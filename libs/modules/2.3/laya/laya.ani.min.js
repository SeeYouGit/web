"use strict";var _get=function t(e,i,a){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,i);if(void 0===r){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,i,a)}if("value"in r)return r.value;var n=r.get;return void 0!==n?n.call(a):void 0},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}();function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){var i=function t(){_classCallCheck(this,t)};i.Skeleton=null,i.AnimationTemplet=null,i.Templet=null;var a=function t(){_classCallCheck(this,t)},r=function t(){_classCallCheck(this,t)},s=function t(){_classCallCheck(this,t)},n=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"parse",value:function(t,n){var h,l,o,u,c,_,p,d=n.__getBuffer(),f=n.readUTFString();t._aniClassName=f;var y,g=n.readUTFString().split("\n"),v=n.getUint8(),m=n.getUint32(),x=n.getUint32();m>0&&(y=d.slice(m,x));var M=new e.Byte(y);for(x>0&&(t._publicExtData=d.slice(x,d.byteLength)),t._useParent=!!n.getUint8(),t._anis.length=v,h=0;h<v;h++){var D=t._anis[h]=new a;D.nodes=[];var k=D.name=g[n.getUint16()];t._aniMap[k]=h,D.bone3DMap={},D.playTime=n.getFloat32();var I=D.nodes.length=n.getUint8();for(D.totalKeyframeDatasLength=0,l=0;l<I;l++){var C=D.nodes[l]=new r;C.childs=[];var A=n.getInt16();A>=0&&(C.name=g[A],D.bone3DMap[C.name]=l),C.keyFrame=[],C.parentIndex=n.getInt16(),-1==C.parentIndex?C.parent=null:C.parent=D.nodes[C.parentIndex],C.lerpType=n.getUint8();var b=n.getUint32();M.pos=b;var T=C.keyframeWidth=M.getUint16();if(D.totalKeyframeDatasLength+=T,0===C.lerpType||1===C.lerpType)for(C.interpolationMethod=[],C.interpolationMethod.length=T,o=0;o<T;o++)C.interpolationMethod[o]=i.AnimationTemplet.interpolation[M.getUint8()];null!=C.parent&&C.parent.childs.push(C);var S=n.getUint16();S>0&&(C.extenData=d.slice(n.pos,n.pos+S),n.pos+=S);var F=n.getUint16();C.keyFrame.length=F;var w,P=0;for(o=0,u=F;o<u;o++){if((w=C.keyFrame[o]=new s).duration=n.getFloat32(),w.startTime=P,2===C.lerpType){w.interpolationData=[];var L,U=n.getUint8();switch(L=n.getFloat32()){case 254:for(w.interpolationData.length=T,p=0;p<T;p++)w.interpolationData[p]=0;break;case 255:for(w.interpolationData.length=T,p=0;p<T;p++)w.interpolationData[p]=5;break;default:for(w.interpolationData.push(L),_=1;_<U;_++)w.interpolationData.push(n.getFloat32())}}for(w.data=new Float32Array(T),w.dData=new Float32Array(T),w.nextData=new Float32Array(T),c=0;c<T;c++)w.data[c]=n.getFloat32(),w.data[c]>-1e-8&&w.data[c]<1e-8&&(w.data[c]=0);P+=w.duration}w.startTime=D.playTime,C.playTime=D.playTime,t._calculateKeyFrame(C,F,T)}}}}]),t}(),h=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"READ_DATA",value:function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=t._BLOCK.count=t._reader.getUint16(),i=t._BLOCK.blockStarts=[],a=t._BLOCK.blockLengths=[],r=0;r<e;r++)i.push(t._reader.getUint32()),a.push(t._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var e=t._reader.getUint32(),i=t._reader.getUint16(),a=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;r<i;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=a}},{key:"parse",value:function(e,i){t._templet=e,t._reader=i;i.__getBuffer();t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var a=0,r=t._BLOCK.count;a<r;a++){var s=i.getUint16(),n=t._strings[s],h=t["READ_"+n];if(null==h)throw new Error("model file err,no this function:"+s+" "+n);h.call(null)}}},{key:"READ_ANIMATIONS",value:function(){var e,n,h,l,o=t._reader,u=o.__getBuffer(),c=o.getUint16(),_=[];for(_.length=c,e=0;e<c;e++)_[e]=i.AnimationTemplet.interpolation[o.getByte()];var p=o.getUint8();for(t._templet._anis.length=p,e=0;e<p;e++){var d=t._templet._anis[e]=new a;d.nodes=[];var f=d.name=t._strings[o.getUint16()];t._templet._aniMap[f]=e,d.bone3DMap={},d.playTime=o.getFloat32();var y=d.nodes.length=o.getInt16();for(d.totalKeyframeDatasLength=0,n=0;n<y;n++){var g=d.nodes[n]=new r;g.keyframeWidth=c,g.childs=[];var v=o.getUint16();v>=0&&(g.name=t._strings[v],d.bone3DMap[g.name]=n),g.keyFrame=[],g.parentIndex=o.getInt16(),-1==g.parentIndex?g.parent=null:g.parent=d.nodes[g.parentIndex],d.totalKeyframeDatasLength+=c,g.interpolationMethod=_,null!=g.parent&&g.parent.childs.push(g);var m=o.getUint16();g.keyFrame.length=m;var x=null,M=null;for(h=0,l=m;h<l;h++){(x=g.keyFrame[h]=new s).startTime=o.getFloat32(),M&&(M.duration=x.startTime-M.startTime),x.dData=new Float32Array(c),x.nextData=new Float32Array(c);var D=t._DATA.offset,k=o.getUint32(),I=4*c,C=u.slice(D+k,D+k+I);x.data=new Float32Array(C),M=x}x.duration=0,g.playTime=d.playTime,t._templet._calculateKeyFrame(g,m,c)}}}}]),t}();h._strings=[],h._BLOCK={count:0},h._DATA={offset:0,size:0};var l=function t(){_classCallCheck(this,t)};l.stopped=0,l.paused=1,l.playing=2;var o=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.isCache=!0,t.playbackRate=1,t._destroyed=!1,t._currentAnimationClipIndex=-1,t._currentKeyframeIndex=-1,t._currentTime=0,t._overallDuration=Number.MAX_VALUE,t._stopWhenCircleFinish=!1,t._elapsedPlaybackTime=0,t._startUpdateLoopCount=-1,t._cachePlayRate=1,t.cacheFrameRate=60,t.returnToZeroStopped=!1,t}return _inherits(i,e.EventDispatcher),_createClass(i,[{key:"_onTempletLoadedComputeFullKeyframeIndices",value:function(t,e,i){this._templet===i&&this._cachePlayRate===t&&this._cacheFrameRate===e&&this._computeFullKeyframeIndices()}},{key:"_computeFullKeyframeIndices",value:function(){}},{key:"_onAnimationTempletLoaded",value:function(){this.destroyed||this._calculatePlayDuration()}},{key:"_calculatePlayDuration",value:function(){if(this.state!==l.stopped){var t=this._templet.getAniDuration(this._currentAnimationClipIndex);0===this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart}}},{key:"_setPlayParams",value:function(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e}},{key:"_setPlayParamsWhenStop",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;this._currentTime=t;var a=i>0?i:t;this._currentKeyframeIndex=Math.floor(a/e+.01),this._currentKeyframeIndex=Math.floor(t/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e,this._currentAnimationClipIndex=-1}},{key:"_update",value:function(t){if(-1!==this._currentAnimationClipIndex&&!this._paused&&this._templet){var i=this._cacheFrameRateInterval*this._cachePlayRate,a=0;this._startUpdateLoopCount!==e.Stat.loopCount&&(a=t*this.playbackRate,this._elapsedPlaybackTime+=a);var r=this.playDuration;if(a+=this._currentTime,0!==this._overallDuration&&this._elapsedPlaybackTime>=this._overallDuration||0===this._overallDuration&&this._elapsedPlaybackTime>=r||0===this._overallDuration&&a>=this.playEnd)return this._setPlayParamsWhenStop(r,i,this.playEnd),void this.event(e.Event.STOPPED);if(r>0){if(a>=r)return this._stopWhenCircleFinish?(this._setPlayParamsWhenStop(r,i),this._stopWhenCircleFinish=!1,void this.event(e.Event.STOPPED)):(a%=r,this._setPlayParams(a,i),void this.event(e.Event.COMPLETE));this._setPlayParams(a,i)}else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(r,i),this._stopWhenCircleFinish=!1,void this.event(e.Event.STOPPED);this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this.event(e.Event.COMPLETE)}}}},{key:"_destroy",value:function(){this.offAll(),this._templet=null,this._destroyed=!0}},{key:"play",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(a<0||r<0||s<0)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(0!==s&&r>s)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=i,this._overallDuration=a,this._playStart=r,this._playEnd=s,this._paused=!1,this._currentAnimationClipIndex=t,this._currentKeyframeIndex=0,this._startUpdateLoopCount=e.Stat.loopCount,this.event(e.Event.PLAYED),this._calculatePlayDuration(),this._update(0)}},{key:"playByFrame",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=1e3/(arguments.length>5&&void 0!==arguments[5]?arguments[5]:30);this.play(t,e,i,a*s,r*s)}},{key:"stop",value:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0]?(this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this._currentAnimationClipIndex=-1,this.event(e.Event.STOPPED)):this._stopWhenCircleFinish=!0}},{key:"destroy",value:function(){}},{key:"templet",get:function(){return this._templet},set:function(t){this.state!==l.stopped&&this.stop(!0),this._templet!==t&&(this._templet=t,this._computeFullKeyframeIndices())}},{key:"playStart",get:function(){return this._playStart}},{key:"playEnd",get:function(){return this._playEnd}},{key:"playDuration",get:function(){return this._playDuration}},{key:"overallDuration",get:function(){return this._overallDuration}},{key:"currentAnimationClipIndex",get:function(){return this._currentAnimationClipIndex}},{key:"currentKeyframeIndex",get:function(){return this._currentKeyframeIndex}},{key:"currentPlayTime",get:function(){return this._currentTime+this._playStart}},{key:"currentFrameTime",get:function(){return this._currentFrameTime}},{key:"cachePlayRate",get:function(){return this._cachePlayRate},set:function(t){this._cachePlayRate!==t&&(this._cachePlayRate=t,this._templet&&this._computeFullKeyframeIndices())}},{key:"cacheFrameRate",get:function(){return this._cacheFrameRate},set:function(t){this._cacheFrameRate!==t&&(this._cacheFrameRate=t,this._cacheFrameRateInterval=1e3/this._cacheFrameRate,this._templet&&this._computeFullKeyframeIndices())}},{key:"currentTime",set:function(t){if(-1!==this._currentAnimationClipIndex&&this._templet){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=e.Stat.loopCount;var i=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/i),this._currentFrameTime=this._currentKeyframeIndex*i}}},{key:"paused",get:function(){return this._paused},set:function(t){this._paused=t,t&&this.event(e.Event.PAUSED)}},{key:"cacheFrameRateInterval",get:function(){return this._cacheFrameRateInterval}},{key:"state",get:function(){return-1===this._currentAnimationClipIndex?l.stopped:this._paused?l.paused:l.playing}},{key:"destroyed",get:function(){return this._destroyed}}]),i}(),u=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"getBezierRate",value:function(e,i,a,r,s){var n=t._getBezierParamKey(i,a,r,s),h=100*n+e;if(t._bezierResultCache[h])return t._bezierResultCache[h];var l,o,u=t._getBezierPoints(i,a,r,s,n);for(o=u.length,l=0;l<o;l+=2)if(e<=u[l])return t._bezierResultCache[h]=u[l+1],u[l+1];return t._bezierResultCache[h]=1,1}},{key:"_getBezierParamKey",value:function(t,e,i,a){return 100*(100*(100*(100*t+e)+i)+a)}},{key:"_getBezierPoints",value:function(i,a,r,s,n){return t._bezierPointsCache[n]?t._bezierPointsCache[n]:(h=[0,0,i,a,r,s,1,1],l=(new e.Bezier).getBezierPoints(h,100,3),t._bezierPointsCache[n]=l,l);var h,l}}]),t}();u._bezierResultCache={},u._bezierPointsCache={};var c=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t._anis=[],t._aniMap={},t.unfixedLastAniIndex=-1,t._fullFrames=null,t._boneCurKeyFrm=[],t}return _inherits(i,e.Resource),_createClass(i,[{key:"parse",value:function(t){var i=new e.Byte(t);this._aniVersion=i.readUTFString(),n.parse(this,i)}},{key:"_calculateKeyFrame",value:function(t,e,i){var a=t.keyFrame;a[e]=a[0];for(var r=0;r<e;r++)for(var s=a[r],n=0;n<i;n++)s.dData[n]=0===s.duration?0:(a[r+1].data[n]-s.data[n])/s.duration,s.nextData[n]=a[r+1].data[n];a.length--}},{key:"_onAsynLoaded",value:function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var i=new e.Byte(t);switch(this._aniVersion=i.readUTFString(),this._aniVersion){case"LAYAANIMATION:02":h.parse(this,i);break;default:n.parse(this,i)}}},{key:"getAnimationCount",value:function(){return this._anis.length}},{key:"getAnimation",value:function(t){return this._anis[t]}},{key:"getAniDuration",value:function(t){return this._anis[t].playTime}},{key:"getNodes",value:function(t){return this._anis[t].nodes}},{key:"getNodeIndexWithName",value:function(t,e){return this._anis[t].bone3DMap[e]}},{key:"getNodeCount",value:function(t){return this._anis[t].nodes.length}},{key:"getTotalkeyframesLength",value:function(t){return this._anis[t].totalKeyframeDatasLength}},{key:"getPublicExtData",value:function(){return this._publicExtData}},{key:"getAnimationDataWithCache",value:function(t,e,i,a){var r=e[i];if(r){var s=r[t];return s?s[a]:null}return null}},{key:"setAnimationDataWithCache",value:function(t,e,i,a,r){var s=e[i]||(e[i]={});(s[t]||(s[t]=[]))[a]=r}},{key:"getNodeKeyFrame",value:function(t,e,i){var a=this._boneCurKeyFrm[e],r=t.length;(void 0==a||a>=r)&&(a=this._boneCurKeyFrm[e]=0);var s=t[a],n=i-s.startTime;if(0==n||n>0&&s.duration>n)return a;var h=0;if(n>0){for(i+=.01,h=a+1;h<r;h++)if((s=t[h]).startTime<=i&&s.startTime+s.duration>i)return this._boneCurKeyFrm[e]=h,h;return r-1}for(h=0;h<a;h++)if((s=t[h]).startTime<=i&&s.startTime+s.duration>i)return this._boneCurKeyFrm[e]=h,h;return a}},{key:"getOriginalData",value:function(t,e,a,r,s){var n=this._anis[t].nodes,h=this._boneCurKeyFrm;h.length<n.length&&(h.length=n.length);for(var l=0,o=0,u=n.length,c=0;o<u;o++){var _,p=n[o],d=p.keyFrame;_=d[this.getNodeKeyFrame(d,o,s)],p.dataOffset=c;var f=s-_.startTime,y=p.lerpType;if(y)switch(y){case 0:case 1:for(l=0;l<p.keyframeWidth;)l+=p.interpolationMethod[l](p,l,e,c+l,_.data,f,_.dData,_.duration,_.nextData);break;case 2:var g=_.interpolationData,v=g.length,m=0;for(l=0;l<v;){var x=g[l];switch(x){case 6:case 7:l+=i.interpolation[x](p,m,e,c+m,_.data,f,_.dData,_.duration,_.nextData,g,l+1);break;default:l+=i.interpolation[x](p,m,e,c+m,_.data,f,_.dData,_.duration,_.nextData)}m++}}else for(l=0;l<p.keyframeWidth;)l+=p.interpolationMethod[l](p,l,e,c+l,_.data,f,_.dData,_.duration,_.nextData);c+=p.keyframeWidth}}},{key:"getNodesCurrentFrameIndex",value:function(t,e){var i=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(i.length),this.unfixedCurrentTimes=new Float32Array(i.length),this.unfixedLastAniIndex=t);for(var a=0,r=i.length;a<r;a++){var s=i[a];for(e<this.unfixedCurrentTimes[a]&&(this.unfixedCurrentFrameIndexes[a]=0),this.unfixedCurrentTimes[a]=e;this.unfixedCurrentFrameIndexes[a]<s.keyFrame.length&&!(s.keyFrame[this.unfixedCurrentFrameIndexes[a]].startTime>this.unfixedCurrentTimes[a]);)this.unfixedCurrentFrameIndexes[a]++;this.unfixedCurrentFrameIndexes[a]--}return this.unfixedCurrentFrameIndexes}},{key:"getOriginalDataUnfixedRate",value:function(t,e,a){var r=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(r.length),this.unfixedCurrentTimes=new Float32Array(r.length),this.unfixedKeyframes=[],this.unfixedLastAniIndex=t);for(var s=0,n=0,h=r.length,l=0;n<h;n++){var o=r[n];for(a<this.unfixedCurrentTimes[n]&&(this.unfixedCurrentFrameIndexes[n]=0),this.unfixedCurrentTimes[n]=a;this.unfixedCurrentFrameIndexes[n]<o.keyFrame.length&&!(o.keyFrame[this.unfixedCurrentFrameIndexes[n]].startTime>this.unfixedCurrentTimes[n]);)this.unfixedKeyframes[n]=o.keyFrame[this.unfixedCurrentFrameIndexes[n]],this.unfixedCurrentFrameIndexes[n]++;var u=this.unfixedKeyframes[n];o.dataOffset=l;var c=a-u.startTime;if(o.lerpType)switch(o.lerpType){case 0:case 1:for(s=0;s<o.keyframeWidth;)s+=o.interpolationMethod[s](o,s,e,l+s,u.data,c,u.dData,u.duration,u.nextData);break;case 2:var _=u.interpolationData,p=_.length,d=0;for(s=0;s<p;){var f=_[s];switch(f){case 6:case 7:s+=i.interpolation[f](o,d,e,l+d,u.data,c,u.dData,u.duration,u.nextData,_,s+1);break;default:s+=i.interpolation[f](o,d,e,l+d,u.data,c,u.dData,u.duration,u.nextData)}d++}}else for(s=0;s<o.keyframeWidth;)s+=o.interpolationMethod[s](o,s,e,l+s,u.data,c,u.dData,u.duration,u.nextData);l+=o.keyframeWidth}}}],[{key:"_LinearInterpolation_0",value:function(t,e,i,a,r,s,n,h,l){arguments.length>9&&void 0!==arguments[9]&&arguments[9];return i[a]=r[e]+s*n[e],1}},{key:"_QuaternionInterpolation_1",value:function(t,i,a,r,s,n,h,l,o){arguments.length>9&&void 0!==arguments[9]&&arguments[9];var u=0===l?0:n/l;return e.MathUtil.slerpQuaternionArray(s,i,o,i,u,a,r),4}},{key:"_AngleInterpolation_2",value:function(t,e,i,a,r,s,n,h,l){arguments.length>9&&void 0!==arguments[9]&&arguments[9];return 0}},{key:"_RadiansInterpolation_3",value:function(t,e,i,a,r,s,n,h,l){arguments.length>9&&void 0!==arguments[9]&&arguments[9];return 0}},{key:"_Matrix4x4Interpolation_4",value:function(t,e,i,a,r,s,n,h,l){arguments.length>9&&void 0!==arguments[9]&&arguments[9];for(var o=0;o<16;o++,e++)i[a+o]=r[e]+s*n[e];return 16}},{key:"_NoInterpolation_5",value:function(t,e,i,a,r,s,n,h,l){arguments.length>9&&void 0!==arguments[9]&&arguments[9];return i[a]=r[e],1}},{key:"_BezierInterpolation_6",value:function(t,e,i,a,r,s,n,h,l){var o=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0;return i[a]=r[e]+(l[e]-r[e])*u.getBezierRate(s/h,o[c],o[c+1],o[c+2],o[c+3]),5}},{key:"_BezierInterpolation_7",value:function(t,e,i,a,r,s,n,h,l){var o=arguments.length>9&&void 0!==arguments[9]?arguments[9]:null,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0;return i[a]=o[c+4]+o[c+5]*u.getBezierRate((.001*s+o[c+6])/o[c+7],o[c],o[c+1],o[c+2],o[c+3]),9}}]),i}();c.interpolation=[c._LinearInterpolation_0,c._QuaternionInterpolation_1,c._AngleInterpolation_2,c._RadiansInterpolation_3,c._Matrix4x4Interpolation_4,c._NoInterpolation_5,c._BezierInterpolation_6,c._BezierInterpolation_7],i.AnimationTemplet=c;var _=function(t){function i(){return _classCallCheck(this,i),_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}return _inherits(i,e.Graphics),_createClass(i,[{key:"drawSkin",value:function(t,i){this.drawTriangles(t.texture,0,0,t.vertices,t.uvs,t.indexes,t.transform||e.Matrix.EMPTY,i)}}],[{key:"create",value:function(){return i._caches.pop()||new i}},{key:"recycle",value:function(t){t.clear(),i._caches.push(t)}}]),i}();_._caches=[];var p=function(){function t(){_classCallCheck(this,t),this.skX=0,this.skY=0,this.scX=1,this.scY=1,this.x=0,this.y=0,this.skewX=0,this.skewY=0}return _createClass(t,[{key:"initData",value:function(t){void 0!=t.x&&(this.x=t.x),void 0!=t.y&&(this.y=t.y),void 0!=t.skX&&(this.skX=t.skX),void 0!=t.skY&&(this.skY=t.skY),void 0!=t.scX&&(this.scX=t.scX),void 0!=t.scY&&(this.scY=t.scY)}},{key:"getMatrix",value:function(){var t;return(t=this.mMatrix?this.mMatrix:this.mMatrix=new e.Matrix).identity(),t.scale(this.scX,this.scY),(this.skewX||this.skewY)&&this.skew(t,this.skewX*Math.PI/180,this.skewY*Math.PI/180),t.rotate(this.skX*Math.PI/180),t.translate(this.x,this.y),t}},{key:"skew",value:function(t,e,i){var a=Math.sin(i),r=Math.cos(i),s=Math.sin(e),n=Math.cos(e);return t.setTo(t.a*n-t.b*a,t.a*s+t.b*r,t.c*n-t.d*a,t.c*s+t.d*r,t.tx*n-t.ty*a,t.tx*s+t.ty*r),t}}]),t}(),d=function(){function t(){_classCallCheck(this,t),this.length=10,this.resultTransform=new p,this.resultMatrix=new e.Matrix,this.inheritScale=!0,this.inheritRotation=!0,this.d=-1,this._children=[]}return _createClass(t,[{key:"setTempMatrix",value:function(t){this._tempMatrix=t;var e,i=0;for(i=0,e=this._children.length;i<e;i++)this._children[i].setTempMatrix(this._tempMatrix)}},{key:"update",value:function(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.rotation=this.transform.skX,i)t=this.resultTransform.getMatrix(),e.Matrix.mul(t,i,this.resultMatrix),this.resultRotation=this.rotation;else if(this.resultRotation=this.rotation+this.parentBone.resultRotation,this.parentBone)if(this.inheritRotation&&this.inheritScale)t=this.resultTransform.getMatrix(),e.Matrix.mul(t,this.parentBone.resultMatrix,this.resultMatrix);else{var a,r,s,n=this.parentBone,h=this.parentBone.resultMatrix;t=this.resultTransform.getMatrix();var l=h.a*t.tx+h.c*t.ty+h.tx,o=h.b*t.tx+h.d*t.ty+h.ty,u=new e.Matrix;this.inheritRotation?(a=Math.atan2(n.resultMatrix.b,n.resultMatrix.a),r=Math.cos(a),s=Math.sin(a),u.setTo(r,s,-s,r,0,0),e.Matrix.mul(this._tempMatrix,u,e.Matrix.TEMP),e.Matrix.TEMP.copyTo(u),t=this.resultTransform.getMatrix(),e.Matrix.mul(t,u,this.resultMatrix),this.resultTransform.scX*this.resultTransform.scY<0&&this.resultMatrix.rotate(.5*Math.PI),this.resultMatrix.tx=l,this.resultMatrix.ty=o):(this.inheritScale,t=this.resultTransform.getMatrix(),e.Matrix.TEMP.identity(),e.Matrix.TEMP.d=this.d,e.Matrix.mul(t,e.Matrix.TEMP,this.resultMatrix),this.resultMatrix.tx=l,this.resultMatrix.ty=o)}else(t=this.resultTransform.getMatrix()).copyTo(this.resultMatrix);var c,_=0;for(_=0,c=this._children.length;_<c;_++)this._children[_].update()}},{key:"updateChild",value:function(){var t,e=0;for(e=0,t=this._children.length;e<t;e++)this._children[e].update()}},{key:"setRotation",value:function(t){this._sprite&&(this._sprite.rotation=180*t/Math.PI)}},{key:"updateDraw",value:function(i,a){t.ShowBones&&!t.ShowBones[this.name]||(this._sprite?(this._sprite.x=i+this.resultMatrix.tx,this._sprite.y=a+this.resultMatrix.ty):(this._sprite=new e.Sprite,this._sprite.graphics.drawCircle(0,0,5,"#ff0000"),this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00"),this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center"),e.ILaya.stage.addChild(this._sprite),this._sprite.x=i+this.resultMatrix.tx,this._sprite.y=a+this.resultMatrix.ty));var r,s=0;for(s=0,r=this._children.length;s<r;s++)this._children[s].updateDraw(i,a)}},{key:"addChild",value:function(t){this._children.push(t),t.parentBone=this}},{key:"findBone",value:function(t){if(this.name==t)return this;var e,i,a;for(e=0,i=this._children.length;e<i;e++)if(a=this._children[e].findBone(t))return a;return null}},{key:"localToWorld",value:function(t){var e=t[0],i=t[1];t[0]=e*this.resultMatrix.a+i*this.resultMatrix.c+this.resultMatrix.tx,t[1]=e*this.resultMatrix.b+i*this.resultMatrix.d+this.resultMatrix.ty}}]),t}();d.ShowBones={};var f=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"getRelativeUV",value:function(t,e){var i,a,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=t[0],n=t[2]-t[0],h=t[1],l=t[5]-t[1];r||(r=[]),r.length=e.length,a=r.length;var o=1/n,u=1/l;for(i=0;i<a;i+=2)r[i]=(e[i]-s)*o,r[i+1]=(e[i+1]-h)*u;return r}},{key:"getAbsoluteUV",value:function(t,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(0==t[0]&&0==t[1]&&1==t[4]&&1==t[5])return a?(e.Utils.copyArray(a,i),a):i;var r,s,n=t[0],h=t[2]-t[0],l=t[1],o=t[5]-t[1];for(a||(a=[]),a.length=i.length,s=a.length,r=0;r<s;r+=2)a[r]=i[r]*h+n,a[r+1]=i[r+1]*o+l;return a}}]),t}(),y=function(){function t(){_classCallCheck(this,t),this.uvs=new Float32Array([0,0,1,0,1,1,0,1]),this.vertices=new Float32Array([0,0,100,0,100,100,0,100]),this.indexes=new Uint16Array([0,1,3,3,1,2]),this.useUvTransform=!1,this.canvasPadding=1}return _createClass(t,[{key:"getBounds",value:function(){return e.Rectangle._getWrapRec(this.vertices)}}]),t}(),g=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this))}return _inherits(e,y),_createClass(e,[{key:"init2",value:function(t,e,i,a){this.transform&&(this.transform=null);var r=e||[0,1,3,3,1,2];this.texture=t,this.indexes=new Uint16Array(r),this.vertices=new Float32Array(i),this.uvs=new Float32Array(a)}}]),e}(),v=function(){function t(){_classCallCheck(this,t),this.srcDisplayIndex=-1,this.type="src",this.displayIndex=-1,this.originalIndex=-1,this._replaceDic={}}return _createClass(t,[{key:"showSlotData",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.currSlotData=t,e&&(this.displayIndex=this.srcDisplayIndex),this.currDisplayData=null,this.currTexture=null}},{key:"showDisplayByName",value:function(t){this.currSlotData&&this.showDisplayByIndex(this.currSlotData.getDisplayByName(t))}},{key:"replaceDisplayByName",value:function(t,e){var i,a;this.currSlotData&&(i=this.currSlotData.getDisplayByName(t),a=this.currSlotData.getDisplayByName(e),this.replaceDisplayByIndex(i,a))}},{key:"replaceDisplayByIndex",value:function(t,e){this.currSlotData&&(this._replaceDic[t]=e,this.originalIndex==t&&this.showDisplayByIndex(t))}},{key:"showDisplayByIndex",value:function(t){if(this.originalIndex=t,null!=this._replaceDic[t]&&(t=this._replaceDic[t]),this.currSlotData&&t>-1&&t<this.currSlotData.displayArr.length){if(this.displayIndex=t,this.currDisplayData=this.currSlotData.displayArr[t],this.currDisplayData){var e=this.currDisplayData.name;this.currTexture=this.templet.getTexture(e),this.currTexture&&0==this.currDisplayData.type&&this.currDisplayData.uvs&&(this.currTexture=this.currDisplayData.createTexture(this.currTexture))}}else this.displayIndex=-1,this.currDisplayData=null,this.currTexture=null}},{key:"replaceSkin",value:function(t){this._diyTexture=t,this._curDiyUV&&(this._curDiyUV.length=0),this.currDisplayData&&this._diyTexture==this.currDisplayData.texture&&(this._diyTexture=null)}},{key:"setParentMatrix",value:function(t){this._parentMatrix=t}},{key:"getSaveVerticle",value:function(i){return t.useSameMatrixAndVerticle&&this._preGraphicVerticle&&t.isSameArr(i,this._preGraphicVerticle)?i=this._preGraphicVerticle:(i=e.ILaya.Utils.copyArray([],i),this._preGraphicVerticle=i),i}},{key:"getSaveMatrix",value:function(e){t.useSameMatrixAndVerticle&&this._preGraphicMatrix&&t.isSameMatrix(e,this._preGraphicMatrix)?e=this._preGraphicMatrix:(e=e.clone(),this._preGraphicMatrix=e);return e}},{key:"draw",value:function(i,a){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if((null!=this._diyTexture||null!=this.currTexture)&&null!=this.currDisplayData||this.currDisplayData&&3==this.currDisplayData.type){var n,h=this.currTexture;switch(this._diyTexture&&(h=this._diyTexture),this.currDisplayData.type){case 0:if(i){var l=this.getDisplayMatrix();if(this._parentMatrix){var o=!1;if(l){var u;if(e.Matrix.mul(l,this._parentMatrix,e.Matrix.TEMP),r?(null==this._resultMatrix&&(this._resultMatrix=new e.Matrix),u=this._resultMatrix):u=t._tempResultMatrix,this._diyTexture&&this.currDisplayData.uvs){var c=t._tempMatrix;c.identity(),this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(c.d=-1),this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(o=!0,c.rotate(-Math.PI/2)),e.Matrix.mul(c,e.Matrix.TEMP,u)}else e.Matrix.TEMP.copyTo(u);r||(u=this.getSaveMatrix(u)),u._checkTransform(),o?i.drawTexture(h,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,u,s):i.drawTexture(h,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,u,s)}}}break;case 1:if(r?(null==this._skinSprite&&(this._skinSprite=t.createSkinMesh()),n=this._skinSprite):n=t.createSkinMesh(),null==n)return;var _;if(null==this.currDisplayData.bones){var p,d=this.currDisplayData.weights;this.deformData&&(d=this.deformData),this._diyTexture?(this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=f.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=f.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),p=this._curDiyUV):p=this.currDisplayData.uvs,this._mVerticleArr=d;this.currDisplayData.triangles.length;_=this.currDisplayData.triangles,this.deformData&&(r||(this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr))),n.init2(h,_,this._mVerticleArr,p);var y,g=this.getDisplayMatrix();if(this._parentMatrix)if(g)e.Matrix.mul(g,this._parentMatrix,e.Matrix.TEMP),r?(null==this._resultMatrix&&(this._resultMatrix=new e.Matrix),y=this._resultMatrix):y=t._tempResultMatrix,e.Matrix.TEMP.copyTo(y),r||(y=this.getSaveMatrix(y)),n.transform=y}else this.skinMesh(a,n);i.drawSkin(n,s);break;case 2:if(r?(null==this._skinSprite&&(this._skinSprite=t.createSkinMesh()),n=this._skinSprite):n=t.createSkinMesh(),null==n)return;this.skinMesh(a,n),i.drawSkin(n,s)}}}},{key:"skinMesh",value:function(e,i){var a,r=this.currTexture,s=this.currDisplayData.bones;this._diyTexture?(r=this._diyTexture,this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=f.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=f.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),a=this._curDiyUV):a=this.currDisplayData.uvs;var n,h,l,o,u,c=this.currDisplayData.weights,_=this.currDisplayData.triangles,p=0,d=0,y=0,g=0,v=0,m=0,x=0;if(t._tempVerticleArr.length=0,u=t._tempVerticleArr,this.deformData&&this.deformData.length>0){var M=0;for(m=0,x=s.length;m<x;){for(y=s[m++]+m,p=0,d=0;m<y;m++)h=e[s[m]],l=c[g]+this.deformData[M++],o=c[g+1]+this.deformData[M++],v=c[g+2],p+=(l*h.a+o*h.c+h.tx)*v,d+=(l*h.b+o*h.d+h.ty)*v,g+=3;u.push(p,d)}}else for(m=0,x=s.length;m<x;){for(y=s[m++]+m,p=0,d=0;m<y;m++)h=e[s[m]],l=c[g],o=c[g+1],v=c[g+2],p+=(l*h.a+o*h.c+h.tx)*v,d+=(l*h.b+o*h.d+h.ty)*v,g+=3;u.push(p,d)}this._mVerticleArr=u,n=_,this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr),i.init2(r,n,this._mVerticleArr,a)}},{key:"drawBonePoint",value:function(t){t&&this._parentMatrix&&t.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000")}},{key:"getDisplayMatrix",value:function(){return this.currDisplayData?this.currDisplayData.transform.getMatrix():null}},{key:"getMatrix",value:function(){return this._resultMatrix}},{key:"copy",value:function(){var e=new t;return e.type="copy",e.name=this.name,e.attachmentName=this.attachmentName,e.srcDisplayIndex=this.srcDisplayIndex,e.parent=this.parent,e.displayIndex=this.displayIndex,e.templet=this.templet,e.currSlotData=this.currSlotData,e.currTexture=this.currTexture,e.currDisplayData=this.currDisplayData,e}}],[{key:"createSkinMesh",value:function(){return new g}},{key:"isSameArr",value:function(t,e){if(t.length!=e.length)return!1;var i,a;for(a=t.length,i=0;i<a;i++)if(t[i]!=e[i])return!1;return!0}},{key:"isSameMatrix",value:function(t,e){return t.a==e.a&&t.b==e.b&&t.c==e.c&&t.d==e.d&&Math.abs(t.tx-e.tx)<1e-5&&Math.abs(t.ty-e.ty)<1e-5}}]),t}();v._tempMatrix=new e.Matrix,v._tempResultMatrix=new e.Matrix,v.useSameMatrixAndVerticle=!0,v._tempVerticleArr=[];var m=function t(){_classCallCheck(this,t),this.deformSlotDataList=[]},x=function t(){_classCallCheck(this,t),this.deformSlotDisplayList=[]},M=function(){function t(){_classCallCheck(this,t),this.slotIndex=-1,this.timeList=[],this.vectices=[],this.tweenKeyList=[],this.frameIndex=0}return _createClass(t,[{key:"binarySearch1",value:function(t,e){var i=0,a=t.length-2;if(0==a)return 1;for(var r=a>>>1;;){if(t[Math.floor(r+1)]<=e?i=r+1:a=r,i==a)return i+1;r=i+a>>>1}return 0}},{key:"apply",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(t+=.05,!(this.timeList.length<=0)){var a=0;if(!(t<this.timeList[0])){var r=this.vectices[0].length,s=[],n=this.binarySearch1(this.timeList,t);if(this.frameIndex=n,t>=this.timeList[this.timeList.length-1]){var h=this.vectices[this.vectices.length-1];if(i<1)for(a=0;a<r;a++)s[a]+=(h[a]-s[a])*i;else for(a=0;a<r;a++)s[a]=h[a];this.deformData=s}else{var l,o=this.vectices[this.frameIndex-1],u=this.vectices[this.frameIndex],c=this.timeList[this.frameIndex-1],_=this.timeList[this.frameIndex];for(i=this.tweenKeyList[n-1]?(t-c)/(_-c):0,a=0;a<r;a++)l=o[a],s[a]=l+(u[a]-l)*i;this.deformData=s}}}}}]),t}(),D=function t(){_classCallCheck(this,t),this.drawOrder=[]},k=function t(){_classCallCheck(this,t)},I=function(){function t(e,i){_classCallCheck(this,t),this.isSpine=!0,this.isDebug=!1,this._targetBone=i[e.targetBoneIndex],this.isSpine=e.isSpine,null==this._bones&&(this._bones=[]),this._bones.length=0;for(var a=0,r=e.boneIndexs.length;a<r;a++)this._bones.push(i[e.boneIndexs[a]]);this.name=e.name,this.mix=e.mix,this.bendDirection=e.bendDirection}return _createClass(t,[{key:"apply",value:function(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:this.isSpine?this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix):this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix)}}},{key:"_applyIk1",value:function(e,i,a,r){var s=e.parentBone,n=1/(s.resultMatrix.a*s.resultMatrix.d-s.resultMatrix.b*s.resultMatrix.c),h=i-s.resultMatrix.tx,l=a-s.resultMatrix.ty,o=(h*s.resultMatrix.d-l*s.resultMatrix.c)*n-e.transform.x,u=(l*s.resultMatrix.a-h*s.resultMatrix.b)*n-e.transform.y,c=Math.atan2(u,o)*t.radDeg-0-e.transform.skX;e.transform.scX<0&&(c+=180),c>180?c-=360:c<-180&&(c+=360),e.transform.skX=e.transform.skY=e.transform.skX+c*r,e.update()}},{key:"updatePos",value:function(t,e){this._sp&&this._sp.pos(t,e)}},{key:"_applyIk2",value:function(i,a,r,s,n,h){if(0!=h){var l,o,u,c=i.resultTransform.x,_=i.resultTransform.y,p=i.transform.scX,d=i.transform.scY,f=a.transform.scX;p<0?(p=-p,l=180,u=-1):(l=0,u=1),d<0&&(d=-d,u=-u),f<0?(f=-f,o=180):o=0;var y,g,v,m=a.resultTransform.x,x=i.resultMatrix.a,M=i.resultMatrix.c,D=i.resultMatrix.b,k=i.resultMatrix.d,I=Math.abs(p-d)<=1e-4;I?(g=x*m+M*(y=a.resultTransform.y)+i.resultMatrix.tx,v=D*m+k*y+i.resultMatrix.ty):(y=0,g=x*m+i.resultMatrix.tx,v=D*m+i.resultMatrix.ty),this.isDebug&&(this._sp||(this._sp=new e.Sprite,e.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(r,s,15,"#ffff00"),this._sp.graphics.drawCircle(g,v,15,"#ff00ff")),i.setRotation(Math.atan2(v-i.resultMatrix.ty,g-i.resultMatrix.tx));var C=i.parentBone;x=C.resultMatrix.a,M=C.resultMatrix.c,D=C.resultMatrix.b;var A,b,T=1/(x*(k=C.resultMatrix.d)-M*D),S=r-C.resultMatrix.tx,F=s-C.resultMatrix.ty,w=(S*k-F*M)*T-c,P=(F*x-S*D)*T-_,L=((S=g-C.resultMatrix.tx)*k-(F=v-C.resultMatrix.ty)*M)*T-c,U=(F*x-S*D)*T-_,B=Math.sqrt(L*L+U*U),E=a.length*f;if(I){var R=(w*w+P*P-B*B-(E*=p)*E)/(2*B*E);R<-1?R=-1:R>1&&(R=1),b=Math.acos(R)*n,x=B+E*R,M=E*Math.sin(b),A=Math.atan2(P*x-w*M,w*x+P*M)}else{var O=(x=p*E)*x,N=(M=d*E)*M,V=w*w+P*P,Y=Math.atan2(P,w),K=-2*N*B,X=N-O;if((k=K*K-4*X*(D=N*B*B+O*V-O*N))>0){var W=Math.sqrt(k);K<0&&(W=-W);var z=(W=-(K+W)/2)/X,G=D/W,q=Math.abs(z)<Math.abs(G)?z:G;q*q<=V&&(F=Math.sqrt(V-q*q)*n,A=Y-Math.atan2(F,q),b=Math.atan2(F/d,(q-B)/p))}var j=0,H=Number.MAX_VALUE,Q=0,Z=0,J=0,$=0,tt=0,et=0;(k=(S=B+x)*S)>$&&(J=0,$=k,tt=S),(k=(S=B-x)*S)<H&&(j=Math.PI,H=k,Q=S);var it=Math.acos(-x*B/(O-N));(k=(S=x*Math.cos(it)+B)*S+(F=M*Math.sin(it))*F)<H&&(j=it,H=k,Q=S,Z=F),k>$&&(J=it,$=k,tt=S,et=F),V<=(H+$)/2?(A=Y-Math.atan2(Z*n,Q),b=j*n):(A=Y-Math.atan2(et*n,tt),b=J*n)}var at=Math.atan2(y,m)*u,rt=i.resultTransform.skX;(A=(A-at)*t.radDeg+l-rt)>180?A-=360:A<-180&&(A+=360),i.resultTransform.x=c,i.resultTransform.y=_,i.resultTransform.skX=i.resultTransform.skY=rt+A*h,rt=a.resultTransform.skX,rt%=360,(b=((b+at)*t.radDeg-0)*u+o-rt)>180?b-=360:b<-180&&(b+=360),a.resultTransform.x=m,a.resultTransform.y=y,a.resultTransform.skX=a.resultTransform.skY=a.resultTransform.skY+b*h,i.update()}}},{key:"_applyIk3",value:function(i,a,r,s,n,h){if(0!=h){var l,o,u,c,_,p,d=a.resultMatrix.a*a.length,f=a.resultMatrix.b*a.length,y=d*d+f*f,g=Math.sqrt(y),v=i.resultMatrix.tx,m=i.resultMatrix.ty,x=a.resultMatrix.tx,M=a.resultMatrix.ty,D=x-v,k=M-m,I=D*D+k*k,C=Math.sqrt(I),A=(D=r-i.resultMatrix.tx)*D+(k=s-i.resultMatrix.ty)*k,b=Math.sqrt(A);if(g+C<=b||b+g<=C||b+C<=g){var T;x=v+(T=g+C<=b?1:-1)*(r-v)*C/b,M=m+T*(s-m)*C/b}else{var S=(I-y+A)/(2*A),F=Math.sqrt(I-S*S*A)/b,w=v+D*S,P=m+k*S,L=-k*F,U=D*F;n>0?(x=w-L,M=P-U):(x=w+L,M=P+U)}l=x,o=M,this.isDebug&&(this._sp||(this._sp=new e.Sprite,e.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(v,m,15,"#ff00ff"),this._sp.graphics.drawCircle(r,s,15,"#ffff00"),this._sp.graphics.drawCircle(l,o,15,"#ff00ff")),u=Math.atan2(o-i.resultMatrix.ty,l-i.resultMatrix.tx),i.setRotation(u),(c=t._tempMatrix).identity(),c.rotate(u),c.scale(i.resultMatrix.getScaleX(),i.resultMatrix.getScaleY()),c.translate(i.resultMatrix.tx,i.resultMatrix.ty),c.copyTo(i.resultMatrix),i.updateChild(),_=Math.atan2(s-o,r-l),a.setRotation(_),(p=t._tempMatrix).identity(),p.rotate(_),p.scale(a.resultMatrix.getScaleX(),a.resultMatrix.getScaleY()),p.translate(l,o),c.copyTo(a.resultMatrix),a.updateChild()}}}]),t}();I.radDeg=180/Math.PI,I.degRad=Math.PI/180,I._tempMatrix=new e.Matrix;var C=function t(){_classCallCheck(this,t),this.boneNames=[],this.bendDirection=1,this.mix=1,this.isSpine=!0,this.targetBoneIndex=-1,this.boneIndexs=[]},A=function(){function t(e,i){_classCallCheck(this,t),this._debugKey=!1,this._segments=[],this._curves=[],this.data=e,this.position=e.position,this.spacing=e.spacing,this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.bones=[];for(var a=this.data.bones,r=0,s=a.length;r<s;r++)this.bones.push(i[a[r]])}return _createClass(t,[{key:"apply",value:function(t,e){if(this.target){var i=this.translateMix,a=this.translateMix,r=a>0,s=this.data.spacingMode,n="length"==s,h=this.data.rotateMode,l="tangent"==h,o="chainScale"==h,u=[],c=this.bones.length,_=l?c:c+1,p=[];this._spaces=p,p[0]=this.position;var d=this.spacing;if(o||n)for(var f=0,y=_-1;f<y;){var g=this.bones[f],v=g.length,m=v*g.resultMatrix.a,x=v*g.resultMatrix.b;v=Math.sqrt(m*m+x*x),o&&(u[f]=v),p[++f]=n?Math.max(0,v+d):d}else for(f=1;f<_;f++)p[f]=d;var M=this.computeWorldPositions(this.target,t,e,_,l,"percent"==this.data.positionMode,"percent"==s);if(this._debugKey){for(f=0;f<M.length;f++)e.drawCircle(M[f++],M[f++],5,"#00ff00");var D=[];for(f=0;f<M.length;f++)D.push(M[f++],M[f++]);e.drawLines(0,0,D,"#ff0000")}var k,I=M[0],C=M[1],A=this.data.offsetRotation,b="chain"==h&&0==A;for(f=0,k=3;f<c;f++,k+=3){(g=this.bones[f]).resultMatrix.tx+=(I-g.resultMatrix.tx)*i,g.resultMatrix.ty+=(C-g.resultMatrix.ty)*i;var T=(m=M[k])-I,S=(x=M[k+1])-C;if(o&&0!=(v=u[f])){var F=(Math.sqrt(T*T+S*S)/v-1)*a+1;g.resultMatrix.a*=F,g.resultMatrix.c*=F}if(I=m,C=x,r){var w,P,L,U=g.resultMatrix.a,B=g.resultMatrix.c,E=g.resultMatrix.b,R=g.resultMatrix.d;w=l?M[k-1]:0==p[f+1]?M[k+2]:Math.atan2(S,T),w-=Math.atan2(E,U)-A/180*Math.PI,b&&(P=Math.cos(w),L=Math.sin(w),I+=((v=g.length)*(P*U-L*E)-T)*a,C+=(v*(L*U+P*E)-S)*a),w>Math.PI?w-=2*Math.PI:w<-Math.PI&&(w+=2*Math.PI),w*=a,P=Math.cos(w),L=Math.sin(w),g.resultMatrix.a=P*U-L*E,g.resultMatrix.c=P*B-L*R,g.resultMatrix.b=L*U+P*E,g.resultMatrix.d=L*B+P*R}}}}},{key:"computeWorldVertices2",value:function(e,i,a,r,s,n){var h,l,o,u=e.currDisplayData.bones,c=e.currDisplayData.weights,_=e.currDisplayData.triangles,p=0,d=0,f=0,y=0,g=0,v=0,m=0,x=0,M=0,D=0;if(null!=u){for(p=0;p<a;p+=2)d+=(y=u[d])+1,f+=y;var k=i;for(g=n,v=3*f;g<r;g+=2){for(m=0,x=0,y=u[d++],y+=d;d<y;d++,v+=3){h=k[u[d]].resultMatrix,M=c[v],D=c[v+1];var I=c[v+2];m+=(M*h.a+D*h.c+h.tx)*I,x+=(M*h.b+D*h.d+h.ty)*I}s[g]=m,s[g+1]=x}}else{var C,A;if(_||(_=c),e.deformData&&(_=e.deformData),C=e.parent,i)for(o=i.length,p=0;p<o;p++)if(i[p].name==C){l=i[p];break}l&&(A=l.resultMatrix),A||(A=t._tempMt);var b=A.tx,T=A.ty,S=A.a,F=A.b,w=A.c,P=A.d;for(l&&(P*=l.d),d=a,g=n;g<r;d+=2,g+=2)M=_[d],D=_[d+1],s[g]=M*S+D*F+b,s[g+1]=-(M*w+D*P+T)}}},{key:"computeWorldPositions",value:function(t,e,i,a,r,s,n){t.currDisplayData.bones,t.currDisplayData.weights,t.currDisplayData.triangles;var h,l,o,u,c,_,p,d,f=[],y=0,g=t.currDisplayData.verLen,v=this.position,m=this._spaces,x=[],M=g/6,D=-1;if(M--,g-=4,this.computeWorldVertices2(t,e,2,g,f,0),this._debugKey)for(y=0;y<f.length;)i.drawCircle(f[y++],f[y++],10,"#ff0000");h=f,this._curves.length=M;var k=this._curves;l=0;var I,C,A,b,T,S,F,w,P,L=h[0],U=h[1],B=0,E=0,R=0,O=0,N=0,V=0;for(y=0,P=2;y<M;y++,P+=6)T=2*(I=.1875*(L-2*(B=h[P])+(R=h[P+2])))+(A=.09375*(3*(B-R)-L+(N=h[P+4]))),S=2*(C=.1875*(U-2*(E=h[P+1])+(O=h[P+3])))+(b=.09375*(3*(E-O)-U+(V=h[P+5]))),F=.75*(B-L)+I+.16666667*A,w=.75*(E-U)+C+.16666667*b,l+=Math.sqrt(F*F+w*w),F+=T,w+=S,T+=A,S+=b,l+=Math.sqrt(F*F+w*w),F+=T,w+=S,l+=Math.sqrt(F*F+w*w),F+=T+A,w+=S+b,l+=Math.sqrt(F*F+w*w),k[y]=l,L=N,U=V;if(s&&(v*=l),n)for(y=0;y<a;y++)m[y]*=l;var Y,K=this._segments,X=0;for(y=0,o=0,u=0,Y=0;y<a;y++,o+=3)if((c=v+=_=m[y])<0)this.addBeforePosition(c,h,0,x,o);else if(c>l)this.addAfterPosition(c-l,h,g-4,x,o);else{for(;;u++)if(!(c>(d=k[u]))){0==u?c/=d:c=(c-(p=k[u-1]))/(d-p);break}if(u!=D){D=u;var W=6*u;for(T=2*(I=.03*((L=h[W])-2*(B=h[W+2])+(R=h[W+4])))+(A=.006*(3*(B-R)-L+(N=h[W+6]))),S=2*(C=.03*((U=h[W+1])-2*(E=h[W+3])+(O=h[W+5])))+(b=.006*(3*(E-O)-U+(V=h[W+7]))),F=.3*(B-L)+I+.16666667*A,w=.3*(E-U)+C+.16666667*b,X=Math.sqrt(F*F+w*w),K[0]=X,W=1;W<8;W++)F+=T,w+=S,T+=A,S+=b,X+=Math.sqrt(F*F+w*w),K[W]=X;F+=T,w+=S,X+=Math.sqrt(F*F+w*w),K[8]=X,F+=T+A,w+=S+b,X+=Math.sqrt(F*F+w*w),K[9]=X,Y=0}for(c*=X;;Y++)if(!(c>(d=K[Y]))){0==Y?c/=d:c=Y+(c-(p=K[Y-1]))/(d-p);break}this.addCurvePosition(.1*c,L,U,B,E,R,O,N,V,x,o,r||y>0&&0==_)}return x}},{key:"addBeforePosition",value:function(t,e,i,a,r){var s=e[i],n=e[i+1],h=e[i+2]-s,l=e[i+3]-n,o=Math.atan2(l,h);a[r]=s+t*Math.cos(o),a[r+1]=n+t*Math.sin(o),a[r+2]=o}},{key:"addAfterPosition",value:function(t,e,i,a,r){var s=e[i+2],n=e[i+3],h=s-e[i],l=n-e[i+1],o=Math.atan2(l,h);a[r]=s+t*Math.cos(o),a[r+1]=n+t*Math.sin(o),a[r+2]=o}},{key:"addCurvePosition",value:function(t,e,i,a,r,s,n,h,l,o,u,c){0==t&&(t=1e-4);var _=t*t,p=_*t,d=1-t,f=d*d,y=f*d,g=d*t,v=3*g,m=d*v,x=v*t,M=e*y+a*m+s*x+h*p,D=i*y+r*m+n*x+l*p;o[u]=M,o[u+1]=D,o[u+2]=c?Math.atan2(D-(i*f+r*g*2+n*_),M-(e*f+a*g*2+s*_)):0}}]),t}();A.BEFORE=-2,A.AFTER=-3,A._tempMt=new e.Matrix;var b=function t(){_classCallCheck(this,t),this.bones=[]},T=function(){function t(e,i){var a,r;for(_classCallCheck(this,t),this._temp=[],this._data=e,null==this._bones&&(this._bones=[]),this.target=i[e.targetIndex],a=0,r=e.boneIndexs.length;a<r;a++)this._bones.push(i[e.boneIndexs[a]]);this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.scaleMix=e.scaleMix,this.shearMix=e.shearMix}return _createClass(t,[{key:"apply",value:function(){for(var t,e=this.target.resultMatrix.a,i=this.target.resultMatrix.b,a=this.target.resultMatrix.c,r=this.target.resultMatrix.d,s=0,n=this._bones.length;s<n;s++){if(t=this._bones[s],this.rotateMix>0){var h=t.resultMatrix.a,l=t.resultMatrix.b,o=t.resultMatrix.c,u=t.resultMatrix.d,c=Math.atan2(a,e)-Math.atan2(o,h)+this._data.offsetRotation*Math.PI/180;c>Math.PI?c-=2*Math.PI:c<-Math.PI&&(c+=2*Math.PI),c*=this.rotateMix;var _=Math.cos(c),p=Math.sin(c);t.resultMatrix.a=_*h-p*o,t.resultMatrix.b=_*l-p*u,t.resultMatrix.c=p*h+_*o,t.resultMatrix.d=p*l+_*u}if(this.translateMix&&(this._temp[0]=this._data.offsetX,this._temp[1]=this._data.offsetY,this.target.localToWorld(this._temp),t.resultMatrix.tx+=(this._temp[0]-t.resultMatrix.tx)*this.translateMix,t.resultMatrix.ty+=(this._temp[1]-t.resultMatrix.ty)*this.translateMix,t.updateChild()),this.scaleMix>0){var d=Math.sqrt(t.resultMatrix.a*t.resultMatrix.a+t.resultMatrix.c*t.resultMatrix.c),f=Math.sqrt(e*e+a*a),y=d>1e-5?(d+(f-d+this._data.offsetScaleX)*this.scaleMix)/d:0;t.resultMatrix.a*=y,t.resultMatrix.c*=y,d=Math.sqrt(t.resultMatrix.b*t.resultMatrix.b+t.resultMatrix.d*t.resultMatrix.d),f=Math.sqrt(i*i+r*r),y=d>1e-5?(d+(f-d+this._data.offsetScaleY)*this.scaleMix)/d:0,t.resultMatrix.b*=y,t.resultMatrix.d*=y}if(this.shearMix>0){l=t.resultMatrix.b,u=t.resultMatrix.d;var g=Math.atan2(u,l);(c=Math.atan2(r,i)-Math.atan2(a,e)-(g-Math.atan2(t.resultMatrix.c,t.resultMatrix.a)))>Math.PI?c-=2*Math.PI:c<-Math.PI&&(c+=2*Math.PI),c=g+(c+this._data.offsetShearY*Math.PI/180)*this.shearMix,y=Math.sqrt(l*l+u*u),t.resultMatrix.b=Math.cos(c)*y,t.resultMatrix.d=Math.sin(c)*y}}}}]),t}(),S=function(t){function a(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,a);var i=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));return i._boneMatrixArray=[],i._lastTime=0,i._currAniIndex=-1,i._pause=!0,i._aniClipIndex=-1,i._clipIndex=-1,i._skinIndex=0,i._skinName="default",i._aniMode=0,i._index=-1,i._total=-1,i._indexControl=!1,i._eventIndex=0,i._drawOrderIndex=0,i._drawOrder=null,i._lastAniClipIndex=-1,i._lastUpdateAniClipIndex=-1,i._playAudio=!0,i._soundChannelArr=[],t&&i.init(t,e),i}return _inherits(a,e.Sprite),_createClass(a,[{key:"init",value:function(t){var i,a,r,s,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,h=0;if(1==n)for(this._graphicsCache=[],h=0,i=t.getAnimationCount();h<i;h++)this._graphicsCache.push([]);if(this._yReverseMatrix=t.yReverseMatrix,this._aniMode=n,this._templet=t,this._templet._addReference(1),this._player=new o,this._player.cacheFrameRate=t.rate,this._player.templet=t,this._player.play(),this._parseSrcBoneMatrix(),this._boneList=t.mBoneArr,this._rootBone=t.mRootBone,this._aniSectionDic=t.aniSectionDic,t.ikArr.length>0)for(this._ikArr=[],h=0,i=t.ikArr.length;h<i;h++)this._ikArr.push(new I(t.ikArr[h],this._boneList));if(t.pathArr.length>0)for(null==this._pathDic&&(this._pathDic={}),h=0,i=t.pathArr.length;h<i;h++)a=t.pathArr[h],r=new A(a,this._boneList),(s=this._boneSlotDic[a.name])&&((r=new A(a,this._boneList)).target=s),this._pathDic[a.name]=r;if(t.tfArr.length>0)for(this._tfArr=[],h=0,i=t.tfArr.length;h<i;h++)this._tfArr.push(new T(t.tfArr[h],this._boneList));if(t.skinDataArray.length>0){var l=this._templet.skinDataArray[this._skinIndex];this._skinName=l.name}this._player.on(e.Event.PLAYED,this,this._onPlay),this._player.on(e.Event.STOPPED,this,this._onStop),this._player.on(e.Event.PAUSED,this,this._onPause)}},{key:"load",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._aniPath=t,this._complete=i,this._loadAniMode=a,e.ILaya.loader.load([{url:t,type:e.ILaya.Loader.BUFFER}],e.Handler.create(this,this._onLoaded))}},{key:"_onLoaded",value:function(){var t,a=e.ILaya.Loader.getRes(this._aniPath);null!=a&&(null==i.Templet.TEMPLET_DICTIONARY&&(i.Templet.TEMPLET_DICTIONARY={}),(t=i.Templet.TEMPLET_DICTIONARY[this._aniPath])?t.isParseFail?this._parseFail():t.isParserComplete?this._parseComplete():(t.on(e.Event.COMPLETE,this,this._parseComplete),t.on(e.Event.ERROR,this,this._parseFail)):((t=new i.Templet)._setCreateURL(this._aniPath),i.Templet.TEMPLET_DICTIONARY[this._aniPath]=t,t.on(e.Event.COMPLETE,this,this._parseComplete),t.on(e.Event.ERROR,this,this._parseFail),t.isParserComplete=!1,t.parseData(null,a)))}},{key:"_parseComplete",value:function(){var t=i.Templet.TEMPLET_DICTIONARY[this._aniPath];t&&(this.init(t,this._loadAniMode),this.play(0,!0)),this._complete&&this._complete.runWith(this)}},{key:"_parseFail",value:function(){console.log("[Error]:"+this._aniPath+"解析失败")}},{key:"_onPlay",value:function(){this.event(e.Event.PLAYED)}},{key:"_onStop",value:function(){var t,i=this._templet.eventAniArr[this._aniClipIndex];if(i&&this._eventIndex<i.length)for(;this._eventIndex<i.length;this._eventIndex++)(t=i[this._eventIndex]).time>=this._player.playStart&&t.time<=this._player.playEnd&&this.event(e.Event.LABEL,t);this._drawOrder=null,this.event(e.Event.STOPPED)}},{key:"_onPause",value:function(){this.event(e.Event.PAUSED)}},{key:"_parseSrcBoneMatrix",value:function(){var t=0,i=0;for(i=this._templet.srcBoneMatrixArr.length,t=0;t<i;t++)this._boneMatrixArray.push(new e.Matrix);if(0==this._aniMode)this._boneSlotDic=this._templet.boneSlotDic,this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic,this._boneSlotArray=this._templet.boneSlotArray;else{null==this._boneSlotDic&&(this._boneSlotDic={}),null==this._bindBoneBoneSlotDic&&(this._bindBoneBoneSlotDic={}),null==this._boneSlotArray&&(this._boneSlotArray=[]);var a,r,s=this._templet.boneSlotArray;for(t=0,i=s.length;t<i;t++)a=s[t],null==(r=this._bindBoneBoneSlotDic[a.parent])&&(this._bindBoneBoneSlotDic[a.parent]=r=[]),this._boneSlotDic[a.name]=a=a.copy(),r.push(a),this._boneSlotArray.push(a)}}},{key:"_emitMissedEvents",value:function(t,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=this._templet.eventAniArr[this._player.currentAnimationClipIndex];if(r){var s,n,h=0;for(s=r.length,h=a;h<s;h++)(n=r[h]).time>=this._player.playStart&&n.time<=this._player.playEnd&&this.event(e.Event.LABEL,n)}}},{key:"_update",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!(this._pause||t&&this._indexControl)){var i=this.timer.currTimer,a=this._player.currentKeyframeIndex,r=i-this._lastTime;if(t?this._player._update(r):a=-1,this._lastTime=i,this._player&&(this._index=this._clipIndex=this._player.currentKeyframeIndex,!(this._index<0||r>0&&this._clipIndex==a&&this._lastUpdateAniClipIndex==this._aniClipIndex))){this._lastUpdateAniClipIndex=this._aniClipIndex,a>this._clipIndex&&0!=this._eventIndex&&(this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex),this._eventIndex=0);var s,n,h=this._templet.eventAniArr[this._aniClipIndex];if(h&&this._eventIndex<h.length){var l=h[this._eventIndex];l.time>=this._player.playStart&&l.time<=this._player.playEnd?this._player.currentPlayTime>=l.time&&(this.event(e.Event.LABEL,l),this._eventIndex++,this._playAudio&&l.audioValue&&"null"!==l.audioValue&&"undefined"!==l.audioValue&&(s=e.SoundManager.playSound(this._player.templet._path+l.audioValue,1,e.Handler.create(this,this._onAniSoundStoped)),e.SoundManager.playbackRate=this._player.playbackRate,s&&this._soundChannelArr.push(s))):l.time<this._player.playStart&&this._playAudio&&l.audioValue&&"null"!==l.audioValue&&"undefined"!==l.audioValue?(this._eventIndex++,s=e.SoundManager.playSound(this._player.templet._path+l.audioValue,1,e.Handler.create(this,this._onAniSoundStoped),null,(this._player.currentPlayTime-l.time)/1e3),e.SoundManager.playbackRate=this._player.playbackRate,s&&this._soundChannelArr.push(s)):this._eventIndex++}0==this._aniMode?(n=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics())&&this.graphics!=n&&(this.graphics=n):1==this._aniMode?(n=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics())&&this.graphics!=n&&(this.graphics=n):this._createGraphics()}}}},{key:"_onAniSoundStoped",value:function(t){for(var e,i=this._soundChannelArr.length,a=0;a<i;a++)((e=this._soundChannelArr[a]).isStopped||t)&&(!e.isStopped&&e.stop(),this._soundChannelArr.splice(a,1),i--,a--)}},{key:"_createGraphics",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;-1==t&&(t=this._clipIndex);var i,a=t*this._player.cacheFrameRateInterval,r=this._templet.drawOrderAniArr[this._aniClipIndex];if(r&&r.length>0)for(this._drawOrderIndex=0,i=r[this._drawOrderIndex];a>=i.time&&(this._drawOrder=i.drawOrder,this._drawOrderIndex++,!(this._drawOrderIndex>=r.length));)i=r[this._drawOrderIndex];0==this._aniMode||1==this._aniMode?this.graphics=_.create():this.graphics instanceof _?this.graphics.clear():this.graphics=_.create();var s=this.graphics,n=this._templet.getNodes(this._aniClipIndex),h=0==this._player.state;this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,null,t,h?a+this._player.cacheFrameRateInterval:a);var l,o,u,c,p=this._aniSectionDic[this._aniClipIndex],d=0,f=0,y=0,g=0,v=0,m=this._templet.srcBoneMatrixArr.length,x=this._curOriginalData;for(f=0,v=p[0];f<m;f++){var M=(c=this._boneList[f]).resultTransform;u=this._templet.srcBoneMatrixArr[f],M.scX=u.scX*x[d++],M.skX=u.skX+x[d++],M.skY=u.skY+x[d++],M.scY=u.scY*x[d++],M.x=u.x+x[d++],M.y=u.y+x[d++],8===this._templet.tMatrixDataLen&&(M.skewX=u.skewX+x[d++],M.skewY=u.skewY+x[d++])}var D,k={},I={};for(v+=p[1];f<v;f++)k[(D=n[f]).name]=x[d++],I[D.name]=x[d++],d+=4;var C,A,b={},T={};for(v+=p[2];f<v;f++)b[(D=n[f]).name]=x[d++],T[D.name]=x[d++],d+=4;if(this._pathDic)for(v+=p[3];f<v;f++){if(D=n[f],C=this._pathDic[D.name])switch(new e.Byte(D.extenData).getByte()){case 1:C.position=x[d++];break;case 2:C.spacing=x[d++];break;case 3:C.rotateMix=x[d++],C.translateMix=x[d++]}}if(this._rootBone.update(this._yReverseMatrix||e.Matrix.TEMP.identity()),this._ikArr)for(f=0,v=this._ikArr.length;f<v;f++)(A=this._ikArr[f]).name in b&&(A.bendDirection=b[A.name]),A.name in T&&(A.mix=T[A.name]),A.apply();if(this._pathDic)for(var S in this._pathDic)(C=this._pathDic[S]).apply(this._boneList,s);if(this._tfArr)for(f=0,g=this._tfArr.length;f<g;f++)this._tfArr[f].apply();for(f=0,g=this._boneList.length;f<g;f++)if(c=this._boneList[f],o=this._bindBoneBoneSlotDic[c.name],c.resultMatrix.copyTo(this._boneMatrixArray[f]),o)for(y=0,v=o.length;y<v;y++)(l=o[y])&&l.setParentMatrix(c.resultMatrix);var F,w,P,L,U={},B=this._templet.deformAniArr;if(B&&B.length>0){if(this._lastAniClipIndex!=this._aniClipIndex)for(this._lastAniClipIndex=this._aniClipIndex,f=0,v=this._boneSlotArray.length;f<v;f++)(l=this._boneSlotArray[f]).deformData=null;var E,R=B[this._aniClipIndex];for(E in F=R.default,this._setDeform(F,U,this._boneSlotArray,a),R)"default"!=E&&E!=this._skinName&&(F=R[E],this._setDeform(F,U,this._boneSlotArray,a));F=R[this._skinName],this._setDeform(F,U,this._boneSlotArray,a)}if(this._drawOrder)for(f=0,v=this._drawOrder.length;f<v;f++)w=k[(l=this._boneSlotArray[this._drawOrder[f]]).name],P=I[l.name],isNaN(w)||-2==w||(this._templet.attachmentNames?l.showDisplayByName(this._templet.attachmentNames[w]):l.showDisplayByIndex(w)),U[this._drawOrder[f]]?(L=U[this._drawOrder[f]],l.currDisplayData&&L[l.currDisplayData.attachmentName]?l.deformData=L[l.currDisplayData.attachmentName]:l.deformData=null):l.deformData=null,isNaN(P)?l.draw(s,this._boneMatrixArray,2==this._aniMode):l.draw(s,this._boneMatrixArray,2==this._aniMode,P);else for(f=0,v=this._boneSlotArray.length;f<v;f++)w=k[(l=this._boneSlotArray[f]).name],P=I[l.name],isNaN(w)||-2==w||(this._templet.attachmentNames?l.showDisplayByName(this._templet.attachmentNames[w]):l.showDisplayByIndex(w)),U[f]?(L=U[f],l.currDisplayData&&L[l.currDisplayData.attachmentName]?l.deformData=L[l.currDisplayData.attachmentName]:l.deformData=null):l.deformData=null,isNaN(P)?l.draw(s,this._boneMatrixArray,2==this._aniMode):l.draw(s,this._boneMatrixArray,2==this._aniMode,P);return 0==this._aniMode?(this._templet.setGrahicsDataWithCache(this._aniClipIndex,t,s),this._checkIsAllParsed(this._aniClipIndex)):1==this._aniMode&&this._setGrahicsDataWithCache(this._aniClipIndex,t,s),s}},{key:"_checkIsAllParsed",value:function(t){var e,i;for(i=Math.floor(.01+this._templet.getAniDuration(t)/1e3*this._player.cacheFrameRate),e=0;e<i;e++)if(!this._templet.getGrahicsDataWithCache(t,e))return;this._templet.getGrahicsDataWithCache(t,i)?this._templet.deleteAniData(t):this._createGraphics(i)}},{key:"_setDeform",value:function(t,e,i,a){var r,s,n,h,l,o;if(t&&t)for(h=0,l=t.deformSlotDataList.length;h<l;h++)for(r=t.deformSlotDataList[h],o=0;o<r.deformSlotDisplayList.length;o++)n=i[(s=r.deformSlotDisplayList[o]).slotIndex],s.apply(a,n),e[s.slotIndex]||(e[s.slotIndex]={}),e[s.slotIndex][s.attachment]=s.deformData}},{key:"getAnimNum",value:function(){return this._templet.getAnimationCount()}},{key:"getAniNameByIndex",value:function(t){return this._templet.getAniNameByIndex(t)}},{key:"getSlotByName",value:function(t){return this._boneSlotDic[t]}},{key:"showSkinByName",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.showSkinByIndex(this._templet.getSkinIndexByName(t),e)}},{key:"showSkinByIndex",value:function(t){for(var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=0;i<this._boneSlotArray.length;i++)this._boneSlotArray[i].showSlotData(null,e);if(this._templet.showSkinByIndex(this._boneSlotDic,t,e)){var a=this._templet.skinDataArray[t];this._skinIndex=t,this._skinName=a.name}this._clearCache()}},{key:"showSlotSkinByIndex",value:function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByIndex(e),this._clearCache()}}},{key:"showSlotSkinByName",value:function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByName(e),this._clearCache()}}},{key:"replaceSlotSkinName",value:function(t,e,i){if(0!=this._aniMode){var a=this.getSlotByName(t);a&&a.replaceDisplayByName(e,i),this._clearCache()}}},{key:"replaceSlotSkinByIndex",value:function(t,e,i){if(0!=this._aniMode){var a=this.getSlotByName(t);a&&a.replaceDisplayByIndex(e,i),this._clearCache()}}},{key:"setSlotSkin",value:function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.replaceSkin(e),this._clearCache()}}},{key:"_clearCache",value:function(){if(1==this._aniMode)for(var t=0,e=this._graphicsCache.length;t<e;t++){for(var i=0,a=this._graphicsCache[t].length;i<a;i++){var r=this._graphicsCache[t][i];r&&r!=this.graphics&&_.recycle(r)}this._graphicsCache[t].length=0}}},{key:"play",value:function(t,i){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,n=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],h=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];this._playAudio=h,this._indexControl=!1;var l,o=-1;if(l=i?2147483647:0,"string"==typeof t)for(var u=0,c=this._templet.getAnimationCount();u<c;u++){var _=this._templet.getAnimation(u);if(_&&t==_.name){o=u;break}}else o=t;o>-1&&o<this.getAnimNum()&&(this._aniClipIndex=o,(a||this._pause||this._currAniIndex!=o)&&(this._currAniIndex=o,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(o)),this._drawOrder=null,this._eventIndex=0,this._player.play(o,this._player.playbackRate,l,r,s),n&&this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex),this._pause&&(this._pause=!1,this._lastTime=e.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)),this._update()))}},{key:"stop",value:function(){this._pause||(this._pause=!0,this._player&&this._player.stop(!0),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0),this.timer.clear(this,this._update))}},{key:"playbackRate",value:function(t){this._player&&(this._player.playbackRate=t)}},{key:"paused",value:function(){if(!this._pause){if(this._pause=!0,this._player&&(this._player.paused=!0),this._soundChannelArr.length>0)for(var t,e=this._soundChannelArr.length,i=0;i<e;i++)(t=this._soundChannelArr[i]).isStopped||t.pause();this.timer.clear(this,this._update)}}},{key:"resume",value:function(){if(this._indexControl=!1,this._pause){if(this._pause=!1,this._player&&(this._player.paused=!1),this._soundChannelArr.length>0)for(var t,i=this._soundChannelArr.length,a=0;a<i;a++)(t=this._soundChannelArr[a]).audioBuffer&&t.resume();this._lastTime=e.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)}}},{key:"_getGrahicsDataWithCache",value:function(t,e){return this._graphicsCache[t][e]}},{key:"_setGrahicsDataWithCache",value:function(t,e,i){this._graphicsCache[t][e]=i}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"destroy",this).call(this,t),this._templet._removeReference(1),this._templet=null,this._player&&this._player.offAll(),this._player=null,this._curOriginalData=null,this._boneMatrixArray.length=0,this._lastTime=0,this.timer.clear(this,this._update),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0)}},{key:"url",get:function(){return this._aniPath},set:function(t){this.load(t)}},{key:"index",get:function(){return this._index},set:function(t){this.player&&(this._index=t,this._player.currentTime=1e3*this._index/this._player.cacheFrameRate,this._indexControl=!0,this._update(!1))}},{key:"total",get:function(){return this._templet&&this._player?this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1e3*this._player.cacheFrameRate):this._total=-1,this._total}},{key:"player",get:function(){return this._player}},{key:"templet",get:function(){return this._templet}}]),a}();S.useSimpleMeshInCanvas=!1,i.Skeleton=S,e.ILaya.regClass(S),e.ClassUtils.regClass("laya.ani.bone.Skeleton",S),e.ClassUtils.regClass("Laya.Skeleton",S);var F=function t(){_classCallCheck(this,t),this.slotArr=[]},w=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"createTexture",value:function(t){return this.texture?this.texture:(this.texture=new e.Texture(t.bitmap,this.uvs),this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]?(this.texture.width=t.height,this.texture.height=t.width,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceHeight,this.texture.sourceHeight=t.sourceWidth):(this.texture.width=t.width,this.texture.height=t.height,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceWidth,this.texture.sourceHeight=t.sourceHeight),this.texture)}},{key:"destory",value:function(){this.texture&&this.texture.destroy()}}]),t}(),P=function(){function t(){_classCallCheck(this,t),this.displayArr=[]}return _createClass(t,[{key:"getDisplayByName",value:function(t){for(var e=0,i=this.displayArr.length;e<i;e++)if(this.displayArr[e].attachmentName==t)return e;return-1}}]),t}(),L=function t(){_classCallCheck(this,t),this.boneIndexs=[]},U=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments));return t._graphicsCache=[],t.srcBoneMatrixArr=[],t.ikArr=[],t.tfArr=[],t.pathArr=[],t.boneSlotDic={},t.bindBoneBoneSlotDic={},t.boneSlotArray=[],t.skinDataArray=[],t.skinDic={},t.subTextureDic={},t.isParseFail=!1,t.drawOrderAniArr=[],t.eventAniArr=[],t.attachmentNames=null,t.deformAniArr=[],t.skinSlotDisplayDataArr=[],t._isParseAudio=!1,t._isDestroyed=!1,t._rate=30,t.isParserComplete=!1,t.aniSectionDic={},t._textureDic={},t.mBoneArr=[],t}return _inherits(i,c),_createClass(i,[{key:"loadAni",value:function(t){this._skBufferUrl=t,e.ILaya.loader.load(t,e.Handler.create(this,this.onComplete),null,e.ILaya.Loader.BUFFER)}},{key:"onComplete",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._isDestroyed)this.destroy();else{var t=e.ILaya.Loader.getRes(this._skBufferUrl);t?(this._path=this._skBufferUrl.slice(0,this._skBufferUrl.lastIndexOf("/"))+"/",this.parseData(null,t)):this.event(e.Event.ERROR,"load failed:"+this._skBufferUrl)}}},{key:"parseData",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30;if(!this._path){var a=this._relativeUrl||this.url;if(a){var r=a.lastIndexOf("/");this._path=r>0?a.slice(0,r)+"/":""}}this._mainTexture=t,this._rate=i,this.parse(e)}},{key:"buildArmature",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new S(this,t)}},{key:"parse",value:function(t){_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"parse",this).call(this,t),this.event(e.Event.LOADED,this),this._aniVersion===i.LAYA_ANIMATION_VISION?this._isParseAudio=!0:this._aniVersion!=i.LAYA_ANIMATION_160_VISION&&console.log("[Error] 版本不一致，请使用IDE版本配套的重新导出"+this._aniVersion+"->"+i.LAYA_ANIMATION_VISION),this._mainTexture?this._parsePublicExtData():this._parseTexturePath()}},{key:"_parseTexturePath",value:function(){if(this._isDestroyed)this.destroy();else{var t=0;this._loadList=[];var i,a=new e.Byte(this.getPublicExtData()),r=a.getInt32(),s=a.readUTFString(),n=s.split("\n");for(t=0;t<r;t++)i=this._path+n[2*t],s=n[2*t+1],a.getFloat32(),a.getFloat32(),a.getFloat32(),a.getFloat32(),a.getFloat32(),a.getFloat32(),a.getFloat32(),a.getFloat32(),-1==this._loadList.indexOf(i)&&this._loadList.push(i);e.ILaya.loader.load(this._loadList,e.Handler.create(this,this._textureComplete))}}},{key:"_textureComplete",value:function(){for(var t,i=0,a=this._loadList.length;i<a;i++)t=this._loadList[i],this._textureDic[t]=e.ILaya.Loader.getRes(t);this._parsePublicExtData()}},{key:"_parsePublicExtData",value:function(){var t,i=0,a=0,r=0,s=0,n=0;for(i=0,n=this.getAnimationCount();i<n;i++)this._graphicsCache.push([]);t="Dragon"!=this._aniClassName;var h,l,o=new e.Byte(this.getPublicExtData()),u=0,c=0,_=0,f=0,y=0,g=0,I=0,A=0,T=0,S=o.getInt32(),U=o.readUTFString(),B=U.split("\n");for(i=0;i<S;i++){if(h=this._mainTexture,l=this._path+B[2*i],U=B[2*i+1],null==this._mainTexture&&(h=this._textureDic[l]),!h)return this.event(e.Event.ERROR,this),void(this.isParseFail=!0);u=o.getFloat32(),c=o.getFloat32(),_=o.getFloat32(),f=o.getFloat32(),T=o.getFloat32(),y=isNaN(T)?0:T,T=o.getFloat32(),g=isNaN(T)?0:T,T=o.getFloat32(),I=isNaN(T)?_:T,T=o.getFloat32(),A=isNaN(T)?f:T,this.subTextureDic[U]=e.Texture.create(h,u,c,_,f,-y,-g,I,A)}this._mainTexture=h;var E,R,O,N,V,Y=o.getUint16();for(i=0;i<Y;i++)(E=[]).push(o.getUint16()),E.push(o.getUint16()),E.push(o.getUint16()),E.push(o.getUint16()),this.aniSectionDic[i]=E;var K,X=o.getInt16(),W={};for(i=0;i<X;i++)R=new d,0==i?K=R:R.root=K,R.d=t?-1:1,N=o.readUTFString(),V=o.readUTFString(),R.length=o.getFloat32(),1==o.getByte()&&(R.inheritRotation=!1),1==o.getByte()&&(R.inheritScale=!1),R.name=N,V&&((O=W[V])?O.addChild(R):this.mRootBone=R),W[N]=R,this.mBoneArr.push(R);this.tMatrixDataLen=o.getUint16();var z,G,q=o.getUint16(),j=Math.floor(q/this.tMatrixDataLen),H=this.srcBoneMatrixArr;for(i=0;i<j;i++)(z=new p).scX=o.getFloat32(),z.skX=o.getFloat32(),z.skY=o.getFloat32(),z.scY=o.getFloat32(),z.x=o.getFloat32(),z.y=o.getFloat32(),8===this.tMatrixDataLen&&(z.skewX=o.getFloat32(),z.skewY=o.getFloat32()),H.push(z),(R=this.mBoneArr[i]).transform=z;var Q,Z,J=o.getUint16();for(i=0;i<J;i++){for(G=new C,Q=o.getUint16(),a=0;a<Q;a++)G.boneNames.push(o.readUTFString()),G.boneIndexs.push(o.getInt16());G.name=o.readUTFString(),G.targetBoneName=o.readUTFString(),G.targetBoneIndex=o.getInt16(),G.bendDirection=o.getFloat32(),G.mix=o.getFloat32(),G.isSpine=t,this.ikArr.push(G)}var $,tt,et=o.getUint16();for(i=0;i<et;i++){for(Z=new L,$=o.getUint16(),a=0;a<$;a++)Z.boneIndexs.push(o.getInt16());Z.name=o.getUTFString(),Z.targetIndex=o.getInt16(),Z.rotateMix=o.getFloat32(),Z.translateMix=o.getFloat32(),Z.scaleMix=o.getFloat32(),Z.shearMix=o.getFloat32(),Z.offsetRotation=o.getFloat32(),Z.offsetX=o.getFloat32(),Z.offsetY=o.getFloat32(),Z.offsetScaleX=o.getFloat32(),Z.offsetScaleY=o.getFloat32(),Z.offsetShearY=o.getFloat32(),this.tfArr.push(Z)}var it,at,rt,st,nt,ht,lt,ot,ut,ct,_t=o.getUint16();for(i=0;i<_t;i++){for((tt=new b).name=o.readUTFString(),it=o.getUint16(),a=0;a<it;a++)tt.bones.push(o.getInt16());tt.target=o.readUTFString(),tt.positionMode=o.readUTFString(),tt.spacingMode=o.readUTFString(),tt.rotateMode=o.readUTFString(),tt.offsetRotation=o.getFloat32(),tt.position=o.getFloat32(),tt.spacing=o.getFloat32(),tt.rotateMix=o.getFloat32(),tt.translateMix=o.getFloat32(),this.pathArr.push(tt)}var pt,dt=o.getInt16();for(i=0;i<dt;i++){var ft=o.getUint8(),yt={};this.deformAniArr.push(yt);for(var gt=0;gt<ft;gt++)for((lt=new m).skinName=o.getUTFString(),yt[lt.skinName]=lt,at=o.getInt16(),a=0;a<at;a++)for(ot=new x,lt.deformSlotDataList.push(ot),rt=o.getInt16(),r=0;r<rt;r++)for(ut=new M,ot.deformSlotDisplayList.push(ut),ut.slotIndex=o.getInt16(),ut.attachment=o.getUTFString(),st=o.getInt16(),s=0;s<st;s++)for(1==o.getByte()?ut.tweenKeyList.push(!0):ut.tweenKeyList.push(!1),nt=o.getFloat32(),ut.timeList.push(nt),ct=[],ut.vectices.push(ct),ht=o.getInt16(),n=0;n<ht;n++)ct.push(o.getFloat32())}var vt,mt,xt,Mt,Dt=o.getInt16();for(i=0;i<Dt;i++){for(vt=o.getInt16(),pt=[],a=0;a<vt;a++){for((mt=new D).time=o.getFloat32(),xt=o.getInt16(),r=0;r<xt;r++)mt.drawOrder.push(o.getInt16());pt.push(mt)}this.drawOrderAniArr.push(pt)}var kt,It,Ct=o.getInt16();for(i=0;i<Ct;i++){for(kt=o.getInt16(),Mt=[],a=0;a<kt;a++)(It=new k).name=o.getUTFString(),this._isParseAudio&&(It.audioValue=o.getUTFString()),It.intValue=o.getInt32(),It.floatValue=o.getFloat32(),It.stringValue=o.getUTFString(),It.time=o.getFloat32(),Mt.push(It);this.eventAniArr.push(Mt)}var At=o.getInt16();if(At>0)for(this.attachmentNames=[],i=0;i<At;i++)this.attachmentNames.push(o.getUTFString());var bt,Tt,St=o.getInt16();for(i=0;i<St;i++)(bt=new v).name=o.readUTFString(),bt.parent=o.readUTFString(),bt.attachmentName=o.readUTFString(),bt.srcDisplayIndex=bt.displayIndex=o.getInt16(),bt.templet=this,this.boneSlotDic[bt.name]=bt,null==(Tt=this.bindBoneBoneSlotDic[bt.parent])&&(this.bindBoneBoneSlotDic[bt.parent]=Tt=[]),Tt.push(bt),this.boneSlotArray.push(bt);var Ft,wt,Pt,Lt,Ut,Bt,Et,Rt,Ot,Nt,Vt=o.readUTFString().split("\n"),Yt=0,Kt=o.getUint8();for(i=0;i<Kt;i++){for((Ft=new F).name=Vt[Yt++],Lt=o.getUint8(),a=0;a<Lt;a++){for((wt=new P).name=Vt[Yt++],bt=this.boneSlotDic[wt.name],Ut=o.getUint8(),r=0;r<Ut;r++){if(Pt=new w,this.skinSlotDisplayDataArr.push(Pt),Pt.name=Vt[Yt++],Pt.attachmentName=Vt[Yt++],Pt.transform=new p,Pt.transform.scX=o.getFloat32(),Pt.transform.skX=o.getFloat32(),Pt.transform.skY=o.getFloat32(),Pt.transform.scY=o.getFloat32(),Pt.transform.x=o.getFloat32(),Pt.transform.y=o.getFloat32(),wt.displayArr.push(Pt),Pt.width=o.getFloat32(),Pt.height=o.getFloat32(),Pt.type=o.getUint8(),Pt.verLen=o.getUint16(),(X=o.getUint16())>0)for(Pt.bones=[],s=0;s<X;s++){var Xt=o.getUint16();Pt.bones.push(Xt)}if((Bt=o.getUint16())>0)for(Pt.uvs=[],s=0;s<Bt;s++)Pt.uvs.push(o.getFloat32());if((Et=o.getUint16())>0)for(Pt.weights=[],s=0;s<Et;s++)Pt.weights.push(o.getFloat32());if((Rt=o.getUint16())>0)for(Pt.triangles=[],s=0;s<Rt;s++)Pt.triangles.push(o.getUint16());if((Ot=o.getUint16())>0)for(Pt.vertices=[],s=0;s<Ot;s++)Pt.vertices.push(o.getFloat32());if((Nt=o.getUint16())>0)for(Pt.lengths=[],s=0;s<Nt;s++)Pt.lengths.push(o.getFloat32())}Ft.slotArr.push(wt)}this.skinDic[Ft.name]=Ft,this.skinDataArray.push(Ft)}1==o.getUint8()?(this.yReverseMatrix=new e.Matrix(1,0,0,-1,0,0),K&&K.setTempMatrix(this.yReverseMatrix)):K&&K.setTempMatrix(new e.Matrix),this.showSkinByIndex(this.boneSlotDic,0),this.isParserComplete=!0,this.event(e.Event.COMPLETE,this)}},{key:"getTexture",value:function(t){var e=this.subTextureDic[t];return e||(e=this.subTextureDic[t.substr(0,t.length-1)]),null==e?this._mainTexture:e}},{key:"showSkinByIndex",value:function(t,e){var i,a,r,s,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(e<0&&e>=this.skinDataArray.length)return!1;var h=this.skinDataArray[e];if(h){for(i=0,a=h.slotArr.length;i<a;i++)(s=h.slotArr[i])&&(r=t[s.name])&&(r.showSlotData(s,n),n&&"undefined"!=r.attachmentName&&"null"!=r.attachmentName?r.showDisplayByName(r.attachmentName):r.showDisplayByIndex(r.displayIndex));return!0}return!1}},{key:"getSkinIndexByName",value:function(t){for(var e=0,i=this.skinDataArray.length;e<i;e++)if(this.skinDataArray[e].name==t)return e;return-1}},{key:"getGrahicsDataWithCache",value:function(t,e){return this._graphicsCache[t]&&this._graphicsCache[t][e]?this._graphicsCache[t][e]:null}},{key:"_setCreateURL",value:function(t){this._skBufferUrl=this._relativeUrl=t,_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"_setCreateURL",this).call(this,t)}},{key:"setGrahicsDataWithCache",value:function(t,e,i){this._graphicsCache[t][e]=i}},{key:"deleteAniData",value:function(t){if(this._anis[t]){var e=this._anis[t];e.bone3DMap=null,e.nodes=null}}},{key:"destroy",value:function(){var t;for(t in this._isDestroyed=!0,this.subTextureDic)t&&this.subTextureDic[t].destroy();for(t in this._textureDic)t&&this._textureDic[t].destroy();for(var a=0,r=this.skinSlotDisplayDataArr.length;a<r;a++)this.skinSlotDisplayDataArr[a].destory();this.skinSlotDisplayDataArr.length=0,this._relativeUrl&&delete i.TEMPLET_DICTIONARY[this._relativeUrl],_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this),e.ILaya.loader.clearRes(this._skBufferUrl)}},{key:"getAniNameByIndex",value:function(t){var e=this.getAnimation(t);return e?e.name:null}},{key:"rate",get:function(){return this._rate},set:function(t){this._rate=t}}]),i}();U.LAYA_ANIMATION_160_VISION="LAYAANIMATION:1.6.0",U.LAYA_ANIMATION_VISION="LAYAANIMATION:1.7.0",i.Templet=U;var B=function(t){function i(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;_classCallCheck(this,i);var a=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return a._start=0,a._Pos=0,a._ended=!0,a._loadedImage={},a._endFrame=-1,a.interval=30,a._ids={},a._idOfSprite=[],a._reset(),a._playing=!1,a._parentMovieClip=t,t?(a._isRoot=!1,a._movieClipList=t._movieClipList,a._movieClipList.push(a)):(a._movieClipList=[a],a._isRoot=!0,a._setBitUp(e.Const.DISPLAY)),a}return _inherits(i,e.Sprite),_createClass(i,[{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._clear(),_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this,t)}},{key:"_setDisplay",value:function(t){_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"_setDisplay",this).call(this,t),this._isRoot&&this._onDisplay(t)}},{key:"_onDisplay",value:function(t){t?this.timer.loop(this.interval,this,this.updates,null,!0):this.timer.clear(this,this.updates)}},{key:"updates",value:function(){var t,e;if(!this._parentMovieClip)for(e=this._movieClipList.length,t=0;t<e;t++)this._movieClipList[t]&&this._movieClipList[t]._update()}},{key:"addLabel",value:function(t,e){this._labels||(this._labels={}),this._labels[e]=t}},{key:"removeLabel",value:function(t){if(t){if(!this._labels)for(var e in this._labels)if(this._labels[e]===t){delete this._labels[e];break}}else this._labels=null}},{key:"_update",value:function(){if(this._data&&this._playing){if(this._playIndex++,this._playIndex>=this._count){if(!this.loop)return this._playIndex--,void this.stop();this._playIndex=0}if(this._parseFrame(this._playIndex),this._labels&&this._labels[this._playIndex]&&this.event(e.Event.LABEL,this._labels[this._playIndex]),-1!=this._endFrame&&this._endFrame==this._playIndex){if(this._endFrame=-1,null!=this._completeHandler){var t=this._completeHandler;this._completeHandler=null,t.run()}this.stop()}}}},{key:"stop",value:function(){this._playing=!1}},{key:"gotoAndStop",value:function(t){this.index=t,this.stop()}},{key:"_clear",value:function(){if(this.stop(),this._idOfSprite.length=0,!this._parentMovieClip){var t,i;for(this.timer.clear(this,this.updates),i=this._movieClipList.length,t=0;t<i;t++)this._movieClipList[t]!=this&&this._movieClipList[t]._clear();this._movieClipList.length=0}var a;for(a in this._atlasPath&&e.ILaya.Loader.clearRes(this._atlasPath),this._loadedImage)this._loadedImage[a]&&(e.ILaya.Loader.clearRes(a),this._loadedImage[a]=!1);this.removeChildren(),this.graphics=null,this._parentMovieClip=null}},{key:"play",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.loop=e,this._playing=!0,this._data&&this._displayFrame(t)}},{key:"_displayFrame",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;-1!=t&&(this._curIndex>t&&this._reset(),this._parseFrame(t))}},{key:"_reset",value:function(){(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])&&1!=this._curIndex&&this.removeChildren(),this._preIndex=this._curIndex=-1,this._Pos=this._start}},{key:"_parseFrame",value:function(t){var a,r,s,n,h,l,o=!1,u=this._idOfSprite,c=this._data;for(this._ended&&this._reset(),c.pos=this._Pos,this._ended=!1,this._playIndex=t,this._curIndex>t&&t<this._preIndex&&(this._reset(!0),c.pos=this._Pos);this._curIndex<=t&&!this._ended;)switch(c.getUint16()){case 12:if(s=c.getUint16(),n=this._ids[c.getUint16()],this._Pos=c.pos,c.pos=n,0==(h=c.getUint8())){var _=c.getUint16();if(!(r=u[s])){r=u[s]=new e.Sprite;var p=new e.Sprite;p.loadImage(this.basePath+_+".png"),this._loadedImage[this.basePath+_+".png"]=!0,r.addChild(p),p.size(c.getFloat32(),c.getFloat32());var d=c._getMatrix();p.transform=d}r.alpha=1}else 1==h&&((a=u[s])||(u[s]=a=new i(this),a.interval=this.interval,a._ids=this._ids,a.basePath=this.basePath,a._setData(c,n),a._initState(),a.play(0)),a.alpha=1);c.pos=this._Pos;break;case 3:var f=u[c.getUint16()];f&&(this.addChild(f),f.zOrder=c.getUint16(),o=!0);break;case 4:(f=u[c.getUint16()])&&f.removeSelf();break;case 5:u[c.getUint16()][i._ValueList[c.getUint16()]]=c.getFloat32();break;case 6:u[c.getUint16()].visible=c.getUint8()>0;break;case 7:var y=(r=u[c.getUint16()]).transform||e.Matrix.create();y.setTo(c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32()),r.transform=y;break;case 8:u[c.getUint16()].setPos(c.getFloat32(),c.getFloat32());break;case 9:u[c.getUint16()].setSize(c.getFloat32(),c.getFloat32());break;case 10:u[c.getUint16()].alpha=c.getFloat32();break;case 11:u[c.getUint16()].setScale(c.getFloat32(),c.getFloat32());break;case 98:l=c.getString(),this.event(l),"stop"==l&&this.stop();break;case 99:this._curIndex=c.getUint16(),o&&this.updateZOrder();break;case 100:this._count=this._curIndex+1,this._ended=!0,this._playing&&(this.event(e.Event.FRAME),this.event(e.Event.END),this.event(e.Event.COMPLETE)),this._reset(!1)}this._playing&&!this._ended&&this.event(e.Event.FRAME),this._Pos=c.pos}},{key:"_setData",value:function(t,e){this._data=t,this._start=e+3}},{key:"load",value:function(t){var i,a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._url=t,a&&(this._atlasPath=r||t.split(".swf")[0]+".json"),this.stop(),this._clear(),this._movieClipList=[this],i=[{url:t,type:e.ILaya.Loader.BUFFER}],this._atlasPath&&i.push({url:this._atlasPath,type:e.ILaya.Loader.ATLAS}),e.ILaya.loader.load(i,e.Handler.create(this,this._onLoaded))}},{key:"_onLoaded",value:function(){var t;(t=e.ILaya.Loader.getRes(this._url))?!this._atlasPath||e.ILaya.Loader.getAtlas(this._atlasPath)?(this.basePath=this._atlasPath?e.ILaya.Loader.getAtlas(this._atlasPath).dir:this._url.split(".swf")[0]+"/image/",this._initData(t)):this.event(e.Event.ERROR,"Atlas not find"):this.event(e.Event.ERROR,"file not find")}},{key:"_initState",value:function(){this._reset(),this._ended=!1;var t=this._playing;for(this._playing=!1,this._curIndex=0;!this._ended;)this._parseFrame(++this._curIndex);this._playing=t}},{key:"_initData",value:function(t){this._data=new e.Byte(t);var i,a=this._data.getUint16();for(i=0;i<a;i++)this._ids[this._data.getInt16()]=this._data.getInt32();this.interval=1e3/this._data.getUint16(),this._setData(this._data,this._ids[32767]),this._initState(),this.play(0),this.event(e.Event.LOADED),this._parentMovieClip||this.timer.loop(this.interval,this,this.updates,null,!0)}},{key:"playTo",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._completeHandler=i,this._endFrame=e,this.play(t,!1)}},{key:"index",get:function(){return this._playIndex},set:function(t){this._playIndex=t,this._data&&this._displayFrame(this._playIndex),this._labels&&this._labels[t]&&this.event(e.Event.LABEL,this._labels[t])}},{key:"count",get:function(){return this._count}},{key:"playing",get:function(){return this._playing}},{key:"url",set:function(t){this.load(t)}}]),i}();B._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"],t.AnimationContent=a,t.AnimationNodeContent=r,t.AnimationParser01=n,t.AnimationParser02=h,t.AnimationPlayer=o,t.AnimationState=l,t.AnimationTemplet=c,t.BezierLerp=u,t.Bone=d,t.BoneSlot=v,t.DeformAniData=m,t.DeformSlotData=x,t.DeformSlotDisplayData=M,t.DrawOrderData=D,t.EventData=k,t.GraphicsAni=_,t.IAniLib=i,t.IkConstraint=I,t.IkConstraintData=C,t.KeyFramesContent=s,t.MeshData=y,t.MovieClip=B,t.PathConstraint=A,t.PathConstraintData=b,t.Skeleton=S,t.SkinData=F,t.SkinMeshForGraphic=g,t.SkinSlotDisplayData=w,t.SlotData=P,t.Templet=U,t.TfConstraint=T,t.TfConstraintData=L,t.Transform=p,t.UVTools=f}(window.Laya=window.Laya||{},Laya);