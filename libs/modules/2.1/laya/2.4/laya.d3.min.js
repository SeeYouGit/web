"use strict";var _set=function e(t,n,r,i){var a=Object.getOwnPropertyDescriptor(t,n);if(void 0===a){var o=Object.getPrototypeOf(t);null!==o&&e(o,n,r,i)}else if("value"in a&&a.writable)a.value=r;else{var s=a.set;void 0!==s&&s.call(i,r)}return r},_get=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,r)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(r):void 0},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e,t){var n=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"isZero",value:function(t){return Math.abs(t)<e.zeroTolerance}},{key:"nearEqual",value:function(t,n){return!!e.isZero(t-n)}},{key:"fastInvSqrt",value:function(t){return e.isZero(t)?t:1/Math.sqrt(t)}}]),e}();n.zeroTolerance=1e-6,n.MaxValue=3.40282347e38,n.MinValue=-3.40282347e38;var r=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,e),this.x=t,this.y=n}return _createClass(e,[{key:"setValue",value:function(e,t){this.x=e,this.y=t}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1]}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"forNativeElement",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;t?(this.elements=t,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),e.rewriteNumProperty(this,"x",0),e.rewriteNumProperty(this,"y",1)}}],[{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"normalize",value:function(e,t){var n=e.x,r=e.y,i=n*n+r*r;i>0&&(i=1/Math.sqrt(i),t.x=n*i,t.y=r*i)}},{key:"scalarLength",value:function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)}},{key:"rewriteNumProperty",value:function(e,t,n){Object.defineProperty(e,t,{get:function(){return this.elements[n]},set:function(e){this.elements[n]=e}})}}]),e}();r.ZERO=new r(0,0),r.ONE=new r(1,1);var i=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,e),this.x=t,this.y=n,this.z=r,this.w=i}return _createClass(e,[{key:"setValue",value:function(e,t,n,r){this.x=e,this.y=t,this.z=n,this.w=r}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2),r.rewriteNumProperty(this,"w",3)}}],[{key:"lerp",value:function(e,t,n,r){var i=e.x,a=e.y,o=e.z,s=e.w;r.x=i+n*(t.x-i),r.y=a+n*(t.y-a),r.z=o+n*(t.z-o),r.w=s+n*(t.w-s)}},{key:"transformByM4x4",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=e.w,s=t.elements;n.x=r*s[0]+i*s[4]+a*s[8]+o*s[12],n.y=r*s[1]+i*s[5]+a*s[9]+o*s[13],n.z=r*s[2]+i*s[6]+a*s[10]+o*s[14],n.w=r*s[3]+i*s[7]+a*s[11]+o*s[15]}},{key:"equals",value:function(e,t){return n.nearEqual(Math.abs(e.x),Math.abs(t.x))&&n.nearEqual(Math.abs(e.y),Math.abs(t.y))&&n.nearEqual(Math.abs(e.z),Math.abs(t.z))&&n.nearEqual(Math.abs(e.w),Math.abs(t.w))}},{key:"normalize",value:function(e,t){var n=e.length();if(n>0){var r=1/n;t.x=e.x*r,t.y=e.y*r,t.z=e.z*r,t.w=e.w*r}}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z,n.w=e.w-t.w}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z,n.w=e.w*t.w}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t}},{key:"Clamp",value:function(e,t,n,r){var i=e.x,a=e.y,o=e.z,s=e.w,l=t.x,_=t.y,u=t.z,c=t.w,h=n.x,d=n.y,f=n.z,m=n.w;i=(i=i>h?h:i)<l?l:i,a=(a=a>d?d:a)<_?_:a,o=(o=o>f?f:o)<u?u:o,s=(s=s>m?m:s)<c?c:s,r.x=i,r.y=a,r.z=o,r.w=s}},{key:"distanceSquared",value:function(e,t){var n=e.x-t.x,r=e.y-t.y,i=e.z-t.z,a=e.w-t.w;return n*n+r*r+i*i+a*a}},{key:"distance",value:function(e,t){var n=e.x-t.x,r=e.y-t.y,i=e.z-t.z,a=e.w-t.w;return Math.sqrt(n*n+r*r+i*i+a*a)}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z),n.w=Math.min(e.w,t.w)}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z),n.w=Math.max(e.w,t.w)}}]),e}();i.ZERO=new i,i.ONE=new i(1,1,1,1),i.UnitX=new i(1,0,0,0),i.UnitY=new i(0,1,0,0),i.UnitZ=new i(0,0,1,0),i.UnitW=new i(0,0,0,1);var a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;arguments.length>3&&void 0!==arguments[3]&&arguments[3];_classCallCheck(this,e),this.x=t,this.y=n,this.z=r}return _createClass(e,[{key:"setValue",value:function(e,t,n){this.x=e,this.y=t,this.z=n}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}},{key:"cloneTo",value:function(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"toDefault",value:function(){this.x=0,this.y=0,this.z=0}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z):this.elements=new Float32Array([this.x,this.y,this.z]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2)}}],[{key:"distanceSquared",value:function(e,t){var n=e.x-t.x,r=e.y-t.y,i=e.z-t.z;return n*n+r*r+i*i}},{key:"distance",value:function(e,t){var n=e.x-t.x,r=e.y-t.y,i=e.z-t.z;return Math.sqrt(n*n+r*r+i*i)}},{key:"min",value:function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z)}},{key:"max",value:function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z)}},{key:"transformQuat",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=t.x,s=t.y,l=t.z,_=t.w,u=_*r+s*a-l*i,c=_*i+l*r-o*a,h=_*a+o*i-s*r,d=-o*r-s*i-l*a;n.x=u*_+d*-o+c*-l-h*-s,n.y=c*_+d*-s+h*-o-u*-l,n.z=h*_+d*-l+u*-s-c*-o}},{key:"scalarLength",value:function(e){var t=e.x,n=e.y,r=e.z;return Math.sqrt(t*t+n*n+r*r)}},{key:"scalarLengthSquared",value:function(e){var t=e.x,n=e.y,r=e.z;return t*t+n*n+r*r}},{key:"normalize",value:function(e,t){var n=e.x,r=e.y,i=e.z,a=n*n+r*r+i*i;a>0&&(a=1/Math.sqrt(a),t.x=n*a,t.y=r*a,t.z=i*a)}},{key:"multiply",value:function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z}},{key:"scale",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t}},{key:"lerp",value:function(e,t,n,r){var i=e.x,a=e.y,o=e.z;r.x=i+n*(t.x-i),r.y=a+n*(t.y-a),r.z=o+n*(t.z-o)}},{key:"transformV3ToV3",value:function(t,n,r){var i=e._tempVector4;e.transformV3ToV4(t,n,i),r.x=i.x,r.y=i.y,r.z=i.z}},{key:"transformV3ToV4",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=t.elements;n.x=r*o[0]+i*o[4]+a*o[8]+o[12],n.y=r*o[1]+i*o[5]+a*o[9]+o[13],n.z=r*o[2]+i*o[6]+a*o[10]+o[14],n.w=r*o[3]+i*o[7]+a*o[11]+o[15]}},{key:"TransformNormal",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=t.elements;n.x=r*o[0]+i*o[4]+a*o[8],n.y=r*o[1]+i*o[5]+a*o[9],n.z=r*o[2]+i*o[6]+a*o[10]}},{key:"transformCoordinate",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=t.elements,s=r*o[3]+i*o[7]+a*o[11]+o[15];n.x=r*o[0]+i*o[4]+a*o[8]+o[12]/s,n.y=r*o[1]+i*o[5]+a*o[9]+o[13]/s,n.z=r*o[2]+i*o[6]+a*o[10]+o[14]/s}},{key:"Clamp",value:function(e,t,n,r){var i=e.x,a=e.y,o=e.z,s=t.x,l=t.y,_=t.z,u=n.x,c=n.y,h=n.z;i=(i=i>u?u:i)<s?s:i,a=(a=a>c?c:a)<l?l:a,o=(o=o>h?h:o)<_?_:o,r.x=i,r.y=a,r.z=o}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z}},{key:"subtract",value:function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z}},{key:"cross",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=t.x,s=t.y,l=t.z;n.x=i*l-a*s,n.y=a*o-r*l,n.z=r*s-i*o}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"equals",value:function(e,t){return n.nearEqual(e.x,t.x)&&n.nearEqual(e.y,t.y)&&n.nearEqual(e.z,t.z)}}]),e}();a._tempVector4=new i,a._ZERO=new a(0,0,0),a._ONE=new a(1,1,1),a._NegativeUnitX=new a(-1,0,0),a._UnitX=new a(1,0,0),a._UnitY=new a(0,1,0),a._UnitZ=new a(0,0,1),a._ForwardRH=new a(0,0,-1),a._ForwardLH=new a(0,0,1),a._Up=new a(0,1,0);var o=function(){function e(){_classCallCheck(this,e),this._defaultPhysicsMemory=16,this._maxLightCount=32,this._lightClusterCount=new a(12,12,12),this._editerEnvironment=!1,this.isAntialias=!0,this.isAlpha=!1,this.premultipliedAlpha=!0,this.isStencil=!0,this.enableMultiLight=!0,this.octreeCulling=!1,this.octreeInitialSize=64,this.octreeInitialCenter=new a(0,0,0),this.octreeMinNodeSize=2,this.octreeLooseness=1.25,this.debugFrustumCulling=!1,this._maxAreaLightCountPerClusterAverage=Math.min(4*Math.floor(2048/this._lightClusterCount.z-1),this._maxLightCount)}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;t._defaultPhysicsMemory=this._defaultPhysicsMemory,t._editerEnvironment=this._editerEnvironment,t.isAntialias=this.isAntialias,t.isAlpha=this.isAlpha,t.premultipliedAlpha=this.premultipliedAlpha,t.isStencil=this.isStencil,t.octreeCulling=this.octreeCulling,this.octreeInitialCenter.cloneTo(t.octreeInitialCenter),t.octreeInitialSize=this.octreeInitialSize,t.octreeMinNodeSize=this.octreeMinNodeSize,t.octreeLooseness=this.octreeLooseness,t.debugFrustumCulling=this.debugFrustumCulling,t.maxLightCount=this.maxLightCount,t.enableMultiLight=this.enableMultiLight;var n=t.lightClusterCount;this.lightClusterCount.cloneTo(n),t.lightClusterCount=n}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"defaultPhysicsMemory",get:function(){return this._defaultPhysicsMemory},set:function(e){if(e<16)throw"defaultPhysicsMemory must large than 16M";this._defaultPhysicsMemory=e}},{key:"maxLightCount",get:function(){return this._maxLightCount},set:function(e){e>2048?(this._maxLightCount=2048,console.warn("Config3D: maxLightCount must less equal 2048.")):this._maxLightCount=e}},{key:"lightClusterCount",get:function(){return this._lightClusterCount},set:function(e){e.x>128||e.y>128||e.z>128?(this._lightClusterCount.setValue(Math.min(e.x,128),Math.min(e.y,128),Math.min(e.z,128)),console.warn("Config3D: lightClusterCount X and Y、Z must less equal 128.")):e.cloneTo(this._lightClusterCount);var t=4*Math.floor(2048/this._lightClusterCount.z-1);t<this._maxLightCount&&console.warn("Config3D: if the area light(PointLight、SpotLight) count is large than "+t+",maybe the far away culster will ingonre some light."),this._maxAreaLightCountPerClusterAverage=Math.min(t,this._maxLightCount)}}]),e}();o._config=new o,window.Config3D=o;var s=function e(){_classCallCheck(this,e)};s.Shader3D=null,s.Scene3D=null,s.MeshRenderStaticBatchManager=null,s.MeshRenderDynamicBatchManager=null,s.SubMeshDynamicBatch=null,s.Laya3D=null,s.Matrix4x4=null;var l=function(){function e(){_classCallCheck(this,e),this._ownerPath=[],this._propertys=[],this._keyFrames=[]}return _createClass(e,[{key:"_setOwnerPathCount",value:function(e){this._ownerPath.length=e}},{key:"_setOwnerPathByIndex",value:function(e,t){this._ownerPath[e]=t}},{key:"_joinOwnerPath",value:function(e){return this._ownerPath.join(e)}},{key:"_setPropertyCount",value:function(e){this._propertys.length=e}},{key:"_setPropertyByIndex",value:function(e,t){this._propertys[e]=t}},{key:"_joinProperty",value:function(e){return this._propertys.join(e)}},{key:"_setKeyframeCount",value:function(e){this._keyFrames.length=e}},{key:"_setKeyframeByIndex",value:function(e,t){this._keyFrames[e]=t}},{key:"getOwnerPathByIndex",value:function(e){return this._ownerPath[e]}},{key:"getPropertyByIndex",value:function(e){return this._propertys[e]}},{key:"getKeyframeByIndex",value:function(e){return this._keyFrames[e]}},{key:"ownerPathCount",get:function(){return this._ownerPath.length}},{key:"propertyCount",get:function(){return this._propertys.length}},{key:"keyFramesCount",get:function(){return this._keyFrames.length}}]),e}();window.conch&&window.conchKeyframeNode&&(l=window.conchKeyframeNode),window.qq&&window.qq.webglPlus&&(l=window.qq.webglPlus.conchKeyframeNode);var _=function e(){_classCallCheck(this,e)},u=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"cloneTo",value:function(e){e.time=this.time}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}}]),e}(),c=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,u),_createClass(t,[{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;n.inTangent=this.inTangent,n.outTangent=this.outTangent,n.value=this.value}}]),t}();window.conch&&window.conchFloatKeyframe&&(c=window.conchFloatKeyframe),window.qq&&window.qq.webglPlus&&(c=window.qq.webglPlus.conchFloatKeyframe);var h=function(){function e(){_classCallCheck(this,e);var t=this.elements=new Float32Array(9);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1}return _createClass(e,[{key:"determinant",value:function(){var e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],_=e[8];return t*(_*a-o*l)+n*(-_*i+o*s)+r*(l*i-a*s)}},{key:"translate",value:function(e,t){var n=t.elements,r=this.elements,i=r[0],a=r[1],o=r[2],s=r[3],l=r[4],_=r[5],u=r[6],c=r[7],h=r[8],d=e.x,f=e.y;n[0]=i,n[1]=a,n[2]=o,n[3]=s,n[4]=l,n[5]=_,n[6]=d*i+f*s+u,n[7]=d*a+f*l+c,n[8]=d*o+f*_+h}},{key:"rotate",value:function(e,t){var n=t.elements,r=this.elements,i=r[0],a=r[1],o=r[2],s=r[3],l=r[4],_=r[5],u=r[6],c=r[7],h=r[8],d=Math.sin(e),f=Math.cos(e);n[0]=f*i+d*s,n[1]=f*a+d*l,n[2]=f*o+d*_,n[3]=f*s-d*i,n[4]=f*l-d*a,n[5]=f*_-d*o,n[6]=u,n[7]=c,n[8]=h}},{key:"scale",value:function(e,t){var n=t.elements,r=this.elements,i=e.x,a=e.y;n[0]=i*r[0],n[1]=i*r[1],n[2]=i*r[2],n[3]=a*r[3],n[4]=a*r[4],n[5]=a*r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8]}},{key:"invert",value:function(e){var t=e.elements,n=this.elements,r=n[0],i=n[1],a=n[2],o=n[3],s=n[4],l=n[5],_=n[6],u=n[7],c=n[8],h=c*s-l*u,d=-c*o+l*_,f=u*o-s*_,m=r*h+i*d+a*f;m||(e=null),m=1/m,t[0]=h*m,t[1]=(-c*i+a*u)*m,t[2]=(l*i-a*s)*m,t[3]=d*m,t[4]=(c*r-a*_)*m,t[5]=(-l*r+a*o)*m,t[6]=f*m,t[7]=(-u*r+i*_)*m,t[8]=(s*r-i*o)*m}},{key:"transpose",value:function(e){var t=e.elements,n=this.elements;if(e===this){var r=n[1],i=n[2],a=n[5];t[1]=n[3],t[2]=n[6],t[3]=r,t[5]=n[7],t[6]=i,t[7]=a}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8]}},{key:"identity",value:function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}},{key:"cloneTo",value:function(e){var t,n,r;if((n=this.elements)!==(r=e.elements))for(t=0;t<9;++t)r[t]=n[t]}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}}],[{key:"createRotationQuaternion",value:function(e,t){var n=e.x,r=e.y,i=e.z,a=e.w,o=n*n,s=r*r,l=i*i,_=n*r,u=i*a,c=i*n,h=r*a,d=r*i,f=n*a,m=t.elements;m[0]=1-2*(s+l),m[1]=2*(_+u),m[2]=2*(c-h),m[3]=2*(_-u),m[4]=1-2*(l+o),m[5]=2*(d+f),m[6]=2*(c+h),m[7]=2*(d-f),m[8]=1-2*(s+o)}},{key:"createFromTranslation",value:function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e.x,n[7]=e.y,n[8]=1}},{key:"createFromRotation",value:function(e,t){var n=t.elements,r=Math.sin(e),i=Math.cos(e);n[0]=i,n[1]=r,n[2]=0,n[3]=-r,n[4]=i,n[5]=0,n[6]=0,n[7]=0,n[8]=1}},{key:"createFromScaling",value:function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=e.y,n[5]=0,n[6]=0,n[7]=0,n[8]=e.z}},{key:"createFromMatrix4x4",value:function(e,t){var n=e.elements,r=t.elements;r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[4],r[4]=n[5],r[5]=n[6],r[6]=n[8],r[7]=n[9],r[8]=n[10]}},{key:"multiply",value:function(e,t,n){var r=e.elements,i=t.elements,a=n.elements,o=r[0],s=r[1],l=r[2],_=r[3],u=r[4],c=r[5],h=r[6],d=r[7],f=r[8],m=i[0],E=i[1],v=i[2],T=i[3],p=i[4],g=i[5],y=i[6],S=i[7],R=i[8];a[0]=m*o+E*_+v*h,a[1]=m*s+E*u+v*S,a[2]=m*l+E*c+v*f,a[3]=T*o+p*_+g*h,a[4]=T*s+p*u+g*d,a[5]=T*l+p*c+g*f,a[6]=y*o+S*_+R*h,a[7]=y*s+S*u+R*d,a[8]=y*l+S*c+R*f}},{key:"lookAt",value:function(t,n,r,i){a.subtract(t,n,e._tempV30),a.normalize(e._tempV30,e._tempV30),a.cross(r,e._tempV30,e._tempV31),a.normalize(e._tempV31,e._tempV31),a.cross(e._tempV30,e._tempV31,e._tempV32);var o=e._tempV30,s=e._tempV31,l=e._tempV32,_=i.elements;_[0]=s.x,_[3]=s.y,_[6]=s.z,_[1]=l.x,_[4]=l.y,_[7]=l.z,_[2]=o.x,_[5]=o.y,_[8]=o.z}}]),e}();h.DEFAULT=new h,h._tempV30=new a,h._tempV31=new a,h._tempV32=new a;var d=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;arguments.length>4&&void 0!==arguments[4]&&arguments[4];_classCallCheck(this,e),this.x=t,this.y=n,this.z=r,this.w=i}return _createClass(e,[{key:"scaling",value:function(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}},{key:"normalize",value:function(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"rotateX",value:function(e,t){e*=.5;var n=Math.sin(e),r=Math.cos(e);t.x=this.x*r+this.w*n,t.y=this.y*r+this.z*n,t.z=this.z*r-this.y*n,t.w=this.w*r-this.x*n}},{key:"rotateY",value:function(e,t){e*=.5;var n=Math.sin(e),r=Math.cos(e);t.x=this.x*r-this.z*n,t.y=this.y*r+this.w*n,t.z=this.z*r+this.x*n,t.w=this.w*r-this.y*n}},{key:"rotateZ",value:function(e,t){e*=.5;var n=Math.sin(e),r=Math.cos(e);t.x=this.x*r+this.y*n,t.y=this.y*r-this.x*n,t.z=this.z*r+this.w*n,t.w=this.w*r-this.z*n}},{key:"getYawPitchRoll",value:function(t){a.transformQuat(a._ForwardRH,this,e.TEMPVector31),a.transformQuat(a._Up,this,e.TEMPVector32);var n=e.TEMPVector32;e.angleTo(a._ZERO,e.TEMPVector31,e.TEMPVector33);var r=e.TEMPVector33;r.x==Math.PI/2?(r.y=e.arcTanAngle(n.z,n.x),r.z=0):r.x==-Math.PI/2?(r.y=e.arcTanAngle(-n.z,-n.x),r.z=0):(s.Matrix4x4.createRotationY(-r.y,s.Matrix4x4.TEMPMatrix0),s.Matrix4x4.createRotationX(-r.x,s.Matrix4x4.TEMPMatrix1),a.transformCoordinate(e.TEMPVector32,s.Matrix4x4.TEMPMatrix0,e.TEMPVector32),a.transformCoordinate(e.TEMPVector32,s.Matrix4x4.TEMPMatrix1,e.TEMPVector32),r.z=e.arcTanAngle(n.y,-n.x)),r.y<=-Math.PI&&(r.y=Math.PI),r.z<=-Math.PI&&(r.z=Math.PI),r.y>=Math.PI&&r.z>=Math.PI&&(r.y=0,r.z=0,r.x=Math.PI-r.x);var i=t;i.x=r.y,i.y=r.x,i.z=r.z}},{key:"invert",value:function(e){var t=this.x,n=this.y,r=this.z,i=this.w,a=t*t+n*n+r*r+i*i,o=a?1/a:0;e.x=-t*o,e.y=-n*o,e.z=-r*o,e.w=i*o}},{key:"identity",value:function(){this.x=0,this.y=0,this.z=0,this.w=1}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}},{key:"cloneTo",value:function(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"equals",value:function(e){return n.nearEqual(this.x,e.x)&&n.nearEqual(this.y,e.y)&&n.nearEqual(this.z,e.z)&&n.nearEqual(this.w,e.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"forNativeElement",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),r.rewriteNumProperty(this,"x",0),r.rewriteNumProperty(this,"y",1),r.rewriteNumProperty(this,"z",2),r.rewriteNumProperty(this,"w",3)}}],[{key:"createFromYawPitchRoll",value:function(e,t,n,r){var i=.5*n,a=.5*t,o=.5*e,s=Math.sin(i),l=Math.cos(i),_=Math.sin(a),u=Math.cos(a),c=Math.sin(o),h=Math.cos(o);r.x=h*_*l+c*u*s,r.y=c*u*l-h*_*s,r.z=h*u*s-c*_*l,r.w=h*u*l+c*_*s}},{key:"multiply",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=e.w,s=t.x,l=t.y,_=t.z,u=t.w,c=i*_-a*l,h=a*s-r*_,d=r*l-i*s,f=r*s+i*l+a*_;n.x=r*u+s*o+c,n.y=i*u+l*o+h,n.z=a*u+_*o+d,n.w=o*u-f}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(t,n,r){a.subtract(n,t,e.TEMPVector30),a.normalize(e.TEMPVector30,e.TEMPVector30),r.x=Math.asin(e.TEMPVector30.y),r.y=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)}},{key:"createFromAxisAngle",value:function(e,t,n){t*=.5;var r=Math.sin(t);n.x=r*e.x,n.y=r*e.y,n.z=r*e.z,n.w=Math.cos(t)}},{key:"createFromMatrix4x4",value:function(e,t){var n,r,i=e.elements,a=i[0]+i[5]+i[10];a>0?(n=Math.sqrt(a+1),t.w=.5*n,n=.5/n,t.x=(i[6]-i[9])*n,t.y=(i[8]-i[2])*n,t.z=(i[1]-i[4])*n):i[0]>=i[5]&&i[0]>=i[10]?(r=.5/(n=Math.sqrt(1+i[0]-i[5]-i[10])),t.x=.5*n,t.y=(i[1]+i[4])*r,t.z=(i[2]+i[8])*r,t.w=(i[6]-i[9])*r):i[5]>i[10]?(r=.5/(n=Math.sqrt(1+i[5]-i[0]-i[10])),t.x=(i[4]+i[1])*r,t.y=.5*n,t.z=(i[9]+i[6])*r,t.w=(i[8]-i[2])*r):(r=.5/(n=Math.sqrt(1+i[10]-i[0]-i[5])),t.x=(i[8]+i[2])*r,t.y=(i[9]+i[6])*r,t.z=.5*n,t.w=(i[1]-i[4])*r)}},{key:"slerp",value:function(e,t,n,r){var i,a,o,s,l,_=e.x,u=e.y,c=e.z,h=e.w,d=t.x,f=t.y,m=t.z,E=t.w;return(a=_*d+u*f+c*m+h*E)<0&&(a=-a,d=-d,f=-f,m=-m,E=-E),1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-n)*i)/o,l=Math.sin(n*i)/o):(s=1-n,l=n),r.x=s*_+l*d,r.y=s*u+l*f,r.z=s*c+l*m,r.w=s*h+l*E,r}},{key:"lerp",value:function(t,n,r,i){var a=1-r;e.dot(t,n)>=0?(i.x=a*t.x+r*n.x,i.y=a*t.y+r*n.y,i.z=a*t.z+r*n.z,i.w=a*t.w+r*n.w):(i.x=a*t.x-r*n.x,i.y=a*t.y-r*n.y,i.z=a*t.z-r*n.z,i.w=a*t.w-r*n.w),i.normalize(i)}},{key:"add",value:function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"rotationLookAt",value:function(t,n,r){e.lookAt(a._ZERO,t,n,r)}},{key:"lookAt",value:function(t,n,r,i){h.lookAt(t,n,r,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,i)}},{key:"invert",value:function(e,t){var r=e.lengthSquared();n.isZero(r)||(r=1/r,t.x=-e.x*r,t.y=-e.y*r,t.z=-e.z*r,t.w=e.w*r)}},{key:"rotationMatrix",value:function(e,t){var n,r,i=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],_=i[4],u=i[5],c=i[6],h=i[7],d=i[8],f=a+_+d;f>0?(n=Math.sqrt(f+1),t.w=.5*n,n=.5/n,t.x=(u-h)*n,t.y=(c-s)*n,t.z=(o-l)*n):a>=_&&a>=d?(r=.5/(n=Math.sqrt(1+a-_-d)),t.x=.5*n,t.y=(o+l)*r,t.z=(s+c)*r,t.w=(u-h)*r):_>d?(r=.5/(n=Math.sqrt(1+_-a-d)),t.x=(l+o)*r,t.y=.5*n,t.z=(h+u)*r,t.w=(c-s)*r):(r=.5/(n=Math.sqrt(1+d-a-_)),t.x=(c+s)*r,t.y=(h+u)*r,t.z=.5*n,t.w=(o-l)*r)}}]),e}();d.TEMPVector30=new a,d.TEMPVector31=new a,d.TEMPVector32=new a,d.TEMPVector33=new a,d._tempMatrix3x3=new h,d.DEFAULT=new d,d.NAN=new d(NaN,NaN,NaN,NaN);var f=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.inTangent=new i,e.outTangent=new i,e.value=new d,e}return _inherits(t,u),_createClass(t,[{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;this.inTangent.cloneTo(n.inTangent),this.outTangent.cloneTo(n.outTangent),this.value.cloneTo(n.value)}}]),t}();window.conch&&window.conchFloatArrayKeyframe&&(f=window.conchFloatArrayKeyframe),window.qq&&window.qq.webglPlus&&(f=window.qq.webglPlus.conchFloatArrayKeyframe);var m=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.inTangent=new a,e.outTangent=new a,e.value=new a,e}return _inherits(t,u),_createClass(t,[{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;this.inTangent.cloneTo(n.inTangent),this.outTangent.cloneTo(n.outTangent),this.value.cloneTo(n.value)}}]),t}();window.conch&&window.conchFloatArrayKeyframe&&(m=window.conchFloatArrayKeyframe),window.qq&&window.qq.webglPlus&&(m=window.qq.webglPlus.conchFloatArrayKeyframe);var E=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;_classCallCheck(this,e);var a=this.elements=new Float32Array(4);a[0]=t,a[1]=n,a[2]=r,a[3]=i}return _createClass(e,[{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}},{key:"cloneTo",value:function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3]}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSquared",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}},{key:"w",get:function(){return this.elements[3]},set:function(e){this.elements[3]=e}}],[{key:"lerp",value:function(e,t,n,r){var i=r.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],_=a[2],u=a[3];i[0]=s+n*(o[0]-s),i[1]=l+n*(o[1]-l),i[2]=_+n*(o[2]-_),i[3]=u+n*(o[3]-u)}},{key:"transformByM4x4",value:function(e,t,n){var r=e.elements,i=r[0],a=r[1],o=r[2],s=r[3],l=t.elements,_=n.elements;_[0]=i*l[0]+a*l[4]+o*l[8]+s*l[12],_[1]=i*l[1]+a*l[5]+o*l[9]+s*l[13],_[2]=i*l[2]+a*l[6]+o*l[10]+s*l[14],_[3]=i*l[3]+a*l[7]+o*l[11]+s*l[15]}},{key:"equals",value:function(e,t){var r=e.elements,i=t.elements;return n.nearEqual(Math.abs(r[0]),Math.abs(i[0]))&&n.nearEqual(Math.abs(r[1]),Math.abs(i[1]))&&n.nearEqual(Math.abs(r[2]),Math.abs(i[2]))&&n.nearEqual(Math.abs(r[3]),Math.abs(i[3]))}},{key:"normalize",value:function(e,t){var n=e.elements,r=t.elements,i=e.length();i>0&&(r[0]=n[0]*i,r[1]=n[1]*i,r[2]=n[2]*i,r[3]=n[3]*i)}},{key:"add",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=i[0]+a[0],r[1]=i[1]+a[1],r[2]=i[2]+a[2],r[3]=i[3]+a[3]}},{key:"subtract",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=i[0]-a[0],r[1]=i[1]-a[1],r[2]=i[2]-a[2],r[3]=i[3]-a[3]}},{key:"multiply",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=i[0]*a[0],r[1]=i[1]*a[1],r[2]=i[2]*a[2],r[3]=i[3]*a[3]}},{key:"scale",value:function(e,t,n){var r=n.elements,i=e.elements;r[0]=i[0]*t,r[1]=i[1]*t,r[2]=i[2]*t,r[3]=i[3]*t}},{key:"Clamp",value:function(e,t,n,r){var i=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],_=t.elements,u=_[0],c=_[1],h=_[2],d=_[3],f=n.elements,m=f[0],E=f[1],v=f[2],T=f[3],p=r.elements;a=(a=a>m?m:a)<u?u:a,o=(o=o>E?E:o)<c?c:o,s=(s=s>v?v:s)<h?h:s,l=(l=l>T?T:l)<d?d:l,p[0]=a,p[1]=o,p[2]=s,p[3]=l}},{key:"distanceSquared",value:function(e,t){var n=e.elements,r=t.elements,i=n[0]-r[0],a=n[1]-r[1],o=n[2]-r[2],s=n[3]-r[3];return i*i+a*a+o*o+s*s}},{key:"distance",value:function(e,t){var n=e.elements,r=t.elements,i=n[0]-r[0],a=n[1]-r[1],o=n[2]-r[2],s=n[3]-r[3];return Math.sqrt(i*i+a*a+o*o+s*s)}},{key:"dot",value:function(e,t){var n=e.elements,r=t.elements;return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]+n[3]*r[3]}},{key:"min",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=Math.min(i[0],a[0]),r[1]=Math.min(i[1],a[1]),r[2]=Math.min(i[2],a[2]),r[3]=Math.min(i[3],a[3])}},{key:"max",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=Math.max(i[0],a[0]),r[1]=Math.max(i[1],a[1]),r[2]=Math.max(i[2],a[2]),r[3]=Math.max(i[3],a[3])}}]),e}();E.ZERO=new E,E.ONE=new E(1,1,1,1),E.UnitX=new E(1,0,0,0),E.UnitY=new E(0,1,0,0),E.UnitZ=new E(0,0,1,0),E.UnitW=new E(0,0,0,1);var v=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,e),t=a||new Float32Array(3),this.elements=t,t[0]=n,t[1]=r,t[2]=i}return _createClass(e,[{key:"setValue",value:function(e,t,n){this.elements[0]=e,this.elements[1]=t,this.elements[2]=n}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2]}},{key:"cloneTo",value:function(e){var t=e.elements,n=this.elements;t[0]=n[0],t[1]=n[1],t[2]=n[2]}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"toDefault",value:function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}}],[{key:"distanceSquared",value:function(e,t){var n=e.elements,r=t.elements,i=n[0]-r[0],a=n[1]-r[1],o=n[2]-r[2];return i*i+a*a+o*o}},{key:"distance",value:function(e,t){var n=e.elements,r=t.elements,i=n[0]-r[0],a=n[1]-r[1],o=n[2]-r[2];return Math.sqrt(i*i+a*a+o*o)}},{key:"min",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=Math.min(i[0],a[0]),r[1]=Math.min(i[1],a[1]),r[2]=Math.min(i[2],a[2])}},{key:"max",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=Math.max(i[0],a[0]),r[1]=Math.max(i[1],a[1]),r[2]=Math.max(i[2],a[2])}},{key:"transformQuat",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements,o=i[0],s=i[1],l=i[2],_=a[0],u=a[1],c=a[2],h=a[3],d=h*o+u*l-c*s,f=h*s+c*o-_*l,m=h*l+_*s-u*o,E=-_*o-u*s-c*l;r[0]=d*h+E*-_+f*-c-m*-u,r[1]=f*h+E*-u+m*-_-d*-c,r[2]=m*h+E*-c+d*-u-f*-_}},{key:"scalarLength",value:function(e){var t=e.elements,n=t[0],r=t[1],i=t[2];return Math.sqrt(n*n+r*r+i*i)}},{key:"scalarLengthSquared",value:function(e){var t=e.elements,n=t[0],r=t[1],i=t[2];return n*n+r*r+i*i}},{key:"normalize",value:function(e,t){var n=e.elements,r=t.elements,i=n[0],a=n[1],o=n[2],s=i*i+a*a+o*o;s>0&&(s=1/Math.sqrt(s),r[0]=n[0]*s,r[1]=n[1]*s,r[2]=n[2]*s)}},{key:"multiply",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=i[0]*a[0],r[1]=i[1]*a[1],r[2]=i[2]*a[2]}},{key:"scale",value:function(e,t,n){var r=n.elements,i=e.elements;r[0]=i[0]*t,r[1]=i[1]*t,r[2]=i[2]*t}},{key:"lerp",value:function(e,t,n,r){var i=r.elements,a=e.elements,o=t.elements,s=a[0],l=a[1],_=a[2];i[0]=s+n*(o[0]-s),i[1]=l+n*(o[1]-l),i[2]=_+n*(o[2]-_)}},{key:"transformV3ToV3",value:function(t,n,r){var i=e._tempVector4;e.transformV3ToV4(t,n,i);var a=i.elements,o=r.elements;o[0]=a[0],o[1]=a[1],o[2]=a[2]}},{key:"transformV3ToV4",value:function(e,t,n){var r=e.elements,i=r[0],a=r[1],o=r[2],s=t.elements,l=n.elements;l[0]=i*s[0]+a*s[4]+o*s[8]+s[12],l[1]=i*s[1]+a*s[5]+o*s[9]+s[13],l[2]=i*s[2]+a*s[6]+o*s[10]+s[14],l[3]=i*s[3]+a*s[7]+o*s[11]+s[15]}},{key:"TransformNormal",value:function(e,t,n){var r=e.elements,i=r[0],a=r[1],o=r[2],s=t.elements,l=n.elements;l[0]=i*s[0]+a*s[4]+o*s[8],l[1]=i*s[1]+a*s[5]+o*s[9],l[2]=i*s[2]+a*s[6]+o*s[10]}},{key:"transformCoordinate",value:function(e,t,n){var r=e.elements,i=r[0],a=r[1],o=r[2],s=t.elements,l=i*s[3]+a*s[7]+o*s[11]+s[15],_=n.elements;_[0]=i*s[0]+a*s[4]+o*s[8]+s[12]/l,_[1]=i*s[1]+a*s[5]+o*s[9]+s[13]/l,_[2]=i*s[2]+a*s[6]+o*s[10]+s[14]/l}},{key:"Clamp",value:function(e,t,n,r){var i=e.elements,a=i[0],o=i[1],s=i[2],l=t.elements,_=l[0],u=l[1],c=l[2],h=n.elements,d=h[0],f=h[1],m=h[2],E=r.elements;a=(a=a>d?d:a)<_?_:a,o=(o=o>f?f:o)<u?u:o,s=(s=s>m?m:s)<c?c:s,E[0]=a,E[1]=o,E[2]=s}},{key:"add",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=i[0]+a[0],r[1]=i[1]+a[1],r[2]=i[2]+a[2]}},{key:"subtract",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=i[0]-a[0],r[1]=i[1]-a[1],r[2]=i[2]-a[2]}},{key:"cross",value:function(e,t,n){var r=e.elements,i=t.elements,a=n.elements,o=r[0],s=r[1],l=r[2],_=i[0],u=i[1],c=i[2];a[0]=s*c-l*u,a[1]=l*_-o*c,a[2]=o*u-s*_}},{key:"dot",value:function(e,t){var n=e.elements,r=t.elements;return n[0]*r[0]+n[1]*r[1]+n[2]*r[2]}},{key:"equals",value:function(e,t){var r=e.elements,i=t.elements;return n.nearEqual(r[0],i[0])&&n.nearEqual(r[1],i[1])&&n.nearEqual(r[2],i[2])}}]),e}();v._tempVector4=new E,v.ZERO=new v(0,0,0),v.ONE=new v(1,1,1),v.NegativeUnitX=new v(-1,0,0),v.UnitX=new v(1,0,0),v.UnitY=new v(0,1,0),v.UnitZ=new v(0,0,1),v.ForwardRH=new v(0,0,-1),v.ForwardLH=new v(0,0,1),v.Up=new v(0,1,0),v.NAN=new v(NaN,NaN,NaN);var T=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,_=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,d=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,f=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,m=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,E=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1,v=arguments.length>16&&void 0!==arguments[16]?arguments[16]:null;_classCallCheck(this,e);var T=this.elements=v||new Float32Array(16);T[0]=t,T[1]=n,T[2]=r,T[3]=i,T[4]=a,T[5]=o,T[6]=s,T[7]=l,T[8]=_,T[9]=u,T[10]=c,T[11]=h,T[12]=d,T[13]=f,T[14]=m,T[15]=E}return _createClass(e,[{key:"setRotation",value:function(e){var t=e.x,n=e.y,r=e.z,i=e.w,a=t*t,o=n*n,s=r*r,l=t*n,_=r*i,u=r*t,c=n*i,h=n*r,d=t*i,f=this.elements;f[0]=1-2*(o+s),f[1]=2*(l+_),f[2]=2*(u-c),f[4]=2*(l-_),f[5]=1-2*(s+a),f[6]=2*(h+d),f[8]=2*(u+c),f[9]=2*(h-d),f[10]=1-2*(o+a)}},{key:"setPosition",value:function(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}},{key:"getElementByRowColumn",value:function(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}},{key:"setElementByRowColumn",value:function(e,t,n){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=n}},{key:"equalsOtherMatrix",value:function(e){var t=this.elements,r=e.elements;return n.nearEqual(t[0],r[0])&&n.nearEqual(t[1],r[1])&&n.nearEqual(t[2],r[2])&&n.nearEqual(t[3],r[3])&&n.nearEqual(t[4],r[4])&&n.nearEqual(t[5],r[5])&&n.nearEqual(t[6],r[6])&&n.nearEqual(t[7],r[7])&&n.nearEqual(t[8],r[8])&&n.nearEqual(t[9],r[9])&&n.nearEqual(t[10],r[10])&&n.nearEqual(t[11],r[11])&&n.nearEqual(t[12],r[12])&&n.nearEqual(t[13],r[13])&&n.nearEqual(t[14],r[14])&&n.nearEqual(t[15],r[15])}},{key:"decomposeTransRotScale",value:function(t,n,r){var i=e._tempMatrix4x4;return this.decomposeTransRotMatScale(t,i,r)?(d.createFromMatrix4x4(i,n),!0):(n.identity(),!1)}},{key:"decomposeTransRotMatScale",value:function(t,r,i){var o=this.elements,s=t,l=r.elements,_=i;s.x=o[12],s.y=o[13],s.z=o[14];var u=o[0],c=o[1],h=o[2],d=o[4],f=o[5],m=o[6],E=o[8],v=o[9],T=o[10],p=_.x=Math.sqrt(u*u+c*c+h*h),g=_.y=Math.sqrt(d*d+f*f+m*m),y=_.z=Math.sqrt(E*E+v*v+T*T);if(n.isZero(p)||n.isZero(g)||n.isZero(y))return l[1]=l[2]=l[3]=l[4]=l[6]=l[7]=l[8]=l[9]=l[11]=l[12]=l[13]=l[14]=0,l[0]=l[5]=l[10]=l[15]=1,!1;var S=e._tempVector0;S.x=E/y,S.y=v/y,S.z=T/y;var R=e._tempVector1;R.x=u/p,R.y=c/p,R.z=h/p;var C=e._tempVector2;a.cross(S,R,C);var I=e._tempVector1;return a.cross(C,S,I),l[3]=l[7]=l[11]=l[12]=l[13]=l[14]=0,l[15]=1,l[0]=I.x,l[1]=I.y,l[2]=I.z,l[4]=C.x,l[5]=C.y,l[6]=C.z,l[8]=S.x,l[9]=S.y,l[10]=S.z,l[0]*u+l[1]*c+l[2]*h<0&&(_.x=-p),l[4]*d+l[5]*f+l[6]*m<0&&(_.y=-g),l[8]*E+l[9]*v+l[10]*T<0&&(_.z=-y),!0}},{key:"decomposeYawPitchRoll",value:function(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>n.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}},{key:"normalize",value:function(){var e=this.elements,t=e[0],n=e[1],r=e[2],i=Math.sqrt(t*t+n*n+r*r);if(!i)return e[0]=0,e[1]=0,void(e[2]=0);1!=i&&(i=1/i,e[0]=t*i,e[1]=n*i,e[2]=r*i)}},{key:"transpose",value:function(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}},{key:"invert",value:function(e){var t=this.elements,n=e.elements,r=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],_=t[6],u=t[7],c=t[8],h=t[9],d=t[10],f=t[11],m=t[12],E=t[13],v=t[14],T=t[15],p=r*l-i*s,g=r*_-a*s,y=r*u-o*s,S=i*_-a*l,R=i*u-o*l,C=a*u-o*_,I=c*E-h*m,A=c*v-d*m,x=c*T-f*m,D=h*v-d*E,L=h*T-f*E,M=d*T-f*v,O=p*M-g*L+y*D+S*x-R*A+C*I;0!==Math.abs(O)&&(O=1/O,n[0]=(l*M-_*L+u*D)*O,n[1]=(a*L-i*M-o*D)*O,n[2]=(E*C-v*R+T*S)*O,n[3]=(d*R-h*C-f*S)*O,n[4]=(_*x-s*M-u*A)*O,n[5]=(r*M-a*x+o*A)*O,n[6]=(v*y-m*C-T*g)*O,n[7]=(c*C-d*y+f*g)*O,n[8]=(s*L-l*x+u*I)*O,n[9]=(i*x-r*L-o*I)*O,n[10]=(m*R-E*y+T*p)*O,n[11]=(h*y-c*R-f*p)*O,n[12]=(l*A-s*D-_*I)*O,n[13]=(r*D-i*A+a*I)*O,n[14]=(E*g-m*S-v*p)*O,n[15]=(c*S-h*g+d*p)*O)}},{key:"identity",value:function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}},{key:"cloneTo",value:function(e){var t,n,r;if((n=this.elements)!==(r=e.elements))for(t=0;t<16;++t)r[t]=n[t]}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"getTranslationVector",value:function(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}},{key:"setTranslationVector",value:function(e){var t=this.elements,n=e;t[12]=n.x,t[13]=n.y,t[14]=n.z}},{key:"getForward",value:function(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}},{key:"setForward",value:function(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}}],[{key:"createRotationX",value:function(e,t){var n=t.elements,r=Math.sin(e),i=Math.cos(e);n[1]=n[2]=n[3]=n[4]=n[7]=n[8]=n[11]=n[12]=n[13]=n[14]=0,n[0]=n[15]=1,n[5]=n[10]=i,n[6]=r,n[9]=-r}},{key:"createRotationY",value:function(e,t){var n=t.elements,r=Math.sin(e),i=Math.cos(e);n[1]=n[3]=n[4]=n[6]=n[7]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[5]=n[15]=1,n[0]=n[10]=i,n[2]=-r,n[8]=r}},{key:"createRotationZ",value:function(e,t){var n=t.elements,r=Math.sin(e),i=Math.cos(e);n[2]=n[3]=n[6]=n[7]=n[8]=n[9]=n[11]=n[12]=n[13]=n[14]=0,n[10]=n[15]=1,n[0]=n[5]=i,n[1]=r,n[4]=-r}},{key:"createRotationYawPitchRoll",value:function(t,n,r,i){d.createFromYawPitchRoll(t,n,r,e._tempQuaternion),e.createRotationQuaternion(e._tempQuaternion,i)}},{key:"createRotationAxis",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=Math.cos(t),s=Math.sin(t),l=r*r,_=i*i,u=a*a,c=r*i,h=r*a,d=i*a,f=n.elements;f[3]=f[7]=f[11]=f[12]=f[13]=f[14]=0,f[15]=1,f[0]=l+o*(1-l),f[1]=c-o*c+s*a,f[2]=h-o*h-s*i,f[4]=c-o*c-s*a,f[5]=_+o*(1-_),f[6]=d-o*d+s*r,f[8]=h-o*h+s*i,f[9]=d-o*d-s*r,f[10]=u+o*(1-u)}},{key:"createRotationQuaternion",value:function(e,t){var n=t.elements,r=e.x,i=e.y,a=e.z,o=e.w,s=r*r,l=i*i,_=a*a,u=r*i,c=a*o,h=a*r,d=i*o,f=i*a,m=r*o;n[3]=n[7]=n[11]=n[12]=n[13]=n[14]=0,n[15]=1,n[0]=1-2*(l+_),n[1]=2*(u+c),n[2]=2*(h-d),n[4]=2*(u-c),n[5]=1-2*(_+s),n[6]=2*(f+m),n[8]=2*(h+d),n[9]=2*(f-m),n[10]=1-2*(l+s)}},{key:"createTranslate",value:function(e,t){var n=t.elements;n[4]=n[8]=n[1]=n[9]=n[2]=n[6]=n[3]=n[7]=n[11]=0,n[0]=n[5]=n[10]=n[15]=1,n[12]=e.x,n[13]=e.y,n[14]=e.z}},{key:"createScaling",value:function(e,t){var n=t.elements;n[0]=e.x,n[5]=e.y,n[10]=e.z,n[1]=n[4]=n[8]=n[12]=n[9]=n[13]=n[2]=n[6]=n[14]=n[3]=n[7]=n[11]=0,n[15]=1}},{key:"multiply",value:function(e,t,n){var r=t.elements,i=e.elements,a=n.elements,o=r[0],s=r[1],l=r[2],_=r[3],u=r[4],c=r[5],h=r[6],d=r[7],f=r[8],m=r[9],E=r[10],v=r[11],T=r[12],p=r[13],g=r[14],y=r[15],S=i[0],R=i[1],C=i[2],I=i[3],A=i[4],x=i[5],D=i[6],L=i[7],M=i[8],O=i[9],N=i[10],P=i[11],b=i[12],V=i[13],k=i[14],w=i[15];a[0]=o*S+s*A+l*M+_*b,a[1]=o*R+s*x+l*O+_*V,a[2]=o*C+s*D+l*N+_*k,a[3]=o*I+s*L+l*P+_*w,a[4]=u*S+c*A+h*M+d*b,a[5]=u*R+c*x+h*O+d*V,a[6]=u*C+c*D+h*N+d*k,a[7]=u*I+c*L+h*P+d*w,a[8]=f*S+m*A+E*M+v*b,a[9]=f*R+m*x+E*O+v*V,a[10]=f*C+m*D+E*N+v*k,a[11]=f*I+m*L+E*P+v*w,a[12]=T*S+p*A+g*M+y*b,a[13]=T*R+p*x+g*O+y*V,a[14]=T*C+p*D+g*N+y*k,a[15]=T*I+p*L+g*P+y*w}},{key:"multiplyForNative",value:function(e,n,r){t.LayaGL.instance.matrix4x4Multiply(e.elements,n.elements,r.elements)}},{key:"createFromQuaternion",value:function(e,t){var n=t.elements,r=e.x,i=e.y,a=e.z,o=e.w,s=r+r,l=i+i,_=a+a,u=r*s,c=i*s,h=i*l,d=a*s,f=a*l,m=a*_,E=o*s,v=o*l,T=o*_;n[0]=1-h-m,n[1]=c+T,n[2]=d-v,n[3]=0,n[4]=c-T,n[5]=1-u-m,n[6]=f+E,n[7]=0,n[8]=d+v,n[9]=f-E,n[10]=1-u-h,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1}},{key:"createAffineTransformation",value:function(e,t,n,r){var i=r.elements,a=t.x,o=t.y,s=t.z,l=t.w,_=a+a,u=o+o,c=s+s,h=a*_,d=a*u,f=a*c,m=o*u,E=o*c,v=s*c,T=l*_,p=l*u,g=l*c,y=n.x,S=n.y,R=n.z;i[0]=(1-(m+v))*y,i[1]=(d+g)*y,i[2]=(f-p)*y,i[3]=0,i[4]=(d-g)*S,i[5]=(1-(h+v))*S,i[6]=(E+T)*S,i[7]=0,i[8]=(f+p)*R,i[9]=(E-T)*R,i[10]=(1-(h+m))*R,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1}},{key:"createLookAt",value:function(t,n,r,i){var o=i.elements,s=e._tempVector0,l=e._tempVector1,_=e._tempVector2;a.subtract(t,n,_),a.normalize(_,_),a.cross(r,_,s),a.normalize(s,s),a.cross(_,s,l),i.identity(),o[0]=s.x,o[4]=s.y,o[8]=s.z,o[1]=l.x,o[5]=l.y,o[9]=l.z,o[2]=_.x,o[6]=_.y,o[10]=_.z,o[12]=-a.dot(s,t),o[13]=-a.dot(l,t),o[14]=-a.dot(_,t)}},{key:"createPerspective",value:function(t,n,r,i,a){var o=1/Math.tan(.5*t),s=r/(o/n),l=r/o;e.createPerspectiveOffCenter(-s,s,-l,l,r,i,a)}},{key:"createPerspectiveOffCenter",value:function(e,t,n,r,i,a,o){var s=o.elements,l=a/(a-i);s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[12]=s[13]=s[15]=0,s[0]=2*i/(t-e),s[5]=2*i/(r-n),s[8]=(e+t)/(t-e),s[9]=(r+n)/(r-n),s[10]=-l,s[11]=-1,s[14]=-i*l}},{key:"createOrthoOffCenter",value:function(e,t,n,r,i,a,o){var s=o.elements,l=1/(a-i);s[1]=s[2]=s[3]=s[4]=s[6]=s[8]=s[7]=s[9]=s[11]=0,s[15]=1,s[0]=2/(t-e),s[5]=2/(r-n),s[10]=-l,s[12]=(e+t)/(e-t),s[13]=(r+n)/(n-r),s[14]=-i*l}},{key:"billboard",value:function(t,r,i,o,s,l){a.subtract(t,r,e._tempVector0);var _=a.scalarLengthSquared(e._tempVector0);n.isZero(_)?(a.scale(s,-1,e._tempVector1),e._tempVector1.cloneTo(e._tempVector0)):a.scale(e._tempVector0,1/Math.sqrt(_),e._tempVector0),a.cross(o,e._tempVector0,e._tempVector2),a.normalize(e._tempVector2,e._tempVector2),a.cross(e._tempVector0,e._tempVector2,e._tempVector3);var u=e._tempVector2,c=e._tempVector3,h=e._tempVector0,d=t,f=l.elements;f[0]=u.x,f[1]=u.y,f[2]=u.z,f[3]=0,f[4]=c.x,f[5]=c.y,f[6]=c.z,f[7]=0,f[8]=h.x,f[9]=h.y,f[10]=h.z,f[11]=0,f[12]=d.x,f[13]=d.y,f[14]=d.z,f[15]=1}},{key:"translation",value:function(e,t){var n=t.elements;n[0]=n[5]=n[10]=n[15]=1,n[12]=e.x,n[13]=e.y,n[14]=e.z}}]),e}();T._tempMatrix4x4=new T,T.TEMPMatrix0=new T,T.TEMPMatrix1=new T,T._tempVector0=new a,T._tempVector1=new a,T._tempVector2=new a,T._tempVector3=new a,T._tempQuaternion=new d,T.DEFAULT=new T,T.ZERO=new T(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var p=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;_classCallCheck(this,e),(t=o||new Float32Array(4))[0]=n,t[1]=r,t[2]=i,t[3]=a,this.elements=t}return _createClass(e,[{key:"scaling",value:function(e,t){var n=t.elements,r=this.elements;n[0]=r[0]*e,n[1]=r[1]*e,n[2]=r[2]*e,n[3]=r[3]*e}},{key:"normalize",value:function(t){e._normalizeArray(this.elements,t.elements)}},{key:"length",value:function(){var e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)}},{key:"rotateX",value:function(e,t){var n=t.elements,r=this.elements;e*=.5;var i=r[0],a=r[1],o=r[2],s=r[3],l=Math.sin(e),_=Math.cos(e);n[0]=i*_+s*l,n[1]=a*_+o*l,n[2]=o*_-a*l,n[3]=s*_-i*l}},{key:"rotateY",value:function(e,t){var n=t.elements,r=this.elements;e*=.5;var i=r[0],a=r[1],o=r[2],s=r[3],l=Math.sin(e),_=Math.cos(e);n[0]=i*_-o*l,n[1]=a*_+s*l,n[2]=o*_+i*l,n[3]=s*_-a*l}},{key:"rotateZ",value:function(e,t){var n=t.elements,r=this.elements;e*=.5;var i=r[0],a=r[1],o=r[2],s=r[3],l=Math.sin(e),_=Math.cos(e);n[0]=i*_+a*l,n[1]=a*_-i*l,n[2]=o*_+s*l,n[3]=s*_-o*l}},{key:"getYawPitchRoll",value:function(t){v.transformQuat(v.ForwardRH,this,e.TEMPVector31),v.transformQuat(v.Up,this,e.TEMPVector32);var n=e.TEMPVector32.elements;e.angleTo(v.ZERO,e.TEMPVector31,e.TEMPVector33);var r=e.TEMPVector33.elements;r[0]==Math.PI/2?(r[1]=e.arcTanAngle(n[2],n[0]),r[2]=0):r[0]==-Math.PI/2?(r[1]=e.arcTanAngle(-n[2],-n[0]),r[2]=0):(T.createRotationY(-r[1],e.TEMPMatrix0),T.createRotationX(-r[0],e.TEMPMatrix1),v.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),v.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),r[2]=e.arcTanAngle(n[1],-n[0])),r[1]<=-Math.PI&&(r[1]=Math.PI),r[2]<=-Math.PI&&(r[2]=Math.PI),r[1]>=Math.PI&&r[2]>=Math.PI&&(r[1]=0,r[2]=0,r[0]=Math.PI-r[0]);var i=t.elements;i[0]=r[1],i[1]=r[0],i[2]=r[2]}},{key:"invert",value:function(e){var t=e.elements,n=this.elements,r=n[0],i=n[1],a=n[2],o=n[3],s=r*r+i*i+a*a+o*o,l=s?1/s:0;t[0]=-r*l,t[1]=-i*l,t[2]=-a*l,t[3]=o*l}},{key:"identity",value:function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1}},{key:"fromArray",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.elements[0]=e[t+0],this.elements[1]=e[t+1],this.elements[2]=e[t+2],this.elements[3]=e[t+3]}},{key:"cloneTo",value:function(e){var t,n,r;if((n=this.elements)!==(r=e.elements))for(t=0;t<4;++t)r[t]=n[t]}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"equals",value:function(e){var t=this.elements,r=e.elements;return n.nearEqual(t[0],r[0])&&n.nearEqual(t[1],r[1])&&n.nearEqual(t[2],r[2])&&n.nearEqual(t[3],r[3])}},{key:"lengthSquared",value:function(){var e=this.elements[0],t=this.elements[1],n=this.elements[2],r=this.elements[3];return e*e+t*t+n*n+r*r}},{key:"x",get:function(){return this.elements[0]},set:function(e){this.elements[0]=e}},{key:"y",get:function(){return this.elements[1]},set:function(e){this.elements[1]=e}},{key:"z",get:function(){return this.elements[2]},set:function(e){this.elements[2]=e}},{key:"w",get:function(){return this.elements[3]},set:function(e){this.elements[3]=e}}],[{key:"_dotArray",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}},{key:"_normalizeArray",value:function(e,t){var n=e[0],r=e[1],i=e[2],a=e[3],o=n*n+r*r+i*i+a*a;o>0&&(o=1/Math.sqrt(o),t[0]=n*o,t[1]=r*o,t[2]=i*o,t[3]=a*o)}},{key:"_lerpArray",value:function(t,n,r,i){var a=1-r;e._dotArray(t,n)>=0?(i[0]=a*t[0]+r*n[0],i[1]=a*t[1]+r*n[1],i[2]=a*t[2]+r*n[2],i[3]=a*t[3]+r*n[3]):(i[0]=a*t[0]-r*n[0],i[1]=a*t[1]-r*n[1],i[2]=a*t[2]-r*n[2],i[3]=a*t[3]-r*n[3]),e._normalizeArray(i,i)}},{key:"createFromYawPitchRoll",value:function(e,t,n,r){var i=.5*n,a=.5*t,o=.5*e,s=Math.sin(i),l=Math.cos(i),_=Math.sin(a),u=Math.cos(a),c=Math.sin(o),h=Math.cos(o),d=r.elements;d[0]=h*_*l+c*u*s,d[1]=c*u*l-h*_*s,d[2]=h*u*s-c*_*l,d[3]=h*u*l+c*_*s}},{key:"multiply",value:function(e,t,n){var r=e.elements,i=t.elements,a=n.elements,o=r[0],s=r[1],l=r[2],_=r[3],u=i[0],c=i[1],h=i[2],d=i[3],f=s*h-l*c,m=l*u-o*h,E=o*c-s*u,v=o*u+s*c+l*h;a[0]=o*d+u*_+f,a[1]=s*d+c*_+m,a[2]=l*d+h*_+E,a[3]=_*d-v}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(t,n,r){v.subtract(n,t,e.TEMPVector30),v.normalize(e.TEMPVector30,e.TEMPVector30),r.elements[0]=Math.asin(e.TEMPVector30.y),r.elements[1]=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x)}},{key:"createFromAxisAngle",value:function(e,t,n){var r=n.elements,i=e.elements;t*=.5;var a=Math.sin(t);r[0]=a*i[0],r[1]=a*i[1],r[2]=a*i[2],r[3]=Math.cos(t)}},{key:"createFromMatrix3x3",value:function(e,t){var n,r=t.elements,i=e.elements,a=i[0]+i[4]+i[8];if(a>0)n=Math.sqrt(a+1),r[3]=.5*n,n=.5/n,r[0]=(i[5]-i[7])*n,r[1]=(i[6]-i[2])*n,r[2]=(i[1]-i[3])*n;else{var o=0;i[4]>i[0]&&(o=1),i[8]>i[3*o+o]&&(o=2);var s=(o+1)%3,l=(o+2)%3;n=Math.sqrt(i[3*o+o]-i[3*s+s]-i[3*l+l]+1),r[o]=.5*n,n=.5/n,r[3]=(i[3*s+l]-i[3*l+s])*n,r[s]=(i[3*s+o]+i[3*o+s])*n,r[l]=(i[3*l+o]+i[3*o+l])*n}}},{key:"createFromMatrix4x4",value:function(e,t){var n,r,i=e.elements,a=t.elements,o=i[0]+i[5]+i[10];o>0?(n=Math.sqrt(o+1),a[3]=.5*n,n=.5/n,a[0]=(i[6]-i[9])*n,a[1]=(i[8]-i[2])*n,a[2]=(i[1]-i[4])*n):i[0]>=i[5]&&i[0]>=i[10]?(r=.5/(n=Math.sqrt(1+i[0]-i[5]-i[10])),a[0]=.5*n,a[1]=(i[1]+i[4])*r,a[2]=(i[2]+i[8])*r,a[3]=(i[6]-i[9])*r):i[5]>i[10]?(r=.5/(n=Math.sqrt(1+i[5]-i[0]-i[10])),a[0]=(i[4]+i[1])*r,a[1]=.5*n,a[2]=(i[9]+i[6])*r,a[3]=(i[8]-i[2])*r):(r=.5/(n=Math.sqrt(1+i[10]-i[0]-i[5])),a[0]=(i[8]+i[2])*r,a[1]=(i[9]+i[6])*r,a[2]=.5*n,a[3]=(i[1]-i[4])*r)}},{key:"slerp",value:function(e,t,n,r){var i,a,o,s,l,_=e.elements,u=t.elements,c=r.elements,h=_[0],d=_[1],f=_[2],m=_[3],E=u[0],v=u[1],T=u[2],p=u[3];return(a=h*E+d*v+f*T+m*p)<0&&(a=-a,E=-E,v=-v,T=-T,p=-p),1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-n)*i)/o,l=Math.sin(n*i)/o):(s=1-n,l=n),c[0]=s*h+l*E,c[1]=s*d+l*v,c[2]=s*f+l*T,c[3]=s*m+l*p,c}},{key:"lerp",value:function(t,n,r,i){e._lerpArray(t.elements,n.elements,r,i.elements)}},{key:"add",value:function(e,t,n){var r=n.elements,i=e.elements,a=t.elements;r[0]=i[0]+a[0],r[1]=i[1]+a[1],r[2]=i[2]+a[2],r[3]=i[3]+a[3]}},{key:"dot",value:function(t,n){return e._dotArray(t.elements,n.elements)}},{key:"rotationLookAt",value:function(t,n,r){e.lookAt(v.ZERO,t,n,r)}},{key:"lookAt",value:function(t,n,r,i){h.lookAt(t,n,r,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,i)}},{key:"invert",value:function(e,t){var r=e.elements,i=t.elements,a=e.lengthSquared();n.isZero(a)||(a=1/a,i[0]=-r[0]*a,i[1]=-r[1]*a,i[2]=-r[2]*a,i[3]=r[3]*a)}},{key:"rotationMatrix",value:function(e,t){var n,r,i=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],_=i[4],u=i[5],c=i[6],h=i[7],d=i[8],f=t.elements,m=a+_+d;m>0?(n=Math.sqrt(m+1),f[3]=.5*n,n=.5/n,f[0]=(u-h)*n,f[1]=(c-s)*n,f[2]=(o-l)*n):a>=_&&a>=d?(r=.5/(n=Math.sqrt(1+a-_-d)),f[0]=.5*n,f[1]=(o+l)*r,f[2]=(s+c)*r,f[3]=(u-h)*r):_>d?(r=.5/(n=Math.sqrt(1+_-a-d)),f[0]=(l+o)*r,f[1]=.5*n,f[2]=(h+u)*r,f[3]=(c-s)*r):(r=.5/(n=Math.sqrt(1+d-a-_)),f[0]=(c+s)*r,f[1]=(h+u)*r,f[2]=.5*n,f[3]=(o-l)*r)}}]),e}();p.TEMPVector30=new v,p.TEMPVector31=new v,p.TEMPVector32=new v,p.TEMPVector33=new v,p.TEMPMatrix0=new T,p.TEMPMatrix1=new T,p._tempMatrix3x3=new h,p.DEFAULT=new p,p.NAN=new p(NaN,NaN,NaN,NaN);var g=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"READ_DATA",value:function(){e._DATA.offset=e._reader.getUint32(),e._DATA.size=e._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var t=e._BLOCK.count=e._reader.getUint16(),n=e._BLOCK.blockStarts=[],r=e._BLOCK.blockLengths=[],i=0;i<t;i++)n.push(e._reader.getUint32()),r.push(e._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var t=e._reader.getUint32(),n=e._reader.getUint16(),r=e._reader.pos;e._reader.pos=t+e._DATA.offset;for(var i=0;i<n;i++)e._strings[i]=e._reader.readUTFString();e._reader.pos=r}},{key:"parse",value:function(t,n){e._animationClip=t,e._reader=n;n.__getBuffer();e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var r=0,i=e._BLOCK.count;r<i;r++){var a=n.getUint16(),o=e._strings[a],s=e["READ_"+o];if(null==s)throw new Error("model file err,no this function:"+a+" "+o);s.call(null)}}},{key:"READ_ANIMATIONS",value:function(){var n,r,i,o=e._reader,s=(o.__getBuffer(),[]),u=o.getUint16();for(s.length=u,n=0;n<u;n++)s[n]=o.getFloat32();var h=e._animationClip;h.name=e._strings[o.getUint16()];var E=h._duration=o.getFloat32();h.islooping=!!o.getByte(),h._frameRate=o.getInt16();var T=o.getInt16(),g=h._nodes;g.count=T;var y=h._nodesMap={},S=h._nodesDic={};for(n=0;n<T;n++){i=new l,g.setNodeByIndex(n,i),i._indexInList=n;var R=i.type=o.getUint8(),C=o.getUint16();for(i._setOwnerPathCount(C),r=0;r<C;r++)i._setOwnerPathByIndex(r,e._strings[o.getUint16()]);var I=i._joinOwnerPath("/"),A=y[I];A||(y[I]=A=[]),A.push(i),i.propertyOwner=e._strings[o.getUint16()];var x=o.getUint16();for(i._setPropertyCount(x),r=0;r<x;r++)i._setPropertyByIndex(r,e._strings[o.getUint16()]);var D=I+"."+i.propertyOwner+"."+i._joinProperty(".");S[D]=i,i.fullPath=D;var L=o.getUint16();switch(i._setKeyframeCount(L),R){case 0:break;case 1:case 3:case 4:i.data=t.Render.supportWebGLPlusAnimation?new v:new a;break;case 2:i.data=t.Render.supportWebGLPlusAnimation?new p:new d;break;default:throw"AnimationClipParser03:unknown type."}for(r=0;r<L;r++)switch(R){case 0:var M=new c;i._setKeyframeByIndex(r,M),M.time=s[o.getUint16()],M.inTangent=o.getFloat32(),M.outTangent=o.getFloat32(),M.value=o.getFloat32();break;case 1:case 3:case 4:var O=new m;if(i._setKeyframeByIndex(r,O),O.time=s[o.getUint16()],t.Render.supportWebGLPlusAnimation){for(var N=O.data=new Float32Array(9),P=0;P<3;P++)N[P]=o.getFloat32();for(P=0;P<3;P++)N[3+P]=o.getFloat32();for(P=0;P<3;P++)N[6+P]=o.getFloat32()}else{var b=O.inTangent,V=O.outTangent,k=O.value;b.x=o.getFloat32(),b.y=o.getFloat32(),b.z=o.getFloat32(),V.x=o.getFloat32(),V.y=o.getFloat32(),V.z=o.getFloat32(),k.x=o.getFloat32(),k.y=o.getFloat32(),k.z=o.getFloat32()}break;case 2:var w=new f;if(i._setKeyframeByIndex(r,w),w.time=s[o.getUint16()],t.Render.supportWebGLPlusAnimation){for(N=w.data=new Float32Array(12),P=0;P<4;P++)N[P]=o.getFloat32();for(P=0;P<4;P++)N[4+P]=o.getFloat32();for(P=0;P<4;P++)N[8+P]=o.getFloat32()}else{var F=w.inTangent,B=w.outTangent,U=w.value;F.x=o.getFloat32(),F.y=o.getFloat32(),F.z=o.getFloat32(),F.w=o.getFloat32(),B.x=o.getFloat32(),B.y=o.getFloat32(),B.z=o.getFloat32(),B.w=o.getFloat32(),U.x=o.getFloat32(),U.y=o.getFloat32(),U.z=o.getFloat32(),U.w=o.getFloat32()}break;default:throw"AnimationClipParser03:unknown type."}}var G=o.getUint16();for(n=0;n<G;n++){var z,H=new _;H.time=Math.min(E,o.getFloat32()),H.eventName=e._strings[o.getUint16()];var W=o.getUint16();for(W>0&&(H.params=z=[]),r=0;r<W;r++){switch(o.getByte()){case 0:z.push(!!o.getByte());break;case 1:z.push(o.getInt32());break;case 2:z.push(o.getFloat32());break;case 3:z.push(e._strings[o.getUint16()]);break;default:throw new Error("unknown type.")}}h.addEvent(H)}}}]),e}();g._strings=[],g._BLOCK={count:0},g._DATA={offset:0,size:0};var y=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"__init__",value:function(){for(var t=0;t<256;++t){var n=t-127;n<-27?(e._baseTable[0|t]=0,e._baseTable[256|t]=32768,e._shiftTable[0|t]=24,e._shiftTable[256|t]=24):n<-14?(e._baseTable[0|t]=1024>>-n-14,e._baseTable[256|t]=1024>>-n-14|32768,e._shiftTable[0|t]=-n-1,e._shiftTable[256|t]=-n-1):n<=15?(e._baseTable[0|t]=n+15<<10,e._baseTable[256|t]=n+15<<10|32768,e._shiftTable[0|t]=13,e._shiftTable[256|t]=13):n<128?(e._baseTable[0|t]=31744,e._baseTable[256|t]=64512,e._shiftTable[0|t]=24,e._shiftTable[256|t]=24):(e._baseTable[0|t]=31744,e._baseTable[256|t]=64512,e._shiftTable[0|t]=13,e._shiftTable[256|t]=13)}for(e._mantissaTable[0]=0,t=1;t<1024;++t){var r=t<<13;for(n=0;0==(8388608&r);)n-=8388608,r<<=1;r&=-8388609,n+=947912704,e._mantissaTable[t]=r|n}for(t=1024;t<2048;++t)e._mantissaTable[t]=939524096+(t-1024<<13);for(e._exponentTable[0]=0,t=1;t<31;++t)e._exponentTable[t]=t<<23;for(e._exponentTable[31]=1199570944,e._exponentTable[32]=2147483648,t=33;t<63;++t)e._exponentTable[t]=2147483648+(t-32<<23);for(e._exponentTable[63]=3347054592,e._offsetTable[0]=0,t=1;t<64;++t)e._offsetTable[t]=32===t?0:1024}},{key:"roundToFloat16Bits",value:function(t){e._floatView[0]=t;var n=e._uint32View[0],r=n>>23&511;return e._baseTable[r]+((8388607&n)>>e._shiftTable[r])}},{key:"convertToNumber",value:function(t){var n=t>>10;return e._uint32View[0]=e._mantissaTable[e._offsetTable[n]+(1023&t)]+e._exponentTable[n],e._floatView[0]}}]),e}();y._buffer=new ArrayBuffer(4),y._floatView=new Float32Array(y._buffer),y._uint32View=new Uint32Array(y._buffer),y._baseTable=new Uint32Array(512),y._shiftTable=new Uint32Array(512),y._mantissaTable=new Uint32Array(2048),y._exponentTable=new Uint32Array(64),y._offsetTable=new Uint32Array(64);var S=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"READ_DATA",value:function(){e._DATA.offset=e._reader.getUint32(),e._DATA.size=e._reader.getUint32()}},{key:"READ_BLOCK",value:function(){for(var t=e._BLOCK.count=e._reader.getUint16(),n=e._BLOCK.blockStarts=[],r=e._BLOCK.blockLengths=[],i=0;i<t;i++)n.push(e._reader.getUint32()),r.push(e._reader.getUint32())}},{key:"READ_STRINGS",value:function(){var t=e._reader.getUint32(),n=e._reader.getUint16(),r=e._reader.pos;e._reader.pos=t+e._DATA.offset;for(var i=0;i<n;i++)e._strings[i]=e._reader.readUTFString();e._reader.pos=r}},{key:"parse",value:function(t,n,r){e._animationClip=t,e._reader=n,e._version=r,e.READ_DATA(),e.READ_BLOCK(),e.READ_STRINGS();for(var i=0,a=e._BLOCK.count;i<a;i++){var o=n.getUint16(),s=e._strings[o],l=e["READ_"+s];if(null==l)throw new Error("model file err,no this function:"+o+" "+s);l.call(null)}e._version=null,e._reader=null,e._animationClip=null}},{key:"READ_ANIMATIONS",value:function(){var n,r,i,o=e._reader,s=(o.__getBuffer(),[]),u=o.getUint16();for(s.length=u,n=0;n<u;n++)s[n]=o.getFloat32();var h=e._animationClip;h.name=e._strings[o.getUint16()];var E=h._duration=o.getFloat32();h.islooping=!!o.getByte(),h._frameRate=o.getInt16();var T=o.getInt16(),g=h._nodes;g.count=T;var S=h._nodesMap={},R=h._nodesDic={};for(n=0;n<T;n++){i=new l,g.setNodeByIndex(n,i),i._indexInList=n;var C=i.type=o.getUint8(),I=o.getUint16();for(i._setOwnerPathCount(I),r=0;r<I;r++)i._setOwnerPathByIndex(r,e._strings[o.getUint16()]);var A=i._joinOwnerPath("/"),x=S[A];x||(S[A]=x=[]),x.push(i),i.propertyOwner=e._strings[o.getUint16()];var D=o.getUint16();for(i._setPropertyCount(D),r=0;r<D;r++)i._setPropertyByIndex(r,e._strings[o.getUint16()]);var L=A+"."+i.propertyOwner+"."+i._joinProperty(".");R[L]=i,i.fullPath=L;var M=o.getUint16();switch(i._setKeyframeCount(M),C){case 0:break;case 1:case 3:case 4:i.data=t.Render.supportWebGLPlusAnimation?new v:new a;break;case 2:i.data=t.Render.supportWebGLPlusAnimation?new p:new d;break;default:throw"AnimationClipParser04:unknown type."}switch(e._version){case"LAYAANIMATION:04":for(r=0;r<M;r++)switch(C){case 0:var O=new c;i._setKeyframeByIndex(r,O),O.time=s[o.getUint16()],O.inTangent=o.getFloat32(),O.outTangent=o.getFloat32(),O.value=o.getFloat32();break;case 1:case 3:case 4:var N=new m;if(i._setKeyframeByIndex(r,N),N.time=s[o.getUint16()],t.Render.supportWebGLPlusAnimation){for(var P=N.data=new Float32Array(9),b=0;b<3;b++)P[b]=o.getFloat32();for(b=0;b<3;b++)P[3+b]=o.getFloat32();for(b=0;b<3;b++)P[6+b]=o.getFloat32()}else{var V=N.inTangent,k=N.outTangent,w=N.value;V.x=o.getFloat32(),V.y=o.getFloat32(),V.z=o.getFloat32(),k.x=o.getFloat32(),k.y=o.getFloat32(),k.z=o.getFloat32(),w.x=o.getFloat32(),w.y=o.getFloat32(),w.z=o.getFloat32()}break;case 2:var F=new f;if(i._setKeyframeByIndex(r,F),F.time=s[o.getUint16()],t.Render.supportWebGLPlusAnimation){for(P=F.data=new Float32Array(12),b=0;b<4;b++)P[b]=o.getFloat32();for(b=0;b<4;b++)P[4+b]=o.getFloat32();for(b=0;b<4;b++)P[8+b]=o.getFloat32()}else{var B=F.inTangent,U=F.outTangent,G=F.value;B.x=o.getFloat32(),B.y=o.getFloat32(),B.z=o.getFloat32(),B.w=o.getFloat32(),U.x=o.getFloat32(),U.y=o.getFloat32(),U.z=o.getFloat32(),U.w=o.getFloat32(),G.x=o.getFloat32(),G.y=o.getFloat32(),G.z=o.getFloat32(),G.w=o.getFloat32()}break;default:throw"AnimationClipParser04:unknown type."}break;case"LAYAANIMATION:COMPRESSION_04":for(r=0;r<M;r++)switch(C){case 0:O=new c,i._setKeyframeByIndex(r,O),O.time=s[o.getUint16()],O.inTangent=y.convertToNumber(o.getUint16()),O.outTangent=y.convertToNumber(o.getUint16()),O.value=y.convertToNumber(o.getUint16());break;case 1:case 3:case 4:if(N=new m,i._setKeyframeByIndex(r,N),N.time=s[o.getUint16()],t.Render.supportWebGLPlusAnimation){for(P=N.data=new Float32Array(9),b=0;b<3;b++)P[b]=y.convertToNumber(o.getUint16());for(b=0;b<3;b++)P[3+b]=y.convertToNumber(o.getUint16());for(b=0;b<3;b++)P[6+b]=y.convertToNumber(o.getUint16())}else V=N.inTangent,k=N.outTangent,w=N.value,V.x=y.convertToNumber(o.getUint16()),V.y=y.convertToNumber(o.getUint16()),V.z=y.convertToNumber(o.getUint16()),k.x=y.convertToNumber(o.getUint16()),k.y=y.convertToNumber(o.getUint16()),k.z=y.convertToNumber(o.getUint16()),w.x=y.convertToNumber(o.getUint16()),w.y=y.convertToNumber(o.getUint16()),w.z=y.convertToNumber(o.getUint16());break;case 2:if(F=new f,i._setKeyframeByIndex(r,F),F.time=s[o.getUint16()],t.Render.supportWebGLPlusAnimation){for(P=F.data=new Float32Array(12),b=0;b<4;b++)P[b]=y.convertToNumber(o.getUint16());for(b=0;b<4;b++)P[4+b]=y.convertToNumber(o.getUint16());for(b=0;b<4;b++)P[8+b]=y.convertToNumber(o.getUint16())}else B=F.inTangent,U=F.outTangent,G=F.value,B.x=y.convertToNumber(o.getUint16()),B.y=y.convertToNumber(o.getUint16()),B.z=y.convertToNumber(o.getUint16()),B.w=y.convertToNumber(o.getUint16()),U.x=y.convertToNumber(o.getUint16()),U.y=y.convertToNumber(o.getUint16()),U.z=y.convertToNumber(o.getUint16()),U.w=y.convertToNumber(o.getUint16()),G.x=y.convertToNumber(o.getUint16()),G.y=y.convertToNumber(o.getUint16()),G.z=y.convertToNumber(o.getUint16()),G.w=y.convertToNumber(o.getUint16());break;default:throw"AnimationClipParser04:unknown type."}}}var z=o.getUint16();for(n=0;n<z;n++){var H,W=new _;W.time=Math.min(E,o.getFloat32()),W.eventName=e._strings[o.getUint16()];var X=o.getUint16();for(X>0&&(W.params=H=[]),r=0;r<X;r++){switch(o.getByte()){case 0:H.push(!!o.getByte());break;case 1:H.push(o.getInt32());break;case 2:H.push(o.getFloat32());break;case 3:H.push(e._strings[o.getUint16()]);break;default:throw new Error("unknown type.")}}h.addEvent(W)}}}]),e}();S._strings=[],S._BLOCK={count:0},S._DATA={offset:0,size:0};var R=function(){function e(){_classCallCheck(this,e),this._nodes=[]}return _createClass(e,[{key:"getNodeByIndex",value:function(e){return this._nodes[e]}},{key:"setNodeByIndex",value:function(e,t){this._nodes[e]=t}},{key:"count",get:function(){return this._nodes.length},set:function(e){this._nodes.length=e}}]),e}();window.conch&&window.conchKeyframeNodeList&&(R=window.conchKeyframeNodeList),window.qq&&window.qq.webglPlus&&(R=window.qq.webglPlus.conchKeyframeNodeList);var C=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"lightAttenTexture",value:function(e,t,n,r,i,a){var o=e/n,s=1/(1+25*o);o>=.64&&(o>1?s=0:s*=1-(o-.64)/.36),a[i]=Math.floor(255*s+.5)}},{key:"haloTexture",value:function(e,t,n,r,i,a){var o=(e-(n>>=1))/n,s=(t-(r>>=1))/r,l=o*o+s*s;l>1&&(l=1),a[i]=Math.floor(255*(1-l)+.5)}},{key:"_generateTexture2D",value:function(e,n,r,i){var a=0,o=0;switch(e.format){case t.TextureFormat.R8G8B8:o=3;break;case t.TextureFormat.R8G8B8A8:o=4;break;case t.TextureFormat.Alpha8:o=1;break;default:throw"GeneratedTexture._generateTexture: unkonw texture format."}for(var s=new Uint8Array(n*r*o),l=0;l<r;l++)for(var _=0;_<n;_++)i(_,l,n,r,a,s),a+=o;e.setPixels(s)}}]),e}(),I=function e(){_classCallCheck(this,e)};I._bullet=null,I._enablePhysics=!1;var A=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"_createFloatTextureBuffer",value:function(e,n){var r=new t.Texture2D(e,n,t.TextureFormat.R32G32B32A32,!1,!1);return r.filterMode=t.BaseTexture.FILTERMODE_POINT,r.wrapModeU=t.BaseTexture.WARPMODE_CLAMP,r.wrapModeV=t.BaseTexture.WARPMODE_CLAMP,r.anisoLevel=0,r}},{key:"_convertToLayaVec3",value:function(e,t,n){var r=I._bullet;t.x=n?-r.btVector3_z(e):r.btVector3_x(e),t.y=r.btVector3_y(e),t.z=r.btVector3_z(e)}},{key:"_convertToBulletVec3",value:function(e,t,n){I._bullet.btVector3_setValue(t,n?-e.x:e.x,e.y,e.z)}},{key:"_rotationTransformScaleSkinAnimation",value:function(t,n,r,i,a,o,s,l,_,u,c,h){var d,f,m,E,v,T=e._tempArray16_0,p=e._tempArray16_1,g=e._tempArray16_2,y=i+i,S=a+a,R=o+o,C=i*y,I=a*y,A=a*S,x=o*y,D=o*S,L=o*R,M=s*y,O=s*S,N=s*R;for(T[15]=1,T[0]=1-A-L,T[1]=I+N,T[2]=x-O,T[4]=I-N,T[5]=1-C-L,T[6]=D+M,T[8]=x+O,T[9]=D-M,T[10]=1-C-A,p[15]=1,p[0]=l,p[5]=_,p[10]=u,d=0;d<4;d++)f=T[d],m=T[d+4],E=T[d+8],v=T[d+12],g[d]=f,g[d+4]=m,g[d+8]=E,g[d+12]=f*t+m*n+E*r+v;for(d=0;d<4;d++)f=g[d],m=g[d+4],E=g[d+8],v=g[d+12],c[d+h]=f*p[0]+m*p[1]+E*p[2]+v*p[3],c[d+h+4]=f*p[4]+m*p[5]+E*p[6]+v*p[7],c[d+h+8]=f*p[8]+m*p[9]+E*p[10]+v*p[11],c[d+h+12]=f*p[12]+m*p[13]+E*p[14]+v*p[15]}},{key:"_computeBoneAndAnimationDatasByBindPoseMatrxix",value:function(t,n,r,i,a,o){var s,l,_=0,u=0,c=t.length;for(s=0;s<c;_+=t[s].keyframeWidth,u+=16,s++)e._rotationTransformScaleSkinAnimation(n[_+0],n[_+1],n[_+2],n[_+3],n[_+4],n[_+5],n[_+6],n[_+7],n[_+8],n[_+9],i,u),0!=s&&(l=16*t[s].parentIndex,e.mulMatrixByArray(i,l,i,u,i,u));var h=r.length;for(s=0;s<h;s++)e.mulMatrixByArrayAndMatrixFast(i,16*o[s],r[s],a,16*s)}},{key:"_computeAnimationDatasByArrayAndMatrixFast",value:function(t,n,r,i){for(var a=0,o=t.length;a<o;a++)e.mulMatrixByArrayAndMatrixFast(n,16*i[a],t[a],r,16*a)}},{key:"_computeBoneAndAnimationDatasByBindPoseMatrxixOld",value:function(t,n,r,i,a){var o,s,l=0,_=0,u=t.length;for(o=0;o<u;l+=t[o].keyframeWidth,_+=16,o++)e._rotationTransformScaleSkinAnimation(n[l+7],n[l+8],n[l+9],n[l+3],n[l+4],n[l+5],n[l+6],n[l+0],n[l+1],n[l+2],i,_),0!=o&&(s=16*t[o].parentIndex,e.mulMatrixByArray(i,s,i,_,i,_));var c=r.length;for(o=0;o<c;o++){var h=16*o;e.mulMatrixByArrayAndMatrixFast(i,h,r[o],a,h)}}},{key:"_computeAnimationDatasByArrayAndMatrixFastOld",value:function(t,n,r){for(var i=t.length,a=0;a<i;a++){var o=16*a;e.mulMatrixByArrayAndMatrixFast(n,o,t[a],r,o)}}},{key:"_computeRootAnimationData",value:function(t,n,r){for(var i=0,a=0,o=0,s=t.length;i<s;a+=t[i].keyframeWidth,o+=16,i++)e.createAffineTransformationArray(n[a+0],n[a+1],n[a+2],n[a+3],n[a+4],n[a+5],n[a+6],n[a+7],n[a+8],n[a+9],r,o)}},{key:"transformVector3ArrayByQuat",value:function(e,t,n,r,i){var a=e[t],o=e[t+1],s=e[t+2],l=n.x,_=n.y,u=n.z,c=n.w,h=c*a+_*s-u*o,d=c*o+u*a-l*s,f=c*s+l*o-_*a,m=-l*a-_*o-u*s;r[i]=h*c+m*-l+d*-u-f*-_,r[i+1]=d*c+m*-_+f*-l-h*-u,r[i+2]=f*c+m*-u+h*-_-d*-l}},{key:"mulMatrixByArray",value:function(t,n,r,i,a,o){var s,l,_,u,c;if(a===r){for(r=e._tempArray16_3,s=0;s<16;++s)r[s]=a[o+s];i=0}for(s=0;s<4;s++)l=t[n+s],_=t[n+s+4],u=t[n+s+8],c=t[n+s+12],a[o+s]=l*r[i+0]+_*r[i+1]+u*r[i+2]+c*r[i+3],a[o+s+4]=l*r[i+4]+_*r[i+5]+u*r[i+6]+c*r[i+7],a[o+s+8]=l*r[i+8]+_*r[i+9]+u*r[i+10]+c*r[i+11],a[o+s+12]=l*r[i+12]+_*r[i+13]+u*r[i+14]+c*r[i+15]}},{key:"mulMatrixByArrayFast",value:function(e,t,n,r,i,a){var o,s,l,_,u;for(o=0;o<4;o++)s=e[t+o],l=e[t+o+4],_=e[t+o+8],u=e[t+o+12],i[a+o]=s*n[r+0]+l*n[r+1]+_*n[r+2]+u*n[r+3],i[a+o+4]=s*n[r+4]+l*n[r+5]+_*n[r+6]+u*n[r+7],i[a+o+8]=s*n[r+8]+l*n[r+9]+_*n[r+10]+u*n[r+11],i[a+o+12]=s*n[r+12]+l*n[r+13]+_*n[r+14]+u*n[r+15]}},{key:"mulMatrixByArrayAndMatrixFast",value:function(e,t,n,r,i){var a,o,s,l,_,u=n.elements,c=u[0],h=u[1],d=u[2],f=u[3],m=u[4],E=u[5],v=u[6],T=u[7],p=u[8],g=u[9],y=u[10],S=u[11],R=u[12],C=u[13],I=u[14],A=u[15],x=t,D=t+4,L=t+8,M=t+12,O=i,N=i+4,P=i+8,b=i+12;for(a=0;a<4;a++)o=e[x+a],s=e[D+a],l=e[L+a],_=e[M+a],r[O+a]=o*c+s*h+l*d+_*f,r[N+a]=o*m+s*E+l*v+_*T,r[P+a]=o*p+s*g+l*y+_*S,r[b+a]=o*R+s*C+l*I+_*A}},{key:"createAffineTransformationArray",value:function(e,t,n,r,i,a,o,s,l,_,u,c){var h=r+r,d=i+i,f=a+a,m=r*h,E=r*d,v=r*f,T=i*d,p=i*f,g=a*f,y=o*h,S=o*d,R=o*f;u[c+0]=(1-(T+g))*s,u[c+1]=(E+R)*s,u[c+2]=(v-S)*s,u[c+3]=0,u[c+4]=(E-R)*l,u[c+5]=(1-(m+g))*l,u[c+6]=(p+y)*l,u[c+7]=0,u[c+8]=(v+S)*_,u[c+9]=(p-y)*_,u[c+10]=(1-(m+T))*_,u[c+11]=0,u[c+12]=e,u[c+13]=t,u[c+14]=n,u[c+15]=1}},{key:"transformVector3ArrayToVector3ArrayCoordinate",value:function(e,t,n,r,i){var a=e[t+0],o=e[t+1],s=e[t+2],l=n.elements,_=a*l[3]+o*l[7]+s*l[11]+l[15];r[i]=a*l[0]+o*l[4]+s*l[8]+l[12]/_,r[i+1]=a*l[1]+o*l[5]+s*l[9]+l[13]/_,r[i+2]=a*l[2]+o*l[6]+s*l[10]+l[14]/_}},{key:"transformVector3ArrayToVector3ArrayNormal",value:function(e,t,n,r,i){var a=e[t+0],o=e[t+1],s=e[t+2],l=n.elements;r[i]=a*l[0]+o*l[4]+s*l[8],r[i+1]=a*l[1]+o*l[5]+s*l[9],r[i+2]=a*l[2]+o*l[6]+s*l[10]}},{key:"transformLightingMapTexcoordArray",value:function(e,t,n,r,i){r[i+0]=e[t+0]*n.x+n.z,r[i+1]=1-((1-e[t+1])*n.y+n.w)}},{key:"getURLVerion",value:function(e){var t=e.indexOf("?");return t>=0?e.substr(t):null}},{key:"_createAffineTransformationArray",value:function(e,t,n,r){var i=t.x,a=t.y,o=t.z,s=t.w,l=i+i,_=a+a,u=o+o,c=i*l,h=i*_,d=i*u,f=a*_,m=a*u,E=o*u,v=s*l,T=s*_,p=s*u,g=n.x,y=n.y,S=n.z;r[0]=(1-(f+E))*g,r[1]=(h+p)*g,r[2]=(d-T)*g,r[3]=0,r[4]=(h-p)*y,r[5]=(1-(c+E))*y,r[6]=(m+v)*y,r[7]=0,r[8]=(d+T)*S,r[9]=(m-v)*S,r[10]=(1-(c+f))*S,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1}},{key:"_mulMatrixArray",value:function(e,t,n,r){var i,a,o,s,l,_=t.elements,u=_[0],c=_[1],h=_[2],d=_[3],f=_[4],m=_[5],E=_[6],v=_[7],T=_[8],p=_[9],g=_[10],y=_[11],S=_[12],R=_[13],C=_[14],I=_[15],A=r,x=r+4,D=r+8,L=r+12;for(i=0;i<4;i++)a=e[i],o=e[i+4],s=e[i+8],l=e[i+12],n[A+i]=a*u+o*c+s*h+l*d,n[x+i]=a*f+o*m+s*E+l*v,n[D+i]=a*T+o*p+s*g+l*y,n[L+i]=a*S+o*R+s*C+l*I}},{key:"arcTanAngle",value:function(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}},{key:"angleTo",value:function(t,n,r){a.subtract(n,t,d.TEMPVector30),a.normalize(d.TEMPVector30,d.TEMPVector30),r.x=Math.asin(d.TEMPVector30.y),r.y=e.arcTanAngle(-d.TEMPVector30.z,-d.TEMPVector30.x)}},{key:"transformQuat",value:function(e,t,n){var r=t,i=e.x,a=e.y,o=e.z,s=r[0],l=r[1],_=r[2],u=r[3],c=u*i+l*o-_*a,h=u*a+_*i-s*o,d=u*o+s*a-l*i,f=-s*i-l*a-_*o;n.x=c*u+f*-s+h*-_-d*-l,n.y=h*u+f*-l+d*-s-c*-_,n.z=d*u+f*-_+c*-l-h*-s}},{key:"quaternionWeight",value:function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w}},{key:"quaternionConjugate",value:function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w}},{key:"scaleWeight",value:function(e,t,n){var r=e.x,i=e.y,a=e.z;n.x=r>0?Math.pow(Math.abs(r),t):-Math.pow(Math.abs(r),t),n.y=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),n.z=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t)}},{key:"scaleBlend",value:function(t,n,r,i){var a=e._tempVector3_0,o=e._tempVector3_1;e.scaleWeight(t,1-r,a),e.scaleWeight(n,r,o);var s=r>.5?n:t;i.x=s.x>0?Math.abs(a.x*o.x):-Math.abs(a.x*o.x),i.y=s.y>0?Math.abs(a.y*o.y):-Math.abs(a.y*o.y),i.z=s.z>0?Math.abs(a.z*o.z):-Math.abs(a.z*o.z)}},{key:"matrix4x4MultiplyFFF",value:function(e,t,n){var r,i,a,o,s;if(n===t)for(t=new Float32Array(16),r=0;r<16;++r)t[r]=n[r];var l=t[0],_=t[1],u=t[2],c=t[3],h=t[4],d=t[5],f=t[6],m=t[7],E=t[8],v=t[9],T=t[10],p=t[11],g=t[12],y=t[13],S=t[14],R=t[15];for(r=0;r<4;r++)i=e[r],a=e[r+4],o=e[r+8],s=e[r+12],n[r]=i*l+a*_+o*u+s*c,n[r+4]=i*h+a*d+o*f+s*m,n[r+8]=i*E+a*v+o*T+s*p,n[r+12]=i*g+a*y+o*S+s*R}},{key:"matrix4x4MultiplyFFFForNative",value:function(e,n,r){t.LayaGL.instance.matrix4x4Multiply(e,n,r)}},{key:"matrix4x4MultiplyMFM",value:function(t,n,r){e.matrix4x4MultiplyFFF(t.elements,n,r.elements)}},{key:"_buildTexture2D",value:function(e,n,r,i){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=new t.Texture2D(e,n,r,a,!0);return o.anisoLevel=1,o.filterMode=t.BaseTexture.FILTERMODE_POINT,C._generateTexture2D(o,e,n,i),o}},{key:"_drawBound",value:function(t,n,r){t.lineCount+12>t.maxLineCount&&(t.maxLineCount+=12);var i=e._tempVector3_0,a=e._tempVector3_1,o=n.min,s=n.max;i.setValue(o.x,o.y,o.z),a.setValue(s.x,o.y,o.z),t.addLine(i,a,r,r),i.setValue(o.x,o.y,o.z),a.setValue(o.x,o.y,s.z),t.addLine(i,a,r,r),i.setValue(s.x,o.y,o.z),a.setValue(s.x,o.y,s.z),t.addLine(i,a,r,r),i.setValue(o.x,o.y,s.z),a.setValue(s.x,o.y,s.z),t.addLine(i,a,r,r),i.setValue(o.x,o.y,o.z),a.setValue(o.x,s.y,o.z),t.addLine(i,a,r,r),i.setValue(o.x,o.y,s.z),a.setValue(o.x,s.y,s.z),t.addLine(i,a,r,r),i.setValue(s.x,o.y,o.z),a.setValue(s.x,s.y,o.z),t.addLine(i,a,r,r),i.setValue(s.x,o.y,s.z),a.setValue(s.x,s.y,s.z),t.addLine(i,a,r,r),i.setValue(o.x,s.y,o.z),a.setValue(s.x,s.y,o.z),t.addLine(i,a,r,r),i.setValue(o.x,s.y,o.z),a.setValue(o.x,s.y,s.z),t.addLine(i,a,r,r),i.setValue(s.x,s.y,o.z),a.setValue(s.x,s.y,s.z),t.addLine(i,a,r,r),i.setValue(o.x,s.y,s.z),a.setValue(s.x,s.y,s.z),t.addLine(i,a,r,r)}},{key:"_getHierarchyPath",value:function(e,t,n){n.length=0;for(var r=t;r!==e;){var i=r._parent;if(!i)return null;n.push(i.getChildIndex(r)),r=i}return n}},{key:"_getNodeByHierarchyPath",value:function(e,t){for(var n=e,r=t.length-1;r>=0;r--)n=n.getChildAt(t[r]);return n}}]),e}();A._tempVector3_0=new a,A._tempVector3_1=new a,A._tempArray16_0=new Float32Array(16),A._tempArray16_1=new Float32Array(16),A._tempArray16_2=new Float32Array(16),A._tempArray16_3=new Float32Array(16),A._compIdToNode=new Object;var x=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._nodes=new R,e._animationEvents=[],e}return _inherits(n,t.Resource),_createClass(n,[{key:"duration",value:function(){return this._duration}},{key:"_hermiteInterpolate",value:function(e,t,n,r){var i=e.outTangent,a=t.inTangent;if(Number.isFinite(i)&&Number.isFinite(a)){var o=n*n,s=o*n,l=s-2*o+n,_=s-o,u=-2*s+3*o;return(2*s-3*o+1)*e.value+l*i*r+_*a*r+u*t.value}return e.value}},{key:"_hermiteInterpolateVector3",value:function(e,t,n,r,i){var a=e.value,o=e.outTangent,s=t.value,l=t.inTangent,_=n*n,u=_*n,c=2*u-3*_+1,h=u-2*_+n,d=u-_,f=-2*u+3*_,m=o.x,E=l.x;Number.isFinite(m)&&Number.isFinite(E)?i.x=c*a.x+h*m*r+d*E*r+f*s.x:i.x=a.x,m=o.y,E=l.y,Number.isFinite(m)&&Number.isFinite(E)?i.y=c*a.y+h*m*r+d*E*r+f*s.y:i.y=a.y,m=o.z,E=l.z,Number.isFinite(m)&&Number.isFinite(E)?i.z=c*a.z+h*m*r+d*E*r+f*s.z:i.z=a.z}},{key:"_hermiteInterpolateQuaternion",value:function(e,t,n,r,i){var a=e.value,o=e.outTangent,s=t.value,l=t.inTangent,_=n*n,u=_*n,c=2*u-3*_+1,h=u-2*_+n,d=u-_,f=-2*u+3*_,m=o.x,E=l.x;Number.isFinite(m)&&Number.isFinite(E)?i.x=c*a.x+h*m*r+d*E*r+f*s.x:i.x=a.x,m=o.y,E=l.y,Number.isFinite(m)&&Number.isFinite(E)?i.y=c*a.y+h*m*r+d*E*r+f*s.y:i.y=a.y,m=o.z,E=l.z,Number.isFinite(m)&&Number.isFinite(E)?i.z=c*a.z+h*m*r+d*E*r+f*s.z:i.z=a.z,m=o.w,E=l.w,Number.isFinite(m)&&Number.isFinite(E)?i.w=c*a.w+h*m*r+d*E*r+f*s.w:i.w=a.w}},{key:"_evaluateClipDatasRealTime",value:function(e,t,r,i,a){for(var o=0,s=e.count;o<s;o++){var l,_=e.getNodeByIndex(o),u=_.type,c=_._keyFrames,h=c.length,f=r[o];if(a)for(-1!==f&&t<c[f].time&&(f=-1,r[o]=f),l=f+1;l<h&&!(c[l].time>t);)f++,l++,r[o]=f;else for((l=f+1)!==h&&t>c[l].time&&(f=h-1,r[o]=f),l=f+1;f>-1&&!(c[f].time<t);)f--,l--,r[o]=f;var m=l===h;switch(u){case 0:if(-1!==f){var E=c[f];if(m)_.data=E.value;else{var v,T=c[l],p=T.time-E.time;v=0!==p?(t-E.time)/p:0,_.data=this._hermiteInterpolate(E,T,v,p)}}else _.data=c[0].value;i&&(_.data-=c[0].value);break;case 1:case 4:var g=_.data;if(this._evaluateFrameNodeVector3DatasRealTime(c,f,m,t,g),i){var y=c[0].value;g.x-=y.x,g.y-=y.y,g.z-=y.z}break;case 2:var S=_.data;if(this._evaluateFrameNodeQuaternionDatasRealTime(c,f,m,t,S),i){var R=n._tempQuaternion0,C=c[0].value;A.quaternionConjugate(C,R),d.multiply(R,S,S)}break;case 3:g=_.data,this._evaluateFrameNodeVector3DatasRealTime(c,f,m,t,g),i&&(y=c[0].value,g.x/=y.x,g.y/=y.y,g.z/=y.z);break;default:throw"AnimationClip:unknown node type."}}}},{key:"_evaluateClipDatasRealTimeForNative",value:function(e,n,r,i){t.LayaGL.instance.evaluateClipDatasRealTime(e._nativeObj,n,r,i)}},{key:"_evaluateFrameNodeVector3DatasRealTime",value:function(e,t,n,r,i){if(-1!==t){var a=e[t];if(n){var o=a.value;i.x=o.x,i.y=o.y,i.z=o.z}else{var s,l=e[t+1],_=a.time,u=l.time-_;s=0!==u?(r-_)/u:0,this._hermiteInterpolateVector3(a,l,s,u,i)}}else{var c=e[0].value;i.x=c.x,i.y=c.y,i.z=c.z}}},{key:"_evaluateFrameNodeQuaternionDatasRealTime",value:function(e,t,n,r,i){if(-1!==t){var a=e[t];if(n){var o=a.value;i.x=o.x,i.y=o.y,i.z=o.z,i.w=o.w}else{var s,l=e[t+1],_=a.time,u=l.time-_;s=0!==u?(r-_)/u:0,this._hermiteInterpolateQuaternion(a,l,s,u,i)}}else{var c=e[0].value;i.x=c.x,i.y=c.y,i.z=c.z,i.w=c.w}}},{key:"_binarySearchEventIndex",value:function(e){for(var t,n=0,r=this._animationEvents.length-1;n<=r;){t=Math.floor((n+r)/2);var i=this._animationEvents[t].time;if(i==e)return t;i>e?r=t-1:n=t+1}return n}},{key:"addEvent",value:function(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}},{key:"_disposeResource",value:function(){this._nodes=null,this._nodesMap=null}}],[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var r=new n,i=new t.Byte(e),a=i.readUTFString();switch(a){case"LAYAANIMATION:03":g.parse(r,i);break;case"LAYAANIMATION:04":case"LAYAANIMATION:COMPRESSION_04":S.parse(r,i,a);break;default:throw"unknown animationClip version."}return r}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,n.ANIMATIONCLIP)}}]),n}();x.ANIMATIONCLIP="ANIMATIONCLIP",x._tempQuaternion0=new d;var D=function(){function e(){_classCallCheck(this,e),this._currentState=null}return _createClass(e,[{key:"_resetPlayState",value:function(e){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._playEventIndex=0,this._lastIsFront=!0}},{key:"_cloneTo",value:function(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._playEventIndex=this._playEventIndex,e._lastIsFront=this._lastIsFront}},{key:"normalizedTime",get:function(){return this._normalizedTime}},{key:"duration",get:function(){return this._duration}},{key:"animatorState",get:function(){return this._currentState}}]),e}(),L=function(){function e(t){_classCallCheck(this,e),this._defaultState=null,this._referenceCount=0,this._playType=-1,this._crossDuration=-1,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwners=[],this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this._statesMap={},this._states=[],this._playStateInfo=new D,this._crossPlayStateInfo=new D,this.blendingMode=e.BLENDINGMODE_OVERRIDE,this.defaultWeight=1,this.playOnWake=!0,this.name=t}return _createClass(e,[{key:"_removeClip",value:function(e,t,n,r){var i=r._clip,a=e[n];if(e.splice(n,1),delete t[r.name],this._animator){var o=i._nodes,s=a._nodeOwners;i._removeReference();for(var l=0,_=o.count;l<_;l++)this._animator._removeKeyframeNodeOwner(s,o.getNodeByIndex(l))}}},{key:"_getReferenceCount",value:function(){return this._referenceCount}},{key:"_addReference",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0,n=this._states.length;t<n;t++)this._states[t]._addReference(e);this._referenceCount+=e}},{key:"_removeReference",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=0,n=this._states.length;t<n;t++)this._states[t]._removeReference(e);this._referenceCount-=e}},{key:"_clearReference",value:function(){this._removeReference(-this._referenceCount)}},{key:"getCurrentPlayState",value:function(){return this._playStateInfo}},{key:"getAnimatorState",value:function(e){var t=this._statesMap[e];return t||null}},{key:"addState",value:function(e){var t=e.name;if(this._statesMap[t])throw"AnimatorControllerLayer:this stat's name has exist.";this._statesMap[t]=e,this._states.push(e),this._animator&&(e._clip._addReference(),this._animator._getOwnersByClip(e))}},{key:"removeState",value:function(e){for(var t=this._states,n=-1,r=0,i=t.length;r<i;r++)if(t[r]===e){n=r;break}-1!==n&&this._removeClip(t,this._statesMap,n,e)}},{key:"destroy",value:function(){this._clearReference(),this._statesMap=null,this._states=null,this._playStateInfo=null,this._crossPlayStateInfo=null,this._defaultState=null}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.blendingMode=this.blendingMode,t.defaultWeight=this.defaultWeight,t.playOnWake=this.playOnWake}},{key:"clone",value:function(){var t=new e(this.name);return this.cloneTo(t),t}},{key:"defaultState",get:function(){return this._defaultState},set:function(e){this._defaultState=e,this._statesMap[e.name]=e}}]),e}();L.BLENDINGMODE_OVERRIDE=0,L.BLENDINGMODE_ADDTIVE=1;var M=function(){function e(){_classCallCheck(this,e),this._referenceCount=0,this._clip=null,this._nodeOwners=[],this._currentFrameIndices=null,this._scripts=null,this.speed=1,this.clipStart=0,this.clipEnd=1}return _createClass(e,[{key:"_getReferenceCount",value:function(){return this._referenceCount}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._clip&&this._clip._addReference(e),this._referenceCount+=e}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._clip&&this._clip._removeReference(e),this._referenceCount-=e}},{key:"_clearReference",value:function(){this._removeReference(-this._referenceCount)}},{key:"_resetFrameIndices",value:function(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}},{key:"addScript",value:function(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}},{key:"getScript",value:function(e){if(this._scripts)for(var t=0,n=this._scripts.length;t<n;t++){var r=this._scripts[t];if(r instanceof e)return r}return null}},{key:"getScripts",value:function(e){var t;if(this._scripts)for(var n=0,r=this._scripts.length;n<r;n++){var i=this._scripts[n];i instanceof e&&(t=t||[]).push(i)}return t}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.speed=this.speed,t.clipStart=this.clipStart,t.clipEnd=this.clipEnd,t.clip=this._clip}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip!==e&&(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e&&(this._currentFrameIndices=new Int16Array(e._nodes.count),this._resetFrameIndices(),this._referenceCount>0&&this._clip._addReference(this._referenceCount)),this._clip=e)}}]),e}(),O=function(){function e(){_classCallCheck(this,e),this.indexInList=-1,this.referenceCount=0,this.updateMark=-1,this.type=-1,this.fullPath=null,this.propertyOwner=null,this.property=null,this.defaultValue=null,this.crossFixedValue=null}return _createClass(e,[{key:"saveCrossFixedValue",value:function(){var e=this.propertyOwner;if(e)switch(this.type){case 0:for(var t=this.property,n=t.length-1,r=0;r<n&&(e=e[t[r]]);r++);this.crossFixedValue=e[t[n]];break;case 1:var i=e.localPosition;this.crossFixedValue||(this.crossFixedValue=new a),this.crossFixedValue.x=i.x,this.crossFixedValue.y=i.y,this.crossFixedValue.z=i.z;break;case 2:var o=e.localRotation;this.crossFixedValue||(this.crossFixedValue=new d),this.crossFixedValue.x=o.x,this.crossFixedValue.y=o.y,this.crossFixedValue.z=o.z,this.crossFixedValue.w=o.w;break;case 3:var s=e.localScale;this.crossFixedValue||(this.crossFixedValue=new a),this.crossFixedValue.x=s.x,this.crossFixedValue.y=s.y,this.crossFixedValue.z=s.z;break;case 4:var l=e.localRotationEuler;this.crossFixedValue||(this.crossFixedValue=new a),this.crossFixedValue.x=l.x,this.crossFixedValue.y=l.y,this.crossFixedValue.z=l.z;break;default:throw"Animator:unknown type."}}}]),e}(),N=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._keyframeNodeOwners=[],e._linkAvatarSpritesData={},e._linkAvatarSprites=[],e._renderableSprites=[],e.cullingMode=n.CULLINGMODE_CULLCOMPLETELY,e._controllerLayers=[],e._linkSprites={},e._speed=1,e._keyframeNodeOwnerMap={},e._updateMark=0,e}return _inherits(n,t.Component),_createClass(n,[{key:"_linkToSprites",value:function(e){for(var t in e){for(var n=this.owner,r=e[t],i=0,a=r.length;i<a;i++){var o=r[i];if(""===o)break;if(!(n=n.getChildByName(o)))break}n&&this.linkSprite3DToAvatarNode(t,n)}}},{key:"_addKeyframeNodeOwner",value:function(e,t,n){var r=t._indexInList,i=t.fullPath,a=this._keyframeNodeOwnerMap[i];if(a)a.referenceCount++,e[r]=a;else{for(var o=n,s=0,l=t.propertyCount;s<l&&(o=o[t.getPropertyByIndex(s)]);s++);(a=this._keyframeNodeOwnerMap[i]=new O).fullPath=i,a.indexInList=this._keyframeNodeOwners.length,a.referenceCount=1,a.propertyOwner=n;var _=t.propertyCount,u=[];for(s=0;s<_;s++)u[s]=t.getPropertyByIndex(s);if(a.property=u,a.type=t.type,o)if(0===t.type)a.defaultValue=o;else{var c=new o.constructor;o.cloneTo(c),a.defaultValue=c}this._keyframeNodeOwners.push(a),e[r]=a}}},{key:"_removeKeyframeNodeOwner",value:function(e,t){var n=t.fullPath,r=this._keyframeNodeOwnerMap[n];r&&(r.referenceCount--,0===r.referenceCount&&(delete this._keyframeNodeOwnerMap[n],this._keyframeNodeOwners.splice(this._keyframeNodeOwners.indexOf(r),1)),e[t._indexInList]=null)}},{key:"_getOwnersByClip",value:function(e){var t=e._clip._nodes,n=t.count,r=e._nodeOwners;r.length=n;for(var i=0;i<n;i++){for(var a=t.getNodeByIndex(i),o=this._avatar?this._avatarNodeMap[this._avatar._rootNode.name]:this.owner,s=0,l=a.ownerPathCount;s<l;s++){var _=a.getOwnerPathByIndex(s);if(""===_)break;if(!(o=o.getChildByName(_)))break}if(o){var u=a.propertyOwner;u&&(o=o[u]),o&&this._addKeyframeNodeOwner(r,a,o)}}}},{key:"_updatePlayer",value:function(e,t,n,r){var i=e._clip._duration*(e.clipEnd-e.clipStart),a=t._elapsedTime,o=a+n;t._lastElapsedTime=a,t._elapsedTime=o;var s=o/i;t._normalizedTime=s;var l=s%1;t._normalizedPlayTime=l<0?l+1:l,t._duration=i;var _=e._scripts;if(!r&&o>=i){if(t._finish=!0,t._elapsedTime=i,t._normalizedPlayTime=1,_)for(var u=0,c=_.length;u<c;u++)_[u].onStateExit()}else if(_)for(u=0,c=_.length;u<c;u++)_[u].onStateUpdate()}},{key:"_eventScript",value:function(e,t,n,r,i){if(i)for(var a=t.length;n<a;n++){var o=t[n];if(!(o.time<=r))break;for(var s=0,l=e.length;s<l;s++){var _=e[s],u=_[o.eventName];u&&u.apply(_,o.params)}}else for(;n>=0&&(o=t[n]).time>=r;n--)for(s=0,l=e.length;s<l;s++)(u=(_=e[s])[o.eventName])&&u.apply(_,o.params);return n}},{key:"_updateEventScript",value:function(e,t){var n=this.owner._scripts;if(n){var r=e._clip,i=r._animationEvents,a=r._duration,o=t._elapsedTime,s=o%a,l=Math.abs(Math.floor(o/a)-Math.floor(t._lastElapsedTime/a)),_=t._elapsedTime>=t._lastElapsedTime;if(t._lastIsFront!==_&&(_?t._playEventIndex++:t._playEventIndex--,t._lastIsFront=_),0==l)t._playEventIndex=this._eventScript(n,i,t._playEventIndex,s,_);else if(_){this._eventScript(n,i,t._playEventIndex,a,!0);for(var u=0,c=l-1;u<c;u++)this._eventScript(n,i,0,a,!0);t._playEventIndex=this._eventScript(n,i,0,s,!0)}else{this._eventScript(n,i,t._playEventIndex,0,!1);var h=i.length-1;for(u=0,c=l-1;u<c;u++)this._eventScript(n,i,h,0,!1);t._playEventIndex=this._eventScript(n,i,h,s,!1)}}}},{key:"_updateClipDatas",value:function(e,t,n,r){var i=e._clip,a=i._duration,o=e.clipStart*a+n._normalizedPlayTime*n._duration,s=e._currentFrameIndices,l=n._elapsedTime>n._lastElapsedTime;i._evaluateClipDatasRealTime(i._nodes,o,s,t,l)}},{key:"_applyFloat",value:function(e,t,n,r,i,a,o){if(n.updateMark===this._updateMark)if(r)e[t]+=i*o;else{var s=e[t];e[t]=s+i*(o-s)}else if(a)e[t]=r?n.defaultValue+o:o;else if(r)e[t]=n.defaultValue+i*o;else{var l=n.defaultValue;e[t]=l+i*(o-l)}}},{key:"_applyPositionAndRotationEuler",value:function(e,t,n,r,i,a){if(e.updateMark===this._updateMark)if(t)a.x+=n*i.x,a.y+=n*i.y,a.z+=n*i.z;else{var o=a.x,s=a.y,l=a.z;a.x=o+n*(i.x-o),a.y=s+n*(i.y-s),a.z=l+n*(i.z-l)}else if(r)if(t){var _=e.defaultValue;a.x=_.x+i.x,a.y=_.y+i.y,a.z=_.z+i.z}else a.x=i.x,a.y=i.y,a.z=i.z;else if(_=e.defaultValue,t)a.x=_.x+n*i.x,a.y=_.y+n*i.y,a.z=_.z+n*i.z;else{var u=_.x,c=_.y,h=_.z;a.x=u+n*(i.x-u),a.y=c+n*(i.y-c),a.z=h+n*(i.z-h)}}},{key:"_applyRotation",value:function(e,t,r,i,a,o){if(e.updateMark===this._updateMark)if(t){var s=n._tempQuaternion1;A.quaternionWeight(a,r,s),s.normalize(s),d.multiply(o,s,o)}else d.lerp(o,a,r,o);else if(i)if(t){var l=e.defaultValue;d.multiply(l,a,o)}else o.x=a.x,o.y=a.y,o.z=a.z,o.w=a.w;else l=e.defaultValue,t?(s=n._tempQuaternion1,A.quaternionWeight(a,r,s),s.normalize(s),d.multiply(l,s,o)):d.lerp(l,a,r,o)}},{key:"_applyScale",value:function(e,t,r,i,a,o){if(e.updateMark===this._updateMark)if(t){var s=n._tempVector31;A.scaleWeight(a,r,s),o.x=o.x*s.x,o.y=o.y*s.y,o.z=o.z*s.z}else A.scaleBlend(o,a,r,o);else if(i)if(t){var l=e.defaultValue;o.x=l.x*a.x,o.y=l.y*a.y,o.z=l.z*a.z}else o.x=a.x,o.y=a.y,o.z=a.z;else l=e.defaultValue,t?(s=n._tempVector31,A.scaleWeight(a,r,s),o.x=l.x*s.x,o.y=l.y*s.y,o.z=l.z*s.z):A.scaleBlend(l,a,r,o)}},{key:"_applyCrossData",value:function(e,t,r,i,a,o,s){var l=e.propertyOwner;if(l){switch(e.type){case 0:for(var _=e.property,u=_.length-1,c=0;c<u&&(l=l[_[c]]);c++);var h=a+s*(o-a);this._applyFloat(l,_[u],e,t,r,i,h);break;case 1:var f=l.localPosition,m=n._tempVector30,E=a.x,v=a.y,T=a.z;m.x=E+s*(o.x-E),m.y=v+s*(o.y-v),m.z=T+s*(o.z-T),this._applyPositionAndRotationEuler(e,t,r,i,m,f),l.localPosition=f;break;case 2:var p=l.localRotation,g=n._tempQuaternion0;d.lerp(a,o,s,g),this._applyRotation(e,t,r,i,g,p),l.localRotation=p;break;case 3:var y=l.localScale,S=n._tempVector30;A.scaleBlend(a,o,s,S),this._applyScale(e,t,r,i,S,y),l.localScale=y;break;case 4:var R=l.localRotationEuler,C=n._tempVector30;E=a.x,v=a.y,T=a.z,C.x=E+s*(o.x-E),C.y=v+s*(o.y-v),C.z=T+s*(o.z-T),this._applyPositionAndRotationEuler(e,t,r,i,C,R),l.localRotationEuler=R}e.updateMark=this._updateMark}}},{key:"_setClipDatasToNode",value:function(e,t,n,r){for(var i=e._clip._nodes,a=e._nodeOwners,o=0,s=i.count;o<s;o++){var l=a[o];if(l){var _=l.propertyOwner;if(_){switch(l.type){case 0:for(var u=l.property,c=u.length-1,h=0;h<c&&(_=_[u[h]]);h++);this._applyFloat(_,u[c],l,t,n,r,i.getNodeByIndex(o).data);break;case 1:var d=_.localPosition;this._applyPositionAndRotationEuler(l,t,n,r,i.getNodeByIndex(o).data,d),_.localPosition=d;break;case 2:var f=_.localRotation;this._applyRotation(l,t,n,r,i.getNodeByIndex(o).data,f),_.localRotation=f;break;case 3:var m=_.localScale;this._applyScale(l,t,n,r,i.getNodeByIndex(o).data,m),_.localScale=m;break;case 4:var E=_.localRotationEuler;this._applyPositionAndRotationEuler(l,t,n,r,i.getNodeByIndex(o).data,E),_.localRotationEuler=E}l.updateMark=this._updateMark}}}}},{key:"_setCrossClipDatasToNode",value:function(e,t,n,r,i){for(var a=e._crossNodesOwners,o=e._crossNodesOwnersCount,s=e.blendingMode!==L.BLENDINGMODE_OVERRIDE,l=e.defaultWeight,_=e._destCrossClipNodeIndices,u=n._clip._nodes,c=n._nodeOwners,h=e._srcCrossClipNodeIndices,d=t._nodeOwners,f=t._clip._nodes,m=0;m<o;m++){var E=a[m];if(E){var v=h[m],T=_[m],p=-1!==v?f.getNodeByIndex(v).data:c[T].defaultValue,g=-1!==T?u.getNodeByIndex(T).data:d[v].defaultValue;this._applyCrossData(E,s,l,i,p,g,r)}}}},{key:"_setFixedCrossClipDatasToNode",value:function(e,t,n,r){for(var i=e._crossNodesOwners,a=e._crossNodesOwnersCount,o=e.blendingMode!==L.BLENDINGMODE_OVERRIDE,s=e.defaultWeight,l=e._destCrossClipNodeIndices,_=t._clip._nodes,u=0;u<a;u++){var c=i[u];if(c){var h=l[u],d=c.crossFixedValue,f=-1!==h?_.getNodeByIndex(h).data:c.defaultValue;this._applyCrossData(c,o,s,r,d,f,n)}}}},{key:"_revertDefaultKeyframeNodes",value:function(e){for(var t=e._nodeOwners,n=0,r=t.length;n<r;n++){var i=t[n];if(i){var a=i.propertyOwner;if(a)switch(i.type){case 0:for(var o=i.property,s=o.length-1,l=0;l<s&&(a=a[o[l]]);l++);a[o[s]]=i.defaultValue;break;case 1:var _=a.localPosition,u=i.defaultValue;_.x=u.x,_.y=u.y,_.z=u.z,a.localPosition=_;break;case 2:var c=a.localRotation,h=i.defaultValue;c.x=h.x,c.y=h.y,c.z=h.z,c.w=h.w,a.localRotation=c;break;case 3:var d=a.localScale;u=i.defaultValue,d.x=u.x,d.y=u.y,d.z=u.z,a.localScale=d;break;case 4:var f=a.localRotationEuler;u=i.defaultValue,f.x=u.x,f.y=u.y,f.z=u.z,a.localRotationEuler=f;break;default:throw"Animator:unknown type."}}}}},{key:"_onAdded",value:function(){var e=this.owner._parent;this.owner._setHierarchyAnimator(this,e?e._hierarchyAnimator:null),this.owner._changeAnimatorToLinkSprite3DNoAvatar(this,!0,[])}},{key:"_onDestroy",value:function(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e]._removeReference();var n=this.owner._parent;this.owner._clearHierarchyAnimator(this,n?n._hierarchyAnimator:null)}},{key:"_onEnable",value:function(){this.owner._scene._animatorPool.add(this);for(var e=0,t=this._controllerLayers.length;e<t;e++){if(this._controllerLayers[e].playOnWake)this.getDefaultState(e)&&this.play(null,e,0)}}},{key:"_onDisable",value:function(){this.owner._scene._animatorPool.remove(this)}},{key:"_handleSpriteOwnersBySprite",value:function(e,t,n){for(var r=0,i=this._controllerLayers.length;r<i;r++)for(var a=this._controllerLayers[r]._states,o=0,s=a.length;o<s;o++){var l=a[o],_=l._clip,u=t.join("/"),c=_._nodesMap[u];if(c)for(var h=l._nodeOwners,d=0,f=c.length;d<f;d++)e?this._addKeyframeNodeOwner(h,c[d],n):this._removeKeyframeNodeOwner(h,c[d])}}},{key:"_parse",value:function(e){var n=e.avatar;if(n){this.avatar=t.Loader.getRes(n.path);var r=n.linkSprites;this._linkSprites=r,this._linkToSprites(r)}e.clipPaths;for(var i=e.playOnWake,a=e.layers,o=0;o<a.length;o++){var s=a[o],l=new L(s.name);l.defaultWeight=0===o?1:s.weight;var _=s.blendingMode;_&&(l.blendingMode=_),this.addControllerLayer(l);for(var u=s.states,c=0,h=u.length;c<h;c++){var d=u[c],f=d.clipPath;if(f){var m,E=d.name;if(m=t.Loader.getRes(f)){var v=new M;v.name=E,v.clip=m,l.addState(v),0===c&&(this.getControllerLayer(o).defaultState=v)}}}void 0!==i&&(l.playOnWake=i)}var T=e.cullingMode;void 0!==T&&(this.cullingMode=T)}},{key:"_update",value:function(){var e=this.owner._scene.timer,r=e._delta/1e3;if(0!==this._speed&&0!==r){var i;if(this.cullingMode===n.CULLINGMODE_CULLCOMPLETELY){i=!1;for(var a=0,o=this._renderableSprites.length;a<o;a++)if(this._renderableSprites[a]._render._visible){i=!0;break}}else i=!0;this._updateMark++;var s=e.scale;for(a=0,o=this._controllerLayers.length;a<o;a++){var l=this._controllerLayers[a],_=l._playStateInfo,u=l._crossPlayStateInfo;switch(m=l.blendingMode!==L.BLENDINGMODE_OVERRIDE,l._playType){case 0:var c=_._currentState,h=c._clip,d=this._speed*c.speed,f=_._finish;if(f||this._updatePlayer(c,_,r*d,h.islooping),i){var m=l.blendingMode!==L.BLENDINGMODE_OVERRIDE;this._updateClipDatas(c,m,_,s*d),this._setClipDatasToNode(c,m,l.defaultWeight,0===a),f||this._updateEventScript(c,_)}break;case 1:h=(c=_._currentState)._clip;var E=l._crossPlayState,v=E._clip,T=l._crossDuration,p=u._startPlayTime,g=v._duration-p,y=T>g?g/T:1,S=this._speed*E.speed;this._updatePlayer(E,u,r*y*S,v.islooping);var R=(u._elapsedTime-p)/y/T;R>=1?i&&(this._updateClipDatas(E,m,u,s*S),this._setClipDatasToNode(E,m,l.defaultWeight,0===a),l._playType=0,_._currentState=E,u._cloneTo(_)):(_._finish||(d=this._speed*c.speed,this._updatePlayer(c,_,r*d,h.islooping)),i&&(this._updateClipDatas(c,m,_,s*d),this._updateClipDatas(E,m,u,s*y*S),this._setCrossClipDatasToNode(l,c,E,R,0===a))),i&&(this._updateEventScript(c,_),this._updateEventScript(E,u));break;case 2:v=(E=l._crossPlayState)._clip,T=l._crossDuration,p=u._startPlayTime,y=T>(g=v._duration-p)?g/T:1,S=this._speed*E.speed,this._updatePlayer(E,u,r*y*S,v.islooping),i&&((R=(u._elapsedTime-p)/y/T)>=1?(this._updateClipDatas(E,m,u,s*S),this._setClipDatasToNode(E,m,1,0===a),l._playType=0,_._currentState=E,u._cloneTo(_)):(this._updateClipDatas(E,m,u,s*y*S),this._setFixedCrossClipDatasToNode(l,E,R,0===a)),this._updateEventScript(E,u))}}i&&this._avatar&&(t.Render.supportWebGLPlusAnimation&&this._updateAnimationNodeWorldMatix(this._animationNodeLocalPositions,this._animationNodeLocalRotations,this._animationNodeLocalScales,this._animationNodeWorldMatrixs,this._animationNodeParentIndices),this._updateAvatarNodesToSprite())}}},{key:"_cloneTo",value:function(e){var t=e;t.avatar=this.avatar,t.cullingMode=this.cullingMode;for(var n=0,r=this._controllerLayers.length;n<r;n++){var i=this._controllerLayers[n];t.addControllerLayer(i.clone());for(var a=i._states,o=0,s=a.length;o<s;o++){var l=a[o].clone(),_=t.getControllerLayer(n);_.addState(l),0==o&&(_.defaultState=l)}}t._linkSprites=this._linkSprites,t._linkToSprites(this._linkSprites)}},{key:"getDefaultState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e].defaultState}},{key:"addState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._controllerLayers[t].addState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.addState() instead.")}},{key:"removeState",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this._controllerLayers[t].removeState(e),console.warn("Animator:this function is discard,please use animatorControllerLayer.removeState() instead.")}},{key:"addControllerLayer",value:function(e){this._controllerLayers.push(e),e._animator=this,e._addReference();for(var t=e._states,n=0,r=t.length;n<r;n++)this._getOwnersByClip(t[n])}},{key:"getControllerLayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e]}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.NEGATIVE_INFINITY,r=this._controllerLayers[t];if(r){var i=r.defaultState;if(!e&&!i)throw new Error("Animator:must have default clip value,please set clip property.");var a=r._playStateInfo,o=a._currentState,s=e?r._statesMap[e]:i,l=s._clip._duration;o!==s?(n!==Number.NEGATIVE_INFINITY?a._resetPlayState(l*n):a._resetPlayState(0),null!==o&&o!==s&&this._revertDefaultKeyframeNodes(o),r._playType=0,a._currentState=s):n!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(l*n),r._playType=0);var _=s._scripts;if(_)for(var u=0,c=_.length;u<c;u++)_[u].onStateEnter()}else console.warn("Invalid layerIndex "+t+".")}},{key:"crossFade",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.NEGATIVE_INFINITY,i=this._controllerLayers[n];if(i){var a=i._statesMap[e];if(a){var o=i._playType;if(-1===o)return void this.play(e,n,r);var s=i._crossPlayStateInfo,l=i._crossNodesOwners,_=i._crossNodesOwnersIndicesMap,u=i._playStateInfo._currentState,c=a._nodeOwners,h=i._destCrossClipNodeIndices,d=a._clip,f=d._nodes,m=d._nodesDic;switch(o){case 0:var E=u._nodeOwners,v=i._srcCrossClipNodeIndices,T=u._clip,p=T._nodes,g=T._nodesDic;i._playType=1;for(var y=++i._crossMark,S=i._crossNodesOwnersCount=0,R=0,C=p.count;R<C;R++){var I=p.getNodeByIndex(R),A=I._indexInList,x=E[A];if(x){var D=I.fullPath;v[S]=A;var L=m[D];h[S]=L?L._indexInList:-1,_[D]=y,l[S]=x,S++}}for(R=0,C=f.count;R<C;R++){var M=(L=f.getNodeByIndex(R))._indexInList,O=c[M];if(O){var N=L.fullPath;g[N]||(v[S]=-1,h[S]=M,_[N]=y,l[S]=O,S++)}}break;case 1:case 2:for(i._playType=2,R=0,C=l.length;R<C;R++){var P=l[R];P.saveCrossFixedValue(),L=m[P.fullPath],h[R]=L?L._indexInList:-1}for(S=i._crossNodesOwnersCount,y=i._crossMark,R=0,C=f.count;R<C;R++)(O=c[M=(L=f.getNodeByIndex(R))._indexInList])&&_[N=L.fullPath]!==y&&(h[S]=M,_[N]=y,P=c[M],l[S]=P,P.saveCrossFixedValue(),S++)}i._crossNodesOwnersCount=S,i._crossPlayState=a,i._crossDuration=u._clip._duration*t,r!==Number.NEGATIVE_INFINITY?s._resetPlayState(d._duration*r):s._resetPlayState(0);var b=a._scripts;if(b)for(R=0,C=b.length;R<C;R++)b[R].onStateEnter()}else console.warn("Invalid name "+n+".")}else console.warn("Invalid layerIndex "+n+".")}},{key:"_getAvatarOwnersAndInitDatasAsync",value:function(){for(var e=0,t=this._controllerLayers.length;e<t;e++)for(var n=this._controllerLayers[e]._states,r=0,i=n.length;r<i;r++)this._getOwnersByClip(n[r]);for(var a in this._avatar._cloneDatasToAnimator(this),this._linkAvatarSpritesData){var o=this._linkAvatarSpritesData[a];if(o)for(var s=0,l=o.length;s<l;s++)this._isLinkSpriteToAnimationNode(o[s],a,!0)}}},{key:"_isLinkSpriteToAnimationNode",value:function(e,t,n){if(this._avatar){var r=this._avatarNodeMap[t];if(r)if(n){e._transform._dummy=r.transform,this._linkAvatarSprites.push(e);var i=r.transform,a=e.transform;if(!a.owner.isStatic&&i){var o=a.worldMatrix,s=this.owner._transform._parent;if(s)A.matrix4x4MultiplyMFM(s.worldMatrix,i.getWorldMatrix(),o);else for(var l=o.elements,_=i.getWorldMatrix(),u=0;u<16;u++)l[u]=_[u];a.worldMatrix=o}}else e._transform._dummy=null,this._linkAvatarSprites.splice(this._linkAvatarSprites.indexOf(e),1)}}},{key:"_isLinkSpriteToAnimationNodeData",value:function(e,t,n){var r=this._linkAvatarSpritesData[t];if(n)r||(this._linkAvatarSpritesData[t]=r=[]),r.push(e);else{var i=r.indexOf(e);r.splice(i,1)}}},{key:"_updateAvatarNodesToSprite",value:function(){for(var e=0,t=this._linkAvatarSprites.length;e<t;e++){var n=this._linkAvatarSprites[e],r=n.transform._dummy,i=n.transform;if(!i.owner.isStatic&&r){var a=i.worldMatrix,o=this.owner._transform;A.matrix4x4MultiplyMFM(o.worldMatrix,r.getWorldMatrix(),a),i.worldMatrix=a}}}},{key:"linkSprite3DToAvatarNode",value:function(e,t){return this._isLinkSpriteToAnimationNodeData(t,e,!0),this._isLinkSpriteToAnimationNode(t,e,!0),!0}},{key:"unLinkSprite3DToAvatarNode",value:function(e){if(e._hierarchyAnimator===this){var t=e.transform._dummy;if(t){var n=t._owner.name;return this._isLinkSpriteToAnimationNodeData(e,n,!1),this._isLinkSpriteToAnimationNode(e,n,!1),!0}return!1}throw"Animator:sprite3D must belong to this Animator"}},{key:"getCurrentAnimatorPlayState",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._controllerLayers[e]._playStateInfo}},{key:"_updateAnimationNodeWorldMatix",value:function(e,n,r,i,a){t.LayaGL.instance.updateAnimationNodeWorldMatix(e,n,r,a,i)}},{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"avatar",get:function(){return this._avatar},set:function(e){if(this._avatar!==e)if(this._avatar=e,e)this._getAvatarOwnersAndInitDatasAsync(),this.owner._changeHierarchyAnimatorAvatar(this,e);else{var t=this.owner._parent;this.owner._changeHierarchyAnimatorAvatar(this,t?t._hierarchyAnimator._avatar:null)}}}],[{key:"_update",value:function(e){for(var t=e._animatorPool,n=t.elements,r=0,i=t.length;r<i;r++){var a=n[r];a&&a.enabled&&a._update()}}}]),n}();N._tempVector30=new a,N._tempVector31=new a,N._tempQuaternion0=new d,N._tempQuaternion1=new d,N.CULLINGMODE_ALWAYSANIMATE=0,N.CULLINGMODE_CULLCOMPLETELY=2;var P=function e(){_classCallCheck(this,e),this.source=null,this.destination=null,this.camera=null,this.compositeShaderData=null,this.command=null,this.deferredReleaseTextures=[]},b=function e(){_classCallCheck(this,e),this.invertY=!1};b._instance=new b;var V=function(e){function n(e,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.RenderTextureFormat.R8G8B8,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.RenderTextureDepthFormat.DEPTH_16;_classCallCheck(this,n);var o=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,i,!1));return o._inPool=!1,o._isCameraTarget=!1,o._glTextureType=t.LayaGL.instance.TEXTURE_2D,o._width=e,o._height=r,o._depthStencilFormat=a,o._create(e,r),o}return _inherits(n,t.BaseTexture),_createClass(n,[{key:"_texImage2D",value:function(e,n,r,i){switch(this._format){case t.RenderTextureFormat.R8G8B8:e.texImage2D(n,0,e.RGB,r,i,0,e.RGB,e.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R8G8B8A8:e.texImage2D(n,0,e.RGBA,r,i,0,e.RGBA,e.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.Alpha8:e.texImage2D(n,0,e.ALPHA,r,i,0,e.ALPHA,e.UNSIGNED_BYTE,null);break;case t.RenderTextureFormat.R16G16B16A16:t.LayaGL.layaGPUInstance._isWebGL2?e.texImage2D(this._glTextureType,0,e.RGBA16F,r,i,0,e.RGBA,e.HALF_FLOAT,null):e.texImage2D(this._glTextureType,0,e.RGBA,r,i,0,e.RGBA,t.LayaGL.layaGPUInstance._oesTextureHalfFloat.HALF_FLOAT_OES,null)}}},{key:"_create",value:function(e,n){var r=t.LayaGL.instance;if(this._frameBuffer=r.createFramebuffer(),t.WebGLContext.bindTexture(r,this._glTextureType,this._glTexture),this._texImage2D(r,this._glTextureType,e,n),this._setGPUMemory(e*n*4),r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this._glTexture,0),this._depthStencilFormat!==t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE)switch(this._depthStencilBuffer=r.createRenderbuffer(),r.bindRenderbuffer(r.RENDERBUFFER,this._depthStencilBuffer),this._depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,e,n),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.STENCIL_8:r.renderbufferStorage(r.RENDERBUFFER,r.STENCIL_INDEX8,e,n),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.STENCIL_ATTACHMENT,r.RENDERBUFFER,this._depthStencilBuffer);break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_16_8:r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,e,n),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,this._depthStencilBuffer);break;default:throw"RenderTexture: unkonw depth format."}r.bindFramebuffer(r.FRAMEBUFFER,null),r.bindRenderbuffer(r.RENDERBUFFER,null),this._setWarpMode(r.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(r.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._readyed=!0,this._activeResource()}},{key:"_start",value:function(){var e=t.LayaGL.instance;e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),n._currentActive=this,this._isCameraTarget&&(b._instance.invertY=!0),this._readyed=!1}},{key:"_end",value:function(){var e=t.LayaGL.instance;e.bindFramebuffer(e.FRAMEBUFFER,null),n._currentActive=null,this._isCameraTarget&&(b._instance.invertY=!1),this._readyed=!0}},{key:"getData",value:function(e,n,r,i,a){if(t.Render.isConchApp&&2==window.conchConfig.threadMode)throw"native 2 thread mode use getDataAsync";var o=t.LayaGL.instance;return o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.checkFramebufferStatus(o.FRAMEBUFFER)===o.FRAMEBUFFER_COMPLETE?(o.readPixels(e,n,r,i,o.RGBA,o.UNSIGNED_BYTE,a),o.bindFramebuffer(o.FRAMEBUFFER,null),a):(o.bindFramebuffer(o.FRAMEBUFFER,null),null)}},{key:"getDataAsync",value:function(e,n,r,i,a){var o=t.LayaGL.instance;o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.readPixelsAsync(e,n,r,i,o.RGBA,o.UNSIGNED_BYTE,function(e){a(new Uint8Array(e))}),o.bindFramebuffer(o.FRAMEBUFFER,null)}},{key:"_disposeResource",value:function(){if(this._frameBuffer){var e=t.LayaGL.instance;e.deleteTexture(this._glTexture),e.deleteFramebuffer(this._frameBuffer),e.deleteRenderbuffer(this._depthStencilBuffer),this._glTexture=null,this._frameBuffer=null,this._depthStencilBuffer=null,this._setGPUMemory(0)}}},{key:"depthStencilFormat",get:function(){return this._depthStencilFormat}},{key:"defaulteTexture",get:function(){return t.Texture2D.grayTexture}}],[{key:"createFromPool",value:function(e,r){for(var i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.RenderTextureFormat.R8G8B8,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.RenderTextureDepthFormat.DEPTH_16,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:t.BaseTexture.FILTERMODE_BILINEAR,l=0,_=n._pool.length;l<_;l++)if((i=n._pool[l])._width==e&&i._height==r&&i._format==a&&i._depthStencilFormat==o&&i._filterMode==s){i._inPool=!1;var u=n._pool[_-1];return n._pool[l]=u,n._pool.length-=1,i}return(i=new n(e,r,a,o)).filterMode=s,i.lock=!0,i}},{key:"recoverToPool",value:function(e){e._inPool||(n._pool.push(e),e._inPool=!0)}},{key:"currentActive",get:function(){return n._currentActive}}]),n}();V._pool=[];var k=function(){function e(){_classCallCheck(this,e),this._mask=[],this._length=0}return _createClass(e,[{key:"_intersectionDefineDatas",value:function(e){for(var t=e._mask,n=this._mask,r=this._length-1;r>=0;r--){var i=n[r]&t[r];0==i&&r==this._length-1?this._length--:n[r]=i}}},{key:"add",value:function(e){var t=e._index,n=t+1,r=this._mask,i=r.length;if(i<n){for(r.length=n;i<t;i++)r[i]=0;r[t]=e._value,this._length=n}else n>this._length?(r[t]=e._value,this._length=n):r[t]|=e._value}},{key:"remove",value:function(e){var t=e._index,n=this._mask,r=this._length-1;if(!(t>r)){var i=n[t]&~e._value;t==r&&0===i?this._length--:n[t]=i}}},{key:"addDefineDatas",value:function(e){var t=e._mask,n=e._length,r=this._mask,i=r.length;if(i<n){r.length=n;for(var a=0;a<i;a++)r[a]|=t[a];for(;i<n;i++)r[i]=t[i];this._length=n}else{for(a=0;a<n;a++)r[a]|=t[a];this._length=Math.max(this._length,n)}}},{key:"removeDefineDatas",value:function(e){for(var t=e._mask,n=this._mask,r=this._length-1,i=e._length-1;i>=0;i--)if(!(i>r)){var a=n[i]&~t[i];i==r&&0===a?(r--,this._length--):n[i]=a}}},{key:"has",value:function(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}},{key:"clear",value:function(){this._length=0}},{key:"cloneTo",value:function(e){var t=e,n=t._mask,r=this._mask,i=this._length;n.length=i;for(var a=0;a<i;a++)n[a]=r[a];t._length=i}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}}]),e}(),w=function e(t,n){_classCallCheck(this,e),this._index=t,this._value=n},F=function(){function e(t,n,r,i){_classCallCheck(this,e),this._subShaderIndex=0,this._passIndex=0,this.setValue(t,n,r,i)}return _createClass(e,[{key:"setValue",value:function(e,t,n,r){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var i=e.getSubShaderAt(t);if(!i)throw"ShaderVariantInfo:Shader don't have subShaderIndex of "+t+".";var a=i._passes[n];if(!a)throw"ShaderVariantInfo:Shader don't have passIndex of "+n+".";for(var o=a._validDefine,l=0,_=r.length;l<_;l++){var u=r[l];if(!o.has(s.Shader3D.getDefineByName(u)))throw"ShaderVariantInfo:Invalid defineName "+u+" in "+e._name+" subShaderIndex of "+t+" passIndex of "+n+"."}this._shader=e,this._subShaderIndex=t,this._passIndex=n,this._defineNames=r}},{key:"equal",value:function(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,n=e._defineNames;if(t.length!==n.length)return!1;for(var r=0,i=this._defineNames.length;r<i;r++)if(t[r]!==n[r])return!1;return!0}},{key:"clone",value:function(){return new e(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}},{key:"shader",get:function(){return this._shader}},{key:"subShaderIndex",get:function(){return this._subShaderIndex}},{key:"passIndex",get:function(){return this._passIndex}},{key:"defineNames",get:function(){return this._defineNames}}]),e}(),B=function(){function e(){_classCallCheck(this,e),this._allCompiled=!1,this._variants=[]}return _createClass(e,[{key:"add",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return!1;return this._variants.push(e.clone()),this._allCompiled=!1,!0}},{key:"remove",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return this._variants.splice(t,1),!0;return!1}},{key:"contatins",value:function(e){for(var t=0,n=this._variants.length;t<n;t++)if(this._variants[t].equal(e))return!0;return!1}},{key:"getByIndex",value:function(e){return this._variants[e]}},{key:"clear",value:function(){this._variants.length=0}},{key:"compile",value:function(){if(!this._allCompiled){for(var e=this._variants,t=0,n=e.length;t<n;t++){var r=e[t];s.Shader3D.compileShaderByDefineNames(r._shader._name,r._subShaderIndex,r._passIndex,r._defineNames)}this._allCompiled=!0}}},{key:"allCompiled",get:function(){return this._allCompiled}},{key:"variantCount",get:function(){return this._variants.length}}]),e}(),U=function(){function e(t,n,r,i){_classCallCheck(this,e),this._attributeMap=null,this._uniformMap=null,this._enableInstancing=!1,this._subShaders=[],this._name=t,this._attributeMap=n,this._uniformMap=r,this._enableInstancing=i}return _createClass(e,[{key:"addSubShader",value:function(e){this._subShaders.push(e),e._owner=this}},{key:"getSubShaderAt",value:function(e){return this._subShaders[e]}},{key:"name",get:function(){return this._name}}],[{key:"_getNamesByDefineData",value:function(t,n){var r=e._maskMap,i=t._mask;n.length=0;for(var a=0,o=t._length;a<o;a++)for(var s=r[a],l=i[a],_=0;_<32;_++){var u=1<<_;if(l>0&&u>l)break;l&u&&n.push(s[u])}}},{key:"getDefineByName",value:function(t){var n=e._defineMap[t];if(!n){var r=e._maskMap,i=e._defineCounter,a=Math.floor(i/32),o=1<<i%32;n=new w(a,o),e._defineMap[t]=n,a==r.length&&(r.length++,r[a]={}),r[a][o]=t,e._defineCounter++}return n}},{key:"propertyNameToID",value:function(t){if(null!=e._propertyNameMap[t])return e._propertyNameMap[t];var n=e._propertyNameCounter++;return e._propertyNameMap[t]=n,n}},{key:"addInclude",value:function(e,n){n=n.replace(t.ShaderCompile._clearCR,""),t.ShaderCompile.addInclude(e,n)}},{key:"compileShaderByDefineNames",value:function(t,n,r,i){var a=e.find(t);if(a){var s=a.getSubShaderAt(n);if(s){var l=s._passes[r];if(l){var _=e._compileDefineDatas;_.clear();for(var u=0,c=i.length;u<c;u++)_.add(e.getDefineByName(i[u]));o._config._multiLighting||_.add(e.SHADERDEFINE_LEGACYSINGALLIGHTING),l.withCompile(_)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}},{key:"add",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return e._preCompileShader[t]=new e(t,n,r,i)}},{key:"find",value:function(t){return e._preCompileShader[t]}},{key:"compileShader",value:function(t,n,r){var i=e.find(t);if(i){var a=i.getSubShaderAt(n);if(a){var s=a._passes[r];if(s){var l=e._compileDefineDatas,_=l._mask;_.length=0;for(var u=arguments.length,c=Array(u>3?u-3:0),h=3;h<u;h++)c[h-3]=arguments[h];for(var d=0,f=c.length;d<f;d++)_.push(c[d]);l._length=c.length,o._config._multiLighting||l.add(e.SHADERDEFINE_LEGACYSINGALLIGHTING),s.withCompile(l)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}}]),e}();U._compileDefineDatas=new k,U.RENDER_STATE_CULL=0,U.RENDER_STATE_BLEND=1,U.RENDER_STATE_BLEND_SRC=2,U.RENDER_STATE_BLEND_DST=3,U.RENDER_STATE_BLEND_SRC_RGB=4,U.RENDER_STATE_BLEND_DST_RGB=5,U.RENDER_STATE_BLEND_SRC_ALPHA=6,U.RENDER_STATE_BLEND_DST_ALPHA=7,U.RENDER_STATE_BLEND_CONST_COLOR=8,U.RENDER_STATE_BLEND_EQUATION=9,U.RENDER_STATE_BLEND_EQUATION_RGB=10,U.RENDER_STATE_BLEND_EQUATION_ALPHA=11,U.RENDER_STATE_DEPTH_TEST=12,U.RENDER_STATE_DEPTH_WRITE=13,U.PERIOD_CUSTOM=0,U.PERIOD_MATERIAL=1,U.PERIOD_SPRITE=2,U.PERIOD_CAMERA=3,U.PERIOD_SCENE=4,U._propertyNameCounter=0,U._propertyNameMap={},U._defineCounter=0,U._defineMap={},U._preCompileShader={},U._maskMap=[],U.debugMode=!0,U.debugShaderVariantCollection=new B;var G=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;_classCallCheck(this,e),this._ownerResource=null,this._data=null,this._defineDatas=new k,this._runtimeCopyValues=[],this._ownerResource=t,this._initData()}return _createClass(e,[{key:"_initData",value:function(){this._data=new Object}},{key:"getData",value:function(){return this._data}},{key:"addDefine",value:function(e){this._defineDatas.add(e)}},{key:"removeDefine",value:function(e){this._defineDatas.remove(e)}},{key:"hasDefine",value:function(e){return this._defineDatas.has(e)}},{key:"clearDefine",value:function(){this._defineDatas.clear()}},{key:"getBool",value:function(e){return this._data[e]}},{key:"setBool",value:function(e,t){this._data[e]=t}},{key:"getInt",value:function(e){return this._data[e]}},{key:"setInt",value:function(e,t){this._data[e]=t}},{key:"getNumber",value:function(e){return this._data[e]}},{key:"setNumber",value:function(e,t){this._data[e]=t}},{key:"getVector2",value:function(e){return this._data[e]}},{key:"setVector2",value:function(e,t){this._data[e]=t}},{key:"getVector3",value:function(e){return this._data[e]}},{key:"setVector3",value:function(e,t){this._data[e]=t}},{key:"getVector",value:function(e){return this._data[e]}},{key:"setVector",value:function(e,t){this._data[e]=t}},{key:"getQuaternion",value:function(e){return this._data[e]}},{key:"setQuaternion",value:function(e,t){this._data[e]=t}},{key:"getMatrix4x4",value:function(e){return this._data[e]}},{key:"setMatrix4x4",value:function(e,t){this._data[e]=t}},{key:"getBuffer",value:function(e){return this._data[e]}},{key:"setBuffer",value:function(e,t){this._data[e]=t}},{key:"setTexture",value:function(e,t){var n=this._data[e];this._data[e]=t,this._ownerResource&&this._ownerResource.referenceCount>0&&(n&&n._removeReference(),t&&t._addReference())}},{key:"getTexture",value:function(e){return this._data[e]}},{key:"setAttribute",value:function(e,t){this._data[e]=t}},{key:"getAttribute",value:function(e){return this._data[e]}},{key:"getLength",value:function(){return this._data.length}},{key:"setLength",value:function(e){this._data.length=e}},{key:"cloneTo",value:function(e){var n=e,o=n._data;for(var s in this._data){var l=this._data[s];if(null!=l)if("number"==typeof l)o[s]=l;else if("number"==typeof l)o[s]=l;else if("boolean"==typeof l)o[s]=l;else if(l instanceof r){var _=o[s]||(o[s]=new r);l.cloneTo(_),o[s]=_}else if(l instanceof a){var u=o[s]||(o[s]=new a);l.cloneTo(u),o[s]=u}else if(l instanceof i){var c=o[s]||(o[s]=new i);l.cloneTo(c),o[s]=c}else if(l instanceof T){var h=o[s]||(o[s]=new T);l.cloneTo(h),o[s]=h}else l instanceof t.BaseTexture&&(o[s]=l)}this._defineDatas.cloneTo(n._defineDatas)}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"cloneToForNative",value:function(e){var n=e;this._int32Data.length-n._int32Data.length>0&&n.needRenewArrayBufferForNative(this._int32Data.length),n._int32Data.set(this._int32Data,0);var o=n._nativeArray,s=this._nativeArray.length;o.length=s;for(var l=0;l<s;l++){var _=this._nativeArray[l];if(_)if("number"==typeof _)o[l]=_,n.setNumber(l,_);else if("number"==typeof _)o[l]=_,n.setInt(l,_);else if("boolean"==typeof _)o[l]=_,n.setBool(l,_);else if(_ instanceof r){var u=o[l]||(o[l]=new r);_.cloneTo(u),o[l]=u,n.setVector2(l,u)}else if(_ instanceof a){var c=o[l]||(o[l]=new a);_.cloneTo(c),o[l]=c,n.setVector3(l,c)}else if(_ instanceof i){var h=o[l]||(o[l]=new i);_.cloneTo(h),o[l]=h,n.setVector(l,h)}else if(_ instanceof T){var d=o[l]||(o[l]=new T);_.cloneTo(d),o[l]=d,n.setMatrix4x4(l,d)}else _ instanceof t.BaseTexture&&(o[l]=_,n.setTexture(l,_))}this._defineDatas.cloneTo(n._defineDatas)}},{key:"_initDataForNative",value:function(){this._frameCount=-1,this._runtimeCopyValues.length=0,this._nativeArray=[],this._data=new ArrayBuffer(32),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),t.LayaGL.instance.createArrayBufferRef(this._data,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0)}},{key:"needRenewArrayBufferForNative",value:function(e){if(e>=this._int32Data.length){var n=4*(e+1),r=this._int32Data,i=this._data.conchRef,a=this._data._ptrID;this._data=new ArrayBuffer(n),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),this._data.conchRef=i,this._data._ptrID=a,r&&this._int32Data.set(r,0);var o=t.LayaGL.instance;o.updateArrayBufferRef?o.updateArrayBufferRef(this._data._ptrID,i.isSyncToRender(),this._data):window.conch.updateArrayBufferRef(this._data._ptrID,i.isSyncToRender(),this._data)}}},{key:"getDataForNative",value:function(){return this._nativeArray}},{key:"getIntForNative",value:function(e){return this._int32Data[e]}},{key:"setIntForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t,this._nativeArray[e]=t}},{key:"getBoolForNative",value:function(e){return 1==this._int32Data[e]}},{key:"setBoolForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._int32Data[e]=t?1:0,this._nativeArray[e]=t}},{key:"getNumberForNative",value:function(e){return this._float32Data[e]}},{key:"setNumberForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._float32Data[e]=t,this._nativeArray[e]=t}},{key:"getMatrix4x4ForNative",value:function(e){return this._nativeArray[e]}},{key:"setMatrix4x4ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVectorForNative",value:function(e){return this._nativeArray[e]}},{key:"setVectorForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVector2ForNative",value:function(e){return this._nativeArray[e]}},{key:"setVector2ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getVector3ForNative",value:function(e){return this._nativeArray[e]}},{key:"setVector3ForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getQuaternionForNative",value:function(e){return this._nativeArray[e]}},{key:"setQuaternionForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t,t.elements||t.forNativeElement();var n=this.setReferenceForNative(t.elements);this._int32Data[e]=n}},{key:"getBufferForNative",value:function(e){return this._nativeArray[e]}},{key:"setBufferForNative",value:function(e,t){this.needRenewArrayBufferForNative(e),this._nativeArray[e]=t;var n=this.setReferenceForNative(t);this._int32Data[e]=n}},{key:"getAttributeForNative",value:function(e){return this._nativeArray[e]}},{key:"setAttributeForNative",value:function(e,n){this._nativeArray[e]=n,n._ptrID||t.LayaGL.instance.createArrayBufferRef(n,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0),t.LayaGL.instance.syncBufferToRenderThread(n),this._int32Data[e]=n._ptrID}},{key:"getTextureForNative",value:function(e){return this._nativeArray[e]}},{key:"setTextureForNative",value:function(e,t){if(t){this.needRenewArrayBufferForNative(e);var n=this._nativeArray[e];this._nativeArray[e]=t;var r=t._getSource()||t.defaulteTexture._getSource();this._int32Data[e]=r.id,this._ownerResource&&this._ownerResource.referenceCount>0&&(n&&n._removeReference(),t&&t._addReference())}}},{key:"setReferenceForNative",value:function(n){this.clearRuntimeCopyArray();var r=0,i=0;return e._SET_RUNTIME_VALUE_MODE_REFERENCE_?(t.LayaGL.instance.createArrayBufferRefs(n,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_REFERENCE),r=0,i=n.getPtrID(r)):(t.LayaGL.instance.createArrayBufferRefs(n,t.LayaGL.ARRAY_BUFFER_TYPE_DATA,!0,t.LayaGL.ARRAY_BUFFER_REF_COPY),r=n.getRefNum()-1,i=n.getPtrID(r),this._runtimeCopyValues.push({obj:n,refID:r,ptrID:i})),t.LayaGL.instance.syncBufferToRenderThread(n,r),i}},{key:"clearRuntimeCopyArray",value:function(){var e=t.Stat.loopCount;if(this._frameCount!=e){this._frameCount=e;for(var n=0,r=this._runtimeCopyValues.length;n<r;n++){this._runtimeCopyValues[n].obj.clearRefNum()}this._runtimeCopyValues.length=0}}}],[{key:"setRuntimeValueMode",value:function(t){e._SET_RUNTIME_VALUE_MODE_REFERENCE_=t}}]),e}();G._SET_RUNTIME_VALUE_MODE_REFERENCE_=!0;var z=function(){function e(){_classCallCheck(this,e),this._compositeShader=U.find("PostProcessComposite"),this._compositeShaderData=new G,this._effects=[],this._context=null,this._context=new P,this._context.compositeShaderData=this._compositeShaderData}return _createClass(e,[{key:"_init",value:function(e,t){this._context.camera=e,this._context.command=t}},{key:"_render",value:function(){var n=G._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&G.setRuntimeValueMode(!1);var r=this._context.camera,i=r.viewport,a=V.createFromPool(b.clientWidth,b.clientHeight,r._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE),o=r._internalRenderTexture;this._context.command.clear(),this._context.source=a,this._context.destination=o,this._context.compositeShaderData.clearDefine(),this._context.command.blitScreenTriangle(o,a),this._context.compositeShaderData.setTexture(e.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);for(var s=0,l=this._effects.length;s<l;s++)this._effects[s].render(this._context);this._compositeShaderData.addDefine(e.SHADERDEFINE_FINALPASS);var _=r._offScreenRenderTexture,u=_||null;this._context.destination=u;var c=r._getCanvasWidth(),h=r._getCanvasHeight();r._screenOffsetScale.setValue(i.x/c,i.y/h,i.width/c,i.height/h),this._context.command.blitScreenTriangle(this._context.source,u,r._screenOffsetScale,this._compositeShader,this._compositeShaderData),V.recoverToPool(a);var d=this._context.deferredReleaseTextures;for(s=0,l=d.length;s<l;s++)V.recoverToPool(d[s]);d.length=0,t.ILaya.Render.supportWebGLPlusRendering&&G.setRuntimeValueMode(n)}},{key:"addEffect",value:function(e){this._effects.push(e)}},{key:"removeEffect",value:function(e){var t=this._effects.indexOf(e);-1!==t&&this._effects.splice(t,1)}}],[{key:"__init__",value:function(){e.SHADERDEFINE_BLOOM_LOW=U.getDefineByName("BLOOM_LOW"),e.SHADERDEFINE_BLOOM=U.getDefineByName("BLOOM"),e.SHADERDEFINE_FINALPASS=U.getDefineByName("FINALPASS")}}]),e}();z.SHADERVALUE_MAINTEX=U.propertyNameToID("u_MainTex"),z.SHADERVALUE_BLOOMTEX=U.propertyNameToID("u_BloomTex"),z.SHADERVALUE_AUTOEXPOSURETEX=U.propertyNameToID("u_AutoExposureTex"),z.SHADERVALUE_BLOOM_DIRTTEX=U.propertyNameToID("u_Bloom_DirtTex"),z.SHADERVALUE_BLOOMTEX_TEXELSIZE=U.propertyNameToID("u_BloomTex_TexelSize"),z.SHADERVALUE_BLOOM_DIRTTILEOFFSET=U.propertyNameToID("u_Bloom_DirtTileOffset"),z.SHADERVALUE_BLOOM_SETTINGS=U.propertyNameToID("u_Bloom_Settings"),z.SHADERVALUE_BLOOM_COLOR=U.propertyNameToID("u_Bloom_Color");var H=function(e){function n(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;_classCallCheck(this,n);var l=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return l._owner=e,l._children=[],l._localMatrix=new Float32Array(16),t.Render.supportWebGLPlusAnimation?(l._localPosition=new v(0,0,0,r),l._localRotation=new p(0,0,0,1,i),l._localScale=new v(0,0,0,o),l._worldMatrix=s):(l._localPosition=new a,l._localRotation=new d,l._localScale=new a,l._worldMatrix=new Float32Array(16)),l._localQuaternionUpdate=!1,l._locaEulerlUpdate=!1,l._localUpdate=!1,l._worldUpdate=!0,l}return _inherits(n,t.EventDispatcher),_createClass(n,[{key:"_getlocalMatrix",value:function(){return this._localUpdate&&(A._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix}},{key:"_onWorldTransform",value:function(){if(!this._worldUpdate){this._worldUpdate=!0,this.event(t.Event.TRANSFORM_CHANGED);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldTransform()}}},{key:"getWorldMatrix",value:function(){if(!t.Render.supportWebGLPlusAnimation&&this._worldUpdate){if(null!=this._parent)A.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else{var e=this._worldMatrix;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1}this._worldUpdate=!1}return t.Render.supportWebGLPlusAnimation&&this._worldUpdate&&(this._worldUpdate=!1),this._worldMatrix}},{key:"setParent",value:function(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,n=t.indexOf(this);t.splice(n,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}},{key:"localPosition",get:function(){return this._localPosition},set:function(e){this._localPosition=e,this._localUpdate=!0,this._onWorldTransform()}},{key:"localRotation",get:function(){if(this._localQuaternionUpdate){var e=this._localRotationEuler;d.createFromYawPitchRoll(e.y/n._angleToRandin,e.x/n._angleToRandin,e.z/n._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},set:function(e){this._localRotation=e,this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform()}},{key:"localScale",get:function(){return this._localScale},set:function(e){this._localScale=e,this._localUpdate=!0,this._onWorldTransform()}},{key:"localRotationEuler",get:function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(n._tempVector3);var e=n._tempVector3,t=this._localRotationEuler;t.x=e.y*n._angleToRandin,t.y=e.x*n._angleToRandin,t.z=e.z*n._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler},set:function(e){this._localRotationEuler=e,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,this._onWorldTransform()}}]),n}();H._tempVector3=new a,H._angleToRandin=180/Math.PI;var W=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,e),this._children=[],this.transform=new H(this,t,n,r,i)}return _createClass(e,[{key:"addChild",value:function(e){e._parent=this,e.transform.setParent(this.transform),this._children.push(e)}},{key:"removeChild",value:function(e){var t=this._children.indexOf(e);-1!==t&&this._children.splice(t,1)}},{key:"getChildByName",value:function(e){for(var t=0,n=this._children.length;t<n;t++){var r=this._children[t];if(r.name===e)return r}return null}},{key:"getChildByIndex",value:function(e){return this._children[e]}},{key:"getChildCount",value:function(){return this._children.length}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name;for(var n=0,r=this._children.length;n<r;n++){var i=this._children[n],a=i.clone();t.addChild(a);var o=i.transform,s=a.transform,l=s.localPosition,_=s.localRotation,u=s.localScale;o.localPosition.cloneTo(l),o.localRotation.cloneTo(_),o.localScale.cloneTo(u),s.localPosition=l,s.localRotation=_,s.localScale=u}}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"_cloneNative",value:function(t,n,r,i,a,o,s){var l=s._nativeCurCloneCount;a[l]=o;var _=new e(new Float32Array(t.buffer,3*l*4,3),new Float32Array(n.buffer,4*l*4,4),new Float32Array(r.buffer,3*l*4,3),new Float32Array(i.buffer,16*l*4,16));return _._worldMatrixIndex=l,this._cloneToNative(_,t,n,r,i,a,l,s),_}},{key:"_cloneToNative",value:function(e,t,n,r,i,a,o,s){var l=e;l.name=this.name;for(var _=0,u=this._children.length;_<u;_++){var c=this._children[_];s._nativeCurCloneCount++;var h=c._cloneNative(t,n,r,i,a,o,s);l.addChild(h);var d=c.transform,f=h.transform,m=f.localPosition,E=f.localRotation,v=f.localScale;d.localPosition.cloneTo(m),d.localRotation.cloneTo(E),d.localScale.cloneTo(v),f.localPosition=m,f.localRotation=E,f.localScale=v}}}]),e}(),X=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._nativeNodeCount=0,e._nativeCurCloneCount=0,e}return _inherits(n,t.Resource),_createClass(n,[{key:"_initCloneToAnimator",value:function(e,t){t._avatarNodeMap[e.name]=e;for(var n=0,r=e.getChildCount();n<r;n++)this._initCloneToAnimator(e.getChildByIndex(n),t)}},{key:"_parseNode",value:function(e,n){var r=e.props.name;n.name=r;var i=e.props,a=n.transform,o=a.localPosition,s=a.localRotation,l=a.localScale;o.fromArray(i.translate),s.fromArray(i.rotation),l.fromArray(i.scale),a.localPosition=o,a.localRotation=s,a.localScale=l;for(var _=e.child,u=0,c=_.length;u<c;u++){var h=_[u],d=new W(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16));n.addChild(d),t.Render.supportWebGLPlusAnimation&&this._nativeNodeCount++,this._parseNode(h,d)}}},{key:"_cloneDatasToAnimator",value:function(e){var t;t=this._rootNode.clone();var n=this._rootNode.transform,r=t.transform,i=r.localPosition,a=r.localRotation,o=r.localScale;n.localPosition.cloneTo(i),n.localRotation.cloneTo(a),n.localScale.cloneTo(o),r.localPosition=i,r.localRotation=a,r.localScale=o,e._avatarNodeMap={},this._initCloneToAnimator(t,e)}},{key:"cloneTo",value:function(e){var t=e,n=this._rootNode.clone();t._rootNode=n}},{key:"clone",value:function(){var e=new n;return this.cloneTo(e),e}},{key:"_cloneDatasToAnimatorNative",value:function(e){var t=new Float32Array(3*this._nativeNodeCount),n=new Float32Array(4*this._nativeNodeCount),r=new Float32Array(3*this._nativeNodeCount),i=new Float32Array(16*this._nativeNodeCount),a=new Int16Array(this._nativeNodeCount);e._animationNodeLocalPositions=t,e._animationNodeLocalRotations=n,e._animationNodeLocalScales=r,e._animationNodeWorldMatrixs=i,e._animationNodeParentIndices=a,this._nativeCurCloneCount=0;var o=this._rootNode._cloneNative(t,n,r,i,a,-1,this),s=this._rootNode.transform,l=o.transform,_=l.localPosition,u=l.localRotation,c=l.localScale;s.localPosition.cloneTo(_),s.localRotation.cloneTo(u),s.localScale.cloneTo(c),l.localPosition=_,l.localRotation=u,l.localScale=c,e._avatarNodeMap={},this._initCloneToAnimator(o,e)}}],[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var r=new n;if(r._rootNode=new W(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16)),t.Render.supportWebGLPlusAnimation&&r._nativeNodeCount++,e.version){var i=e.rootNode;i&&r._parseNode(i,r._rootNode)}return r}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,n.AVATAR)}}]),n}();X.AVATAR="AVATAR";var Y=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._shaderValues=null,e._disablePublicDefineDatas=new k,e._shaderValues=new G(e),e.renderQueue=n.RENDERQUEUE_OPAQUE,e._alphaTest=!1,e}return _inherits(n,t.Resource),_createClass(n,[{key:"_removeTetxureReference",value:function(){var e=this._shaderValues.getData();for(var n in e){var r=e[n];r&&r instanceof t.BaseTexture&&r._removeReference()}}},{key:"_disposeResource",value:function(){this._referenceCount>0&&this._removeTetxureReference(),this._shaderValues=null}},{key:"_addReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_addReference",this).call(this,e);var r=this._shaderValues.getData();for(var i in r){var a=r[i];a&&a instanceof t.BaseTexture&&a._addReference()}}},{key:"_removeReference",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_removeReference",this).call(this,e),this._removeTetxureReference()}},{key:"setShaderName",value:function(e){if(this._shader=U.find(e),!this._shader)throw new Error("BaseMaterial: unknown shader name.")}},{key:"cloneTo",value:function(e){var t=e;t.name=this.name,t.renderQueue=this.renderQueue,this._disablePublicDefineDatas.cloneTo(t._disablePublicDefineDatas),this._shaderValues.cloneTo(t._shaderValues)}},{key:"clone",value:function(){var e=new n;return this.cloneTo(e),e}},{key:"shaderData",get:function(){return this._shaderValues}},{key:"alphaTestValue",get:function(){return this._shaderValues.getNumber(n.ALPHATESTVALUE)},set:function(e){this._shaderValues.setNumber(n.ALPHATESTVALUE,e)}},{key:"alphaTest",get:function(){return this._alphaTest},set:function(e){this._alphaTest=e,e?this._shaderValues.addDefine(n.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(n.SHADERDEFINE_ALPHATEST)}},{key:"_defineDatas",get:function(){return this._shaderValues._defineDatas}}],[{key:"load",value:function(e,r){t.Laya.loader.create(e,r,null,n.MATERIAL)}},{key:"__initDefine__",value:function(){n.SHADERDEFINE_ALPHATEST=U.getDefineByName("ALPHATEST")}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n,o=e,s=o.props,l=s.type,_=t.ClassUtils.getRegClass(l);if(!_)throw"_getSprite3DHierarchyInnerUrls 错误: "+e.type+" 不是类";switch(n=new _,o.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var u,c;for(var h in s)switch(h){case"vectors":var d=s[h];for(u=0,c=d.length;u<c;u++){var f=d[u],m=f.value;switch(m.length){case 2:n[f.name]=new r(m[0],m[1]);break;case 3:n[f.name]=new a(m[0],m[1],m[2]);break;case 4:n[f.name]=new i(m[0],m[1],m[2],m[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var E=s[h];for(u=0,c=E.length;u<c;u++){var v=E[u],T=v.path;T&&(n[v.name]=t.Loader.getRes(T))}break;case"defines":var p=s[h];for(u=0,c=p.length;u<c;u++){var g=U.getDefineByName(p[u]);n._shaderValues.addDefine(g)}break;case"renderStates":var y=s[h][0],S=n;S.blend=y.blend,S.cull=y.cull,S.depthTest=y.depthTest,S.depthWrite=y.depthWrite,S.blendSrc=y.srcBlend,S.blendDst=y.dstBlend;break;case"cull":n.cull=s[h];break;case"blend":n.blend=s[h];break;case"depthWrite":n.depthWrite=s[h];break;case"srcBlend":n.blendSrc=s[h];break;case"dstBlend":n.blendDst=s[h];break;default:n[h]=s[h]}break;default:throw new Error("BaseMaterial:unkonwn version.")}return n}}]),n}();Y.MATERIAL="MATERIAL",Y.RENDERQUEUE_OPAQUE=2e3,Y.RENDERQUEUE_ALPHATEST=2450,Y.RENDERQUEUE_TRANSPARENT=3e3,Y.ALPHATESTVALUE=U.propertyNameToID("u_AlphaTestValue"),Y.SHADERDEFINE_ALPHATEST=null;var j=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"load",value:function(e,n){t.Laya.loader.create(e,n,null,Y.MATERIAL)}},{key:"__initDefine__",value:function(){e.SHADERDEFINE_ALPHATEST=Y.SHADERDEFINE_ALPHATEST}}]),e}();j.MATERIAL="MATERIAL",j.RENDERQUEUE_OPAQUE=2e3,j.RENDERQUEUE_ALPHATEST=2450,j.RENDERQUEUE_TRANSPARENT=3e3,j.ALPHATESTVALUE=U.propertyNameToID("u_AlphaTestValue"),j.SHADERDEFINE_ALPHATEST=null;var Z=function e(){_classCallCheck(this,e)},q=function(){function e(){_classCallCheck(this,e),this.cull=e.CULL_BACK,this.blend=e.BLEND_DISABLE,this.srcBlend=e.BLENDPARAM_ONE,this.dstBlend=e.BLENDPARAM_ZERO,this.srcBlendRGB=e.BLENDPARAM_ONE,this.dstBlendRGB=e.BLENDPARAM_ZERO,this.srcBlendAlpha=e.BLENDPARAM_ONE,this.dstBlendAlpha=e.BLENDPARAM_ZERO,this.blendConstColor=new i(1,1,1,1),this.blendEquation=e.BLENDEQUATION_ADD,this.blendEquationRGB=e.BLENDEQUATION_ADD,this.blendEquationAlpha=e.BLENDEQUATION_ADD,this.depthTest=e.DEPTHTEST_LEQUAL,this.depthWrite=!0}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(t.blendConstColor),t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}}]),e}();q.CULL_NONE=0,q.CULL_FRONT=1,q.CULL_BACK=2,q.BLEND_DISABLE=0,q.BLEND_ENABLE_ALL=1,q.BLEND_ENABLE_SEPERATE=2,q.BLENDPARAM_ZERO=0,q.BLENDPARAM_ONE=1,q.BLENDPARAM_SRC_COLOR=768,q.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,q.BLENDPARAM_DST_COLOR=774,q.BLENDPARAM_ONE_MINUS_DST_COLOR=775,q.BLENDPARAM_SRC_ALPHA=770,q.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,q.BLENDPARAM_DST_ALPHA=772,q.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,q.BLENDPARAM_SRC_ALPHA_SATURATE=776,q.BLENDEQUATION_ADD=32774,q.BLENDEQUATION_SUBTRACT=32778,q.BLENDEQUATION_REVERSE_SUBTRACT=32779,q.DEPTHTEST_OFF=0,q.DEPTHTEST_NEVER=512,q.DEPTHTEST_LESS=513,q.DEPTHTEST_EQUAL=514,q.DEPTHTEST_LEQUAL=515,q.DEPTHTEST_GREATER=516,q.DEPTHTEST_NOTEQUAL=517,q.DEPTHTEST_GEQUAL=518,q.DEPTHTEST_ALWAYS=519;var Q=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));e._enableVertexColor=!1,e.setShaderName("BLINNPHONG"),e._albedoIntensity=1,e._albedoColor=new i(1,1,1,1);var n=e._shaderValues;return n.setVector(t.ALBEDOCOLOR,new i(1,1,1,1)),n.setVector(t.MATERIALSPECULAR,new i(1,1,1,1)),n.setNumber(t.SHININESS,.078125),n.setNumber(Y.ALPHATESTVALUE,.5),n.setVector(t.TILINGOFFSET,new i(1,1,0,0)),e._enableLighting=!0,e.renderMode=t.RENDERMODE_OPAQUE,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;n._enableLighting=this._enableLighting,n._albedoIntensity=this._albedoIntensity,n._enableVertexColor=this._enableVertexColor,this._albedoColor.cloneTo(n._albedoColor)}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_SpecColorR",get:function(){return this._shaderValues.getVector(t.MATERIALSPECULAR).x},set:function(e){this._shaderValues.getVector(t.MATERIALSPECULAR).x=e}},{key:"_SpecColorG",get:function(){return this._shaderValues.getVector(t.MATERIALSPECULAR).y},set:function(e){this._shaderValues.getVector(t.MATERIALSPECULAR).y=e}},{key:"_SpecColorB",get:function(){return this._shaderValues.getVector(t.MATERIALSPECULAR).z},set:function(e){this._shaderValues.getVector(t.MATERIALSPECULAR).z=e}},{key:"_SpecColorA",get:function(){return this._shaderValues.getVector(t.MATERIALSPECULAR).w},set:function(e){this._shaderValues.getVector(t.MATERIALSPECULAR).w=e}},{key:"_AlbedoIntensity",get:function(){return this._albedoIntensity},set:function(e){if(this._albedoIntensity!==e){var n=this._shaderValues.getVector(t.ALBEDOCOLOR);i.scale(this._albedoColor,e,n),this._albedoIntensity=e,this._shaderValues.setVector(t.ALBEDOCOLOR,n)}}},{key:"_Shininess",get:function(){return this._shaderValues.getNumber(t.SHININESS)},set:function(e){e=Math.max(0,Math.min(1,e)),this._shaderValues.setNumber(t.SHININESS,e)}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).x},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.x=e,this.tilingOffset=n}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).y},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.y=e,this.tilingOffset=n}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).z},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.z=e,this.tilingOffset=n}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).w},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.w=e,this.tilingOffset=n}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"renderMode",set:function(e){switch(e){case t.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Y.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS;break;case t.RENDERMODE_CUTOUT:this.renderQueue=Y.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS;break;case t.RENDERMODE_TRANSPARENT:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_BACK,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LESS;break;default:throw new Error("Material:renderMode value error.")}}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){this._enableVertexColor=e,e?this._shaderValues.addDefine(t.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(t.SHADERDEFINE_ENABLEVERTEXCOLOR)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(t.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(t.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(t.TILINGOFFSET,e)}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){var n=this._shaderValues.getVector(t.ALBEDOCOLOR);i.scale(e,this._albedoIntensity,n),this._albedoColor=e,this._shaderValues.setVector(t.ALBEDOCOLOR,n)}},{key:"albedoIntensity",get:function(){return this._albedoIntensity},set:function(e){this._AlbedoIntensity=e}},{key:"specularColorR",get:function(){return this._SpecColorR},set:function(e){this._SpecColorR=e}},{key:"specularColorG",get:function(){return this._SpecColorG},set:function(e){this._SpecColorG=e}},{key:"specularColorB",get:function(){return this._SpecColorB},set:function(e){this._SpecColorB=e}},{key:"specularColorA",get:function(){return this._SpecColorA},set:function(e){this._SpecColorA=e}},{key:"specularColor",get:function(){return this._shaderValues.getVector(t.MATERIALSPECULAR)},set:function(e){this._shaderValues.setVector(t.MATERIALSPECULAR,e)}},{key:"shininess",get:function(){return this._Shininess},set:function(e){this._Shininess=e}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(t.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(t.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(t.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(t.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_NORMALMAP):this._shaderValues.removeDefine(t.SHADERDEFINE_NORMALMAP),this._shaderValues.setTexture(t.NORMALTEXTURE,e)}},{key:"specularTexture",get:function(){return this._shaderValues.getTexture(t.SPECULARTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_SPECULARMAP):this._shaderValues.removeDefine(t.SHADERDEFINE_SPECULARMAP),this._shaderValues.setTexture(t.SPECULARTEXTURE,e)}},{key:"enableLighting",get:function(){return this._enableLighting},set:function(e){this._enableLighting!==e&&(e?(this._disablePublicDefineDatas.remove(Z.SHADERDEFINE_POINTLIGHT),this._disablePublicDefineDatas.remove(Z.SHADERDEFINE_SPOTLIGHT),this._disablePublicDefineDatas.remove(Z.SHADERDEFINE_DIRECTIONLIGHT)):(this._disablePublicDefineDatas.add(Z.SHADERDEFINE_POINTLIGHT),this._disablePublicDefineDatas.add(Z.SHADERDEFINE_SPOTLIGHT),this._disablePublicDefineDatas.add(Z.SHADERDEFINE_DIRECTIONLIGHT)),this._enableLighting=e)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(t.CULL)},set:function(e){this._shaderValues.setInt(t.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(t.BLEND)},set:function(e){this._shaderValues.setInt(t.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(t.BLEND_SRC)},set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(t.BLEND_DST)},set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_DIFFUSEMAP=U.getDefineByName("DIFFUSEMAP"),t.SHADERDEFINE_NORMALMAP=U.getDefineByName("NORMALMAP"),t.SHADERDEFINE_SPECULARMAP=U.getDefineByName("SPECULARMAP"),t.SHADERDEFINE_TILINGOFFSET=U.getDefineByName("TILINGOFFSET"),t.SHADERDEFINE_ENABLEVERTEXCOLOR=U.getDefineByName("ENABLEVERTEXCOLOR")}}]),t}();Q.RENDERMODE_OPAQUE=0,Q.RENDERMODE_CUTOUT=1,Q.RENDERMODE_TRANSPARENT=2,Q.ALBEDOTEXTURE=U.propertyNameToID("u_DiffuseTexture"),Q.NORMALTEXTURE=U.propertyNameToID("u_NormalTexture"),Q.SPECULARTEXTURE=U.propertyNameToID("u_SpecularTexture"),Q.ALBEDOCOLOR=U.propertyNameToID("u_DiffuseColor"),Q.MATERIALSPECULAR=U.propertyNameToID("u_MaterialSpecular"),Q.SHININESS=U.propertyNameToID("u_Shininess"),Q.TILINGOFFSET=U.propertyNameToID("u_TilingOffset"),Q.CULL=U.propertyNameToID("s_Cull"),Q.BLEND=U.propertyNameToID("s_Blend"),Q.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),Q.BLEND_DST=U.propertyNameToID("s_BlendDst"),Q.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),Q.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var K=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("Effect"),e._color=new i(1,1,1,1),e._shaderValues.setVector(t.TINTCOLOR,new i(1,1,1,1)),e.renderMode=t.RENDERMODE_ADDTIVE,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).x},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.x=e,this.tilingOffset=n}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).y},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.y=e,this.tilingOffset=n}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).z},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.z=e,this.tilingOffset=n}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).w},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.w=e,this.tilingOffset=n}},{key:"renderMode",set:function(e){switch(e){case t.RENDERMODE_ADDTIVE:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_NONE,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.addDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case t.RENDERMODE_ALPHABLENDED:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_NONE,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("MeshEffectMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(t.TINTCOLOR)},set:function(e){this._shaderValues.setVector(t.TINTCOLOR,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(t.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(t.MAINTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(t.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(t.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(t.TILINGOFFSET,e)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(t.CULL)},set:function(e){this._shaderValues.setInt(t.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(t.BLEND)},set:function(e){this._shaderValues.setInt(t.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(t.BLEND_SRC)},set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(t.BLEND_DST)},set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_MAINTEXTURE=U.getDefineByName("MAINTEXTURE"),t.SHADERDEFINE_TILINGOFFSET=U.getDefineByName("TILINGOFFSET"),t.SHADERDEFINE_ADDTIVEFOG=U.getDefineByName("ADDTIVEFOG")}}]),t}();K.RENDERMODE_ADDTIVE=0,K.RENDERMODE_ALPHABLENDED=1,K.MAINTEXTURE=U.propertyNameToID("u_AlbedoTexture"),K.TINTCOLOR=U.propertyNameToID("u_AlbedoColor"),K.TILINGOFFSET=U.propertyNameToID("u_TilingOffset"),K.CULL=U.propertyNameToID("s_Cull"),K.BLEND=U.propertyNameToID("s_Blend"),K.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),K.BLEND_DST=U.propertyNameToID("s_BlendDst"),K.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),K.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var J=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._enableLighting=!0,e.setShaderName("ExtendTerrain"),e.renderMode=t.RENDERMODE_OPAQUE,e}return _inherits(t,Y),_createClass(t,[{key:"_setDetailNum",value:function(e){switch(e){case 1:this._shaderValues.addDefine(t.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._shaderValues.addDefine(t.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._shaderValues.addDefine(t.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._shaderValues.addDefine(t.SHADERDEFINE_DETAIL_NUM4),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._shaderValues.addDefine(t.SHADERDEFINE_DETAIL_NUM5),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM1),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM2),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM3),this._shaderValues.removeDefine(t.SHADERDEFINE_DETAIL_NUM4)}}},{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"splatAlphaTexture",get:function(){return this._shaderValues.getTexture(t.SPLATALPHATEXTURE)},set:function(e){this._shaderValues.setTexture(t.SPLATALPHATEXTURE,e)}},{key:"diffuseTexture1",get:function(){return this._shaderValues.getTexture(t.DIFFUSETEXTURE1)},set:function(e){this._shaderValues.setTexture(t.DIFFUSETEXTURE1,e),this._setDetailNum(1)}},{key:"diffuseTexture2",get:function(){return this._shaderValues.getTexture(t.DIFFUSETEXTURE2)},set:function(e){this._shaderValues.setTexture(t.DIFFUSETEXTURE2,e),this._setDetailNum(2)}},{key:"diffuseTexture3",get:function(){return this._shaderValues.getTexture(t.DIFFUSETEXTURE3)},set:function(e){this._shaderValues.setTexture(t.DIFFUSETEXTURE3,e),this._setDetailNum(3)}},{key:"diffuseTexture4",get:function(){return this._shaderValues.getTexture(t.DIFFUSETEXTURE4)},set:function(e){this._shaderValues.setTexture(t.DIFFUSETEXTURE4,e),this._setDetailNum(4)}},{key:"diffuseTexture5",get:function(){return this._shaderValues.getTexture(t.DIFFUSETEXTURE5)},set:function(e){this._shaderValues.setTexture(t.DIFFUSETEXTURE5,e),this._setDetailNum(5)}},{key:"diffuseScaleOffset1",set:function(e){this._shaderValues.setVector(t.DIFFUSESCALEOFFSET1,e)}},{key:"diffuseScaleOffset2",set:function(e){this._shaderValues.setVector(t.DIFFUSESCALEOFFSET2,e)}},{key:"diffuseScaleOffset3",set:function(e){this._shaderValues.setVector(t.DIFFUSESCALEOFFSET3,e)}},{key:"diffuseScaleOffset4",set:function(e){this._shaderValues.setVector(t.DIFFUSESCALEOFFSET4,e)}},{key:"diffuseScaleOffset5",set:function(e){this._shaderValues.setVector(t.DIFFUSESCALEOFFSET5,e)}},{key:"enableLighting",get:function(){return this._enableLighting},set:function(e){this._enableLighting!==e&&(e?(this._disablePublicDefineDatas.remove(Z.SHADERDEFINE_POINTLIGHT),this._disablePublicDefineDatas.remove(Z.SHADERDEFINE_SPOTLIGHT),this._disablePublicDefineDatas.remove(Z.SHADERDEFINE_DIRECTIONLIGHT)):(this._disablePublicDefineDatas.add(Z.SHADERDEFINE_POINTLIGHT),this._disablePublicDefineDatas.add(Z.SHADERDEFINE_SPOTLIGHT),this._disablePublicDefineDatas.add(Z.SHADERDEFINE_DIRECTIONLIGHT)),this._enableLighting=e)}},{key:"renderMode",set:function(e){switch(e){case t.RENDERMODE_OPAQUE:this.renderQueue=Y.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS;break;case t.RENDERMODE_TRANSPARENT:this.renderQueue=Y.RENDERQUEUE_OPAQUE,this.depthWrite=!1,this.cull=q.CULL_BACK,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LEQUAL;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(t.CULL)},set:function(e){this._shaderValues.setInt(t.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(t.BLEND)},set:function(e){this._shaderValues.setInt(t.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(t.BLEND_SRC)},set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(t.BLEND_DST)},set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_DETAIL_NUM1=U.getDefineByName("ExtendTerrain_DETAIL_NUM1"),t.SHADERDEFINE_DETAIL_NUM2=U.getDefineByName("ExtendTerrain_DETAIL_NUM2"),t.SHADERDEFINE_DETAIL_NUM3=U.getDefineByName("ExtendTerrain_DETAIL_NUM3"),t.SHADERDEFINE_DETAIL_NUM4=U.getDefineByName("ExtendTerrain_DETAIL_NUM4"),t.SHADERDEFINE_DETAIL_NUM5=U.getDefineByName("ExtendTerrain_DETAIL_NUM5")}}]),t}();J.RENDERMODE_OPAQUE=1,J.RENDERMODE_TRANSPARENT=2,J.SPLATALPHATEXTURE=U.propertyNameToID("u_SplatAlphaTexture"),J.DIFFUSETEXTURE1=U.propertyNameToID("u_DiffuseTexture1"),J.DIFFUSETEXTURE2=U.propertyNameToID("u_DiffuseTexture2"),J.DIFFUSETEXTURE3=U.propertyNameToID("u_DiffuseTexture3"),J.DIFFUSETEXTURE4=U.propertyNameToID("u_DiffuseTexture4"),J.DIFFUSETEXTURE5=U.propertyNameToID("u_DiffuseTexture5"),J.DIFFUSESCALEOFFSET1=U.propertyNameToID("u_DiffuseScaleOffset1"),J.DIFFUSESCALEOFFSET2=U.propertyNameToID("u_DiffuseScaleOffset2"),J.DIFFUSESCALEOFFSET3=U.propertyNameToID("u_DiffuseScaleOffset3"),J.DIFFUSESCALEOFFSET4=U.propertyNameToID("u_DiffuseScaleOffset4"),J.DIFFUSESCALEOFFSET5=U.propertyNameToID("u_DiffuseScaleOffset5"),J.CULL=U.propertyNameToID("s_Cull"),J.BLEND=U.propertyNameToID("s_Blend"),J.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),J.BLEND_DST=U.propertyNameToID("s_BlendDst"),J.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),J.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var $=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("PBRSpecular"),e._albedoColor=new i(1,1,1,1),e._shaderValues.setVector(t.ALBEDOCOLOR,new i(1,1,1,1)),e._emissionColor=new i(0,0,0,0),e._shaderValues.setVector(t.EMISSIONCOLOR,new i(0,0,0,0)),e._specularColor=new i(.2,.2,.2,.2),e._shaderValues.setVector(t.SPECULARCOLOR,new i(.2,.2,.2,.2)),e._shaderValues.setNumber(t.SMOOTHNESS,.5),e._shaderValues.setNumber(t.SMOOTHNESSSCALE,1),e._shaderValues.setNumber(t.SMOOTHNESSSOURCE,0),e._shaderValues.setNumber(t.OCCLUSIONSTRENGTH,1),e._shaderValues.setNumber(t.NORMALSCALE,1),e._shaderValues.setNumber(t.PARALLAXSCALE,.001),e._shaderValues.setBool(t.ENABLEEMISSION,!1),e._shaderValues.setNumber(Y.ALPHATESTVALUE,.5),e.renderMode=t.RENDERMODE_OPAQUE,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;this._albedoColor.cloneTo(n._albedoColor),this._specularColor.cloneTo(n._specularColor),this._emissionColor.cloneTo(n._emissionColor)}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_SpecColorR",get:function(){return this._specularColor.x},set:function(e){this._specularColor.x=e,this.specularColor=this._specularColor}},{key:"_SpecColorG",get:function(){return this._specularColor.y},set:function(e){this._specularColor.y=e,this.specularColor=this._specularColor}},{key:"_SpecColorB",get:function(){return this._specularColor.z},set:function(e){this._specularColor.z=e,this.specularColor=this._specularColor}},{key:"_SpecColorA",get:function(){return this._specularColor.w},set:function(e){this._specularColor.w=e,this.specularColor=this._specularColor}},{key:"_Glossiness",get:function(){return this._shaderValues.getNumber(t.SMOOTHNESS)},set:function(e){this._shaderValues.setNumber(t.SMOOTHNESS,e)}},{key:"_GlossMapScale",get:function(){return this._shaderValues.getNumber(t.SMOOTHNESSSCALE)},set:function(e){this._shaderValues.setNumber(t.SMOOTHNESSSCALE,e)}},{key:"_BumpScale",get:function(){return this._shaderValues.getNumber(t.NORMALSCALE)},set:function(e){this._shaderValues.setNumber(t.NORMALSCALE,e)}},{key:"_Parallax",get:function(){return this._shaderValues.getNumber(t.PARALLAXSCALE)},set:function(e){this._shaderValues.setNumber(t.PARALLAXSCALE,e)}},{key:"_OcclusionStrength",get:function(){return this._shaderValues.getNumber(t.OCCLUSIONSTRENGTH)},set:function(e){this._shaderValues.setNumber(t.OCCLUSIONSTRENGTH,e)}},{key:"_EmissionColorR",get:function(){return this._emissionColor.x},set:function(e){this._emissionColor.x=e,this.emissionColor=this._emissionColor}},{key:"_EmissionColorG",get:function(){return this._emissionColor.y},set:function(e){this._emissionColor.y=e,this.emissionColor=this._emissionColor}},{key:"_EmissionColorB",get:function(){return this._emissionColor.z},set:function(e){this._emissionColor.z=e,this.emissionColor=this._emissionColor}},{key:"_EmissionColorA",get:function(){return this._emissionColor.w},set:function(e){this._emissionColor.w=e,this.emissionColor=this._emissionColor}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).x},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.x=e,this.tilingOffset=n}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).y},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.y=e,this.tilingOffset=n}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).z},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.z=e,this.tilingOffset=n}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).w},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.w=e,this.tilingOffset=n}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){this._albedoColor=e,this._shaderValues.setVector(t.ALBEDOCOLOR,e)}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(t.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(t.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(t.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(t.NORMALTEXTURE,e)}},{key:"normalTextureScale",get:function(){return this._BumpScale},set:function(e){this._BumpScale=e}},{key:"parallaxTexture",get:function(){return this._shaderValues.getTexture(t.PARALLAXTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_PARALLAXTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(t.PARALLAXTEXTURE,e)}},{key:"parallaxTextureScale",get:function(){return this._Parallax},set:function(e){this._Parallax=Math.max(.005,Math.min(.08,e))}},{key:"occlusionTexture",get:function(){return this._shaderValues.getTexture(t.OCCLUSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_OCCLUSIONTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(t.OCCLUSIONTEXTURE,e)}},{key:"occlusionTextureStrength",get:function(){return this._OcclusionStrength},set:function(e){this._OcclusionStrength=Math.max(0,Math.min(1,e))}},{key:"specularTexture",get:function(){return this._shaderValues.getTexture(t.SPECULARTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_SPECULARTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_SPECULARTEXTURE),this._shaderValues.setTexture(t.SPECULARTEXTURE,e)}},{key:"specularColorR",get:function(){return this._SpecColorR},set:function(e){this._SpecColorR=e}},{key:"specularColorG",get:function(){return this._SpecColorG},set:function(e){this._SpecColorG=e}},{key:"specularColorB",get:function(){return this._SpecColorB},set:function(e){this._SpecColorB=e}},{key:"specularColorA",get:function(){return this._SpecColorA},set:function(e){this._SpecColorA=e}},{key:"specularColor",get:function(){return this._shaderValues.getVector(t.SPECULARCOLOR)},set:function(e){this._shaderValues.setVector(t.SPECULARCOLOR,e)}},{key:"smoothness",get:function(){return this._Glossiness},set:function(e){this._Glossiness=Math.max(0,Math.min(1,e))}},{key:"smoothnessTextureScale",get:function(){return this._GlossMapScale},set:function(e){this._GlossMapScale=Math.max(0,Math.min(1,e))}},{key:"smoothnessSource",get:function(){return this._shaderValues.getInt(t.SMOOTHNESSSOURCE)},set:function(e){e?(this._shaderValues.addDefine(t.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(t.SMOOTHNESSSOURCE,1)):(this._shaderValues.removeDefine(t.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(t.SMOOTHNESSSOURCE,0))}},{key:"enableEmission",get:function(){return this._shaderValues.getBool(t.ENABLEEMISSION)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_EMISSION):this._shaderValues.removeDefine(t.SHADERDEFINE_EMISSION),this._shaderValues.setBool(t.ENABLEEMISSION,e)}},{key:"emissionColor",get:function(){return this._shaderValues.getVector(t.EMISSIONCOLOR)},set:function(e){this._shaderValues.setVector(t.EMISSIONCOLOR,e)}},{key:"emissionTexture",get:function(){return this._shaderValues.getTexture(t.EMISSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_EMISSIONTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(t.EMISSIONTEXTURE,e)}},{key:"enableReflection",get:function(){return this._shaderValues.getBool(t.ENABLEREFLECT)},set:function(e){this._shaderValues.setBool(t.ENABLEREFLECT,!0),e?this._disablePublicDefineDatas.remove(Z.SHADERDEFINE_REFLECTMAP):this._disablePublicDefineDatas.add(Z.SHADERDEFINE_REFLECTMAP)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(t.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(t.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(t.TILINGOFFSET,e)}},{key:"renderMode",set:function(e){switch(e){case t.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Y.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_ALPHAPREMULTIPLY);break;case t.RENDERMODE_CUTOUT:this.renderQueue=Y.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_ALPHAPREMULTIPLY);break;case t.RENDERMODE_FADE:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_BACK,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_ALPHAPREMULTIPLY);break;case t.RENDERMODE_TRANSPARENT:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_BACK,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_ONE,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.addDefine(t.SHADERDEFINE_ALPHAPREMULTIPLY);break;default:throw new Error("PBRSpecularMaterial : renderMode value error.")}}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(t.CULL)},set:function(e){this._shaderValues.setInt(t.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(t.BLEND)},set:function(e){this._shaderValues.setInt(t.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(t.BLEND_SRC)},set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(t.BLEND_DST)},set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_ALBEDOTEXTURE=U.getDefineByName("ALBEDOTEXTURE"),t.SHADERDEFINE_SPECULARTEXTURE=U.getDefineByName("SPECULARTEXTURE"),t.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=U.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA"),t.SHADERDEFINE_NORMALTEXTURE=U.getDefineByName("NORMALTEXTURE"),t.SHADERDEFINE_PARALLAXTEXTURE=U.getDefineByName("PARALLAXTEXTURE"),t.SHADERDEFINE_OCCLUSIONTEXTURE=U.getDefineByName("OCCLUSIONTEXTURE"),t.SHADERDEFINE_EMISSION=U.getDefineByName("EMISSION"),t.SHADERDEFINE_EMISSIONTEXTURE=U.getDefineByName("EMISSIONTEXTURE"),t.SHADERDEFINE_TILINGOFFSET=U.getDefineByName("TILINGOFFSET"),t.SHADERDEFINE_ALPHAPREMULTIPLY=U.getDefineByName("ALPHAPREMULTIPLY")}}]),t}();$.SmoothnessSource_SpecularTexture_Alpha=0,$.SmoothnessSource_AlbedoTexture_Alpha=1,$.RENDERMODE_OPAQUE=0,$.RENDERMODE_CUTOUT=1,$.RENDERMODE_FADE=2,$.RENDERMODE_TRANSPARENT=3,$.ALBEDOTEXTURE=U.propertyNameToID("u_AlbedoTexture"),$.SPECULARTEXTURE=U.propertyNameToID("u_SpecularTexture"),$.NORMALTEXTURE=U.propertyNameToID("u_NormalTexture"),$.PARALLAXTEXTURE=U.propertyNameToID("u_ParallaxTexture"),$.OCCLUSIONTEXTURE=U.propertyNameToID("u_OcclusionTexture"),$.EMISSIONTEXTURE=U.propertyNameToID("u_EmissionTexture"),$.ALBEDOCOLOR=U.propertyNameToID("u_AlbedoColor"),$.SPECULARCOLOR=U.propertyNameToID("u_SpecularColor"),$.EMISSIONCOLOR=U.propertyNameToID("u_EmissionColor"),$.SMOOTHNESS=U.propertyNameToID("u_smoothness"),$.SMOOTHNESSSCALE=U.propertyNameToID("u_smoothnessScale"),$.SMOOTHNESSSOURCE=-1,$.OCCLUSIONSTRENGTH=U.propertyNameToID("u_occlusionStrength"),$.NORMALSCALE=U.propertyNameToID("u_normalScale"),$.PARALLAXSCALE=U.propertyNameToID("u_parallaxScale"),$.ENABLEEMISSION=-1,$.ENABLEREFLECT=-1,$.TILINGOFFSET=U.propertyNameToID("u_TilingOffset"),$.CULL=U.propertyNameToID("s_Cull"),$.BLEND=U.propertyNameToID("s_Blend"),$.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),$.BLEND_DST=U.propertyNameToID("s_BlendDst"),$.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),$.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var ee=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("PBRStandard"),e._albedoColor=new i(1,1,1,1),e._shaderValues.setVector(t.ALBEDOCOLOR,new i(1,1,1,1)),e._emissionColor=new i(0,0,0,0),e._shaderValues.setVector(t.EMISSIONCOLOR,new i(0,0,0,0)),e._shaderValues.setNumber(t.METALLIC,0),e._shaderValues.setNumber(t.SMOOTHNESS,.5),e._shaderValues.setNumber(t.SMOOTHNESSSCALE,1),e._shaderValues.setNumber(t.SMOOTHNESSSOURCE,0),e._shaderValues.setNumber(t.OCCLUSIONSTRENGTH,1),e._shaderValues.setNumber(t.NORMALSCALE,1),e._shaderValues.setNumber(t.PARALLAXSCALE,.001),e._shaderValues.setBool(t.ENABLEEMISSION,!1),e._shaderValues.setBool(t.ENABLEREFLECT,!0),e._shaderValues.setNumber(Y.ALPHATESTVALUE,.5),e._disablePublicDefineDatas.remove(Z.SHADERDEFINE_REFLECTMAP),e.renderMode=t.RENDERMODE_OPAQUE,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;this._albedoColor.cloneTo(n._albedoColor),this._emissionColor.cloneTo(n._emissionColor)}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_Metallic",get:function(){return this._shaderValues.getNumber(t.METALLIC)},set:function(e){this._shaderValues.setNumber(t.METALLIC,e)}},{key:"_Glossiness",get:function(){return this._shaderValues.getNumber(t.SMOOTHNESS)},set:function(e){this._shaderValues.setNumber(t.SMOOTHNESS,e)}},{key:"_GlossMapScale",get:function(){return this._shaderValues.getNumber(t.SMOOTHNESSSCALE)},set:function(e){this._shaderValues.setNumber(t.SMOOTHNESSSCALE,e)}},{key:"_BumpScale",get:function(){return this._shaderValues.getNumber(t.NORMALSCALE)},set:function(e){this._shaderValues.setNumber(t.NORMALSCALE,e)}},{key:"_Parallax",get:function(){return this._shaderValues.getNumber(t.PARALLAXSCALE)},set:function(e){this._shaderValues.setNumber(t.PARALLAXSCALE,e)}},{key:"_OcclusionStrength",get:function(){return this._shaderValues.getNumber(t.OCCLUSIONSTRENGTH)},set:function(e){this._shaderValues.setNumber(t.OCCLUSIONSTRENGTH,e)}},{key:"_EmissionColorR",get:function(){return this._emissionColor.x},set:function(e){this._emissionColor.x=e,this.emissionColor=this._emissionColor}},{key:"_EmissionColorG",get:function(){return this._emissionColor.y},set:function(e){this._emissionColor.y=e,this.emissionColor=this._emissionColor}},{key:"_EmissionColorB",get:function(){return this._emissionColor.z},set:function(e){this._emissionColor.z=e,this.emissionColor=this._emissionColor}},{key:"_EmissionColorA",get:function(){return this._emissionColor.w},set:function(e){this._emissionColor.w=e,this.emissionColor=this._emissionColor}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).x},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.x=e,this.tilingOffset=n}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).y},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.y=e,this.tilingOffset=n}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).z},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.z=e,this.tilingOffset=n}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).w},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.w=e,this.tilingOffset=n}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){this._albedoColor=e,this._shaderValues.setVector(t.ALBEDOCOLOR,e)}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(t.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(t.ALBEDOTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(t.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(t.NORMALTEXTURE,e)}},{key:"normalTextureScale",get:function(){return this._BumpScale},set:function(e){this._BumpScale=e}},{key:"parallaxTexture",get:function(){return this._shaderValues.getTexture(t.PARALLAXTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_PARALLAXTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(t.PARALLAXTEXTURE,e)}},{key:"parallaxTextureScale",get:function(){return this._Parallax},set:function(e){this._Parallax=Math.max(.005,Math.min(.08,e))}},{key:"occlusionTexture",get:function(){return this._shaderValues.getTexture(t.OCCLUSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_OCCLUSIONTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(t.OCCLUSIONTEXTURE,e)}},{key:"occlusionTextureStrength",get:function(){return this._OcclusionStrength},set:function(e){this._OcclusionStrength=Math.max(0,Math.min(1,e))}},{key:"metallicGlossTexture",get:function(){return this._shaderValues.getTexture(t.METALLICGLOSSTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_METALLICGLOSSTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_METALLICGLOSSTEXTURE),this._shaderValues.setTexture(t.METALLICGLOSSTEXTURE,e)}},{key:"metallic",get:function(){return this._Metallic},set:function(e){this._Metallic=Math.max(0,Math.min(1,e))}},{key:"smoothness",get:function(){return this._Glossiness},set:function(e){this._Glossiness=Math.max(0,Math.min(1,e))}},{key:"smoothnessTextureScale",get:function(){return this._GlossMapScale},set:function(e){this._GlossMapScale=Math.max(0,Math.min(1,e))}},{key:"smoothnessSource",get:function(){return this._shaderValues.getInt(t.SMOOTHNESSSOURCE)},set:function(e){e?(this._shaderValues.addDefine(t.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(t.SMOOTHNESSSOURCE,1)):(this._shaderValues.removeDefine(t.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(t.SMOOTHNESSSOURCE,0))}},{key:"enableEmission",get:function(){return this._shaderValues.getBool(t.ENABLEEMISSION)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_EMISSION):this._shaderValues.removeDefine(t.SHADERDEFINE_EMISSION),this._shaderValues.setBool(t.ENABLEEMISSION,e)}},{key:"emissionColorR",get:function(){return this._EmissionColorR},set:function(e){this._EmissionColorR=e}},{key:"emissionColorG",get:function(){return this._EmissionColorG},set:function(e){this._EmissionColorG=e}},{key:"emissionColorB",get:function(){return this._EmissionColorB},set:function(e){this._EmissionColorB=e}},{key:"emissionColorA",get:function(){return this._EmissionColorA},set:function(e){this._EmissionColorA=e}},{key:"emissionColor",get:function(){return this._shaderValues.getVector(t.EMISSIONCOLOR)},set:function(e){this._shaderValues.setVector(t.EMISSIONCOLOR,e)}},{key:"emissionTexture",get:function(){return this._shaderValues.getTexture(t.EMISSIONTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_EMISSIONTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(t.EMISSIONTEXTURE,e)}},{key:"enableReflection",get:function(){return this._shaderValues.getBool(t.ENABLEREFLECT)},set:function(e){this._shaderValues.setBool(t.ENABLEREFLECT,!0),e?this._disablePublicDefineDatas.remove(Z.SHADERDEFINE_REFLECTMAP):this._disablePublicDefineDatas.add(Z.SHADERDEFINE_REFLECTMAP)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(t.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(t.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(t.TILINGOFFSET,e)}},{key:"renderMode",set:function(e){switch(e){case t.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Y.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_ALPHAPREMULTIPLY);break;case t.RENDERMODE_CUTOUT:this.renderQueue=Y.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_ALPHAPREMULTIPLY);break;case t.RENDERMODE_FADE:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_BACK,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_ALPHAPREMULTIPLY);break;case t.RENDERMODE_TRANSPARENT:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_BACK,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_ONE,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.addDefine(t.SHADERDEFINE_ALPHAPREMULTIPLY);break;default:throw new Error("PBRSpecularMaterial : renderMode value error.")}}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(t.CULL)},set:function(e){this._shaderValues.setInt(t.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(t.BLEND)},set:function(e){this._shaderValues.setInt(t.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(t.BLEND_SRC)},set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(t.BLEND_DST)},set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_ALBEDOTEXTURE=U.getDefineByName("ALBEDOTEXTURE"),t.SHADERDEFINE_METALLICGLOSSTEXTURE=U.getDefineByName("METALLICGLOSSTEXTURE"),t.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=U.getDefineByName("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA"),t.SHADERDEFINE_NORMALTEXTURE=U.getDefineByName("NORMALTEXTURE"),t.SHADERDEFINE_PARALLAXTEXTURE=U.getDefineByName("PARALLAXTEXTURE"),t.SHADERDEFINE_OCCLUSIONTEXTURE=U.getDefineByName("OCCLUSIONTEXTURE"),t.SHADERDEFINE_EMISSION=U.getDefineByName("EMISSION"),t.SHADERDEFINE_EMISSIONTEXTURE=U.getDefineByName("EMISSIONTEXTURE"),t.SHADERDEFINE_REFLECTMAP=U.getDefineByName("REFLECTMAP"),t.SHADERDEFINE_TILINGOFFSET=U.getDefineByName("TILINGOFFSET"),t.SHADERDEFINE_ALPHAPREMULTIPLY=U.getDefineByName("ALPHAPREMULTIPLY")}}]),t}();ee.SmoothnessSource_MetallicGlossTexture_Alpha=0,ee.SmoothnessSource_AlbedoTexture_Alpha=1,ee.RENDERMODE_OPAQUE=0,ee.RENDERMODE_CUTOUT=1,ee.RENDERMODE_FADE=2,ee.RENDERMODE_TRANSPARENT=3,ee.ALBEDOTEXTURE=U.propertyNameToID("u_AlbedoTexture"),ee.METALLICGLOSSTEXTURE=U.propertyNameToID("u_MetallicGlossTexture"),ee.NORMALTEXTURE=U.propertyNameToID("u_NormalTexture"),ee.PARALLAXTEXTURE=U.propertyNameToID("u_ParallaxTexture"),ee.OCCLUSIONTEXTURE=U.propertyNameToID("u_OcclusionTexture"),ee.EMISSIONTEXTURE=U.propertyNameToID("u_EmissionTexture"),ee.ALBEDOCOLOR=U.propertyNameToID("u_AlbedoColor"),ee.EMISSIONCOLOR=U.propertyNameToID("u_EmissionColor"),ee.METALLIC=U.propertyNameToID("u_metallic"),ee.SMOOTHNESS=U.propertyNameToID("u_smoothness"),ee.SMOOTHNESSSCALE=U.propertyNameToID("u_smoothnessScale"),ee.SMOOTHNESSSOURCE=-1,ee.OCCLUSIONSTRENGTH=U.propertyNameToID("u_occlusionStrength"),ee.NORMALSCALE=U.propertyNameToID("u_normalScale"),ee.PARALLAXSCALE=U.propertyNameToID("u_parallaxScale"),ee.ENABLEEMISSION=-1,ee.ENABLEREFLECT=-1,ee.TILINGOFFSET=U.propertyNameToID("u_TilingOffset"),ee.CULL=U.propertyNameToID("s_Cull"),ee.BLEND=U.propertyNameToID("s_Blend"),ee.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),ee.BLEND_DST=U.propertyNameToID("s_BlendDst"),ee.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),ee.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var te=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("SkyBox"),e.tintColor=new i(.5,.5,.5,.5),e.exposure=1,e.rotation=0,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"tintColor",get:function(){return this._shaderValues.getVector(t.TINTCOLOR)},set:function(e){this._shaderValues.setVector(t.TINTCOLOR,e)}},{key:"exposure",get:function(){return this._shaderValues.getNumber(t.EXPOSURE)},set:function(e){this._shaderValues.setNumber(t.EXPOSURE,e)}},{key:"rotation",get:function(){return this._shaderValues.getNumber(t.ROTATION)},set:function(e){this._shaderValues.setNumber(t.ROTATION,e)}},{key:"textureCube",get:function(){return this._shaderValues.getTexture(t.TEXTURECUBE)},set:function(e){this._shaderValues.setTexture(t.TEXTURECUBE,e)}}],[{key:"__initDefine__",value:function(){}}]),t}();te.TINTCOLOR=U.propertyNameToID("u_TintColor"),te.EXPOSURE=U.propertyNameToID("u_Exposure"),te.ROTATION=U.propertyNameToID("u_Rotation"),te.TEXTURECUBE=U.propertyNameToID("u_CubeTexture");var ne=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("SkyBoxProcedural"),e.sunDisk=t.SUN_HIGH_QUALITY,e.sunSize=.04,e.sunSizeConvergence=5,e.atmosphereThickness=1,e.skyTint=new i(.5,.5,.5,1),e.groundTint=new i(.369,.349,.341,1),e.exposure=1.3,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"sunDisk",get:function(){return this._sunDisk},set:function(e){switch(e){case t.SUN_HIGH_QUALITY:this._shaderValues.removeDefine(t.SHADERDEFINE_SUN_SIMPLE),this._shaderValues.addDefine(t.SHADERDEFINE_SUN_HIGH_QUALITY);break;case t.SUN_SIMPLE:this._shaderValues.removeDefine(t.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.addDefine(t.SHADERDEFINE_SUN_SIMPLE);break;case t.SUN_NODE:this._shaderValues.removeDefine(t.SHADERDEFINE_SUN_HIGH_QUALITY),this._shaderValues.removeDefine(t.SHADERDEFINE_SUN_SIMPLE);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=e}},{key:"sunSize",get:function(){return this._shaderValues.getNumber(t.SUNSIZE)},set:function(e){e=Math.min(Math.max(0,e),1),this._shaderValues.setNumber(t.SUNSIZE,e)}},{key:"sunSizeConvergence",get:function(){return this._shaderValues.getNumber(t.SUNSIZECONVERGENCE)},set:function(e){e=Math.min(Math.max(0,e),20),this._shaderValues.setNumber(t.SUNSIZECONVERGENCE,e)}},{key:"atmosphereThickness",get:function(){return this._shaderValues.getNumber(t.ATMOSPHERETHICKNESS)},set:function(e){e=Math.min(Math.max(0,e),5),this._shaderValues.setNumber(t.ATMOSPHERETHICKNESS,e)}},{key:"skyTint",get:function(){return this._shaderValues.getVector(t.SKYTINT)},set:function(e){this._shaderValues.setVector(t.SKYTINT,e)}},{key:"groundTint",get:function(){return this._shaderValues.getVector(t.GROUNDTINT)},set:function(e){this._shaderValues.setVector(t.GROUNDTINT,e)}},{key:"exposure",get:function(){return this._shaderValues.getNumber(t.EXPOSURE)},set:function(e){e=Math.min(Math.max(0,e),8),this._shaderValues.setNumber(t.EXPOSURE,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_SUN_HIGH_QUALITY=U.getDefineByName("SUN_HIGH_QUALITY"),t.SHADERDEFINE_SUN_SIMPLE=U.getDefineByName("SUN_SIMPLE")}}]),t}();ne.SUN_NODE=0,ne.SUN_SIMPLE=1,ne.SUN_HIGH_QUALITY=2,ne.SUNSIZE=U.propertyNameToID("u_SunSize"),ne.SUNSIZECONVERGENCE=U.propertyNameToID("u_SunSizeConvergence"),ne.ATMOSPHERETHICKNESS=U.propertyNameToID("u_AtmosphereThickness"),ne.SKYTINT=U.propertyNameToID("u_SkyTint"),ne.GROUNDTINT=U.propertyNameToID("u_GroundTint"),ne.EXPOSURE=U.propertyNameToID("u_Exposure");var re=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._albedoColor=new i(1,1,1,1),e._albedoIntensity=1,e._enableVertexColor=!1,e.setShaderName("Unlit"),e._shaderValues.setVector(t.ALBEDOCOLOR,new i(1,1,1,1)),e.renderMode=t.RENDERMODE_OPAQUE,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"_ColorR",get:function(){return this._albedoColor.x},set:function(e){this._albedoColor.x=e,this.albedoColor=this._albedoColor}},{key:"_ColorG",get:function(){return this._albedoColor.y},set:function(e){this._albedoColor.y=e,this.albedoColor=this._albedoColor}},{key:"_ColorB",get:function(){return this._albedoColor.z},set:function(e){this._albedoColor.z=e,this.albedoColor=this._albedoColor}},{key:"_ColorA",get:function(){return this._albedoColor.w},set:function(e){this._albedoColor.w=e,this.albedoColor=this._albedoColor}},{key:"_AlbedoIntensity",get:function(){return this._albedoIntensity},set:function(e){if(this._albedoIntensity!==e){var n=this._shaderValues.getVector(t.ALBEDOCOLOR);i.scale(this._albedoColor,e,n),this._albedoIntensity=e,this._shaderValues.setVector(t.ALBEDOCOLOR,n)}}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).x},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.x=e,this.tilingOffset=n}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).y},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.y=e,this.tilingOffset=n}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).z},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.z=e,this.tilingOffset=n}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).w},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.w=e,this.tilingOffset=n}},{key:"_Cutoff",get:function(){return this.alphaTestValue},set:function(e){this.alphaTestValue=e}},{key:"albedoColorR",get:function(){return this._ColorR},set:function(e){this._ColorR=e}},{key:"albedoColorG",get:function(){return this._ColorG},set:function(e){this._ColorG=e}},{key:"albedoColorB",get:function(){return this._ColorB},set:function(e){this._ColorB=e}},{key:"albedoColorA",get:function(){return this._ColorA},set:function(e){this._ColorA=e}},{key:"albedoColor",get:function(){return this._albedoColor},set:function(e){var n=this._shaderValues.getVector(t.ALBEDOCOLOR);i.scale(e,this._albedoIntensity,n),this._albedoColor=e,this._shaderValues.setVector(t.ALBEDOCOLOR,n)}},{key:"albedoIntensity",get:function(){return this._albedoIntensity},set:function(e){this._AlbedoIntensity=e}},{key:"albedoTexture",get:function(){return this._shaderValues.getTexture(t.ALBEDOTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_ALBEDOTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(t.ALBEDOTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(t.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(t.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(t.TILINGOFFSET,e)}},{key:"enableVertexColor",get:function(){return this._enableVertexColor},set:function(e){this._enableVertexColor=e,e?this._shaderValues.addDefine(t.SHADERDEFINE_ENABLEVERTEXCOLOR):this._shaderValues.removeDefine(t.SHADERDEFINE_ENABLEVERTEXCOLOR)}},{key:"renderMode",set:function(e){switch(e){case t.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Y.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS;break;case t.RENDERMODE_CUTOUT:this.renderQueue=Y.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.cull=q.CULL_BACK,this.blend=q.BLEND_DISABLE,this.depthTest=q.DEPTHTEST_LESS;break;case t.RENDERMODE_TRANSPARENT:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_BACK,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LESS;break;default:throw new Error("UnlitMaterial : renderMode value error.")}}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(t.CULL)},set:function(e){this._shaderValues.setInt(t.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(t.BLEND)},set:function(e){this._shaderValues.setInt(t.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(t.BLEND_SRC)},set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(t.BLEND_DST)},set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_ALBEDOTEXTURE=U.getDefineByName("ALBEDOTEXTURE"),t.SHADERDEFINE_TILINGOFFSET=U.getDefineByName("TILINGOFFSET"),t.SHADERDEFINE_ENABLEVERTEXCOLOR=U.getDefineByName("ENABLEVERTEXCOLOR")}}]),t}();re.RENDERMODE_OPAQUE=0,re.RENDERMODE_CUTOUT=1,re.RENDERMODE_TRANSPARENT=2,re.RENDERMODE_ADDTIVE=3,re.ALBEDOTEXTURE=U.propertyNameToID("u_AlbedoTexture"),re.ALBEDOCOLOR=U.propertyNameToID("u_AlbedoColor"),re.TILINGOFFSET=U.propertyNameToID("u_TilingOffset"),re.CULL=U.propertyNameToID("s_Cull"),re.BLEND=U.propertyNameToID("s_Blend"),re.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),re.BLEND_DST=U.propertyNameToID("s_BlendDst"),re.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),re.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var ie=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("WaterPrimary"),e._shaderValues.setVector(t.HORIZONCOLOR,new i(.172,.463,.435,0)),e._shaderValues.setNumber(t.WAVESCALE,.15),e._shaderValues.setVector(t.WAVESPEED,new i(19,9,-16,-7)),e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"horizonColor",get:function(){return this._shaderValues.getVector(t.HORIZONCOLOR)},set:function(e){this._shaderValues.setVector(t.HORIZONCOLOR,e)}},{key:"mainTexture",get:function(){return this._shaderValues.getTexture(t.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(t.MAINTEXTURE,e)}},{key:"normalTexture",get:function(){return this._shaderValues.getTexture(t.NORMALTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_NORMALTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(t.NORMALTEXTURE,e)}},{key:"waveScale",get:function(){return this._shaderValues.getNumber(t.WAVESCALE)},set:function(e){this._shaderValues.setNumber(t.WAVESCALE,e)}},{key:"waveSpeed",get:function(){return this._shaderValues.getVector(t.WAVESPEED)},set:function(e){this._shaderValues.setVector(t.WAVESPEED,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_MAINTEXTURE=U.getDefineByName("MAINTEXTURE"),t.SHADERDEFINE_NORMALTEXTURE=U.getDefineByName("NORMALTEXTURE")}}]),t}();ie.HORIZONCOLOR=U.propertyNameToID("u_HorizonColor"),ie.MAINTEXTURE=U.propertyNameToID("u_MainTexture"),ie.NORMALTEXTURE=U.propertyNameToID("u_NormalTexture"),ie.WAVESCALE=U.propertyNameToID("u_WaveScale"),ie.WAVESPEED=U.propertyNameToID("u_WaveSpeed");var ae=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;_classCallCheck(this,e),this.r=t,this.g=n,this.b=r,this.a=i}return _createClass(e,[{key:"toLinear",value:function(t){t.r=e.gammaToLinearSpace(this.r),t.g=e.gammaToLinearSpace(this.g),t.b=e.gammaToLinearSpace(this.b)}},{key:"toGamma",value:function(t){t.r=e.linearToGammaSpace(this.r),t.g=e.linearToGammaSpace(this.g),t.b=e.linearToGammaSpace(this.b)}},{key:"cloneTo",value:function(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"forNativeElement",value:function(){}}],[{key:"gammaToLinearSpace",value:function(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}},{key:"linearToGammaSpace",value:function(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}}]),e}();ae.RED=new ae(1,0,0,1),ae.GREEN=new ae(0,1,0,1),ae.BLUE=new ae(0,0,1,1),ae.CYAN=new ae(0,1,1,1),ae.YELLOW=new ae(1,.92,.016,1),ae.MAGENTA=new ae(1,0,1,1),ae.GRAY=new ae(.5,.5,.5,1),ae.WHITE=new ae(1,1,1,1),ae.BLACK=new ae(0,0,0,1);var oe=function(){function e(){_classCallCheck(this,e),this._batchRenderElementPool=[]}return _createClass(e,[{key:"_clear",value:function(){this._batchRenderElementPoolIndex=0}},{key:"_getBatchRenderElementFromPool",value:function(){throw"StaticBatch:must override this function."}},{key:"dispose",value:function(){}}],[{key:"_registerManager",value:function(t){e._managers.push(t)}}]),e}();oe._managers=[];var se=function(e){function r(e){_classCallCheck(this,r);var t=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return t._localPosition=new a(0,0,0),t._localRotation=new d(0,0,0,1),t._localScale=new a(1,1,1),t._localRotationEuler=new a(0,0,0),t._localMatrix=new T,t._position=new a(0,0,0),t._rotation=new d(0,0,0,1),t._scale=new a(1,1,1),t._rotationEuler=new a(0,0,0),t._worldMatrix=new T,t._children=null,t._parent=null,t._dummy=null,t._transformFlag=0,t._owner=e,t._children=[],t._setTransformFlag(r.TRANSFORM_LOCALQUATERNION|r.TRANSFORM_LOCALEULER|r.TRANSFORM_LOCALMATRIX,!1),t._setTransformFlag(r.TRANSFORM_WORLDPOSITION|r.TRANSFORM_WORLDQUATERNION|r.TRANSFORM_WORLDEULER|r.TRANSFORM_WORLDSCALE|r.TRANSFORM_WORLDMATRIX,!0),t}return _inherits(r,t.EventDispatcher),_createClass(r,[{key:"_getScaleMatrix",value:function(){var e=r._tempQuaternion0,t=r._tempMatrix3x30,n=r._tempMatrix3x31,i=r._tempMatrix3x32;return h.createFromMatrix4x4(this.worldMatrix,n),this.rotation.invert(e),h.createRotationQuaternion(e,t),h.multiply(t,n,i),i}},{key:"_setTransformFlag",value:function(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}},{key:"_getTransformFlag",value:function(e){return 0!=(this._transformFlag&e)}},{key:"_setParent",value:function(e){if(this._parent!==e){if(this._parent){var t=this._parent._children,n=t.indexOf(this);t.splice(n,1)}e&&(e._children.push(this),e&&this._onWorldTransform()),this._parent=e}}},{key:"_onWorldPositionRotationTransform",value:function(){if(!(this._getTransformFlag(r.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(r.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(r.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(r.TRANSFORM_WORLDEULER))){this._setTransformFlag(r.TRANSFORM_WORLDMATRIX|r.TRANSFORM_WORLDPOSITION|r.TRANSFORM_WORLDQUATERNION|r.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionRotationTransform()}}},{key:"_onWorldPositionScaleTransform",value:function(){if(!this._getTransformFlag(r.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(r.TRANSFORM_WORLDPOSITION)||!this._getTransformFlag(r.TRANSFORM_WORLDSCALE)){this._setTransformFlag(r.TRANSFORM_WORLDMATRIX|r.TRANSFORM_WORLDPOSITION|r.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionScaleTransform()}}},{key:"_onWorldPositionTransform",value:function(){if(!this._getTransformFlag(r.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(r.TRANSFORM_WORLDPOSITION)){this._setTransformFlag(r.TRANSFORM_WORLDMATRIX|r.TRANSFORM_WORLDPOSITION,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionTransform()}}},{key:"_onWorldRotationTransform",value:function(){if(!this._getTransformFlag(r.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(r.TRANSFORM_WORLDQUATERNION)||!this._getTransformFlag(r.TRANSFORM_WORLDEULER)){this._setTransformFlag(r.TRANSFORM_WORLDMATRIX|r.TRANSFORM_WORLDQUATERNION|r.TRANSFORM_WORLDEULER,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionRotationTransform()}}},{key:"_onWorldScaleTransform",value:function(){if(!this._getTransformFlag(r.TRANSFORM_WORLDMATRIX)||!this._getTransformFlag(r.TRANSFORM_WORLDSCALE)){this._setTransformFlag(r.TRANSFORM_WORLDMATRIX|r.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldPositionScaleTransform()}}},{key:"_onWorldTransform",value:function(){if(!(this._getTransformFlag(r.TRANSFORM_WORLDMATRIX)&&this._getTransformFlag(r.TRANSFORM_WORLDPOSITION)&&this._getTransformFlag(r.TRANSFORM_WORLDQUATERNION)&&this._getTransformFlag(r.TRANSFORM_WORLDEULER)&&this._getTransformFlag(r.TRANSFORM_WORLDSCALE))){this._setTransformFlag(r.TRANSFORM_WORLDMATRIX|r.TRANSFORM_WORLDPOSITION|r.TRANSFORM_WORLDQUATERNION|r.TRANSFORM_WORLDEULER|r.TRANSFORM_WORLDSCALE,!0),this.event(t.Event.TRANSFORM_CHANGED,this._transformFlag);for(var e=0,n=this._children.length;e<n;e++)this._children[e]._onWorldTransform()}}},{key:"translate",value:function(e){!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?(T.createFromQuaternion(this.localRotation,r._tempMatrix0),a.transformCoordinate(e,r._tempMatrix0,r._tempVector30),a.add(this.localPosition,r._tempVector30,this._localPosition),this.localPosition=this._localPosition):(a.add(this.position,e,this._position),this.position=this._position)}},{key:"rotate",value:function(e){var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];!(arguments.length>2&&void 0!==arguments[2])||arguments[2]?t=e:(a.scale(e,Math.PI/180,r._tempVector30),t=r._tempVector30),d.createFromYawPitchRoll(t.y,t.x,t.z,r._tempQuaternion0),n?(d.multiply(this._localRotation,r._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(d.multiply(r._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)}},{key:"getForward",value:function(e){var t=this.worldMatrix.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}},{key:"getUp",value:function(e){var t=this.worldMatrix.elements;e.x=t[4],e.y=t[5],e.z=t[6]}},{key:"getRight",value:function(e){var t=this.worldMatrix.elements;e.x=t[0],e.y=t[1],e.z=t[2]}},{key:"lookAt",value:function(e,t){var r;if(arguments.length>2&&void 0!==arguments[2]&&arguments[2]){if(r=this._localPosition,Math.abs(r.x-e.x)<n.zeroTolerance&&Math.abs(r.y-e.y)<n.zeroTolerance&&Math.abs(r.z-e.z)<n.zeroTolerance)return;d.lookAt(this._localPosition,e,t,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var i=this.position;if(r=i,Math.abs(r.x-e.x)<n.zeroTolerance&&Math.abs(r.y-e.y)<n.zeroTolerance&&Math.abs(r.z-e.z)<n.zeroTolerance)return;d.lookAt(i,e,t,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}}},{key:"getWorldLossyScale",value:function(){if(this._getTransformFlag(r.TRANSFORM_WORLDSCALE)){if(null!==this._parent){var e=this._getScaleMatrix().elements;this._scale.x=e[0],this._scale.y=e[4],this._scale.z=e[8]}else this._localScale.cloneTo(this._scale);this._setTransformFlag(r.TRANSFORM_WORLDSCALE,!1)}return this._scale}},{key:"setWorldLossyScale",value:function(e){if(null!==this._parent){var t=r._tempMatrix3x33,n=r._tempMatrix3x33,i=n.elements,a=this._parent._getScaleMatrix();a.invert(a),h.createFromScaling(e,t),h.multiply(a,t,n),this._localScale.x=i[0],this._localScale.y=i[4],this._localScale.z=i[8]}else e.cloneTo(this._localScale);this.localScale=this._localScale,this._scale!==e&&e.cloneTo(this._scale),this._setTransformFlag(r.TRANSFORM_WORLDSCALE,!1)}},{key:"_isFrontFaceInvert",get:function(){var e=this.getWorldLossyScale(),t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}},{key:"owner",get:function(){return this._owner}},{key:"worldNeedUpdate",get:function(){return this._getTransformFlag(r.TRANSFORM_WORLDMATRIX)}},{key:"localPositionX",get:function(){return this._localPosition.x},set:function(e){this._localPosition.x=e,this.localPosition=this._localPosition}},{key:"localPositionY",get:function(){return this._localPosition.y},set:function(e){this._localPosition.y=e,this.localPosition=this._localPosition}},{key:"localPositionZ",get:function(){return this._localPosition.z},set:function(e){this._localPosition.z=e,this.localPosition=this._localPosition}},{key:"localPosition",get:function(){return this._localPosition},set:function(e){this._localPosition!==e&&e.cloneTo(this._localPosition),this._setTransformFlag(r.TRANSFORM_LOCALMATRIX,!0),this._onWorldPositionTransform()}},{key:"localRotationX",get:function(){return this.localRotation.x},set:function(e){this._localRotation.x=e,this.localRotation=this._localRotation}},{key:"localRotationY",get:function(){return this.localRotation.y},set:function(e){this._localRotation.y=e,this.localRotation=this._localRotation}},{key:"localRotationZ",get:function(){return this.localRotation.z},set:function(e){this._localRotation.z=e,this.localRotation=this._localRotation}},{key:"localRotationW",get:function(){return this.localRotation.w},set:function(e){this._localRotation.w=e,this.localRotation=this._localRotation}},{key:"localRotation",get:function(){if(this._getTransformFlag(r.TRANSFORM_LOCALQUATERNION)){var e=this._localRotationEuler;d.createFromYawPitchRoll(e.y/r._angleToRandin,e.x/r._angleToRandin,e.z/r._angleToRandin,this._localRotation),this._setTransformFlag(r.TRANSFORM_LOCALQUATERNION,!1)}return this._localRotation},set:function(e){this._localRotation!==e&&e.cloneTo(this._localRotation),this._localRotation.normalize(this._localRotation),this._setTransformFlag(r.TRANSFORM_LOCALEULER|r.TRANSFORM_LOCALMATRIX,!0),this._setTransformFlag(r.TRANSFORM_LOCALQUATERNION,!1),this._onWorldRotationTransform()}},{key:"localScaleX",get:function(){return this._localScale.x},set:function(e){this._localScale.x=e,this.localScale=this._localScale}},{key:"localScaleY",get:function(){return this._localScale.y},set:function(e){this._localScale.y=e,this.localScale=this._localScale}},{key:"localScaleZ",get:function(){return this._localScale.z},set:function(e){this._localScale.z=e,this.localScale=this._localScale}},{key:"localScale",get:function(){return this._localScale},set:function(e){this._localScale!==e&&e.cloneTo(this._localScale),this._setTransformFlag(r.TRANSFORM_LOCALMATRIX,!0),this._onWorldScaleTransform()}},{key:"localRotationEulerX",get:function(){return this.localRotationEuler.x},set:function(e){this._localRotationEuler.x=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEulerY",get:function(){return this.localRotationEuler.y},set:function(e){this._localRotationEuler.y=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEulerZ",get:function(){return this.localRotationEuler.z},set:function(e){this._localRotationEuler.z=e,this.localRotationEuler=this._localRotationEuler}},{key:"localRotationEuler",get:function(){if(this._getTransformFlag(r.TRANSFORM_LOCALEULER)){this._localRotation.getYawPitchRoll(r._tempVector30);var e=r._tempVector30,t=this._localRotationEuler;t.x=e.y*r._angleToRandin,t.y=e.x*r._angleToRandin,t.z=e.z*r._angleToRandin,this._setTransformFlag(r.TRANSFORM_LOCALEULER,!1)}return this._localRotationEuler},set:function(e){this._localRotationEuler!==e&&e.cloneTo(this._localRotationEuler),this._setTransformFlag(r.TRANSFORM_LOCALEULER,!1),this._setTransformFlag(r.TRANSFORM_LOCALQUATERNION|r.TRANSFORM_LOCALMATRIX,!0),this._onWorldRotationTransform()}},{key:"localMatrix",get:function(){return this._getTransformFlag(r.TRANSFORM_LOCALMATRIX)&&(T.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix),this._setTransformFlag(r.TRANSFORM_LOCALMATRIX,!1)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._setTransformFlag(r.TRANSFORM_LOCALEULER,!0),this._setTransformFlag(r.TRANSFORM_LOCALMATRIX,!1),this._onWorldTransform()}},{key:"position",get:function(){if(this._getTransformFlag(r.TRANSFORM_WORLDPOSITION)){if(null!=this._parent){var e=this.worldMatrix.elements;this._position.x=e[12],this._position.y=e[13],this._position.z=e[14]}else this._localPosition.cloneTo(this._position);this._setTransformFlag(r.TRANSFORM_WORLDPOSITION,!1)}return this._position},set:function(e){if(null!=this._parent){var t=r._tempMatrix0;this._parent.worldMatrix.invert(t),a.transformCoordinate(e,t,this._localPosition)}else e.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position!==e&&e.cloneTo(this._position),this._setTransformFlag(r.TRANSFORM_WORLDPOSITION,!1)}},{key:"rotation",get:function(){return this._getTransformFlag(r.TRANSFORM_WORLDQUATERNION)&&(null!=this._parent?d.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._setTransformFlag(r.TRANSFORM_WORLDQUATERNION,!1)),this._rotation},set:function(e){null!=this._parent?(this._parent.rotation.invert(r._tempQuaternion0),d.multiply(r._tempQuaternion0,e,this._localRotation)):e.cloneTo(this._localRotation),this.localRotation=this._localRotation,e!==this._rotation&&e.cloneTo(this._rotation),this._setTransformFlag(r.TRANSFORM_WORLDQUATERNION,!1)}},{key:"rotationEuler",get:function(){if(this._getTransformFlag(r.TRANSFORM_WORLDEULER)){this.rotation.getYawPitchRoll(r._tempVector30);var e=r._tempVector30,t=this._rotationEuler;t.x=e.y*r._angleToRandin,t.y=e.x*r._angleToRandin,t.z=e.z*r._angleToRandin,this._setTransformFlag(r.TRANSFORM_WORLDEULER,!1)}return this._rotationEuler},set:function(e){d.createFromYawPitchRoll(e.y/r._angleToRandin,e.x/r._angleToRandin,e.z/r._angleToRandin,this._rotation),this.rotation=this._rotation,this._rotationEuler!==e&&e.cloneTo(this._rotationEuler),this._setTransformFlag(r.TRANSFORM_WORLDEULER,!1)}},{key:"worldMatrix",get:function(){return this._getTransformFlag(r.TRANSFORM_WORLDMATRIX)&&(null!=this._parent?T.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setTransformFlag(r.TRANSFORM_WORLDMATRIX,!1)),this._worldMatrix},set:function(e){null===this._parent?e.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),T.multiply(this._localMatrix,e,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix!==e&&e.cloneTo(this._worldMatrix),this._setTransformFlag(r.TRANSFORM_WORLDMATRIX,!1)}},{key:"scale",get:function(){return console.warn("Transfrm3D: discard function,please use getWorldLossyScale instead."),this.getWorldLossyScale()},set:function(e){console.warn("Transfrm3D: discard function,please use setWorldLossyScale instead."),this.setWorldLossyScale(e)}}]),r}();se._tempVector30=new a,se._tempQuaternion0=new d,se._tempMatrix0=new T,se._tempMatrix3x30=new h,se._tempMatrix3x31=new h,se._tempMatrix3x32=new h,se._tempMatrix3x33=new h,se.TRANSFORM_LOCALQUATERNION=1,se.TRANSFORM_LOCALEULER=2,se.TRANSFORM_LOCALMATRIX=4,se.TRANSFORM_WORLDPOSITION=8,se.TRANSFORM_WORLDQUATERNION=16,se.TRANSFORM_WORLDSCALE=32,se.TRANSFORM_WORLDMATRIX=64,se.TRANSFORM_WORLDEULER=128,se._angleToRandin=180/Math.PI;var le=function(e){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r._needProcessCollisions=!1,r._needProcessTriggers=!1,r._id=++n._uniqueIDCounter,r._transform=new se(r),r._isStatic=t,r.layer=0,r.name=e||"New Sprite3D",r}return _inherits(n,t.Node),_createClass(n,[{key:"_setCreateURL",value:function(e){this._url=t.URL.formatURL(e)}},{key:"_changeAnimatorsToLinkSprite3D",value:function(e,t,r){var i=this.getComponent(N);if(i&&(i.avatar||e._changeAnimatorToLinkSprite3DNoAvatar(i,t,r)),this._parent&&this._parent instanceof n){r.unshift(this._parent.name);var a=this._parent;a._hierarchyAnimator&&a._changeAnimatorsToLinkSprite3D(e,t,r)}}},{key:"_setHierarchyAnimator",value:function(e,t){this._changeHierarchyAnimator(e),this._changeAnimatorAvatar(e.avatar);for(var n=0,r=this._children.length;n<r;n++){var i=this._children[n];i._hierarchyAnimator==t&&i._setHierarchyAnimator(e,t)}}},{key:"_clearHierarchyAnimator",value:function(e,t){this._changeHierarchyAnimator(t),this._changeAnimatorAvatar(t?t.avatar:null);for(var n=0,r=this._children.length;n<r;n++){var i=this._children[n];i._hierarchyAnimator==e&&i._clearHierarchyAnimator(e,t)}}},{key:"_changeHierarchyAnimatorAvatar",value:function(e,t){this._changeAnimatorAvatar(t);for(var n=0,r=this._children.length;n<r;n++){var i=this._children[n];i._hierarchyAnimator==e&&i._changeHierarchyAnimatorAvatar(e,t)}}},{key:"_changeAnimatorToLinkSprite3DNoAvatar",value:function(e,t,n){e._handleSpriteOwnersBySprite(t,n,this);for(var r=0,i=this._children.length;r<i;r++){var a=this._children[r],o=n.length;n.push(a.name),a._changeAnimatorToLinkSprite3DNoAvatar(e,t,n),n.splice(o,1)}}},{key:"_changeHierarchyAnimator",value:function(e){this._hierarchyAnimator=e}},{key:"_changeAnimatorAvatar",value:function(e){}},{key:"_onAdded",value:function(){if(this._parent instanceof n){var e=this._parent;this.transform._setParent(e.transform),e._hierarchyAnimator&&(!this._hierarchyAnimator&&this._setHierarchyAnimator(e._hierarchyAnimator,null),e._changeAnimatorsToLinkSprite3D(this,!0,[this.name]))}_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onAdded",this).call(this)}},{key:"_onRemoved",value:function(){if(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onRemoved",this).call(this),this._parent instanceof n){var e=this._parent;this.transform._setParent(null),e._hierarchyAnimator&&(this._hierarchyAnimator==e._hierarchyAnimator&&this._clearHierarchyAnimator(e._hierarchyAnimator,null),e._changeAnimatorsToLinkSprite3D(this,!1,[this.name]))}}},{key:"_parse",value:function(e,t){if(void 0!==e.isStatic&&(this._isStatic=e.isStatic),void 0!==e.active&&(this.active=e.active),void 0!=e.name&&(this.name=e.name),void 0!==e.position){var n=this.transform.localPosition;n.fromArray(e.position),this.transform.localPosition=n}if(void 0!==e.rotationEuler){var r=this.transform.localRotationEuler;r.fromArray(e.rotationEuler),this.transform.localRotationEuler=r}if(void 0!==e.rotation){var i=this.transform.localRotation;i.fromArray(e.rotation),this.transform.localRotation=i}if(void 0!==e.scale){var a=this.transform.localScale;a.fromArray(e.scale),this.transform.localScale=a}void 0!=e.layer&&(this.layer=e.layer)}},{key:"_cloneTo",value:function(e,t,r){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var i=e,a=this._transform,o=i._transform;i.name=this.name,i.destroyed=this.destroyed,i.active=this.active,o.localPosition=a.localPosition,o.localRotation=a.localRotation,o.localScale=a.localScale,i._isStatic=this._isStatic,i.layer=this.layer,_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_cloneTo",this).call(this,i,t,r)}},{key:"clone",value:function(){var e=n._createSprite3DInstance(this);return n._parseSprite3DInstance(this,e,this,e),e}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this,e),this._transform=null,this._scripts=null,this._url&&t.Loader.clearRes(this._url))}},{key:"_create",value:function(){return new n}},{key:"id",get:function(){return this._id}},{key:"layer",get:function(){return this._layer},set:function(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._layer=e}}},{key:"url",get:function(){return this._url}},{key:"isStatic",get:function(){return this._isStatic}},{key:"transform",get:function(){return this._transform}}],[{key:"__init__",value:function(){}},{key:"instantiate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=e.clone();t&&t.addChild(a);var o=a.transform;if(n){var s=o.worldMatrix;e.transform.worldMatrix.cloneTo(s),o.worldMatrix=s}else r&&(o.position=r),i&&(o.rotation=i);return a}},{key:"load",value:function(e,r){t.Laya.loader.create(e,r,null,n.HIERARCHY)}},{key:"_createSprite3DInstance",value:function(e){for(var t=e._create(),r=e._children,i=0,a=r.length;i<a;i++){var o=n._createSprite3DInstance(r[i]);t.addChild(o)}return t}},{key:"_parseSprite3DInstance",value:function(e,t,r,i){for(var a=r._children,o=i._children,s=0,l=a.length;s<l;s++)n._parseSprite3DInstance(e,t,a[s],o[s]);r._cloneTo(i,e,t)}}]),n}();le.HIERARCHY="HIERARCHY",le.WORLDMATRIX=U.propertyNameToID("u_WorldMat"),le.MVPMATRIX=U.propertyNameToID("u_MvpMatrix"),le._uniqueIDCounter=0;var _e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,le),_createClass(t,[{key:"_onInActive",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onInActive",this).call(this),this._scene._removeRenderObject(this._render)}},{key:"_onActive",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onActive",this).call(this),this._scene._addRenderObject(this._render)}},{key:"_onActiveInScene",value:function(){if(_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onActiveInScene",this).call(this),s.Laya3D._editerEnvironment){var e=this._scene,n=new i;e._allotPickColorByID(this.id,n),e._pickIdToSprite[this.id]=this,this._render._shaderValues.setVector(t.PICKCOLOR,n)}}},{key:"_addToInitStaticBatchManager",value:function(){}},{key:"_setBelongScene",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_setBelongScene",this).call(this,e),this._render._setBelongScene(e)}},{key:"_setUnBelongScene",value:function(){this._render._shaderValues.removeDefine(t.SAHDERDEFINE_LIGHTMAP),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_setUnBelongScene",this).call(this)}},{key:"_changeHierarchyAnimator",value:function(e){if(this._hierarchyAnimator){var n=this._hierarchyAnimator._renderableSprites;n.splice(n.indexOf(this),1)}e&&e._renderableSprites.push(this),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_changeHierarchyAnimator",this).call(this,e)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this,e),this._render._destroy(),this._render=null}},{key:"_create",value:function(){return new t(this.name)}}],[{key:"__init__",value:function(){t.SHADERDEFINE_RECEIVE_SHADOW=U.getDefineByName("RECEIVESHADOW"),t.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=U.getDefineByName("SCALEOFFSETLIGHTINGMAPUV"),t.SAHDERDEFINE_LIGHTMAP=U.getDefineByName("LIGHTMAP")}}]),t}();_e.LIGHTMAPSCALEOFFSET=U.propertyNameToID("u_LightmapScaleOffset"),_e.LIGHTMAP=U.propertyNameToID("u_LightMap"),_e.PICKCOLOR=U.propertyNameToID("u_PickColor");var ue=function(){function e(){_classCallCheck(this,e),this._initBatchSprites=[],this._staticBatches={},this._batchRenderElementPoolIndex=0,this._batchRenderElementPool=[]}return _createClass(e,[{key:"_partition",value:function(e,t,n){for(var r=e[Math.floor((n+t)/2)];t<=n;){for(;this._compare(e[t],r)<0;)t++;for(;this._compare(e[n],r)>0;)n--;if(t<n){var i=e[t];e[t]=e[n],e[n]=i,t++,n--}else if(t===n){t++;break}}return t}},{key:"_quickSort",value:function(e,t,n){if(e.length>1){var r=this._partition(e,t,n),i=r-1;t<i&&this._quickSort(e,t,i),r<n&&this._quickSort(e,r,n)}}},{key:"_compare",value:function(e,t){throw"StaticBatch:must override this function."}},{key:"_initStaticBatchs",value:function(e){throw"StaticBatch:must override this function."}},{key:"_getBatchRenderElementFromPool",value:function(){throw"StaticBatch:must override this function."}},{key:"_addBatchSprite",value:function(e){this._initBatchSprites.push(e)}},{key:"_clear",value:function(){this._batchRenderElementPoolIndex=0}},{key:"_garbageCollection",value:function(){throw"StaticBatchManager: must override it."}},{key:"dispose",value:function(){this._staticBatches=null}}],[{key:"_addToStaticBatchQueue",value:function(t,n){t instanceof _e&&n.push(t);for(var r=0,i=t.numChildren;r<i;r++)e._addToStaticBatchQueue(t._children[r],n)}},{key:"_registerManager",value:function(t){e._managers.push(t)}},{key:"combine",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;n||(n=[],t&&e._addToStaticBatchQueue(t,n));var r=n.length;if(r>0){for(var i=0;i<r;i++){var a=n[i];a.destroyed||(a._render._isPartOfStaticBatch?console.warn("StaticBatchManager: Sprite "+a.name+" has a part of Static Batch,it will be ignore."):a._addToInitStaticBatchManager())}for(var o=0,s=e._managers.length;o<s;o++){e._managers[o]._initStaticBatchs(t)}}}}]),e}();ue._managers=[];var ce=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"__init__",value:function(){t.Render.supportWebGLPlusCulling&&(e._cullingBufferLength=0,e._cullingBuffer=new Float32Array(4096))}},{key:"_drawTraversalCullingBound",value:function(t,n){t.length;for(var r=t.elements,i=0,a=t.length;i<a;i++){var o=e._tempColor0;o.r=0,o.g=1,o.b=0,o.a=1,A._drawBound(n,r[i].bounds._getBoundBox(),o)}}},{key:"_traversalCulling",value:function(e,n,r,i,o,s,l){for(var _=i.elements,u=e.boundFrustum,c=e._transform.position,h=0,d=i.length;h<d;h++){var f=_[h];if(l?f._castShadow&&f._enable:e._isLayerVisible(f._owner._layer)&&f._enable)if(t.Stat.frustumCulling++,!e.useOcclusionCulling||f._needRender(u,r)){f._visible=!0,f._distanceForSort=a.distance(f.bounds.getCenter(),c);for(var m=f._renderElements,E=0,v=m.length;E<v;E++)m[E]._update(n,r,o,s)}else f._visible=!1;else f._visible=!1}}},{key:"renderObjectCulling",value:function(t,n,r,i,a,o){var s,l,_=n._opaqueQueue,u=n._transparentQueue,c=n._renders;_.clear(),u.clear();var h=ue._managers;for(s=0,l=h.length;s<l;s++)h[s]._clear();var d=oe._managers;for(s=0,l=d.length;s<l;s++)d[s]._clear();var f=n._octree;if(f&&(f.updateMotionObjects(),f.shrinkRootIfPossible(),f.getCollidingWithFrustum(r,i,a,o)),e._traversalCulling(t,n,r,c,i,a,o),e.debugFrustumCulling){var m=n._debugTool;m.clear(),f&&(f.drawAllBounds(m),f.drawAllObjects(m)),e._drawTraversalCullingBound(c,m)}var E=_.elements.length;E>0&&_._quickSort(0,E-1),(E=u.elements.length)>0&&u._quickSort(0,E-1)}},{key:"renderObjectCullingNative",value:function(t,n,r,i,o,s){var l,_,u,c,h=n._opaqueQueue,d=n._transparentQueue;h.clear(),d.clear();var f=ue._managers;for(l=0,_=f.length;l<_;l++)f[l]._clear();var m=oe._managers;for(l=0,_=m.length;l<_;l++)m[l]._clear();var E=i.length,v=i.elements;for(l=0;l<E;l++)v[l].bounds,v[l]._updateForNative&&v[l]._updateForNative(r);t.boundFrustum;e.cullingNative(t._boundFrustumBuffer,e._cullingBuffer,n._cullingBufferIndices,E,n._cullingBufferResult);var T=r.camera._transform.position;for(l=0;l<E;l++){var p=v[l];if(!t.useOcclusionCulling||t._isLayerVisible(p._owner._layer)&&p._enable&&n._cullingBufferResult[l]){p._visible=!0,p._distanceForSort=a.distance(p.bounds.getCenter(),T);var g=p._renderElements;for(u=0,c=g.length;u<c;u++){g[u]._update(n,r,o,s)}}else p._visible=!1}var y=h.elements.length;y>0&&h._quickSort(0,y-1),(y=d.elements.length)>0&&d._quickSort(0,y-1)}},{key:"cullingNative",value:function(e,n,r,i,a){return t.LayaGL.instance.culling(e,n,r,i,a)}}]),e}();ce._tempVector3=new a,ce._tempColor0=new ae,ce.debugFrustumCulling=!1;var he=function e(){_classCallCheck(this,e),this.updateMark=-1,this.indexInList=-1,this.batched=!1},de=function(){function e(){_classCallCheck(this,e),this._destroyed=!1}return _createClass(e,[{key:"_getType",value:function(){throw"GeometryElement:must override it."}},{key:"_prepareRender",value:function(e){return!0}},{key:"_render",value:function(e){throw"GeometryElement:must override it."}},{key:"destroy",value:function(){this._destroyed||(this._destroyed=!0)}},{key:"destroyed",get:function(){return this._destroyed}}]),e}();de._typeCounter=0;var fe=function(e){function n(e,r){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,n);var a=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));a._vertexDeclaration=null,a._float32Reader=null;var o=t.LayaGL.instance;return a._bufferUsage=r,a._bufferType=o.ARRAY_BUFFER,a._canRead=i,a._byteLength=e,a.bind(),o.bufferData(a._bufferType,a._byteLength,a._bufferUsage),i&&(a._buffer=new Uint8Array(e),a._float32Reader=new Float32Array(a._buffer.buffer)),a}return _inherits(n,t.Buffer),_createClass(n,[{key:"bind",value:function(){if(t.Buffer._bindedVertexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedVertexBuffer=this._glBuffer,!0}return!1}},{key:"setData",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Number.MAX_SAFE_INTEGER;if(this.bind(),0!==r||i!==Number.MAX_SAFE_INTEGER){var a=new Uint8Array(e,r,i);t.LayaGL.instance.bufferSubData(this._bufferType,n,a),this._canRead&&this._buffer.set(a,n)}else t.LayaGL.instance.bufferSubData(this._bufferType,n,e),this._canRead&&this._buffer.set(new Uint8Array(e),n)}},{key:"getUint8Data",value:function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"getFloat32Data",value:function(){if(this._canRead)return this._float32Reader;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"markAsUnreadbale",value:function(){this._canRead=!1,this._buffer=null,this._float32Reader=null}},{key:"destroy",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this),this._buffer=null,this._float32Reader=null,this._vertexDeclaration=null}},{key:"vertexDeclaration",get:function(){return this._vertexDeclaration},set:function(e){this._vertexDeclaration=e}},{key:"canRead",get:function(){return this._canRead}}]),n}();fe.DATATYPE_FLOAT32ARRAY=0,fe.DATATYPE_UINT8ARRAY=1;var me=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"__init__",value:function(){var n=t.LayaGL.instance;e._elementInfos={single:[1,n.FLOAT,0],vector2:[2,n.FLOAT,0],vector3:[3,n.FLOAT,0],vector4:[4,n.FLOAT,0],color:[4,n.FLOAT,0],byte4:[4,n.UNSIGNED_BYTE,0],short2:[2,n.FLOAT,0],short4:[4,n.FLOAT,0],normalizedshort2:[2,n.FLOAT,0],normalizedshort4:[4,n.FLOAT,0],halfvector2:[2,n.FLOAT,0],halfvector4:[4,n.FLOAT,0]}}},{key:"getElementInfos",value:function(t){var n=e._elementInfos[t];if(n)return n;throw"VertexElementFormat: this vertexElementFormat is not implement."}}]),e}();me.Single="single",me.Vector2="vector2",me.Vector3="vector3",me.Vector4="vector4",me.Color="color",me.Byte4="byte4",me.Short2="short2",me.Short4="short4",me.NormalizedShort2="normalizedshort2",me.NormalizedShort4="normalizedshort4",me.HalfVector2="halfvector2",me.HalfVector4="halfvector4";var Ee=function(){function e(t,n){_classCallCheck(this,e),this._id=++e._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=n;var r=n.length;this._shaderValues=new G(null);for(var i=0;i<r;i++){var a=n[i],o=a._elementUsage;this._vertexElementsDic[o]=a;var s=new Int32Array(5),l=me.getElementInfos(a._elementFormat);s[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=this._vertexStride,s[4]=a._offset,this._shaderValues.setAttribute(o,s)}}return _createClass(e,[{key:"getVertexElementByIndex",value:function(e){return this._vertexElements[e]}},{key:"getVertexElementByUsage",value:function(e){return this._vertexElementsDic[e]}},{key:"id",get:function(){return this._id}},{key:"vertexStride",get:function(){return this._vertexStride}},{key:"vertexElementCount",get:function(){return this._vertexElements.length}}]),e}();Ee._uniqueIDCounter=1;var ve=function(){function e(t,n,r){_classCallCheck(this,e),this._offset=t,this._elementFormat=n,this._elementUsage=r}return _createClass(e,[{key:"offset",get:function(){return this._offset}},{key:"elementFormat",get:function(){return this._elementFormat}},{key:"elementUsage",get:function(){return this._elementUsage}}]),e}(),Te=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"__init__",value:function(){e.instanceWorldMatrixDeclaration=new Ee(64,[new ve(0,me.Vector4,e.MESH_WORLDMATRIX_ROW0),new ve(16,me.Vector4,e.MESH_WORLDMATRIX_ROW1),new ve(32,me.Vector4,e.MESH_WORLDMATRIX_ROW2),new ve(48,me.Vector4,e.MESH_WORLDMATRIX_ROW3)]),e.instanceMVPMatrixDeclaration=new Ee(64,[new ve(0,me.Vector4,e.MESH_MVPMATRIX_ROW0),new ve(16,me.Vector4,e.MESH_MVPMATRIX_ROW1),new ve(32,me.Vector4,e.MESH_MVPMATRIX_ROW2),new ve(48,me.Vector4,e.MESH_MVPMATRIX_ROW3)])}},{key:"getVertexDeclaration",value:function(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=e._vertexDeclarationMap[t+(n?"_0":"_1")];if(!r){for(var i=t.split(","),a=0,o=[],s=0,l=i.length;s<l;s++){var _;switch(i[s]){case"POSITION":_=new ve(a,me.Vector3,e.MESH_POSITION0),a+=12;break;case"NORMAL":_=new ve(a,me.Vector3,e.MESH_NORMAL0),a+=12;break;case"COLOR":_=new ve(a,me.Vector4,e.MESH_COLOR0),a+=16;break;case"UV":_=new ve(a,me.Vector2,e.MESH_TEXTURECOORDINATE0),a+=8;break;case"UV1":_=new ve(a,me.Vector2,e.MESH_TEXTURECOORDINATE1),a+=8;break;case"BLENDWEIGHT":_=new ve(a,me.Vector4,e.MESH_BLENDWEIGHT0),a+=16;break;case"BLENDINDICES":n?(_=new ve(a,me.Vector4,e.MESH_BLENDINDICES0),a+=16):(_=new ve(a,me.Byte4,e.MESH_BLENDINDICES0),a+=4);break;case"TANGENT":_=new ve(a,me.Vector4,e.MESH_TANGENT0),a+=16;break;default:throw"VertexMesh: unknown vertex flag."}o.push(_)}r=new Ee(a,o),e._vertexDeclarationMap[t+(n?"_0":"_1")]=r}return r}}]),e}();Te.MESH_POSITION0=0,Te.MESH_COLOR0=1,Te.MESH_TEXTURECOORDINATE0=2,Te.MESH_NORMAL0=3,Te.MESH_TANGENT0=4,Te.MESH_BLENDINDICES0=5,Te.MESH_BLENDWEIGHT0=6,Te.MESH_TEXTURECOORDINATE1=7,Te.MESH_WORLDMATRIX_ROW0=8,Te.MESH_WORLDMATRIX_ROW1=9,Te.MESH_WORLDMATRIX_ROW2=10,Te.MESH_WORLDMATRIX_ROW3=11,Te.MESH_MVPMATRIX_ROW0=12,Te.MESH_MVPMATRIX_ROW1=13,Te.MESH_MVPMATRIX_ROW2=14,Te.MESH_MVPMATRIX_ROW3=15,Te._vertexDeclarationMap={};var pe=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));e.maxInstanceCount=1024,e.instanceWorldMatrixData=new Float32Array(16*e.maxInstanceCount),e.instanceMVPMatrixData=new Float32Array(16*e.maxInstanceCount);var r=t.LayaGL.instance;return e.instanceWorldMatrixBuffer=new fe(4*e.instanceWorldMatrixData.length,r.DYNAMIC_DRAW),e.instanceMVPMatrixBuffer=new fe(4*e.instanceMVPMatrixData.length,r.DYNAMIC_DRAW),e.instanceWorldMatrixBuffer.vertexDeclaration=Te.instanceWorldMatrixDeclaration,e.instanceMVPMatrixBuffer.vertexDeclaration=Te.instanceMVPMatrixDeclaration,e}return _inherits(n,de),_createClass(n,[{key:"_render",value:function(e){var n=t.LayaGL.instance,r=e.renderElement,i=r.instanceSubMesh,a=r.instanceBatchElementList.length,o=i._indexCount;i._mesh._instanceBufferState.bind(),t.LayaGL.layaGPUInstance.drawElementsInstanced(n.TRIANGLES,o,n.UNSIGNED_SHORT,2*i._indexStart,a),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=a-1,t.Stat.trianglesFaces+=o*a/3}}],[{key:"__init__",value:function(){n.instance=new n}}]),n}(),ge=function e(){_classCallCheck(this,e),this.updateMark=-1,this.pointLightCount=0,this.spotLightCount=0,this.indices=[]},ye=function(){function e(t,n,i,a){_classCallCheck(this,e),this._updateMark=0,this._depthSliceParam=new r,this._xSlices=t,this._ySlices=n,this._zSlices=i;var o=t*n,s=i*(1+Math.ceil(a/4));this._clusterTexture=A._createFloatTextureBuffer(o,s),this._clusterTexture.lock=!0,this._clusterPixels=new Float32Array(o*s*4);for(var l=new Array(this._zSlices),_=0;_<this._zSlices;_++){l[_]=new Array(this._ySlices);for(var u=0;u<this._ySlices;u++){l[_][u]=new Array(this._xSlices);for(var c=0;c<this._xSlices;c++)l[_][u][c]=new ge}}this._clusterDatas=l}return _createClass(e,[{key:"_insertSpotLightSphere",value:function(t,n,r,i,o){var s=e._tempVector35;s.x=o.x-t.x,s.y=o.y-t.y,s.z=o.z-t.z;var l=a.dot(s,s),_=o.w;if(!(l>_*_))return!1;var u=a.dot(s,n);return!(Math.cos(i)*Math.sqrt(l-u*u)-u*Math.sin(i)>_||u>_+r||u<-_)}},{key:"_placePointLightToClusters",value:function(e,t){for(var n=this._clusterDatas,r=this._updateMark,i=t.zMin,a=t.zMax;i<a;i++)for(var o=t.yMin,s=t.yMax;o<s;o++)for(var l=t.xMin,_=t.xMax;l<_;l++){var u=n[i][o][l];u.updateMark!=r&&(u.pointLightCount=0,u.spotLightCount=0,u.updateMark=r);var c=u.indices,h=u.pointLightCount++;h<c.length?c[h]=e:c.push(e)}}},{key:"_placeSpotLightToClusters",value:function(e,t){for(var n=this._clusterDatas,r=this._updateMark,i=t.zMin,a=t.zMax;i<a;i++)for(var o=t.yMin,s=t.yMax;o<s;o++)for(var l=t.xMin,_=t.xMax;l<_;l++){var u=n[i][o][l];u.updateMark!=r&&(u.pointLightCount=0,u.spotLightCount=0,u.updateMark=r);var c=u.indices,h=u.pointLightCount+u.spotLightCount++;h<c.length?c[h]=e:c.push(e)}}},{key:"_insertConePlane",value:function(t,n,r,i,o){var s=e._tempVector36,l=e._tempVector37;a.cross(o,n,s),a.cross(s,n,l),a.normalize(l,l);var _=r*Math.tan(i),u=t.x+r*n.x+_*l.x,c=t.y+r*n.y+_*l.y,h=t.z+r*n.z+_*l.z;return u*o.x+c*o.y+h*o.z<=0||t.x*o.x+t.y*o.y+t.z*o.z<=0}},{key:"_shrinkSphereLightZPerspective",value:function(e,t,n,r,i){var a=n.z,o=a-r,s=a+r;if(o>t||s<=e)return!1;var l=this._depthSliceParam;return i.zMin=Math.floor(Math.log2(Math.max(o,e))*l.x-l.y),i.zMax=Math.min(Math.ceil(Math.log2(s)*l.x-l.y),this._zSlices),!0}},{key:"_shrinkSpotLightZPerspective",value:function(e,t,n,r,i,a,o){var s=r.x,l=r.y,_=r.z,u=Math.tan(a)*i,c=n.x,h=n.y,d=n.z,f=s-c,m=l-h,E=_-d,v=f*f+m*m+E*E,T=Math.sqrt(1-E*E/v),p=Math.max(Math.min(d,_-T*u),n.z-i),g=Math.min(Math.max(d,_+T*u),n.z+i);if(p>t||g<=e)return!1;var y=this._depthSliceParam;return o.zMin=Math.floor(Math.log2(Math.max(p,e))*y.x-y.y),o.zMax=Math.min(Math.ceil(Math.log2(g)*y.x-y.y),this._zSlices),!0}},{key:"_shrinkSphereLightByBoundOrth",value:function(e,t,n,r,i,a,o){var s=i.z,l=s-a,_=s+a;if(l>r||_<=n)return!1;var u=i.x,c=u-a,h=u+a;if(c>e||h<=-e)return!1;var d=i.y,f=d-a,m=d+a;if(f>t||m<=-t)return!1;var E=this._xSlices,v=this._ySlices,T=this._depthSliceParam,p=2*e/E,g=2*t/v;return o.xMin=Math.max(Math.floor((c+e)/p),0),o.xMax=Math.min(Math.ceil((h+e)/p),E),o.yMin=Math.max(Math.floor((t-m)/g),0),o.yMax=Math.min(Math.ceil((t-f)/g),v),o.zMin=Math.floor(Math.log2(Math.max(l,n))*T.x-T.y),o.zMax=Math.min(Math.ceil(Math.log2(_)*T.x-T.y),this._zSlices),!0}},{key:"_shrinkSpotLightByBoundOrth",value:function(e,t,n,r,i,a,o,s,l){var _=a.x,u=a.y,c=a.z,h=Math.tan(s)*o,d=i.x,f=i.y,m=i.z,E=_-d,v=u-f,T=c-m,p=E*E+v*v+T*T,g=Math.sqrt(1-T*T/p),y=Math.max(Math.min(m,c-g*h),i.z-o),S=Math.min(Math.max(m,c+g*h),i.z+o);if(y>r||S<=n)return!1;var R=Math.sqrt(1-E*E/p),C=Math.max(Math.min(d,_-R*h),i.x-o),I=Math.min(Math.max(d,_+R*h),i.x+o);if(C>e||I<=-e)return!1;var A=Math.sqrt(1-v*v/p),x=Math.max(Math.min(f,u-A*h),i.y-o),D=Math.min(Math.max(f,u+A*h),i.y+o);if(x>t||D<=-t)return!1;var L=this._xSlices,M=this._ySlices,O=this._depthSliceParam,N=2*e/L,P=2*t/M;return l.xMin=Math.max(Math.floor((C+e)/N),0),l.xMax=Math.min(Math.ceil((I+e)/N),L),l.yMin=Math.max(Math.floor((t-D)/P),0),l.yMax=Math.min(Math.ceil((t-x)/P),M),l.zMin=Math.floor(Math.log2(Math.max(y,n))*O.x-O.y),l.zMax=Math.min(Math.ceil(Math.log2(S)*O.x-O.y),this._zSlices),!0}},{key:"_shrinkXYByRadiusPerspective",value:function(e,t,n,r,i){var a,o,s,l,_,u=e.x,c=e.y,h=e.z,d=this._ySlices+1;for(_=0;_<d;_++){if(c*(f=i[_]).y+h*f.z<t){o=Math.max(0,_-1);break}}if(_==d)return!1;for(l=this._ySlices,_=o+1;_<d;_++){if(c*(f=i[_]).y+h*f.z<=-t){l=Math.max(0,_);break}}for(d=this._xSlices+1,_=0;_<d;_++){if(u*(f=r[_]).x+h*f.z<t){a=Math.max(0,_-1);break}}for(s=this._xSlices,_=a+1;_<d;_++){var f;if(u*(f=r[_]).x+h*f.z<=-t){s=Math.max(0,_);break}}return n.xMin=a,n.xMax=s,n.yMin=o,n.yMax=l,!0}},{key:"_shrinkSpotXYByConePerspective",value:function(t,n,r,i,a,o,s){for(var l,_,u,c,h=e._tempVector32,d=a.yMax+1,f=a.yMin+1;f<d;f++)if(this._insertConePlane(t,n,r,i,s[f])){_=Math.max(0,f-1);break}c=a.yMax;for(f=_+1;f<d;f++){var m=s[f];if(h.setValue(0,-m.y,-m.z),!this._insertConePlane(t,n,r,i,h)){c=Math.max(0,f);break}}d=a.xMax+1;for(f=a.xMin+1;f<d;f++)if(this._insertConePlane(t,n,r,i,o[f])){l=Math.max(0,f-1);break}u=a.xMax;for(f=l+1;f<d;f++){m=o[f];if(h.setValue(-m.x,0,-m.z),!this._insertConePlane(t,n,r,i,h)){u=Math.max(0,f);break}}a.xMin=l,a.xMax=u,a.yMin=_,a.yMax=c}},{key:"_updatePointLightPerspective",value:function(t,n,r,i,o,s,l){var _=e._tempLightBound,u=e._tempVector30;a.transformV3ToV3(i._transform.position,r,u),u.z*=-1,this._shrinkSphereLightZPerspective(t,n,u,i.range,_)&&this._shrinkXYByRadiusPerspective(u,i.range,_,s,l)&&this._placePointLightToClusters(o,_)}},{key:"_updateSpotLightPerspective",value:function(t,n,r,i,o,s,l){var _=e._tempLightBound,u=e._tempVector30,c=e._tempVector31,h=e._tempVector34,d=i._transform.position,f=i.range;i._transform.worldMatrix.getForward(c),a.normalize(c,c),a.scale(c,f,h),a.add(d,h,h),a.transformV3ToV3(d,r,u),a.transformV3ToV3(h,r,h),u.z*=-1,h.z*=-1;var m=i.spotAngle/2*Math.PI/180;if(this._shrinkSpotLightZPerspective(t,n,u,h,f,m,_)&&this._shrinkXYByRadiusPerspective(u,f,_,s,l)){var E=e._tempVector33;E.x=h.x-u.x,E.y=h.y-u.y,E.z=h.z-u.z,a.normalize(E,E),this._shrinkSpotXYByConePerspective(u,E,f,m,_,s,l),this._placeSpotLightToClusters(o,_)}}},{key:"_updatePointLightOrth",value:function(t,n,r,i,o,s,l){var _=e._tempLightBound,u=e._tempVector30;a.transformV3ToV3(s._transform.position,o,u),u.z*=-1,this._shrinkSphereLightByBoundOrth(t,n,r,i,u,s.range,_)&&this._placePointLightToClusters(l,_)}},{key:"_updateSpotLightOrth",value:function(t,n,r,i,o,s,l){var _=e._tempLightBound,u=e._tempVector30,c=e._tempVector31,h=e._tempVector34,d=s._transform.position,f=s.range;s._transform.worldMatrix.getForward(c),a.normalize(c,c),a.scale(c,f,h),a.add(d,h,h),a.transformV3ToV3(d,o,u),a.transformV3ToV3(h,o,h),u.z*=-1,h.z*=-1;var m=s.spotAngle/2*Math.PI/180;this._shrinkSpotLightByBoundOrth(t,n,r,i,u,h,f,m,_)&&this._placeSpotLightToClusters(l,_)}},{key:"update",value:function(e,t){this._updateMark++;var n=e.nearPlane;this._depthSliceParam.x=o._config.lightClusterCount.z/Math.log2(e.farPlane/n),this._depthSliceParam.y=Math.log2(n)*this._depthSliceParam.x;var r=e.nearPlane,i=e.farPlane,a=e.viewMatrix,s=t._directionLights._length,l=t._pointLights,_=l._length,u=l._elements,c=t._spotLights,h=c._length,d=c._elements;if(e.orthographic){for(var f=e.orthographicVerticalSize/2,m=f*e.aspectRatio,E=0;E<_;E++,s++)this._updatePointLightOrth(m,f,r,i,a,u[E],s);for(E=0;E<h;E++,s++)this._updateSpotLightOrth(m,f,r,i,a,d[E],s)}else{e._updateClusterPlaneXY();var v=e._clusterXPlanes,T=e._clusterYPlanes;for(E=0;E<_;E++,s++)this._updatePointLightPerspective(r,i,a,u[E],s,v,T);for(E=0;E<h;E++,s++)this._updateSpotLightPerspective(r,i,a,d[E],s,v,T)}if(_+h>0){for(var p=this._xSlices,g=this._ySlices,y=this._zSlices,S=p*g*4,R=S*y,C=this._clusterPixels,I=C.length,A=this._clusterDatas,x=this._updateMark,D=!0,L=0;L<y;L++)for(var M=0;M<g;M++)for(var O=0;O<p;O++){var N=A[L][M][O],P=4*(O+M*p+L*p*g);if(N.updateMark!==x)C[P]=0,C[P+1]=0;else if(D){var b=N.indices,V=N.pointLightCount,k=N.spotLightCount,w=V+k;if(R+w<I){C[P]=V,C[P+1]=k,C[P+2]=Math.floor(R/S),C[P+3]=R%S;for(E=0;E<w;E++)C[R++]=b[E]}else{w=I-(R+w),V=Math.min(V,w),C[P]=V,C[P+1]=Math.min(k,w-V),C[P+2]=Math.floor(R/S),C[P+3]=R%S;for(E=0;E<w;E++)C[R++]=b[E];D=!1}}}var F=this._clusterTexture.width;this._clusterTexture.setSubPixels(0,0,F,Math.ceil(R/(4*F)),C)}}}]),e}();ye._tempVector30=new a,ye._tempVector31=new a,ye._tempVector32=new a,ye._tempVector33=new a,ye._tempVector34=new a,ye._tempVector35=new a,ye._tempVector36=new a,ye._tempVector37=new a,ye._tempLightBound=new function e(){_classCallCheck(this,e)};var Se=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;_classCallCheck(this,e),this.normal=t,this.distance=n}return _createClass(e,[{key:"normalize",value:function(){var e=this.normal.x,t=this.normal.y,n=this.normal.z,r=1/Math.sqrt(e*e+t*t+n*n);this.normal.x=e*r,this.normal.y=t*r,this.normal.z=n*r,this.distance*=r}}],[{key:"createPlaneBy3P",value:function(t,n,r){var i=n.x-t.x,a=n.y-t.y,o=n.z-t.z,s=r.x-t.x,l=r.y-t.y,_=r.z-t.z,u=a*_-o*l,c=o*s-i*_,h=i*l-a*s,d=1/Math.sqrt(u*u+c*c+h*h),f=u*d,m=c*d,E=h*d;e._TEMPVec3.x=f,e._TEMPVec3.y=m,e._TEMPVec3.z=E;var v=-(f*t.x+m*t.y+E*t.z);return new e(e._TEMPVec3,v)}}]),e}();Se._TEMPVec3=new a,Se.PlaneIntersectionType_Back=0,Se.PlaneIntersectionType_Front=1,Se.PlaneIntersectionType_Intersecting=2;var Re=function e(t,n){_classCallCheck(this,e),this.origin=t,this.direction=n},Ce=function e(){_classCallCheck(this,e)};Ce.Disjoint=0,Ce.Contains=1,Ce.Intersects=2;var Ie=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"distancePlaneToPoint",value:function(e,t){return a.dot(e.normal,t)-e.distance}},{key:"distanceBoxToPoint",value:function(e,t){var n=e.min,r=n.x,i=n.y,a=n.z,o=e.max,s=o.x,l=o.y,_=o.z,u=t.x,c=t.y,h=t.z,d=0;return u<r&&(d+=(r-u)*(r-u)),u>s&&(d+=(s-u)*(s-u)),c<i&&(d+=(i-c)*(i-c)),c>l&&(d+=(l-c)*(l-c)),h<a&&(d+=(a-h)*(a-h)),h>_&&(d+=(_-h)*(_-h)),Math.sqrt(d)}},{key:"distanceBoxToBox",value:function(e,t){var n,r=e.min,i=r.x,a=r.y,o=r.z,s=e.max,l=s.x,_=s.y,u=s.z,c=t.min,h=c.x,d=c.y,f=c.z,m=t.max,E=m.x,v=m.y,T=m.z,p=0;return i>E?p+=(n=i-E)*n:h>l&&(p+=(n=h-l)*n),a>v?p+=(n=a-v)*n:d>_&&(p+=(n=d-_)*n),o>T?p+=(n=o-T)*n:f>u&&(p+=(n=f-u)*n),Math.sqrt(p)}},{key:"distanceSphereToPoint",value:function(e,t){var n=Math.sqrt(a.distanceSquared(e.center,t));return n-=e.radius,Math.max(n,0)}},{key:"distanceSphereToSphere",value:function(e,t){var n=Math.sqrt(a.distanceSquared(e.center,t.center));return n-=e.radius+t.radius,Math.max(n,0)}},{key:"intersectsRayAndTriangleRD",value:function(t,r,i,a,o){var s=t.origin,l=s.x,_=s.y,u=s.z,c=t.direction,h=c.x,d=c.y,f=c.z,m=r.x,E=r.y,v=r.z,T=i.x,p=i.y,g=i.z,y=a.x,S=a.y,R=a.z,C=e._tempV30.x,I=e._tempV30.y,A=e._tempV30.z;C=T-m,I=p-E,A=g-v;var x=e._tempV31.x,D=e._tempV31.y,L=e._tempV31.z;x=y-m,D=S-E,L=R-v;var M=e._tempV32.x,O=e._tempV32.y,N=e._tempV32.z,P=C*(M=d*L-f*D)+I*(O=f*x-h*L)+A*(N=h*D-d*x);if(n.isZero(P))return!1;var b=1/P,V=e._tempV33.x,k=e._tempV33.y,w=e._tempV33.z,F=(V=l-m)*M+(k=_-E)*O+(w=u-v)*N;if((F*=b)<0||F>1)return!1;var B=e._tempV34.x,U=e._tempV34.y,G=e._tempV34.z,z=h*(B=k*A-w*I)+d*(U=w*C-V*A)+f*(G=V*I-k*C);if((z*=b)<0||F+z>1)return!1;var H=x*B+D*U+L*G;return!((H*=b)<0)}},{key:"intersectsRayAndTriangleRP",value:function(t,n,r,i,o){return e.intersectsRayAndTriangleRD(t,n,r,i,void 0)?(a.scale(t.direction,void 0,e._tempV30),a.add(t.origin,e._tempV30,o),!0):(o=a._ZERO,!1)}},{key:"intersectsRayAndPoint",value:function(t,r){a.subtract(t.origin,r,e._tempV30);var i=a.dot(e._tempV30,t.direction),o=a.dot(e._tempV30,e._tempV30)-n.zeroTolerance;return!(o>0&&i>0)&&!(i*i-o<0)}},{key:"intersectsRayAndRay",value:function(t,r,i){var o=t.origin,s=o.x,l=o.y,_=o.z,u=t.direction,c=u.x,h=u.y,d=u.z,f=r.origin,m=f.x,E=f.y,v=f.z,T=r.direction,p=T.x,g=T.y,y=T.z;a.cross(u,T,e._tempV30);var S=e._tempV30,R=a.scalarLength(e._tempV30);if(n.isZero(R)&&n.nearEqual(m,s)&&n.nearEqual(E,l)&&n.nearEqual(v,_))return!0;R*=R;var C=m-s,I=E-l,A=v-_,x=p,D=g,L=y,M=S.x,O=S.y,N=S.z,P=C*D*N+I*L*M+A*x*O-C*L*O-I*x*N-A*D*M;x=c,D=h,L=d;var b=P/R;a.scale(u,b,e._tempV30),a.scale(T,b,e._tempV31),a.add(o,e._tempV30,e._tempV32),a.add(f,e._tempV31,e._tempV33);var V=e._tempV32,k=e._tempV33;return!!(n.nearEqual(k.x,V.x)&&n.nearEqual(k.y,V.y)&&n.nearEqual(k.z,V.z))}},{key:"intersectsPlaneAndTriangle",value:function(t,n,r,i){var a=e.intersectsPlaneAndPoint(t,n),o=e.intersectsPlaneAndPoint(t,r),s=e.intersectsPlaneAndPoint(t,i);return a==Se.PlaneIntersectionType_Front&&o==Se.PlaneIntersectionType_Front&&s==Se.PlaneIntersectionType_Front?Se.PlaneIntersectionType_Front:a==Se.PlaneIntersectionType_Back&&o==Se.PlaneIntersectionType_Back&&s==Se.PlaneIntersectionType_Back?Se.PlaneIntersectionType_Back:Se.PlaneIntersectionType_Intersecting}},{key:"intersectsRayAndPlaneRD",value:function(e,t){var r=t.normal,i=a.dot(r,e.direction);if(Math.abs(i)<n.zeroTolerance)return-1;var o=a.dot(r,e.origin),s=(-t.distance-o)/i;if(s<0){if(s<-n.zeroTolerance)return-1;s=0}return s}},{key:"intersectsRayAndPlaneRP",value:function(t,n,r){var i=e.intersectsRayAndPlaneRD(t,n);if(-1==i)return r.setValue(0,0,0),!1;var o=e._tempV30;return a.scale(t.direction,i,o),a.add(t.origin,o,r),!0}},{key:"intersectsRayAndBoxRD",value:function(e,t){var r=e.origin,i=r.x,a=r.y,o=r.z,s=e.direction,l=s.x,_=s.y,u=s.z,c=t.min,h=c.x,d=c.y,f=c.z,m=t.max,E=m.x,v=m.y,T=m.z,p=0,g=n.MaxValue;if(n.isZero(l)){if(i<h||i>E)return-1}else{var y=1/l,S=(h-i)*y,R=(E-i)*y;if(S>R){var C=S;S=R,R=C}if((p=Math.max(S,p))>(g=Math.min(R,g)))return-1}if(n.isZero(_)){if(a<d||a>v)return-1}else{var I=1/_,A=(d-a)*I,x=(v-a)*I;if(A>x){var D=A;A=x,x=D}if((p=Math.max(A,p))>(g=Math.min(x,g)))return-1}if(n.isZero(u)){if(o<f||o>T)return-1}else{var L=1/u,M=(f-o)*L,O=(T-o)*L;if(M>O){var N=M;M=O,O=N}if((p=Math.max(M,p))>(g=Math.min(O,g)))return-1}return p}},{key:"intersectsRayAndBoxRP",value:function(t,n,r){var i=e.intersectsRayAndBoxRD(t,n);return-1===i?(a._ZERO.cloneTo(r),i):(a.scale(t.direction,i,e._tempV30),a.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(r),i)}},{key:"intersectsRayAndSphereRD",value:function(t,n){var r=n.radius;a.subtract(t.origin,n.center,e._tempV30);var i=a.dot(e._tempV30,t.direction),o=a.dot(e._tempV30,e._tempV30)-r*r;if(o>0&&i>0)return-1;var s=i*i-o;if(s<0)return-1;var l=-i-Math.sqrt(s);return l<0&&(l=0),l}},{key:"intersectsRayAndSphereRP",value:function(t,n,r){var i=e.intersectsRayAndSphereRD(t,n);return-1===i?(a._ZERO.cloneTo(r),i):(a.scale(t.direction,i,e._tempV30),a.add(t.origin,e._tempV30,e._tempV31),e._tempV31.cloneTo(r),i)}},{key:"intersectsSphereAndTriangle",value:function(t,n,r,i){var o=t.center,s=t.radius;return e.closestPointPointTriangle(o,n,r,i,e._tempV30),a.subtract(e._tempV30,o,e._tempV31),a.dot(e._tempV31,e._tempV31)<=s*s}},{key:"intersectsPlaneAndPoint",value:function(e,t){var n=a.dot(e.normal,t)+e.distance;return n>0?Se.PlaneIntersectionType_Front:n<0?Se.PlaneIntersectionType_Back:Se.PlaneIntersectionType_Intersecting}},{key:"intersectsPlaneAndPlane",value:function(t,r){a.cross(t.normal,r.normal,e._tempV30);var i=a.dot(e._tempV30,e._tempV30);return!n.isZero(i)}},{key:"intersectsPlaneAndPlaneRL",value:function(t,r,i){var o=t.normal,s=r.normal;a.cross(o,s,e._tempV34);var l=a.dot(e._tempV34,e._tempV34);return!n.isZero(l)&&(a.scale(s,t.distance,e._tempV30),a.scale(o,r.distance,e._tempV31),a.subtract(e._tempV30,e._tempV31,e._tempV32),a.cross(e._tempV32,e._tempV34,e._tempV33),a.normalize(e._tempV34,e._tempV34),!0)}},{key:"intersectsPlaneAndBox",value:function(t,n){var r=t.distance,i=t.normal,o=i.x,s=i.y,l=i.z,_=n.min,u=_.x,c=_.y,h=_.z,d=n.max,f=d.x,m=d.y,E=d.z;e._tempV30.x=o>0?u:f,e._tempV30.y=s>0?c:m,e._tempV30.z=l>0?h:E,e._tempV31.x=o>0?f:u,e._tempV31.y=s>0?m:c,e._tempV31.z=l>0?E:h;var v=a.dot(i,e._tempV30);return v+r>0?Se.PlaneIntersectionType_Front:(v=a.dot(i,e._tempV31))+r<0?Se.PlaneIntersectionType_Back:Se.PlaneIntersectionType_Intersecting}},{key:"intersectsPlaneAndSphere",value:function(e,t){var n=t.radius,r=a.dot(e.normal,t.center)+e.distance;return r>n?Se.PlaneIntersectionType_Front:r<-n?Se.PlaneIntersectionType_Back:Se.PlaneIntersectionType_Intersecting}},{key:"intersectsBoxAndBox",value:function(e,t){var n=e.min,r=e.max,i=t.min,a=t.max;return!(n.x>a.x||i.x>r.x)&&(!(n.y>a.y||i.y>r.y)&&!(n.z>a.z||i.z>r.z))}},{key:"intersectsBoxAndSphere",value:function(t,n){var r=n.center,i=n.radius;return a.Clamp(r,t.min,t.max,e._tempV30),a.distanceSquared(r,e._tempV30)<=i*i}},{key:"intersectsSphereAndSphere",value:function(e,t){var n=e.radius+t.radius;return a.distanceSquared(e.center,t.center)<=n*n}},{key:"boxContainsPoint",value:function(e,t){var n=e.min,r=e.max;return n.x<=t.x&&r.x>=t.x&&n.y<=t.y&&r.y>=t.y&&n.z<=t.z&&r.z>=t.z?Ce.Contains:Ce.Disjoint}},{key:"boxContainsBox",value:function(e,t){var n=e.min,r=n.x,i=n.y,a=n.z,o=e.max,s=o.x,l=o.y,_=o.z,u=t.min,c=u.x,h=u.y,d=u.z,f=t.max,m=f.x,E=f.y,v=f.z;return s<c||r>m?Ce.Disjoint:l<h||i>E?Ce.Disjoint:_<d||a>v?Ce.Disjoint:r<=c&&m<=s&&i<=h&&E<=l&&a<=d&&v<=_?Ce.Contains:Ce.Intersects}},{key:"boxContainsSphere",value:function(t,n){var r=t.min,i=r.x,o=r.y,s=r.z,l=t.max,_=l.x,u=l.y,c=l.z,h=n.center,d=h.x,f=h.y,m=h.z,E=n.radius;return a.Clamp(h,r,l,e._tempV30),a.distanceSquared(h,e._tempV30)>E*E?Ce.Disjoint:i+E<=d&&d<=_-E&&_-i>E&&o+E<=f&&f<=u-E&&u-o>E&&s+E<=m&&m<=c-E&&c-s>E?Ce.Contains:Ce.Intersects}},{key:"sphereContainsPoint",value:function(e,t){return a.distanceSquared(t,e.center)<=e.radius*e.radius?Ce.Contains:Ce.Disjoint}},{key:"sphereContainsTriangle",value:function(t,n,r,i){var a=e.sphereContainsPoint(t,n),o=e.sphereContainsPoint(t,r),s=e.sphereContainsPoint(t,i);return a==Ce.Contains&&o==Ce.Contains&&s==Ce.Contains?Ce.Contains:e.intersectsSphereAndTriangle(t,n,r,i)?Ce.Intersects:Ce.Disjoint}},{key:"sphereContainsBox",value:function(t,n){var r=t.center,i=r.x,o=r.y,s=r.z,l=t.radius,_=n.min,u=_.x,c=_.y,h=_.z,d=n.max,f=d.x,m=d.y,E=d.z,v=e._tempV30;v.x,v.y,v.z;if(!e.intersectsBoxAndSphere(n,t))return Ce.Disjoint;var T=l*l;return i-u,o-m,s-E,a.scalarLengthSquared(e._tempV30)>T?Ce.Intersects:(i-f,o-m,s-E,a.scalarLengthSquared(e._tempV30)>T?Ce.Intersects:(i-f,o-c,s-E,a.scalarLengthSquared(e._tempV30)>T?Ce.Intersects:(i-u,o-c,s-E,a.scalarLengthSquared(e._tempV30)>T?Ce.Intersects:(i-u,o-m,s-h,a.scalarLengthSquared(e._tempV30)>T?Ce.Intersects:(i-f,o-m,s-h,a.scalarLengthSquared(e._tempV30)>T?Ce.Intersects:(i-f,o-c,s-h,a.scalarLengthSquared(e._tempV30)>T?Ce.Intersects:(i-u,o-c,s-h,a.scalarLengthSquared(e._tempV30)>T?Ce.Intersects:Ce.Contains)))))))}},{key:"sphereContainsSphere",value:function(e,t){var n=e.radius,r=t.radius,i=a.distance(e.center,t.center);return n+r<i?Ce.Disjoint:n-r<i?Ce.Intersects:Ce.Contains}},{key:"closestPointPointTriangle",value:function(t,n,r,i,o){a.subtract(r,n,e._tempV30),a.subtract(i,n,e._tempV31),a.subtract(t,n,e._tempV32),a.subtract(t,r,e._tempV33),a.subtract(t,i,e._tempV34);var s=a.dot(e._tempV30,e._tempV32),l=a.dot(e._tempV31,e._tempV32),_=a.dot(e._tempV30,e._tempV33),u=a.dot(e._tempV31,e._tempV33),c=a.dot(e._tempV30,e._tempV34),h=a.dot(e._tempV31,e._tempV34);if(s<=0&&l<=0)n.cloneTo(o);else if(_>=0&&u<=_)r.cloneTo(o);else{var d=s*u-_*l;if(d<=0&&s>=0&&_<=0){var f=s/(s-_);return a.scale(e._tempV30,f,o),void a.add(n,o,o)}if(h>=0&&c<=h)i.cloneTo(o);else{var m=c*l-s*h;if(m<=0&&l>=0&&h<=0){var E=l/(l-h);return a.scale(e._tempV31,E,o),void a.add(n,o,o)}var v=_*h-c*u;if(v<=0&&u-_>=0&&c-h>=0){var T=(u-_)/(u-_+(c-h));return a.subtract(i,r,o),a.scale(o,T,o),void a.add(r,o,o)}var p=1/(v+m+d),g=m*p,y=d*p;a.scale(e._tempV30,g,e._tempV35),a.scale(e._tempV31,y,e._tempV36),a.add(e._tempV35,e._tempV36,o),a.add(n,o,o)}}}},{key:"closestPointPlanePoint",value:function(t,n,r){var i=t.normal,o=a.dot(i,n)-t.distance;a.scale(i,o,e._tempV30),a.subtract(n,e._tempV30,r)}},{key:"closestPointBoxPoint",value:function(t,n,r){a.max(n,t.min,e._tempV30),a.min(e._tempV30,t.max,r)}},{key:"closestPointSpherePoint",value:function(e,t,n){var r=e.center;a.subtract(t,r,n),a.normalize(n,n),a.scale(n,e.radius,n),a.add(n,r,n)}},{key:"closestPointSphereSphere",value:function(e,t,n){var r=e.center;a.subtract(t.center,r,n),a.normalize(n,n),a.scale(n,e.radius,n),a.add(n,r,n)}}]),e}();Ie._tempV30=new a,Ie._tempV31=new a,Ie._tempV32=new a,Ie._tempV33=new a,Ie._tempV34=new a,Ie._tempV35=new a,Ie._tempV36=new a;var Ae=function(){function e(t){_classCallCheck(this,e),this._matrix=t,this._near=new Se(new a),this._far=new Se(new a),this._left=new Se(new a),this._right=new Se(new a),this._top=new Se(new a),this._bottom=new Se(new a),e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}return _createClass(e,[{key:"equalsBoundFrustum",value:function(e){return this._matrix.equalsOtherMatrix(e.matrix)}},{key:"equalsObj",value:function(t){if(t instanceof e){var n=t;return this.equalsBoundFrustum(n)}return!1}},{key:"getPlane",value:function(e){switch(e){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}}},{key:"getCorners",value:function(t){e._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(t[0]),e._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(t[1]),e._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(t[2]),e._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(t[3]),e._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(t[4]),e._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(t[5]),e._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(t[6]),e._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(t[7])}},{key:"containsPoint",value:function(e){for(var t=Se.PlaneIntersectionType_Front,n=Se.PlaneIntersectionType_Front,r=0;r<6;r++){switch(r){case 0:n=Ie.intersectsPlaneAndPoint(this._near,e);break;case 1:n=Ie.intersectsPlaneAndPoint(this._far,e);break;case 2:n=Ie.intersectsPlaneAndPoint(this._left,e);break;case 3:n=Ie.intersectsPlaneAndPoint(this._right,e);break;case 4:n=Ie.intersectsPlaneAndPoint(this._top,e);break;case 5:n=Ie.intersectsPlaneAndPoint(this._bottom,e)}switch(n){case Se.PlaneIntersectionType_Back:return Ce.Disjoint;case Se.PlaneIntersectionType_Intersecting:t=Se.PlaneIntersectionType_Intersecting}}switch(t){case Se.PlaneIntersectionType_Intersecting:return Ce.Intersects;default:return Ce.Contains}}},{key:"intersects",value:function(e){var t=e.min,n=e.max,r=t.x,i=t.y,a=t.z,o=n.x,s=n.y,l=n.z,_=this._near.normal;if(this._near.distance+_.x*(_.x<0?r:o)+_.y*(_.y<0?i:s)+_.z*(_.z<0?a:l)<0)return!1;var u=this._left.normal;if(this._left.distance+u.x*(u.x<0?r:o)+u.y*(u.y<0?i:s)+u.z*(u.z<0?a:l)<0)return!1;var c=this._right.normal;if(this._right.distance+c.x*(c.x<0?r:o)+c.y*(c.y<0?i:s)+c.z*(c.z<0?a:l)<0)return!1;var h=this._bottom.normal;if(this._bottom.distance+h.x*(h.x<0?r:o)+h.y*(h.y<0?i:s)+h.z*(h.z<0?a:l)<0)return!1;var d=this._top.normal;if(this._top.distance+d.x*(d.x<0?r:o)+d.y*(d.y<0?i:s)+d.z*(d.z<0?a:l)<0)return!1;var f=this._far.normal;return!(this._far.distance+f.x*(f.x<0?r:o)+f.y*(f.y<0?i:s)+f.z*(f.z<0?a:l)<0)}},{key:"containsBoundBox",value:function(t){for(var n=e._tempV30,r=e._tempV31,i=t.min,a=t.max,o=Ce.Contains,s=0;s<6;s++){var l=this.getPlane(s),_=l.normal;if(_.x>=0?(n.x=a.x,r.x=i.x):(n.x=i.x,r.x=a.x),_.y>=0?(n.y=a.y,r.y=i.y):(n.y=i.y,r.y=a.y),_.z>=0?(n.z=a.z,r.z=i.z):(n.z=i.z,r.z=a.z),Ie.intersectsPlaneAndPoint(l,n)===Se.PlaneIntersectionType_Back)return Ce.Disjoint;Ie.intersectsPlaneAndPoint(l,r)===Se.PlaneIntersectionType_Back&&(o=Ce.Intersects)}return o}},{key:"containsBoundSphere",value:function(e){for(var t=Se.PlaneIntersectionType_Front,n=Se.PlaneIntersectionType_Front,r=0;r<6;r++){switch(r){case 0:n=Ie.intersectsPlaneAndSphere(this._near,e);break;case 1:n=Ie.intersectsPlaneAndSphere(this._far,e);break;case 2:n=Ie.intersectsPlaneAndSphere(this._left,e);break;case 3:n=Ie.intersectsPlaneAndSphere(this._right,e);break;case 4:n=Ie.intersectsPlaneAndSphere(this._top,e);break;case 5:n=Ie.intersectsPlaneAndSphere(this._bottom,e)}switch(n){case Se.PlaneIntersectionType_Back:return Ce.Disjoint;case Se.PlaneIntersectionType_Intersecting:t=Se.PlaneIntersectionType_Intersecting}}switch(t){case Se.PlaneIntersectionType_Intersecting:return Ce.Intersects;default:return Ce.Contains}}},{key:"matrix",get:function(){return this._matrix},set:function(t){this._matrix=t,e._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}},{key:"near",get:function(){return this._near}},{key:"far",get:function(){return this._far}},{key:"left",get:function(){return this._left}},{key:"right",get:function(){return this._right}},{key:"top",get:function(){return this._top}},{key:"bottom",get:function(){return this._bottom}}],[{key:"_getPlanesFromMatrix",value:function(e,t,n,r,i,a,o){var s=e.elements,l=s[0],_=s[1],u=s[2],c=s[3],h=s[4],d=s[5],f=s[6],m=s[7],E=s[8],v=s[9],T=s[10],p=s[11],g=s[12],y=s[13],S=s[14],R=s[15],C=t.normal;C.x=c+u,C.y=m+f,C.z=p+T,t.distance=R+S,t.normalize();var I=n.normal;I.x=c-u,I.y=m-f,I.z=p-T,n.distance=R-S,n.normalize();var A=r.normal;A.x=c+l,A.y=m+h,A.z=p+E,r.distance=R+g,r.normalize();var x=i.normal;x.x=c-l,x.y=m-h,x.z=p-E,i.distance=R-g,i.normalize();var D=a.normal;D.x=c-_,D.y=m-d,D.z=p-v,a.distance=R-y,a.normalize();var L=o.normal;L.x=c+_,L.y=m+d,L.z=p+v,o.distance=R+y,o.normalize()}},{key:"_get3PlaneInterPoint",value:function(t,n,r){var i=t.normal,o=n.normal,s=r.normal;a.cross(o,s,e._tempV30),a.cross(s,i,e._tempV31),a.cross(i,o,e._tempV32);var l=a.dot(i,e._tempV30),_=a.dot(o,e._tempV31),u=a.dot(s,e._tempV32);return a.scale(e._tempV30,-t.distance/l,e._tempV33),a.scale(e._tempV31,-n.distance/_,e._tempV34),a.scale(e._tempV32,-r.distance/u,e._tempV35),a.add(e._tempV33,e._tempV34,e._tempV36),a.add(e._tempV35,e._tempV36,e._tempV37),e._tempV37}}]),e}();Ae._tempV30=new a,Ae._tempV31=new a,Ae._tempV32=new a,Ae._tempV33=new a,Ae._tempV34=new a,Ae._tempV35=new a,Ae._tempV36=new a,Ae._tempV37=new a;var xe=function(){function e(t,n,r,i){_classCallCheck(this,e),this.minDepth=0,this.maxDepth=1,this.x=t,this.y=n,this.width=r,this.height=i}return _createClass(e,[{key:"project",value:function(e,t,n){var r=e.x,i=e.y,o=e.z;a.transformV3ToV3(e,t,n);var s=t.elements,l=r*s[3]+i*s[7]+o*s[11]+s[15];1!==l&&(n.x=n.x/l,n.y=n.y/l,n.z=n.z/l),n.x=.5*(n.x+1)*this.width+this.x,n.y=.5*(1-n.y)*this.height+this.y,n.z=n.z*(this.maxDepth-this.minDepth)+this.minDepth}},{key:"unprojectFromMat",value:function(e,t,n){var r=t.elements;n.x=(e.x-this.x)/this.width*2-1,n.y=-((e.y-this.y)/this.height*2-1);var i=(this.maxDepth-this.minDepth)/2;n.z=(e.z-this.minDepth-i)/i;var o=n.x*r[3]+n.y*r[7]+n.z*r[11]+r[15];a.transformV3ToV3(n,t,n),1!==o&&(n.x=n.x/o,n.y=n.y/o,n.z=n.z/o)}},{key:"unprojectFromWVP",value:function(t,n,r,i,a){T.multiply(n,r,e._tempMatrix4x4),i&&T.multiply(e._tempMatrix4x4,i,e._tempMatrix4x4),e._tempMatrix4x4.invert(e._tempMatrix4x4),this.unprojectFromMat(t,e._tempMatrix4x4,a)}},{key:"cloneTo",value:function(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e.minDepth=this.minDepth,e.maxDepth=this.maxDepth}}]),e}();xe._tempMatrix4x4=new T;var De=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"calculateCursorRay",value:function(t,n,r,i,o,s){var l=t.x,_=t.y,u=e._tempVector30,c=u;c.x=l,c.y=_,c.z=n.minDepth;var h=e._tempVector31,d=h;d.x=l,d.y=_,d.z=n.maxDepth;var f=s.origin,m=e._tempVector32;n.unprojectFromWVP(u,r,i,o,f),n.unprojectFromWVP(h,r,i,o,m);var E=s.direction;E.x=m.x-f.x,E.y=m.y-f.y,E.z=m.z-f.z,a.normalize(s.direction,s.direction)}},{key:"rayIntersectsTriangle",value:function(t,n,r,i){var o=e._tempVector30,s=e._tempVector31;a.subtract(r,n,o),a.subtract(i,n,s);var l,_=e._tempVector32;if(a.cross(t.direction,s,_),(l=a.dot(o,_))>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return Number.NaN;var u,c=1/l,h=e._tempVector33;if(a.subtract(t.origin,n,h),u=a.dot(h,_),(u*=c)<0||u>1)return Number.NaN;var d,f,m=e._tempVector34;return a.cross(h,o,m),d=a.dot(t.direction,m),(d*=c)<0||u+d>1?Number.NaN:(f=a.dot(s,m),(f*=c)<0?Number.NaN:f)}}]),e}();De._tempVector30=new a,De._tempVector31=new a,De._tempVector32=new a,De._tempVector33=new a,De._tempVector34=new a;var Le,Me=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"supportTextureFormat",value:function(e){switch(e){case t.TextureFormat.R32G32B32A32:return!(!t.LayaGL.layaGPUInstance._isWebGL2&&!t.LayaGL.layaGPUInstance._oesTextureFloat);default:return!0}}},{key:"supportRenderTextureFormat",value:function(e){switch(e){case t.RenderTextureFormat.R16G16B16A16:return!!(t.LayaGL.layaGPUInstance._isWebGL2||t.LayaGL.layaGPUInstance._oesTextureHalfFloat&&t.LayaGL.layaGPUInstance._oesTextureHalfFloatLinear);default:return!0}}}]),e}(),Oe=function(e){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this))}return _inherits(n,t.BufferStateBase),_createClass(n,[{key:"applyVertexBuffer",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var n=t.LayaGL.instance,r=e.vertexDeclaration,i=r._shaderValues.getData();for(var a in this.vertexDeclaration=r,e.bind(),i){var o=parseInt(a),s=i[a];n.enableVertexAttribArray(o),n.vertexAttribPointer(o,s[0],s[1],!!s[2],s[3],s[4])}}},{key:"applyVertexBuffers",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";for(var n=t.LayaGL.instance,r=0,i=e.length;r<i;r++){var a=e[r],o=a.vertexDeclaration._shaderValues.getData();for(var s in a.bind(),o){var l=parseInt(s),_=o[s];n.enableVertexAttribArray(l),n.vertexAttribPointer(l,_[0],_[1],!!_[2],_[3],_[4])}}}},{key:"applyInstanceVertexBuffer",value:function(e){if(t.LayaGL.layaGPUInstance.supportInstance()){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var n=t.LayaGL.instance,r=e.vertexDeclaration._shaderValues.getData();for(var i in e.bind(),r){var a=parseInt(i),o=r[i];n.enableVertexAttribArray(a),n.vertexAttribPointer(a,o[0],o[1],!!o[2],o[3],o[4]),t.LayaGL.layaGPUInstance.vertexAttribDivisor(a,1)}}}},{key:"applyIndexBuffer",value:function(e){if(t.BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._bindForVAO(),this._bindedIndexBuffer=e)}}]),n}();(Le=e.IndexFormat||(e.IndexFormat={}))[Le.UInt8=0]="UInt8",Le[Le.UInt16=1]="UInt16",Le[Le.UInt32=2]="UInt32";var Ne=function(n){function r(n,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:35044,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];_classCallCheck(this,r);var s=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));switch(s._indexType=n,s._indexCount=i,s._bufferUsage=a,s._bufferType=t.LayaGL.instance.ELEMENT_ARRAY_BUFFER,s._canRead=o,n){case e.IndexFormat.UInt32:s._indexTypeByteCount=4;break;case e.IndexFormat.UInt16:s._indexTypeByteCount=2;break;case e.IndexFormat.UInt8:s._indexTypeByteCount=1;break;default:throw new Error("unidentification index type.")}var l=s._indexTypeByteCount*i,_=t.BufferStateBase._curBindedBufferState;if(s._byteLength=l,_?_._bindedIndexBuffer===s?t.LayaGL.instance.bufferData(s._bufferType,l,s._bufferUsage):(_.unBind(),s.bind(),t.LayaGL.instance.bufferData(s._bufferType,l,s._bufferUsage),_.bind()):(s.bind(),t.LayaGL.instance.bufferData(s._bufferType,l,s._bufferUsage)),o)switch(n){case e.IndexFormat.UInt32:s._buffer=new Uint32Array(i);break;case e.IndexFormat.UInt16:s._buffer=new Uint16Array(i);break;case e.IndexFormat.UInt8:s._buffer=new Uint8Array(i)}return s}return _inherits(r,t.Buffer),_createClass(r,[{key:"indexType",get:function(){return this._indexType}},{key:"indexTypeByteCount",get:function(){return this._indexTypeByteCount}},{key:"indexCount",get:function(){return this._indexCount}},{key:"canRead",get:function(){return this._canRead}}]),_createClass(r,[{key:"_bindForVAO",value:function(){if(!t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must bind current BufferState.";var e=t.LayaGL.instance;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer)}},{key:"bind",value:function(){if(t.BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must unbind current BufferState.";if(t.Buffer._bindedIndexBuffer!==this._glBuffer){var e=t.LayaGL.instance;return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer),t.Buffer._bindedIndexBuffer=this._glBuffer,!0}return!1}},{key:"setData",value:function(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4294967295,o=this._indexTypeByteCount;if(0!==i||4294967295!==a)switch(this._indexType){case e.IndexFormat.UInt32:n=new Uint32Array(n.buffer,i*o,a);break;case e.IndexFormat.UInt16:n=new Uint16Array(n.buffer,i*o,a);break;case e.IndexFormat.UInt8:n=new Uint8Array(n.buffer,i*o,a)}var s=t.BufferStateBase._curBindedBufferState;if(s?s._bindedIndexBuffer===this?t.LayaGL.instance.bufferSubData(this._bufferType,r*o,n):(s.unBind(),this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,r*o,n),s.bind()):(this.bind(),t.LayaGL.instance.bufferSubData(this._bufferType,r*o,n)),this._canRead)if(0!==r||0!==i||4294967295!==a){var l=this._buffer.length-r;a>l&&(a=l);for(var _=0;_<a;_++)this._buffer[r+_]=n[_]}else this._buffer=n}},{key:"getData",value:function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")}},{key:"destroy",value:function(){_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"destroy",this).call(this),this._buffer=null}}]),r}(),Pe=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"_render",value:function(e){}}]),e}(),be=function(n){function r(){_classCallCheck(this,r);var n=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this)),i=t.LayaGL.instance,a=new Float32Array([-1,1,-1,1,1,-1,1,1,1,-1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1]),o=new Uint8Array([0,1,2,2,3,0,4,7,6,6,5,4,0,3,7,7,4,0,1,5,6,6,2,1,3,2,6,6,7,3,0,4,5,5,1,0]),s=Te.getVertexDeclaration("POSITION");n._vertexBuffer=new fe(8*s.vertexStride,i.STATIC_DRAW,!1),n._vertexBuffer.vertexDeclaration=s,n._indexBuffer=new Ne(e.IndexFormat.UInt8,36,i.STATIC_DRAW,!1),n._vertexBuffer.setData(a.buffer),n._indexBuffer.setData(o);var l=new Oe;return l.bind(),l.applyVertexBuffer(n._vertexBuffer),l.applyIndexBuffer(n._indexBuffer),l.unBind(),n._bufferState=l,n}return _inherits(r,Pe),_createClass(r,null,[{key:"__init__",value:function(){r.instance=new r}}]),_createClass(r,[{key:"_render",value:function(e){var n=t.LayaGL.instance;n.drawElements(n.TRIANGLES,36,n.UNSIGNED_BYTE,0),t.Stat.trianglesFaces+=12,t.Stat.renderBatches++}}]),r}(),Ve=function(){function e(){_classCallCheck(this,e),this._mesh=be.instance}return _createClass(e,[{key:"_isAvailable",value:function(){return!(!this._material||!this._mesh)}},{key:"_render",value:function(n){if(this._material&&this._mesh){var r=t.LayaGL.instance,i=n.scene,o=n.camera,s=G._SET_RUNTIME_VALUE_MODE_REFERENCE_;t.ILaya.Render.supportWebGLPlusRendering&&G.setRuntimeValueMode(!1),t.WebGLContext.setCullFace(r,!1),t.WebGLContext.setDepthFunc(r,r.LEQUAL),t.WebGLContext.setDepthMask(r,!1);var l=e._compileDefine;this._material._shaderValues._defineDatas.cloneTo(l);var _=n.shader=this._material._shader.getSubShaderAt(0)._passes[0].withCompile(l),u=_.bind(),c=t.Stat.loopCount!==_._uploadMark,h=_._uploadScene!==i||c;(h||u)&&(_.uploadUniforms(_._sceneUniformParamsMap,i._shaderValues,h),_._uploadScene=i);o._getRenderTexture();var d=_._uploadCamera!==o||c;if(d||u){var f=e._tempMatrix0,m=e._tempMatrix1;o.viewMatrix.cloneTo(f),o.projectionMatrix.cloneTo(m),f.setTranslationVector(a._ZERO),o.orthographic&&T.createPerspective(o.fieldOfView,o.aspectRatio,o.nearPlane,o.farPlane,m);var E=1/Math.tan(3.1416*o.fieldOfView/180*.5);m.elements[0]=E/o.aspectRatio,m.elements[5]=E,m.elements[10]=1e-6-1,m.elements[11]=-1,m.elements[14]=-0,o._applyViewProject(n,f,m),_.uploadUniforms(_._cameraUniformParamsMap,o._shaderValues,d),_._uploadCamera=o}var v=_._uploadMaterial!==this._material||c;(v||u)&&(_.uploadUniforms(_._materialUniformParamsMap,this._material._shaderValues,v),_._uploadMaterial=this._material),this._mesh._bufferState.bind(),this._mesh._render(n),t.ILaya.Render.supportWebGLPlusRendering&&G.setRuntimeValueMode(s),t.WebGLContext.setDepthFunc(r,r.LESS),t.WebGLContext.setDepthMask(r,!0),o._applyViewProject(n,o.viewMatrix,o.projectionMatrix)}}},{key:"destroy",value:function(){this._material&&(this._material._removeReference(),this._material=null)}},{key:"material",get:function(){return this._material},set:function(e){this._material!==e&&(this._material&&this._material._removeReference(),e&&e._addReference(),this._material=e)}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e)}}]),e}();Ve._tempMatrix0=new T,Ve._tempMatrix1=new T,Ve._compileDefine=new k;var ke=function(e){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r._skyRenderer=new Ve,r._forward=new a,r._up=new a,r.clearColor=new i(100/255,149/255,237/255,1),r._shaderValues=new G(null),r._fieldOfView=60,r._useUserProjectionMatrix=!1,r._orthographic=!1,r._orthographicVerticalSize=10,r.renderingOrder=0,r._nearPlane=e,r._farPlane=t,r.cullingMask=2147483647,r.useOcclusionCulling=!0,r}return _inherits(n,le),_createClass(n,[{key:"_sortCamerasByRenderingOrder",value:function(){if(this.displayedInStage)for(var e=this.scene._cameraPool,t=e.length-1,n=0;n<t;n++)if(e[n].renderingOrder>e[t].renderingOrder){var r=e[n];e[n]=e[t],e[t]=r}}},{key:"_calculateProjectionMatrix",value:function(){}},{key:"_onScreenSizeChanged",value:function(){this._calculateProjectionMatrix()}},{key:"_prepareCameraToRender",value:function(){var e=this._shaderValues;this.transform.getForward(this._forward),this.transform.getUp(this._up),e.setVector3(n.CAMERAPOS,this.transform.position),e.setVector3(n.CAMERADIRECTION,this._forward),e.setVector3(n.CAMERAUP,this._up)}},{key:"render",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1]}},{key:"addLayer",value:function(e){this.cullingMask|=Math.pow(2,e)}},{key:"removeLayer",value:function(e){this.cullingMask&=~Math.pow(2,e)}},{key:"addAllLayers",value:function(){this.cullingMask=2147483647}},{key:"removeAllLayers",value:function(){this.cullingMask=0}},{key:"resetProjectionMatrix",value:function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()}},{key:"_onActive",value:function(){this._scene._addCamera(this),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onActive",this).call(this)}},{key:"_onInActive",value:function(){this._scene._removeCamera(this),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onInActive",this).call(this)}},{key:"_parse",value:function(e,r){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_parse",this).call(this,e,r),this.orthographic=e.orthographic,void 0!==e.orthographicVerticalSize&&(this.orthographicVerticalSize=e.orthographicVerticalSize),void 0!==e.fieldOfView&&(this.fieldOfView=e.fieldOfView),this.nearPlane=e.nearPlane,this.farPlane=e.farPlane;var a=e.clearColor;this.clearColor=new i(a[0],a[1],a[2],a[3]);var o=e.skyboxMaterial;o&&(this._skyRenderer.material=t.Loader.getRes(o.path))}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._skyRenderer.destroy(),this._skyRenderer=null,t.Laya.stage.off(t.Event.RESIZE,this,this._onScreenSizeChanged),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this,e)}},{key:"_create",value:function(){return new n}},{key:"skyRenderer",get:function(){return this._skyRenderer}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._calculateProjectionMatrix()}},{key:"nearPlane",get:function(){return this._nearPlane},set:function(e){this._nearPlane=e,this._calculateProjectionMatrix()}},{key:"farPlane",get:function(){return this._farPlane},set:function(e){this._farPlane=e,this._calculateProjectionMatrix()}},{key:"orthographic",get:function(){return this._orthographic},set:function(e){this._orthographic=e,this._calculateProjectionMatrix()}},{key:"orthographicVerticalSize",get:function(){return this._orthographicVerticalSize},set:function(e){this._orthographicVerticalSize=e,this._calculateProjectionMatrix()}},{key:"renderingOrder",get:function(){return this._renderingOrder},set:function(e){this._renderingOrder=e,this._sortCamerasByRenderingOrder()}}]),n}();ke._tempMatrix4x40=new T,ke.CAMERAPOS=U.propertyNameToID("u_CameraPos"),ke.VIEWMATRIX=U.propertyNameToID("u_View"),ke.PROJECTMATRIX=U.propertyNameToID("u_Projection"),ke.VIEWPROJECTMATRIX=U.propertyNameToID("u_ViewProjection"),ke.CAMERADIRECTION=U.propertyNameToID("u_CameraDirection"),ke.CAMERAUP=U.propertyNameToID("u_CameraUp"),ke.VIEWPORT=U.propertyNameToID("u_Viewport"),ke.PROJECTION_PARAMS=U.propertyNameToID("u_ProjectionParams"),ke.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",ke.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",ke._invertYScaleMatrix=new T(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),ke._invertYProjectionMatrix=new T,ke._invertYProjectionViewMatrix=new T,ke.CLEARFLAG_SOLIDCOLOR=0,ke.CLEARFLAG_SKY=1,ke.CLEARFLAG_DEPTHONLY=2,ke.CLEARFLAG_NONE=3;var we=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));e._bufferState=new Oe,e._bufferStateInvertUV=new Oe;var r=t.LayaGL.instance;return e._vertexBuffer=new fe(64,r.STATIC_DRAW,!1),e._vertexBuffer.vertexDeclaration=n._vertexDeclaration,e._vertexBuffer.setData(n._vertices.buffer),e._bufferState.bind(),e._bufferState.applyVertexBuffer(e._vertexBuffer),e._bufferState.unBind(),e._vertexBufferInvertUV=new fe(64,r.STATIC_DRAW,!1),e._vertexBufferInvertUV.vertexDeclaration=n._vertexDeclaration,e._vertexBufferInvertUV.setData(n._verticesInvertUV.buffer),e._bufferStateInvertUV.bind(),e._bufferStateInvertUV.applyVertexBuffer(e._vertexBufferInvertUV),e._bufferStateInvertUV.unBind(),e._setGPUMemory(e._vertexBuffer._byteLength+e._vertexBufferInvertUV._byteLength),e}return _inherits(n,t.Resource),_createClass(n,[{key:"render",value:function(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}},{key:"renderInvertUV",value:function(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLE_STRIP,0,4),t.Stat.renderBatches++}},{key:"destroy",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}],[{key:"__init__",value:function(){n._vertexDeclaration=new Ee(16,[new ve(0,me.Vector4,n.SCREENQUAD_POSITION_UV)]),n.instance=new n,n.instance.lock=!0}}]),n}();we.SCREENQUAD_POSITION_UV=0,we._vertices=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),we._verticesInvertUV=new Float32Array([1,1,1,0,1,-1,1,1,-1,1,0,0,-1,-1,0,1]);var Fe=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));e._bufferState=new Oe,e._bufferStateInvertUV=new Oe;var r=t.LayaGL.instance;return e._vertexBuffer=new fe(48,r.STATIC_DRAW,!1),e._vertexBuffer.vertexDeclaration=n._vertexDeclaration,e._vertexBuffer.setData(n._vertices.buffer),e._bufferState.bind(),e._bufferState.applyVertexBuffer(e._vertexBuffer),e._bufferState.unBind(),e._vertexBufferInvertUV=new fe(48,r.STATIC_DRAW,!1),e._vertexBufferInvertUV.vertexDeclaration=n._vertexDeclaration,e._vertexBufferInvertUV.setData(n._verticesInvertUV.buffer),e._bufferStateInvertUV.bind(),e._bufferStateInvertUV.applyVertexBuffer(e._vertexBufferInvertUV),e._bufferStateInvertUV.unBind(),e._setGPUMemory(e._vertexBuffer._byteLength+e._vertexBufferInvertUV._byteLength),e}return _inherits(n,t.Resource),_createClass(n,[{key:"render",value:function(){var e=t.LayaGL.instance;this._bufferState.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}},{key:"renderInvertUV",value:function(){var e=t.LayaGL.instance;this._bufferStateInvertUV.bind(),e.drawArrays(e.TRIANGLES,0,3),t.Stat.renderBatches++}},{key:"destroy",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferStateInvertUV.destroy(),this._vertexBufferInvertUV.destroy(),this._setGPUMemory(0)}}],[{key:"__init__",value:function(){n._vertexDeclaration=new Ee(16,[new ve(0,me.Vector4,n.SCREENTRIANGLE_POSITION_UV)]),n.instance=new n,n.instance.lock=!0}}]),n}();Fe.SCREENTRIANGLE_POSITION_UV=0,Fe._vertices=new Float32Array([-1,-1,0,0,-1,3,0,2,3,-1,2,0]),Fe._verticesInvertUV=new Float32Array([-1,-1,0,1,-1,3,0,-1,3,-1,2,1]);var Be=function(){function e(){_classCallCheck(this,e),this._commandBuffer=null}return _createClass(e,[{key:"run",value:function(){}},{key:"recover",value:function(){this._commandBuffer=null}}],[{key:"__init__",value:function(){e._screenShaderData=new G,e._screenShader=U.find("BlitScreen")}}]),e}();Be.SCREENTEXTURE_NAME="u_MainTex",Be.SCREENTEXTUREOFFSETSCALE_NAME="u_OffsetScale",Be.MAINTEXTURE_TEXELSIZE_NAME="u_MainTex_TexelSize",Be.SCREENTEXTURE_ID=U.propertyNameToID(Be.SCREENTEXTURE_NAME),Be.SCREENTEXTUREOFFSETSCALE_ID=U.propertyNameToID(Be.SCREENTEXTUREOFFSETSCALE_NAME),Be.MAINTEXTURE_TEXELSIZE_ID=U.propertyNameToID(Be.MAINTEXTURE_TEXELSIZE_NAME);var Ue=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e._source=null,e._dest=null,e._offsetScale=null,e._shader=null,e._shaderData=null,e._subShader=0,e._sourceTexelSize=new i,e._screenType=0,e}return _inherits(n,Be),_createClass(n,[{key:"run",value:function(){var e=this._shader||Be._screenShader,r=this._shaderData||Be._screenShaderData,i=this._dest;t.LayaGL.instance.viewport(0,0,i?i.width:b.clientWidth,i?i.height:b.clientHeight),r.setTexture(Be.SCREENTEXTURE_ID,this._source),r.setVector(Be.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale||n._defaultOffsetScale),this._sourceTexelSize.setValue(1/this._source.width,1/this._source.height,this._source.width,this._source.height),r.setVector(Be.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),i&&i._start();for(var a=e.getSubShaderAt(this._subShader)._passes,o=0,s=a.length;o<s;o++){var l=n._compileDefine;r._defineDatas.cloneTo(l);var _=a[o].withCompile(l);switch(_.bind(),_.uploadUniforms(_._materialUniformParamsMap,r,!0),_.uploadRenderStateBlendDepth(r),_.uploadRenderStateFrontFace(r,!1,null),this._screenType){case n._SCREENTYPE_QUAD:b._instance.invertY?we.instance.renderInvertUV():we.instance.render();break;case n._SCREENTYPE_TRIANGLE:b._instance.invertY?Fe.instance.renderInvertUV():Fe.instance.render();break;default:throw"BlitScreenQuadCMD:unknown screen Type."}}i&&i._end()}},{key:"recover",value:function(){n._pool.push(this),this._source=null,this._dest=null,this._offsetScale=null,this._shader=null,this._shaderData=null,_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"recover",this).call(this)}}],[{key:"create",value:function(e,t){var r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:n._SCREENTYPE_QUAD;return(r=n._pool.length>0?n._pool.pop():new n)._source=e,r._dest=t,r._offsetScale=i,r._shader=a,r._shaderData=o,r._subShader=s,r._screenType=l,r}}]),n}();Ue._SCREENTYPE_QUAD=0,Ue._SCREENTYPE_TRIANGLE=1,Ue._compileDefine=new k,Ue._pool=[],Ue._defaultOffsetScale=new i(0,0,1,1);var Ge=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));return e._renderTexture=null,e}return _inherits(t,Be),_createClass(t,[{key:"run",value:function(){this._renderTexture._start()}},{key:"recover",value:function(){t._pool.push(this),this._renderTexture=null}}],[{key:"create",value:function(e){var n;return(n=t._pool.length>0?t._pool.pop():new t)._renderTexture=e,n}}]),t}();Ge._pool=[];var ze=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments));return e._shaderData=null,e._nameID=0,e._texture=null,e}return _inherits(t,Be),_createClass(t,[{key:"run",value:function(){this._shaderData.setTexture(this._nameID,this._texture)}},{key:"recover",value:function(){t._pool.push(this),this._shaderData=null,this._nameID=0,this._texture=null}}],[{key:"create",value:function(e,n,r){var i;return(i=t._pool.length>0?t._pool.pop():new t)._shaderData=e,i._nameID=n,i._texture=r,i}}]),t}();ze._pool=[];var He,We=function(){function e(){_classCallCheck(this,e),this._camera=null,this._commands=[]}return _createClass(e,[{key:"_apply",value:function(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].run()}},{key:"setShaderDataTexture",value:function(e,t,n){this._commands.push(ze.create(e,t,n))}},{key:"blitScreenQuad",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this._commands.push(Ue.create(e,t,n,r,i,a,Ue._SCREENTYPE_QUAD))}},{key:"blitScreenTriangle",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this._commands.push(Ue.create(e,t,n,r,i,a,Ue._SCREENTYPE_TRIANGLE))}},{key:"setRenderTarget",value:function(e){this._commands.push(Ge.create(e))}},{key:"clear",value:function(){for(var e=0,t=this._commands.length;e<t;e++)this._commands[e].recover();this._commands.length=0}}]),e}();(He=e.CameraClearFlags||(e.CameraClearFlags={}))[He.SolidColor=0]="SolidColor",He[He.Sky=1]="Sky",He[He.DepthOnly=2]="DepthOnly",He[He.Nothing=3]="Nothing";var Xe=function(n){function s(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;_classCallCheck(this,s);var l=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,a,o));return l._updateViewMatrix=!0,l._postProcess=null,l._enableHDR=!1,l._viewportParams=new i,l._projectionParams=new i,l._offScreenRenderTexture=null,l._internalRenderTexture=null,l._postProcessCommandBuffers=[],l._clusterPlaneCacheFlag=new r(-1,-1),l._screenOffsetScale=new i,l.enableRender=!0,l.clearFlag=e.CameraClearFlags.SolidColor,l._viewMatrix=new T,l._projectionMatrix=new T,l._projectionViewMatrix=new T,l._viewport=new xe(0,0,0,0),l._normalizedViewport=new xe(0,0,1,1),l._aspectRatio=n,l._boundFrustum=new Ae(T.DEFAULT),t.Render.supportWebGLPlusCulling&&(l._boundFrustumBuffer=new Float32Array(24)),l._calculateProjectionMatrix(),t.Laya.stage.on(t.Event.RESIZE,l,l._onScreenSizeChanged),l.transform.on(t.Event.TRANSFORM_CHANGED,l,l._onTransformChanged),l}return _inherits(s,ke),_createClass(s,[{key:"_calculationViewport",value:function(e,t,n){var r=e.x*t,i=e.y*n,a=r+Math.max(e.width*t,0),o=i+Math.max(e.height*n,0),s=Math.ceil(r),l=Math.ceil(i),_=Math.floor(a),u=Math.floor(o),c=s-r>=.5?Math.floor(r):s,h=l-i>=.5?Math.floor(i):l,d=a-_>=.5?Math.ceil(a):_,f=o-u>=.5?Math.ceil(o):u;this._viewport.x=c,this._viewport.y=h,this._viewport.width=d-c,this._viewport.height=f-h}},{key:"_calculateProjectionMatrix",value:function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var e=.5*this.orthographicVerticalSize,t=e*this.aspectRatio;T.createOrthoOffCenter(-t,t,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else T.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix)}},{key:"_isLayerVisible",value:function(e){return 0!=(Math.pow(2,e)&this.cullingMask)}},{key:"_onTransformChanged",value:function(e){(e&=se.TRANSFORM_WORLDMATRIX)&&(this._updateViewMatrix=!0)}},{key:"_parse",value:function(e,t){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_parse",this).call(this,e,t);var n=e.clearFlag;void 0!==n&&(this.clearFlag=n);var r=e.viewport;this.normalizedViewport=new xe(r[0],r[1],r[2],r[3]);var i=e.enableHDR;void 0!==i&&(this.enableHDR=i)}},{key:"_getCanvasWidth",value:function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.width:b.clientWidth}},{key:"_getCanvasHeight",value:function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.height:b.clientHeight}},{key:"_getRenderTexture",value:function(){return this._internalRenderTexture||this._offScreenRenderTexture}},{key:"_needInternalRenderTexture",value:function(){return!(!this._postProcess&&!this._enableHDR)}},{key:"_applyPostProcessCommandBuffers",value:function(){for(var e=0,t=this._postProcessCommandBuffers.length;e<t;e++)this._postProcessCommandBuffers[e]._apply()}},{key:"_getRenderTextureFormat",value:function(){return this._enableHDR?t.RenderTextureFormat.R16G16B16A16:t.RenderTextureFormat.R8G8B8}},{key:"_prepareCameraToRender",value:function(){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_prepareCameraToRender",this).call(this);var e=this.viewport;this._viewportParams.setValue(e.x,e.y,e.width,e.height),this._projectionParams.setValue(this._nearPlane,this._farPlane,this._getRenderTexture()?-1:1,0),this._shaderValues.setVector(ke.VIEWPORT,this._viewportParams),this._shaderValues.setVector(ke.PROJECTION_PARAMS,this._projectionParams)}},{key:"_applyViewProject",value:function(e,t,n){var r,i=this._shaderValues;e.invertY?(T.multiply(ke._invertYScaleMatrix,n,ke._invertYProjectionMatrix),T.multiply(ke._invertYProjectionMatrix,t,ke._invertYProjectionViewMatrix),n=ke._invertYProjectionMatrix,r=ke._invertYProjectionViewMatrix):(T.multiply(n,t,this._projectionViewMatrix),r=this._projectionViewMatrix),e.viewMatrix=t,e.projectionMatrix=n,e.projectionViewMatrix=r,i.setMatrix4x4(ke.VIEWMATRIX,t),i.setMatrix4x4(ke.PROJECTMATRIX,n),i.setMatrix4x4(ke.VIEWPROJECTMATRIX,r)}},{key:"_updateClusterPlaneXY",value:function(){var e=this.fieldOfView,t=this.aspectRatio;if(this._clusterPlaneCacheFlag.x!==e||this._clusterPlaneCacheFlag.y!==t){var n=o._config.lightClusterCount,r=n.x,i=n.y,s=r+1,l=i+1,_=this._clusterXPlanes,u=this._clusterYPlanes;if(!_){_=this._clusterXPlanes=new Array(s),u=this._clusterYPlanes=new Array(l);for(var c=0;c<s;c++)_[c]=new a;for(c=0;c<l;c++)u[c]=new a}var h=Math.tan(this.fieldOfView/2*Math.PI/180),d=this.aspectRatio*h,f=2*h/r,m=2*d/i;for(c=0;c<s;c++){var E=m*c-d,v=1/Math.sqrt(1+E*E);_[c].setValue(v,0,-E*v)}for(c=0;c<l;c++){E=h-f*c;var T=-1/Math.sqrt(1+E*E);u[c].setValue(0,T,-E*T)}this._clusterPlaneCacheFlag.x=e,this._clusterPlaneCacheFlag.y=t}}},{key:"render",value:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.activeInHierarchy){var i=this.viewport,a=this._needInternalRenderTexture(),l=t.LayaGL.instance,_=b._instance,u=_.scene=this._scene;if(this._internalRenderTexture=a?V.createFromPool(i.width,i.height,this._getRenderTextureFormat(),t.RenderTextureDepthFormat.DEPTH_16,t.BaseTexture.FILTERMODE_BILINEAR):null,u.parallelSplitShadowMaps[0]){G.setRuntimeValueMode(!1);var c=u.parallelSplitShadowMaps[0];c._calcAllLightCameraInfo(this),u._shaderValues.addDefine(Z.SHADERDEFINE_CAST_SHADOW);for(var h=0,d=c.shadowMapCount;h<d;h++){var f=c.cameras[h];_.camera=f,ce.renderObjectCulling(f,u,_,n,r,!0);var m=c.cameras[h+1].renderTarget;m._start(),b._instance.invertY=!1,_.camera=f,s._updateMark++,_.viewport=f.viewport,f._prepareCameraToRender(),f._applyViewProject(_,f.viewMatrix,f.projectionMatrix),u._clear(l,_),u._opaqueQueue._render(_),m._end()}u._shaderValues.removeDefine(Z.SHADERDEFINE_CAST_SHADOW),G.setRuntimeValueMode(!0)}if(_.camera=this,s._updateMark++,u._preRenderScript(),a&&!this._offScreenRenderTexture&&(this.clearFlag==e.CameraClearFlags.DepthOnly||this.clearFlag==e.CameraClearFlags.Nothing))if(this._enableHDR){var E=V.createFromPool(i.width,i.height,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTH_16,t.BaseTexture.FILTERMODE_BILINEAR);t.WebGLContext.bindTexture(l,l.TEXTURE_2D,E._getSource()),l.copyTexSubImage2D(l.TEXTURE_2D,0,0,0,i.x,b.clientHeight-(i.y+i.height),i.width,i.height),(T=Ue.create(E,this._internalRenderTexture)).run(),T.recover(),V.recoverToPool(E)}else t.WebGLContext.bindTexture(l,l.TEXTURE_2D,this._internalRenderTexture._getSource()),l.copyTexSubImage2D(l.TEXTURE_2D,0,0,0,i.x,b.clientHeight-(i.y+i.height),i.width,i.height);var v=this._getRenderTexture();if(v&&v._start(),_.viewport=i,this._prepareCameraToRender(),o._config._multiLighting&&ye.instance.update(this,this._scene),this._applyViewProject(_,this.viewMatrix,this._projectionMatrix),u._preCulling(_,this,n,r),u._clear(l,_),u._renderScene(_),u._postRenderScript(),v&&v._end(),a){if(this._postProcess)this._postProcess._render(),this._applyPostProcessCommandBuffers();else if(this._enableHDR){var T,p=this._getCanvasWidth(),g=this._getCanvasHeight();this._screenOffsetScale.setValue(i.x/p,i.y/g,i.width/p,i.height/g),(T=Ue.create(this._internalRenderTexture,this._offScreenRenderTexture?this._offScreenRenderTexture:null,this._screenOffsetScale)).run(),T.recover()}V.recoverToPool(this._internalRenderTexture)}}}},{key:"viewportPointToRay",value:function(e,t){De.calculateCursorRay(e,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}},{key:"normalizedViewportPointToRay",value:function(e,t){var n=s._tempVector20,r=this.viewport;n.x=e.x*r.width,n.y=e.y*r.height,De.calculateCursorRay(n,this.viewport,this._projectionMatrix,this.viewMatrix,null,t)}},{key:"worldToViewportPoint",value:function(e,n){T.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(e,this._projectionViewMatrix,n),n.x=n.x/t.Laya.stage.clientScaleX,n.y=n.y/t.Laya.stage.clientScaleY}},{key:"worldToNormalizedViewportPoint",value:function(e,n){T.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(e,this._projectionViewMatrix,n),n.x=n.x/t.Laya.stage.clientScaleX,n.y=n.y/t.Laya.stage.clientScaleY}},{key:"convertScreenCoordToOrthographicCoord",value:function(e,n){if(this._orthographic){var r=b.clientWidth,i=b.clientHeight,o=this.orthographicVerticalSize*this.aspectRatio/r,s=this.orthographicVerticalSize/i;return n.x=(-r/2+e.x*t.Laya.stage.clientScaleX)*o,n.y=(i/2-e.y*t.Laya.stage.clientScaleY)*s,n.z=(this.nearPlane-this.farPlane)*(e.z+1)/2-this.nearPlane,a.transformCoordinate(n,this.transform.worldMatrix,n),!0}return!1}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._offScreenRenderTexture=null,this.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged),_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"destroy",this).call(this,e)}},{key:"addCommandBuffer",value:function(e,t){switch(e){case s.CAMERAEVENT_POSTPROCESS:this._postProcessCommandBuffers.push(t),t._camera=this;break;default:throw"Camera:unknown event."}}},{key:"removeCommandBuffer",value:function(e,t){switch(e){case s.CAMERAEVENT_POSTPROCESS:var n=this._postProcessCommandBuffers.indexOf(t);-1!==n&&this._postProcessCommandBuffers.splice(n,1);break;default:throw"Camera:unknown event."}}},{key:"removeCommandBuffers",value:function(e){switch(e){case s.CAMERAEVENT_POSTPROCESS:this._postProcessCommandBuffers.length=0;break;default:throw"Camera:unknown event."}}},{key:"_create",value:function(){return new s}},{key:"aspectRatio",get:function(){if(0===this._aspectRatio){var e=this.viewport;return e.width/e.height}return this._aspectRatio},set:function(e){if(e<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=e,this._calculateProjectionMatrix()}},{key:"viewport",get:function(){return this._offScreenRenderTexture?this._calculationViewport(this._normalizedViewport,this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):this._calculationViewport(this._normalizedViewport,b.clientWidth,b.clientHeight),this._viewport},set:function(e){var t,n;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,n=this._offScreenRenderTexture.height):(t=b.clientWidth,n=b.clientHeight),this._normalizedViewport.x=e.x/t,this._normalizedViewport.y=e.y/n,this._normalizedViewport.width=e.width/t,this._normalizedViewport.height=e.height/n,this._calculationViewport(this._normalizedViewport,t,n),this._calculateProjectionMatrix()}},{key:"normalizedViewport",get:function(){return this._normalizedViewport},set:function(e){var t,n;this._offScreenRenderTexture?(t=this._offScreenRenderTexture.width,n=this._offScreenRenderTexture.height):(t=b.clientWidth,n=b.clientHeight),this._normalizedViewport!==e&&e.cloneTo(this._normalizedViewport),this._calculationViewport(e,t,n),this._calculateProjectionMatrix()}},{key:"viewMatrix",get:function(){if(this._updateViewMatrix){var e=this.transform.getWorldLossyScale(),t=e.x,n=e.y,r=e.z,i=this._viewMatrix.elements;this.transform.worldMatrix.cloneTo(this._viewMatrix),i[0]/=t,i[1]/=t,i[2]/=t,i[4]/=n,i[5]/=n,i[6]/=n,i[8]/=r,i[9]/=r,i[10]/=r,this._viewMatrix.invert(this._viewMatrix),this._updateViewMatrix=!1}return this._viewMatrix}},{key:"projectionMatrix",get:function(){return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._useUserProjectionMatrix=!0}},{key:"projectionViewMatrix",get:function(){return T.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}},{key:"boundFrustum",get:function(){if(this._boundFrustum.matrix=this.projectionViewMatrix,t.Render.supportWebGLPlusCulling){var e=this._boundFrustum.near,n=this._boundFrustum.far,r=this._boundFrustum.left,i=this._boundFrustum.right,a=this._boundFrustum.top,o=this._boundFrustum.bottom,s=e.normal,l=n.normal,_=r.normal,u=i.normal,c=a.normal,h=o.normal,d=this._boundFrustumBuffer;d[0]=s.x,d[1]=s.y,d[2]=s.z,d[3]=e.distance,d[4]=l.x,d[5]=l.y,d[6]=l.z,d[7]=n.distance,d[8]=_.x,d[9]=_.y,d[10]=_.z,d[11]=r.distance,d[12]=u.x,d[13]=u.y,d[14]=u.z,d[15]=i.distance,d[16]=c.x,d[17]=c.y,d[18]=c.z,d[19]=a.distance,d[20]=h.x,d[21]=h.y,d[22]=h.z,d[23]=o.distance}return this._boundFrustum}},{key:"renderTarget",get:function(){return this._offScreenRenderTexture},set:function(e){var t=this._offScreenRenderTexture;t!==e&&(t&&(t._isCameraTarget=!1),e&&(e._isCameraTarget=!0),this._offScreenRenderTexture=e,this._calculateProjectionMatrix())}},{key:"postProcess",get:function(){return this._postProcess},set:function(e){this._postProcess=e;var t=new We;this.addCommandBuffer(s.CAMERAEVENT_POSTPROCESS,t),e._init(this,t)}},{key:"enableHDR",get:function(){return this._enableHDR},set:function(e){!e||Me.supportRenderTextureFormat(t.RenderTextureFormat.R16G16B16A16)?this._enableHDR=e:console.warn("Camera:can't enable HDR in this device.")}}]),s}();Xe.CAMERAEVENT_POSTPROCESS=0,Xe._tempVector20=new r,Xe._updateMark=0;var Ye=function(){function e(){_classCallCheck(this,e),this.renderSubShader=null,this.renderType=e.RENDERTYPE_NORMAL}return _createClass(e,[{key:"getInvertFront",value:function(){return this._transform._isFrontFaceInvert}},{key:"setTransform",value:function(e){this._transform=e}},{key:"setGeometry",value:function(e){this._geometry=e}},{key:"addToOpaqueRenderQueue",value:function(e,t){t.elements.add(this)}},{key:"addToTransparentRenderQueue",value:function(e,t){t.elements.add(this),t.lastTransparentBatched=!1,t.lastTransparentRenderElement=this}},{key:"_update",value:function(e,t,n,r){if(this.material){var i=this.material._shader.getSubShaderAt(0);if(this.renderSubShader=null,n)if(r){var a=i.getFlag(r);if(!a)return;for(var o=n._subShaders,s=0,l=o.length;s<l;s++){var _=o[s];if(a===_.getFlag(r)){this.renderSubShader=_;break}}if(!this.renderSubShader)return}else this.renderSubShader=n.getSubShaderAt(0);else this.renderSubShader=i;var u=e._getRenderQueue(this.material.renderQueue);u.isTransparent?this.addToTransparentRenderQueue(t,u):this.addToOpaqueRenderQueue(t,u)}}},{key:"_render",value:function(t){var n,r,i,a=t.invertY,o=Xe._updateMark,s=t.scene,l=t.camera,_=this._transform,u=this._geometry;t.renderElement=this;var c=o!==this.render._updateMark||this.renderType!==this.render._updateRenderType;if(c?(this.render._renderUpdate(t,_),this.render._renderUpdateWithCamera(t,_),this.render._updateMark=o,this.render._updateRenderType=this.renderType):this.renderType==e.RENDERTYPE_INSTANCEBATCH&&(this.render._renderUpdate(t,_),this.render._renderUpdateWithCamera(t,_)),u._prepareRender(t))for(var h=this.renderSubShader._passes,d=0,f=h.length;d<f;d++){var m=e._compileDefine;s._shaderValues._defineDatas.cloneTo(m),m.removeDefineDatas(this.material._disablePublicDefineDatas),m.addDefineDatas(this.render._shaderValues._defineDatas),m.addDefineDatas(this.material._shaderValues._defineDatas);var E=t.shader=h[d].withCompile(m),v=E.bind(),T=o!==E._uploadMark,p=E._uploadScene!==s||T;(p||v)&&(E.uploadUniforms(E._sceneUniformParamsMap,s._shaderValues,p),E._uploadScene=s);var g=E._uploadRender!==this.render||E._uploadRenderType!==this.renderType||T;(g||v)&&(E.uploadUniforms(E._spriteUniformParamsMap,this.render._shaderValues,g),E._uploadRender=this.render,E._uploadRenderType=this.renderType);var y=E._uploadCamera!==l||T;(y||v)&&(E.uploadUniforms(E._cameraUniformParamsMap,l._shaderValues,y),E._uploadCamera=l);var S=E._uploadMaterial!==this.material||T;(S||v)&&(E.uploadUniforms(E._materialUniformParamsMap,this.material._shaderValues,S),E._uploadMaterial=this.material);var R=this.material._shaderValues;n!==this.material||r!==E?(E.uploadRenderStateBlendDepth(R),E.uploadRenderStateFrontFace(R,a,this.getInvertFront()),n=this.material,r=E,i=this.render):i!==this.render&&(E.uploadRenderStateFrontFace(R,a,this.getInvertFront()),i=this.render),u._render(t),E._uploadMark=o}c&&this.renderType!==e.RENDERTYPE_NORMAL&&this.render._revertBatchRenderUpdate(t)}},{key:"destroy",value:function(){this._transform=null,this._geometry=null,this.material=null,this.render=null}}]),e}();Ye.RENDERTYPE_NORMAL=0,Ye.RENDERTYPE_STATICBATCH=1,Ye.RENDERTYPE_INSTANCEBATCH=2,Ye.RENDERTYPE_VERTEXBATCH=3,Ye._compileDefine=new k;var je=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._dynamicWorldPositionNormalNeedUpdate=!0,e}return _inherits(n,Ye),_createClass(n,[{key:"_onWorldMatrixChanged",value:function(){this._dynamicWorldPositionNormalNeedUpdate=!0}},{key:"_computeWorldPositionsAndNormals",value:function(e,t,n,r){if(this._dynamicWorldPositionNormalNeedUpdate){for(var i=this._geometry,a=i._vertexBuffer,o=a.vertexDeclaration.vertexStride/4,s=a.getFloat32Data(),l=this._transform.worldMatrix,_=this._transform.rotation,u=i._indices,c=0;c<r;c++){var h=(n?u[c]:c)*o,d=3*c;A.transformVector3ArrayToVector3ArrayCoordinate(s,h+e,l,this._dynamicWorldPositions,d),-1!==t&&A.transformVector3ArrayByQuat(s,h+t,_,this._dynamicWorldNormals,d)}this._dynamicWorldPositionNormalNeedUpdate=!1}}},{key:"setTransform",value:function(e){this._transform!==e&&(this._transform&&this._transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),e&&e.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatrixChanged),this._dynamicWorldPositionNormalNeedUpdate=!0,this._transform=e)}},{key:"setGeometry",value:function(e){if(this._geometry!==e){var t=e,n=t._mesh;if(n){var r=n._subMeshes.length>1,i=r?t._indexCount:n._vertexCount;if(i<=s.SubMeshDynamicBatch.maxAllowVertexCount){var a=3*i;this._dynamicVertexBatch=!0,this._dynamicWorldPositions=new Float32Array(a),this._dynamicWorldNormals=new Float32Array(a),this._dynamicVertexCount=i,this._dynamicMultiSubMesh=r}else this._dynamicVertexBatch=!1}this._geometry=e}}},{key:"addToOpaqueRenderQueue",value:function(e,n){var r=this.staticBatch,i=n.elements,a=i.elements;if(r){var o=s.MeshRenderStaticBatchManager.instance,l=o.getBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,r._batchID);if(o._updateCountMark===l.updateMark){var _=l.indexInList;if(l.batched)a[_].staticBatchElementList.add(this);else{var u=a[_],c=u.render,h=o._getBatchRenderElementFromPool();h.renderType=Ye.RENDERTYPE_STATICBATCH,h.setGeometry(r),h.material=u.material;var d=r.batchOwner,f=d?d._transform:null;h.setTransform(f),h.render=c,h.renderSubShader=u.renderSubShader;var m=h.staticBatchElementList;m.length=0,m.add(u),m.add(this),a[_]=h,l.batched=!0}}else l.updateMark=o._updateCountMark,l.indexInList=i.length,l.batched=!1,i.add(this)}else if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0){var E=this._geometry,v=s.MeshRenderDynamicBatchManager.instance,T=v.getInstanceBatchOpaquaMark(this.render.receiveShadow,this.material.id,E._id,this._transform._isFrontFaceInvert);if(v._updateCountMark===T.updateMark){var p=T.indexInList;if(T.batched){var g=a[p].instanceBatchElementList;g.length===pe.instance.maxInstanceCount?(T.updateMark=v._updateCountMark,T.indexInList=i.length,T.batched=!1,i.add(this)):g.add(this)}else{var y=a[p],S=y.render,R=v._getBatchRenderElementFromPool();R.renderType=Ye.RENDERTYPE_INSTANCEBATCH,R.setGeometry(pe.instance),R.material=y.material,R.setTransform(null),R.render=S,R.instanceSubMesh=E,R.renderSubShader=y.renderSubShader;var C=R.instanceBatchElementList;C.length=0,C.add(y),C.add(this),a[p]=R,T.batched=!0}}else T.updateMark=v._updateCountMark,T.indexInList=i.length,T.batched=!1,i.add(this)}else if(this._dynamicVertexBatch){var I=this._geometry._vertexBuffer.vertexDeclaration,A=s.MeshRenderDynamicBatchManager.instance,x=A.getVertexBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,I.id);if(A._updateCountMark===x.updateMark){var D=x.indexInList;if(x.batched)a[D].vertexBatchElementList.add(this);else{var L=a[D],M=L.render,O=A._getBatchRenderElementFromPool();O.renderType=Ye.RENDERTYPE_VERTEXBATCH,O.setGeometry(s.SubMeshDynamicBatch.instance),O.material=L.material,O.setTransform(null),O.render=M,O.vertexBatchVertexDeclaration=I,O.renderSubShader=L.renderSubShader;var N=O.vertexBatchElementList;N.length=0,N.add(L),N.add(this),a[D]=O,x.batched=!0}}else x.updateMark=A._updateCountMark,x.indexInList=i.length,x.batched=!1,i.add(this)}else i.add(this)}},{key:"addToTransparentRenderQueue",value:function(e,n){var r=this.staticBatch,i=n.elements,a=i.elements;if(r){var o=s.MeshRenderStaticBatchManager.instance,l=n.lastTransparentRenderElement;if(l){var _=l.render;if(l._geometry._getType()!==this._geometry._getType()||l.staticBatch!==r||l.material!==this.material||_.receiveShadow!==this.render.receiveShadow||_.lightmapIndex!==this.render.lightmapIndex)i.add(this),n.lastTransparentBatched=!1;else{if(n.lastTransparentBatched)a[i.length-1].staticBatchElementList.add(this);else{var u=o._getBatchRenderElementFromPool();u.renderType=Ye.RENDERTYPE_STATICBATCH,u.setGeometry(r),u.material=l.material;var c=r.batchOwner,h=c?c._transform:null;u.setTransform(h),u.render=this.render,u.renderSubShader=l.renderSubShader;var d=u.staticBatchElementList;d.length=0,d.add(l),d.add(this),a[i.length-1]=u}n.lastTransparentBatched=!0}}else i.add(this),n.lastTransparentBatched=!1}else if(this.renderSubShader._owner._enableInstancing&&t.LayaGL.layaGPUInstance.supportInstance()&&this.render.lightmapIndex<0){var f=this._geometry,m=s.MeshRenderDynamicBatchManager.instance,E=n.lastTransparentRenderElement;if(E){var v=E.render;if(E._geometry._getType()!==this._geometry._getType()||E._geometry!==f||E.material!==this.material||v.receiveShadow!==this.render.receiveShadow)i.add(this),n.lastTransparentBatched=!1;else if(n.lastTransparentBatched){var T=a[i.length-1].instanceBatchElementList;T.length===pe.instance.maxInstanceCount?(i.add(this),n.lastTransparentBatched=!1):(T.add(this),n.lastTransparentBatched=!0)}else{var p=m._getBatchRenderElementFromPool();p.renderType=Ye.RENDERTYPE_INSTANCEBATCH,p.setGeometry(pe.instance),p.material=E.material,p.setTransform(null),p.render=this.render,p.instanceSubMesh=f,p.renderSubShader=E.renderSubShader;var g=p.instanceBatchElementList;g.length=0,g.add(E),g.add(this),a[i.length-1]=p,n.lastTransparentBatched=!0}}else i.add(this),n.lastTransparentBatched=!1}else if(this._dynamicVertexBatch){var y=this._geometry._vertexBuffer.vertexDeclaration,S=s.MeshRenderDynamicBatchManager.instance,R=n.lastTransparentRenderElement;if(R){var C=R.render;if(R._geometry._getType()!==this._geometry._getType()||R._geometry._vertexBuffer._vertexDeclaration!==y||R.material!==this.material||C.receiveShadow!==this.render.receiveShadow||C.lightmapIndex!==this.render.lightmapIndex)i.add(this),n.lastTransparentBatched=!1;else{if(n.lastTransparentBatched)a[i.length-1].vertexBatchElementList.add(this);else{var I=S._getBatchRenderElementFromPool();I.renderType=Ye.RENDERTYPE_VERTEXBATCH,I.setGeometry(s.SubMeshDynamicBatch.instance),I.material=R.material,I.setTransform(null),I.render=this.render,I.vertexBatchVertexDeclaration=y,I.renderSubShader=R.renderSubShader;var A=I.vertexBatchElementList;A.length=0,A.add(R),A.add(this),a[i.length-1]=I}n.lastTransparentBatched=!0}}else i.add(this),n.lastTransparentBatched=!1}else i.add(this);n.lastTransparentRenderElement=this}},{key:"getInvertFront",value:function(){switch(this.renderType){case Ye.RENDERTYPE_NORMAL:return this._transform._isFrontFaceInvert;case Ye.RENDERTYPE_STATICBATCH:case Ye.RENDERTYPE_VERTEXBATCH:return!1;case Ye.RENDERTYPE_INSTANCEBATCH:return this.instanceBatchElementList.elements[0]._transform._isFrontFaceInvert;default:throw"SubMeshRenderElement: unknown renderType"}}},{key:"destroy",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this),this._dynamicWorldPositions=null,this._dynamicWorldNormals=null,this.staticBatch=null,this.staticBatchElementList=null,this.vertexBatchElementList=null,this.vertexBatchVertexDeclaration=null}}]),n}(),Ze=function(n){function r(e,t){_classCallCheck(this,r);var n=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return n._bufferState=new Oe,n._batchID=r._batchIDCounter++,n._batchElements=[],n._currentBatchVertexCount=0,n._currentBatchIndexCount=0,n._vertexDeclaration=t,n.batchOwner=e,n}return _inherits(r,de),_createClass(r,[{key:"_getStaticBatchBakedVertexs",value:function(e,t,n,i,a,o){var s,l=o._vertexBuffer,_=l.vertexDeclaration,u=_.getVertexElementByUsage(Te.MESH_POSITION0)._offset/4,c=_.getVertexElementByUsage(Te.MESH_NORMAL0),h=c?c._offset/4:-1,d=_.getVertexElementByUsage(Te.MESH_COLOR0),f=d?d._offset/4:-1,m=_.getVertexElementByUsage(Te.MESH_TEXTURECOORDINATE0),E=m?m._offset/4:-1,v=_.getVertexElementByUsage(Te.MESH_TEXTURECOORDINATE1),p=v?v._offset/4:-1,g=_.getVertexElementByUsage(Te.MESH_TANGENT0),y=g?g._offset/4:-1,S=_.vertexStride/4,R=l.getFloat32Data();n?(n.worldMatrix.invert(r._tempMatrix4x40),s=r._tempMatrix4x41,T.multiply(r._tempMatrix4x40,i.worldMatrix,s)):s=i.worldMatrix;var C=r._tempMatrix4x42;s.invert(C),C.transpose();var I=r._tempQuaternion0;s.decomposeTransRotScale(r._tempVector30,I,r._tempVector31);for(var x=a.lightmapScaleOffset,D=o.vertexCount,L=0;L<D;L++){var M,O,N=L*S,P=18*(L+t);A.transformVector3ArrayToVector3ArrayCoordinate(R,N+u,s,e,P+0),-1!==h&&A.transformVector3ArrayToVector3ArrayNormal(R,N+h,C,e,P+3);var b=P+6;if(-1!==f){var V=N+f;for(M=0,O=4;M<O;M++)e[b+M]=R[V+M]}else for(M=0,O=4;M<O;M++)e[b+M]=1;if(-1!==E){var k=N+E;e[P+10]=R[k],e[P+11]=R[k+1]}if(x&&(-1!==p?A.transformLightingMapTexcoordArray(R,N+p,x,e,P+12):A.transformLightingMapTexcoordArray(R,N+E,x,e,P+12)),-1!==y){var w=N+y;e[P+14]=R[w],e[P+15]=R[w+1],e[P+16]=R[w+2],e[P+17]=R[w+3]}}return D}},{key:"addTest",value:function(e){var t=e.meshFilter.sharedMesh.vertexCount;return!(this._currentBatchVertexCount+t>r.maxBatchVertexCount)}},{key:"add",value:function(e){var t=e.meshFilter.sharedMesh,n=t.vertexCount;this._batchElements.push(e);var r=e._render;r._isPartOfStaticBatch=!0,r._staticBatch=this;for(var i=r._renderElements,a=0,o=i.length;a<o;a++)i[a].staticBatch=this;this._currentBatchIndexCount+=t._indexBuffer.indexCount,this._currentBatchVertexCount+=n}},{key:"remove",value:function(e){var t=e.meshFilter.sharedMesh,n=this._batchElements.indexOf(e);if(-1!==n){this._batchElements.splice(n,1);for(var r=e._render._renderElements,i=0,a=r.length;i<a;i++)r[i].staticBatch=null;this._currentBatchIndexCount=this._currentBatchIndexCount-t._indexBuffer.indexCount,this._currentBatchVertexCount=this._currentBatchVertexCount-t.vertexCount,e._render._isPartOfStaticBatch=!1}}},{key:"finishInit",value:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy(),t.Resource._addGPUMemory(-(this._vertexBuffer._byteLength+this._indexBuffer._byteLength)));var n=t.LayaGL.instance,r=0,i=0,a=this.batchOwner,o=this._vertexDeclaration.vertexStride/4,s=new Float32Array(o*this._currentBatchVertexCount),l=new Uint16Array(this._currentBatchIndexCount);this._vertexBuffer=new fe(this._vertexDeclaration.vertexStride*this._currentBatchVertexCount,n.STATIC_DRAW),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration,this._indexBuffer=new Ne(e.IndexFormat.UInt16,this._currentBatchIndexCount,n.STATIC_DRAW);for(var _=0,u=this._batchElements.length;_<u;_++){for(var c,h=this._batchElements[_],d=h.meshFilter.sharedMesh,f=this._getStaticBatchBakedVertexs(s,r,a?a._transform:null,h._transform,h._render,d),m=d._indexBuffer.getData(),E=r,v=i+m.length,T=h._render._renderElements,p=0,g=d.subMeshCount;p<g;p++){var y=d._subMeshes[p],S=i+y._indexStart,R=T[p];R.staticBatchIndexStart=S,R.staticBatchIndexEnd=S+y._indexCount}if(l.set(m,i),a?h._transform._isFrontFaceInvert!==a.transform._isFrontFaceInvert:h._transform._isFrontFaceInvert)for(c=i;c<v;c+=3){l[c]=E+l[c];var C=l[c+1],I=l[c+2];l[c+1]=E+I,l[c+2]=E+C}else for(c=i;c<v;c+=3)l[c]=E+l[c],l[c+1]=E+l[c+1],l[c+2]=E+l[c+2];i+=m.length,r+=f}this._vertexBuffer.setData(s.buffer),this._indexBuffer.setData(l);var A=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(A),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}},{key:"_render",value:function(e){this._bufferState.bind();for(var n=t.LayaGL.instance,r=e.renderElement.staticBatchElementList,i=r.elements,a=0,o=0,s=r.length,l=1;l<s;l++){if(i[l-1].staticBatchIndexEnd!==i[l].staticBatchIndexStart){var _=i[a].staticBatchIndexStart,u=i[o].staticBatchIndexEnd-_;n.drawElements(n.TRIANGLES,u,n.UNSIGNED_SHORT,2*_),a=++o,t.Stat.trianglesFaces+=u/3}else o++}_=i[a].staticBatchIndexStart,u=i[o].staticBatchIndexEnd-_,n.drawElements(n.TRIANGLES,u,n.UNSIGNED_SHORT,2*_),t.Stat.renderBatches++,t.Stat.savedRenderBatches+=s-1,t.Stat.trianglesFaces+=u/3}},{key:"dispose",value:function(){var e=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;t.Resource._addGPUMemory(-e),this._batchElements=null,this.batchOwner=null,this._vertexDeclaration=null,this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null}}]),r}();Ze._tempVector30=new a,Ze._tempVector31=new a,Ze._tempQuaternion0=new d,Ze._tempMatrix4x40=new T,Ze._tempMatrix4x41=new T,Ze._tempMatrix4x42=new T,Ze.maxBatchVertexCount=65535,Ze._batchIDCounter=0;var qe=function(){function e(){_classCallCheck(this,e),this.elements=[],this.length=0}return _createClass(e,[{key:"_add",value:function(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}},{key:"add",value:function(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++}}]),e}(),Qe=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._opaqueBatchMarks=[],e._updateCountMark=0,e}return _inherits(t,ue),_createClass(t,[{key:"_compare",value:function(e,t){var n=e._render,r=t._render,i=e.meshFilter.sharedMesh,a=t.meshFilter.sharedMesh,o=n.lightmapIndex-r.lightmapIndex;if(0===o){var s=(n.receiveShadow?1:0)-(r.receiveShadow?1:0);if(0===s){var l=n.sharedMaterial&&r.sharedMaterial?n.sharedMaterial.id-r.sharedMaterial.id:0;if(0===l){var _=i._vertexBuffer.vertexDeclaration.id-a._vertexBuffer.vertexDeclaration.id;return 0===_?a._indexBuffer.indexCount-i._indexBuffer.indexCount:_}return l}return s}return o}},{key:"_getBatchRenderElementFromPool",value:function(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new je,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.staticBatchElementList=new qe),e}},{key:"_getStaticBatch",value:function(e,n,r){var i=e[r];return i||(i=e[r]=new Ze(n,t._verDec),this._staticBatches[i._batchID]=i),i}},{key:"_initStaticBatchs",value:function(e){var t=this._initBatchSprites;this._quickSort(t,0,t.length-1);for(var n,r=[],i=!1,a=0,o=0,s=t.length;o<s;o++){var l=t[o];if(i)n.addTest(l)?n.add(l):(i=!1,a++);else o!==s-1&&((n=this._getStaticBatch(r,e,a)).add(l),i=!0)}for(o=0,s=r.length;o<s;o++){var _=r[o];_&&_.finishInit()}this._initBatchSprites.length=0}},{key:"_removeRenderSprite",value:function(e){var t=e._render,n=t._staticBatch,r=n._batchElements,i=r.indexOf(e);if(-1!==i){r.splice(i,1),t._staticBatch=null;for(var a=t._renderElements,o=0,s=a.length;o<s;o++)a[o].staticBatch=null}0===r.length&&(delete this._staticBatches[n._batchID],n.dispose())}},{key:"_clear",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_clear",this).call(this),this._updateCountMark++}},{key:"_garbageCollection",value:function(){for(var e in this._staticBatches){var t=this._staticBatches[e];0===t._batchElements.length&&(t.dispose(),delete this._staticBatches[e])}}},{key:"getBatchOpaquaMark",value:function(e,t,n,r){var i=t?1:0,a=this._opaqueBatchMarks[e]||(this._opaqueBatchMarks[e]=[]),o=a[i]||(a[i]=[]),s=o[n]||(o[n]=[]);return s[r]||(s[r]=new he)}}],[{key:"__init__",value:function(){t._verDec=Te.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT")}}]),t}();Qe.instance=new Qe;var Ke=function e(){_classCallCheck(this,e)},Je=function(){function e(t,n){_classCallCheck(this,e),this.min=t,this.max=n}return _createClass(e,[{key:"_rotateExtents",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=t.elements;n.x=Math.abs(o[0]*r)+Math.abs(o[4]*i)+Math.abs(o[8]*a),n.y=Math.abs(o[1]*r)+Math.abs(o[5]*i)+Math.abs(o[9]*a),n.z=Math.abs(o[2]*r)+Math.abs(o[6]*i)+Math.abs(o[10]*a)}},{key:"getCorners",value:function(e){e.length=8;var t=this.min.x,n=this.min.y,r=this.min.z,i=this.max.x,o=this.max.y,s=this.max.z;e[0]=new a(t,o,s),e[1]=new a(i,o,s),e[2]=new a(i,n,s),e[3]=new a(t,n,s),e[4]=new a(t,o,r),e[5]=new a(i,o,r),e[6]=new a(i,n,r),e[7]=new a(t,n,r)}},{key:"getCenter",value:function(e){a.add(this.min,this.max,e),a.scale(e,.5,e)}},{key:"getExtent",value:function(e){a.subtract(this.max,this.min,e),a.scale(e,.5,e)}},{key:"setCenterAndExtent",value:function(e,t){a.subtract(e,t,this.min),a.add(e,t,this.max)}},{key:"tranform",value:function(t,n){var r=e._tempVector30,i=e._tempVector31;this.getCenter(r),this.getExtent(i),a.transformCoordinate(r,t,r),this._rotateExtents(i,t,i),n.setCenterAndExtent(r,i)}},{key:"toDefault",value:function(){this.min.toDefault(),this.max.toDefault()}},{key:"cloneTo",value:function(e){var t=e;this.min.cloneTo(t.min),this.max.cloneTo(t.max)}},{key:"clone",value:function(){var t=new e(new a,new a);return this.cloneTo(t),t}}],[{key:"createfromPoints",value:function(e,t){if(null==e)throw new Error("points");var n=t.min,r=t.max;n.x=Number.MAX_VALUE,n.y=Number.MAX_VALUE,n.z=Number.MAX_VALUE,r.x=-Number.MAX_VALUE,r.y=-Number.MAX_VALUE,r.z=-Number.MAX_VALUE;for(var i=0,o=e.length;i<o;++i)a.min(n,e[i],n),a.max(r,e[i],r)}},{key:"merge",value:function(e,t,n){a.min(e.min,t.min,n.min),a.max(e.max,t.max,n.max)}}]),e}();Je._tempVector30=new a,Je._tempVector31=new a;var $e=function(){function e(t,n){_classCallCheck(this,e),this._updateFlag=0,this._center=new a,this._extent=new a,this._boundBox=new Je(new a,new a),t.cloneTo(this._boundBox.min),n.cloneTo(this._boundBox.max),this._setUpdateFlag(e._UPDATE_CENTER|e._UPDATE_EXTENT,!0)}return _createClass(e,[{key:"setMin",value:function(t){var n=this._boundBox.min;t!==n&&t.cloneTo(n),this._setUpdateFlag(e._UPDATE_CENTER|e._UPDATE_EXTENT,!0),this._setUpdateFlag(e._UPDATE_MIN,!1)}},{key:"getMin",value:function(){var t=this._boundBox.min;return this._getUpdateFlag(e._UPDATE_MIN)&&(this._getMin(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(e._UPDATE_MIN,!1)),t}},{key:"setMax",value:function(t){var n=this._boundBox.max;t!==n&&t.cloneTo(n),this._setUpdateFlag(e._UPDATE_CENTER|e._UPDATE_EXTENT,!0),this._setUpdateFlag(e._UPDATE_MAX,!1)}},{key:"getMax",value:function(){var t=this._boundBox.max;return this._getUpdateFlag(e._UPDATE_MAX)&&(this._getMax(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(e._UPDATE_MAX,!1)),t}},{key:"setCenter",value:function(t){t!==this._center&&t.cloneTo(this._center),this._setUpdateFlag(e._UPDATE_MIN|e._UPDATE_MAX,!0),this._setUpdateFlag(e._UPDATE_CENTER,!1)}},{key:"getCenter",value:function(){return this._getUpdateFlag(e._UPDATE_CENTER)&&(this._getCenter(this.getMin(),this.getMax(),this._center),this._setUpdateFlag(e._UPDATE_CENTER,!1)),this._center}},{key:"setExtent",value:function(t){t!==this._extent&&t.cloneTo(this._extent),this._setUpdateFlag(e._UPDATE_MIN|e._UPDATE_MAX,!0),this._setUpdateFlag(e._UPDATE_EXTENT,!1)}},{key:"getExtent",value:function(){return this._getUpdateFlag(e._UPDATE_EXTENT)&&(this._getExtent(this.getMin(),this.getMax(),this._extent),this._setUpdateFlag(e._UPDATE_EXTENT,!1)),this._extent}},{key:"_getUpdateFlag",value:function(e){return 0!=(this._updateFlag&e)}},{key:"_setUpdateFlag",value:function(e,t){t?this._updateFlag|=e:this._updateFlag&=~e}},{key:"_getCenter",value:function(e,t,n){a.add(e,t,n),a.scale(n,.5,n)}},{key:"_getExtent",value:function(e,t,n){a.subtract(t,e,n),a.scale(n,.5,n)}},{key:"_getMin",value:function(e,t,n){a.subtract(e,t,n)}},{key:"_getMax",value:function(e,t,n){a.add(e,t,n)}},{key:"_rotateExtents",value:function(e,t,n){var r=e.x,i=e.y,a=e.z,o=t.elements;n.x=Math.abs(o[0]*r)+Math.abs(o[4]*i)+Math.abs(o[8]*a),n.y=Math.abs(o[1]*r)+Math.abs(o[5]*i)+Math.abs(o[9]*a),n.z=Math.abs(o[2]*r)+Math.abs(o[6]*i)+Math.abs(o[10]*a)}},{key:"_tranform",value:function(e,t){var n=t._center,r=t._extent;a.transformCoordinate(this.getCenter(),e,n),this._rotateExtents(this.getExtent(),e,r),t._boundBox.setCenterAndExtent(n,r),t._updateFlag=0}},{key:"_getBoundBox",value:function(){if(this._updateFlag&e._UPDATE_MIN){var t=this._boundBox.min;this._getMin(this.getCenter(),this.getExtent(),t),this._setUpdateFlag(e._UPDATE_MIN,!1)}if(this._updateFlag&e._UPDATE_MAX){var n=this._boundBox.max;this._getMax(this.getCenter(),this.getExtent(),n),this._setUpdateFlag(e._UPDATE_MAX,!1)}return this._boundBox}},{key:"cloneTo",value:function(e){var t=e;this.getMin().cloneTo(t._boundBox.min),this.getMax().cloneTo(t._boundBox.max),this.getCenter().cloneTo(t._center),this.getExtent().cloneTo(t._extent),t._updateFlag=0}},{key:"clone",value:function(){var t=new e(new a,new a);return this.cloneTo(t),t}}]),e}();$e._UPDATE_MIN=1,$e._UPDATE_MAX=2,$e._UPDATE_CENTER=4,$e._UPDATE_EXTENT=8;var et=function(e){function n(e){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));if(r._indexInList=-1,r._indexInCastShadowList=-1,r._boundsChange=!0,r._castShadow=!1,r._supportOctree=!0,r._sharedMaterials=[],r._visible=!0,r._indexInOctreeMotionList=-1,r._updateMark=-1,r._updateRenderType=-1,r._isPartOfStaticBatch=!1,r._staticBatch=null,r._id=++n._uniqueIDCounter,r._indexInCastShadowList=-1,r._bounds=new $e(a._ZERO,a._ZERO),t.Render.supportWebGLPlusCulling){var i=ce._cullingBufferLength;r._cullingBufferIndex=i;var o=ce._cullingBuffer,s=i+7;if(s>=o.length){var l=o;(o=ce._cullingBuffer=new Float32Array(o.length+4096)).set(l,0)}o[i]=2,ce._cullingBufferLength=s}return r._renderElements=[],r._owner=e,r._enable=!0,r._materialsInstance=[],r._shaderValues=new G(null),r.lightmapIndex=-1,r.receiveShadow=!1,r.sortingFudge=0,e&&r._owner.transform.on(t.Event.TRANSFORM_CHANGED,r,r._onWorldMatNeedChange),r}return _inherits(n,t.EventDispatcher),_createClass(n,[{key:"_getOctreeNode",value:function(){return this._octreeNode}},{key:"_setOctreeNode",value:function(e){this._octreeNode=e}},{key:"_getIndexInMotionList",value:function(){return this._indexInOctreeMotionList}},{key:"_setIndexInMotionList",value:function(e){this._indexInOctreeMotionList=e}},{key:"_changeMaterialReference",value:function(e,t){e&&e._removeReference(),t._addReference()}},{key:"_getInstanceMaterial",value:function(e,t){var n=e.clone();return n.name=n.name+"(Instance)",this._materialsInstance[t]=!0,this._changeMaterialReference(this._sharedMaterials[t],n),this._sharedMaterials[t]=n,n}},{key:"_applyLightMapParams",value:function(){if(this._scene&&this._lightmapIndex>=0){var e=this._scene.getlightmaps();this._lightmapIndex<e.length?(this._shaderValues.addDefine(_e.SAHDERDEFINE_LIGHTMAP),this._shaderValues.setTexture(_e.LIGHTMAP,e[this._lightmapIndex])):this._shaderValues.removeDefine(_e.SAHDERDEFINE_LIGHTMAP)}else this._shaderValues.removeDefine(_e.SAHDERDEFINE_LIGHTMAP)}},{key:"_onWorldMatNeedChange",value:function(e){this._boundsChange=!0,this._octreeNode&&(e&=se.TRANSFORM_WORLDPOSITION|se.TRANSFORM_WORLDQUATERNION|se.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this)}},{key:"_calculateBoundingBox",value:function(){throw"BaseRender: must override it."}},{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"_setBelongScene",value:function(e){this._scene!==e&&(this._scene=e,this._applyLightMapParams())}},{key:"_needRender",value:function(e,t){return!0}},{key:"_renderUpdate",value:function(e,t){}},{key:"_renderUpdateWithCamera",value:function(e,t){}},{key:"_revertBatchRenderUpdate",value:function(e){}},{key:"_destroy",value:function(){-1!==this._indexInOctreeMotionList&&this._octreeNode._octree.removeMotionObject(this),this.offAll();var e=0,t=0;for(e=0,t=this._renderElements.length;e<t;e++)this._renderElements[e].destroy();for(e=0,t=this._sharedMaterials.length;e<t;e++)this._sharedMaterials[e].destroyed||this._sharedMaterials[e]._removeReference();this._renderElements=null,this._owner=null,this._sharedMaterials=null,this._bounds=null,this._lightmapScaleOffset=null}},{key:"markAsUnStatic",value:function(){this._isPartOfStaticBatch&&(Qe.instance._removeRenderSprite(this._owner),this._isPartOfStaticBatch=!1)}},{key:"id",get:function(){return this._id}},{key:"lightmapIndex",get:function(){return this._lightmapIndex},set:function(e){this._lightmapIndex!==e&&(this._lightmapIndex=e,this._applyLightMapParams())}},{key:"lightmapScaleOffset",get:function(){return this._lightmapScaleOffset},set:function(e){this._lightmapScaleOffset=e,this._shaderValues.setVector(_e.LIGHTMAPSCALEOFFSET,e),this._shaderValues.addDefine(_e.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=!!e}},{key:"material",get:function(){var e=this._sharedMaterials[0];if(e&&!this._materialsInstance[0]){var t=this._getInstanceMaterial(e,0),n=this._renderElements[0];n&&(n.material=t)}return this._sharedMaterials[0]},set:function(e){this.sharedMaterial=e}},{key:"materials",get:function(){for(var e=0,t=this._sharedMaterials.length;e<t;e++)if(!this._materialsInstance[e]){var n=this._getInstanceMaterial(this._sharedMaterials[e],e),r=this._renderElements[e];r&&(r.material=n)}return this._sharedMaterials.slice()},set:function(e){this.sharedMaterials=e}},{key:"sharedMaterial",get:function(){return this._sharedMaterials[0]},set:function(e){var t=this._sharedMaterials[0];if(t!==e){this._sharedMaterials[0]=e,this._materialsInstance[0]=!1,this._changeMaterialReference(t,e);var n=this._renderElements[0];n&&(n.material=e)}}},{key:"sharedMaterials",get:function(){return this._sharedMaterials.slice()},set:function(e){for(var t=this._materialsInstance,n=this._sharedMaterials,r=0,i=n.length;r<i;r++){var a=n[r];a&&a._removeReference()}if(!e)throw new Error("BaseRender: shadredMaterials value can't be null.");var o=e.length;for(t.length=o,n.length=o,r=0;r<o;r++){a=n[r];var s=e[r];if(a!==s){t[r]=!1;var l=this._renderElements[r];l&&(l.material=s)}s&&s._addReference(),n[r]=s}}},{key:"bounds",get:function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}},{key:"receiveShadow",set:function(e){this._receiveShadow!==e&&(this._receiveShadow=e,e?this._shaderValues.addDefine(_e.SHADERDEFINE_RECEIVE_SHADOW):this._shaderValues.removeDefine(_e.SHADERDEFINE_RECEIVE_SHADOW))},get:function(){return this._receiveShadow}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"isPartOfStaticBatch",get:function(){return this._isPartOfStaticBatch}}]),n}();et._tempBoundBoxCorners=[new a,new a,new a,new a,new a,new a,new a,new a],et._uniqueIDCounter=0;var tt=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t._revertStaticBatchDefineUV1=!1,t._revertStaticBatchDefineLightMapUV=!1,t._projectionViewWorldMatrix=new T,t}return _inherits(n,et),_createClass(n,[{key:"_createRenderElement",value:function(){return new je}},{key:"_onMeshChange",value:function(e){if(e){var t=e.subMeshCount;this._renderElements.length=t;for(var n=0;n<t;n++){var r=this._renderElements[n];if(!r){var i=this.sharedMaterials[n];(r=this._renderElements[n]=this._createRenderElement()).setTransform(this._owner._transform),r.render=this,r.material=i||Q.defaultMaterial}r.setGeometry(e.getSubMesh(n))}}else this._renderElements.length=0;this._boundsChange=!0}},{key:"_calculateBoundingBox",value:function(){var e=this._owner.meshFilter.sharedMesh;if(e){var n=this._owner.transform.worldMatrix;e.bounds._tranform(n,this._bounds)}if(t.Render.supportWebGLPlusCulling){var r=this._bounds.getMin(),i=this._bounds.getMax(),a=ce._cullingBuffer;a[this._cullingBufferIndex+1]=r.x,a[this._cullingBufferIndex+2]=r.y,a[this._cullingBufferIndex+3]=r.z,a[this._cullingBufferIndex+4]=i.x,a[this._cullingBufferIndex+5]=i.y,a[this._cullingBufferIndex+6]=i.z}}},{key:"_needRender",value:function(e,t){return!e||e.intersects(this.bounds._getBoundBox())}},{key:"_renderUpdate",value:function(e,t){var n=e.renderElement;switch(n.renderType){case Ye.RENDERTYPE_NORMAL:this._shaderValues.setMatrix4x4(le.WORLDMATRIX,t.worldMatrix);break;case Ye.RENDERTYPE_STATICBATCH:t?this._shaderValues.setMatrix4x4(le.WORLDMATRIX,t.worldMatrix):this._shaderValues.setMatrix4x4(le.WORLDMATRIX,T.DEFAULT),this._shaderValues.hasDefine(Ke.SHADERDEFINE_UV1)?this._revertStaticBatchDefineUV1=!1:(this._shaderValues.addDefine(Ke.SHADERDEFINE_UV1),this._revertStaticBatchDefineUV1=!0),this._shaderValues.hasDefine(_e.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV)?(this._shaderValues.removeDefine(_e.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV),this._revertStaticBatchDefineLightMapUV=!0):this._revertStaticBatchDefineLightMapUV=!1;break;case Ye.RENDERTYPE_VERTEXBATCH:this._shaderValues.setMatrix4x4(le.WORLDMATRIX,T.DEFAULT);break;case Ye.RENDERTYPE_INSTANCEBATCH:for(var r=pe.instance.instanceWorldMatrixData,i=n.instanceBatchElementList,a=i.elements,o=i.length,s=0;s<o;s++)r.set(a[s]._transform.worldMatrix.elements,16*s);pe.instance.instanceWorldMatrixBuffer.setData(r.buffer,0,0,16*o*4),this._shaderValues.addDefine(Ke.SHADERDEFINE_GPU_INSTANCE)}}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix,r=e.renderElement;switch(r.renderType){case Ye.RENDERTYPE_NORMAL:case Ye.RENDERTYPE_STATICBATCH:case Ye.RENDERTYPE_VERTEXBATCH:t?(T.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(le.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(le.MVPMATRIX,n);break;case Ye.RENDERTYPE_INSTANCEBATCH:for(var i=pe.instance.instanceMVPMatrixData,a=r.instanceBatchElementList,o=a.elements,s=a.length,l=0;l<s;l++){var _=o[l]._transform.worldMatrix;A.mulMatrixByArray(n.elements,0,_.elements,0,i,16*l)}pe.instance.instanceMVPMatrixBuffer.setData(i.buffer,0,0,16*s*4)}}},{key:"_revertBatchRenderUpdate",value:function(e){switch(e.renderElement.renderType){case Ye.RENDERTYPE_STATICBATCH:this._revertStaticBatchDefineUV1&&this._shaderValues.removeDefine(Ke.SHADERDEFINE_UV1),this._revertStaticBatchDefineLightMapUV&&this._shaderValues.addDefine(_e.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV);break;case Ye.RENDERTYPE_INSTANCEBATCH:this._shaderValues.removeDefine(Ke.SHADERDEFINE_GPU_INSTANCE)}}},{key:"_destroy",value:function(){this._isPartOfStaticBatch&&Qe.instance._removeRenderSprite(this._owner),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_destroy",this).call(this)}}]),n}(),nt=function(){function e(t){_classCallCheck(this,e),this._owner=t}return _createClass(e,[{key:"_getMeshDefine",value:function(e,t){t.length=0;for(var n=0,r=e._subMeshes.length;n<r;n++)for(var i=e.getSubMesh(n)._vertexBuffer._vertexDeclaration._vertexElements,a=0,o=i.length;a<o;a++){switch(i[a]._elementUsage){case Te.MESH_COLOR0:t.push(Ke.SHADERDEFINE_COLOR);break;case Te.MESH_TEXTURECOORDINATE0:t.push(Ke.SHADERDEFINE_UV0);break;case Te.MESH_TEXTURECOORDINATE1:t.push(Ke.SHADERDEFINE_UV1)}}}},{key:"destroy",value:function(){this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)}},{key:"sharedMesh",get:function(){return this._sharedMesh},set:function(t){if(this._sharedMesh!==t){var n=this._owner._render._shaderValues,r=this._sharedMesh;if(r){r._removeReference(),this._getMeshDefine(r,e._meshVerticeDefine);for(var i=0,a=e._meshVerticeDefine.length;i<a;i++)n.removeDefine(e._meshVerticeDefine[i])}if(t){t._addReference(),this._getMeshDefine(t,e._meshVerticeDefine);for(i=0,a=e._meshVerticeDefine.length;i<a;i++)n.addDefine(e._meshVerticeDefine[i])}this._owner._render._onMeshChange(t),this._sharedMesh=t}}}]),e}();nt._meshVerticeDefine=[];var rt=function(n){function r(){_classCallCheck(this,r);var n=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));n._bufferState=new Oe;var i=t.LayaGL.instance,a=Te.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT").vertexStride*r.maxIndicesCount;n._vertices=new Float32Array(a/4),n._vertexBuffer=new fe(a,i.DYNAMIC_DRAW),n._indices=new Int16Array(r.maxIndicesCount),n._indexBuffer=new Ne(e.IndexFormat.UInt16,n._indices.length,i.DYNAMIC_DRAW);var o=n._vertexBuffer._byteLength+n._indexBuffer._byteLength;return t.Resource._addMemory(o,o),n}return _inherits(r,de),_createClass(r,[{key:"_getBatchVertices",value:function(e,t,n,r,i,a){var o=e.vertexStride/4,s=a._vertexBuffer.getFloat32Data(),l=(i.render.lightmapScaleOffset,i._dynamicMultiSubMesh),_=i._dynamicVertexCount;i._computeWorldPositionsAndNormals(this._positionOffset,this._normalOffset,l,_);for(var u=i._dynamicWorldPositions,c=i._dynamicWorldNormals,h=a._indices,d=0;d<_;d++){var f=(l?h[d]:d)*o,m=(d+n)*o,E=3*d,v=m+this._positionOffset;t[v]=u[E],t[v+1]=u[E+1],t[v+2]=u[E+2],-1!==this._normalOffset&&(t[v=m+this._normalOffset]=c[E],t[v+1]=c[E+1],t[v+2]=c[E+2]),-1!==this._colorOffset&&(v=m+this._colorOffset,E=f+this._colorOffset,t[v]=s[E],t[v+1]=s[E+1],t[v+2]=s[E+2],t[v+3]=s[E+3]),-1!==this._uv0Offset&&(v=m+this._uv0Offset,E=f+this._uv0Offset,t[v]=s[E],t[v+1]=s[E+1]),-1!==this._sTangentOffset&&(v=m+this._sTangentOffset,E=f+this._sTangentOffset,t[v]=s[E],t[v+1]=s[E+1],t[v+2]=s[E+2],t[v+3]=s[E+3],v=m+this._sTangentOffset,E=f+this._sTangentOffset,t[v]=s[E],t[v+1]=s[E+1],t[v+2]=s[E+2],t[v+3]=s[E+3])}}},{key:"_getBatchIndices",value:function(e,t,n,r,i,a){var o,s,l,_=i._indices,u=r._isFrontFaceInvert;if(a)if(u)for(o=0,s=_.length;o<s;o+=3){var c=n+o;e[l=t+o]=c,e[l+1]=c+2,e[l+2]=c+1}else for(o=0,s=_.length;o<s;o+=3)c=n+o,e[l=t+o]=c,e[l+1]=c+1,e[l+2]=c+2;else if(u)for(o=0,s=_.length;o<s;o+=3)e[l=t+o]=n+_[o],e[l+1]=n+_[o+2],e[l+2]=n+_[o+1];else for(o=0,s=_.length;o<s;o+=3)e[l=t+o]=n+_[o],e[l+1]=n+_[o+1],e[l+2]=n+_[o+2]}},{key:"_flush",value:function(e,n){var r=t.LayaGL.instance;this._vertexBuffer.setData(this._vertices.buffer,0,0,e*this._bufferState.vertexDeclaration.vertexStride),this._indexBuffer.setData(this._indices,0,0,n),r.drawElements(r.TRIANGLES,n,r.UNSIGNED_SHORT,0)}},{key:"_prepareRender",value:function(e){var t=e.renderElement.vertexBatchVertexDeclaration;this._bufferState=s.MeshRenderDynamicBatchManager.instance._getBufferState(t),this._positionOffset=t.getVertexElementByUsage(Te.MESH_POSITION0)._offset/4;var n=t.getVertexElementByUsage(Te.MESH_NORMAL0);this._normalOffset=n?n._offset/4:-1;var r=t.getVertexElementByUsage(Te.MESH_COLOR0);this._colorOffset=r?r._offset/4:-1;var i=t.getVertexElementByUsage(Te.MESH_TEXTURECOORDINATE0);this._uv0Offset=i?i._offset/4:-1;var a=t.getVertexElementByUsage(Te.MESH_TEXTURECOORDINATE1);this._uv1Offset=a?a._offset/4:-1;var o=t.getVertexElementByUsage(Te.MESH_TANGENT0);return this._sTangentOffset=o?o._offset/4:-1,!0}},{key:"_render",value:function(e){this._bufferState.bind();for(var n=e.renderElement,i=n.vertexBatchVertexDeclaration,a=n.vertexBatchElementList,o=0,s=0,l=(i.vertexStride,0),_=a.length,u=a.elements,c=0;c<_;c++){var h=u[c],d=h._geometry,f=d._indexCount;s+f>r.maxIndicesCount&&(this._flush(o,s),l++,t.Stat.trianglesFaces+=s/3,o=s=0);var m=h._transform;this._getBatchVertices(i,this._vertices,o,m,h,d),this._getBatchIndices(this._indices,s,o,m,d,h._dynamicMultiSubMesh),o+=h._dynamicVertexCount,s+=f}this._flush(o,s),l++,t.Stat.renderBatches+=l,t.Stat.savedRenderBatches+=_-l,t.Stat.trianglesFaces+=s/3}}],[{key:"__init__",value:function(){r.instance=new r}}]),r}();rt.maxAllowVertexCount=10,rt.maxAllowAttribueCount=900,rt.maxIndicesCount=32e3;var it=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._instanceBatchOpaqueMarks=[],e._vertexBatchOpaqueMarks=[],e._cacheBufferStates=[],e._updateCountMark=0,e}return _inherits(t,oe),_createClass(t,[{key:"getInstanceBatchOpaquaMark",value:function(e,t,n,r){var i=this._instanceBatchOpaqueMarks[e?0:1]||(this._instanceBatchOpaqueMarks[e?0:1]=[]),a=i[t]||(i[t]=[]),o=a[n]||(a[n]=[]);return o[r?1:0]||(o[r?1:0]=new he)}},{key:"getVertexBatchOpaquaMark",value:function(e,t,n,r){var i=this._vertexBatchOpaqueMarks[e]||(this._vertexBatchOpaqueMarks[e]=[]),a=i[t?0:1]||(i[t?0:1]=[]),o=a[n]||(a[n]=[]);return o[r]||(o[r]=new he)}},{key:"_getBufferState",value:function(e){var t=this._cacheBufferStates[e.id];if(!t){var n=rt.instance;(t=new Oe).bind();var r=n._vertexBuffer;r.vertexDeclaration=e,t.applyVertexBuffer(r),t.applyIndexBuffer(n._indexBuffer),t.unBind(),this._cacheBufferStates[e.id]=t}return t}},{key:"_getBatchRenderElementFromPool",value:function(){var e=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return e||(e=new je,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=e,e.vertexBatchElementList=new qe,e.instanceBatchElementList=new qe),e}},{key:"_clear",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_clear",this).call(this),this._updateCountMark++}}]),t}();it.instance=new it;var at=function(e){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return r._meshFilter=new nt(r),r._render=new tt(r),e&&(r._meshFilter.sharedMesh=e),r}return _inherits(n,_e),_createClass(n,[{key:"meshFilter",get:function(){return this._meshFilter}},{key:"meshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){Ke.SHADERDEFINE_UV0=U.getDefineByName("UV"),Ke.SHADERDEFINE_COLOR=U.getDefineByName("COLOR"),Ke.SHADERDEFINE_UV1=U.getDefineByName("UV1"),Ke.SHADERDEFINE_GPU_INSTANCE=U.getDefineByName("GPU_INSTANCE"),ue._registerManager(Qe.instance),oe._registerManager(it.instance)}}]),_createClass(n,[{key:"_parse",value:function(e,r){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_parse",this).call(this,e,r);var a=this.meshRenderer,o=e.lightmapIndex;null!=o&&(a.lightmapIndex=o);var s=e.lightmapScaleOffset;s&&(a.lightmapScaleOffset=new i(s[0],s[1],s[2],s[3])),void 0!=e.meshPath&&(this.meshFilter.sharedMesh=t.Loader.getRes(e.meshPath)),void 0!=e.enableRender&&(this.meshRenderer.enable=e.enableRender);var l=e.materials;if(l){var _=a.sharedMaterials,u=l.length;_.length=u;for(var c=0;c<u;c++)_[c]=t.Loader.getRes(l[c].path);a.sharedMaterials=_}}},{key:"_addToInitStaticBatchManager",value:function(){this.meshFilter.sharedMesh&&Qe.instance._addBatchSprite(this)}},{key:"_cloneTo",value:function(e,t,r){var i=e;i._meshFilter.sharedMesh=this._meshFilter.sharedMesh;var a=this._render,o=i._render;o.enable=a.enable,o.sharedMaterials=a.sharedMaterials,o.castShadow=a.castShadow;var s=a.lightmapScaleOffset;s&&(o.lightmapScaleOffset=s.clone()),o.lightmapIndex=a.lightmapIndex,o.receiveShadow=a.receiveShadow,o.sortingFudge=a.sortingFudge,_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_cloneTo",this).call(this,e,t,r)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new n}}]),n}(),ot=function e(){_classCallCheck(this,e)};ot.Blend=0,ot.Fixed=1;var st=function(){function e(t,n){_classCallCheck(this,e),this._mode=0,this._maxColorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorRGBKeysCount=0,this._colorAlphaKeysCount=0,this._alphaElements=null,this._rgbElements=null,this._maxColorRGBKeysCount=t,this._maxColorAlphaKeysCount=n,this._rgbElements=new Float32Array(4*t),this._alphaElements=new Float32Array(2*n)}return _createClass(e,[{key:"addColorRGB",value:function(e,t){if(this._colorRGBKeysCount<this._maxColorRGBKeysCount){var n=4*this._colorRGBKeysCount;this._rgbElements[n]=e,this._rgbElements[n+1]=t.r,this._rgbElements[n+2]=t.g,this._rgbElements[n+3]=t.b,this._colorRGBKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorRGBKeysCount)}},{key:"addColorAlpha",value:function(e,t){if(this._colorAlphaKeysCount<this._maxColorAlphaKeysCount){var n=2*this._colorAlphaKeysCount;this._alphaElements[n]=e,this._alphaElements[n+1]=t,this._colorAlphaKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorAlphaKeysCount)}},{key:"updateColorRGB",value:function(e,t,n){if(e<this._colorRGBKeysCount){var r=4*e;this._rgbElements[r]=t,this._rgbElements[r+1]=n.r,this._rgbElements[r+2]=n.g,this._rgbElements[r+3]=n.b}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount)}},{key:"updateColorAlpha",value:function(e,t,n){if(e<this._colorAlphaKeysCount){var r=2*e;this._alphaElements[r]=t,this._alphaElements[r+1]=n}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount)}},{key:"evaluateColorRGB",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=Math.min(Math.max(e,0),1);var i=this._rgbElements,a=n;if(r)for(var o=a;o>=0;o--){var s=4*o;if(e===(d=i[s]))return t.r=i[s+1],t.g=i[s+2],t.b=i[s+3],a;switch(this._mode){case ot.Blend:if(e>d){if(e>(h=i[s+4]))throw"Gradient:wrong startSearchIndex.";var l=h-d,_=h-e,u=e-d;return t.r=(_*i[s+1]+u*i[s+5])/l,t.g=(_*i[s+2]+u*i[s+6])/l,t.b=(_*i[s+3]+u*i[s+7])/l,a}a--;continue;case ot.Fixed:if(e>d){if(e>i[s+4])throw"Gradient:wrong startSearchIndex.";return t.r=i[s+5],t.g=i[s+6],t.b=i[s+7],a}a--;continue;default:throw"Gradient:unknown mode."}}else{o=0;for(var c=this._rgbElements.length;o<c;o++){var h;if(e===(h=i[s=4*o]))return t.r=i[s+1],t.g=i[s+2],t.b=i[s+3],a;switch(this._mode){case ot.Blend:if(e<h){var d;if(e<(d=i[s-4]))throw"Gradient:wrong startSearchIndex.";l=h-d,_=h-e,u=e-d;return t.r=(_*i[s-3]+u*i[s+1])/l,t.g=(_*i[s-2]+u*i[s+2])/l,t.b=(_*i[s-1]+u*i[s+3])/l,a}a++;continue;case ot.Fixed:if(e<h){if(e<i[s-4])throw"Gradient:wrong startSearchIndex.";return t.r=i[s+1],t.g=i[s+2],t.b=i[s+3],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}},{key:"evaluateColorAlpha",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e=Math.min(Math.max(e,0),1);var i=this._alphaElements,a=n;if(r)for(var o=a;o>=0;o--){if(e===(d=i[c=2*o]))return t.a=i[c+1],a;switch(this._mode){case ot.Blend:if(e>d){if(e>(h=i[c+2]))throw"Gradient:wrong startSearchIndex.";var s=h-d,l=h-e,_=e-d;return t.a=(l*i[c+1]+_*i[c+3])/s,a}a--;continue;case ot.Fixed:if(e>d){if(e>i[c+2])throw"Gradient:wrong startSearchIndex.";return t.a=i[c+3],a}a--;continue;default:throw"Gradient:unknown mode."}}else{o=a;for(var u=this._alphaElements.length;o<u;o++){var c,h;if(e===(h=i[c=2*o]))return t.a=i[c+1],a;switch(this._mode){case ot.Blend:if(e<h){var d;if(e<(d=i[c-2]))throw"Gradient:wrong startSearchIndex.";s=h-d,l=h-e,_=e-d;return t.a=(l*i[c-1]+_*i[c+1])/s,a}a++;continue;case ot.Fixed:if(e<h){if(e<i[c-2])throw"Gradient:wrong startSearchIndex.";return t.a=i[c+1],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}},{key:"cloneTo",value:function(e){var t,n,r=e;r._colorAlphaKeysCount=this._colorAlphaKeysCount;var i=r._alphaElements;for(t=0,n=this._alphaElements.length;t<n;t++)i[t]=this._alphaElements[t];r._colorRGBKeysCount=this._colorRGBKeysCount;var a=r._rgbElements;for(t=0,n=this._rgbElements.length;t<n;t++)a[t]=this._rgbElements[t]}},{key:"clone",value:function(){var t=new e(this._maxColorRGBKeysCount,this._maxColorAlphaKeysCount);return this.cloneTo(t),t}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}},{key:"colorRGBKeysCount",get:function(){return this._colorRGBKeysCount}},{key:"colorAlphaKeysCount",get:function(){return this._colorAlphaKeysCount}},{key:"maxColorRGBKeysCount",get:function(){return this._maxColorRGBKeysCount}},{key:"maxColorAlphaKeysCount",get:function(){return this._maxColorAlphaKeysCount}}]),e}(),lt=function(){function e(t,n,r){_classCallCheck(this,e),this._time=t,this._minCount=n,this._maxCount=r}return _createClass(e,[{key:"time",get:function(){return this._time}},{key:"minCount",get:function(){return this._minCount}},{key:"maxCount",get:function(){return this._maxCount}}]),_createClass(e,[{key:"cloneTo",value:function(e){var t=e;t._time=this._time,t._minCount=this._minCount,t._maxCount=this._maxCount}},{key:"clone",value:function(){var t=new e(this._time,this._minCount,this._maxCount);return this.cloneTo(t),t}}]),e}(),_t=function(){function e(){_classCallCheck(this,e),this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradient.cloneTo(t._gradient),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax)}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}}],[{key:"createByConstant",value:function(t){var n=new e;return n._type=0,n._constant=t,n}},{key:"createByGradient",value:function(t){var n=new e;return n._type=1,n._gradient=t,n}},{key:"createByRandomTwoConstant",value:function(t,n){var r=new e;return r._type=2,r._constantMin=t,r._constantMax=n,r}},{key:"createByRandomTwoGradient",value:function(t,n){var r=new e;return r._type=3,r._gradientMin=t,r._gradientMax=n,r}}]),e}(),ut=function(){function e(t){_classCallCheck(this,e),this._color=t}return _createClass(e,[{key:"color",get:function(){return this._color}}]),_createClass(e,[{key:"cloneTo",value:function(e){var t=e;this._color.cloneTo(t._color),t.enable=this.enable}},{key:"clone",value:function(){var t;switch(this._color.type){case 0:t=_t.createByConstant(this._color.constant.clone());break;case 1:t=_t.createByGradient(this._color.gradient.clone());break;case 2:t=_t.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:t=_t.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var n=new e(t);return n.enable=this.enable,n}}]),e}(),ct=function(){function e(){_classCallCheck(this,e),this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._constant=this._constant,this._overTime&&this._overTime.cloneTo(t._overTime),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._overTimeMin&&this._overTimeMin.cloneTo(t._overTimeMin),this._overTimeMax&&this._overTimeMax.cloneTo(t._overTimeMax)}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"frameOverTimeData",get:function(){return this._overTime}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"frameOverTimeDataMin",get:function(){return this._overTimeMin}},{key:"frameOverTimeDataMax",get:function(){return this._overTimeMax}}],[{key:"createByConstant",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=new e;return n._type=0,n._constant=t,n}},{key:"createByOverTime",value:function(t){var n=new e;return n._type=1,n._overTime=t,n}},{key:"createByRandomTwoConstant",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=new e;return r._type=2,r._constantMin=t,r._constantMax=n,r}},{key:"createByRandomTwoOverTime",value:function(t,n){var r=new e;return r._type=3,r._overTimeMin=t,r._overTimeMax=n,r}}]),e}(),ht=function(){function e(){_classCallCheck(this,e),this._type=0,this._separateAxes=!1,this._constant=0,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,t._constant=this._constant,this._constantSeparate.cloneTo(t._constantSeparate),this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"type",get:function(){return this._type}},{key:"separateAxes",get:function(){return this._separateAxes}},{key:"constant",get:function(){return this._constant}},{key:"constantSeparate",get:function(){return this._constantSeparate}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"gradientW",get:function(){return this._gradientW}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"constantMinSeparate",get:function(){return this._constantMinSeparate}},{key:"constantMaxSeparate",get:function(){return this._constantMaxSeparate}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}},{key:"gradientWMin",get:function(){return this._gradientWMin}},{key:"gradientWMax",get:function(){return this._gradientWMax}}],[{key:"createByConstant",value:function(t){var n=new e;return n._type=0,n._separateAxes=!1,n._constant=t,n}},{key:"createByConstantSeparate",value:function(t){var n=new e;return n._type=0,n._separateAxes=!0,n._constantSeparate=t,n}},{key:"createByGradient",value:function(t){var n=new e;return n._type=1,n._separateAxes=!1,n._gradient=t,n}},{key:"createByGradientSeparate",value:function(t,n,r){var i=new e;return i._type=1,i._separateAxes=!0,i._gradientX=t,i._gradientY=n,i._gradientZ=r,i}},{key:"createByRandomTwoConstant",value:function(t,n){var r=new e;return r._type=2,r._separateAxes=!1,r._constantMin=t,r._constantMax=n,r}},{key:"createByRandomTwoConstantSeparate",value:function(t,n){var r=new e;return r._type=2,r._separateAxes=!0,r._constantMinSeparate=t,r._constantMaxSeparate=n,r}},{key:"createByRandomTwoGradient",value:function(t,n){var r=new e;return r._type=3,r._separateAxes=!1,r._gradientMin=t,r._gradientMax=n,r}},{key:"createByRandomTwoGradientSeparate",value:function(t,n,r,i,a,o,s,l){var _=new e;return _._type=3,_._separateAxes=!0,_._gradientXMin=t,_._gradientXMax=n,_._gradientYMin=r,_._gradientYMax=i,_._gradientZMin=a,_._gradientZMax=o,_._gradientWMin=s,_._gradientWMax=l,_}}]),e}(),dt=function(){function e(){_classCallCheck(this,e),this._currentLength=0,this._elements=new Float32Array(8)}return _createClass(e,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("Warning:data count must lessEqual than 4")}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,r=0,i=this._elements.length;r<i;r++)n[r]=this._elements[r]}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"gradientCount",get:function(){return this._currentLength/2}}]),e}(),ft=function(){function e(){_classCallCheck(this,e),this._currentLength=0,this._elements=new Float32Array(8)}return _createClass(e,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t):console.log("GradientDataNumber warning:data count must lessEqual than 4")}},{key:"getKeyByIndex",value:function(e){return this._elements[2*e]}},{key:"getValueByIndex",value:function(e){return this._elements[2*e+1]}},{key:"getAverageValue",value:function(){for(var e=0,t=this._currentLength-2;e<t;e+=2){this._elements[e+1];this._elements[e+3],this._elements[e+2]-this._elements[e]}return 0}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,r=0,i=this._elements.length;r<i;r++)n[r]=this._elements[r]}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"gradientCount",get:function(){return this._currentLength/2}}]),e}(),mt=function(){function e(){_classCallCheck(this,e),this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=0,this._constantMax=0,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}return _createClass(e,[{key:"getMaxSizeInGradient",value:function(){var e,t,n=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(e=0,t=this._gradientX.gradientCount;e<t;e++)n=Math.max(n,this._gradientX.getValueByIndex(e));for(e=0,t=this._gradientY.gradientCount;e<t;e++)n=Math.max(n,this._gradientY.getValueByIndex(e))}else for(e=0,t=this._gradient.gradientCount;e<t;e++)n=Math.max(n,this._gradient.getValueByIndex(e));break;case 1:this._separateAxes?(n=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),n=Math.max(n,this._constantMinSeparate.y),n=Math.max(n,this._constantMaxSeparate.y)):n=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(e=0,t=this._gradientXMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMin.getValueByIndex(e));for(e=0,t=this._gradientXMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientXMax.getValueByIndex(e));for(e=0,t=this._gradientYMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientYMin.getValueByIndex(e));for(e=0,t=this._gradientZMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientZMax.getValueByIndex(e))}else{for(e=0,t=this._gradientMin.gradientCount;e<t;e++)n=Math.max(n,this._gradientMin.getValueByIndex(e));for(e=0,t=this._gradientMax.gradientCount;e<t;e++)n=Math.max(n,this._gradientMax.getValueByIndex(e))}}return n}},{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._separateAxes=this._separateAxes,this._gradient.cloneTo(t._gradient),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),t._constantMin=this._constantMin,t._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(t._constantMinSeparate),this._constantMaxSeparate.cloneTo(t._constantMaxSeparate),this._gradientMin.cloneTo(t._gradientMin),this._gradientMax.cloneTo(t._gradientMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"type",get:function(){return this._type}},{key:"separateAxes",get:function(){return this._separateAxes}},{key:"gradient",get:function(){return this._gradient}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"constantMinSeparate",get:function(){return this._constantMinSeparate}},{key:"constantMaxSeparate",get:function(){return this._constantMaxSeparate}},{key:"gradientMin",get:function(){return this._gradientMin}},{key:"gradientMax",get:function(){return this._gradientMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}}],[{key:"createByGradient",value:function(t){var n=new e;return n._type=0,n._separateAxes=!1,n._gradient=t,n}},{key:"createByGradientSeparate",value:function(t,n,r){var i=new e;return i._type=0,i._separateAxes=!0,i._gradientX=t,i._gradientY=n,i._gradientZ=r,i}},{key:"createByRandomTwoConstant",value:function(t,n){var r=new e;return r._type=1,r._separateAxes=!1,r._constantMin=t,r._constantMax=n,r}},{key:"createByRandomTwoConstantSeparate",value:function(t,n){var r=new e;return r._type=1,r._separateAxes=!0,r._constantMinSeparate=t,r._constantMaxSeparate=n,r}},{key:"createByRandomTwoGradient",value:function(t,n){var r=new e;return r._type=2,r._separateAxes=!1,r._gradientMin=t,r._gradientMax=n,r}},{key:"createByRandomTwoGradientSeparate",value:function(t,n,r,i,a,o){var s=new e;return s._type=2,s._separateAxes=!0,s._gradientXMin=t,s._gradientXMax=n,s._gradientYMin=r,s._gradientYMax=i,s._gradientZMin=a,s._gradientZMax=o,s}}]),e}(),Et=function(){function e(){_classCallCheck(this,e),this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,this._constant.cloneTo(t._constant),this._gradientX.cloneTo(t._gradientX),this._gradientY.cloneTo(t._gradientY),this._gradientZ.cloneTo(t._gradientZ),this._constantMin.cloneTo(t._constantMin),this._constantMax.cloneTo(t._constantMax),this._gradientXMin.cloneTo(t._gradientXMin),this._gradientXMax.cloneTo(t._gradientXMax),this._gradientYMin.cloneTo(t._gradientYMin),this._gradientYMax.cloneTo(t._gradientYMax),this._gradientZMin.cloneTo(t._gradientZMin),this._gradientZMax.cloneTo(t._gradientZMax)}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"gradientX",get:function(){return this._gradientX}},{key:"gradientY",get:function(){return this._gradientY}},{key:"gradientZ",get:function(){return this._gradientZ}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}},{key:"gradientXMin",get:function(){return this._gradientXMin}},{key:"gradientXMax",get:function(){return this._gradientXMax}},{key:"gradientYMin",get:function(){return this._gradientYMin}},{key:"gradientYMax",get:function(){return this._gradientYMax}},{key:"gradientZMin",get:function(){return this._gradientZMin}},{key:"gradientZMax",get:function(){return this._gradientZMax}}],[{key:"createByConstant",value:function(t){var n=new e;return n._type=0,n._constant=t,n}},{key:"createByGradient",value:function(t,n,r){var i=new e;return i._type=1,i._gradientX=t,i._gradientY=n,i._gradientZ=r,i}},{key:"createByRandomTwoConstant",value:function(t,n){var r=new e;return r._type=2,r._constantMin=t,r._constantMax=n,r}},{key:"createByRandomTwoGradient",value:function(t,n,r,i,a,o){var s=new e;return s._type=3,s._gradientXMin=t,s._gradientXMax=n,s._gradientYMin=r,s._gradientYMax=i,s._gradientZMin=a,s._gradientZMax=o,s}}]),e}(),vt=function(){function e(t){_classCallCheck(this,e),this._angularVelocity=t}return _createClass(e,[{key:"angularVelocity",get:function(){return this._angularVelocity}}]),_createClass(e,[{key:"cloneTo",value:function(e){var t=e;this._angularVelocity.cloneTo(t._angularVelocity),t.enable=this.enable}},{key:"clone",value:function(){var t;switch(this._angularVelocity.type){case 0:t=this._angularVelocity.separateAxes?ht.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):ht.createByConstant(this._angularVelocity.constant);break;case 1:t=this._angularVelocity.separateAxes?ht.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone()):ht.createByGradient(this._angularVelocity.gradient.clone());break;case 2:t=this._angularVelocity.separateAxes?ht.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):ht.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:t=this._angularVelocity.separateAxes?ht.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):ht.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var n=new e(t);return n.enable=this.enable,n}}]),e}(),Tt=function(){function e(){_classCallCheck(this,e),this.enable=!0,this.randomDirection=0}return _createClass(e,[{key:"_getShapeBoundBox",value:function(e){throw new Error("BaseShape: must override it.")}},{key:"_getSpeedBoundBox",value:function(e){throw new Error("BaseShape: must override it.")}},{key:"generatePositionAndDirection",value:function(e,t){arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3];throw new Error("BaseShape: must override it.")}},{key:"_calculateProceduralBounds",value:function(e,t,n){this._getShapeBoundBox(e);var r=e.min,i=e.max;a.multiply(r,t,r),a.multiply(i,t,i);var o=new Je(new a,new a);this.randomDirection?(o.min=new a(-1,-1,-1),o.max=new a(1,1,1)):this._getSpeedBoundBox(o);var s=new Je(new a,new a),l=s.min,_=s.max;a.scale(o.min,n.y,l),a.scale(o.max,n.y,_),a.add(e.min,l,l),a.add(e.max,_,_),a.min(e.min,l,e.min),a.max(e.max,l,e.max);var u=new Je(new a,new a),c=u.min,h=u.max;a.scale(o.min,n.x,c),a.scale(o.max,n.x,h),a.min(u.min,h,l),a.max(u.min,h,_),a.min(e.min,l,e.min),a.max(e.max,l,e.max)}},{key:"cloneTo",value:function(e){e.enable=this.enable}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}}]),e}(),pt=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"_randomPointUnitArcCircle",value:function(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;n=r?r.getFloat()*e:Math.random()*e,t.x=Math.cos(n),t.y=Math.sin(n)}},{key:"_randomPointInsideUnitArcCircle",value:function(t,n){var r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;e._randomPointUnitArcCircle(t,n,i),r=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),n.x=n.x*r,n.y=n.y*r}},{key:"_randomPointUnitCircle",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t=n?n.getFloat()*Math.PI*2:Math.random()*Math.PI*2,e.x=Math.cos(t),e.y=Math.sin(t)}},{key:"_randomPointInsideUnitCircle",value:function(t){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e._randomPointUnitCircle(t),n=r?Math.pow(r.getFloat(),.5):Math.pow(Math.random(),.5),t.x=t.x*n,t.y=t.y*n}},{key:"_randomPointUnitSphere",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;r?(t=e.z=2*r.getFloat()-1,n=r.getFloat()*Math.PI*2):(t=e.z=2*Math.random()-1,n=Math.random()*Math.PI*2);var i=Math.sqrt(1-t*t);e.x=i*Math.cos(n),e.y=i*Math.sin(n)}},{key:"_randomPointInsideUnitSphere",value:function(t){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e._randomPointUnitSphere(t),n=r?Math.pow(r.getFloat(),1/3):Math.pow(Math.random(),1/3),t.x=t.x*n,t.y=t.y*n,t.z=t.z*n}},{key:"_randomPointInsideHalfUnitBox",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;t?(e.x=t.getFloat()-.5,e.y=t.getFloat()-.5,e.z=t.getFloat()-.5):(e.x=Math.random()-.5,e.y=Math.random()-.5,e.z=Math.random()-.5)}}]),e}(),gt=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.x=1,e.y=1,e.z=1,e}return _inherits(t,Tt),_createClass(t,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=.5*-this.x,t.y=.5*-this.y,t.z=.5*-this.z;var n=e.max;n.x=.5*this.x,n.y=.5*this.y,n.z=.5*this.z}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=0,t.y=0,t.z=0;var n=e.max;n.x=0,n.y=1,n.z=0}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=r[16],pt._randomPointInsideHalfUnitBox(e,n),r[16]=n.seed):pt._randomPointInsideHalfUnitBox(e),e.x=this.x*e.x,e.y=this.y*e.y,e.z=this.z*e.z,this.randomDirection?n?(n.seed=r[17],pt._randomPointUnitSphere(t,n),r[17]=n.seed):pt._randomPointUnitSphere(t):(t.x=0,t.y=0,t.z=1)}},{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;n.x=this.x,n.y=this.y,n.z=this.z,n.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}}]),t}(),yt=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.radius=1,e.arc=2*Math.PI,e.emitFromEdge=!1,e}return _inherits(t,Tt),_createClass(t,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.z=-this.radius,t.y=0;var n=e.max;n.x=n.z=this.radius,n.y=0}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=-1,t.z=0;var n=e.max;n.x=n.y=1,n.z=0}},{key:"generatePositionAndDirection",value:function(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=t._tempPositionPoint;r?(r.seed=i[16],this.emitFromEdge?pt._randomPointUnitArcCircle(this.arc,t._tempPositionPoint,r):pt._randomPointInsideUnitArcCircle(this.arc,t._tempPositionPoint,r),i[16]=r.seed):this.emitFromEdge?pt._randomPointUnitArcCircle(this.arc,t._tempPositionPoint):pt._randomPointInsideUnitArcCircle(this.arc,t._tempPositionPoint),e.x=-o.x,e.y=o.y,e.z=0,a.scale(e,this.radius,e),this.randomDirection?r?(r.seed=i[17],pt._randomPointUnitSphere(n,r),i[17]=r.seed):pt._randomPointUnitSphere(n):e.cloneTo(n)}},{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;n.radius=this.radius,n.arc=this.arc,n.emitFromEdge=this.emitFromEdge,n.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}}]),t}();yt._tempPositionPoint=new r;var St=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.angle=25/180*Math.PI,e.radius=1,e.length=5,e.emitType=0,e}return _inherits(t,Tt),_createClass(t,[{key:"_getShapeBoundBox",value:function(e){var t=this.radius+this.length*Math.sin(this.angle),n=this.length*Math.cos(this.angle),r=e.min;r.x=r.y=-t,r.z=0;var i=e.max;i.x=i.y=t,i.z=n}},{key:"_getSpeedBoundBox",value:function(e){var t=Math.sin(this.angle),n=e.min;n.x=n.y=-t,n.z=0;var r=e.max;r.x=r.y=t,r.z=1}},{key:"generatePositionAndDirection",value:function(e,n){var r,i,o,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,_=t._tempPositionPoint,u=Math.cos(this.angle),c=Math.sin(this.angle);switch(this.emitType){case 0:s?(s.seed=l[16],pt._randomPointInsideUnitCircle(t._tempPositionPoint,s),l[16]=s.seed):pt._randomPointInsideUnitCircle(t._tempPositionPoint),r=_.x,i=_.y,e.x=r*this.radius,e.y=i*this.radius,e.z=0,this.randomDirection?(s?(s.seed=l[17],pt._randomPointInsideUnitCircle(t._tempDirectionPoint,s),l[17]=s.seed):pt._randomPointInsideUnitCircle(t._tempDirectionPoint),o=t._tempDirectionPoint,n.x=o.x*c,n.y=o.y*c):(n.x=r*c,n.y=i*c),n.z=u;break;case 1:s?(s.seed=l[16],pt._randomPointUnitCircle(t._tempPositionPoint,s),l[16]=s.seed):pt._randomPointUnitCircle(t._tempPositionPoint),r=_.x,i=_.y,e.x=r*this.radius,e.y=i*this.radius,e.z=0,this.randomDirection?(s?(s.seed=l[17],pt._randomPointInsideUnitCircle(t._tempDirectionPoint,s),l[17]=s.seed):pt._randomPointInsideUnitCircle(t._tempDirectionPoint),o=t._tempDirectionPoint,n.x=o.x*c,n.y=o.y*c):(n.x=r*c,n.y=i*c),n.z=u;break;case 2:s?(s.seed=l[16],pt._randomPointInsideUnitCircle(t._tempPositionPoint,s)):pt._randomPointInsideUnitCircle(t._tempPositionPoint),r=_.x,i=_.y,e.x=r*this.radius,e.y=i*this.radius,e.z=0,n.x=r*c,n.y=i*c,n.z=u,a.normalize(n,n),s?(a.scale(n,this.length*s.getFloat(),n),l[16]=s.seed):a.scale(n,this.length*Math.random(),n),a.add(e,n,e),this.randomDirection&&(s?(s.seed=l[17],pt._randomPointUnitSphere(n,s),l[17]=s.seed):pt._randomPointUnitSphere(n));break;case 3:s?(s.seed=l[16],pt._randomPointUnitCircle(t._tempPositionPoint,s)):pt._randomPointUnitCircle(t._tempPositionPoint),r=_.x,i=_.y,e.x=r*this.radius,e.y=i*this.radius,e.z=0,n.x=r*c,n.y=i*c,n.z=u,a.normalize(n,n),s?(a.scale(n,this.length*s.getFloat(),n),l[16]=s.seed):a.scale(n,this.length*Math.random(),n),a.add(e,n,e),this.randomDirection&&(s?(s.seed=l[17],pt._randomPointUnitSphere(n,s),l[17]=s.seed):pt._randomPointUnitSphere(n));break;default:throw new Error("ConeShape:emitType is invalid.")}}},{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;n.angle=this.angle,n.radius=this.radius,n.length=this.length,n.emitType=this.emitType,n.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}}]),t}();St._tempPositionPoint=new r,St._tempDirectionPoint=new r;var Rt=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.radius=1,e.emitFromShell=!1,e}return _inherits(t,Tt),_createClass(t,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-this.radius;var n=e.max;n.x=n.y=this.radius,n.z=0}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=-1,t.z=0;var n=e.max;n.x=n.y=n.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=r[16],this.emitFromShell?pt._randomPointUnitSphere(e,n):pt._randomPointInsideUnitSphere(e,n),r[16]=n.seed):this.emitFromShell?pt._randomPointUnitSphere(e):pt._randomPointInsideUnitSphere(e),a.scale(e,this.radius,e);var i=e.z;i<0&&(e.z=-1*i),this.randomDirection?n?(n.seed=r[17],pt._randomPointUnitSphere(t,n),r[17]=n.seed):pt._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}}]),t}(),Ct=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.radius=1,e.emitFromShell=!1,e}return _inherits(t,Tt),_createClass(t,[{key:"_getShapeBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-this.radius;var n=e.max;n.x=n.y=n.z=this.radius}},{key:"_getSpeedBoundBox",value:function(e){var t=e.min;t.x=t.y=t.z=-1;var n=e.max;n.x=n.y=n.z=1}},{key:"generatePositionAndDirection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;n?(n.seed=r[16],this.emitFromShell?pt._randomPointUnitSphere(e,n):pt._randomPointInsideUnitSphere(e,n),r[16]=n.seed):this.emitFromShell?pt._randomPointUnitSphere(e):pt._randomPointInsideUnitSphere(e),a.scale(e,this.radius,e),this.randomDirection?n?(n.seed=r[17],pt._randomPointUnitSphere(t,n),r[17]=n.seed):pt._randomPointUnitSphere(t):e.cloneTo(t)}},{key:"cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e);var n=e;n.radius=this.radius,n.emitFromShell=this.emitFromShell,n.randomDirection=this.randomDirection}},{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}}]),t}(),It=function(){function e(t){_classCallCheck(this,e),this._size=t}return _createClass(e,[{key:"size",get:function(){return this._size}}]),_createClass(e,[{key:"cloneTo",value:function(e){var t=e;this._size.cloneTo(t._size),t.enable=this.enable}},{key:"clone",value:function(){var t;switch(this._size.type){case 0:t=this._size.separateAxes?mt.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):mt.createByGradient(this._size.gradient.clone());break;case 1:t=this._size.separateAxes?mt.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):mt.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:t=this._size.separateAxes?mt.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):mt.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var n=new e(t);return n.enable=this.enable,n}}]),e}(),At=function(){function e(){_classCallCheck(this,e),this._type=0,this._constant=0,this._constantMin=0,this._constantMax=0}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;t._type=this._type,t._constant=this._constant,t._constantMin=this._constantMin,t._constantMax=this._constantMax}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"type",get:function(){return this._type}},{key:"constant",get:function(){return this._constant}},{key:"constantMin",get:function(){return this._constantMin}},{key:"constantMax",get:function(){return this._constantMax}}],[{key:"createByConstant",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=new e;return n._type=0,n._constant=t,n}},{key:"createByRandomTwoConstant",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=new e;return r._type=1,r._constantMin=t,r._constantMax=n,r}}]),e}(),xt=function(){function e(t,n){_classCallCheck(this,e),this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new r(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=t,this._startFrame=n}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;this.tiles.cloneTo(t.tiles),t.type=this.type,t.randomRow=this.randomRow,t.rowIndex=this.rowIndex,t.cycles=this.cycles,t.enableUVChannels=this.enableUVChannels,t.enable=this.enable,this._frame.cloneTo(t._frame),this._startFrame.cloneTo(t._startFrame)}},{key:"clone",value:function(){var t,n;switch(this._frame.type){case 0:t=ct.createByConstant(this._frame.constant);break;case 1:t=ct.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:t=ct.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:t=ct.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}switch(this._startFrame.type){case 0:n=At.createByConstant(this._startFrame.constant);break;case 1:n=At.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var r=new e(t,n);return this.cloneTo(r),r}},{key:"frame",get:function(){return this._frame}},{key:"startFrame",get:function(){return this._startFrame}}]),e}(),Dt=function(){function e(t){_classCallCheck(this,e),this.enable=!1,this.space=0,this._velocity=t}return _createClass(e,[{key:"cloneTo",value:function(e){var t=e;this._velocity.cloneTo(t._velocity),t.enable=this.enable,t.space=this.space}},{key:"clone",value:function(){var t;switch(this._velocity.type){case 0:t=Et.createByConstant(this._velocity.constant.clone());break;case 1:t=Et.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:t=Et.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:t=Et.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var n=new e(t);return n.enable=this.enable,n.space=this.space,n}},{key:"velocity",get:function(){return this._velocity}}]),e}(),Lt=function e(){_classCallCheck(this,e)};Lt.WORLDPOSITION=U.propertyNameToID("u_WorldPosition"),Lt.WORLDROTATION=U.propertyNameToID("u_WorldRotation"),Lt.POSITIONSCALE=U.propertyNameToID("u_PositionScale"),Lt.SIZESCALE=U.propertyNameToID("u_SizeScale"),Lt.SCALINGMODE=U.propertyNameToID("u_ScalingMode"),Lt.GRAVITY=U.propertyNameToID("u_Gravity"),Lt.THREEDSTARTROTATION=U.propertyNameToID("u_ThreeDStartRotation"),Lt.STRETCHEDBILLBOARDLENGTHSCALE=U.propertyNameToID("u_StretchedBillboardLengthScale"),Lt.STRETCHEDBILLBOARDSPEEDSCALE=U.propertyNameToID("u_StretchedBillboardSpeedScale"),Lt.SIMULATIONSPACE=U.propertyNameToID("u_SimulationSpace"),Lt.CURRENTTIME=U.propertyNameToID("u_CurrentTime"),Lt.VOLVELOCITYCONST=U.propertyNameToID("u_VOLVelocityConst"),Lt.VOLVELOCITYGRADIENTX=U.propertyNameToID("u_VOLVelocityGradientX"),Lt.VOLVELOCITYGRADIENTY=U.propertyNameToID("u_VOLVelocityGradientY"),Lt.VOLVELOCITYGRADIENTZ=U.propertyNameToID("u_VOLVelocityGradientZ"),Lt.VOLVELOCITYCONSTMAX=U.propertyNameToID("u_VOLVelocityConstMax"),Lt.VOLVELOCITYGRADIENTXMAX=U.propertyNameToID("u_VOLVelocityGradientMaxX"),Lt.VOLVELOCITYGRADIENTYMAX=U.propertyNameToID("u_VOLVelocityGradientMaxY"),Lt.VOLVELOCITYGRADIENTZMAX=U.propertyNameToID("u_VOLVelocityGradientMaxZ"),Lt.VOLSPACETYPE=U.propertyNameToID("u_VOLSpaceType"),Lt.COLOROVERLIFEGRADIENTALPHAS=U.propertyNameToID("u_ColorOverLifeGradientAlphas"),Lt.COLOROVERLIFEGRADIENTCOLORS=U.propertyNameToID("u_ColorOverLifeGradientColors"),Lt.MAXCOLOROVERLIFEGRADIENTALPHAS=U.propertyNameToID("u_MaxColorOverLifeGradientAlphas"),Lt.MAXCOLOROVERLIFEGRADIENTCOLORS=U.propertyNameToID("u_MaxColorOverLifeGradientColors"),Lt.SOLSIZEGRADIENT=U.propertyNameToID("u_SOLSizeGradient"),Lt.SOLSIZEGRADIENTX=U.propertyNameToID("u_SOLSizeGradientX"),Lt.SOLSIZEGRADIENTY=U.propertyNameToID("u_SOLSizeGradientY"),Lt.SOLSizeGradientZ=U.propertyNameToID("u_SOLSizeGradientZ"),Lt.SOLSizeGradientMax=U.propertyNameToID("u_SOLSizeGradientMax"),Lt.SOLSIZEGRADIENTXMAX=U.propertyNameToID("u_SOLSizeGradientMaxX"),Lt.SOLSIZEGRADIENTYMAX=U.propertyNameToID("u_SOLSizeGradientMaxY"),Lt.SOLSizeGradientZMAX=U.propertyNameToID("u_SOLSizeGradientMaxZ"),Lt.ROLANGULARVELOCITYCONST=U.propertyNameToID("u_ROLAngularVelocityConst"),Lt.ROLANGULARVELOCITYCONSTSEPRARATE=U.propertyNameToID("u_ROLAngularVelocityConstSeprarate"),Lt.ROLANGULARVELOCITYGRADIENT=U.propertyNameToID("u_ROLAngularVelocityGradient"),Lt.ROLANGULARVELOCITYGRADIENTX=U.propertyNameToID("u_ROLAngularVelocityGradientX"),Lt.ROLANGULARVELOCITYGRADIENTY=U.propertyNameToID("u_ROLAngularVelocityGradientY"),Lt.ROLANGULARVELOCITYGRADIENTZ=U.propertyNameToID("u_ROLAngularVelocityGradientZ"),Lt.ROLANGULARVELOCITYCONSTMAX=U.propertyNameToID("u_ROLAngularVelocityConstMax"),Lt.ROLANGULARVELOCITYCONSTMAXSEPRARATE=U.propertyNameToID("u_ROLAngularVelocityConstMaxSeprarate"),Lt.ROLANGULARVELOCITYGRADIENTMAX=U.propertyNameToID("u_ROLAngularVelocityGradientMax"),Lt.ROLANGULARVELOCITYGRADIENTXMAX=U.propertyNameToID("u_ROLAngularVelocityGradientMaxX"),Lt.ROLANGULARVELOCITYGRADIENTYMAX=U.propertyNameToID("u_ROLAngularVelocityGradientMaxY"),Lt.ROLANGULARVELOCITYGRADIENTZMAX=U.propertyNameToID("u_ROLAngularVelocityGradientMaxZ"),Lt.ROLANGULARVELOCITYGRADIENTWMAX=U.propertyNameToID("u_ROLAngularVelocityGradientMaxW"),Lt.TEXTURESHEETANIMATIONCYCLES=U.propertyNameToID("u_TSACycles"),Lt.TEXTURESHEETANIMATIONSUBUVLENGTH=U.propertyNameToID("u_TSASubUVLength"),Lt.TEXTURESHEETANIMATIONGRADIENTUVS=U.propertyNameToID("u_TSAGradientUVs"),Lt.TEXTURESHEETANIMATIONGRADIENTMAXUVS=U.propertyNameToID("u_TSAMaxGradientUVs");var Mt=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("PARTICLESHURIKEN"),e._color=new i(1,1,1,1),e.renderMode=t.RENDERMODE_ALPHABLENDED,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).x},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.x=e,this.tilingOffset=n}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).y},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.y=e,this.tilingOffset=n}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).z},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.z=e,this.tilingOffset=n}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).w},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.w=e,this.tilingOffset=n}},{key:"renderMode",set:function(e){switch(e){case t.RENDERMODE_ADDTIVE:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=q.CULL_NONE,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE,this.alphaTest=!1,this._shaderValues.addDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case t.RENDERMODE_ALPHABLENDED:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.depthWrite=!1,this.cull=q.CULL_NONE,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.alphaTest=!1,this._shaderValues.removeDefine(t.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("ShurikenParticleMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(t.TINTCOLOR)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_TINTCOLOR):this._shaderValues.removeDefine(t.SHADERDEFINE_TINTCOLOR),this._shaderValues.setVector(t.TINTCOLOR,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(t.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(t.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(t.TILINGOFFSET,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(t.DIFFUSETEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_DIFFUSEMAP):this._shaderValues.removeDefine(t.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(t.DIFFUSETEXTURE,e)}},{key:"depthWrite",get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)},set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)}},{key:"cull",get:function(){return this._shaderValues.getInt(t.CULL)},set:function(e){this._shaderValues.setInt(t.CULL,e)}},{key:"blend",get:function(){return this._shaderValues.getInt(t.BLEND)},set:function(e){this._shaderValues.setInt(t.BLEND,e)}},{key:"blendSrc",get:function(){return this._shaderValues.getInt(t.BLEND_SRC)},set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)}},{key:"blendDst",get:function(){return this._shaderValues.getInt(t.BLEND_DST)},set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)}},{key:"depthTest",get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)},set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_DIFFUSEMAP=U.getDefineByName("DIFFUSEMAP"),t.SHADERDEFINE_TINTCOLOR=U.getDefineByName("TINTCOLOR"),t.SHADERDEFINE_ADDTIVEFOG=U.getDefineByName("ADDTIVEFOG"),t.SHADERDEFINE_TILINGOFFSET=U.getDefineByName("TILINGOFFSET")}}]),t}();Mt.RENDERMODE_ALPHABLENDED=0,Mt.RENDERMODE_ADDTIVE=1,Mt.DIFFUSETEXTURE=U.propertyNameToID("u_texture"),Mt.TINTCOLOR=U.propertyNameToID("u_Tintcolor"),Mt.TILINGOFFSET=U.propertyNameToID("u_TilingOffset"),Mt.CULL=U.propertyNameToID("s_Cull"),Mt.BLEND=U.propertyNameToID("s_Blend"),Mt.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),Mt.BLEND_DST=U.propertyNameToID("s_BlendDst"),Mt.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),Mt.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var Ot=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"setColliderCollision",value:function(e,t,n){}},{key:"getIColliderCollision",value:function(e,t){return!1}}]),e}();Ot.COLLISIONFILTERGROUP_DEFAULTFILTER=1,Ot.COLLISIONFILTERGROUP_STATICFILTER=2,Ot.COLLISIONFILTERGROUP_KINEMATICFILTER=4,Ot.COLLISIONFILTERGROUP_DEBRISFILTER=8,Ot.COLLISIONFILTERGROUP_SENSORTRIGGER=16,Ot.COLLISIONFILTERGROUP_CHARACTERFILTER=32,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER1=64,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER2=128,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER3=256,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER4=512,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER5=1024,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER6=2048,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER7=4096,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER8=8192,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER9=16384,Ot.COLLISIONFILTERGROUP_CUSTOMFILTER10=32768,Ot.COLLISIONFILTERGROUP_ALLFILTER=-1,Ot.gravity=new a(0,-9.81,0);var Nt=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t._finalGravity=new a,t._tempRotationMatrix=new T,t._mesh=null,t.stretchedBillboardCameraSpeedScale=0,t.stretchedBillboardSpeedScale=0,t.stretchedBillboardLengthScale=2,t._defaultBoundBox=new Je(new a,new a),t.renderMode=0,t._supportOctree=!1,t}return _inherits(n,et),_createClass(n,[{key:"_calculateBoundingBox",value:function(){if((e=this._bounds.getMin()).x=-Number.MAX_VALUE,e.y=-Number.MAX_VALUE,e.z=-Number.MAX_VALUE,this._bounds.setMin(e),(n=this._bounds.getMax()).x=Number.MAX_VALUE,n.y=Number.MAX_VALUE,n.z=Number.MAX_VALUE,this._bounds.setMax(n),t.Render.supportWebGLPlusCulling){var e=this._bounds.getMin(),n=this._bounds.getMax(),r=ce._cullingBuffer;r[this._cullingBufferIndex+1]=e.x,r[this._cullingBufferIndex+2]=e.y,r[this._cullingBufferIndex+3]=e.z,r[this._cullingBufferIndex+4]=n.x,r[this._cullingBufferIndex+5]=n.y,r[this._cullingBufferIndex+6]=n.z}}},{key:"_needRender",value:function(e,t){return!e||!!e.intersects(this.bounds._getBoundBox())&&!!this._owner.particleSystem.isAlive}},{key:"_renderUpdate",value:function(e,t){var n=this._owner.particleSystem,r=this._shaderValues,i=this._owner.transform;switch(n.simulationSpace){case 0:break;case 1:r.setVector3(Lt.WORLDPOSITION,i.position),r.setQuaternion(Lt.WORLDROTATION,i.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(n.scaleMode){case 0:var o=i.getWorldLossyScale();r.setVector3(Lt.POSITIONSCALE,o),r.setVector3(Lt.SIZESCALE,o);break;case 1:var s=i.localScale;r.setVector3(Lt.POSITIONSCALE,s),r.setVector3(Lt.SIZESCALE,s);break;case 2:r.setVector3(Lt.POSITIONSCALE,i.getWorldLossyScale()),r.setVector3(Lt.SIZESCALE,a._ONE)}a.scale(Ot.gravity,n.gravityModifier,this._finalGravity),r.setVector3(Lt.GRAVITY,this._finalGravity),r.setInt(Lt.SIMULATIONSPACE,n.simulationSpace),r.setBool(Lt.THREEDSTARTROTATION,n.threeDStartRotation),r.setInt(Lt.SCALINGMODE,n.scaleMode),r.setNumber(Lt.STRETCHEDBILLBOARDLENGTHSCALE,this.stretchedBillboardLengthScale),r.setNumber(Lt.STRETCHEDBILLBOARDSPEEDSCALE,this.stretchedBillboardSpeedScale),r.setNumber(Lt.CURRENTTIME,n._currentTime)}},{key:"_destroy",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_destroy",this).call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){if(this._renderMode!==e){var t=this._shaderValues;switch(this._renderMode){case 0:t.removeDefine(Lt.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.removeDefine(Lt.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.removeDefine(Lt.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.removeDefine(Lt.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.removeDefine(Lt.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=e,e){case 0:t.addDefine(Lt.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:t.addDefine(Lt.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:t.addDefine(Lt.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:t.addDefine(Lt.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:t.addDefine(Lt.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}var n=this._owner.particleSystem;n&&n._initBufferDatas()}}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh&&this._mesh._removeReference(),this._mesh=e,e&&e._addReference(),this._owner.particleSystem._initBufferDatas())}},{key:"bounds",get:function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}}]),n}(),Pt=function e(){_classCallCheck(this,e)};Pt.PARTICLE_CORNERTEXTURECOORDINATE0=0,Pt.PARTICLE_POSITION0=1,Pt.PARTICLE_COLOR0=2,Pt.PARTICLE_TEXTURECOORDINATE0=3,Pt.PARTICLE_SHAPEPOSITIONSTARTLIFETIME=4,Pt.PARTICLE_DIRECTIONTIME=5,Pt.PARTICLE_STARTCOLOR0=6,Pt.PARTICLE_ENDCOLOR0=7,Pt.PARTICLE_STARTSIZE=8,Pt.PARTICLE_STARTROTATION=9,Pt.PARTICLE_STARTSPEED=10,Pt.PARTICLE_RANDOM0=11,Pt.PARTICLE_RANDOM1=12,Pt.PARTICLE_SIMULATIONWORLDPOSTION=13,Pt.PARTICLE_SIMULATIONWORLDROTATION=14;var bt=function(e){function t(e,n,r,i,a,o,s,l,_,u,c,h,d,f){_classCallCheck(this,t);var m=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return m._cornerTextureCoordinate=e,m._positionStartLifeTime=n,m._velocity=r,m._startColor=i,m._startSize=a,m._startRotation0=o,m._startRotation1=s,m._startRotation2=l,m._startLifeTime=_,m._time=u,m._startSpeed=c,m._randoms0=m.random0,m._randoms1=m.random1,m._simulationWorldPostion=f,m}return _inherits(t,Pt),_createClass(t,[{key:"cornerTextureCoordinate",get:function(){return this._cornerTextureCoordinate}},{key:"positionStartLifeTime",get:function(){return this._positionStartLifeTime}},{key:"velocity",get:function(){return this._velocity}},{key:"startColor",get:function(){return this._startColor}},{key:"startSize",get:function(){return this._startSize}},{key:"startRotation0",get:function(){return this._startRotation0}},{key:"startRotation1",get:function(){return this._startRotation1}},{key:"startRotation2",get:function(){return this._startRotation2}},{key:"startLifeTime",get:function(){return this._startLifeTime}},{key:"time",get:function(){return this._time}},{key:"startSpeed",get:function(){return this._startSpeed}},{key:"random0",get:function(){return this._randoms0}},{key:"random1",get:function(){return this._randoms1}},{key:"simulationWorldPostion",get:function(){return this._simulationWorldPostion}}],[{key:"__init__",value:function(){t._vertexDeclaration=new Ee(152,[new ve(0,me.Vector4,Pt.PARTICLE_CORNERTEXTURECOORDINATE0),new ve(16,me.Vector4,Pt.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new ve(32,me.Vector4,Pt.PARTICLE_DIRECTIONTIME),new ve(48,me.Vector4,Pt.PARTICLE_STARTCOLOR0),new ve(64,me.Vector3,Pt.PARTICLE_STARTSIZE),new ve(76,me.Vector3,Pt.PARTICLE_STARTROTATION),new ve(88,me.Single,Pt.PARTICLE_STARTSPEED),new ve(92,me.Vector4,Pt.PARTICLE_RANDOM0),new ve(108,me.Vector4,Pt.PARTICLE_RANDOM1),new ve(124,me.Vector3,Pt.PARTICLE_SIMULATIONWORLDPOSTION),new ve(136,me.Vector4,Pt.PARTICLE_SIMULATIONWORLDROTATION)])}},{key:"vertexDeclaration",get:function(){return t._vertexDeclaration}}]),t}(),Vt=function(e){function t(e,n,r,i,a,o,s,l,_,u,c,h,d,f){_classCallCheck(this,t);var m=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return m._cornerTextureCoordinate=e,m._positionStartLifeTime=n,m._velocity=r,m._startColor=i,m._startSize=a,m._startRotation0=o,m._startRotation1=s,m._startRotation2=l,m._startLifeTime=_,m._time=u,m._startSpeed=c,m._randoms0=m.random0,m._randoms1=m.random1,m._simulationWorldPostion=f,m}return _inherits(t,Pt),_createClass(t,[{key:"cornerTextureCoordinate",get:function(){return this._cornerTextureCoordinate}},{key:"position",get:function(){return this._positionStartLifeTime}},{key:"velocity",get:function(){return this._velocity}},{key:"startColor",get:function(){return this._startColor}},{key:"startSize",get:function(){return this._startSize}},{key:"startRotation0",get:function(){return this._startRotation0}},{key:"startRotation1",get:function(){return this._startRotation1}},{key:"startRotation2",get:function(){return this._startRotation2}},{key:"startLifeTime",get:function(){return this._startLifeTime}},{key:"time",get:function(){return this._time}},{key:"startSpeed",get:function(){return this._startSpeed}},{key:"random0",get:function(){return this._randoms0}},{key:"random1",get:function(){return this._randoms1}},{key:"simulationWorldPostion",get:function(){return this._simulationWorldPostion}}],[{key:"__init__",value:function(){t._vertexDeclaration=new Ee(172,[new ve(0,me.Vector3,Pt.PARTICLE_POSITION0),new ve(12,me.Vector4,Pt.PARTICLE_COLOR0),new ve(28,me.Vector2,Pt.PARTICLE_TEXTURECOORDINATE0),new ve(36,me.Vector4,Pt.PARTICLE_SHAPEPOSITIONSTARTLIFETIME),new ve(52,me.Vector4,Pt.PARTICLE_DIRECTIONTIME),new ve(68,me.Vector4,Pt.PARTICLE_STARTCOLOR0),new ve(84,me.Vector3,Pt.PARTICLE_STARTSIZE),new ve(96,me.Vector3,Pt.PARTICLE_STARTROTATION),new ve(108,me.Single,Pt.PARTICLE_STARTSPEED),new ve(112,me.Vector4,Pt.PARTICLE_RANDOM0),new ve(128,me.Vector4,Pt.PARTICLE_RANDOM1),new ve(144,me.Vector3,Pt.PARTICLE_SIMULATIONWORLDPOSTION),new ve(156,me.Vector4,Pt.PARTICLE_SIMULATIONWORLDROTATION)])}},{key:"vertexDeclaration",get:function(){return t._vertexDeclaration}}]),t}(),kt=function(){function e(t,n){_classCallCheck(this,e),this.center=t,this.radius=n}return _createClass(e,[{key:"toDefault",value:function(){this.center.toDefault(),this.radius=0}},{key:"intersectsRayDistance",value:function(e){return Ie.intersectsRayAndSphereRD(e,this)}},{key:"intersectsRayPoint",value:function(e,t){return Ie.intersectsRayAndSphereRP(e,this,t)}},{key:"cloneTo",value:function(e){var t=e;this.center.cloneTo(t.center),t.radius=this.radius}},{key:"clone",value:function(){var t=new e(new a,0);return this.cloneTo(t),t}}],[{key:"createFromSubPoints",value:function(t,n,r,i){if(null==t)throw new Error("points");if(n<0||n>=t.length)throw new Error("start"+n+"Must be in the range [0, "+(t.length-1)+"]");if(r<0||n+r>t.length)throw new Error("count"+r+"Must be in the range <= "+t.length+"}");var o=n+r,s=e._tempVector3;s.x=0,s.y=0,s.z=0;for(var l=n;l<o;++l)a.add(t[l],s,s);var _=i.center;a.scale(s,1/r,_);var u=0;for(l=n;l<o;++l){var c=a.distanceSquared(_,t[l]);c>u&&(u=c)}i.radius=Math.sqrt(u)}},{key:"createfromPoints",value:function(t,n){if(null==t)throw new Error("points");e.createFromSubPoints(t,0,t.length,n)}}]),e}();kt._tempVector3=new a;var wt=function(){function e(t){_classCallCheck(this,e),this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=t,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}return _createClass(e,[{key:"getUint",value:function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]}},{key:"getFloat",value:function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)}},{key:"getSignedFloat",value:function(){return 2*this.getFloat()-1}},{key:"seed",get:function(){return this.seeds[0]},set:function(e){this.seeds[0]=e,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}}],[{key:"getFloatFromInt",value:function(e){return 1/8388607*(8388607&e)}},{key:"getByteFromInt",value:function(e){return(8388607&e)>>>15}}]),e}(),Ft=function(){function e(){_classCallCheck(this,e),this._emissionRate=10,this._destroyed=!1,this._bursts=[]}return _createClass(e,[{key:"destroy",value:function(){this._bursts=null,this._destroyed=!0}},{key:"getBurstsCount",value:function(){return this._bursts.length}},{key:"getBurstByIndex",value:function(e){return this._bursts[e]}},{key:"addBurst",value:function(e){var t=this._bursts.length;if(t>0)for(var n=0;n<t;n++)this._bursts[n].time>e.time&&this._bursts.splice(n,0,e);this._bursts.push(e)}},{key:"removeBurst",value:function(e){var t=this._bursts.indexOf(e);-1!==t&&this._bursts.splice(t,1)}},{key:"removeBurstByIndex",value:function(e){this._bursts.splice(e,1)}},{key:"clearBurst",value:function(){this._bursts.length=0}},{key:"cloneTo",value:function(e){var t=e,n=t._bursts;n.length=this._bursts.length;for(var r=0,i=this._bursts.length;r<i;r++){var a=n[r];a?this._bursts[r].cloneTo(a):n[r]=this._bursts[r].clone()}t._emissionRate=this._emissionRate,t.enable=this.enable}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"emissionRate",set:function(e){if(e<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=e},get:function(){return this._emissionRate}},{key:"destroyed",get:function(){return this._destroyed}}]),e}(),Bt=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"_getStartLifetimeFromGradient",value:function(e,n){for(var r=1,i=e.gradientCount;r<i;r++){var a=e.getKeyByIndex(r);if(a>=n){var o=e.getKeyByIndex(r-1),s=(n-o)/(a-o);return t.MathUtil.lerp(e.getValueByIndex(r-1),e.getValueByIndex(r),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")}},{key:"_randomInvertRoationArray",value:function(e,t,n,r,i){var a;r?(r.seed=i[6],a=r.getFloat(),i[6]=r.seed):a=Math.random(),a<n?(t.x=-e.x,t.y=-e.y,t.z=-e.z):(t.x=e.x,t.y=e.y,t.z=e.z)}},{key:"_randomInvertRoation",value:function(e,t,n,r){var i;return n?(n.seed=r[6],i=n.getFloat(),r[6]=n.seed):i=Math.random(),i<t&&(e=-e),e}},{key:"create",value:function(n,r,a){var o=n.autoRandomSeed,s=n._rand,l=n._randomSeeds;switch(n.startColorType){case 0:var _=n.startColorConstant;e.startColor.x=_.x,e.startColor.y=_.y,e.startColor.z=_.z,e.startColor.w=_.w;break;case 2:o?i.lerp(n.startColorConstantMin,n.startColorConstantMax,Math.random(),e.startColor):(s.seed=l[3],i.lerp(n.startColorConstantMin,n.startColorConstantMax,s.getFloat(),e.startColor),l[3]=s.seed)}var u=n.colorOverLifetime;if(u&&u.enable){var c=u.color;switch(c.type){case 0:e.startColor.x=e.startColor.x*c.constant.x,e.startColor.y=e.startColor.y*c.constant.y,e.startColor.z=e.startColor.z*c.constant.z,e.startColor.w=e.startColor.w*c.constant.w;break;case 2:var h;o?h=Math.random():(s.seed=l[10],h=s.getFloat(),l[10]=s.seed);var d=c.constantMin,f=c.constantMax;e.startColor.x=e.startColor.x*t.MathUtil.lerp(d.x,f.x,h),e.startColor.y=e.startColor.y*t.MathUtil.lerp(d.y,f.y,h),e.startColor.z=e.startColor.z*t.MathUtil.lerp(d.z,f.z,h),e.startColor.w=e.startColor.w*t.MathUtil.lerp(d.w,f.w,h)}}var m=e.startSize;switch(n.startSizeType){case 0:if(n.threeDStartSize){var E=n.startSizeConstantSeparate;m[0]=E.x,m[1]=E.y,m[2]=E.z}else m[0]=m[1]=m[2]=n.startSizeConstant;break;case 2:if(n.threeDStartSize){var v=n.startSizeConstantMinSeparate,T=n.startSizeConstantMaxSeparate;o?(m[0]=t.MathUtil.lerp(v.x,T.x,Math.random()),m[1]=t.MathUtil.lerp(v.y,T.y,Math.random()),m[2]=t.MathUtil.lerp(v.z,T.z,Math.random())):(s.seed=l[4],m[0]=t.MathUtil.lerp(v.x,T.x,s.getFloat()),m[1]=t.MathUtil.lerp(v.y,T.y,s.getFloat()),m[2]=t.MathUtil.lerp(v.z,T.z,s.getFloat()),l[4]=s.seed)}else o?m[0]=m[1]=m[2]=t.MathUtil.lerp(n.startSizeConstantMin,n.startSizeConstantMax,Math.random()):(s.seed=l[4],m[0]=m[1]=m[2]=t.MathUtil.lerp(n.startSizeConstantMin,n.startSizeConstantMax,s.getFloat()),l[4]=s.seed)}var p=n.sizeOverLifetime;if(p&&p.enable&&1===p.size.type){var g,y=p.size;if(y.separateAxes)o?(m[0]=m[0]*t.MathUtil.lerp(y.constantMinSeparate.x,y.constantMaxSeparate.x,Math.random()),m[1]=m[1]*t.MathUtil.lerp(y.constantMinSeparate.y,y.constantMaxSeparate.y,Math.random()),m[2]=m[2]*t.MathUtil.lerp(y.constantMinSeparate.z,y.constantMaxSeparate.z,Math.random())):(s.seed=l[11],m[0]=m[0]*t.MathUtil.lerp(y.constantMinSeparate.x,y.constantMaxSeparate.x,s.getFloat()),m[1]=m[1]*t.MathUtil.lerp(y.constantMinSeparate.y,y.constantMaxSeparate.y,s.getFloat()),m[2]=m[2]*t.MathUtil.lerp(y.constantMinSeparate.z,y.constantMaxSeparate.z,s.getFloat()),l[11]=s.seed);else o?g=t.MathUtil.lerp(y.constantMin,y.constantMax,Math.random()):(s.seed=l[11],g=t.MathUtil.lerp(y.constantMin,y.constantMax,s.getFloat()),l[11]=s.seed),m[0]=m[0]*g,m[1]=m[1]*g,m[2]=m[2]*g}var S=r.renderMode;if(1!==S)switch(n.startRotationType){case 0:if(n.threeDStartRotation){var R=n.startRotationConstantSeparate,C=e._tempVector30;e._randomInvertRoationArray(R,C,n.randomizeRotationDirection,o?null:s,l),e.startRotation[0]=C.x,e.startRotation[1]=C.y,e.startRotation[2]=4!==S?-C.z:C.z}else e.startRotation[0]=e._randomInvertRoation(n.startRotationConstant,n.randomizeRotationDirection,o?null:s,l),e.startRotation[1]=0,e.startRotation[2]=0;break;case 2:if(n.threeDStartRotation){var I=n.startRotationConstantMinSeparate,A=n.startRotationConstantMaxSeparate,x=e._tempVector30;o?(x.x=t.MathUtil.lerp(I.x,A.x,Math.random()),x.y=t.MathUtil.lerp(I.y,A.y,Math.random()),x.z=t.MathUtil.lerp(I.z,A.z,Math.random())):(s.seed=l[5],x.x=t.MathUtil.lerp(I.x,A.x,s.getFloat()),x.y=t.MathUtil.lerp(I.y,A.y,s.getFloat()),x.z=t.MathUtil.lerp(I.z,A.z,s.getFloat()),l[5]=s.seed),e._randomInvertRoationArray(x,x,n.randomizeRotationDirection,o?null:s,l),e.startRotation[0]=x.x,e.startRotation[1]=x.y,e.startRotation[2]=4!==S?-x.z:x.z}else o?e.startRotation[0]=e._randomInvertRoation(t.MathUtil.lerp(n.startRotationConstantMin,n.startRotationConstantMax,Math.random()),n.randomizeRotationDirection,o?null:s,l):(s.seed=l[5],e.startRotation[0]=e._randomInvertRoation(t.MathUtil.lerp(n.startRotationConstantMin,n.startRotationConstantMax,s.getFloat()),n.randomizeRotationDirection,o?null:s,l),l[5]=s.seed)}switch(n.startLifetimeType){case 0:e.startLifeTime=n.startLifetimeConstant;break;case 1:e.startLifeTime=e._getStartLifetimeFromGradient(n.startLifeTimeGradient,n.emissionTime);break;case 2:o?e.startLifeTime=t.MathUtil.lerp(n.startLifetimeConstantMin,n.startLifetimeConstantMax,Math.random()):(s.seed=l[7],e.startLifeTime=t.MathUtil.lerp(n.startLifetimeConstantMin,n.startLifetimeConstantMax,s.getFloat()),l[7]=s.seed);break;case 3:var D=n.emissionTime;o?e.startLifeTime=t.MathUtil.lerp(e._getStartLifetimeFromGradient(n.startLifeTimeGradientMin,D),e._getStartLifetimeFromGradient(n.startLifeTimeGradientMax,D),Math.random()):(s.seed=l[7],e.startLifeTime=t.MathUtil.lerp(e._getStartLifetimeFromGradient(n.startLifeTimeGradientMin,D),e._getStartLifetimeFromGradient(n.startLifeTimeGradientMax,D),s.getFloat()),l[7]=s.seed)}var L=n.textureSheetAnimation;if(L&&L.enable){var M,O=L.tiles,N=O.x,P=O.y,b=1/N,V=1/P,k=L.startFrame;switch(k.type){case 0:M=k.constant;break;case 1:o?M=t.MathUtil.lerp(k.constantMin,k.constantMax,Math.random()):(s.seed=l[14],M=t.MathUtil.lerp(k.constantMin,k.constantMax,s.getFloat()),l[14]=s.seed)}var w=L.frame,F=L.cycles;switch(w.type){case 0:M+=w.constant*F;break;case 2:o?M+=t.MathUtil.lerp(w.constantMin,w.constantMax,Math.random())*F:(s.seed=l[15],M+=t.MathUtil.lerp(w.constantMin,w.constantMax,s.getFloat())*F,l[15]=s.seed)}var B=0;switch(L.type){case 0:B=Math.floor(M/N);break;case 1:L.randomRow?o?B=Math.floor(Math.random()*P):(s.seed=l[13],B=Math.floor(s.getFloat()*P),l[13]=s.seed):B=L.rowIndex}var U=Math.floor(M%N);e.startUVInfo=e.startUVInfo,e.startUVInfo[0]=b,e.startUVInfo[1]=V,e.startUVInfo[2]=U*b,e.startUVInfo[3]=B*V}else e.startUVInfo=e.startUVInfo,e.startUVInfo[0]=1,e.startUVInfo[1]=1,e.startUVInfo[2]=0,e.startUVInfo[3]=0}}]),e}();Bt._tempVector30=new a,Bt.startColor=new i,Bt.startSize=new Float32Array(3),Bt.startRotation=new Float32Array(3),Bt.startUVInfo=new Float32Array(4);var Ut=function(n){function o(e){_classCallCheck(this,o);var t=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return t._boundingSphere=null,t._boundingBox=null,t._boundingBoxCorners=null,t._owner=null,t._ownerRender=null,t._vertices=null,t._floatCountPerVertex=0,t._startLifeTimeIndex=0,t._timeIndex=0,t._simulateUpdate=!1,t._firstActiveElement=0,t._firstNewElement=0,t._firstFreeElement=0,t._firstRetiredElement=0,t._drawCounter=0,t._bufferMaxParticles=0,t._emission=null,t._shape=null,t._isEmitting=!1,t._isPlaying=!1,t._isPaused=!1,t._playStartDelay=0,t._frameRateTime=0,t._emissionTime=0,t._totalDelayTime=0,t._burstsIndex=0,t._velocityOverLifetime=null,t._colorOverLifetime=null,t._sizeOverLifetime=null,t._rotationOverLifetime=null,t._textureSheetAnimation=null,t._startLifetimeType=0,t._startLifetimeConstant=0,t._startLifeTimeGradient=null,t._startLifetimeConstantMin=0,t._startLifetimeConstantMax=0,t._startLifeTimeGradientMin=null,t._startLifeTimeGradientMax=null,t._maxStartLifetime=0,t._uvLength=new r,t._vertexStride=0,t._indexStride=0,t._vertexBuffer=null,t._indexBuffer=null,t._bufferState=new Oe,t._currentTime=0,t._startUpdateLoopCount=0,t._rand=null,t._randomSeeds=null,t.duration=0,t.looping=!1,t.prewarm=!1,t.startDelayType=0,t.startDelay=0,t.startDelayMin=0,t.startDelayMax=0,t.startSpeedType=0,t.startSpeedConstant=0,t.startSpeedConstantMin=0,t.startSpeedConstantMax=0,t.threeDStartSize=!1,t.startSizeType=0,t.startSizeConstant=0,t.startSizeConstantSeparate=null,t.startSizeConstantMin=0,t.startSizeConstantMax=0,t.startSizeConstantMinSeparate=null,t.startSizeConstantMaxSeparate=null,t.threeDStartRotation=!1,t.startRotationType=0,t.startRotationConstant=0,t.startRotationConstantSeparate=null,t.startRotationConstantMin=0,t.startRotationConstantMax=0,t.startRotationConstantMinSeparate=null,t.startRotationConstantMaxSeparate=null,t.randomizeRotationDirection=0,t.startColorType=0,t.startColorConstant=new i(1,1,1,1),t.startColorConstantMin=new i(0,0,0,0),t.startColorConstantMax=new i(1,1,1,1),t.gravityModifier=0,t.simulationSpace=0,t.simulationSpeed=1,t.scaleMode=0,t.playOnAwake=!1,t.randomSeed=null,t.autoRandomSeed=!1,t.isPerformanceMode=!1,t._firstActiveElement=0,t._firstNewElement=0,t._firstFreeElement=0,t._firstRetiredElement=0,t._owner=e,t._ownerRender=e.particleRenderer,t._boundingBoxCorners=[],t._boundingSphere=new kt(new a,Number.MAX_VALUE),t._boundingBox=new Je(new a(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new a(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),t._currentTime=0,t._isEmitting=!1,t._isPlaying=!1,t._isPaused=!1,t._burstsIndex=0,t._frameRateTime=0,t._emissionTime=0,t._totalDelayTime=0,t._simulateUpdate=!1,t._bufferMaxParticles=1,t.duration=5,t.looping=!0,t.prewarm=!1,t.startDelayType=0,t.startDelay=0,t.startDelayMin=0,t.startDelayMax=0,t._startLifetimeType=0,t._startLifetimeConstant=5,t._startLifeTimeGradient=new ft,t._startLifetimeConstantMin=0,t._startLifetimeConstantMax=5,t._startLifeTimeGradientMin=new ft,t._startLifeTimeGradientMax=new ft,t._maxStartLifetime=5,t.startSpeedType=0,t.startSpeedConstant=5,t.startSpeedConstantMin=0,t.startSpeedConstantMax=5,t.threeDStartSize=!1,t.startSizeType=0,t.startSizeConstant=1,t.startSizeConstantSeparate=new a(1,1,1),t.startSizeConstantMin=0,t.startSizeConstantMax=1,t.startSizeConstantMinSeparate=new a(0,0,0),t.startSizeConstantMaxSeparate=new a(1,1,1),t.threeDStartRotation=!1,t.startRotationType=0,t.startRotationConstant=0,t.startRotationConstantSeparate=new a(0,0,0),t.startRotationConstantMin=0,t.startRotationConstantMax=0,t.startRotationConstantMinSeparate=new a(0,0,0),t.startRotationConstantMaxSeparate=new a(0,0,0),t.gravityModifier=0,t.simulationSpace=1,t.scaleMode=0,t.playOnAwake=!0,t._rand=new wt(0),t.autoRandomSeed=!0,t.randomSeed=new Uint32Array(1),t._randomSeeds=new Uint32Array(o._RANDOMOFFSET.length),t.isPerformanceMode=!0,t._emission=new Ft,t._emission.enable=!0,t}return _inherits(o,de),_createClass(o,[{key:"_getVertexBuffer",value:function(){return 0===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:0)?this._vertexBuffer:null}},{key:"_getIndexBuffer",value:function(){return this._indexBuffer}},{key:"_generateBoundingSphere",value:function(){var e=this._boundingSphere.center;e.x=0,e.y=0,e.z=0,this._boundingSphere.radius=Number.MAX_VALUE}},{key:"_generateBoundingBox",value:function(){var e,t,n,r,i,s,l,_,u,c=this._owner.particleRenderer,h=this._boundingBox.min,d=this._boundingBox.max;switch(this.startLifetimeType){case 0:n=this.startLifetimeConstant;break;case 1:n=-Number.MAX_VALUE;var f=f;for(e=0,t=f.gradientCount;e<t;e++)n=Math.max(n,f.getValueByIndex(e));break;case 2:n=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:n=-Number.MAX_VALUE;var m=m;for(e=0,t=m.gradientCount;e<t;e++)n=Math.max(n,m.getValueByIndex(e));var E=E;for(e=0,t=E.gradientCount;e<t;e++)n=Math.max(n,E.getValueByIndex(e))}switch(this.startSpeedType){case 0:r=i=this.startSpeedConstant;break;case 1:break;case 2:r=this.startLifetimeConstantMin,i=this.startLifetimeConstantMax}this._shape&&this._shape.enable||(s=l=a._ZERO,_=a._ZERO,u=a._UnitZ);var v,T,p=new a(_.x*r,_.y*r,_.z*r),g=new a(u.x*i,u.y*i,u.z*i);if(this._velocityOverLifetime&&this._velocityOverLifetime.enable){var y=this._velocityOverLifetime.velocity;switch(y.type){case 0:y.constant;break;case 1:new a(y.gradientX.getAverageValue(),y.gradientY.getAverageValue(),y.gradientZ.getAverageValue());break;case 2:y.constantMin,y.constantMax;break;case 3:new a(y.gradientXMin.getAverageValue(),y.gradientYMin.getAverageValue(),y.gradientZMin.getAverageValue()),new a(y.gradientXMax.getAverageValue(),y.gradientYMax.getAverageValue(),y.gradientZMax.getAverageValue())}}var S,R,C,I,A=this._owner.transform,x=A.position,D=o._tempVector39,L=c.renderMode;switch(this.scaleMode){case 0:var M=A.getWorldLossyScale();v=M,D.x=M.x,D.y=M.z,D.z=M.y,1===L&&(T=M);break;case 1:var O=A.localScale;v=O,D.x=O.x,D.y=O.z,D.z=O.y,1===L&&(T=O);break;case 2:v=A.getWorldLossyScale(),D.x=D.y=D.z=1,1===L&&(T=a._ONE)}switch(this._velocityOverLifetime&&this._velocityOverLifetime.enable||(S=new a(p.x*n,p.y*n,p.z*n),R=new a(g.x*n,g.y*n,g.z*n),2!=this.scaleMode?(a.add(s,S,h),a.multiply(v,h,h),a.add(l,R,d),a.multiply(v,d,d)):(a.multiply(v,s,h),a.add(h,S,h),a.multiply(v,l,d),a.add(d,R,d))),this.simulationSpace){case 0:break;case 1:a.add(h,x,h),a.add(d,x,d)}switch(this.startSizeType){case 0:if(this.threeDStartSize){var N=N;C=Math.max(N.x,N.y),1===L&&(I=N.y)}else C=this.startSizeConstant,1===L&&(I=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var P=P;C=Math.max(P.x,P.y),1===L&&(I=P.y)}else C=this.startSizeConstantMax,1===L&&(I=this.startSizeConstantMax)}if(this._sizeOverLifetime&&this._sizeOverLifetime.enable){this._sizeOverLifetime.size;C*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var b,V,k=o._tempVector30;switch(L){case 0:b=C*o.halfKSqrtOf2,a.scale(D,C,k),a.subtract(h,k,h),a.add(d,k,d);break;case 1:var w=o._tempVector31,F=o._tempVector32,B=o._tempVector33,U=o._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enable||(a.multiply(T,g,F),a.multiply(T,p,B));var G=I*c.stretchedBillboardLengthScale,z=a.scalarLength(F)*c.stretchedBillboardSpeedScale+G,H=a.scalarLength(B)*c.stretchedBillboardSpeedScale+G,W=o._tempVector35,X=o._tempVector36;a.normalize(F,W),a.scale(W,z,U),a.subtract(R,U,U),a.normalize(B,X),a.scale(X,H,w),a.add(S,w,w),b=C*o.halfKSqrtOf2,a.scale(D,b,k);var Y=o._tempVector37,j=o._tempVector38;a.scale(W,.5,Y),a.scale(X,.5,j),a.multiply(Y,D,Y),a.multiply(j,D,j),a.add(h,j,h),a.min(h,U,h),a.subtract(h,k,h),a.subtract(d,Y,d),a.max(d,w,d),a.add(d,k,d);break;case 2:V=.5*(C*=Math.cos(.7853981633974483)),k.x=D.x*V,k.y=D.z*V,a.subtract(h,k,h),a.add(d,k,d);break;case 3:V=.5*(C*=Math.cos(.7853981633974483)),a.scale(D,V,k),a.subtract(h,k,h),a.add(d,k,d)}this._boundingBox.getCorners(this._boundingBoxCorners)}},{key:"_updateEmission",value:function(){if(this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var e=this._startUpdateLoopCount===t.Stat.loopCount||this._isPaused?0:this._owner._scene.timer._delta/1e3;e=Math.min(o._maxElapsedTime,e*this.simulationSpeed),this._updateParticles(e)}}},{key:"_updateParticles",value:function(e){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=e,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=e,this._totalDelayTime<this._playStartDelay||this._emission.enable&&this._isEmitting&&!this._isPaused&&this._advanceTime(e,this._currentTime))}},{key:"_updateParticlesSimulationRestart",value:function(e){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=e,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=e;var t=e;t<this._playStartDelay?this._totalDelayTime=t:this._emission.enable&&this._advanceTime(e,e)}},{key:"_retireActiveParticles",value:function(){for(;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,t=e+this._timeIndex;if(this._currentTime-this._vertices[t]+1e-4<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[t]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}}},{key:"_freeRetiredParticles",value:function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&e<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}}},{key:"_burst",value:function(e,n){for(var r=0,i=this._emission._bursts,a=i.length;this._burstsIndex<a;this._burstsIndex++){var o,s=i[this._burstsIndex],l=s.time;if(!(e<=l&&l<n))break;this.autoRandomSeed?o=t.MathUtil.lerp(s.minCount,s.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=t.MathUtil.lerp(s.minCount,s.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),r+=o}return r}},{key:"_advanceTime",value:function(e,t){var n,r=this._emissionTime;this._emissionTime+=e;var i=0;if(this._emissionTime>this.duration){if(!this.looping){for(i=Math.min(this.maxParticles-this.aliveParticleCount,i),n=0;n<i;n++)this.emit(t);return this._isPlaying=!1,void this.stop()}i+=this._burst(r,this._emissionTime),this._emissionTime-=this.duration,this._burstsIndex=0,i+=this._burst(0,this._emissionTime)}else i+=this._burst(r,this._emissionTime);for(i=Math.min(this.maxParticles-this.aliveParticleCount,i),n=0;n<i;n++)this.emit(t);var a=this.emission.emissionRate;if(a>0){var o=1/a;for(this._frameRateTime+=o,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=t&&this.emit(this._frameRateTime);)this._frameRateTime+=o;this._frameRateTime=Math.floor(t/o)*o}}},{key:"_initBufferDatas",value:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy());var n=t.LayaGL.instance,r=this._ownerRender,i=r.renderMode;if(-1!==i&&this.maxParticles>0){var a,o,s,l,_,u,c,h=0,d=0,f=r.mesh;if(4===i){if(f){c=Vt.vertexDeclaration,this._floatCountPerVertex=c.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=f._vertexCount;var m=this._bufferMaxParticles*this._vertexStride,E=m%65535;if(Math.floor(m/65535)+1>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");h=c.vertexStride*E,this._vertexBuffer=new fe(h,n.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=c,this._vertices=new Float32Array(this._floatCountPerVertex*E),this._indexStride=f._indexBuffer.indexCount;var v=f._indexBuffer.getData(),T=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=new Ne(e.IndexFormat.UInt16,T,n.STATIC_DRAW),a=new Uint16Array(T),d=h+2*T,_=0,o=0;o<this._bufferMaxParticles;o++){var p=o*this._vertexStride;for(s=0,l=v.length;s<l;s++)a[_++]=p+v[s]}this._indexBuffer.setData(a),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}}else{for(c=bt.vertexDeclaration,this._floatCountPerVertex=c.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,h=c.vertexStride*this._bufferMaxParticles*this._vertexStride,this._vertexBuffer=new fe(h,n.DYNAMIC_DRAW),this._vertexBuffer.vertexDeclaration=c,this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),o=0;o<this._bufferMaxParticles;o++)u=o*this._floatCountPerVertex*this._vertexStride,this._vertices[u]=-.5,this._vertices[u+1]=-.5,this._vertices[u+2]=0,this._vertices[u+3]=1,u+=this._floatCountPerVertex,this._vertices[u]=.5,this._vertices[u+1]=-.5,this._vertices[u+2]=1,this._vertices[u+3]=1,u+=this._floatCountPerVertex,this._vertices[u]=.5,this._vertices[u+1]=.5,this._vertices[u+2]=1,this._vertices[u+3]=0,u+=this._floatCountPerVertex,this._vertices[u]=-.5,this._vertices[u+1]=.5,this._vertices[u+2]=0,this._vertices[u+3]=0;for(this._indexStride=6,this._indexBuffer=new Ne(e.IndexFormat.UInt16,6*this._bufferMaxParticles,n.STATIC_DRAW),a=new Uint16Array(6*this._bufferMaxParticles),o=0;o<this._bufferMaxParticles;o++){_=6*o;var g=o*this._vertexStride,y=g+2;a[_++]=g,a[_++]=y,a[_++]=g+1,a[_++]=g,a[_++]=g+3,a[_++]=y}this._indexBuffer.setData(a),d=h+6*this._bufferMaxParticles*2,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}t.Resource._addMemory(d,d)}}},{key:"destroy",value:function(){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"destroy",this).call(this);var e=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission.destroy(),this._bufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._owner=null,this._vertices=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null}},{key:"emit",value:function(e){var t=o._tempPosition,n=o._tempDirection;return this._shape&&this._shape.enable?this.autoRandomSeed?this._shape.generatePositionAndDirection(t,n):this._shape.generatePositionAndDirection(t,n,this._rand,this._randomSeeds):(t.x=t.y=t.z=0,n.x=n.y=0,n.z=1),this.addParticle(t,n,e)}},{key:"addParticle",value:function(e,n,r){a.normalize(n,n);var i=this._firstFreeElement+1;if(i>=this._bufferMaxParticles&&(i=0),i===this._firstRetiredElement)return!1;var o,s,l,_,u,c,h,d,f,m,E=this._owner.transform;if(Bt.create(this,this._ownerRender,E),this._currentTime-r>=Bt.startLifeTime)return!0;switch(0==this.simulationSpace&&(o=E.position,s=E.rotation),this.startSpeedType){case 0:l=this.startSpeedConstant;break;case 2:this.autoRandomSeed?l=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,Math.random()):(this._rand.seed=this._randomSeeds[8],l=t.MathUtil.lerp(this.startSpeedConstantMin,this.startSpeedConstantMax,this._rand.getFloat()),this._randomSeeds[8]=this._rand.seed)}var v=this._velocityOverLifetime&&this._velocityOverLifetime.enable;if(v){var T=this._velocityOverLifetime.velocity.type;2===T||3===T?this.autoRandomSeed?(_=Math.random(),u=Math.random(),c=Math.random()):(this._rand.seed=this._randomSeeds[9],_=this._rand.getFloat(),u=this._rand.getFloat(),c=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):v=!1}else v=!1;var p=this._colorOverLifetime&&this._colorOverLifetime.enable;p?3===this._colorOverLifetime.color.type?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[10],h=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):p=!1:p=!1;var g=this._sizeOverLifetime&&this._sizeOverLifetime.enable;g?3===this._sizeOverLifetime.size.type?this.autoRandomSeed?d=Math.random():(this._rand.seed=this._randomSeeds[11],d=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):g=!1:g=!1;var y=this._rotationOverLifetime&&this._rotationOverLifetime.enable;if(y){var S=this._rotationOverLifetime.angularVelocity.type;2===S||3===S?this.autoRandomSeed?f=Math.random():(this._rand.seed=this._randomSeeds[12],f=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):y=!1}else y=!1;var R=this._textureSheetAnimation&&this._textureSheetAnimation.enable;R?3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?m=Math.random():(this._rand.seed=this._randomSeeds[15],m=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):R=!1:R=!1;var C,I,A,x,D,L,M=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,O=Bt.startUVInfo[0],N=Bt.startUVInfo[1],P=Bt.startUVInfo[2],b=Bt.startUVInfo[3],V=this._ownerRender;if(4===V.renderMode){var k=V.mesh._vertexBuffer;C=k.getFloat32Data();var w=k.vertexDeclaration;A=w.getVertexElementByUsage(Te.MESH_POSITION0)._offset/4;var F=w.getVertexElementByUsage(Te.MESH_COLOR0);x=F?F._offset/4:-1;var B=w.getVertexElementByUsage(Te.MESH_TEXTURECOORDINATE0);D=B?B._offset/4:-1,I=w.vertexStride/4,L=0}else{this._vertices[M+2]=P,this._vertices[M+3]=b+N;var U=M+this._floatCountPerVertex;this._vertices[U+2]=P+O,this._vertices[U+3]=b+N;var G=U+this._floatCountPerVertex;this._vertices[G+2]=P+O,this._vertices[G+3]=b;var z=G+this._floatCountPerVertex;this._vertices[z+2]=P,this._vertices[z+3]=b}for(var H=M,W=M+this._floatCountPerVertex*this._vertexStride;H<W;H+=this._floatCountPerVertex){var X;if(4===V.renderMode){X=H;var Y=I*L++,j=Y+A;this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j],-1===x?(this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1,this._vertices[X++]=1):(j=Y+x,this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j++],this._vertices[X++]=C[j]),-1===D?(this._vertices[X++]=0,this._vertices[X++]=0):(j=Y+D,this._vertices[X++]=P+C[j++]*O,this._vertices[X++]=b+C[j]*N)}else X=H+4;switch(this._vertices[X++]=e.x,this._vertices[X++]=e.y,this._vertices[X++]=e.z,this._vertices[X++]=Bt.startLifeTime,this._vertices[X++]=n.x,this._vertices[X++]=n.y,this._vertices[X++]=n.z,this._vertices[X++]=r,this._vertices[X++]=Bt.startColor.x,this._vertices[X++]=Bt.startColor.y,this._vertices[X++]=Bt.startColor.z,this._vertices[X++]=Bt.startColor.w,this._vertices[X++]=Bt.startSize[0],this._vertices[X++]=Bt.startSize[1],this._vertices[X++]=Bt.startSize[2],this._vertices[X++]=Bt.startRotation[0],this._vertices[X++]=Bt.startRotation[1],this._vertices[X++]=Bt.startRotation[2],this._vertices[X++]=l,p&&(this._vertices[X+1]=h),g&&(this._vertices[X+2]=d),y&&(this._vertices[X+3]=f),R&&(this._vertices[X+4]=m),v&&(this._vertices[X+5]=_,this._vertices[X+6]=u,this._vertices[X+7]=c),this.simulationSpace){case 0:X+=8,this._vertices[X++]=o.x,this._vertices[X++]=o.y,this._vertices[X++]=o.z,this._vertices[X++]=s.x,this._vertices[X++]=s.y,this._vertices[X++]=s.z,this._vertices[X++]=s.w;break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=i,!0}},{key:"addNewParticlesToVertexBuffer",value:function(){var e,t=this._vertexStride*this._floatCountPerVertex*4;this._firstNewElement<this._firstFreeElement?(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._firstFreeElement-this._firstNewElement)*t)):(e=this._firstNewElement*t,this._vertexBuffer.setData(this._vertices.buffer,e,e,(this._bufferMaxParticles-this._firstNewElement)*t),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices.buffer,0,0,this._firstFreeElement*t)),this._firstNewElement=this._firstFreeElement}},{key:"_getType",value:function(){return o._type}},{key:"_prepareRender",value:function(e){return this._updateEmission(),this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement}},{key:"_render",value:function(e){var n;this._bufferState.bind();var r=t.LayaGL.instance;this._firstActiveElement<this._firstFreeElement?(n=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,r.drawElements(r.TRIANGLES,n,r.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++):(n=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,r.drawElements(r.TRIANGLES,n,r.UNSIGNED_SHORT,2*this._firstActiveElement*this._indexStride),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++,this._firstFreeElement>0&&(n=this._firstFreeElement*this._indexStride,r.drawElements(r.TRIANGLES,n,r.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=n/3,t.Stat.renderBatches++))}},{key:"play",value:function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var e=0,n=this._randomSeeds.length;e<n;e++)this._randomSeeds[e]=this.randomSeed[0]+o._RANDOMOFFSET[e];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=t.MathUtil.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=t.Stat.loopCount}},{key:"pause",value:function(){this._isPaused=!0}},{key:"simulate",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._simulateUpdate=!0,t?this._updateParticlesSimulationRestart(e):(this._isPaused=!1,this._updateParticles(e)),this.pause()}},{key:"stop",value:function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0}},{key:"cloneTo",value:function(e){var t=e;t.duration=this.duration,t.looping=this.looping,t.prewarm=this.prewarm,t.startDelayType=this.startDelayType,t.startDelay=this.startDelay,t.startDelayMin=this.startDelayMin,t.startDelayMax=this.startDelayMax,t._maxStartLifetime=this._maxStartLifetime,t.startLifetimeType=this.startLifetimeType,t.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(t.startLifeTimeGradient),t.startLifetimeConstantMin=this.startLifetimeConstantMin,t.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(t.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(t.startLifeTimeGradientMax),t.startSpeedType=this.startSpeedType,t.startSpeedConstant=this.startSpeedConstant,t.startSpeedConstantMin=this.startSpeedConstantMin,t.startSpeedConstantMax=this.startSpeedConstantMax,t.threeDStartSize=this.threeDStartSize,t.startSizeType=this.startSizeType,t.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(t.startSizeConstantSeparate),t.startSizeConstantMin=this.startSizeConstantMin,t.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(t.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(t.startSizeConstantMaxSeparate),t.threeDStartRotation=this.threeDStartRotation,t.startRotationType=this.startRotationType,t.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(t.startRotationConstantSeparate),t.startRotationConstantMin=this.startRotationConstantMin,t.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(t.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(t.startRotationConstantMaxSeparate),t.randomizeRotationDirection=this.randomizeRotationDirection,t.startColorType=this.startColorType,this.startColorConstant.cloneTo(t.startColorConstant),this.startColorConstantMin.cloneTo(t.startColorConstantMin),this.startColorConstantMax.cloneTo(t.startColorConstantMax),t.gravityModifier=this.gravityModifier,t.simulationSpace=this.simulationSpace,t.scaleMode=this.scaleMode,t.playOnAwake=this.playOnAwake,t.autoRandomSeed=this.autoRandomSeed,t.randomSeed[0]=this.randomSeed[0],t.maxParticles=this.maxParticles,this._emission&&(t._emission=this._emission.clone()),this.shape&&(t.shape=this.shape.clone()),this.velocityOverLifetime&&(t.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(t.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(t.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(t.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(t.textureSheetAnimation=this.textureSheetAnimation.clone()),t.isPerformanceMode=this.isPerformanceMode,t._isEmitting=this._isEmitting,t._isPlaying=this._isPlaying,t._isPaused=this._isPaused,t._playStartDelay=this._playStartDelay,t._frameRateTime=this._frameRateTime,t._emissionTime=this._emissionTime,t._totalDelayTime=this._totalDelayTime,t._burstsIndex=this._burstsIndex}},{key:"clone",value:function(){var e=new o(null);return this.cloneTo(e),e}},{key:"maxParticles",get:function(){return this._bufferMaxParticles-1},set:function(e){var t=e+1;t!==this._bufferMaxParticles&&(this._bufferMaxParticles=t,this._initBufferDatas())}},{key:"emission",get:function(){return this._emission}},{key:"aliveParticleCount",get:function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}},{key:"emissionTime",get:function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}},{key:"shape",get:function(){return this._shape},set:function(e){this._shape!==e&&(e&&e.enable?this._owner._render._shaderValues.addDefine(Lt.SHADERDEFINE_SHAPE):this._owner._render._shaderValues.removeDefine(Lt.SHADERDEFINE_SHAPE),this._shape=e)}},{key:"isAlive",get:function(){return!!(this._isPlaying||this.aliveParticleCount>0)}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"startLifetimeType",get:function(){return this._startLifetimeType},set:function(e){var t,n;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var r=r;for(t=0,n=r.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(t));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var i=i;for(t=0,n=i.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,i.getValueByIndex(t));var a=a;for(t=0,n=a.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(t))}this._startLifetimeType=e}},{key:"startLifetimeConstant",get:function(){return this._startLifetimeConstant},set:function(e){0===this._startLifetimeType&&(this._maxStartLifetime=e),this._startLifetimeConstant=e}},{key:"startLifeTimeGradient",get:function(){return this._startLifeTimeGradient},set:function(e){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradient=e}},{key:"startLifetimeConstantMin",get:function(){return this._startLifetimeConstantMin},set:function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(e,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=e}},{key:"startLifetimeConstantMax",get:function(){return this._startLifetimeConstantMax},set:function(e){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,e)),this._startLifetimeConstantMax=e}},{key:"startLifeTimeGradientMin",get:function(){return this._startLifeTimeGradientMin},set:function(e){if(3===this._startLifetimeType){var t,n;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t));for(t=0,n=this._startLifeTimeGradientMax.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(t))}this._startLifeTimeGradientMin=e}},{key:"startLifeTimeGradientMax",get:function(){return this._startLifeTimeGradientMax},set:function(e){if(3===this._startLifetimeType){var t,n;for(this._maxStartLifetime=-Number.MAX_VALUE,t=0,n=this._startLifeTimeGradientMin.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(t));for(t=0,n=e.gradientCount;t<n;t++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(t))}this._startLifeTimeGradientMax=e}},{key:"velocityOverLifetime",get:function(){return this._velocityOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.velocity,r=n.type;if(e.enable)switch(r){case 0:t.addDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:t.addDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:t.addDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:t.addDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else t.removeDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(r){case 0:t.setVector3(Lt.VOLVELOCITYCONST,n.constant);break;case 1:t.setBuffer(Lt.VOLVELOCITYGRADIENTX,n.gradientX._elements),t.setBuffer(Lt.VOLVELOCITYGRADIENTY,n.gradientY._elements),t.setBuffer(Lt.VOLVELOCITYGRADIENTZ,n.gradientZ._elements);break;case 2:t.setVector3(Lt.VOLVELOCITYCONST,n.constantMin),t.setVector3(Lt.VOLVELOCITYCONSTMAX,n.constantMax);break;case 3:t.setBuffer(Lt.VOLVELOCITYGRADIENTX,n.gradientXMin._elements),t.setBuffer(Lt.VOLVELOCITYGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(Lt.VOLVELOCITYGRADIENTY,n.gradientYMin._elements),t.setBuffer(Lt.VOLVELOCITYGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(Lt.VOLVELOCITYGRADIENTZ,n.gradientZMin._elements),t.setBuffer(Lt.VOLVELOCITYGRADIENTZMAX,n.gradientZMax._elements)}t.setInt(Lt.VOLSPACETYPE,e.space)}else t.removeDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),t.removeDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),t.removeDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),t.removeDefine(Lt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);this._velocityOverLifetime=e}},{key:"colorOverLifetime",get:function(){return this._colorOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.color;if(e.enable)switch(n.type){case 1:t.addDefine(Lt.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:t.addDefine(Lt.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else t.removeDefine(Lt.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(Lt.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(n.type){case 1:var r=n.gradient;t.setBuffer(Lt.COLOROVERLIFEGRADIENTALPHAS,r._alphaElements),t.setBuffer(Lt.COLOROVERLIFEGRADIENTCOLORS,r._rgbElements);break;case 3:var i=n.gradientMin,a=n.gradientMax;t.setBuffer(Lt.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(Lt.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements),t.setBuffer(Lt.MAXCOLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(Lt.MAXCOLOROVERLIFEGRADIENTCOLORS,a._rgbElements)}}else t.removeDefine(Lt.SHADERDEFINE_COLOROVERLIFETIME),t.removeDefine(Lt.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),t.setBuffer(Lt.COLOROVERLIFEGRADIENTALPHAS,r._alphaElements),t.setBuffer(Lt.COLOROVERLIFEGRADIENTCOLORS,r._rgbElements),t.setBuffer(Lt.COLOROVERLIFEGRADIENTALPHAS,i._alphaElements),t.setBuffer(Lt.COLOROVERLIFEGRADIENTCOLORS,i._rgbElements),t.setBuffer(Lt.MAXCOLOROVERLIFEGRADIENTALPHAS,a._alphaElements),t.setBuffer(Lt.MAXCOLOROVERLIFEGRADIENTCOLORS,a._rgbElements);this._colorOverLifetime=e}},{key:"sizeOverLifetime",get:function(){return this._sizeOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.size,r=n.separateAxes,i=n.type;if(e.enable)switch(i){case 0:r?t.addDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):t.addDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:r?t.addDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):t.addDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else t.removeDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(i){case 0:r?(t.setBuffer(Lt.SOLSIZEGRADIENTX,n.gradientX._elements),t.setBuffer(Lt.SOLSIZEGRADIENTY,n.gradientY._elements),t.setBuffer(Lt.SOLSizeGradientZ,n.gradientZ._elements)):t.setBuffer(Lt.SOLSIZEGRADIENT,n.gradient._elements);break;case 2:r?(t.setBuffer(Lt.SOLSIZEGRADIENTX,n.gradientXMin._elements),t.setBuffer(Lt.SOLSIZEGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(Lt.SOLSIZEGRADIENTY,n.gradientYMin._elements),t.setBuffer(Lt.SOLSIZEGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(Lt.SOLSizeGradientZ,n.gradientZMin._elements),t.setBuffer(Lt.SOLSizeGradientZMAX,n.gradientZMax._elements)):(t.setBuffer(Lt.SOLSIZEGRADIENT,n.gradientMin._elements),t.setBuffer(Lt.SOLSizeGradientMax,n.gradientMax._elements))}}else t.removeDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMECURVE),t.removeDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),t.removeDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),t.removeDefine(Lt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);this._sizeOverLifetime=e}},{key:"rotationOverLifetime",get:function(){return this._rotationOverLifetime},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.angularVelocity;if(!n)return;var r=n.separateAxes,i=n.type;if(e.enable)switch(r?t.addDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):t.addDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIME),i){case 0:t.addDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:t.addDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:t.addDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:t.addDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(i){case 0:r?t.setVector3(Lt.ROLANGULARVELOCITYCONSTSEPRARATE,n.constantSeparate):t.setNumber(Lt.ROLANGULARVELOCITYCONST,n.constant);break;case 1:r?(t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTX,n.gradientX._elements),t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTY,n.gradientY._elements),t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTZ,n.gradientZ._elements)):t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENT,n.gradient._elements);break;case 2:r?(t.setVector3(Lt.ROLANGULARVELOCITYCONSTSEPRARATE,n.constantMinSeparate),t.setVector3(Lt.ROLANGULARVELOCITYCONSTMAXSEPRARATE,n.constantMaxSeparate)):(t.setNumber(Lt.ROLANGULARVELOCITYCONST,n.constantMin),t.setNumber(Lt.ROLANGULARVELOCITYCONSTMAX,n.constantMax));break;case 3:r?(t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTX,n.gradientXMin._elements),t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTXMAX,n.gradientXMax._elements),t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTY,n.gradientYMin._elements),t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTYMAX,n.gradientYMax._elements),t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTZ,n.gradientZMin._elements),t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTZMAX,n.gradientZMax._elements)):(t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENT,n.gradientMin._elements),t.setBuffer(Lt.ROLANGULARVELOCITYGRADIENTMAX,n.gradientMax._elements))}}else t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIME),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),t.removeDefine(Lt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);this._rotationOverLifetime=e}},{key:"textureSheetAnimation",get:function(){return this._textureSheetAnimation},set:function(e){var t=this._owner._render._shaderValues;if(e){var n=e.frame,r=n.type;if(e.enable)switch(r){case 1:t.addDefine(Lt.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:t.addDefine(Lt.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else t.removeDefine(Lt.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(Lt.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===r||3===r){t.setNumber(Lt.TEXTURESHEETANIMATIONCYCLES,e.cycles);var i=e.tiles,a=this._uvLength;a.x=1/i.x,a.y=1/i.y,t.setVector2(Lt.TEXTURESHEETANIMATIONSUBUVLENGTH,this._uvLength)}switch(r){case 1:t.setBuffer(Lt.TEXTURESHEETANIMATIONGRADIENTUVS,n.frameOverTimeData._elements);break;case 3:t.setBuffer(Lt.TEXTURESHEETANIMATIONGRADIENTUVS,n.frameOverTimeDataMin._elements),t.setBuffer(Lt.TEXTURESHEETANIMATIONGRADIENTMAXUVS,n.frameOverTimeDataMax._elements)}}else t.removeDefine(Lt.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),t.removeDefine(Lt.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);this._textureSheetAnimation=e}}]),o}();Ut._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447]),Ut.halfKSqrtOf2=.71,Ut._maxElapsedTime=1/3,Ut._tempVector30=new a,Ut._tempVector31=new a,Ut._tempVector32=new a,Ut._tempVector33=new a,Ut._tempVector34=new a,Ut._tempVector35=new a,Ut._tempVector36=new a,Ut._tempVector37=new a,Ut._tempVector38=new a,Ut._tempVector39=new a,Ut._tempPosition=new a,Ut._tempDirection=new a,Ut._type=de._typeCounter++;var Gt=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,null));e._render=new Nt(e),e._particleSystem=new Ut(e);var t=e._render._renderElements[0]=new Ye;return t.setTransform(e._transform),t.render=e._render,t.setGeometry(e._particleSystem),t.material=Mt.defaultMaterial,e}return _inherits(n,_e),_createClass(n,[{key:"particleSystem",get:function(){return this._particleSystem}},{key:"particleRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){Lt.SHADERDEFINE_RENDERMODE_BILLBOARD=U.getDefineByName("SPHERHBILLBOARD"),Lt.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=U.getDefineByName("STRETCHEDBILLBOARD"),Lt.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=U.getDefineByName("HORIZONTALBILLBOARD"),Lt.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=U.getDefineByName("VERTICALBILLBOARD"),Lt.SHADERDEFINE_COLOROVERLIFETIME=U.getDefineByName("COLOROVERLIFETIME"),Lt.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=U.getDefineByName("RANDOMCOLOROVERLIFETIME"),Lt.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=U.getDefineByName("VELOCITYOVERLIFETIMECONSTANT"),Lt.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=U.getDefineByName("VELOCITYOVERLIFETIMECURVE"),Lt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=U.getDefineByName("VELOCITYOVERLIFETIMERANDOMCONSTANT"),Lt.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=U.getDefineByName("VELOCITYOVERLIFETIMERANDOMCURVE"),Lt.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=U.getDefineByName("TEXTURESHEETANIMATIONCURVE"),Lt.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=U.getDefineByName("TEXTURESHEETANIMATIONRANDOMCURVE"),Lt.SHADERDEFINE_ROTATIONOVERLIFETIME=U.getDefineByName("ROTATIONOVERLIFETIME"),Lt.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=U.getDefineByName("ROTATIONOVERLIFETIMESEPERATE"),Lt.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=U.getDefineByName("ROTATIONOVERLIFETIMECONSTANT"),Lt.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=U.getDefineByName("ROTATIONOVERLIFETIMECURVE"),Lt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=U.getDefineByName("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),Lt.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=U.getDefineByName("ROTATIONOVERLIFETIMERANDOMCURVES"),Lt.SHADERDEFINE_SIZEOVERLIFETIMECURVE=U.getDefineByName("SIZEOVERLIFETIMECURVE"),Lt.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=U.getDefineByName("SIZEOVERLIFETIMECURVESEPERATE"),Lt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=U.getDefineByName("SIZEOVERLIFETIMERANDOMCURVES"),Lt.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=U.getDefineByName("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),Lt.SHADERDEFINE_RENDERMODE_MESH=U.getDefineByName("RENDERMODE_MESH"),Lt.SHADERDEFINE_SHAPE=U.getDefineByName("SHAPE")}}]),_createClass(n,[{key:"_parseModule",value:function(e,n){for(var r in n)switch(r){case"bases":var i=n.bases;for(var a in i)e[a]=i[a];break;case"vector2s":var o=n.vector2s;for(var a in o){var s=e[a],l=o[a];s.setValue(l[0],l[1]),e[a]=s}break;case"vector3s":var _=n.vector3s;for(var a in _){var u=e[a],c=_[a];u.setValue(c[0],c[1],c[2]),e[a]=u}break;case"vector4s":var h=n.vector4s;for(var a in h){var d=e[a],f=h[a];d.setValue(f[0],f[1],f[2],f[3]),e[a]=d}break;case"gradientDataNumbers":var m=n.gradientDataNumbers;for(var a in m){for(var E=e[a],v=n[a],T=0,p=v.length;T<p;T++){var g=v[T];E.add(g.key,g.value)}e[a]=E}break;case"resources":var y=n.resources;for(var a in y)e[a]=t.Loader.getRes(y[a]);break;case"bursts":var S=n.bursts;for(T=0,p=S.length;T<p;T++){var R=S[T];e.addBurst(new lt(R.time,R.min,R.max))}break;case"randomSeed":e.randomSeed[0]=n.randomSeed;break;case"shapeType":case"type":case"color":case"size":case"frame":case"startFrame":case"angularVelocity":case"velocity":break;default:throw"ShurikenParticle3D:unknown type."}}},{key:"_parse",value:function(e,t){if(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_parse",this).call(this,e,t),e.main){var r=this.particleSystem,o=this.particleRenderer;this._parseModule(o,e.renderer),this._parseModule(r,e.main),this._parseModule(r.emission,e.emission);var s=e.shape;if(s){var l;switch(s.shapeType){case 0:l=new Ct;break;case 1:l=new Rt;break;case 2:l=new St;break;case 3:l=new gt;break;case 7:l=new yt;break;default:throw"ShuriKenParticle3D:unknown shape type."}this._parseModule(l,s),r.shape=l}var _=e.velocityOverLifetime;if(_){var u,c=_.velocity;switch(c.type){case 0:var h=c.constant;u=Et.createByConstant(h?new a(h[0],h[1],h[2]):new a(0,0,0));break;case 1:u=Et.createByGradient(this._initParticleVelocity(c.gradientX),this._initParticleVelocity(c.gradientY),this._initParticleVelocity(c.gradientZ));break;case 2:var d=c.constantMin,f=c.constantMax;u=Et.createByRandomTwoConstant(d?new a(d[0],d[1],d[2]):new a(0,0,0),f?new a(f[0],f[1],f[2]):new a(0,0,0));break;case 3:u=Et.createByRandomTwoGradient(this._initParticleVelocity(c.gradientXMin),this._initParticleVelocity(c.gradientXMax),this._initParticleVelocity(c.gradientYMin),this._initParticleVelocity(c.gradientYMax),this._initParticleVelocity(c.gradientZMin),this._initParticleVelocity(c.gradientZMax))}var m=new Dt(u);this._parseModule(m,_),r.velocityOverLifetime=m}var E=e.colorOverLifetime;if(E){var v,T=E.color;switch(T.type){case 0:var p=T.constant;v=_t.createByConstant(p?new i(p[0],p[1],p[2],p[3]):new i(0,0,0,0));break;case 1:v=_t.createByGradient(this._initParticleColor(T.gradient));break;case 2:var g=T.constantMin,y=T.constantMax;v=_t.createByRandomTwoConstant(g?new i(g[0],g[1],g[2],g[3]):new i(0,0,0,0),g?new i(y[0],y[1],y[2],y[3]):new i(0,0,0,0));break;case 3:v=_t.createByRandomTwoGradient(this._initParticleColor(T.gradientMin),this._initParticleColor(T.gradientMax))}var S=new ut(v);this._parseModule(S,E),r.colorOverLifetime=S}var R=e.sizeOverLifetime;if(R){var C,I=R.size;switch(I.type){case 0:C=I.separateAxes?mt.createByGradientSeparate(this._initParticleSize(I.gradientX),this._initParticleSize(I.gradientY),this._initParticleSize(I.gradientZ)):mt.createByGradient(this._initParticleSize(I.gradient));break;case 1:if(I.separateAxes){var A=I.constantMinSeparate,x=I.constantMaxSeparate;C=mt.createByRandomTwoConstantSeparate(A?new a(A[0],A[1],A[2]):new a(0,0,0),x?new a(x[0],x[1],x[2]):new a(0,0,0))}else C=mt.createByRandomTwoConstant(I.constantMin||0,I.constantMax||0);break;case 2:C=I.separateAxes?mt.createByRandomTwoGradientSeparate(this._initParticleSize(I.gradientXMin),this._initParticleSize(I.gradientYMin),this._initParticleSize(I.gradientZMin),this._initParticleSize(I.gradientXMax),this._initParticleSize(I.gradientYMax),this._initParticleSize(I.gradientZMax)):mt.createByRandomTwoGradient(this._initParticleSize(I.gradientMin),this._initParticleSize(I.gradientMax))}var D=new It(C);this._parseModule(D,R),r.sizeOverLifetime=D}var L=e.rotationOverLifetime;if(L){var M,O=L.angularVelocity;switch(O.type){case 0:if(O.separateAxes){var N=O.constantSeparate;M=ht.createByConstantSeparate(N?new a(N[0],N[1],N[2]):new a(0,0,Math.PI/4))}else M=ht.createByConstant(O.constant||Math.PI/4);break;case 1:M=O.separateAxes?ht.createByGradientSeparate(this._initParticleRotation(O.gradientX),this._initParticleRotation(O.gradientY),this._initParticleRotation(O.gradientZ)):ht.createByGradient(this._initParticleRotation(O.gradient));break;case 2:if(O.separateAxes){var P=O.constantMinSeparate,b=O.constantMaxSeparate;M=ht.createByRandomTwoConstantSeparate(P?new a(P[0],P[1],P[2]):new a(0,0,0),b?new a(b[0],b[1],b[2]):new a(0,0,Math.PI/4))}else M=ht.createByRandomTwoConstant(O.constantMin||0,O.constantMax||Math.PI/4);break;case 3:O.separateAxes||(M=ht.createByRandomTwoGradient(this._initParticleRotation(O.gradientMin),this._initParticleRotation(O.gradientMax)))}var V=new vt(M);this._parseModule(V,L),r.rotationOverLifetime=V}var k=e.textureSheetAnimation;if(k){var w,F=k.frame;switch(F.type){case 0:w=ct.createByConstant(F.constant);break;case 1:w=ct.createByOverTime(this._initParticleFrame(F.overTime));break;case 2:w=ct.createByRandomTwoConstant(F.constantMin,F.constantMax);break;case 3:w=ct.createByRandomTwoOverTime(this._initParticleFrame(F.overTimeMin),this._initParticleFrame(F.overTimeMax))}var B,U=k.startFrame;switch(U.type){case 0:B=At.createByConstant(U.constant);break;case 1:B=At.createByRandomTwoConstant(U.constantMin,U.constantMax)}var G=new xt(w,B);this._parseModule(G,k),r.textureSheetAnimation=G}}else this._parseOld(e)}},{key:"_activeHierarchy",value:function(e){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_activeHierarchy",this).call(this,e),this.particleSystem.playOnAwake&&this.particleSystem.play()}},{key:"_inActiveHierarchy",value:function(e){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_inActiveHierarchy",this).call(this,e),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)}},{key:"_cloneTo",value:function(e,t,r){var i=e,a=i._particleSystem;this._particleSystem.cloneTo(a);var o=i._render,s=this._render;o.sharedMaterials=s.sharedMaterials,o.enable=s.enable,o.renderMode=s.renderMode,o.mesh=s.mesh,o.stretchedBillboardCameraSpeedScale=s.stretchedBillboardCameraSpeedScale,o.stretchedBillboardSpeedScale=s.stretchedBillboardSpeedScale,o.stretchedBillboardLengthScale=s.stretchedBillboardLengthScale,o.sortingFudge=s.sortingFudge,_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_cloneTo",this).call(this,e,t,r)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this,e),this._particleSystem.destroy(),this._particleSystem=null)}},{key:"_create",value:function(){return new n}},{key:"_parseOld",value:function(e){var o,s,l,_=Math.PI/180,u=this.particleRenderer,c=e.material;c&&(l=t.Loader.getRes(c.path)),u.sharedMaterial=l;var h=e.meshPath;h&&(u.mesh=t.Loader.getRes(h)),u.renderMode=e.renderMode,u.stretchedBillboardCameraSpeedScale=e.stretchedBillboardCameraSpeedScale,u.stretchedBillboardSpeedScale=e.stretchedBillboardSpeedScale,u.stretchedBillboardLengthScale=e.stretchedBillboardLengthScale,u.sortingFudge=e.sortingFudge?e.sortingFudge:0;var d=this.particleSystem;d.isPerformanceMode=e.isPerformanceMode,d.duration=e.duration,d.looping=e.looping,d.prewarm=e.prewarm,d.startDelayType=e.startDelayType,d.startDelay=e.startDelay,d.startDelayMin=e.startDelayMin,d.startDelayMax=e.startDelayMax,d.startLifetimeType=e.startLifetimeType,d.startLifetimeConstant=e.startLifetimeConstant,d.startLifeTimeGradient=n._initStartLife(e.startLifetimeGradient),d.startLifetimeConstantMin=e.startLifetimeConstantMin,d.startLifetimeConstantMax=e.startLifetimeConstantMax,d.startLifeTimeGradientMin=n._initStartLife(e.startLifetimeGradientMin),d.startLifeTimeGradientMax=n._initStartLife(e.startLifetimeGradientMax),d.startSpeedType=e.startSpeedType,d.startSpeedConstant=e.startSpeedConstant,d.startSpeedConstantMin=e.startSpeedConstantMin,d.startSpeedConstantMax=e.startSpeedConstantMax,d.threeDStartSize=e.threeDStartSize,d.startSizeType=e.startSizeType,d.startSizeConstant=e.startSizeConstant;var f=e.startSizeConstantSeparate,m=d.startSizeConstantSeparate;m.x=f[0],m.y=f[1],m.z=f[2],d.startSizeConstantMin=e.startSizeConstantMin,d.startSizeConstantMax=e.startSizeConstantMax;var E=e.startSizeConstantMinSeparate,v=d.startSizeConstantMinSeparate;v.x=E[0],v.y=E[1],v.z=E[2];var T=e.startSizeConstantMaxSeparate,p=d.startSizeConstantMaxSeparate;p.x=T[0],p.y=T[1],p.z=T[2],d.threeDStartRotation=e.threeDStartRotation,d.startRotationType=e.startRotationType,d.startRotationConstant=e.startRotationConstant*_;var g=e.startRotationConstantSeparate,y=d.startRotationConstantSeparate;y.x=g[0]*_,y.y=g[1]*_,y.z=g[2]*_,d.startRotationConstantMin=e.startRotationConstantMin*_,d.startRotationConstantMax=e.startRotationConstantMax*_;var S=e.startRotationConstantMinSeparate,R=d.startRotationConstantMinSeparate;R.x=S[0]*_,R.y=S[1]*_,R.z=S[2]*_;var C=e.startRotationConstantMaxSeparate,I=d.startRotationConstantMaxSeparate;I.x=C[0]*_,I.y=C[1]*_,I.z=C[2]*_,d.randomizeRotationDirection=e.randomizeRotationDirection,d.startColorType=e.startColorType;var A=e.startColorConstant,x=d.startColorConstant;x.x=A[0],x.y=A[1],x.z=A[2],x.w=A[3];var D=e.startColorConstantMin,L=d.startColorConstantMin;L.x=D[0],L.y=D[1],L.z=D[2],L.w=D[3];var M=e.startColorConstantMax,O=d.startColorConstantMax;O.x=M[0],O.y=M[1],O.z=M[2],O.w=M[3],d.gravityModifier=e.gravityModifier,d.simulationSpace=e.simulationSpace,void 0!==e.simulationSpeed&&(d.simulationSpeed=e.simulationSpeed),d.scaleMode=e.scaleMode,d.playOnAwake=e.playOnAwake,d.maxParticles=e.maxParticles;var N=e.autoRandomSeed;null!=N&&(d.autoRandomSeed=N);var P=e.randomSeed;null!=P&&(d.randomSeed[0]=P);var b=e.emission,V=d.emission;if(b){V.emissionRate=b.emissionRate;var k=b.bursts;if(k)for(o=0,s=k.length;o<s;o++){var w=k[o];V.addBurst(new lt(w.time,w.min,w.max))}V.enable=b.enable}else V.enable=!1;var F=e.shape;if(F){var B;switch(F.shapeType){case 0:var U;B=U=new Ct,U.radius=F.sphereRadius,U.emitFromShell=F.sphereEmitFromShell,U.randomDirection=F.sphereRandomDirection;break;case 1:var G;B=G=new Rt,G.radius=F.hemiSphereRadius,G.emitFromShell=F.hemiSphereEmitFromShell,G.randomDirection=F.hemiSphereRandomDirection;break;case 2:var z;B=z=new St,z.angle=F.coneAngle*_,z.radius=F.coneRadius,z.length=F.coneLength,z.emitType=F.coneEmitType,z.randomDirection=F.coneRandomDirection;break;case 3:var H;B=H=new gt,H.x=F.boxX,H.y=F.boxY,H.z=F.boxZ,H.randomDirection=F.boxRandomDirection;break;case 7:var W;B=W=new yt,W.radius=F.circleRadius,W.arc=F.circleArc*_,W.emitFromEdge=F.circleEmitFromEdge,W.randomDirection=F.circleRandomDirection;break;default:var X;B=X=new yt,X.radius=F.circleRadius,X.arc=F.circleArc*_,X.emitFromEdge=F.circleEmitFromEdge,X.randomDirection=F.circleRandomDirection}B.enable=F.enable,d.shape=B}var Y=e.velocityOverLifetime;if(Y){var j,Z=Y.velocity;switch(Z.type){case 0:var q=Z.constant;j=Et.createByConstant(new a(q[0],q[1],q[2]));break;case 1:j=Et.createByGradient(this._initParticleVelocity(Z.gradientX),this._initParticleVelocity(Z.gradientY),this._initParticleVelocity(Z.gradientZ));break;case 2:var Q=Z.constantMin,K=Z.constantMax;j=Et.createByRandomTwoConstant(new a(Q[0],Q[1],Q[2]),new a(K[0],K[1],K[2]));break;case 3:j=Et.createByRandomTwoGradient(this._initParticleVelocity(Z.gradientXMin),this._initParticleVelocity(Z.gradientXMax),this._initParticleVelocity(Z.gradientYMin),this._initParticleVelocity(Z.gradientYMax),this._initParticleVelocity(Z.gradientZMin),this._initParticleVelocity(Z.gradientZMax))}var J=new Dt(j);J.space=Y.space,J.enable=Y.enable,d.velocityOverLifetime=J}var $=e.colorOverLifetime;if($){var ee,te=$.color;switch(te.type){case 0:var ne=te.constant;ee=_t.createByConstant(new i(ne[0],ne[1],ne[2],ne[3]));break;case 1:ee=_t.createByGradient(this._initParticleColor(te.gradient));break;case 2:var re=te.constantMin,ie=te.constantMax;ee=_t.createByRandomTwoConstant(new i(re[0],re[1],re[2],re[3]),new i(ie[0],ie[1],ie[2],ie[3]));break;case 3:ee=_t.createByRandomTwoGradient(this._initParticleColor(te.gradientMin),this._initParticleColor(te.gradientMax))}var ae=new ut(ee);ae.enable=$.enable,d.colorOverLifetime=ae}var oe=e.sizeOverLifetime;if(oe){var se,le=oe.size;switch(le.type){case 0:se=le.separateAxes?mt.createByGradientSeparate(this._initParticleSize(le.gradientX),this._initParticleSize(le.gradientY),this._initParticleSize(le.gradientZ)):mt.createByGradient(this._initParticleSize(le.gradient));break;case 1:if(le.separateAxes){var _e=le.constantMinSeparate,ue=le.constantMaxSeparate;se=mt.createByRandomTwoConstantSeparate(new a(_e[0],_e[1],_e[2]),new a(ue[0],ue[1],ue[2]))}else se=mt.createByRandomTwoConstant(le.constantMin,le.constantMax);break;case 2:se=le.separateAxes?mt.createByRandomTwoGradientSeparate(this._initParticleSize(le.gradientXMin),this._initParticleSize(le.gradientYMin),this._initParticleSize(le.gradientZMin),this._initParticleSize(le.gradientXMax),this._initParticleSize(le.gradientYMax),this._initParticleSize(le.gradientZMax)):mt.createByRandomTwoGradient(this._initParticleSize(le.gradientMin),this._initParticleSize(le.gradientMax))}var ce=new It(se);ce.enable=oe.enable,d.sizeOverLifetime=ce}var he=e.rotationOverLifetime;if(he){var de,fe=he.angularVelocity;switch(fe.type){case 0:if(fe.separateAxes){var me=fe.constantSeparate;de=ht.createByConstantSeparate(new a(me[0]*_,me[1]*_,me[2]*_))}else de=ht.createByConstant(fe.constant*_);break;case 1:de=fe.separateAxes?ht.createByGradientSeparate(this._initParticleRotation(fe.gradientX),this._initParticleRotation(fe.gradientY),this._initParticleRotation(fe.gradientZ)):ht.createByGradient(this._initParticleRotation(fe.gradient));break;case 2:if(fe.separateAxes){var Ee=fe.constantMinSeparate,ve=fe.constantMaxSeparate;de=ht.createByRandomTwoConstantSeparate(new a(Ee[0]*_,Ee[1]*_,Ee[2]*_),new a(ve[0]*_,ve[1]*_,ve[2]*_))}else de=ht.createByRandomTwoConstant(fe.constantMin*_,fe.constantMax*_);break;case 3:fe.separateAxes||(de=ht.createByRandomTwoGradient(this._initParticleRotation(fe.gradientMin),this._initParticleRotation(fe.gradientMax)))}var Te=new vt(de);Te.enable=he.enable,d.rotationOverLifetime=Te}var pe=e.textureSheetAnimation;if(pe){var ge,ye=pe.frame;switch(ye.type){case 0:ge=ct.createByConstant(ye.constant);break;case 1:ge=ct.createByOverTime(this._initParticleFrame(ye.overTime));break;case 2:ge=ct.createByRandomTwoConstant(ye.constantMin,ye.constantMax);break;case 3:ge=ct.createByRandomTwoOverTime(this._initParticleFrame(ye.overTimeMin),this._initParticleFrame(ye.overTimeMax))}var Se,Re=pe.startFrame;switch(Re.type){case 0:Se=At.createByConstant(Re.constant);break;case 1:Se=At.createByRandomTwoConstant(Re.constantMin,Re.constantMax)}var Ce=new xt(ge,Se);Ce.enable=pe.enable;var Ie=pe.tiles;Ce.tiles=new r(Ie[0],Ie[1]),Ce.type=pe.type,Ce.randomRow=pe.randomRow;var Ae=pe.rowIndex;void 0!==Ae&&(Ce.rowIndex=Ae),Ce.cycles=pe.cycles,d.textureSheetAnimation=Ce}}},{key:"_initParticleColor",value:function(e){var t=new st(4,4);if(e){var n,r,i=e.alphas;if(i)for(n=0,r=i.length;n<r;n++){3==n&&r>4&&(n=r-1,console.warn("GradientDataColor warning:alpha data length is large than 4, will ignore the middle data."));var a=i[n];t.addColorAlpha(a.key,a.value)}else t.addColorAlpha(0,1),t.addColorAlpha(1,1);var o=e.rgbs;if(o)for(n=0,r=o.length;n<r;n++){3==n&&r>4&&(n=r-1,console.warn("GradientDataColor warning:rgb data length is large than 4, will ignore the middle data."));var s=o[n],l=s.value;t.addColorRGB(s.key,new ae(l[0],l[1],l[2],1))}else t.addColorRGB(0,new ae(1,1,1,1)),t.addColorRGB(1,new ae(1,1,1,1))}else t.addColorAlpha(0,1),t.addColorAlpha(1,1),t.addColorRGB(0,new ae(1,1,1,1)),t.addColorRGB(1,new ae(1,1,1,1));return t}},{key:"_initParticleFrame",value:function(e){var t=new dt;if(e)for(var n=e.frames,r=0,i=n.length;r<i;r++){var a=n[r];t.add(a.key,a.value)}else t.add(0,0),t.add(1,1);return t}},{key:"_initParticleVelocity",value:function(e){for(var t=new ft,n=e.velocitys,r=0,i=n.length;r<i;r++){var a=n[r];t.add(a.key,a.value)}return t}},{key:"_initParticleSize",value:function(e){var t=new ft;if(e)for(var n=e.sizes,r=0,i=n.length;r<i;r++){var a=n[r];t.add(a.key,a.value)}else t.add(0,0),t.add(1,1);return t}},{key:"_initParticleRotation",value:function(e){for(var t=new ft,n=e.angularVelocitys,r=0,i=n.length;r<i;r++){var a=n[r];t.add(a.key,a.value/180*Math.PI)}return t}}],[{key:"_initStartLife",value:function(e){for(var t=new ft,n=e.startLifetimes,r=0,i=n.length;r<i;r++){var a=n[r];t.add(a.key,a.value)}return t}}]),n}(),zt=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("LineShader"),e._shaderValues.setVector(t.COLOR,new i(1,1,1,1)),e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"color",get:function(){return this._shaderValues.getVector(t.COLOR)},set:function(e){this._shaderValues.setVector(t.COLOR,e)}},{key:"depthWrite",set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)},get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)}},{key:"cull",set:function(e){this._shaderValues.setInt(t.CULL,e)},get:function(){return this._shaderValues.getInt(t.CULL)}},{key:"blend",set:function(e){this._shaderValues.setInt(t.BLEND,e)},get:function(){return this._shaderValues.getInt(t.BLEND)}},{key:"blendSrc",set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)},get:function(){return this._shaderValues.getInt(t.BLEND_SRC)}},{key:"blendDst",set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)},get:function(){return this._shaderValues.getInt(t.BLEND_DST)}},{key:"depthTest",set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)},get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)}}],[{key:"__initDefine__",value:function(){}}]),t}();zt.COLOR=U.propertyNameToID("u_Color"),zt.CULL=U.propertyNameToID("s_Cull"),zt.BLEND=U.propertyNameToID("s_Blend"),zt.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),zt.BLEND_DST=U.propertyNameToID("s_BlendDst"),zt.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),zt.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var Ht=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"vertexDeclaration",get:function(){return e._vertexDeclaration}}],[{key:"__init__",value:function(){e._vertexDeclaration=new Ee(28,[new ve(0,me.Vector3,Te.MESH_POSITION0),new ve(12,me.Vector4,Te.MESH_COLOR0)])}},{key:"vertexDeclaration",get:function(){return e._vertexDeclaration}}]),e}(),Wt=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,qe),_createClass(t,[{key:"add",value:function(e){if(-1!==e._getIndexInList())throw"SimpleSingletonList:"+e+" has  in  SingletonList.";this._add(e),e._setIndexInList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInList();if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._setIndexInList(t)}e._setIndexInList(-1)}},{key:"clear",value:function(){for(var e,t=this.elements,n=this.length;e<n;e++)t[e]._setIndexInList(-1);this.length=0}}]),t}(),Xt=function e(){_classCallCheck(this,e),this._pressedSprite=null,this._pressedLoopCount=-1,this.sprite=null,this.mousePositionX=0,this.mousePositionY=0},Yt=function(){function e(){_classCallCheck(this,e),this._indexInList=-1,this._identifier=-1,this._position=new r}return _createClass(e,[{key:"_getIndexInList",value:function(){return this._indexInList}},{key:"_setIndexInList",value:function(e){this._indexInList=e}},{key:"identifier",get:function(){return this._identifier}},{key:"position",get:function(){return this._position}}]),e}(),jt=function e(){_classCallCheck(this,e),this.succeeded=!1,this.collider=null,this.point=new a,this.normal=new a,this.hitFraction=0},Zt=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,qe),_createClass(t,[{key:"add",value:function(e){if(-1!==e._inPhysicUpdateListIndex)throw"PhysicsUpdateList:element has  in  PhysicsUpdateList.";this._add(e),e._inPhysicUpdateListIndex=this.length++}},{key:"remove",value:function(e){var t=e._inPhysicUpdateListIndex;if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._inPhysicUpdateListIndex=t}e._inPhysicUpdateListIndex=-1}}]),t}(),qt=function e(){_classCallCheck(this,e),this._idCounter=0,this.colliderA=null,this.colliderB=null,this.distance=0,this.normal=new a,this.positionOnA=new a,this.positionOnB=new a,this._id=++this._idCounter},Qt=function(){function e(){_classCallCheck(this,e),this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[]}return _createClass(e,[{key:"_setUpdateFrame",value:function(e){this._lastUpdateFrame=this._updateFrame,this._updateFrame=e}}]),e}(),Kt=function(){function e(){_classCallCheck(this,e),this._hitResultsPoolIndex=0,this._hitResultsPool=[],this._contactPonintsPoolIndex=0,this._contactPointsPool=[],this._collisionsPool=[],this._collisions={}}return _createClass(e,[{key:"getHitResult",value:function(){var e=this._hitResultsPool[this._hitResultsPoolIndex++];return e||(e=new jt,this._hitResultsPool.push(e)),e}},{key:"recoverAllHitResultsPool",value:function(){this._hitResultsPoolIndex=0}},{key:"getContactPoints",value:function(){var e=this._contactPointsPool[this._contactPonintsPoolIndex++];return e||(e=new qt,this._contactPointsPool.push(e)),e}},{key:"recoverAllContactPointsPool",value:function(){this._contactPonintsPoolIndex=0}},{key:"getCollision",value:function(e,t){var n,r=e.id,i=t.id,a=this._collisions[r];return a&&(n=a[i]),n||(a||(a={},this._collisions[r]=a),(n=0===this._collisionsPool.length?new Qt:this._collisionsPool.pop())._colliderA=e,n._colliderB=t,a[i]=n),n}},{key:"recoverCollision",value:function(e){var t=e._colliderA.id,n=e._colliderB.id;this._collisions[t][n]=null,this._collisionsPool.push(e)}},{key:"garbageCollection",value:function(){for(var e in this._hitResultsPoolIndex=0,this._hitResultsPool.length=0,this._contactPonintsPoolIndex=0,this._contactPointsPool.length=0,this._collisionsPool.length=0,this._collisionsPool){var t=this._collisionsPool[e],n=!0;for(var r in t)t[r]?n=!1:delete t[r];n&&delete this._collisionsPool[e]}}}]),e}(),Jt=function(){function e(){_classCallCheck(this,e),this._scale=new a(1,1,1),this._centerMatrix=new T,this._attatched=!1,this._indexInCompound=-1,this._compoundParent=null,this._attatchedCollisionObject=null,this._referenceCount=0,this._localOffset=new a(0,0,0),this._localRotation=new d(0,0,0,1),this.needsCustomCollisionCallback=!1}return _createClass(e,[{key:"_setScale",value:function(t){if(this._compoundParent)this.updateLocalTransformations();else{var n=I._bullet;n.btVector3_setValue(e._btScale,t.x,t.y,t.z),n.btCollisionShape_setLocalScaling(this._btShape,e._btScale)}}},{key:"_addReference",value:function(){this._referenceCount++}},{key:"_removeReference",value:function(){this._referenceCount--}},{key:"updateLocalTransformations",value:function(){if(this._compoundParent){var t=e._tempVector30;a.multiply(this.localOffset,this._scale,t),e._createAffineTransformation(t,this.localRotation,this._centerMatrix.elements)}else e._createAffineTransformation(this.localOffset,this.localRotation,this._centerMatrix.elements)}},{key:"cloneTo",value:function(e){var t=e;this._localOffset.cloneTo(t.localOffset),this._localRotation.cloneTo(t.localRotation),t.localOffset=t.localOffset,t.localRotation=t.localRotation}},{key:"clone",value:function(){return null}},{key:"destroy",value:function(){this._btShape&&(I._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}},{key:"type",get:function(){return this._type}},{key:"localOffset",get:function(){return this._localOffset},set:function(e){this._localOffset=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}},{key:"localRotation",get:function(){return this._localRotation},set:function(e){this._localRotation=e,this._compoundParent&&this._compoundParent._updateChildTransform(this)}}],[{key:"__init__",value:function(){var t=I._bullet;e._btScale=t.btVector3_create(1,1,1),e._btVector30=t.btVector3_create(0,0,0),e._btQuaternion0=t.btQuaternion_create(0,0,0,1),e._btTransform0=t.btTransform_create()}},{key:"_createAffineTransformation",value:function(e,t,n){var r=t.x,i=t.y,a=t.z,o=t.w,s=r+r,l=i+i,_=a+a,u=r*s,c=r*l,h=r*_,d=i*l,f=i*_,m=a*_,E=o*s,v=o*l,T=o*_;n[0]=1-(d+m),n[1]=c+T,n[2]=h-v,n[3]=0,n[4]=c-T,n[5]=1-(u+m),n[6]=f+E,n[7]=0,n[8]=h+v,n[9]=f-E,n[10]=1-(u+d),n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1}}]),e}();Jt.SHAPEORIENTATION_UPX=0,Jt.SHAPEORIENTATION_UPY=1,Jt.SHAPEORIENTATION_UPZ=2,Jt.SHAPETYPES_BOX=0,Jt.SHAPETYPES_SPHERE=1,Jt.SHAPETYPES_CYLINDER=2,Jt.SHAPETYPES_CAPSULE=3,Jt.SHAPETYPES_CONVEXHULL=4,Jt.SHAPETYPES_COMPOUND=5,Jt.SHAPETYPES_STATICPLANE=6,Jt.SHAPETYPES_CONE=7,Jt._tempVector30=new a;var $t=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));i._sizeX=e,i._sizeY=n,i._sizeZ=r,i._type=Jt.SHAPETYPES_BOX;var a=I._bullet;return a.btVector3_setValue(t._btSize,e/2,n/2,r/2),i._btShape=a.btBoxShape_create(t._btSize),i}return _inherits(t,Jt),_createClass(t,[{key:"sizeX",get:function(){return this._sizeX}},{key:"sizeY",get:function(){return this._sizeY}},{key:"sizeZ",get:function(){return this._sizeZ}}],[{key:"__init__",value:function(){t._btSize=I._bullet.btVector3_create(0,0,0)}}]),_createClass(t,[{key:"clone",value:function(){var e=new t(this._sizeX,this._sizeY,this._sizeZ);return this.cloneTo(e),e}}]),t}(),en=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1.25,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Jt.SHAPEORIENTATION_UPY;_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));i._radius=e,i._length=n,i._orientation=r,i._type=Jt.SHAPETYPES_CAPSULE;var a=I._bullet;switch(r){case Jt.SHAPEORIENTATION_UPX:i._btShape=a.btCapsuleShapeX_create(e,n-2*e);break;case Jt.SHAPEORIENTATION_UPY:i._btShape=a.btCapsuleShape_create(e,n-2*e);break;case Jt.SHAPEORIENTATION_UPZ:i._btShape=a.btCapsuleShapeZ_create(e,n-2*e);break;default:throw"CapsuleColliderShape:unknown orientation."}return i}return _inherits(t,Jt),_createClass(t,[{key:"_setScale",value:function(e){var n=t._tempVector30;switch(this.orientation){case Jt.SHAPEORIENTATION_UPX:n.x=e.x,n.y=n.z=Math.max(e.y,e.z);break;case Jt.SHAPEORIENTATION_UPY:n.y=e.y,n.x=n.z=Math.max(e.x,e.z);break;case Jt.SHAPEORIENTATION_UPZ:n.z=e.z,n.x=n.y=Math.max(e.x,e.y);break;default:throw"CapsuleColliderShape:unknown orientation."}_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_setScale",this).call(this,n)}},{key:"clone",value:function(){var e=new t(this._radius,this._length,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"length",get:function(){return this._length}},{key:"orientation",get:function(){return this._orientation}}]),t}();en._tempVector30=new a;var tn=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._childColliderShapes=[],e._type=Jt.SHAPETYPES_COMPOUND,e._btShape=I._bullet.btCompoundShape_create(),e}return _inherits(t,Jt),_createClass(t,[{key:"_clearChildShape",value:function(e){e._attatched=!1,e._compoundParent=null,e._indexInCompound=-1}},{key:"_addReference",value:function(){}},{key:"_removeReference",value:function(){}},{key:"_updateChildTransform",value:function(e){var t=I._bullet,n=e.localOffset,r=e.localRotation,i=Jt._btVector30,a=Jt._btQuaternion0,o=Jt._btTransform0;t.btVector3_setValue(i,-n.x,n.y,n.z),t.btQuaternion_setValue(a,-r.x,r.y,r.z,-r.w),t.btTransform_setOrigin(o,i),t.btTransform_setRotation(o,a),t.btCompoundShape_updateChildTransform(this._btShape,e._indexInCompound,o,!0)}},{key:"addChildShape",value:function(e){if(e._attatched)throw"CompoundColliderShape: this shape has attatched to other entity.";e._attatched=!0,e._compoundParent=this,e._indexInCompound=this._childColliderShapes.length,this._childColliderShapes.push(e);var n=e.localOffset,r=e.localRotation,i=I._bullet;i.btVector3_setValue(t._btOffset,-n.x,n.y,n.z),i.btQuaternion_setValue(t._btRotation,-r.x,r.y,r.z,-r.w),i.btTransform_setOrigin(t._btTransform,t._btOffset),i.btTransform_setRotation(t._btTransform,t._btRotation);var a=i.btCollisionShape_getLocalScaling(this._btShape);i.btCollisionShape_setLocalScaling(this._btShape,t._btVector3One),i.btCompoundShape_addChildShape(this._btShape,t._btTransform,e._btShape),i.btCollisionShape_setLocalScaling(this._btShape,a),this._attatchedCollisionObject&&(this._attatchedCollisionObject.colliderShape=this)}},{key:"removeChildShape",value:function(e){if(e._compoundParent===this){var t=e._indexInCompound;this._clearChildShape(e);var n=this._childColliderShapes[this._childColliderShapes.length-1];n._indexInCompound=t,this._childColliderShapes[t]=n,this._childColliderShapes.pop(),I._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,t)}}},{key:"clearChildShape",value:function(){for(var e=0,t=this._childColliderShapes.length;e<t;e++)this._clearChildShape(this._childColliderShapes[e]),I._bullet.btCompoundShape_removeChildShapeByIndex(this._btShape,0);this._childColliderShapes.length=0}},{key:"getChildShapeCount",value:function(){return this._childColliderShapes.length}},{key:"cloneTo",value:function(e){var t=e;t.clearChildShape();for(var n=0,r=this._childColliderShapes.length;n<r;n++)t.addChildShape(this._childColliderShapes[n].clone())}},{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this);for(var e=0,n=this._childColliderShapes.length;e<n;e++){var r=this._childColliderShapes[e];0===r._referenceCount&&r.destroy()}}}],[{key:"__init__",value:function(){var e=I._bullet;t._btVector3One=e.btVector3_create(1,1,1),t._btTransform=e.btTransform_create(),t._btOffset=e.btVector3_create(0,0,0),t._btRotation=e.btQuaternion_create(0,0,0,1)}}]),t}(),nn=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Jt.SHAPEORIENTATION_UPY;_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));i._radius=1,i._height=.5,i._radius=e,i._height=n,i._orientation=r,i._type=Jt.SHAPETYPES_CYLINDER;var a=I._bullet;switch(r){case Jt.SHAPEORIENTATION_UPX:i._btShape=a.btConeShapeX_create(e,n);break;case Jt.SHAPEORIENTATION_UPY:i._btShape=a.btConeShape_create(e,n);break;case Jt.SHAPEORIENTATION_UPZ:i._btShape=a.btConeShapeZ_create(e,n);break;default:throw"ConeColliderShape:unknown orientation."}return i}return _inherits(t,Jt),_createClass(t,[{key:"clone",value:function(){var e=new t(this._radius,this._height,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"height",get:function(){return this._height}},{key:"orientation",get:function(){return this._orientation}}]),t}(),rn=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Jt.SHAPEORIENTATION_UPY;_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));i._radius=1,i._height=.5,i._radius=e,i._height=n,i._orientation=r,i._type=Jt.SHAPETYPES_CYLINDER;var a=I._bullet;switch(r){case Jt.SHAPEORIENTATION_UPX:a.btVector3_setValue(t._btSize,n/2,e,e),i._btShape=a.btCylinderShapeX_create(t._btSize);break;case Jt.SHAPEORIENTATION_UPY:a.btVector3_setValue(t._btSize,e,n/2,e),i._btShape=a.btCylinderShape_create(t._btSize);break;case Jt.SHAPEORIENTATION_UPZ:a.btVector3_setValue(t._btSize,e,e,n/2),i._btShape=a.btCylinderShapeZ_create(t._btSize);break;default:throw"CapsuleColliderShape:unknown orientation."}return i}return _inherits(t,Jt),_createClass(t,[{key:"clone",value:function(){var e=new t(this._radius,this._height,this._orientation);return this.cloneTo(e),e}},{key:"radius",get:function(){return this._radius}},{key:"height",get:function(){return this._height}},{key:"orientation",get:function(){return this._orientation}}],[{key:"__init__",value:function(){t._btSize=I._bullet.btVector3_create(0,0,0)}}]),t}(),an=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._mesh=null,e._convex=!1,e}return _inherits(t,Jt),_createClass(t,[{key:"_setScale",value:function(e){if(this._compoundParent)this.updateLocalTransformations();else{var t=I._bullet;t.btVector3_setValue(Jt._btScale,e.x,e.y,e.z),t.btCollisionShape_setLocalScaling(this._btShape,Jt._btScale),t.btGImpactShapeInterface_updateBound(this._btShape)}}},{key:"cloneTo",value:function(e){var n=e;n.convex=this._convex,n.mesh=this._mesh,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"cloneTo",this).call(this,e)}},{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"destroy",value:function(){this._btShape&&(I._bullet.btCollisionShape_destroy(this._btShape),this._btShape=null)}},{key:"mesh",get:function(){return this._mesh},set:function(e){if(this._mesh!==e){var t=I._bullet;this._mesh&&t.destroy(this._btShape),e&&(this._btShape=t.btGImpactMeshShape_create(e._getPhysicMesh()),t.btGImpactShapeInterface_updateBound(this._btShape)),this._mesh=e}}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex=e}}]),t}(),on=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._radius=e,n._type=Jt.SHAPETYPES_SPHERE,n._btShape=I._bullet.btSphereShape_create(e),n}return _inherits(t,Jt),_createClass(t,[{key:"radius",get:function(){return this._radius}}]),_createClass(t,[{key:"clone",value:function(){var e=new t(this._radius);return this.cloneTo(e),e}}]),t}(),sn=function(e){function n(e,t){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return r._restitution=0,r._friction=.5,r._rollingFriction=0,r._ccdMotionThreshold=0,r._ccdSweptSphereRadius=0,r._collisionGroup=Ot.COLLISIONFILTERGROUP_DEFAULTFILTER,r._canCollideWith=Ot.COLLISIONFILTERGROUP_ALLFILTER,r._colliderShape=null,r._transformFlag=2147483647,r._enableProcessCollisions=!0,r._inPhysicUpdateListIndex=-1,r.canScaleShape=!0,r._collisionGroup=e,r._canCollideWith=t,n._physicObjectsMap[r.id]=r,r}return _inherits(n,t.Component),_createClass(n,[{key:"_parseShape",value:function(e){var t=e.length;if(1===t){var r=n._creatShape(e[0]);this.colliderShape=r}else{for(var i=new tn,a=0;a<t;a++)r=n._creatShape(e[a]),i.addChildShape(r);this.colliderShape=i}}},{key:"_onScaleChange",value:function(e){this._colliderShape._setScale(e)}},{key:"_onEnable",value:function(){this._simulation=this.owner._scene.physicsSimulation,I._bullet.btCollisionObject_setContactProcessingThreshold(this._btColliderObject,1e30),this._colliderShape&&this._enabled&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}},{key:"_onDisable",value:function(){this._colliderShape&&this._enabled&&(this._removeFromSimulation(),-1!==this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.remove(this)),this._simulation=null}},{key:"_onDestroy",value:function(){delete n._physicObjectsMap[this.id],I._bullet.btCollisionObject_destroy(this._btColliderObject),this._colliderShape.destroy(),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onDestroy",this).call(this),this._btColliderObject=null,this._colliderShape=null,this._simulation=null,this.owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}},{key:"_isValid",value:function(){return this._simulation&&this._colliderShape&&this._enabled}},{key:"_parse",value:function(e){null!=e.collisionGroup&&(this.collisionGroup=e.collisionGroup),null!=e.canCollideWith&&(this.canCollideWith=e.canCollideWith),null!=e.ccdMotionThreshold&&(this.ccdMotionThreshold=e.ccdMotionThreshold),null!=e.ccdSweptSphereRadius&&(this.ccdSweptSphereRadius=e.ccdSweptSphereRadius)}},{key:"_setTransformFlag",value:function(e,t){t?this._transformFlag|=e:this._transformFlag&=~e}},{key:"_getTransformFlag",value:function(e){return 0!=(this._transformFlag&e)}},{key:"_addToSimulation",value:function(){}},{key:"_removeFromSimulation",value:function(){}},{key:"_derivePhysicsTransformation",value:function(e){this._innerDerivePhysicsTransformation(I._bullet.btCollisionObject_getWorldTransform(this._btColliderObject),e)}},{key:"_innerDerivePhysicsTransformation",value:function(e,t){var r=I._bullet,i=this.owner._transform,o=i.rotation,s=i.getWorldLossyScale();if(t||this._getTransformFlag(se.TRANSFORM_WORLDPOSITION)){var l=this._colliderShape.localOffset,_=i.position,u=n._btVector30;if(0!==l.x||0!==l.y||0!==l.z){var c=n._tempVector30;a.transformQuat(l,o,c),a.multiply(c,s,c),a.add(_,c,c),r.btVector3_setValue(u,-c.x,c.y,c.z)}else r.btVector3_setValue(u,-_.x,_.y,_.z);r.btTransform_setOrigin(e,u),this._setTransformFlag(se.TRANSFORM_WORLDPOSITION,!1)}if(t||this._getTransformFlag(se.TRANSFORM_WORLDQUATERNION)){var h=this._colliderShape.localRotation,d=n._btQuaternion0;if(0!==h.x||0!==h.y||0!==h.z||1!==h.w){var f=n._tempQuaternion0;n.physicQuaternionMultiply(o.x,o.y,o.z,o.w,h,f),r.btQuaternion_setValue(d,-f.x,f.y,f.z,-f.w)}else r.btQuaternion_setValue(d,-o.x,o.y,o.z,-o.w);r.btTransform_setRotation(e,d),this._setTransformFlag(se.TRANSFORM_WORLDQUATERNION,!1)}(t||this._getTransformFlag(se.TRANSFORM_WORLDSCALE))&&(this._onScaleChange(i.getWorldLossyScale()),this._setTransformFlag(se.TRANSFORM_WORLDSCALE,!1))}},{key:"_updateTransformComponent",value:function(e){var t=I._bullet,r=this._colliderShape.localOffset,i=this._colliderShape.localRotation,a=this.owner._transform,o=a.position,s=a.rotation,l=t.btTransform_getOrigin(e),_=t.btTransform_getRotation(e),u=-t.btQuaternion_x(_),c=t.btQuaternion_y(_),h=t.btQuaternion_z(_),d=-t.btQuaternion_w(_);if(0!==r.x||0!==r.y||0!==r.z){var f=n._tempVector30;n.physicVector3TransformQuat(r,u,c,h,d,f),o.x=-t.btVector3_x(l)-f.x,o.y=t.btVector3_y(l)-f.y,o.z=t.btVector3_z(l)-f.z}else o.x=-t.btVector3_x(l),o.y=t.btVector3_y(l),o.z=t.btVector3_z(l);if(a.position=o,0!==i.x||0!==i.y||0!==i.z||1!==i.w){var m=n._tempQuaternion0;i.invert(m),n.physicQuaternionMultiply(u,c,h,d,m,s)}else s.x=u,s.y=c,s.z=h,s.w=d;a.rotation=s}},{key:"_onShapeChange",value:function(e){var t=this._btColliderObject,r=I._bullet,i=r.btCollisionObject_getCollisionFlags(t);e.needsCustomCollisionCallback?0==(i&n.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)&&r.btCollisionObject_setCollisionFlags(t,i|n.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK):(i&n.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)>0&&r.btCollisionObject_setCollisionFlags(t,i^n.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK)}},{key:"_onAdded",value:function(){this.enabled=this._enabled,this.restitution=this._restitution,this.friction=this._friction,this.rollingFriction=this._rollingFriction,this.ccdMotionThreshold=this._ccdMotionThreshold,this.ccdSweptSphereRadius=this._ccdSweptSphereRadius,this.owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onTransformChanged)}},{key:"_onTransformChanged",value:function(e){n._addUpdateList&&(e&=se.TRANSFORM_WORLDPOSITION|se.TRANSFORM_WORLDQUATERNION|se.TRANSFORM_WORLDSCALE)&&(this._transformFlag|=e,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this))}},{key:"_cloneTo",value:function(e){var t=e;t.restitution=this._restitution,t.friction=this._friction,t.rollingFriction=this._rollingFriction,t.ccdMotionThreshold=this._ccdMotionThreshold,t.ccdSweptSphereRadius=this._ccdSweptSphereRadius,t.collisionGroup=this._collisionGroup,t.canCollideWith=this._canCollideWith,t.canScaleShape=this.canScaleShape,this._colliderShape&&(t.colliderShape=this._colliderShape.clone())}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e,this._btColliderObject&&I._bullet.btCollisionObject_setRestitution(this._btColliderObject,e)}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e,this._btColliderObject&&I._bullet.btCollisionObject_setFriction(this._btColliderObject,e)}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){this._rollingFriction=e,this._btColliderObject&&I._bullet.btCollisionObject_setRollingFriction(this._btColliderObject,e)}},{key:"ccdMotionThreshold",get:function(){return this._ccdMotionThreshold},set:function(e){this._ccdMotionThreshold=e,this._btColliderObject&&I._bullet.btCollisionObject_setCcdMotionThreshold(this._btColliderObject,e)}},{key:"ccdSweptSphereRadius",get:function(){return this._ccdSweptSphereRadius},set:function(e){this._ccdSweptSphereRadius=e,this._btColliderObject&&I._bullet.btCollisionObject_setCcdSweptSphereRadius(this._btColliderObject,e)}},{key:"isActive",get:function(){return!!this._btColliderObject&&I._bullet.btCollisionObject_isActive(this._btColliderObject)}},{key:"enabled",get:function(){return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"enabled",this)},set:function(e){this._enabled!=e&&(this._simulation&&this._colliderShape&&(e?(this._derivePhysicsTransformation(!0),this._addToSimulation()):this._removeFromSimulation()),_set(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"enabled",e,this))}},{key:"colliderShape",get:function(){return this._colliderShape},set:function(e){var t=this._colliderShape;if(t&&(t._attatched=!1,t._attatchedCollisionObject=null),this._colliderShape=e,e){if(e._attatched)throw"PhysicsComponent: this shape has attatched to other entity.";if(e._attatched=!0,e._attatchedCollisionObject=this,this._btColliderObject){I._bullet.btCollisionObject_setCollisionShape(this._btColliderObject,e._btShape);var n=this._simulation&&this._enabled;n&&t&&this._removeFromSimulation(),this._onShapeChange(e),n&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}}else this._simulation&&this._enabled&&t&&this._removeFromSimulation()}},{key:"simulation",get:function(){return this._simulation}},{key:"collisionGroup",get:function(){return this._collisionGroup},set:function(e){this._collisionGroup!==e&&(this._collisionGroup=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}},{key:"canCollideWith",get:function(){return this._canCollideWith},set:function(e){this._canCollideWith!==e&&(this._canCollideWith=e,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}}],[{key:"__init__",value:function(){var e=I._bullet;n._btVector30=e.btVector3_create(0,0,0),n._btQuaternion0=e.btQuaternion_create(0,0,0,1)}},{key:"_createAffineTransformationArray",value:function(e,t,n,r,i,a,o,s,l){var _=r+r,u=i+i,c=a+a,h=r*_,d=r*u,f=r*c,m=i*u,E=i*c,v=a*c,T=o*_,p=o*u,g=o*c,y=s[0],S=s[1],R=s[2];l[0]=(1-(m+v))*y,l[1]=(d+g)*y,l[2]=(f-p)*y,l[3]=0,l[4]=(d-g)*S,l[5]=(1-(h+v))*S,l[6]=(E+T)*S,l[7]=0,l[8]=(f+p)*R,l[9]=(E-T)*R,l[10]=(1-(h+m))*R,l[11]=0,l[12]=e,l[13]=t,l[14]=n,l[15]=1}},{key:"_creatShape",value:function(e){var n;switch(e.type){case"BoxColliderShape":var r=e.size;n=r?new $t(r[0],r[1],r[2]):new $t;break;case"SphereColliderShape":n=new on(e.radius);break;case"CapsuleColliderShape":n=new en(e.radius,e.height,e.orientation);break;case"MeshColliderShape":var i=new an;e.mesh&&(i.mesh=t.Loader.getRes(e.mesh)),n=i;break;case"ConeColliderShape":n=new nn(e.radius,e.height,e.orientation);break;case"CylinderColliderShape":n=new rn(e.radius,e.height,e.orientation);break;default:throw"unknown shape type."}if(e.center){var a=n.localOffset;a.fromArray(e.center),n.localOffset=a}return n}},{key:"physicVector3TransformQuat",value:function(e,t,n,r,i,a){var o=e.x,s=e.y,l=e.z,_=i*o+n*l-r*s,u=i*s+r*o-t*l,c=i*l+t*s-n*o,h=-t*o-n*s-r*l;a.x=_*i+h*-t+u*-r-c*-n,a.y=u*i+h*-n+c*-t-_*-r,a.z=c*i+h*-r+_*-n-u*-t}},{key:"physicQuaternionMultiply",value:function(e,t,n,r,i,a){var o=i.x,s=i.y,l=i.z,_=i.w,u=t*l-n*s,c=n*o-e*l,h=e*s-t*o,d=e*o+t*s+n*l;a.x=e*_+o*r+u,a.y=t*_+s*r+c,a.z=n*_+l*r+h,a.w=r*_-d}}]),n}();sn.ACTIVATIONSTATE_ACTIVE_TAG=1,sn.ACTIVATIONSTATE_ISLAND_SLEEPING=2,sn.ACTIVATIONSTATE_WANTS_DEACTIVATION=3,sn.ACTIVATIONSTATE_DISABLE_DEACTIVATION=4,sn.ACTIVATIONSTATE_DISABLE_SIMULATION=5,sn.COLLISIONFLAGS_STATIC_OBJECT=1,sn.COLLISIONFLAGS_KINEMATIC_OBJECT=2,sn.COLLISIONFLAGS_NO_CONTACT_RESPONSE=4,sn.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK=8,sn.COLLISIONFLAGS_CHARACTER_OBJECT=16,sn.COLLISIONFLAGS_DISABLE_VISUALIZE_OBJECT=32,sn.COLLISIONFLAGS_DISABLE_SPU_COLLISION_PROCESSING=64,sn._tempVector30=new a,sn._tempQuaternion0=new d,sn._tempQuaternion1=new d,sn._tempMatrix4x40=new T,sn._physicObjectsMap={},sn._addUpdateList=!0;var ln=function(){function e(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1];_classCallCheck(this,e),this._gravity=new a(0,-10,0),this._btVector3Zero=I._bullet.btVector3_create(0,0,0),this._btDefaultQuaternion=I._bullet.btQuaternion_create(0,0,0,-1),this._collisionsUtils=new Kt,this._previousFrameCollisions=[],this._currentFrameCollisions=[],this._physicsUpdateList=new Zt,this._characters=[],this._updatedRigidbodies=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this.maxSubSteps=t.maxSubSteps,this.fixedTimeStep=t.fixedTimeStep;var n=I._bullet;this._btCollisionConfiguration=n.btDefaultCollisionConfiguration_create(),this._btDispatcher=n.btCollisionDispatcher_create(this._btCollisionConfiguration),this._btBroadphase=n.btDbvtBroadphase_create(),n.btOverlappingPairCache_setInternalGhostPairCallback(n.btDbvtBroadphase_getOverlappingPairCache(this._btBroadphase),n.btGhostPairCallback_create());var r=t.flags;if(r&e.PHYSICSENGINEFLAGS_COLLISIONSONLY)this._btCollisionWorld=new n.btCollisionWorld(this._btDispatcher,this._btBroadphase,this._btCollisionConfiguration);else{if(r&e.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT)throw"PhysicsSimulation:SoftBody processing is not yet available";var i=n.btSequentialImpulseConstraintSolver_create();this._btDiscreteDynamicsWorld=n.btDiscreteDynamicsWorld_create(this._btDispatcher,this._btBroadphase,i,this._btCollisionConfiguration),this._btCollisionWorld=this._btDiscreteDynamicsWorld}this._btDiscreteDynamicsWorld&&(this._btSolverInfo=n.btDynamicsWorld_getSolverInfo(this._btDiscreteDynamicsWorld),this._btDispatchInfo=n.btCollisionWorld_getDispatchInfo(this._btDiscreteDynamicsWorld)),this._btClosestRayResultCallback=n.ClosestRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllHitsRayResultCallback=n.AllHitsRayResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btClosestConvexResultCallback=n.ClosestConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),this._btAllConvexResultCallback=n.AllConvexResultCallback_create(this._btVector3Zero,this._btVector3Zero),n.btGImpactCollisionAlgorithm_RegisterAlgorithm(this._btDispatcher)}return _createClass(e,[{key:"_simulate",value:function(e){this._updatedRigidbodies=0;var t=I._bullet;this._btDiscreteDynamicsWorld?t.btDiscreteDynamicsWorld_stepSimulation(this._btDiscreteDynamicsWorld,e,this.maxSubSteps,this.fixedTimeStep):t.PerformDiscreteCollisionDetection(this._btCollisionWorld)}},{key:"_destroy",value:function(){var e=I._bullet;this._btDiscreteDynamicsWorld?(e.btCollisionWorld_destroy(this._btDiscreteDynamicsWorld),this._btDiscreteDynamicsWorld=null):(e.btCollisionWorld_destroy(this._btCollisionWorld),this._btCollisionWorld=null),e.btDbvtBroadphase_destroy(this._btBroadphase),this._btBroadphase=null,e.btCollisionDispatcher_destroy(this._btDispatcher),this._btDispatcher=null,e.btDefaultCollisionConfiguration_destroy(this._btCollisionConfiguration),this._btCollisionConfiguration=null}},{key:"_addPhysicsCollider",value:function(e,t,n){I._bullet.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,n)}},{key:"_removePhysicsCollider",value:function(e){I._bullet.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject)}},{key:"_addRigidBody",value:function(e,t,n){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";I._bullet.btDiscreteDynamicsWorld_addRigidBody(this._btCollisionWorld,e._btColliderObject,t,n)}},{key:"_removeRigidBody",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";I._bullet.btDiscreteDynamicsWorld_removeRigidBody(this._btCollisionWorld,e._btColliderObject)}},{key:"_addCharacter",value:function(e,t,n){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var r=I._bullet;r.btCollisionWorld_addCollisionObject(this._btCollisionWorld,e._btColliderObject,t,n),r.btDynamicsWorld_addAction(this._btCollisionWorld,e._btKinematicCharacter)}},{key:"_removeCharacter",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";var t=I._bullet;t.btCollisionWorld_removeCollisionObject(this._btCollisionWorld,e._btColliderObject),t.btDynamicsWorld_removeAction(this._btCollisionWorld,e._btKinematicCharacter)}},{key:"raycastFromTo",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ot.COLLISIONFILTERGROUP_ALLFILTER,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ot.COLLISIONFILTERGROUP_ALLFILTER,o=I._bullet,s=this._btClosestRayResultCallback,l=e._btTempVector30,_=e._btTempVector31;if(o.btVector3_setValue(l,-t.x,t.y,t.z),o.btVector3_setValue(_,-n.x,n.y,n.z),o.ClosestRayResultCallback_set_m_rayFromWorld(s,l),o.ClosestRayResultCallback_set_m_rayToWorld(s,_),o.RayResultCallback_set_m_collisionFilterGroup(s,i),o.RayResultCallback_set_m_collisionFilterMask(s,a),o.RayResultCallback_set_m_collisionObject(s,null),o.RayResultCallback_set_m_closestHitFraction(s,1),o.btCollisionWorld_rayTest(this._btCollisionWorld,l,_,s),o.RayResultCallback_hasHit(s)){if(r){r.succeeded=!0,r.collider=sn._physicObjectsMap[o.btCollisionObject_getUserIndex(o.RayResultCallback_get_m_collisionObject(s))],r.hitFraction=o.RayResultCallback_get_m_closestHitFraction(s);var u=o.ClosestRayResultCallback_get_m_hitPointWorld(s),c=r.point;c.x=-o.btVector3_x(u),c.y=o.btVector3_y(u),c.z=o.btVector3_z(u);var h=o.ClosestRayResultCallback_get_m_hitNormalWorld(s),d=r.normal;d.x=-o.btVector3_x(h),d.y=o.btVector3_y(h),d.z=o.btVector3_z(h)}return!0}return r&&(r.succeeded=!1),!1}},{key:"raycastAllFromTo",value:function(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ot.COLLISIONFILTERGROUP_ALLFILTER,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ot.COLLISIONFILTERGROUP_ALLFILTER,o=I._bullet,s=this._btAllHitsRayResultCallback,l=e._btTempVector30,_=e._btTempVector31;r.length=0,o.btVector3_setValue(l,-t.x,t.y,t.z),o.btVector3_setValue(_,-n.x,n.y,n.z),o.AllHitsRayResultCallback_set_m_rayFromWorld(s,l),o.AllHitsRayResultCallback_set_m_rayToWorld(s,_),o.RayResultCallback_set_m_collisionFilterGroup(s,i),o.RayResultCallback_set_m_collisionFilterMask(s,a);var u=o.AllHitsRayResultCallback_get_m_collisionObjects(s),c=o.AllHitsRayResultCallback_get_m_hitPointWorld(s),h=o.AllHitsRayResultCallback_get_m_hitNormalWorld(s),d=o.AllHitsRayResultCallback_get_m_hitFractions(s);o.tBtCollisionObjectArray_clear(u),o.tVector3Array_clear(c),o.tVector3Array_clear(h),o.tScalarArray_clear(d),o.btCollisionWorld_rayTest(this._btCollisionWorld,l,_,s);var f=o.tBtCollisionObjectArray_size(u);if(f>0){this._collisionsUtils.recoverAllHitResultsPool();for(var m=0;m<f;m++){var E=this._collisionsUtils.getHitResult();r.push(E),E.succeeded=!0,E.collider=sn._physicObjectsMap[o.btCollisionObject_getUserIndex(o.tBtCollisionObjectArray_at(u,m))],E.hitFraction=o.tScalarArray_at(d,m);var v=o.tVector3Array_at(c,m),T=E.point;T.x=-o.btVector3_x(v),T.y=o.btVector3_y(v),T.z=o.btVector3_z(v);var p=o.tVector3Array_at(h,m),g=E.normal;g.x=-o.btVector3_x(p),g.y=o.btVector3_y(p),g.z=o.btVector3_z(p)}return!0}return!1}},{key:"rayCast",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ot.COLLISIONFILTERGROUP_ALLFILTER,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ot.COLLISIONFILTERGROUP_ALLFILTER,s=t.origin,l=e._tempVector30;return a.normalize(t.direction,l),a.scale(l,r,l),a.add(s,l,l),this.raycastFromTo(s,l,n,i,o)}},{key:"rayCastAll",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2147483647,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ot.COLLISIONFILTERGROUP_ALLFILTER,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Ot.COLLISIONFILTERGROUP_ALLFILTER,s=t.origin,l=e._tempVector30;return a.normalize(t.direction,l),a.scale(l,r,l),a.add(s,l,l),this.raycastAllFromTo(s,l,n,i,o)}},{key:"shapeCast",value:function(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:Ot.COLLISIONFILTERGROUP_ALLFILTER,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Ot.COLLISIONFILTERGROUP_ALLFILTER,_=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=I._bullet,c=this._btClosestConvexResultCallback,h=e._btTempVector30,d=e._btTempVector31,f=e._btTempQuaternion0,m=e._btTempQuaternion1,E=e._btTempTransform0,v=e._btTempTransform1,T=t._btShape;if(u.btVector3_setValue(h,-n.x,n.y,n.z),u.btVector3_setValue(d,-r.x,r.y,r.z),u.ConvexResultCallback_set_m_collisionFilterGroup(c,s),u.ConvexResultCallback_set_m_collisionFilterMask(c,l),u.btTransform_setOrigin(E,h),u.btTransform_setOrigin(v,d),a?(u.btQuaternion_setValue(f,-a.x,a.y,a.z,-a.w),u.btTransform_setRotation(E,f)):u.btTransform_setRotation(E,this._btDefaultQuaternion),o?(u.btQuaternion_setValue(m,-o.x,o.y,o.z,-o.w),u.btTransform_setRotation(v,m)):u.btTransform_setRotation(v,this._btDefaultQuaternion),u.ClosestConvexResultCallback_set_m_hitCollisionObject(c,null),u.ConvexResultCallback_set_m_closestHitFraction(c,1),u.btCollisionWorld_convexSweepTest(this._btCollisionWorld,T,E,v,c,_),u.ConvexResultCallback_hasHit(c)){if(i){i.succeeded=!0,i.collider=sn._physicObjectsMap[u.btCollisionObject_getUserIndex(u.ClosestConvexResultCallback_get_m_hitCollisionObject(c))],i.hitFraction=u.ConvexResultCallback_get_m_closestHitFraction(c);var p=u.ClosestConvexResultCallback_get_m_hitPointWorld(c),g=u.ClosestConvexResultCallback_get_m_hitNormalWorld(c),y=i.point,S=i.normal;y.x=-u.btVector3_x(p),y.y=u.btVector3_y(p),y.z=u.btVector3_z(p),S.x=-u.btVector3_x(g),S.y=u.btVector3_y(g),S.z=u.btVector3_z(g)}return!0}return i&&(i.succeeded=!1),!1}},{key:"shapeCastAll",value:function(t,n,r,i){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:Ot.COLLISIONFILTERGROUP_ALLFILTER,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Ot.COLLISIONFILTERGROUP_ALLFILTER,_=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=I._bullet,c=this._btAllConvexResultCallback,h=e._btTempVector30,d=e._btTempVector31,f=e._btTempQuaternion0,m=e._btTempQuaternion1,E=e._btTempTransform0,v=e._btTempTransform1,T=t._btShape;i.length=0,u.btVector3_setValue(h,-n.x,n.y,n.z),u.btVector3_setValue(d,-r.x,r.y,r.z),u.ConvexResultCallback_set_m_collisionFilterGroup(c,s),u.ConvexResultCallback_set_m_collisionFilterMask(c,l),u.btTransform_setOrigin(E,h),u.btTransform_setOrigin(v,d),a?(u.btQuaternion_setValue(f,-a.x,a.y,a.z,-a.w),u.btTransform_setRotation(E,f)):u.btTransform_setRotation(E,this._btDefaultQuaternion),o?(u.btQuaternion_setValue(m,-o.x,o.y,o.z,-o.w),u.btTransform_setRotation(v,m)):u.btTransform_setRotation(v,this._btDefaultQuaternion);var p=u.AllConvexResultCallback_get_m_collisionObjects(c);u.tBtCollisionObjectArray_clear(p),u.btCollisionWorld_convexSweepTest(this._btCollisionWorld,T,E,v,c,_);var g=u.tBtCollisionObjectArray_size(p);if(g>0){for(var y=u.AllConvexResultCallback_get_m_hitPointWorld(c),S=u.AllConvexResultCallback_get_m_hitNormalWorld(c),R=u.AllConvexResultCallback_get_m_hitFractions(c),C=0;C<g;C++){var A=this._collisionsUtils.getHitResult();i.push(A),A.succeeded=!0,A.collider=sn._physicObjectsMap[u.btCollisionObject_getUserIndex(u.tBtCollisionObjectArray_at(p,C))],A.hitFraction=u.tScalarArray_at(R,C);var x=u.tVector3Array_at(y,C),D=A.point;D.x=-u.btVector3_x(x),D.y=u.btVector3_y(x),D.z=u.btVector3_z(x);var L=u.tVector3Array_at(S,C),M=A.normal;M.x=-u.btVector3_x(L),M.y=u.btVector3_y(L),M.z=u.btVector3_z(L)}return!0}return!1}},{key:"addConstraint",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";e._simulation=this}},{key:"removeConstraint",value:function(e){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly"}},{key:"_updatePhysicsTransformFromRender",value:function(){for(var e=this._physicsUpdateList.elements,t=0,n=this._physicsUpdateList.length;t<n;t++){var r=e[t];r._derivePhysicsTransformation(!1),r._inPhysicUpdateListIndex=-1}this._physicsUpdateList.length=0}},{key:"_updateCharacters",value:function(){for(var e=0,t=this._characters.length;e<t;e++){var n=this._characters[e];n._updateTransformComponent(I._bullet.btCollisionObject_getWorldTransform(n._btColliderObject))}}},{key:"_updateCollisions",value:function(){this._collisionsUtils.recoverAllContactPointsPool();var e=this._currentFrameCollisions;this._currentFrameCollisions=this._previousFrameCollisions,this._currentFrameCollisions.length=0,this._previousFrameCollisions=e;for(var n=t.Stat.loopCount,r=I._bullet,i=r.btDispatcher_getNumManifolds(this._btDispatcher),a=0;a<i;a++){var o,s=r.btDispatcher_getManifoldByIndexInternal(this._btDispatcher,a),l=sn._physicObjectsMap[r.btCollisionObject_getUserIndex(r.btPersistentManifold_getBody0(s))],_=sn._physicObjectsMap[r.btCollisionObject_getUserIndex(r.btPersistentManifold_getBody1(s))],u=null,c=null;if((l.isTrigger||_.isTrigger)&&(l.owner._needProcessTriggers||_.owner._needProcessTriggers))for(var h=r.btPersistentManifold_getNumContacts(s),d=0;d<h;d++){var f=r.btPersistentManifold_getContactPoint(s,d),m=r.btManifoldPoint_getDistance(f);if(m<=0){c=(u=this._collisionsUtils.getCollision(l,_)).contacts,(o=u._updateFrame!==n)&&(u._isTrigger=!0,c.length=0);break}}else if((l.owner._needProcessCollisions||_.owner._needProcessCollisions)&&(l._enableProcessCollisions||_._enableProcessCollisions))for(h=r.btPersistentManifold_getNumContacts(s),d=0;d<h;d++)if(f=r.btPersistentManifold_getContactPoint(s,d),(m=r.btManifoldPoint_getDistance(f))<=0){var E=this._collisionsUtils.getContactPoints();E.colliderA=l,E.colliderB=_,E.distance=m;var v=r.btManifoldPoint_get_m_normalWorldOnB(f),T=E.normal;T.x=-r.btVector3_x(v),T.y=r.btVector3_y(v),T.z=r.btVector3_z(v);var p=r.btManifoldPoint_get_m_positionWorldOnA(f),g=E.positionOnA;g.x=-r.btVector3_x(p),g.y=r.btVector3_y(p),g.z=r.btVector3_z(p);var y=r.btManifoldPoint_get_m_positionWorldOnB(f),S=E.positionOnB;S.x=-r.btVector3_x(y),S.y=r.btVector3_y(y),S.z=r.btVector3_z(y),u||(c=(u=this._collisionsUtils.getCollision(l,_)).contacts,(o=u._updateFrame!==n)&&(u._isTrigger=!1,c.length=0)),c.push(E)}u&&o&&(this._currentFrameCollisions.push(u),u._setUpdateFrame(n))}}},{key:"_eventScripts",value:function(){for(var e=t.Stat.loopCount,n=0,r=this._currentFrameCollisions.length;n<r;n++){var i=this._currentFrameCollisions[n],a=i._colliderA,o=i._colliderB;if(!a.destroyed&&!o.destroyed)if(e-i._lastUpdateFrame==1){var s=a.owner,l=s._scripts;if(l)if(i._isTrigger){if(s._needProcessTriggers)for(var _=0,u=l.length;_<u;_++)l[_].onTriggerStay(o)}else if(s._needProcessCollisions)for(_=0,u=l.length;_<u;_++)i.other=o,l[_].onCollisionStay(i);var c=o.owner,h=c._scripts;if(h)if(i._isTrigger){if(c._needProcessTriggers)for(_=0,u=h.length;_<u;_++)h[_].onTriggerStay(a)}else if(c._needProcessCollisions)for(_=0,u=h.length;_<u;_++)i.other=a,h[_].onCollisionStay(i)}else{if(l=(s=a.owner)._scripts)if(i._isTrigger){if(s._needProcessTriggers)for(_=0,u=l.length;_<u;_++)l[_].onTriggerEnter(o)}else if(s._needProcessCollisions)for(_=0,u=l.length;_<u;_++)i.other=o,l[_].onCollisionEnter(i);if(h=(c=o.owner)._scripts)if(i._isTrigger){if(c._needProcessTriggers)for(_=0,u=h.length;_<u;_++)h[_].onTriggerEnter(a)}else if(c._needProcessCollisions)for(_=0,u=h.length;_<u;_++)i.other=a,h[_].onCollisionEnter(i)}}for(n=0,r=this._previousFrameCollisions.length;n<r;n++){var d=this._previousFrameCollisions[n],f=d._colliderA,m=d._colliderB;if(!f.destroyed&&!m.destroyed&&e-d._updateFrame==1){if(this._collisionsUtils.recoverCollision(d),l=(s=f.owner)._scripts)if(d._isTrigger){if(s._needProcessTriggers)for(_=0,u=l.length;_<u;_++)l[_].onTriggerExit(m)}else if(s._needProcessCollisions)for(_=0,u=l.length;_<u;_++)d.other=m,l[_].onCollisionExit(d);if(h=(c=m.owner)._scripts)if(d._isTrigger){if(c._needProcessTriggers)for(_=0,u=h.length;_<u;_++)h[_].onTriggerExit(f)}else if(c._needProcessCollisions)for(_=0,u=h.length;_<u;_++)d.other=f,h[_].onCollisionExit(d)}}}},{key:"clearForces",value:function(){if(!this._btDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";I._bullet.btDiscreteDynamicsWorld_clearForces(this._btDiscreteDynamicsWorld)}},{key:"continuousCollisionDetection",get:function(){return I._bullet.btCollisionWorld_get_m_useContinuous(this._btDispatchInfo)},set:function(e){I._bullet.btCollisionWorld_set_m_useContinuous(this._btDispatchInfo,e)}},{key:"gravity",get:function(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._gravity},set:function(t){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._gravity=t;var n=I._bullet,r=e._btTempVector30;n.btVector3_setValue(r,-t.x,t.y,t.z),n.btDiscreteDynamicsWorld_setGravity(this._btDiscreteDynamicsWorld,r)}},{key:"speculativeContactRestitution",get:function(){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";return I._bullet.btDiscreteDynamicsWorld_getApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld)},set:function(e){if(!this._btDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";I._bullet.btDiscreteDynamicsWorld_setApplySpeculativeContactRestitution(this._btDiscreteDynamicsWorld,e)}}],[{key:"__init__",value:function(){var t=I._bullet;e._btTempVector30=t.btVector3_create(0,0,0),e._btTempVector31=t.btVector3_create(0,0,0),e._btTempQuaternion0=t.btQuaternion_create(0,0,0,1),e._btTempQuaternion1=t.btQuaternion_create(0,0,0,1),e._btTempTransform0=t.btTransform_create(),e._btTempTransform1=t.btTransform_create()}},{key:"createConstraint",value:function(){}}]),e}();ln.PHYSICSENGINEFLAGS_NONE=0,ln.PHYSICSENGINEFLAGS_COLLISIONSONLY=1,ln.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT=2,ln.PHYSICSENGINEFLAGS_MULTITHREADED=4,ln.PHYSICSENGINEFLAGS_USEHARDWAREWHENPOSSIBLE=8,ln.SOLVERMODE_RANDMIZE_ORDER=1,ln.SOLVERMODE_FRICTION_SEPARATE=2,ln.SOLVERMODE_USE_WARMSTARTING=4,ln.SOLVERMODE_USE_2_FRICTION_DIRECTIONS=16,ln.SOLVERMODE_ENABLE_FRICTION_DIRECTION_CACHING=32,ln.SOLVERMODE_DISABLE_VELOCITY_DEPENDENT_FRICTION_DIRECTION=64,ln.SOLVERMODE_CACHE_FRIENDLY=128,ln.SOLVERMODE_SIMD=256,ln.SOLVERMODE_INTERLEAVE_CONTACT_AND_FRICTION_CONSTRAINTS=512,ln.SOLVERMODE_ALLOW_ZERO_LENGTH_FRICTION_DIRECTIONS=1024,ln._tempVector30=new a,ln.disableSimulation=!1;var _n=function(){function e(){var t=this;_classCallCheck(this,e),this._eventList=[],this._mouseTouch=new Xt,this._touchPool=[],this._touches=new Wt,this._multiTouchEnabled=!0,this._pushEventList=function(e){e.cancelable&&e.preventDefault(),t._eventList.push(e)}.bind(this)}return _createClass(e,[{key:"__init__",value:function(e,t){this._scene=t,e.oncontextmenu=function(e){return!1}}},{key:"_onCanvasEvent",value:function(e){e.addEventListener("mousedown",this._pushEventList),e.addEventListener("mouseup",this._pushEventList,!0),e.addEventListener("mousemove",this._pushEventList,!0),e.addEventListener("touchstart",this._pushEventList),e.addEventListener("touchend",this._pushEventList,!0),e.addEventListener("touchmove",this._pushEventList,!0),e.addEventListener("touchcancel",this._pushEventList,!0)}},{key:"_offCanvasEvent",value:function(e){e.removeEventListener("mousedown",this._pushEventList),e.removeEventListener("mouseup",this._pushEventList,!0),e.removeEventListener("mousemove",this._pushEventList,!0),e.removeEventListener("touchstart",this._pushEventList),e.removeEventListener("touchend",this._pushEventList,!0),e.removeEventListener("touchmove",this._pushEventList,!0),e.removeEventListener("touchcancel",this._pushEventList,!0),this._eventList.length=0,this._touches.clear()}},{key:"touchCount",value:function(){return this._touches.length}},{key:"_getTouch",value:function(e){var t=this._touchPool[e];return t||(t=new Yt,this._touchPool[e]=t,t._identifier=e),t}},{key:"_mouseTouchDown",value:function(){var e=this._mouseTouch,n=e.sprite;if(e._pressedSprite=n,e._pressedLoopCount=t.Stat.loopCount,n){var r=n._scripts;if(r)for(var i=0,a=r.length;i<a;i++)r[i].onMouseDown()}}},{key:"_mouseTouchUp",value:function(){var e,t,n=this._mouseTouch,r=n._pressedSprite;n._pressedSprite=null,n._pressedLoopCount=-1;var i=n.sprite;if(i&&i===r){var a=i._scripts;if(a)for(e=0,t=a.length;e<t;e++)a[e].onMouseClick()}if(r){var o=r._scripts;if(o)for(e=0,t=o.length;e<t;e++)o[e].onMouseUp()}}},{key:"_mouseTouchRayCast",value:function(t){var n=e._tempHitResult0,r=e._tempVector20,i=e._tempRay0;n.succeeded=!1;var a=this._mouseTouch.mousePositionX,o=this._mouseTouch.mousePositionY;r.x=a,r.y=o;for(var s=t.length-1;s>=0;s--){var l=t[s],_=l.viewport;if(r.x>=_.x&&r.y>=_.y&&r.x<=_.width&&r.y<=_.height)if(l.viewportPointToRay(r,i),this._scene._physicsSimulation.rayCast(i,n)||l.clearFlag===ke.CLEARFLAG_SOLIDCOLOR||l.clearFlag===ke.CLEARFLAG_SKY)break}var u=this._mouseTouch,c=u.sprite;if(n.succeeded){var h=n.collider.owner;u.sprite=h;var d=h._scripts;if(c!==h&&d)for(var f=0,m=d.length;f<m;f++)d[f].onMouseEnter()}else u.sprite=null;if(c&&c!==h){var E=c._scripts;if(E)for(f=0,m=E.length;f<m;f++)E[f].onMouseOut()}}},{key:"_changeTouches",value:function(n,r){for(var i=0,a=0,o=this._touches.length,s=0,l=n.length;s<l;s++){var _=n[s],u=_.identifier;if(this._multiTouchEnabled||0===u){var c=this._getTouch(u),h=c._position,d=e._tempPoint;d.setTo(_.pageX,_.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(d);var f=d.x,m=d.y;switch(r){case 0:this._touches.add(c),i+=f,a+=m;break;case 1:this._touches.remove(c),i-=f,a-=m;break;case 2:i=f-h.x,a=m-h.y}h.x=f,h.y=m}}var E=this._touches.length;0===E?(this._mouseTouch.mousePositionX=0,this._mouseTouch.mousePositionY=0):(this._mouseTouch.mousePositionX=(this._mouseTouch.mousePositionX*o+i)/E,this._mouseTouch.mousePositionY=(this._mouseTouch.mousePositionY*o+a)/E)}},{key:"_update",value:function(){var n,r,i,a,o=I._enablePhysics&&!ln.disableSimulation;r=this._eventList.length;var s=this._scene._cameraPool;if(r>0){var l=!1;for(n=0;n<r;n++){var _=this._eventList[n];switch(_.type){case"mousedown":o&&this._mouseTouchDown();break;case"mouseup":o&&this._mouseTouchUp();break;case"mousemove":var u=e._tempPoint;u.setTo(_.pageX,_.pageY),t.ILaya.stage._canvasTransform.invertTransformPoint(u),this._mouseTouch.mousePositionX=u.x,this._mouseTouch.mousePositionY=u.y,o&&(l=!0);break;case"touchstart":var c=this._touches.length;this._changeTouches(_.changedTouches,0),o&&(l=!0,0===c&&this._mouseTouchDown());break;case"touchend":case"touchcancel":this._changeTouches(_.changedTouches,1),o&&0===this._touches.length&&this._mouseTouchUp();break;case"touchmove":this._changeTouches(_.changedTouches,2),o&&(l=!0);break;default:throw"Input3D:unkonwn event type."}}l&&this._mouseTouchRayCast(s),this._eventList.length=0}if(o){var h=this._mouseTouch,d=h._pressedSprite;if(d&&t.Stat.loopCount>h._pressedLoopCount){var f=d._scripts;if(f)for(i=0,a=f.length;i<a;i++)f[i].onMouseDrag()}var m=h.sprite;if(m){var E=m._scripts;if(E)for(i=0,a=E.length;i<a;i++)E[i].onMouseOver()}}}},{key:"getTouch",value:function(e){return e<this._touches.length?this._touches.elements[e]:null}},{key:"multiTouchEnabled",get:function(){return this._multiTouchEnabled},set:function(e){this._multiTouchEnabled=e}}]),e}();_n._tempPoint=new t.Point,_n._tempVector20=new r,_n._tempRay0=new Re(new a,new a),_n._tempHitResult0=new jt;var un=function e(){_classCallCheck(this,e),this.flags=0,this.maxSubSteps=1,this.fixedTimeStep=1/60},cn=function(){function e(t,n){_classCallCheck(this,e),this._position=t,this._textureCoordinate0=n}return _createClass(e,[{key:"position",get:function(){return this._position}},{key:"textureCoordinate0",get:function(){return this._textureCoordinate0}},{key:"vertexDeclaration",get:function(){return e._vertexDeclaration}}],[{key:"__init__",value:function(){e._vertexDeclaration=new Ee(20,[new ve(0,me.Vector3,Te.MESH_POSITION0),new ve(12,me.Vector2,Te.MESH_TEXTURECOORDINATE0)])}},{key:"vertexDeclaration",get:function(){return e._vertexDeclaration}}]),e}(),hn=function(n){function r(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:48,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:48;_classCallCheck(this,r);var a=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this)),o=t.LayaGL.instance;a._stacks=n,a._slices=i;for(var s=cn.vertexDeclaration,l=s.vertexStride/4,_=(a._stacks+1)*(a._slices+1),u=3*a._stacks*(a._slices+1)*2,c=new Float32Array(_*l),h=new Uint16Array(u),d=Math.PI/a._stacks,f=2*Math.PI/a._slices,m=0,E=0,v=0,T=0;T<a._stacks+1;T++)for(var p=Math.sin(T*d),g=Math.cos(T*d),y=0;y<a._slices+1;y++){var S=p*Math.sin(y*f),R=p*Math.cos(y*f);c[E+0]=S*r._radius,c[E+1]=g*r._radius,c[E+2]=R*r._radius,c[E+3]=-y/a._slices+.75,c[E+4]=T/a._stacks,E+=l,T!=a._stacks-1&&(h[v++]=m+1,h[v++]=m,h[v++]=m+(a._slices+1),h[v++]=m+(a._slices+1),h[v++]=m,h[v++]=m+a._slices,m++)}a._vertexBuffer=new fe(4*c.length,o.STATIC_DRAW,!1),a._vertexBuffer.vertexDeclaration=s,a._indexBuffer=new Ne(e.IndexFormat.UInt16,h.length,o.STATIC_DRAW,!1),a._vertexBuffer.setData(c.buffer),a._indexBuffer.setData(h);var C=new Oe;return C.bind(),C.applyVertexBuffer(a._vertexBuffer),C.applyIndexBuffer(a._indexBuffer),C.unBind(),a._bufferState=C,a}return _inherits(r,Pe),_createClass(r,[{key:"_render",value:function(e){var n=t.LayaGL.instance,r=this._indexBuffer.indexCount;n.drawElements(n.TRIANGLES,r,n.UNSIGNED_SHORT,0),t.Stat.trianglesFaces+=r/3,t.Stat.renderBatches++}},{key:"stacks",get:function(){return this._stacks}},{key:"slices",get:function(){return this._slices}}],[{key:"__init__",value:function(){r.instance=new r}}]),r}();hn._radius=1;var dn=function(){function e(){_classCallCheck(this,e),this._length=0,this._elements=[]}return _createClass(e,[{key:"add",value:function(e){this._length===this._elements.length?this._elements.push(e):this._elements[this._length]=e,this._length++}},{key:"remove",value:function(e){var t=this._elements.indexOf(e);if(this._length--,t!==this._length){var n=this._elements[this._length];this._elements[t]=n}}},{key:"shift",value:function(){return this._length--,this._elements.shift()}}]),e}(),fn=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,dn),_createClass(t,[{key:"getSunLight",value:function(){for(var e,t=-1,n=this._elements,r=0;r<this._length;r++){var i=n[r]._intensity;t<i&&(t=i,e=r)}return e}}]),t}(),mn=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,dn),_createClass(t,[{key:"remove",value:function(e){var t=this._elements.indexOf(e);this._elements.splice(t,1),this._length--}}]),t}(),En=function(e){function n(e,r){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));i._floatCountPerVertices=7,i._minUpdate=Number.MAX_VALUE,i._maxUpdate=Number.MIN_VALUE,i._bufferState=new Oe,i._floatBound=new Float32Array(6),i._calculateBound=!1,i._maxLineCount=0,i._lineCount=0;var a=2*r;i._owner=e,i._maxLineCount=r,i._vertices=new Float32Array(a*i._floatCountPerVertices),i._vertexBuffer=new fe(Ht.vertexDeclaration.vertexStride*a,t.LayaGL.instance.STATIC_DRAW,!1),i._vertexBuffer.vertexDeclaration=Ht.vertexDeclaration,i._bufferState.bind(),i._bufferState.applyVertexBuffer(i._vertexBuffer),i._bufferState.unBind();var o=n._tempVector0,s=n._tempVector1;return o.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i._bounds=new $e(o,s),i}return _inherits(n,de),_createClass(n,[{key:"_getType",value:function(){return n._type}},{key:"_resizeLineData",value:function(e){var n=2*e,r=this._vertices;this._vertexBuffer.destroy(),this._maxLineCount=e;var i=n*this._floatCountPerVertices;this._vertices=new Float32Array(i),this._vertexBuffer=new fe(Ht.vertexDeclaration.vertexStride*n,t.LayaGL.instance.STATIC_DRAW,!1),this._vertexBuffer.vertexDeclaration=Ht.vertexDeclaration,i<r.length?(this._vertices.set(new Float32Array(r.buffer,0,i)),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*i)):(this._vertices.set(r),this._vertexBuffer.setData(this._vertices.buffer,0,0,4*r.length)),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind()}},{key:"_updateLineVertices",value:function(e,t,n,r,i){t&&(this._vertices[e+0]=t.x,this._vertices[e+1]=t.y,this._vertices[e+2]=t.z),r&&(this._vertices[e+3]=r.r,this._vertices[e+4]=r.g,this._vertices[e+5]=r.b,this._vertices[e+6]=r.a),n&&(this._vertices[e+7]=n.x,this._vertices[e+8]=n.y,this._vertices[e+9]=n.z),i&&(this._vertices[e+10]=i.r,this._vertices[e+11]=i.g,this._vertices[e+12]=i.b,this._vertices[e+13]=i.a),this._minUpdate=Math.min(this._minUpdate,e),this._maxUpdate=Math.max(this._maxUpdate,e+2*this._floatCountPerVertices);var o=this._bounds,s=this._floatBound,l=o.getMin(),_=o.getMax();a.min(l,t,l),a.min(l,n,l),a.max(_,t,_),a.max(_,n,_),o.setMin(l),o.setMax(_),s[0]=l.x,s[1]=l.y,s[2]=l.z,s[3]=_.x,s[4]=_.y,s[5]=_.z}},{key:"_reCalculateBound",value:function(){if(this._calculateBound){var e=this._vertices,t=n._tempVector0,r=n._tempVector1;t.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<2*this._lineCount;++i){var a=this._floatCountPerVertices*i,o=e[a+0],s=e[a+1],l=e[a+2];t.x=Math.min(o,t.x),t.y=Math.min(s,t.y),t.z=Math.min(l,t.z),r.x=Math.max(o,r.x),r.y=Math.max(s,r.y),r.z=Math.max(l,r.z)}this._bounds.setMin(t),this._bounds.setMax(r);var _=this._floatBound;_[0]=t.x,_[1]=t.y,_[2]=t.z,_[3]=r.x,_[4]=r.y,_[5]=r.z,this._calculateBound=!1}}},{key:"_removeLineData",value:function(e){var t=2*this._floatCountPerVertices,n=e+1,r=e*t,i=this._vertices,a=new Float32Array(i.buffer,n*t*4,(this._lineCount-n)*t);i.set(a,r),this._minUpdate=Math.min(this._minUpdate,r),this._maxUpdate=Math.max(this._maxUpdate,r+a.length),this._lineCount--;var o=this._floatBound,s=i[r],l=i[r+1],_=i[r+2],u=i[r+7],c=i[r+8],h=i[r+9],d=o[0],f=o[1],m=o[2],E=o[3],v=o[4],T=o[5];s!==d&&s!==E&&l!==f&&l!==v&&_!==m&&_!==T&&u!==d&&u!==E&&c!==f&&c!==v&&h!==m&&h!==T||(this._calculateBound=!0)}},{key:"_updateLineData",value:function(e,t,n,r,i){var a=2*this._floatCountPerVertices;this._updateLineVertices(e*a,t,n,r,i)}},{key:"_updateLineDatas",value:function(e,t){for(var n=2*this._floatCountPerVertices,r=t.length,i=0;i<r;i++){var a=t[i];this._updateLineVertices((e+i)*n,a.startPosition,a.endPosition,a.startColor,a.endColor)}}},{key:"_getLineData",value:function(e,t){var n=t.startPosition,r=t.startColor,i=t.endPosition,a=t.endColor,o=this._vertices,s=e*this._floatCountPerVertices*2;n.x=o[s+0],n.y=o[s+1],n.z=o[s+2],r.r=o[s+3],r.g=o[s+4],r.b=o[s+5],r.a=o[s+6],i.x=o[s+7],i.y=o[s+8],i.z=o[s+9],a.r=o[s+10],a.g=o[s+11],a.b=o[s+12],a.a=o[s+13]}},{key:"_prepareRender",value:function(e){return!0}},{key:"_render",value:function(e){if(this._minUpdate!==Number.MAX_VALUE&&this._maxUpdate!==Number.MIN_VALUE&&(this._vertexBuffer.setData(this._vertices.buffer,4*this._minUpdate,4*this._minUpdate,4*(this._maxUpdate-this._minUpdate)),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE),this._lineCount>0){this._bufferState.bind();var n=t.LayaGL.instance;n.drawArrays(n.LINES,0,2*this._lineCount),t.Stat.renderBatches++}}},{key:"destroy",value:function(){this._destroyed||(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferState=null,this._vertexBuffer=null,this._vertices=null)}}]),n}();En._tempVector0=new a,En._tempVector1=new a,En._type=de._typeCounter++;var vn=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t._projectionViewWorldMatrix=new T,t}return _inherits(n,et),_createClass(n,[{key:"_calculateBoundingBox",value:function(){var e=this._owner.transform.worldMatrix,n=this._owner._geometryFilter;if(n._reCalculateBound(),n._bounds._tranform(e,this._bounds),t.Render.supportWebGLPlusCulling){var r=this._bounds.getMin(),i=this._bounds.getMax(),a=ce._cullingBuffer;a[this._cullingBufferIndex+1]=r.x,a[this._cullingBufferIndex+2]=r.y,a[this._cullingBufferIndex+3]=r.z,a[this._cullingBufferIndex+4]=i.x,a[this._cullingBufferIndex+5]=i.y,a[this._cullingBufferIndex+6]=i.z}}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix,r=this._shaderValues;if(t){var i=t.worldMatrix;r.setMatrix4x4(le.WORLDMATRIX,i),T.multiply(n,i,this._projectionViewWorldMatrix),r.setMatrix4x4(le.MVPMATRIX,this._projectionViewWorldMatrix)}else r.setMatrix4x4(le.WORLDMATRIX,T.DEFAULT),r.setMatrix4x4(le.MVPMATRIX,n)}}]),n}(),Tn=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n));return r._geometryFilter=new En(r,e),r._render=new vn(r),r._changeRenderObjects(r._render,0,zt.defaultMaterial),r}return _inherits(t,_e),_createClass(t,[{key:"maxLineCount",get:function(){return this._geometryFilter._maxLineCount},set:function(e){this._geometryFilter._resizeLineData(e),this._geometryFilter._lineCount=Math.min(this._geometryFilter._lineCount,e)}},{key:"lineCount",get:function(){return this._geometryFilter._lineCount},set:function(e){if(e>this.maxLineCount)throw"PixelLineSprite3D: lineCount can't large than maxLineCount";this._geometryFilter._lineCount=e}},{key:"pixelLineRenderer",get:function(){return this._render}}]),_createClass(t,[{key:"_changeRenderObjects",value:function(e,t,n){var r=this._render._renderElements;n||(n=zt.defaultMaterial);var i=r[t];i||(i=r[t]=new Ye),i.setTransform(this._transform),i.setGeometry(this._geometryFilter),i.render=this._render,i.material=n}},{key:"addLine",value:function(e,t,n,r){if(this._geometryFilter._lineCount===this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount has equal with maxLineCount.";this._geometryFilter._updateLineData(this._geometryFilter._lineCount++,e,t,n,r)}},{key:"addLines",value:function(e){var t=this._geometryFilter._lineCount,n=e.length;if(t+n>this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount plus lines count must less than maxLineCount.";this._geometryFilter._updateLineDatas(t,e),this._geometryFilter._lineCount+=n}},{key:"removeLine",value:function(e){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._removeLineData(e)}},{key:"setLine",value:function(e,t,n,r,i){if(!(e<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._updateLineData(e,t,n,r,i)}},{key:"getLine",value:function(e,t){if(!(e<this.lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._getLineData(e,t)}},{key:"clear",value:function(){this._geometryFilter._lineCount=0}},{key:"_create",value:function(){return new t}}]),t}(),pn=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];_classCallCheck(this,e),this.isTransparent=!1,this.elements=new qe,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1,this.isTransparent=t}return _createClass(e,[{key:"_compare",value:function(e,t){var n=e.material.renderQueue-t.material.renderQueue;return 0===n?(this.isTransparent?t.render._distanceForSort-e.render._distanceForSort:e.render._distanceForSort-t.render._distanceForSort)+t.render.sortingFudge-e.render.sortingFudge:n}},{key:"_partitionRenderObject",value:function(e,t){for(var n=this.elements.elements,r=n[Math.floor((t+e)/2)];e<=t;){for(;this._compare(n[e],r)<0;)e++;for(;this._compare(n[t],r)>0;)t--;if(e<t){var i=n[e];n[e]=n[t],n[t]=i,e++,t--}else if(e===t){e++;break}}return e}},{key:"_quickSort",value:function(e,t){if(this.elements.length>1){var n=this._partitionRenderObject(e,t),r=n-1;e<r&&this._quickSort(e,r),n<t&&this._quickSort(n,t)}}},{key:"_render",value:function(e){for(var t=this.elements.elements,n=0,r=this.elements.length;n<r;n++)t[n]._render(e)}},{key:"clear",value:function(){this.elements.length=0,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1}}]),e}(),gn=function(){function e(t,n,r,i){_classCallCheck(this,e),this._bounds=new Je(new a,new a),this._objects=[],this._isContaion=!1,this.center=new a,this.baseLength=0,this._setValues(t,n,r,i)}return _createClass(e,[{key:"_setValues",value:function(e,t,n,r){this._octree=e,this._parent=t,this.baseLength=n,r.cloneTo(this.center);var i=this._bounds.min,a=this._bounds.max,o=e._looseness*n/2;i.setValue(r.x-o,r.y-o,r.z-o),a.setValue(r.x+o,r.y+o,r.z+o)}},{key:"_getChildBound",value:function(t){if(null!=this._children&&this._children[t])return this._children[t]._bounds;var n=this.baseLength/4,r=this.baseLength/2*this._octree._looseness/2,i=e._tempBoundBox,a=i.min,o=i.max;switch(t){case 0:a.x=this.center.x-n-r,a.y=this.center.y+n-r,a.z=this.center.z-n-r,o.x=this.center.x-n+r,o.y=this.center.y+n+r,o.z=this.center.z-n+r;break;case 1:a.x=this.center.x+n-r,a.y=this.center.y+n-r,a.z=this.center.z-n-r,o.x=this.center.x+n+r,o.y=this.center.y+n+r,o.z=this.center.z-n+r;break;case 2:a.x=this.center.x-n-r,a.y=this.center.y+n-r,a.z=this.center.z+n-r,o.x=this.center.x-n+r,o.y=this.center.y+n+r,o.z=this.center.z+n+r;break;case 3:a.x=this.center.x+n-r,a.y=this.center.y+n-r,a.z=this.center.z+n-r,o.x=this.center.x+n+r,o.y=this.center.y+n+r,o.z=this.center.z+n+r;break;case 4:a.x=this.center.x-n-r,a.y=this.center.y-n-r,a.z=this.center.z-n-r,o.x=this.center.x-n+r,o.y=this.center.y-n+r,o.z=this.center.z-n+r;break;case 5:a.x=this.center.x+n-r,a.y=this.center.y-n-r,a.z=this.center.z-n-r,o.x=this.center.x+n+r,o.y=this.center.y-n+r,o.z=this.center.z-n+r;break;case 6:a.x=this.center.x-n-r,a.y=this.center.y-n-r,a.z=this.center.z+n-r,o.x=this.center.x-n+r,o.y=this.center.y-n+r,o.z=this.center.z+n+r;break;case 7:a.x=this.center.x+n-r,a.y=this.center.y-n-r,a.z=this.center.z+n-r,o.x=this.center.x+n+r,o.y=this.center.y-n+r,o.z=this.center.z+n+r}return i}},{key:"_getChildCenter",value:function(t){if(null!=this._children)return this._children[t].center;var n=this.baseLength/4,r=e._tempVector30;switch(t){case 0:r.x=this.center.x-n,r.y=this.center.y+n,r.z=this.center.z-n;break;case 1:r.x=this.center.x+n,r.y=this.center.y+n,r.z=this.center.z-n;break;case 2:r.x=this.center.x-n,r.y=this.center.y+n,r.z=this.center.z+n;break;case 3:r.x=this.center.x+n,r.y=this.center.y+n,r.z=this.center.z+n;break;case 4:r.x=this.center.x-n,r.y=this.center.y-n,r.z=this.center.z-n;break;case 5:r.x=this.center.x+n,r.y=this.center.y-n,r.z=this.center.z-n;break;case 6:r.x=this.center.x-n,r.y=this.center.y-n,r.z=this.center.z+n;break;case 7:r.x=this.center.x+n,r.y=this.center.y-n,r.z=this.center.z+n}return r}},{key:"_getChild",value:function(t){var n=this.baseLength/4;switch(this._children||(this._children=[]),t){case 0:return this._children[0]||(this._children[0]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+-n,this.center.y+n,this.center.z-n)));case 1:return this._children[1]||(this._children[1]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+n,this.center.y+n,this.center.z-n)));case 2:return this._children[2]||(this._children[2]=new e(this._octree,this,this.baseLength/2,new a(this.center.x-n,this.center.y+n,this.center.z+n)));case 3:return this._children[3]||(this._children[3]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+n,this.center.y+n,this.center.z+n)));case 4:return this._children[4]||(this._children[4]=new e(this._octree,this,this.baseLength/2,new a(this.center.x-n,this.center.y-n,this.center.z-n)));case 5:return this._children[5]||(this._children[5]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+n,this.center.y-n,this.center.z-n)));case 6:return this._children[6]||(this._children[6]=new e(this._octree,this,this.baseLength/2,new a(this.center.x-n,this.center.y-n,this.center.z+n)));case 7:return this._children[7]||(this._children[7]=new e(this._octree,this,this.baseLength/2,new a(this.center.x+n,this.center.y-n,this.center.z+n)));default:throw"BoundsOctreeNode: unknown index."}}},{key:"_shouldMerge",value:function(){for(var t=this._objects.length,n=0;n<8;n++){var r=this._children[n];if(r){if(null!=r._children)return!1;t+=r._objects.length}}return t<=e._NUM_OBJECTS_ALLOWED}},{key:"_mergeChildren",value:function(){for(var e=0;e<8;e++){var t=this._children[e];if(t){t._parent=null;for(var n=t._objects,r=n.length-1;r>=0;r--){var i=n[r];this._objects.push(i),i._setOctreeNode(this)}}}this._children=null}},{key:"_merge",value:function(){if(null===this._children){var e=this._parent;e&&e._shouldMerge()&&(e._mergeChildren(),e._merge())}}},{key:"_checkAddNode",value:function(t){if(null==this._children){if(this._objects.length<e._NUM_OBJECTS_ALLOWED||this.baseLength/2<this._octree._minSize)return this;for(var n=this._objects.length-1;n>=0;n--){var r=this._objects[n],i=this._bestFitChild(r.bounds.getCenter());e._encapsulates(this._getChildBound(i),r.bounds._getBoundBox())&&(this._objects.splice(this._objects.indexOf(r),1),this._getChild(i)._add(r))}}var a=this._bestFitChild(t.bounds.getCenter());return e._encapsulates(this._getChildBound(a),t.bounds._getBoundBox())?this._getChild(a)._checkAddNode(t):this}},{key:"_add",value:function(e){var t=this._checkAddNode(e);t._objects.push(e),e._setOctreeNode(t)}},{key:"_remove",value:function(e){var t=this._objects.indexOf(e);this._objects.splice(t,1),e._setOctreeNode(null),this._merge()}},{key:"_addUp",value:function(e){return Ie.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Ce.Contains?(this._add(e),!0):!!this._parent&&this._parent._addUp(e)}},{key:"_getCollidingWithFrustum",value:function(e,n,r,i,o,s,l){if(r){var _=n.containsBoundBox(this._bounds);if(t.Stat.octreeNodeCulling++,_===Ce.Disjoint)return;r=_===Ce.Intersects}this._isContaion=!r;for(var u=e.camera,c=e.scene,h=0,d=this._objects.length;h<d;h++){var f=this._objects[h];if(l?f._castShadow&&f._enable:u._isLayerVisible(f._owner._layer)&&f._enable){if(r&&(t.Stat.frustumCulling++,!f._needRender(n,e)))continue;f._distanceForSort=a.distance(f.bounds.getCenter(),i);for(var m=f._renderElements,E=0,v=m.length;E<v;E++){m[E]._update(c,e,o,s)}}}if(null!=this._children)for(h=0;h<8;h++){var T=this._children[h];T&&T._getCollidingWithFrustum(e,n,r,i,o,s,l)}}},{key:"_getCollidingWithBoundBox",value:function(e,t,n){if(t){var r=Ie.boxContainsBox(this._bounds,e);if(r===Ce.Disjoint)return;t=r===Ce.Intersects}if(t)for(var i=0,a=this._objects.length;i<a;i++){var o=this._objects[i];Ie.intersectsBoxAndBox(o.bounds._getBoundBox(),e)&&n.push(o)}if(null!=this._children)for(i=0;i<8;i++){this._children[i]._getCollidingWithBoundBox(e,t,n)}}},{key:"_bestFitChild",value:function(e){return(e.x<=this.center.x?0:1)+(e.y>=this.center.y?0:4)+(e.z<=this.center.z?0:2)}},{key:"_update",value:function(e){if(Ie.boxContainsBox(this._bounds,e.bounds._getBoundBox())===Ce.Contains){var t=this._checkAddNode(e);if(t!==e._getOctreeNode()){t._objects.push(e),e._setOctreeNode(t);var n=this._objects.indexOf(e);this._objects.splice(n,1),this._merge()}return!0}if(this._parent){var r=this._parent._addUp(e);return r&&(n=this._objects.indexOf(e),this._objects.splice(n,1),this._merge()),r}return!1}},{key:"add",value:function(t){return!!e._encapsulates(this._bounds,t.bounds._getBoundBox())&&(this._add(t),!0)}},{key:"remove",value:function(e){return e._getOctreeNode()===this&&(this._remove(e),!0)}},{key:"update",value:function(e){return e._getOctreeNode()===this&&this._update(e)}},{key:"shrinkIfPossible",value:function(t){if(this.baseLength<2*t)return this;for(var n=-1,r=0,i=this._objects.length;r<i;r++){var a=this._objects[r],o=this._bestFitChild(a.bounds.getCenter());if(0!=r&&o!=n)return this;var s=this._getChildBound(o);if(!e._encapsulates(s,a.bounds._getBoundBox()))return this;0==r&&(n=o)}if(null==this._children){if(-1!=n){var l=this._getChildCenter(n);this._setValues(this._octree,null,this.baseLength/2,l)}return this}var _=!1;for(r=0,i=this._children.length;r<i;r++){var u=this._children[r];if(u&&u.hasAnyObjects()){if(_)return this;if(n>=0&&n!=r)return this;_=!0,n=r}}if(-1!=n){var c=this._children[n];return c._parent=null,c}return this}},{key:"hasAnyObjects",value:function(){if(this._objects.length>0)return!0;if(null!=this._children)for(var e=0;e<8;e++){var t=this._children[e];if(t&&t.hasAnyObjects())return!0}return!1}},{key:"getCollidingWithBoundBox",value:function(e,t){this._getCollidingWithBoundBox(e,!0,t)}},{key:"getCollidingWithRay",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE,r=Ie.intersectsRayAndBoxRD(e,this._bounds);if(!(-1==r||r>n)){for(var i=0,a=this._objects.length;i<a;i++){var o=this._objects[i];-1!==(r=Ie.intersectsRayAndBoxRD(e,o.bounds._getBoundBox()))&&r<=n&&t.push(o)}if(null!=this._children)for(i=0;i<8;i++){this._children[i].getCollidingWithRay(e,t,n)}}}},{key:"getCollidingWithFrustum",value:function(e,t,n,r){var i=e.camera.transform.position,a=e.camera.boundFrustum;this._getCollidingWithFrustum(e,a,!0,i,t,n,r)}},{key:"isCollidingWithBoundBox",value:function(e){if(!Ie.intersectsBoxAndBox(this._bounds,e))return!1;for(var t=0,n=this._objects.length;t<n;t++){var r=this._objects[t];if(Ie.intersectsBoxAndBox(r.bounds._getBoundBox(),e))return!0}if(null!=this._children)for(t=0;t<8;t++){if(this._children[t].isCollidingWithBoundBox(e))return!0}return!1}},{key:"isCollidingWithRay",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE,n=Ie.intersectsRayAndBoxRD(e,this._bounds);if(-1==n||n>t)return!1;for(var r=0,i=this._objects.length;r<i;r++){var a=this._objects[r];if(-1!==(n=Ie.intersectsRayAndBoxRD(e,a.bounds._getBoundBox()))&&n<=t)return!0}if(null!=this._children)for(r=0;r<8;r++){if(this._children[r].isCollidingWithRay(e,t))return!0}return!1}},{key:"getBound",value:function(){return this._bounds}},{key:"drawAllBounds",value:function(t,n,r){if(null!==this._children||0!=this._objects.length){n++;var i=e._tempColor0;if(this._isContaion)i.r=0,i.g=0,i.b=1;else{var a=r?n/r:0;i.r=1-a,i.g=a,i.b=0}if(i.a=.3,A._drawBound(t,this._bounds,i),null!=this._children)for(var o=0;o<8;o++){var s=this._children[o];s&&s.drawAllBounds(t,n,r)}}}},{key:"drawAllObjects",value:function(t,n,r){n++;var i=e._tempColor0;if(this._isContaion)i.r=0,i.g=0,i.b=1;else{var a=r?n/r:0;i.r=1-a,i.g=a,i.b=0}i.a=1;for(var o=0,s=this._objects.length;o<s;o++)A._drawBound(t,this._objects[o].bounds._getBoundBox(),i);if(null!=this._children)for(o=0;o<8;o++){var l=this._children[o];l&&l.drawAllObjects(t,n,r)}}}],[{key:"_encapsulates",value:function(e,t){return Ie.boxContainsBox(e,t)==Ce.Contains}}]),e}();gn._tempVector3=new a,gn._tempVector30=new a,gn._tempVector31=new a,gn._tempColor0=new ae,gn._tempBoundBox=new Je(new a,new a),gn._NUM_OBJECTS_ALLOWED=8;var yn=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,qe),_createClass(t,[{key:"add",value:function(e){if(-1!==e._getIndexInMotionList())throw"OctreeMotionList:element has  in  PhysicsUpdateList.";this._add(e),e._setIndexInMotionList(this.length++)}},{key:"remove",value:function(e){var t=e._getIndexInMotionList();if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._setIndexInMotionList(t)}e._setIndexInMotionList(-1)}}]),t}(),Sn=function(){function e(t,n,r,i){_classCallCheck(this,e),this._motionObjects=new yn,this.count=0,r>t&&(console.warn("Minimum node size must be at least as big as the initial world size. Was: "+r+" Adjusted to: "+t),r=t),this._initialSize=t,this._minSize=r,this._looseness=Math.min(Math.max(i,1),2),this._rootNode=new gn(this,null,t,n)}return _createClass(e,[{key:"_getMaxDepth",value:function(e,t){t++;var n=e._children;if(null!=n)for(var r=t,i=0,a=n.length;i<a;i++){var o=n[i];o&&(t=Math.max(this._getMaxDepth(o,r),t))}return t}},{key:"_grow",value:function(e){var t=e.x>=0?1:-1,n=e.y>=0?1:-1,r=e.z>=0?1:-1,i=this._rootNode,o=this._rootNode.baseLength/2,s=2*this._rootNode.baseLength,l=this._rootNode.center,_=new a(l.x+t*o,l.y+n*o,l.z+r*o);if(this._rootNode=new gn(this,null,s,_),i.hasAnyObjects()){for(var u=this._rootNode._bestFitChild(i.center),c=[],h=0;h<8;h++)h==u&&(i._parent=this._rootNode,c[h]=i);this._rootNode._children=c}}},{key:"add",value:function(t){for(var n=0;!this._rootNode.add(t);){var r=e._tempVector30;if(a.subtract(t.bounds.getCenter(),this._rootNode.center,r),this._grow(r),++n>20)throw"Aborted Add operation as it seemed to be going on forever ("+(n-1)+") attempts at growing the octree."}this.count++}},{key:"remove",value:function(e){var t=e._getOctreeNode().remove(e);return t&&this.count--,t}},{key:"update",value:function(t){var n=0,r=t._getOctreeNode();if(r){for(;!r._update(t);){var i=e._tempVector30;if(a.subtract(t.bounds.getCenter(),this._rootNode.center,i),this._grow(i),++n>20)throw"Aborted Add operation as it seemed to be going on forever ("+(n-1)+") attempts at growing the octree."}return!0}return!1}},{key:"shrinkRootIfPossible",value:function(){this._rootNode=this._rootNode.shrinkIfPossible(this._initialSize)}},{key:"addMotionObject",value:function(e){this._motionObjects.add(e)}},{key:"removeMotionObject",value:function(e){this._motionObjects.remove(e)}},{key:"updateMotionObjects",value:function(){for(var e=this._motionObjects.elements,t=0,n=this._motionObjects.length;t<n;t++){var r=e[t];this.update(r),r._setIndexInMotionList(-1)}this._motionObjects.length=0}},{key:"isCollidingWithBoundBox",value:function(e){return this._rootNode.isCollidingWithBoundBox(e)}},{key:"isCollidingWithRay",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE;return this._rootNode.isCollidingWithRay(e,t)}},{key:"getCollidingWithBoundBox",value:function(e,t){this._rootNode.getCollidingWithBoundBox(e,t)}},{key:"getCollidingWithRay",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;this._rootNode.getCollidingWithRay(e,t,n)}},{key:"getCollidingWithFrustum",value:function(e,t,n,r){this._rootNode.getCollidingWithFrustum(e,t,n,r)}},{key:"getMaxBounds",value:function(){return this._rootNode.getBound()}},{key:"drawAllBounds",value:function(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllBounds(e,-1,t)}},{key:"drawAllObjects",value:function(e){var t=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllObjects(e,-1,t)}}]),e}();Sn._tempVector30=new a;var Rn=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));if(e._lightCount=0,e._pointLights=new dn,e._spotLights=new dn,e._directionLights=new fn,e._alternateLights=new mn,e._lightmaps=[],e._skyRenderer=new Ve,e._reflectionMode=1,e._input=new _n,e._timer=t.ILaya.timer,e._collsionTestList=[],e._renders=new Wt,e._opaqueQueue=new pn(!1),e._transparentQueue=new pn(!0),e._cameraPool=[],e._animatorPool=new Wt,e._scriptPool=new Array,e._tempScriptPool=new Array,e._needClearScriptPool=!1,e.currentCreationLayer=Math.pow(2,0),e.enableLight=!0,e._key=new t.SubmitKey,e._time=0,e._pickIdToSprite=new Object,I._enablePhysics&&(e._physicsSimulation=new ln(n.physicsSettings)),e._shaderValues=new G(null),e.parallelSplitShadowMaps=[],e.enableFog=!1,e.fogStart=300,e.fogRange=1e3,e.fogColor=new a(.7,.7,.7),e.ambientColor=new a(.212,.227,.259),e.reflectionIntensity=1,o._config._multiLighting||e._shaderValues.addDefine(U.SHADERDEFINE_LEGACYSINGALLIGHTING),t.Render.supportWebGLPlusCulling&&(e._cullingBufferIndices=new Int32Array(1024),e._cullingBufferResult=new Int32Array(1024)),e._scene=e,e._input.__init__(t.Render.canvas,e),n.octreeCulling&&(e._octree=new Sn(n.octreeInitialSize,n.octreeInitialCenter,n.octreeMinNodeSize,n.octreeLooseness)),ce.debugFrustumCulling){e._debugTool=new Tn;var r=new zt;r.renderQueue=Y.RENDERQUEUE_TRANSPARENT,r.alphaTest=!1,r.depthWrite=!1,r.cull=q.CULL_BACK,r.blend=q.BLEND_ENABLE_ALL,r.blendSrc=q.BLENDPARAM_SRC_ALPHA,r.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,r.depthTest=q.DEPTHTEST_LESS,e._debugTool.pixelLineRenderer.sharedMaterial=r}return e}return _inherits(n,t.Sprite),_createClass(n,[{key:"_allotPickColorByID",value:function(e,t){var n=Math.floor(e/65025);e-=255*n*255;var r=Math.floor(e/255),i=e-=255*r;t.x=n/255,t.y=r/255,t.z=i/255,t.w=1}},{key:"_searchIDByPickColor",value:function(e){return 255*e.x*255+255*e.y+e.z}},{key:"_setLightmapToChildNode",value:function(e){e instanceof _e&&e._render._applyLightMapParams();for(var t=e._children,n=0,r=t.length;n<r;n++)this._setLightmapToChildNode(t[n])}},{key:"_update",value:function(){var e=this.timer._delta/1e3;this._time+=e,this._shaderValues.setNumber(n.TIME,this._time);var t=this._physicsSimulation;I._enablePhysics&&!ln.disableSimulation&&(t._updatePhysicsTransformFromRender(),sn._addUpdateList=!1,t._simulate(e),t._updateCharacters(),sn._addUpdateList=!0,t._updateCollisions(),t._eventScripts()),this._input._update(),this._clearScript(),this._updateScript(),N._update(this),this._lateUpdateScript()}},{key:"_binarySearchIndexInCameraPool",value:function(e){for(var t,n=0,r=this._cameraPool.length-1;n<=r;){t=Math.floor((n+r)/2);var i=this._cameraPool[t]._renderingOrder;if(i==e._renderingOrder)return t;i>e._renderingOrder?r=t-1:n=t+1}return n}},{key:"onEnable",value:function(){this._input._onCanvasEvent(t.Render.canvas)}},{key:"onDisable",value:function(){this._input._offCanvasEvent(t.Render.canvas)}},{key:"_setCreateURL",value:function(e){this._url=t.URL.formatURL(e)}},{key:"_getGroup",value:function(){return this._group}},{key:"_setGroup",value:function(e){this._group=e}},{key:"_clearScript",value:function(){if(this._needClearScriptPool){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var r=e[t];r&&(r._indexInPool=this._tempScriptPool.length,this._tempScriptPool.push(r))}this._scriptPool=this._tempScriptPool,e.length=0,this._tempScriptPool=e,this._needClearScriptPool=!1}}},{key:"_updateScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var r=e[t];r&&r.enabled&&r.onUpdate()}}},{key:"_lateUpdateScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var r=e[t];r&&r.enabled&&r.onLateUpdate()}}},{key:"_addScript",value:function(e){var t=this._scriptPool;e._indexInPool=t.length,t.push(e)}},{key:"_removeScript",value:function(e){this._scriptPool[e._indexInPool]=null,e._indexInPool=-1,this._needClearScriptPool=!0}},{key:"_preRenderScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var r=e[t];r&&r.enabled&&r.onPreRender()}}},{key:"_postRenderScript",value:function(){for(var e=this._scriptPool,t=0,n=e.length;t<n;t++){var r=e[t];r&&r.enabled&&r.onPostRender()}}},{key:"_prepareSceneToRender",value:function(){var e=this._shaderValues;if(o._config._multiLighting){var t=n._lightTexture,r=n._lightPixles,i=t.width,s=4*i,l=0,_=this._directionLights._length,u=this._directionLights._elements;if(_>0){for(var c=this._directionLights.getSunLight(),h=0;h<_;h++,l++){var d=(S=u[h])._direction,f=S._intensityColor,m=s*l;a.scale(S.color,S._intensity,f),S.transform.worldMatrix.getForward(d),a.normalize(d,d),r[m]=f.x,r[m+1]=f.y,r[m+2]=f.z,r[m+4]=d.x,r[m+5]=d.y,r[m+6]=d.z,h==c&&(e.setVector3(n.SUNLIGHTDIRCOLOR,f),e.setVector3(n.SUNLIGHTDIRECTION,d))}e.addDefine(Z.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(Z.SHADERDEFINE_DIRECTIONLIGHT);var E=this._pointLights._length;if(E>0){var v=this._pointLights._elements;for(h=0;h<E;h++,l++){var T=(R=v[h]).transform.position;f=R._intensityColor,m=s*l;a.scale(R.color,R._intensity,f),r[m]=f.x,r[m+1]=f.y,r[m+2]=f.z,r[m+3]=R.range,r[m+4]=T.x,r[m+5]=T.y,r[m+6]=T.z}e.addDefine(Z.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(Z.SHADERDEFINE_POINTLIGHT);var p=this._spotLights._length;if(p>0){var g=this._spotLights._elements;for(h=0;h<p;h++,l++){var y=g[h];d=y._direction,T=y.transform.position,f=y._intensityColor,m=s*l;a.scale(y.color,y._intensity,f),y.transform.worldMatrix.getForward(d),a.normalize(d,d),r[m]=f.x,r[m+1]=f.y,r[m+2]=f.z,r[m+3]=y.range,r[m+4]=T.x,r[m+5]=T.y,r[m+6]=T.z,r[m+7]=y.spotAngle*Math.PI/180,r[m+8]=d.x,r[m+9]=d.y,r[m+10]=d.z}e.addDefine(Z.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(Z.SHADERDEFINE_SPOTLIGHT);l>0&&t.setSubPixels(0,0,i,l,r,0),e.setTexture(n.LIGHTBUFFER,t),e.setInt(n.DIRECTIONLIGHTCOUNT,this._directionLights._length),e.setTexture(n.CLUSTERBUFFER,ye.instance._clusterTexture)}else{if(this._directionLights._length>0){var S=this._directionLights._elements[0];a.scale(S.color,S._intensity,S._intensityColor),S.transform.worldMatrix.getForward(S._direction),a.normalize(S._direction,S._direction),e.setVector3(n.LIGHTDIRCOLOR,S._intensityColor),e.setVector3(n.LIGHTDIRECTION,S._direction),e.setVector3(n.SUNLIGHTDIRCOLOR,S._intensityColor),e.setVector3(n.SUNLIGHTDIRECTION,S._direction),e.addDefine(Z.SHADERDEFINE_DIRECTIONLIGHT)}else e.removeDefine(Z.SHADERDEFINE_DIRECTIONLIGHT);if(this._pointLights._length>0){var R=this._pointLights._elements[0];a.scale(R.color,R._intensity,R._intensityColor),e.setVector3(n.POINTLIGHTCOLOR,R._intensityColor),e.setVector3(n.POINTLIGHTPOS,R.transform.position),e.setNumber(n.POINTLIGHTRANGE,R.range),e.addDefine(Z.SHADERDEFINE_POINTLIGHT)}else e.removeDefine(Z.SHADERDEFINE_POINTLIGHT);if(this._spotLights._length>0){var C=this._spotLights._elements[0];a.scale(C.color,C._intensity,C._intensityColor),e.setVector3(n.SPOTLIGHTCOLOR,C._intensityColor),e.setVector3(n.SPOTLIGHTPOS,C.transform.position),C.transform.worldMatrix.getForward(C._direction),a.normalize(C._direction,C._direction),e.setVector3(n.SPOTLIGHTDIRECTION,C._direction),e.setNumber(n.SPOTLIGHTRANGE,C.range),e.setNumber(n.SPOTLIGHTSPOTANGLE,C.spotAngle*Math.PI/180),e.addDefine(Z.SHADERDEFINE_SPOTLIGHT)}else e.removeDefine(Z.SHADERDEFINE_SPOTLIGHT)}}},{key:"_addCamera",value:function(e){for(var t=this._binarySearchIndexInCameraPool(e),n=e._renderingOrder,r=this._cameraPool.length;t<r&&this._cameraPool[t]._renderingOrder<=n;)t++;this._cameraPool.splice(t,0,e)}},{key:"_removeCamera",value:function(e){this._cameraPool.splice(this._cameraPool.indexOf(e),1)}},{key:"_preCulling",value:function(e,t,n,r){ce.renderObjectCulling(t,this,e,n,r,!1)}},{key:"_clear",value:function(e,n){var r,i,a,o=n.viewport,s=n.camera,l=s._getRenderTexture(),_=o.width,u=o.height;s._needInternalRenderTexture()?(r=0,i=0):(r=o.x,i=s._getCanvasHeight()-o.y-u),e.viewport(r,i,_,u);var c=s.clearFlag;switch(c!==ke.CLEARFLAG_SKY||s.skyRenderer._isAvailable()||this._skyRenderer._isAvailable()||(c=ke.CLEARFLAG_SOLIDCOLOR),c){case ke.CLEARFLAG_SOLIDCOLOR:var h=s.clearColor;if(e.enable(e.SCISSOR_TEST),e.scissor(r,i,_,u),h?e.clearColor(h.x,h.y,h.z,h.w):e.clearColor(0,0,0,0),l)switch(a=e.COLOR_BUFFER_BIT,l.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:a|=e.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:a|=e.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_16_8:a|=e.DEPTH_BUFFER_BIT,a|=e.STENCIL_BUFFER_BIT}else a=e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(e,!0),e.clear(a),e.disable(e.SCISSOR_TEST);break;case ke.CLEARFLAG_SKY:case ke.CLEARFLAG_DEPTHONLY:if(e.enable(e.SCISSOR_TEST),e.scissor(r,i,_,u),l)switch(l.depthStencilFormat){case t.RenderTextureDepthFormat.DEPTH_16:a=e.DEPTH_BUFFER_BIT;break;case t.RenderTextureDepthFormat.STENCIL_8:a=e.STENCIL_BUFFER_BIT;break;case t.RenderTextureDepthFormat.DEPTHSTENCIL_16_8:a=e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT}else a=e.DEPTH_BUFFER_BIT;t.WebGLContext.setDepthMask(e,!0),e.clear(a),e.disable(e.SCISSOR_TEST);break;case ke.CLEARFLAG_NONE:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}}},{key:"_renderScene",value:function(e){var t=e.camera;if(this._opaqueQueue._render(e),t.clearFlag===ke.CLEARFLAG_SKY&&(t.skyRenderer._isAvailable()?t.skyRenderer._render(e):this._skyRenderer._isAvailable()&&this._skyRenderer._render(e)),this._transparentQueue._render(e),ce.debugFrustumCulling)for(var n=this._debugTool._render._renderElements,r=0,i=n.length;r<i;r++)n[r]._update(this,e,null,null),n[r]._render(e)}},{key:"_parse",value:function(e,n){var r=e.lightmaps;if(r){for(var i=r.length,a=[],o=0;o<i;o++)a[o]=t.Loader.getRes(r[o].path);this.setlightmaps(a)}var s=e.ambientColor;if(s){var l=this.ambientColor;l.fromArray(s),this.ambientColor=l}var _=e.sky;if(_)switch(this._skyRenderer.material=t.Loader.getRes(_.material.path),_.mesh){case"SkyBox":this._skyRenderer.mesh=be.instance;break;case"SkyDome":this._skyRenderer.mesh=hn.instance;break;default:this.skyRenderer.mesh=be.instance}var u=e.reflectionTexture;u&&(this.customReflection=t.Loader.getRes(u)),this.enableFog=e.enableFog,this.fogStart=e.fogStart,this.fogRange=e.fogRange;var c=e.fogColor;if(c){var h=this.fogColor;h.fromArray(c),this.fogColor=h}}},{key:"_onActive",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onActive",this).call(this),t.ILaya.stage._scene3Ds.push(this)}},{key:"_onInActive",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onInActive",this).call(this);var e=t.ILaya.stage._scene3Ds;e.splice(e.indexOf(this),1)}},{key:"_addRenderObject",value:function(e){if(this._octree&&e._supportOctree)this._octree.add(e);else if(this._renders.add(e),t.Render.supportWebGLPlusCulling){var n=e._getIndexInList(),r=this._cullingBufferIndices.length;if(n>=r){var i=this._cullingBufferIndices,a=this._cullingBufferResult;this._cullingBufferIndices=new Int32Array(r+1024),this._cullingBufferResult=new Int32Array(r+1024),this._cullingBufferIndices.set(i,0),this._cullingBufferResult.set(a,0)}this._cullingBufferIndices[n]=e._cullingBufferIndex}}},{key:"_removeRenderObject",value:function(e){var n;this._octree&&e._supportOctree?this._octree.remove(e):(t.Render.supportWebGLPlusCulling&&(n=this._renders.elements[this._renders.length-1]),this._renders.remove(e),t.Render.supportWebGLPlusCulling&&(this._cullingBufferIndices[n._getIndexInList()]=n._cullingBufferIndex))}},{key:"_getRenderQueue",value:function(e){return e<=2500?this._opaqueQueue:this._transparentQueue}},{key:"setlightmaps",value:function(e){for(var t=this._lightmaps,n=0,r=t.length;n<r;n++)t[n]._removeReference();if(!e)throw new Error("Scene3D: value value can't be null.");var i=e.length;for(t.length=i,n=0;n<i;n++){var a=e[n];a._addReference(),t[n]=a}for(n=0,r=this._children.length;n<r;n++)this._setLightmapToChildNode(this._children[n])}},{key:"getlightmaps",value:function(){return this._lightmaps.slice()}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this,e),this._skyRenderer.destroy(),this._skyRenderer=null,this._directionLights=null,this._pointLights=null,this._spotLights=null,this._alternateLights=null,this._lightmaps=null,this._shaderValues=null,this._renders=null,this._cameraPool=null,this._octree=null,this.parallelSplitShadowMaps=null,this._physicsSimulation&&this._physicsSimulation._destroy(),t.Loader.clearRes(this.url))}},{key:"render",value:function(e,n,r){e._curSubmit=t.SubmitBase.RENDERBASE,this._children.length>0&&e.addRenderObject(this)}},{key:"renderSubmit",value:function(){var e,n,r;t.LayaGL.instance;for(this._prepareSceneToRender(),e=0,r=(n=this._cameraPool.length)-1;e<n;e++){t.Render.supportWebGLPlusRendering&&G.setRuntimeValueMode(e==r);var i=this._cameraPool[e];i.enableRender&&i.render()}return t.Context.set2DRenderConfig(),1}},{key:"getRenderType",value:function(){return 0}},{key:"releaseRender",value:function(){}},{key:"reUse",value:function(e,t){return 0}},{key:"url",get:function(){return this._url}},{key:"enableFog",get:function(){return this._enableFog},set:function(e){this._enableFog!==e&&(this._enableFog=e,e?this._shaderValues.addDefine(Z.SHADERDEFINE_FOG):this._shaderValues.removeDefine(Z.SHADERDEFINE_FOG))}},{key:"fogColor",get:function(){return this._shaderValues.getVector3(n.FOGCOLOR)},set:function(e){this._shaderValues.setVector3(n.FOGCOLOR,e)}},{key:"fogStart",get:function(){return this._shaderValues.getNumber(n.FOGSTART)},set:function(e){this._shaderValues.setNumber(n.FOGSTART,e)}},{key:"fogRange",get:function(){return this._shaderValues.getNumber(n.FOGRANGE)},set:function(e){this._shaderValues.setNumber(n.FOGRANGE,e)}},{key:"ambientColor",get:function(){return this._shaderValues.getVector3(n.AMBIENTCOLOR)},set:function(e){this._shaderValues.setVector3(n.AMBIENTCOLOR,e)}},{key:"skyRenderer",get:function(){return this._skyRenderer}},{key:"customReflection",get:function(){return this._shaderValues.getTexture(n.REFLECTIONTEXTURE)},set:function(e){this._shaderValues.setTexture(n.REFLECTIONTEXTURE,e),e?this._shaderValues.addDefine(Z.SHADERDEFINE_REFLECTMAP):this._shaderValues.removeDefine(Z.SHADERDEFINE_REFLECTMAP)}},{key:"reflectionIntensity",get:function(){return this._shaderValues.getNumber(n.REFLETIONINTENSITY)},set:function(e){e=Math.max(Math.min(e,1),0),this._shaderValues.setNumber(n.REFLETIONINTENSITY,e)}},{key:"physicsSimulation",get:function(){return this._physicsSimulation}},{key:"reflectionMode",get:function(){return this._reflectionMode},set:function(e){this._reflectionMode=e}},{key:"timer",get:function(){return this._timer},set:function(e){this._timer=e}},{key:"input",get:function(){return this._input}}],[{key:"__init__",value:function(){var e=o._config;if(e._multiLighting){var t=e.maxLightCount,r=e.lightClusterCount;ye.instance=new ye(r.x,r.y,r.z,Math.min(e.maxLightCount,e._maxAreaLightCountPerClusterAverage)),n._lightTexture=A._createFloatTextureBuffer(4,t),n._lightTexture.lock=!0,n._lightPixles=new Float32Array(4*t*4)}Z.SHADERDEFINE_FOG=U.getDefineByName("FOG"),Z.SHADERDEFINE_DIRECTIONLIGHT=U.getDefineByName("DIRECTIONLIGHT"),Z.SHADERDEFINE_POINTLIGHT=U.getDefineByName("POINTLIGHT"),Z.SHADERDEFINE_SPOTLIGHT=U.getDefineByName("SPOTLIGHT"),Z.SHADERDEFINE_CAST_SHADOW=U.getDefineByName("CASTSHADOW"),Z.SHADERDEFINE_SHADOW_PSSM1=U.getDefineByName("SHADOWMAP_PSSM1"),Z.SHADERDEFINE_SHADOW_PSSM2=U.getDefineByName("SHADOWMAP_PSSM2"),Z.SHADERDEFINE_SHADOW_PSSM3=U.getDefineByName("SHADOWMAP_PSSM3"),Z.SHADERDEFINE_SHADOW_PCF_NO=U.getDefineByName("SHADOWMAP_PCF_NO"),Z.SHADERDEFINE_SHADOW_PCF1=U.getDefineByName("SHADOWMAP_PCF1"),Z.SHADERDEFINE_SHADOW_PCF2=U.getDefineByName("SHADOWMAP_PCF2"),Z.SHADERDEFINE_SHADOW_PCF3=U.getDefineByName("SHADOWMAP_PCF3"),Z.SHADERDEFINE_REFLECTMAP=U.getDefineByName("REFLECTMAP")}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,n.HIERARCHY)}}]),n}();Rn.HIERARCHY="HIERARCHY",Rn.physicsSettings=new un,Rn.octreeCulling=!1,Rn.octreeInitialSize=64,Rn.octreeInitialCenter=new a(0,0,0),Rn.octreeMinNodeSize=2,Rn.octreeLooseness=1.25,Rn.REFLECTIONMODE_SKYBOX=0,Rn.REFLECTIONMODE_CUSTOM=1,Rn.FOGCOLOR=U.propertyNameToID("u_FogColor"),Rn.FOGSTART=U.propertyNameToID("u_FogStart"),Rn.FOGRANGE=U.propertyNameToID("u_FogRange"),Rn.DIRECTIONLIGHTCOUNT=U.propertyNameToID("u_DirationLightCount"),Rn.LIGHTBUFFER=U.propertyNameToID("u_LightBuffer"),Rn.CLUSTERBUFFER=U.propertyNameToID("u_LightClusterBuffer"),Rn.SUNLIGHTDIRECTION=U.propertyNameToID("u_SunLight.direction"),Rn.SUNLIGHTDIRCOLOR=U.propertyNameToID("u_SunLight.color"),Rn.LIGHTDIRECTION=U.propertyNameToID("u_DirectionLight.direction"),Rn.LIGHTDIRCOLOR=U.propertyNameToID("u_DirectionLight.color"),Rn.POINTLIGHTPOS=U.propertyNameToID("u_PointLight.position"),Rn.POINTLIGHTRANGE=U.propertyNameToID("u_PointLight.range"),Rn.POINTLIGHTATTENUATION=U.propertyNameToID("u_PointLight.attenuation"),Rn.POINTLIGHTCOLOR=U.propertyNameToID("u_PointLight.color"),Rn.SPOTLIGHTPOS=U.propertyNameToID("u_SpotLight.position"),Rn.SPOTLIGHTDIRECTION=U.propertyNameToID("u_SpotLight.direction"),Rn.SPOTLIGHTSPOTANGLE=U.propertyNameToID("u_SpotLight.spot"),Rn.SPOTLIGHTRANGE=U.propertyNameToID("u_SpotLight.range"),Rn.SPOTLIGHTCOLOR=U.propertyNameToID("u_SpotLight.color"),Rn.SHADOWDISTANCE=U.propertyNameToID("u_shadowPSSMDistance"),Rn.SHADOWLIGHTVIEWPROJECT=U.propertyNameToID("u_lightShadowVP"),Rn.SHADOWMAPPCFOFFSET=U.propertyNameToID("u_shadowPCFoffset"),Rn.SHADOWMAPTEXTURE1=U.propertyNameToID("u_shadowMap1"),Rn.SHADOWMAPTEXTURE2=U.propertyNameToID("u_shadowMap2"),Rn.SHADOWMAPTEXTURE3=U.propertyNameToID("u_shadowMap3"),Rn.AMBIENTCOLOR=U.propertyNameToID("u_AmbientColor"),Rn.REFLECTIONTEXTURE=U.propertyNameToID("u_ReflectTexture"),Rn.REFLETIONINTENSITY=U.propertyNameToID("u_ReflectIntensity"),Rn.TIME=U.propertyNameToID("u_Time");var Cn=function e(){_classCallCheck(this,e)},In=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t._bones=[],t._skinnedDataLoopMarks=[],t._localBounds=new $e(a._ZERO,a._ZERO),t._cacheAnimationNode=[],t}return _inherits(n,tt),_createClass(n,[{key:"_computeSkinnedData",value:function(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&!this._cacheAvatar)for(var e=this._cacheMesh._inverseBindPoses,t=this._cacheMesh._bindPoseIndices,n=this._cacheMesh._skinDataPathMarks,r=0,i=this._cacheMesh.subMeshCount;r<i;r++)for(var a=this._cacheMesh.getSubMesh(r)._boneIndicesList,o=this._skinnedData[r],s=0,l=a.length;s<l;s++){var _=a[s];this._computeSubSkinnedData(e,_,t,o[s],n)}}},{key:"_computeSubSkinnedData",value:function(e,n,r,i,a){for(var o=0,s=n.length;o<s;o++){var l=n[o];if(this._skinnedDataLoopMarks[l]===t.Stat.loopCount)for(var _=a[l],u=this._skinnedData[_[0]][_[1]],c=16*_[2],h=16*o,d=0;d<16;d++)i[h+d]=u[c+d];else{if(this._cacheAvatar)A._mulMatrixArray(this._cacheAnimationNode[l].transform.getWorldMatrix(),e[r[l]],i,16*o);else{var f=r[l];A._mulMatrixArray(this._bones[f].transform.worldMatrix.elements,e[f],i,16*o)}this._skinnedDataLoopMarks[l]=t.Stat.loopCount}}}},{key:"_onWorldMatNeedChange",value:function(e){this._boundsChange=!0,this._octreeNode&&(this._cacheAvatar?-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this):(e&=se.TRANSFORM_WORLDPOSITION|se.TRANSFORM_WORLDQUATERNION|se.TRANSFORM_WORLDSCALE)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this))}},{key:"_createRenderElement",value:function(){return new Ye}},{key:"_onMeshChange",value:function(e){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onMeshChange",this).call(this,e),this._cacheMesh=e;var t=e.subMeshCount;this._skinnedData=[],this._skinnedDataLoopMarks.length=e._bindPoseIndices.length;for(var r=0;r<t;r++)for(var i=e.getSubMesh(r)._boneIndicesList,a=i.length,o=this._skinnedData[r]=[],s=0;s<a;s++)o[s]=new Float32Array(16*i[s].length);this._cacheAvatar&&e&&this._getCacheAnimationNodes()}},{key:"_setCacheAnimator",value:function(e){this._cacheAnimator=e,this._shaderValues.addDefine(Cn.SHADERDEFINE_BONE),this._setRootNode()}},{key:"_calculateBoundingBox",value:function(){if(this._cacheAvatar)if(this._cacheAnimator&&this._rootBone){var e=n._tempMatrix4x4;A.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheRootAnimationNode.transform.getWorldMatrix(),e),this._localBounds._tranform(e,this._bounds)}else _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_calculateBoundingBox",this).call(this);else this._cacheRootBone?this._localBounds._tranform(this._cacheRootBone.transform.worldMatrix,this._bounds):this._localBounds._tranform(this._owner.transform.worldMatrix,this._bounds);if(t.Render.supportWebGLPlusCulling){var r=this._bounds.getMin(),i=this._bounds.getMax(),a=ce._cullingBuffer;a[this._cullingBufferIndex+1]=r.x,a[this._cullingBufferIndex+2]=r.y,a[this._cullingBufferIndex+3]=r.z,a[this._cullingBufferIndex+4]=i.x,a[this._cullingBufferIndex+5]=i.y,a[this._cullingBufferIndex+6]=i.z}}},{key:"_renderUpdate",value:function(e,t){if(this._cacheAnimator)if(this._computeSkinnedData(),this._cacheAvatar){var n=this._cacheAnimator.owner._transform;this._shaderValues.setMatrix4x4(le.WORLDMATRIX,n.worldMatrix)}else this._shaderValues.setMatrix4x4(le.WORLDMATRIX,T.DEFAULT);else this._shaderValues.setMatrix4x4(le.WORLDMATRIX,t.worldMatrix)}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;if(this._cacheAnimator)if(this._cacheAvatar){var r=this._cacheAnimator.owner._transform;T.multiply(n,r.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(le.MVPMATRIX,this._projectionViewWorldMatrix)}else this._shaderValues.setMatrix4x4(le.MVPMATRIX,n);else T.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(le.MVPMATRIX,this._projectionViewWorldMatrix)}},{key:"_destroy",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_destroy",this).call(this),this._cacheAvatar?this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._cacheRootBone?!this._cacheRootBone.destroyed&&this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner&&!this._owner.destroyed&&this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange)}},{key:"_setRootBone",value:function(e){this._rootBone=e,this._setRootNode()}},{key:"_setRootNode",value:function(){var e;e=this._cacheAnimator&&this._rootBone&&this._cacheAvatar?this._cacheAnimator._avatarNodeMap[this._rootBone]:null,this._cacheRootAnimationNode!=e&&(this._onWorldMatNeedChange(se.TRANSFORM_WORLDPOSITION|se.TRANSFORM_WORLDQUATERNION|se.TRANSFORM_WORLDSCALE),this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e&&e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootAnimationNode=e)}},{key:"_getCacheAnimationNodes",value:function(){var e=this._cacheMesh._boneNames,n=this._cacheMesh._bindPoseIndices,r=n.length;if(t.Render.supportWebGLPlusAnimation){this._cacheAnimationNodeIndices=new Uint16Array(r);var i=this._cacheAnimator._avatarNodeMap;for(s=0;s<r;s++){var a=i[e[n[s]]];this._cacheAnimationNodeIndices[s]=a?a._worldMatrixIndex:0}}else{this._cacheAnimationNode.length=r;for(var o=this._cacheAnimator._avatarNodeMap,s=0;s<r;s++){var l=o[e[n[s]]];this._cacheAnimationNode[s]=l}}}},{key:"_setCacheAvatar",value:function(e){this._cacheAvatar!==e&&(this._cacheMesh?(this._cacheAvatar=e,e&&(this._shaderValues.addDefine(Cn.SHADERDEFINE_BONE),this._getCacheAnimationNodes())):this._cacheAvatar=e,this._setRootNode())}},{key:"_computeSubSkinnedDataNative",value:function(e,n,r,i,a,o){t.LayaGL.instance.computeSubSkinnedData(e,n,r,i,a,o)}},{key:"_computeSkinnedDataForNative",value:function(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&!this._cacheAvatar)for(var e=this._cacheMesh._inverseBindPoses,n=this._cacheMesh._bindPoseIndices,r=this._cacheMesh._skinDataPathMarks,i=0,a=this._cacheMesh.subMeshCount;i<a;i++)for(var o=this._cacheMesh.getSubMesh(i)._boneIndicesList,s=this._skinnedData[i],l=0,_=o.length;l<_;l++){var u=o[l];this._cacheAvatar&&t.Render.supportWebGLPlusAnimation?this._computeSubSkinnedDataNative(this._cacheAnimator._animationNodeWorldMatrixs,this._cacheAnimationNodeIndices,this._cacheMesh._inverseBindPosesBuffer,u,n,s[l]):this._computeSubSkinnedData(e,u,n,s[l],r)}}},{key:"localBounds",get:function(){return this._localBounds},set:function(e){this._localBounds=e}},{key:"rootBone",get:function(){return this._cacheRootBone},set:function(e){this._cacheRootBone!=e&&(this._cacheRootBone?this._cacheRootBone.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.off(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),e?e.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange):this._owner.transform.on(t.Event.TRANSFORM_CHANGED,this,this._onWorldMatNeedChange),this._cacheRootBone=e,this._onWorldMatNeedChange(se.TRANSFORM_WORLDPOSITION|se.TRANSFORM_WORLDQUATERNION|se.TRANSFORM_WORLDSCALE))}},{key:"bones",get:function(){return this._bones}},{key:"bounds",get:function(){return(this._boundsChange||this._cacheAvatar)&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds}}]),n}();In._tempMatrix4x4=new T;var An=function(e){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return r._meshFilter=new nt(r),r._render=new In(r),e&&(r._meshFilter.sharedMesh=e),r}return _inherits(n,_e),_createClass(n,[{key:"_parse",value:function(e,r){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_parse",this).call(this,e,r);var o=this.skinnedMeshRenderer,s=e.lightmapIndex;null!=s&&(o.lightmapIndex=s);var l,_=e.lightmapScaleOffset;if(_&&(o.lightmapScaleOffset=new i(_[0],_[1],_[2],_[3])),l=e.meshPath){var u=t.Loader.getRes(l);u&&(this.meshFilter.sharedMesh=u)}var c=e.materials;if(c){var h=o.sharedMaterials,d=c.length;h.length=d;for(var f=0;f<d;f++)h[f]=t.Loader.getRes(c[f].path);o.sharedMaterials=h}var m=e.boundBox,E=m.min,v=m.max;if(o.localBounds.setMin(new a(E[0],E[1],E[2])),o.localBounds.setMax(new a(v[0],v[1],v[2])),r){var T=e.rootBone;o.rootBone=r[T];var p,g=e.bones;for(f=0,p=g.length;f<p;f++)o.bones.push(r[g[f]])}else e.rootBone&&o._setRootBone(e.rootBone)}},{key:"_changeHierarchyAnimator",value:function(e){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_changeHierarchyAnimator",this).call(this,e),this.skinnedMeshRenderer._setCacheAnimator(e)}},{key:"_changeAnimatorAvatar",value:function(e){this.skinnedMeshRenderer._setCacheAvatar(e)}},{key:"_cloneTo",value:function(e,t,r){var i=e;i.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var a=this._render,o=i._render;o.enable=a.enable,o.sharedMaterials=a.sharedMaterials,o.castShadow=a.castShadow;var s=a.lightmapScaleOffset;s&&(o.lightmapScaleOffset=s.clone()),o.receiveShadow=a.receiveShadow,o.sortingFudge=a.sortingFudge,o._rootBone=a._rootBone;var l=a.bones,_=o.bones,u=l.length;_.length=u;var c=a.rootBone;if(c){var h=A._getHierarchyPath(t,c,n._tempArray0);o.rootBone=h?A._getNodeByHierarchyPath(r,h):c}for(var d=0;d<l.length;d++)h=A._getHierarchyPath(t,l[d],n._tempArray0),_[d]=h?A._getNodeByHierarchyPath(r,h):l[d];var f=a.localBounds;f&&f.cloneTo(o.localBounds),_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_cloneTo",this).call(this,e,t,r)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this,e),this._meshFilter.destroy())}},{key:"_create",value:function(){return new n}},{key:"meshFilter",get:function(){return this._meshFilter}},{key:"skinnedMeshRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){Cn.SHADERDEFINE_BONE=U.getDefineByName("BONE")}}]),n}();An._tempArray0=[],An.BONES=U.propertyNameToID("u_Bones");var xn=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.setShaderName("Trail"),e._color=new i(1,1,1,1),e._shaderValues.setVector(t.TINTCOLOR,new i(1,1,1,1)),e.renderMode=t.RENDERMODE_ALPHABLENDED,e}return _inherits(t,Y),_createClass(t,[{key:"clone",value:function(){var e=new t;return this.cloneTo(e),e}},{key:"_TintColorR",get:function(){return this._color.x},set:function(e){this._color.x=e,this.color=this._color}},{key:"_TintColorG",get:function(){return this._color.y},set:function(e){this._color.y=e,this.color=this._color}},{key:"_TintColorB",get:function(){return this._color.z},set:function(e){this._color.z=e,this.color=this._color}},{key:"_TintColorA",get:function(){return this._color.w},set:function(e){this._color.w=e,this.color=this._color}},{key:"_MainTex_STX",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).x},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.x=e,this.tilingOffset=n}},{key:"_MainTex_STY",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).y},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.y=e,this.tilingOffset=n}},{key:"_MainTex_STZ",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).z},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.z=e,this.tilingOffset=n}},{key:"_MainTex_STW",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET).w},set:function(e){var n=this._shaderValues.getVector(t.TILINGOFFSET);n.w=e,this.tilingOffset=n}},{key:"renderMode",set:function(e){switch(e){case t.RENDERMODE_ADDTIVE:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_NONE,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.addDefine(t.SHADERDEFINE_ADDTIVEFOG);break;case t.RENDERMODE_ALPHABLENDED:this.renderQueue=Y.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.cull=q.CULL_NONE,this.blend=q.BLEND_ENABLE_ALL,this.blendSrc=q.BLENDPARAM_SRC_ALPHA,this.blendDst=q.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=q.DEPTHTEST_LESS,this._shaderValues.removeDefine(t.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("TrailMaterial : renderMode value error.")}}},{key:"colorR",get:function(){return this._TintColorR},set:function(e){this._TintColorR=e}},{key:"colorG",get:function(){return this._TintColorG},set:function(e){this._TintColorG=e}},{key:"colorB",get:function(){return this._TintColorB},set:function(e){this._TintColorB=e}},{key:"colorA",get:function(){return this._TintColorA},set:function(e){this._TintColorA=e}},{key:"color",get:function(){return this._shaderValues.getVector(t.TINTCOLOR)},set:function(e){this._shaderValues.setVector(t.TINTCOLOR,e)}},{key:"texture",get:function(){return this._shaderValues.getTexture(t.MAINTEXTURE)},set:function(e){e?this._shaderValues.addDefine(t.SHADERDEFINE_MAINTEXTURE):this._shaderValues.removeDefine(t.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(t.MAINTEXTURE,e)}},{key:"tilingOffsetX",get:function(){return this._MainTex_STX},set:function(e){this._MainTex_STX=e}},{key:"tilingOffsetY",get:function(){return this._MainTex_STY},set:function(e){this._MainTex_STY=e}},{key:"tilingOffsetZ",get:function(){return this._MainTex_STZ},set:function(e){this._MainTex_STZ=e}},{key:"tilingOffsetW",get:function(){return this._MainTex_STW},set:function(e){this._MainTex_STW=e}},{key:"tilingOffset",get:function(){return this._shaderValues.getVector(t.TILINGOFFSET)},set:function(e){e&&(1!=e.x||1!=e.y||0!=e.z||0!=e.w)?this._shaderValues.addDefine(t.SHADERDEFINE_TILINGOFFSET):this._shaderValues.removeDefine(t.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(t.TILINGOFFSET,e)}},{key:"depthWrite",set:function(e){this._shaderValues.setBool(t.DEPTH_WRITE,e)},get:function(){return this._shaderValues.getBool(t.DEPTH_WRITE)}},{key:"cull",set:function(e){this._shaderValues.setInt(t.CULL,e)},get:function(){return this._shaderValues.getInt(t.CULL)}},{key:"blend",set:function(e){this._shaderValues.setInt(t.BLEND,e)},get:function(){return this._shaderValues.getInt(t.BLEND)}},{key:"blendSrc",set:function(e){this._shaderValues.setInt(t.BLEND_SRC,e)},get:function(){return this._shaderValues.getInt(t.BLEND_SRC)}},{key:"blendDst",set:function(e){this._shaderValues.setInt(t.BLEND_DST,e)},get:function(){return this._shaderValues.getInt(t.BLEND_DST)}},{key:"depthTest",set:function(e){this._shaderValues.setInt(t.DEPTH_TEST,e)},get:function(){return this._shaderValues.getInt(t.DEPTH_TEST)}}],[{key:"__initDefine__",value:function(){t.SHADERDEFINE_MAINTEXTURE=U.getDefineByName("MAINTEXTURE"),t.SHADERDEFINE_TILINGOFFSET=U.getDefineByName("TILINGOFFSET"),t.SHADERDEFINE_ADDTIVEFOG=U.getDefineByName("ADDTIVEFOG")}}]),t}();xn.RENDERMODE_ALPHABLENDED=0,xn.RENDERMODE_ADDTIVE=1,xn.MAINTEXTURE=U.propertyNameToID("u_MainTexture"),xn.TINTCOLOR=U.propertyNameToID("u_MainColor"),xn.TILINGOFFSET=U.propertyNameToID("u_TilingOffset"),xn.CULL=U.propertyNameToID("s_Cull"),xn.BLEND=U.propertyNameToID("s_Blend"),xn.BLEND_SRC=U.propertyNameToID("s_BlendSrc"),xn.BLEND_DST=U.propertyNameToID("s_BlendDst"),xn.DEPTH_TEST=U.propertyNameToID("s_DepthTest"),xn.DEPTH_WRITE=U.propertyNameToID("s_DepthWrite");var Dn,Ln=function e(){_classCallCheck(this,e)};Ln.Stretch=0,Ln.Tile=1,(Dn=e.TrailAlignment||(e.TrailAlignment={}))[Dn.View=0]="View",Dn[Dn.TransformZ=1]="TransformZ";var Mn=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"vertexDeclaration",get:function(){return e._vertexDeclaration1}}],[{key:"__init__",value:function(){e._vertexDeclaration1=new Ee(32,[new ve(0,me.Vector3,e.TRAIL_POSITION0),new ve(12,me.Vector3,e.TRAIL_OFFSETVECTOR),new ve(24,me.Single,e.TRAIL_TIME0),new ve(28,me.Single,e.TRAIL_TEXTURECOORDINATE0Y)]),e._vertexDeclaration2=new Ee(20,[new ve(0,me.Single,e.TRAIL_TEXTURECOORDINATE0X),new ve(4,me.Color,e.TRAIL_COLOR)])}},{key:"vertexDeclaration1",get:function(){return e._vertexDeclaration1}},{key:"vertexDeclaration2",get:function(){return e._vertexDeclaration2}}]),e}();Mn.TRAIL_POSITION0=0,Mn.TRAIL_OFFSETVECTOR=1,Mn.TRAIL_TIME0=2,Mn.TRAIL_TEXTURECOORDINATE0Y=3,Mn.TRAIL_TEXTURECOORDINATE0X=4,Mn.TRAIL_COLOR=5;var On=function(r){function i(e){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));n._floatCountPerVertices1=8,n._floatCountPerVertices2=5,n._increaseSegementCount=16,n._activeIndex=0,n._endIndex=0,n._needAddFirstVertex=!1,n._isTempEndVertex=!1,n._vertices1=null,n._vertices2=null,n._lastFixedVertexPosition=new a,n._bufferState=new Oe,n.tmpColor=new ae,n._disappearBoundsMode=!1,n._owner=e,n._segementCount=n._increaseSegementCount,n._resizeData(n._segementCount,n._bufferState);var r=n._owner._owner.trailRenderer.bounds,o=n._owner._owner.transform.position;return r.setMin(o),r.setMax(o),t.Render.supportWebGLPlusCulling&&n._calculateBoundingBoxForNative(),n}return _inherits(i,de),_createClass(i,[{key:"_resizeData",value:function(e,n){this._subBirthTime=new Float32Array(e),this._subDistance=new Float64Array(e);var r=t.LayaGL.instance,i=2*e,a=Mn.vertexDeclaration1,o=Mn.vertexDeclaration2,s=[],l=i*a.vertexStride,_=i*o.vertexStride,u=l+_;this._vertices1=new Float32Array(i*this._floatCountPerVertices1),this._vertices2=new Float32Array(i*this._floatCountPerVertices2),this._vertexBuffer1=new fe(l,r.STATIC_DRAW,!1),this._vertexBuffer1.vertexDeclaration=a,this._vertexBuffer2=new fe(_,r.DYNAMIC_DRAW,!1),this._vertexBuffer2.vertexDeclaration=o,s.push(this._vertexBuffer1),s.push(this._vertexBuffer2),n.bind(),n.applyVertexBuffers(s),n.unBind(),t.Resource._addMemory(u,u)}},{key:"_resetData",value:function(){var e=this._endIndex-this._activeIndex,t=new Float32Array(this._vertices1.buffer,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e),n=new Float32Array(this._vertices2.buffer,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e),r=new Float64Array(this._subDistance.buffer,8*this._activeIndex,e),i=new Float32Array(this._subBirthTime.buffer,4*this._activeIndex,e);e===this._segementCount&&(this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._segementCount+=this._increaseSegementCount,this._resizeData(this._segementCount,this._bufferState)),this._vertices1.set(t,0),this._vertices2.set(n,0),this._subDistance.set(r,0),this._subBirthTime.set(i,0),this._endIndex=e,this._activeIndex=0,this._vertexBuffer1.setData(this._vertices1.buffer,0,2*this._floatCountPerVertices1*this._activeIndex*4,2*this._floatCountPerVertices1*e*4),this._vertexBuffer2.setData(this._vertices2.buffer,0,2*this._floatCountPerVertices2*this._activeIndex*4,2*this._floatCountPerVertices2*e*4)}},{key:"_updateTrail",value:function(e,t,n){a.equals(t,n)||(this._endIndex-this._activeIndex==0?this._addTrailByFirstPosition(e,n):this._addTrailByNextPosition(e,n))}},{key:"_addTrailByFirstPosition",value:function(e,t){this._endIndex===this._segementCount&&this._resetData(),this._subDistance[this._endIndex]=0,this._subBirthTime[this._endIndex]=this._owner._curtime,this._endIndex++,t.cloneTo(this._lastFixedVertexPosition),this._needAddFirstVertex=!0}},{key:"_addTrailByNextPosition",value:function(t,r){var o=i._tempVector30,s=i._tempVector31;switch(this._owner.alignment){case e.TrailAlignment.View:var l=t.viewMatrix;a.transformCoordinate(r,l,i._tempVector33),a.transformCoordinate(this._lastFixedVertexPosition,l,i._tempVector34),a.subtract(i._tempVector33,i._tempVector34,o),a.cross(i._tempVector33,o,s);break;case e.TrailAlignment.TransformZ:a.subtract(r,this._lastFixedVertexPosition,o);var _=i._tempVector32;this._owner._owner.transform.localMatrix.getForward(_),a.cross(o,_,s)}a.normalize(s,s),a.scale(s,this._owner.widthMultiplier/2,s);var u,c,h=a.scalarLength(o);this._needAddFirstVertex&&(this._updateVerticesByPositionData(r,s,this._endIndex-1),this._needAddFirstVertex=!1),h-this._owner.minVertexDistance>=n.zeroTolerance?(this._isTempEndVertex?(u=this._endIndex-1,c=h-this._subDistance[u],this._updateVerticesByPosition(r,s,h,u),this._owner._totalLength+=c):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(r,s,h,this._endIndex),this._owner._totalLength+=h,this._endIndex++),r.cloneTo(this._lastFixedVertexPosition),this._isTempEndVertex=!1):(this._isTempEndVertex?(u=this._endIndex-1,c=h-this._subDistance[u],this._updateVerticesByPosition(r,s,h,u),this._owner._totalLength+=c):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(r,s,h,this._endIndex),this._owner._totalLength+=h,this._endIndex++),this._isTempEndVertex=!0)}},{key:"_updateVerticesByPositionData",value:function(e,n,r){var o=2*this._floatCountPerVertices1*r,s=this._owner._curtime;this._vertices1[o]=e.x,this._vertices1[o+1]=e.y,this._vertices1[o+2]=e.z,this._vertices1[o+3]=-n.x,this._vertices1[o+4]=-n.y,this._vertices1[o+5]=-n.z,this._vertices1[o+6]=s,this._vertices1[o+7]=1,this._vertices1[o+8]=e.x,this._vertices1[o+9]=e.y,this._vertices1[o+10]=e.z,this._vertices1[o+11]=n.x,this._vertices1[o+12]=n.y,this._vertices1[o+13]=n.z,this._vertices1[o+14]=s,this._vertices1[o+15]=0;var l=this._owner._owner.trailRenderer.bounds,_=l.getMin(),u=l.getMax(),c=i._tempVector35,h=i._tempVector36,d=i._tempVector32;a.add(e,n,c),a.subtract(e,n,h),a.min(h,c,d),a.min(_,d,_),l.setMin(_),a.max(c,h,d),a.max(u,d,u),l.setMax(u),t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative();var f=2*this._floatCountPerVertices1;this._vertexBuffer1.setData(this._vertices1.buffer,4*o,4*o,4*f)}},{key:"_updateVerticesByPosition",value:function(e,t,n,r){this._updateVerticesByPositionData(e,t,r),this._subDistance[r]=n,this._subBirthTime[r]=this._owner._curtime}},{key:"_updateVertexBufferUV",value:function(){var e,n,r;this._disappearBoundsMode&&(n=(e=this._owner._owner.trailRenderer.bounds).getMin(),r=e.getMax(),n.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative());for(var o=this._endIndex,s=0,l=this._owner.colorGradient,_=l.colorAlphaKeysCount-1,u=l.colorRGBKeysCount-1,c=this._owner._totalLength,h=2*this._floatCountPerVertices2,d=this._activeIndex;d<o;d++){var f,m;d!==this._activeIndex&&(s+=this._subDistance[d]),this._owner.textureMode==Ln.Stretch?m=f=1-s/c:(m=1-s/c,f=1-(c-s)),u=l.evaluateColorRGB(m,this.tmpColor,u,!0),_=l.evaluateColorAlpha(m,this.tmpColor,_,!0);var E=d*h;if(this._vertices2[E+0]=f,this._vertices2[E+1]=this.tmpColor.r,this._vertices2[E+2]=this.tmpColor.g,this._vertices2[E+3]=this.tmpColor.b,this._vertices2[E+4]=this.tmpColor.a,this._vertices2[E+5]=f,this._vertices2[E+6]=this.tmpColor.r,this._vertices2[E+7]=this.tmpColor.g,this._vertices2[E+8]=this.tmpColor.b,this._vertices2[E+9]=this.tmpColor.a,this._disappearBoundsMode){var v=2*this._floatCountPerVertices1*d,T=i._tempVector32,p=i._tempVector33,g=i._tempVector34;T.setValue(this._vertices1[v+0],this._vertices1[v+1],this._vertices1[v+2]),p.setValue(this._vertices1[v+3],this._vertices1[v+4],this._vertices1[v+5]),a.add(T,p,g),a.min(g,n,n),a.max(g,r,r),a.subtract(T,p,g),a.min(g,n,n),a.max(g,r,r)}}this._disappearBoundsMode&&(e.setMin(n),e.setMax(r),this._disappearBoundsMode=!1,t.Render.supportWebGLPlusCulling&&this._calculateBoundingBoxForNative());var y=this._activeIndex*h;this._vertexBuffer2.setData(this._vertices2.buffer,4*y,4*y,4*(o*h-y))}},{key:"_updateDisappear",value:function(){for(var e=this._endIndex,t=this._activeIndex;t<e&&this._owner._curtime-this._subBirthTime[t]>=this._owner.time+n.zeroTolerance;t++){var r=t+1;if(r!==e&&(this._owner._totalLength-=this._subDistance[r]),this._isTempEndVertex&&r===e-1){this._floatCountPerVertices1;var i=this._lastFixedVertexPosition;i.x=this._vertices1[0],i.y=this._vertices1[1],i.z=this._vertices1[2],this._isTempEndVertex=!1}this._activeIndex++,this._disappearBoundsMode=!0}}},{key:"_getType",value:function(){return i._type}},{key:"_prepareRender",value:function(e){return this._endIndex-this._activeIndex>1}},{key:"_render",value:function(e){this._bufferState.bind();var n=t.LayaGL.instance,r=2*this._activeIndex,i=2*this._endIndex-r;n.drawArrays(n.TRIANGLE_STRIP,r,i),t.Stat.renderBatches++,t.Stat.trianglesFaces+=i-2}},{key:"destroy",value:function(){_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this);var e=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;t.Resource._addMemory(-e,-e),this._bufferState.destroy(),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._bufferState=null,this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._subBirthTime=null,this._subDistance=null,this._lastFixedVertexPosition=null,this._disappearBoundsMode=!1}},{key:"_calculateBoundingBoxForNative",value:function(){var e=this._owner._owner.trailRenderer,t=e.bounds,n=t.getMin(),r=t.getMax(),i=ce._cullingBuffer;i[e._cullingBufferIndex+1]=n.x,i[e._cullingBufferIndex+2]=n.y,i[e._cullingBufferIndex+3]=n.z,i[e._cullingBufferIndex+4]=r.x,i[e._cullingBufferIndex+5]=r.y,i[e._cullingBufferIndex+6]=r.z}}]),i}();On.ALIGNMENT_VIEW=0,On.ALIGNMENT_TRANSFORM_Z=1,On._tempVector30=new a,On._tempVector31=new a,On._tempVector32=new a,On._tempVector33=new a,On._tempVector34=new a,On._tempVector35=new a,On._tempVector36=new a,On._type=de._typeCounter++;var Nn=function(){function e(t){_classCallCheck(this,e),this._totalLength=0,this._lastPosition=new a,this._curtime=0,this.alignment=e.ALIGNMENT_VIEW,this._owner=t,this._initDefaultData(),this.addRenderElement()}return _createClass(e,[{key:"addRenderElement",value:function(){var e=this._owner._render,t=e._renderElements,n=e.sharedMaterials[0];n||(n=xn.defaultMaterial);var r=new Ye;r.setTransform(this._owner._transform),r.render=e,r.material=n,this._trialGeometry=new On(this),r.setGeometry(this._trialGeometry),t.push(r)}},{key:"_update",value:function(t){var n=this._owner._render;this._curtime+=t.scene.timer._delta/1e3,n._shaderValues.setNumber(e.CURTIME,this._curtime);var r=this._owner.transform.position,i=n._renderElements[0]._geometry;i._updateDisappear(),i._updateTrail(t.camera,this._lastPosition,r),i._updateVertexBufferUV(),r.cloneTo(this._lastPosition)}},{key:"_initDefaultData",value:function(){this.time=5,this.minVertexDistance=.1,this.widthMultiplier=1,this.textureMode=Ln.Stretch;var e=[],t=new c;t.time=0,t.inTangent=0,t.outTangent=0,t.value=1,e.push(t);var n=new c;n.time=1,n.inTangent=0,n.outTangent=0,n.value=1,e.push(n),this.widthCurve=e;var r=new st(2,2);r.mode=ot.Blend,r.addColorRGB(0,ae.WHITE),r.addColorRGB(1,ae.WHITE),r.addColorAlpha(0,1),r.addColorAlpha(1,1),this.colorGradient=r}},{key:"destroy",value:function(){this._trialGeometry.destroy(),this._trialGeometry=null,this._widthCurve=null,this._colorGradient=null}},{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._owner._render._shaderValues.setNumber(e.LIFETIME,t)}},{key:"minVertexDistance",get:function(){return this._minVertexDistance},set:function(e){this._minVertexDistance=e}},{key:"widthMultiplier",get:function(){return this._widthMultiplier},set:function(e){this._widthMultiplier=e}},{key:"widthCurve",get:function(){return this._widthCurve},set:function(t){this._widthCurve=t;var n,r,i=new Float32Array(4*t.length),a=0;for(n=0,r=t.length;n<r;n++)i[a++]=t[n].time,i[a++]=t[n].inTangent,i[a++]=t[n].outTangent,i[a++]=t[n].value;this._owner._render._shaderValues.setBuffer(e.WIDTHCURVE,i),this._owner._render._shaderValues.setInt(e.WIDTHCURVEKEYLENGTH,t.length)}},{key:"colorGradient",get:function(){return this._colorGradient},set:function(e){this._colorGradient=e}},{key:"textureMode",get:function(){return this._textureMode},set:function(e){this._textureMode=e}}]),e}();Nn.CURTIME=U.propertyNameToID("u_CurTime"),Nn.LIFETIME=U.propertyNameToID("u_LifeTime"),Nn.WIDTHCURVE=U.propertyNameToID("u_WidthCurve"),Nn.WIDTHCURVEKEYLENGTH=U.propertyNameToID("u_WidthCurveKeyLength"),Nn.ALIGNMENT_VIEW=0,Nn.ALIGNMENT_TRANSFORM_Z=1;var Pn=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n._projectionViewWorldMatrix=new T,n}return _inherits(t,et),_createClass(t,[{key:"_calculateBoundingBox",value:function(){}},{key:"_needRender",value:function(e,t){return this._owner.trailFilter._update(t),!e||e.intersects(this.bounds._getBoundBox())}},{key:"_updateForNative",value:function(e){this._owner.trailFilter._update(e)}},{key:"_renderUpdate",value:function(e,n){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_renderUpdate",this).call(this,e,n)}},{key:"_renderUpdateWithCamera",value:function(e,t){var n=e.projectionViewMatrix;t?(T.multiply(n,t.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(le.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(le.MVPMATRIX,n)}}]),t}(),bn=function(e){function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t._render=new Pn(t),t._geometryFilter=new Nn(t),t}return _inherits(n,_e),_createClass(n,[{key:"trailFilter",get:function(){return this._geometryFilter}},{key:"trailRenderer",get:function(){return this._render}}],[{key:"__init__",value:function(){}}]),_createClass(n,[{key:"_parse",value:function(e,r){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_parse",this).call(this,e,r);var i,a,o=this._render,s=this._geometryFilter,l=e.materials;if(l){var _=o.sharedMaterials,u=l.length;for(_.length=u,i=0;i<u;i++)_[i]=t.Loader.getRes(l[i].path);o.sharedMaterials=_}s.time=e.time,s.minVertexDistance=e.minVertexDistance,s.widthMultiplier=e.widthMultiplier,s.textureMode=e.textureMode,null!=e.alignment&&(s.alignment=e.alignment);var h=[],d=e.widthCurve;for(i=0,a=d.length;i<a;i++){var f=new c;f.time=d[i].time,f.inTangent=d[i].inTangent,f.outTangent=d[i].outTangent,f.value=d[i].value,h.push(f)}s.widthCurve=h;var m=e.colorGradient,E=m.colorKeys,v=m.alphaKeys,T=new st(E.length,v.length);for(T.mode=m.mode,i=0,a=E.length;i<a;i++){var p=E[i];T.addColorRGB(p.time,new ae(p.value[0],p.value[1],p.value[2],1))}for(i=0,a=v.length;i<a;i++){var g=v[i];T.addColorAlpha(g.time,g.value)}s.colorGradient=T}},{key:"_onActive",value:function(){_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_onActive",this).call(this),this._transform.position.cloneTo(this._geometryFilter._lastPosition)}},{key:"_cloneTo",value:function(e,t,r){var i,a;_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"_cloneTo",this).call(this,e,t,r);var o=e,s=o.trailFilter;s.time=this.trailFilter.time,s.minVertexDistance=this.trailFilter.minVertexDistance,s.widthMultiplier=this.trailFilter.widthMultiplier,s.textureMode=this.trailFilter.textureMode,s.alignment=this.trailFilter.alignment;var l=this.trailFilter.widthCurve,_=[];for(i=0,a=l.length;i<a;i++){var u=new c;l[i].cloneTo(u),_.push(u)}s.widthCurve=_;var h=new st(this.trailFilter.colorGradient.maxColorRGBKeysCount,this.trailFilter.colorGradient.maxColorAlphaKeysCount);this.trailFilter.colorGradient.cloneTo(h),s.colorGradient=h,o.trailRenderer.sharedMaterial=this.trailRenderer.sharedMaterial}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.destroyed||(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this,e),this._geometryFilter.destroy(),this._geometryFilter=null)}},{key:"_create",value:function(){return new n}}]),n}(),Vn=function(){function e(t,n,r,i){_classCallCheck(this,e),this._position=t,this._normal=n,this._textureCoord0=r,this._textureCoord1=i}return _createClass(e,[{key:"position",get:function(){return this._position}},{key:"normal",get:function(){return this._normal}},{key:"textureCoord0",get:function(){return this._textureCoord0}},{key:"textureCoord1",get:function(){return this._textureCoord1}},{key:"vertexDeclaration",get:function(){return e._vertexDeclaration}}],[{key:"__init__",value:function(){e._vertexDeclaration=new Ee(40,[new ve(0,me.Vector3,e.TERRAIN_POSITION0),new ve(12,me.Vector3,e.TERRAIN_NORMAL0),new ve(24,me.Vector2,e.TERRAIN_TEXTURECOORDINATE0),new ve(32,me.Vector2,e.TERRAIN_TEXTURECOORDINATE1)])}},{key:"vertexDeclaration",get:function(){return e._vertexDeclaration}}]),e}();Vn.TERRAIN_POSITION0=0,Vn.TERRAIN_NORMAL0=1,Vn.TERRAIN_TEXTURECOORDINATE0=2,Vn.TERRAIN_TEXTURECOORDINATE1=3;var kn=function e(){_classCallCheck(this,e)};kn._interactive={getWorldTransform:function(e,t){},setWorldTransform:function(e,t){var n=sn._physicObjectsMap[e];n._simulation._updatedRigidbodies++,n._updateTransformComponent(t)}};var wn=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ot.COLLISIONFILTERGROUP_DEFAULTFILTER,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ot.COLLISIONFILTERGROUP_ALLFILTER;_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r,i));return o._upAxis=new a(0,1,0),o._maxSlope=45,o._jumpSpeed=10,o._fallSpeed=55,o._gravity=new a(0,3*-9.8,0),o._btKinematicCharacter=null,o._stepHeight=e,n&&(o._upAxis=n),o}return _inherits(t,sn),_createClass(t,[{key:"_constructCharacter",value:function(){var e=I._bullet;this._btKinematicCharacter&&e.btKinematicCharacterController_destroy(this._btKinematicCharacter);var n=t._btTempVector30;e.btVector3_setValue(n,this._upAxis.x,this._upAxis.y,this._upAxis.z),this._btKinematicCharacter=e.btKinematicCharacterController_create(this._btColliderObject,this._colliderShape._btShape,this._stepHeight,n),this.fallSpeed=this._fallSpeed,this.maxSlope=this._maxSlope,this.jumpSpeed=this._jumpSpeed,this.gravity=this._gravity}},{key:"_onShapeChange",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onShapeChange",this).call(this,e),this._constructCharacter()}},{key:"_onAdded",value:function(){var e=I._bullet,n=e.btPairCachingGhostObject_create();e.btCollisionObject_setUserIndex(n,this.id),e.btCollisionObject_setCollisionFlags(n,sn.COLLISIONFLAGS_CHARACTER_OBJECT),this._btColliderObject=n,this._colliderShape&&this._constructCharacter(),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onAdded",this).call(this)}},{key:"_addToSimulation",value:function(){this._simulation._characters.push(this),this._simulation._addCharacter(this,this._collisionGroup,this._canCollideWith)}},{key:"_removeFromSimulation",value:function(){this._simulation._removeCharacter(this);var e=this._simulation._characters;e.splice(e.indexOf(this),1)}},{key:"_cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_cloneTo",this).call(this,e);var n=e;n.stepHeight=this._stepHeight,n.upAxis=this._upAxis,n.maxSlope=this._maxSlope,n.jumpSpeed=this._jumpSpeed,n.fallSpeed=this._fallSpeed,n.gravity=this._gravity}},{key:"_onDestroy",value:function(){I._bullet.btKinematicCharacterController_destroy(this._btKinematicCharacter),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onDestroy",this).call(this),this._btKinematicCharacter=null}},{key:"move",value:function(e){var n=t._btVector30,r=I._bullet;r.btVector3_setValue(n,-e.x,e.y,e.z),r.btKinematicCharacterController_setWalkDirection(this._btKinematicCharacter,n)}},{key:"jump",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=I._bullet,r=t._btVector30;e?(A._convertToBulletVec3(e,r,!0),n.btKinematicCharacterController_jump(this._btKinematicCharacter,r)):(n.btVector3_setValue(r,0,0,0),n.btKinematicCharacterController_jump(this._btKinematicCharacter,r))}},{key:"fallSpeed",get:function(){return this._fallSpeed},set:function(e){this._fallSpeed=e,I._bullet.btKinematicCharacterController_setFallSpeed(this._btKinematicCharacter,e)}},{key:"jumpSpeed",get:function(){return this._jumpSpeed},set:function(e){this._jumpSpeed=e,I._bullet.btKinematicCharacterController_setJumpSpeed(this._btKinematicCharacter,e)}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity=e;var n=I._bullet,r=t._btTempVector30;n.btVector3_setValue(r,-e.x,e.y,e.z),n.btKinematicCharacterController_setGravity(this._btKinematicCharacter,r)}},{key:"maxSlope",get:function(){return this._maxSlope},set:function(e){this._maxSlope=e,I._bullet.btKinematicCharacterController_setMaxSlope(this._btKinematicCharacter,e/180*Math.PI)}},{key:"isGrounded",get:function(){return I._bullet.btKinematicCharacterController_onGround(this._btKinematicCharacter)}},{key:"stepHeight",get:function(){return this._stepHeight},set:function(e){this._stepHeight=e,this._constructCharacter()}},{key:"upAxis",get:function(){return this._upAxis},set:function(e){this._upAxis=e,this._constructCharacter()}}],[{key:"__init__",value:function(){t._btTempVector30=I._bullet.btVector3_create(0,0,0)}}]),t}();wn.UPAXIS_X=0,wn.UPAXIS_Y=1,wn.UPAXIS_Z=2;var Fn=function(e){function t(e,n){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r._isTrigger=!1,r}return _inherits(t,sn),_createClass(t,[{key:"_onAdded",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onAdded",this).call(this),this.isTrigger=this._isTrigger}},{key:"_cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_cloneTo",this).call(this,e),e.isTrigger=this._isTrigger}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e;var t=I._bullet;if(this._btColliderObject){var n=t.btCollisionObject_getCollisionFlags(this._btColliderObject);e?0==(n&sn.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,n|sn.COLLISIONFLAGS_NO_CONTACT_RESPONSE):0!=(n&sn.COLLISIONFLAGS_NO_CONTACT_RESPONSE)&&t.btCollisionObject_setCollisionFlags(this._btColliderObject,n^sn.COLLISIONFLAGS_NO_CONTACT_RESPONSE)}}}]),t}(),Bn=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ot.COLLISIONFILTERGROUP_DEFAULTFILTER,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ot.COLLISIONFILTERGROUP_ALLFILTER;_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r._enableProcessCollisions=!1,r}return _inherits(t,Fn),_createClass(t,[{key:"_addToSimulation",value:function(){this._simulation._addPhysicsCollider(this,this._collisionGroup,this._canCollideWith)}},{key:"_removeFromSimulation",value:function(){this._simulation._removePhysicsCollider(this)}},{key:"_onTransformChanged",value:function(e){(e&=se.TRANSFORM_WORLDPOSITION|se.TRANSFORM_WORLDQUATERNION|se.TRANSFORM_WORLDSCALE)&&(this._transformFlag|=e,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this))}},{key:"_parse",value:function(e){null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_parse",this).call(this,e),this._parseShape(e.shapes)}},{key:"_onAdded",value:function(){var e=I._bullet,n=e.btCollisionObject_create();e.btCollisionObject_setUserIndex(n,this.id),e.btCollisionObject_forceActivationState(n,sn.ACTIVATIONSTATE_DISABLE_SIMULATION);var r=e.btCollisionObject_getCollisionFlags(n);this.owner.isStatic?((r&sn.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(r^=sn.COLLISIONFLAGS_KINEMATIC_OBJECT),r|=sn.COLLISIONFLAGS_STATIC_OBJECT):((r&sn.COLLISIONFLAGS_STATIC_OBJECT)>0&&(r^=sn.COLLISIONFLAGS_STATIC_OBJECT),r|=sn.COLLISIONFLAGS_KINEMATIC_OBJECT),e.btCollisionObject_setCollisionFlags(n,r),this._btColliderObject=n,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onAdded",this).call(this)}}]),t}(),Un=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ot.COLLISIONFILTERGROUP_DEFAULTFILTER,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ot.COLLISIONFILTERGROUP_ALLFILTER;_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return r._isKinematic=!1,r._mass=1,r._gravity=new a(0,-10,0),r._angularDamping=0,r._linearDamping=0,r._overrideGravity=!1,r._totalTorque=new a(0,0,0),r._totalForce=new a(0,0,0),r._linearVelocity=new a,r._angularVelocity=new a,r._linearFactor=new a(1,1,1),r._angularFactor=new a(1,1,1),r._detectCollisions=!0,r}return _inherits(t,Fn),_createClass(t,[{key:"_updateMass",value:function(e){if(this._btColliderObject&&this._colliderShape){var n=I._bullet;n.btCollisionShape_calculateLocalInertia(this._colliderShape._btShape,e,t._btInertia),n.btRigidBody_setMassProps(this._btColliderObject,e,t._btInertia),n.btRigidBody_updateInertiaTensor(this._btColliderObject)}}},{key:"_onScaleChange",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onScaleChange",this).call(this,e),this._updateMass(this._isKinematic?0:this._mass)}},{key:"_onAdded",value:function(){var e=I._bullet,n=e.layaMotionState_create();e.layaMotionState_set_rigidBodyID(n,this._id),this._btLayaMotionState=n;var r=e.btRigidBodyConstructionInfo_create(0,n,null,t._btVector3Zero),i=e.btRigidBody_create(r);e.btCollisionObject_setUserIndex(i,this.id),this._btColliderObject=i,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onAdded",this).call(this),this.mass=this._mass,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.overrideGravity=this._overrideGravity,this.gravity=this._gravity,this.isKinematic=this._isKinematic,e.btRigidBodyConstructionInfo_destroy(r)}},{key:"_onShapeChange",value:function(e){if(_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onShapeChange",this).call(this,e),this._isKinematic)this._updateMass(0);else{var n=I._bullet;n.btRigidBody_setCenterOfMassTransform(this._btColliderObject,n.btCollisionObject_getWorldTransform(this._btColliderObject)),this._updateMass(this._mass)}}},{key:"_parse",value:function(e){null!=e.friction&&(this.friction=e.friction),null!=e.rollingFriction&&(this.rollingFriction=e.rollingFriction),null!=e.restitution&&(this.restitution=e.restitution),null!=e.isTrigger&&(this.isTrigger=e.isTrigger),null!=e.mass&&(this.mass=e.mass),null!=e.isKinematic&&(this.isKinematic=e.isKinematic),null!=e.linearDamping&&(this.linearDamping=e.linearDamping),null!=e.angularDamping&&(this.angularDamping=e.angularDamping),null!=e.overrideGravity&&(this.overrideGravity=e.overrideGravity),e.gravity&&(this.gravity.fromArray(e.gravity),this.gravity=this.gravity),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_parse",this).call(this,e),this._parseShape(e.shapes)}},{key:"_onDestroy",value:function(){I._bullet.btMotionState_destroy(this._btLayaMotionState),_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onDestroy",this).call(this),this._btLayaMotionState=null,this._gravity=null,this._totalTorque=null,this._linearVelocity=null,this._angularVelocity=null,this._linearFactor=null,this._angularFactor=null}},{key:"_addToSimulation",value:function(){this._simulation._addRigidBody(this,this._collisionGroup,this._detectCollisions?this._canCollideWith:0)}},{key:"_removeFromSimulation",value:function(){this._simulation._removeRigidBody(this)}},{key:"_cloneTo",value:function(e){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_cloneTo",this).call(this,e);var n=e;n.isKinematic=this._isKinematic,n.mass=this._mass,n.gravity=this._gravity,n.angularDamping=this._angularDamping,n.linearDamping=this._linearDamping,n.overrideGravity=this._overrideGravity,n.linearVelocity=this._linearVelocity,n.angularVelocity=this._angularVelocity,n.linearFactor=this._linearFactor,n.angularFactor=this._angularFactor,n.detectCollisions=this._detectCollisions}},{key:"applyForce",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var r=I._bullet,i=t._btTempVector30;if(r.btVector3_setValue(i,-e.x,e.y,e.z),n){var a=t._btTempVector31;r.btVector3_setValue(a,-n.x,n.y,n.z),r.btRigidBody_applyForce(this._btColliderObject,i,a)}else r.btRigidBody_applyCentralForce(this._btColliderObject,i)}},{key:"applyTorque",value:function(e){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var n=I._bullet,r=t._btTempVector30;n.btVector3_setValue(r,-e.x,e.y,e.z),n.btRigidBody_applyTorque(this._btColliderObject,r)}},{key:"applyImpulse",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var r=I._bullet;r.btVector3_setValue(t._btImpulse,-e.x,e.y,e.z),n?(r.btVector3_setValue(t._btImpulseOffset,-n.x,n.y,n.z),r.btRigidBody_applyImpulse(this._btColliderObject,t._btImpulse,t._btImpulseOffset)):r.btRigidBody_applyCentralImpulse(this._btColliderObject,t._btImpulse)}},{key:"applyTorqueImpulse",value:function(e){if(null==this._btColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var n=I._bullet,r=t._btTempVector30;n.btVector3_setValue(r,-e.x,e.y,e.z),n.btRigidBody_applyTorqueImpulse(this._btColliderObject,r)}},{key:"wakeUp",value:function(){this._btColliderObject&&I._bullet.btCollisionObject_activate(this._btColliderObject,!1)}},{key:"clearForces",value:function(){var e=this._btColliderObject;if(null==e)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var n=I._bullet;n.btRigidBody_clearForces(e);var r=t._btVector3Zero;n.btCollisionObject_setInterpolationLinearVelocity(e,r),n.btRigidBody_setLinearVelocity(e,r),n.btCollisionObject_setInterpolationAngularVelocity(e,r),n.btRigidBody_setAngularVelocity(e,r)}},{key:"mass",get:function(){return this._mass},set:function(e){e=Math.max(e,1e-7),this._mass=e,this._isKinematic||this._updateMass(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e;var n=I._bullet,r=!!(this._simulation&&this._enabled&&this._colliderShape);r&&this._removeFromSimulation();var i=this._btColliderObject,a=n.btCollisionObject_getCollisionFlags(i);e?(a|=sn.COLLISIONFLAGS_KINEMATIC_OBJECT,n.btCollisionObject_setCollisionFlags(i,a),n.btCollisionObject_forceActivationState(this._btColliderObject,sn.ACTIVATIONSTATE_DISABLE_DEACTIVATION),this._enableProcessCollisions=!1,this._updateMass(0)):((a&sn.COLLISIONFLAGS_KINEMATIC_OBJECT)>0&&(a^=sn.COLLISIONFLAGS_KINEMATIC_OBJECT),n.btCollisionObject_setCollisionFlags(i,a),n.btCollisionObject_setActivationState(this._btColliderObject,sn.ACTIVATIONSTATE_ACTIVE_TAG),this._enableProcessCollisions=!0,this._updateMass(this._mass));var o=t._btVector3Zero;n.btCollisionObject_setInterpolationLinearVelocity(i,o),n.btRigidBody_setLinearVelocity(i,o),n.btCollisionObject_setInterpolationAngularVelocity(i,o),n.btRigidBody_setAngularVelocity(i,o),r&&this._addToSimulation()}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._btColliderObject&&I._bullet.btRigidBody_setDamping(this._btColliderObject,e,this._angularDamping)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._btColliderObject&&I._bullet.btRigidBody_setDamping(this._btColliderObject,this._linearDamping,e)}},{key:"overrideGravity",get:function(){return this._overrideGravity},set:function(e){this._overrideGravity=e;var n=I._bullet;if(this._btColliderObject){var r=n.btRigidBody_getFlags(this._btColliderObject);e?0==(r&t._BT_DISABLE_WORLD_GRAVITY)&&n.btRigidBody_setFlags(this._btColliderObject,r|t._BT_DISABLE_WORLD_GRAVITY):(r&t._BT_DISABLE_WORLD_GRAVITY)>0&&n.btRigidBody_setFlags(this._btColliderObject,r^t._BT_DISABLE_WORLD_GRAVITY)}}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity=e;var n=I._bullet;n.btVector3_setValue(t._btGravity,-e.x,e.y,e.z),n.btRigidBody_setGravity(this._btColliderObject,t._btGravity)}},{key:"totalForce",get:function(){if(this._btColliderObject){var e=I._bullet.btRigidBody_getTotalForce(this._btColliderObject);return A._convertToLayaVec3(e,this._totalForce,!0),this._totalForce}return null}},{key:"linearFactor",get:function(){return this._btColliderObject?this._linearFactor:null},set:function(e){if(this._linearFactor=e,this._btColliderObject){var n=t._btTempVector30;A._convertToBulletVec3(e,n,!1),I._bullet.btRigidBody_setLinearFactor(this._btColliderObject,n)}}},{key:"linearVelocity",get:function(){return this._btColliderObject&&A._convertToLayaVec3(I._bullet.btRigidBody_getLinearVelocity(this._btColliderObject),this._linearVelocity,!0),this._linearVelocity},set:function(e){if(this._linearVelocity=e,this._btColliderObject){var n=t._btTempVector30;A._convertToBulletVec3(e,n,!0),this.isSleeping&&this.wakeUp(),I._bullet.btRigidBody_setLinearVelocity(this._btColliderObject,n)}}},{key:"angularFactor",get:function(){return this._btColliderObject?this._angularFactor:null},set:function(e){if(this._angularFactor=e,this._btColliderObject){var n=t._btTempVector30;A._convertToBulletVec3(e,n,!1),I._bullet.btRigidBody_setAngularFactor(this._btColliderObject,n)}}},{key:"angularVelocity",get:function(){return this._btColliderObject&&A._convertToLayaVec3(I._bullet.btRigidBody_getAngularVelocity(this._btColliderObject),this._angularVelocity,!0),this._angularVelocity},set:function(e){if(this._angularVelocity=e,this._btColliderObject){var n=t._btTempVector30;A._convertToBulletVec3(e,n,!0),this.isSleeping&&this.wakeUp(),I._bullet.btRigidBody_setAngularVelocity(this._btColliderObject,n)}}},{key:"totalTorque",get:function(){if(this._btColliderObject){var e=I._bullet.btRigidBody_getTotalTorque(this._btColliderObject);return A._convertToLayaVec3(e,this._totalTorque,!0),this._totalTorque}return null}},{key:"detectCollisions",get:function(){return this._detectCollisions},set:function(e){this._detectCollisions!==e&&(this._detectCollisions=e,this._colliderShape&&this._enabled&&this._simulation&&(this._simulation._removeRigidBody(this),this._simulation._addRigidBody(this,this._collisionGroup,e?this._canCollideWith:0)))}},{key:"isSleeping",get:function(){return!!this._btColliderObject&&I._bullet.btCollisionObject_getActivationState(this._btColliderObject)===sn.ACTIVATIONSTATE_ISLAND_SLEEPING}},{key:"sleepLinearVelocity",get:function(){return I._bullet.btRigidBody_getLinearSleepingThreshold(this._btColliderObject)},set:function(e){var t=I._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,e,t.btRigidBody_getAngularSleepingThreshold(this._btColliderObject))}},{key:"sleepAngularVelocity",get:function(){return I._bullet.btRigidBody_getAngularSleepingThreshold(this._btColliderObject)},set:function(e){var t=I._bullet;t.btRigidBody_setSleepingThresholds(this._btColliderObject,t.btRigidBody_getLinearSleepingThreshold(this._btColliderObject),e)}}],[{key:"__init__",value:function(){var e=I._bullet;t._btTempVector30=e.btVector3_create(0,0,0),t._btTempVector31=e.btVector3_create(0,0,0),t._btVector3Zero=e.btVector3_create(0,0,0),t._btInertia=e.btVector3_create(0,0,0),t._btImpulse=e.btVector3_create(0,0,0),t._btImpulseOffset=e.btVector3_create(0,0,0),t._btGravity=e.btVector3_create(0,0,0)}}]),t}();Un.TYPE_STATIC=0,Un.TYPE_DYNAMIC=1,Un.TYPE_KINEMATIC=2,Un._BT_DISABLE_WORLD_GRAVITY=1,Un._BT_ENABLE_GYROPSCOPIC_FORCE=2;var Gn=function(e){function t(e,n){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));r._normal=e,r._offset=n,r._type=Jt.SHAPETYPES_STATICPLANE;var i=I._bullet;return i.btVector3_setValue(t._btNormal,-e.x,e.y,e.z),r._btShape=i.btStaticPlaneShape_create(t._btNormal,n),r}return _inherits(t,Jt),_createClass(t,null,[{key:"__init__",value:function(){t._btNormal=I._bullet.btVector3_create(0,0,0)}}]),_createClass(t,[{key:"clone",value:function(){var e=new t(this._normal,this._offset);return this.cloneTo(e),e}}]),t}(),zn=function(n){function r(e){_classCallCheck(this,r);var t=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return t._id=++r._uniqueIDCounter,t._mesh=e,t._boneIndicesList=[],t._subIndexBufferStart=[],t._subIndexBufferCount=[],t}return _inherits(r,de),_createClass(r,[{key:"_setIndexRange",value:function(e,t){this._indexStart=e,this._indexCount=t,this._indices=new Uint16Array(this._indexBuffer.getData().buffer,2*e,t)}},{key:"_getType",value:function(){return r._type}},{key:"_prepareRender",value:function(e){return this._mesh._uploadVerticesData(),!0}},{key:"_render",value:function(n){var r=this._mesh;if(r.indexFormat!==e.IndexFormat.UInt32||t.LayaGL.layaGPUInstance.supportElementIndexUint32()){var i,a=t.LayaGL.instance,o=n.renderElement.render._skinnedData;switch(r.indexFormat){case e.IndexFormat.UInt32:i=a.UNSIGNED_INT;break;case e.IndexFormat.UInt16:i=a.UNSIGNED_SHORT;break;case e.IndexFormat.UInt8:i=a.UNSIGNED_BYTE}if(r._bufferState.bind(),o)for(var s=o[this._indexInMesh],l=0,_=this._boneIndicesList.length;l<_;l++)n.shader.uploadCustomUniform(An.BONES,s[l]),a.drawElements(a.TRIANGLES,this._subIndexBufferCount[l],i,2*this._subIndexBufferStart[l]);else a.drawElements(a.TRIANGLES,this._indexCount,i,2*this._indexStart);t.Stat.trianglesFaces+=this._indexCount/3,t.Stat.renderBatches++}else console.warn("SubMesh:this device do not support IndexFormat.UInt32.")}},{key:"getIndices",value:function(){if(this._mesh._isReadable)return this._indices.slice();throw"SubMesh:can't get indices on subMesh,mesh's isReadable must be true."}},{key:"setIndices",value:function(e){this._indexBuffer.setData(e,this._indexStart,0,this._indexCount)}},{key:"destroy",value:function(){this._destroyed||(_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"destroy",this).call(this),this._indexBuffer.destroy(),this._indexBuffer=null,this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null)}},{key:"indexCount",get:function(){return this._indexCount}}]),r}();zn._uniqueIDCounter=0,zn._type=de._typeCounter++;var Hn=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"parse",value:function(e,t,r,i){n._mesh=r,n._subMeshes=i,n._version=t,n._readData=e,n.READ_DATA(),n.READ_BLOCK(),n.READ_STRINGS();for(var a=0,o=n._BLOCK.count;a<o;a++){n._readData.pos=n._BLOCK.blockStarts[a];var s=n._readData.getUint16(),l=n._strings[s],_=n["READ_"+l];if(null==_)throw new Error("model file err,no this function:"+s+" "+l);_.call(null)}n._mesh._bindPoseIndices=new Uint16Array(n._bindPoseIndices),n._bindPoseIndices.length=0,n._strings.length=0,n._readData=null,n._version=null,n._mesh=null,n._subMeshes=null}},{key:"_readString",value:function(){return n._strings[n._readData.getUint16()]}},{key:"READ_DATA",value:function(){n._DATA.offset=n._readData.getUint32(),n._DATA.size=n._readData.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=n._BLOCK.count=n._readData.getUint16(),t=n._BLOCK.blockStarts=[],r=n._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(n._readData.getUint32()),r.push(n._readData.getUint32())}},{key:"READ_STRINGS",value:function(){var e=n._readData.getUint32(),t=n._readData.getUint16(),r=n._readData.pos;n._readData.pos=e+n._DATA.offset;for(var i=0;i<t;i++)n._strings[i]=n._readData.readUTFString();n._readData.pos=r}},{key:"READ_MESH",value:function(){var r,i=t.LayaGL.instance,a=(n._readString(),n._readData.__getBuffer()),o=0,s=n._readData.getInt16(),l=n._DATA.offset;for(r=0;r<s;r++){var _,u=l+n._readData.getUint32(),c=n._readData.getUint32(),h=a.slice(u,u+c),d=new Float32Array(h),f=n._readString();switch(n._version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":_=Te.getVertexDeclaration(f);break;case"LAYAMODEL:0401":_=Te.getVertexDeclaration(f,!1);break;default:throw new Error("LoadModelV03: unknown version.")}if(!_)throw new Error("LoadModelV03: unknown vertexDeclaration.");var m=new fe(4*d.length,i.STATIC_DRAW,!0);m.vertexDeclaration=_,m.setData(d.buffer),n._mesh._vertexBuffer=m,n._mesh._vertexCount+=m._byteLength/_.vertexStride,o+=4*d.length}var E=l+n._readData.getUint32(),v=n._readData.getUint32(),p=new Uint16Array(a.slice(E,E+v)),g=new Ne(e.IndexFormat.UInt16,v/2,i.STATIC_DRAW,!0);g.setData(p),n._mesh._indexBuffer=g,o+=2*g.indexCount,n._mesh._setBuffer(n._mesh._vertexBuffer,g),n._mesh._setCPUMemory(o),n._mesh._setGPUMemory(o);var y=n._mesh._boneNames=[],S=n._readData.getUint16();for(y.length=S,r=0;r<S;r++)y[r]=n._strings[n._readData.getUint16()];n._readData.pos+=8;var R=n._readData.getUint32(),C=n._readData.getUint32(),I=new Float32Array(a.slice(l+R,l+R+C)),A=I.length,x=n._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*A);for(n._mesh._inverseBindPoses=[],r=0;r<A;r+=16){var D=new T(I[r+0],I[r+1],I[r+2],I[r+3],I[r+4],I[r+5],I[r+6],I[r+7],I[r+8],I[r+9],I[r+10],I[r+11],I[r+12],I[r+13],I[r+14],I[r+15],new Float32Array(x,4*r,16));n._mesh._inverseBindPoses[r/16]=D}return!0}},{key:"READ_SUBMESH",value:function(){var e=n._readData.__getBuffer(),t=new zn(n._mesh);n._readData.getInt16(),n._readData.getUint32(),n._readData.getUint32();var r=n._readData.getUint32(),i=n._readData.getUint32(),a=n._mesh._indexBuffer;t._indexBuffer=a,t._setIndexRange(r,i);var o=n._mesh._vertexBuffer;t._vertexBuffer=o;var s=n._DATA.offset,l=t._subIndexBufferStart,_=t._subIndexBufferCount,u=t._boneIndicesList,c=n._readData.getUint16();l.length=c,_.length=c,u.length=c;for(var h=n._mesh._skinDataPathMarks,d=n._bindPoseIndices,f=n._subMeshes.length,m=0;m<c;m++){l[m]=n._readData.getUint32(),_[m]=n._readData.getUint32();for(var E=n._readData.getUint32(),v=n._readData.getUint32(),T=u[m]=new Uint16Array(e.slice(s+E,s+E+v)),p=0,g=T.length;p<g;p++){var y=T[p],S=d.indexOf(y);-1===S?(T[p]=d.length,d.push(y),h.push([f,m,p])):T[p]=S}}return n._subMeshes.push(t),!0}}]),n}();Hn._BLOCK={count:0},Hn._DATA={offset:0,size:0},Hn._strings=[],Hn._bindPoseIndices=[];var Wn=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"parse",value:function(e,t,r,i){n._mesh=r,n._subMeshes=i,n._version=t,n._readData=e,n.READ_DATA(),n.READ_BLOCK(),n.READ_STRINGS();for(var a=0,o=n._BLOCK.count;a<o;a++){n._readData.pos=n._BLOCK.blockStarts[a];var s=n._readData.getUint16(),l=n._strings[s],_=n["READ_"+l];if(null==_)throw new Error("model file err,no this function:"+s+" "+l);_.call(null)}n._mesh._bindPoseIndices=new Uint16Array(n._bindPoseIndices),n._bindPoseIndices.length=0,n._strings.length=0,n._readData=null,n._version=null,n._mesh=null,n._subMeshes=null}},{key:"_readString",value:function(){return n._strings[n._readData.getUint16()]}},{key:"READ_DATA",value:function(){n._DATA.offset=n._readData.getUint32(),n._DATA.size=n._readData.getUint32()}},{key:"READ_BLOCK",value:function(){for(var e=n._BLOCK.count=n._readData.getUint16(),t=n._BLOCK.blockStarts=[],r=n._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(n._readData.getUint32()),r.push(n._readData.getUint32())}},{key:"READ_STRINGS",value:function(){var e=n._readData.getUint32(),t=n._readData.getUint16(),r=n._readData.pos;n._readData.pos=e+n._DATA.offset;for(var i=0;i<t;i++)n._strings[i]=n._readData.readUTFString();n._readData.pos=r}},{key:"READ_MESH",value:function(){var r,i=t.LayaGL.instance,a=0,o=(n._readString(),n._readData),s=o.__getBuffer(),l=o.getInt16(),_=n._DATA.offset;for(r=0;r<l;r++){var u,c,h,d=_+o.getUint32(),f=o.getUint32(),m=n._readString(),E=Te.getVertexDeclaration(m,!1),v=E.vertexStride,p=m.split(","),g=p.length,S=n._mesh;switch(n._version){case"LAYAMODEL:05":u=s.slice(d,d+f*v),c=new Float32Array(u),h=new Uint8Array(u);break;case"LAYAMODEL:COMPRESSION_05":u=new ArrayBuffer(v*f),c=new Float32Array(u),h=new Uint8Array(u);var R=o.pos;o.pos=d;for(var C=0;C<f;C++)for(var I,A=C*v,x=0;x<g;x++)switch(p[x]){case"POSITION":c[I=A/4]=y.convertToNumber(o.getUint16()),c[I+1]=y.convertToNumber(o.getUint16()),c[I+2]=y.convertToNumber(o.getUint16()),A+=12;break;case"NORMAL":c[I=A/4]=o.getUint8()/127.5-1,c[I+1]=o.getUint8()/127.5-1,c[I+2]=o.getUint8()/127.5-1,A+=12;break;case"COLOR":c[I=A/4]=o.getUint8()/255,c[I+1]=o.getUint8()/255,c[I+2]=o.getUint8()/255,c[I+3]=o.getUint8()/255,A+=16;break;case"UV":case"UV1":c[I=A/4]=y.convertToNumber(o.getUint16()),c[I+1]=y.convertToNumber(o.getUint16()),A+=8;break;case"BLENDWEIGHT":c[I=A/4]=o.getUint8()/255,c[I+1]=o.getUint8()/255,c[I+2]=o.getUint8()/255,c[I+3]=o.getUint8()/255,A+=16;break;case"BLENDINDICES":h[A]=o.getUint8(),h[A+1]=o.getUint8(),h[A+2]=o.getUint8(),h[A+3]=o.getUint8(),A+=4;break;case"TANGENT":c[I=A/4]=o.getUint8()/127.5-1,c[I+1]=o.getUint8()/127.5-1,c[I+2]=o.getUint8()/127.5-1,c[I+3]=o.getUint8()/127.5-1,A+=16}o.pos=R}var D=new fe(u.byteLength,i.STATIC_DRAW,!0);D.vertexDeclaration=E,D.setData(u);f=D._byteLength/E.vertexStride;S._indexFormat=f>65535?e.IndexFormat.UInt32:e.IndexFormat.UInt16,S._vertexBuffer=D,S._vertexCount+=f,a+=4*c.length}var L,M=_+o.getUint32(),O=o.getUint32();L=S.indexFormat==e.IndexFormat.UInt32?new Uint32Array(s.slice(M,M+O)):new Uint16Array(s.slice(M,M+O));var N=new Ne(S.indexFormat,L.length,i.STATIC_DRAW,!0);N.setData(L),S._indexBuffer=N,S._setBuffer(S._vertexBuffer,N),a+=2*N.indexCount,S._setCPUMemory(a),S._setGPUMemory(a);var P=S._boneNames=[],b=o.getUint16();for(P.length=b,r=0;r<b;r++)P[r]=n._strings[o.getUint16()];var V=o.getUint32(),k=o.getUint32(),w=new Float32Array(s.slice(_+V,_+V+k)),F=w.length,B=S._inverseBindPosesBuffer=new ArrayBuffer(4*F);for(S._inverseBindPoses=[],r=0;r<F;r+=16){var U=new T(w[r+0],w[r+1],w[r+2],w[r+3],w[r+4],w[r+5],w[r+6],w[r+7],w[r+8],w[r+9],w[r+10],w[r+11],w[r+12],w[r+13],w[r+14],w[r+15],new Float32Array(B,4*r,16));S._inverseBindPoses[r/16]=U}return!0}},{key:"READ_SUBMESH",value:function(){var e=n._readData,t=e.__getBuffer(),r=new zn(n._mesh);e.getInt16();var i=e.getUint32(),a=e.getUint32(),o=n._mesh._indexBuffer;r._indexBuffer=o,r._setIndexRange(i,a);var s=n._mesh._vertexBuffer;r._vertexBuffer=s;var l=n._DATA.offset,_=r._subIndexBufferStart,u=r._subIndexBufferCount,c=r._boneIndicesList,h=e.getUint16();_.length=h,u.length=h,c.length=h;for(var d=n._mesh._skinDataPathMarks,f=n._bindPoseIndices,m=n._subMeshes.length,E=0;E<h;E++){_[E]=e.getUint32(),u[E]=e.getUint32();for(var v=e.getUint32(),T=e.getUint32(),p=c[E]=new Uint16Array(t.slice(l+v,l+v+T)),g=0,y=p.length;g<y;g++){var S=p[g],R=f.indexOf(S);-1===R?(p[g]=f.length,f.push(S),d.push([m,E,g])):p[g]=R}}return n._subMeshes.push(r),!0}}]),n}();Wn._BLOCK={count:0},Wn._DATA={offset:0,size:0},Wn._strings=[],Wn._bindPoseIndices=[];var Xn=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"read",value:function(e,n,r){var i=new t.Byte(e);i.pos=0;var a=i.readUTFString();switch(a){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":Hn.parse(i,a,n,r);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":Wn.parse(i,a,n,r);break;default:throw new Error("MeshReader: unknown mesh version.")}n._setSubMeshes(r)}}]),e}(),Yn=function(n){function o(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_classCallCheck(this,o);var n=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return n._tempVector30=new a,n._tempVector31=new a,n._tempVector32=new a,n._minVerticesUpdate=-1,n._maxVerticesUpdate=-1,n._needUpdateBounds=!0,n._bounds=new $e(new a,new a),n._bufferState=new Oe,n._instanceBufferState=new Oe,n._vertexBuffer=null,n._indexBuffer=null,n._vertexCount=0,n._indexFormat=e.IndexFormat.UInt16,n._isReadable=t,n._subMeshes=[],n._skinDataPathMarks=[],n}return _inherits(o,t.Resource),_createClass(o,[{key:"_getPositionElement",value:function(e){for(var t=e.vertexDeclaration._vertexElements,n=0,r=t.length;n<r;n++){var i=t[n];if(i._elementFormat===me.Vector3&&i._elementUsage===Te.MESH_POSITION0)return i}return null}},{key:"_getVerticeElementData",value:function(e,t){e.length=this._vertexCount;var n=this._vertexBuffer.vertexDeclaration,o=n.getVertexElementByUsage(t);if(o){var s=this._vertexBuffer.getUint8Data(),l=this._vertexBuffer.getFloat32Data(),_=n.vertexStride,u=_/4,c=o._offset,h=c/4;switch(t){case Te.MESH_TEXTURECOORDINATE0:case Te.MESH_TEXTURECOORDINATE1:for(var d=0;d<this._vertexCount;d++){var f=u*d+h;e[d]=new r(l[f],l[f+1])}break;case Te.MESH_POSITION0:case Te.MESH_NORMAL0:for(d=0;d<this._vertexCount;d++){f=u*d+h;e[d]=new a(l[f],l[f+1],l[f+2])}break;case Te.MESH_TANGENT0:case Te.MESH_BLENDWEIGHT0:for(d=0;d<this._vertexCount;d++){f=u*d+h;e[d]=new i(l[f],l[f+1],l[f+2],l[f+3])}break;case Te.MESH_COLOR0:for(d=0;d<this._vertexCount;d++){f=u*d+h;e[d]=new ae(l[f],l[f+1],l[f+2],l[f+3])}break;case Te.MESH_BLENDINDICES0:for(d=0;d<this._vertexCount;d++){f=_*d+c;e[d]=new i(s[f],s[f+1],s[f+2],s[f+3])}break;default:throw"Mesh:Unknown elementUsage."}}}},{key:"_setVerticeElementData",value:function(e,t){var n=this._vertexBuffer.vertexDeclaration,r=n.getVertexElementByUsage(t);if(r){var i=this._vertexBuffer.getUint8Data(),a=this._vertexBuffer.getFloat32Data(),o=n.vertexStride,s=o/4,l=r._offset,_=l/4;switch(t){case Te.MESH_TEXTURECOORDINATE0:case Te.MESH_TEXTURECOORDINATE1:for(var u=0,c=e.length;u<c;u++){var h=s*u+_,d=e[u];a[h]=d.x,a[h+1]=d.y}break;case Te.MESH_POSITION0:case Te.MESH_NORMAL0:for(u=0,c=e.length;u<c;u++){h=s*u+_;var f=e[u];a[h]=f.x,a[h+1]=f.y,a[h+2]=f.z}break;case Te.MESH_TANGENT0:case Te.MESH_BLENDWEIGHT0:for(u=0,c=e.length;u<c;u++){h=s*u+_;var m=e[u];a[h]=m.x,a[h+1]=m.y,a[h+2]=m.z,a[h+3]=m.w}break;case Te.MESH_COLOR0:for(u=0,c=e.length;u<c;u++){h=s*u+_;var E=e[u];a[h]=E.r,a[h+1]=E.g,a[h+2]=E.b,a[h+2]=E.a}break;case Te.MESH_BLENDINDICES0:for(u=0,c=e.length;u<c;u++){h=o*u+l,m=e[u];i[h]=m.x,i[h+1]=m.y,i[h+2]=m.z,i[h+3]=m.w}break;default:throw"Mesh:Unknown elementUsage."}this._minVerticesUpdate=0,this._maxVerticesUpdate=Number.MAX_SAFE_INTEGER}else console.warn("Mesh: the mesh don't have  this VertexElement.")}},{key:"_disposeResource",value:function(){for(var e=0,t=this._subMeshes.length;e<t;e++)this._subMeshes[e].destroy();this._btTriangleMesh&&I._bullet.btStridingMeshInterface_destroy(this._btTriangleMesh),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._subMeshes=null,this._btTriangleMesh=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null}},{key:"_setSubMeshes",value:function(e){this._subMeshes=e;for(var t=0,n=e.length;t<n;t++)e[t]._indexInMesh=t;this.calculateBounds()}},{key:"_setBuffer",value:function(e,t){var n=this._bufferState;n.bind(),n.applyVertexBuffer(e),n.applyIndexBuffer(t),n.unBind();var r=this._instanceBufferState;r.bind(),r.applyVertexBuffer(e),r.applyInstanceVertexBuffer(pe.instance.instanceWorldMatrixBuffer),r.applyInstanceVertexBuffer(pe.instance.instanceMVPMatrixBuffer),r.applyIndexBuffer(t),r.unBind()}},{key:"_getPhysicMesh",value:function(){if(!this._btTriangleMesh){for(var e=I._bullet,t=e.btTriangleMesh_create(),n=o._nativeTempVector30,r=o._nativeTempVector31,i=o._nativeTempVector32,a=this._tempVector30,s=this._tempVector31,l=this._tempVector32,_=this._vertexBuffer,u=this._getPositionElement(_),c=_.getFloat32Data(),h=_.vertexDeclaration.vertexStride/4,d=u._offset/4,f=this._indexBuffer.getData(),m=0,E=f.length;m<E;m+=3){var v=f[m]*h+d,T=f[m+1]*h+d,p=f[m+2]*h+d;a.setValue(c[v],c[v+1],c[v+2]),s.setValue(c[T],c[T+1],c[T+2]),l.setValue(c[p],c[p+1],c[p+2]),A._convertToBulletVec3(a,n,!0),A._convertToBulletVec3(s,r,!0),A._convertToBulletVec3(l,i,!0),e.btTriangleMesh_addTriangle(t,n,r,i,!0)}this._btTriangleMesh=t}return this._btTriangleMesh}},{key:"_uploadVerticesData",value:function(){var e=this._minVerticesUpdate,t=this._maxVerticesUpdate;if(-1!==e&&-1!==t){var n=e;this._vertexBuffer.setData(this._vertexBuffer.getUint8Data().buffer,n,n,t-e),this._minVerticesUpdate=-1,this._maxVerticesUpdate=-1}}},{key:"getSubMesh",value:function(e){return this._subMeshes[e]}},{key:"getPositions",value:function(e){if(!this._isReadable)throw"Mesh:can't get positions on mesh,isReadable must be true.";this._getVerticeElementData(e,Te.MESH_POSITION0)}},{key:"setPositions",value:function(e){if(!this._isReadable)throw"Mesh:setPosition() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Te.MESH_POSITION0),this._needUpdateBounds=!0}},{key:"getColors",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Te.MESH_COLOR0)}},{key:"setColors",value:function(e){if(!this._isReadable)throw"Mesh:setColors() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Te.MESH_COLOR0)}},{key:"getUVs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._isReadable)throw"Mesh:can't get uvs on mesh,isReadable must be true.";switch(t){case 0:this._getVerticeElementData(e,Te.MESH_TEXTURECOORDINATE0);break;case 1:this._getVerticeElementData(e,Te.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}},{key:"setUVs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this._isReadable)throw"Mesh:setUVs() need isReadable must be true or use setVertices().";switch(t){case 0:this._setVerticeElementData(e,Te.MESH_TEXTURECOORDINATE0);break;case 1:this._setVerticeElementData(e,Te.MESH_TEXTURECOORDINATE1);break;default:throw"Mesh:Invalid channel."}}},{key:"getNormals",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Te.MESH_NORMAL0)}},{key:"setNormals",value:function(e){if(!this._isReadable)throw"Mesh:setNormals() need must be true or use setVertices().";this._setVerticeElementData(e,Te.MESH_NORMAL0)}},{key:"getTangents",value:function(e){if(!this._isReadable)throw"Mesh:can't get colors on mesh,isReadable must be true.";this._getVerticeElementData(e,Te.MESH_TANGENT0)}},{key:"setTangents",value:function(e){if(!this._isReadable)throw"Mesh:setTangents() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Te.MESH_TANGENT0)}},{key:"getBoneWeights",value:function(e){if(!this._isReadable)throw"Mesh:can't get boneWeights on mesh,isReadable must be true.";this._getVerticeElementData(e,Te.MESH_BLENDWEIGHT0)}},{key:"setBoneWeights",value:function(e){if(!this._isReadable)throw"Mesh:setBoneWeights() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Te.MESH_BLENDWEIGHT0)}},{key:"getBoneIndices",value:function(e){if(!this._isReadable)throw"Mesh:can't get boneIndices on mesh,isReadable must be true.";this._getVerticeElementData(e,Te.MESH_BLENDINDICES0)}},{key:"setBoneIndices",value:function(e){if(!this._isReadable)throw"Mesh:setBoneIndices() need isReadable must be true or use setVertices().";this._setVerticeElementData(e,Te.MESH_BLENDINDICES0)}},{key:"markAsUnreadbale",value:function(){this._uploadVerticesData(),this._vertexBuffer.markAsUnreadbale(),this._isReadable=!1}},{key:"getVertexDeclaration",value:function(){return this._vertexBuffer._vertexDeclaration}},{key:"getVertices",value:function(){if(this._isReadable)return this._vertexBuffer.getUint8Data().buffer.slice(0);throw"Mesh:can't get vertices on mesh,isReadable must be true."}},{key:"setVertices",value:function(e){this._vertexBuffer.setData(e),this._needUpdateBounds=!0}},{key:"getIndices",value:function(){if(this._isReadable)return this._indexBuffer.getData().slice();throw"Mesh:can't get indices on subMesh,mesh's isReadable must be true."}},{key:"setIndices",value:function(n){var r;n instanceof Uint32Array?r=e.IndexFormat.UInt32:n instanceof Uint16Array?r=e.IndexFormat.UInt16:n instanceof Uint8Array&&(r=e.IndexFormat.UInt8);var i=this._indexBuffer;this._indexFormat===r&&i.indexCount===n.length||(i.destroy(),this._indexBuffer=i=new Ne(r,n.length,t.LayaGL.instance.STATIC_DRAW,this._isReadable)),i.setData(n),this._indexFormat=r}},{key:"calculateBounds",value:function(){if(!this._isReadable)throw"Mesh:can't calculate bounds on subMesh,mesh's isReadable must be true.";if(this._needUpdateBounds){var e=this._tempVector30,t=this._tempVector31;e.x=e.y=e.z=Number.MAX_VALUE,t.x=t.y=t.z=-Number.MAX_VALUE;for(var n=this._vertexBuffer,r=this._getPositionElement(n),i=n.getFloat32Data(),a=n.vertexDeclaration.vertexStride/4,o=r._offset/4,s=0,l=i.length;s<l;s+=a){var _=s+o,u=i[_],c=i[_+1],h=i[_+2];e.x=Math.min(e.x,u),e.y=Math.min(e.y,c),e.z=Math.min(e.z,h),t.x=Math.max(t.x,u),t.y=Math.max(t.y,c),t.z=Math.max(t.z,h)}this._bounds.setMin(e),this._bounds.setMax(t),this._needUpdateBounds=!1}}},{key:"cloneTo",value:function(t){var n=t,r=this._vertexBuffer,i=new fe(r._byteLength,r.bufferUsage,r.canRead);i.vertexDeclaration=r.vertexDeclaration,i.setData(r.getUint8Data().slice().buffer),n._vertexBuffer=i,n._vertexCount=this._vertexCount;var a,o=this._indexBuffer,s=new Ne(e.IndexFormat.UInt16,o.indexCount,o.bufferUsage,o.canRead);s.setData(o.getData().slice()),n._indexBuffer=s,n._setBuffer(n._vertexBuffer,s),n._setCPUMemory(this.cpuMemory),n._setGPUMemory(this.gpuMemory);var l=this._boneNames,_=n._boneNames=[];for(a=0;a<l.length;a++)_[a]=l[a];var u=this._inverseBindPoses,c=n._inverseBindPoses=[];for(a=0;a<u.length;a++)c[a]=u[a];for(n._bindPoseIndices=new Uint16Array(this._bindPoseIndices),a=0;a<this._skinDataPathMarks.length;a++)n._skinDataPathMarks[a]=this._skinDataPathMarks[a].slice();for(a=0;a<this.subMeshCount;a++){var h=this._subMeshes[a],d=h._subIndexBufferStart,f=h._subIndexBufferCount,m=h._boneIndicesList,E=new zn(n);E._subIndexBufferStart.length=d.length,E._subIndexBufferCount.length=f.length,E._boneIndicesList.length=m.length;for(var v=0;v<d.length;v++)E._subIndexBufferStart[v]=d[v];for(v=0;v<f.length;v++)E._subIndexBufferCount[v]=f[v];for(v=0;v<m.length;v++)E._boneIndicesList[v]=new Uint16Array(m[v]);E._indexBuffer=s,E._indexStart=h._indexStart,E._indexCount=h._indexCount,E._indices=new Uint16Array(s.getData().buffer,2*h._indexStart,h._indexCount);var T=n._vertexBuffer;E._vertexBuffer=T,n._subMeshes.push(E)}n._setSubMeshes(n._subMeshes)}},{key:"clone",value:function(){var e=new o;return this.cloneTo(e),e}},{key:"inverseAbsoluteBindPoses",get:function(){return this._inverseBindPoses}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"indexCount",get:function(){return this._indexBuffer.indexCount}},{key:"subMeshCount",get:function(){return this._subMeshes.length}},{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds!==e&&e.cloneTo(this._bounds)}},{key:"indexFormat",get:function(){return this._indexFormat}}],[{key:"__init__",value:function(){var e=I._bullet;e&&(o._nativeTempVector30=e.btVector3_create(0,0,0),o._nativeTempVector31=e.btVector3_create(0,0,0),o._nativeTempVector32=e.btVector3_create(0,0,0))}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var t=new o;return Xn.read(e,t,t._subMeshes),t}},{key:"load",value:function(e,n){t.ILaya.loader.create(e,n,null,o.MESH)}}]),o}();Yn.MESH="MESH";var jn=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"__init__",value:function(){}},{key:"_createMesh",value:function(n,r,i){var a=t.LayaGL.instance,o=new Yn,s=new zn(o),l=new fe(4*r.length,a.STATIC_DRAW,!0);l.vertexDeclaration=n,l.setData(r.buffer),o._vertexBuffer=l,o._vertexCount=l._byteLength/n.vertexStride;var _=new Ne(e.IndexFormat.UInt16,i.length,a.STATIC_DRAW,!0);_.setData(i),o._indexBuffer=_,o._setBuffer(l,_),s._vertexBuffer=l,s._indexBuffer=_,s._setIndexRange(0,_.indexCount);var u=s._subIndexBufferStart,c=s._subIndexBufferCount,h=s._boneIndicesList;u.length=1,c.length=1,h.length=1,u[0]=0,c[0]=_.indexCount;var d=[];d.push(s),o._setSubMeshes(d);var f=l._byteLength+_._byteLength;return o._setCPUMemory(f),o._setGPUMemory(f),o}},{key:"createBox",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=Te.getVertexDeclaration("POSITION,NORMAL,UV"),a=e/2,o=t/2,s=r/2,l=new Float32Array([-a,o,-s,0,1,0,0,0,a,o,-s,0,1,0,1,0,a,o,s,0,1,0,1,1,-a,o,s,0,1,0,0,1,-a,-o,-s,0,-1,0,0,1,a,-o,-s,0,-1,0,1,1,a,-o,s,0,-1,0,1,0,-a,-o,s,0,-1,0,0,0,-a,o,-s,-1,0,0,0,0,-a,o,s,-1,0,0,1,0,-a,-o,s,-1,0,0,1,1,-a,-o,-s,-1,0,0,0,1,a,o,-s,1,0,0,1,0,a,o,s,1,0,0,0,0,a,-o,s,1,0,0,0,1,a,-o,-s,1,0,0,1,1,-a,o,s,0,0,1,0,0,a,o,s,0,0,1,1,0,a,-o,s,0,0,1,1,1,-a,-o,s,0,0,1,0,1,-a,o,-s,0,0,-1,1,0,a,o,-s,0,0,-1,0,0,a,-o,-s,0,0,-1,0,1,-a,-o,-s,0,0,-1,1,1]),_=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);return n._createMesh(i,l,_)}},{key:"createCapsule",value:function(){var e,t,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:32,s=(a+1)*(o+1)*2+2*(o+1),l=3*a*(o+1)*2*2+2*o*3,_=Te.getVertexDeclaration("POSITION,NORMAL,UV"),u=_.vertexStride/4,c=new Float32Array(s*u),h=new Uint16Array(l),d=Math.PI/2/a,f=2*Math.PI/o,m=i/2-r,E=0,v=0,T=0,p=0,g=0,y=0;for(e=0;e<=a;e++)for(t=0;t<=o;t++)E=r*Math.cos(e*d)*Math.cos(t*f+Math.PI),v=r*Math.sin(e*d),T=r*Math.cos(e*d)*Math.sin(t*f+Math.PI),c[p++]=E,c[p++]=v+m,c[p++]=T,c[p++]=E,c[p++]=v,c[p++]=T,c[p++]=1-t/o,c[p++]=(1-e/a)*(Math.PI*r/2/(i+Math.PI*r)),e<a&&(h[g++]=e*(o+1)+t+(o+1),h[g++]=e*(o+1)+t,h[g++]=e*(o+1)+t+1,h[g++]=e*(o+1)+t+o,h[g++]=e*(o+1)+t,h[g++]=e*(o+1)+t+(o+1));for(y+=(a+1)*(o+1),e=0;e<=a;e++)for(t=0;t<=o;t++)E=r*Math.cos(e*d)*Math.cos(t*f+Math.PI),v=r*Math.sin(-e*d),T=r*Math.cos(e*d)*Math.sin(t*f+Math.PI),c[p++]=E,c[p++]=v-m,c[p++]=T,c[p++]=E,c[p++]=v,c[p++]=T,c[p++]=1-t/o,c[p++]=(e/a*(Math.PI*r/2)+(i+Math.PI*r/2))/(i+Math.PI*r),e<a&&(h[g++]=y+e*(o+1)+t,h[g++]=y+e*(o+1)+t+(o+1),h[g++]=y+e*(o+1)+t+1,h[g++]=y+e*(o+1)+t,h[g++]=y+e*(o+1)+t+o,h[g++]=y+e*(o+1)+t+(o+1));for(y+=(a+1)*(o+1),t=0;t<=o;t++)E=r*Math.cos(t*f+Math.PI),v=m,T=r*Math.sin(t*f+Math.PI),c[p++]=E,c[p+8*(o+1)-1]=E,c[p++]=v,c[p+8*(o+1)-1]=-v,c[p++]=T,c[p+8*(o+1)-1]=T,c[p++]=E,c[p+8*(o+1)-1]=E,c[p++]=0,c[p+8*(o+1)-1]=0,c[p++]=T,c[p+8*(o+1)-1]=T,c[p++]=1-1*t/o,c[p+8*(o+1)-1]=1-1*t/o,c[p++]=Math.PI*r/2/(i+Math.PI*r),c[p+8*(o+1)-1]=(Math.PI*r/2+i)/(i+Math.PI*r);for(t=0;t<o;t++)h[g++]=t+y+(o+1),h[g++]=t+y+1,h[g++]=t+y,h[g++]=t+y+(o+1),h[g++]=t+y+(o+1)+1,h[g++]=t+y+1;return y+=2*(o+1),n._createMesh(_,c,h)}},{key:"createCone",value:function(){for(var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,o=i+1+1+2*(i+1),s=6*i+3*i,l=Te.getVertexDeclaration("POSITION,NORMAL,UV"),_=l.vertexStride/4,u=new Float32Array(o*_),c=new Uint16Array(s),h=2*Math.PI/i,f=r/2,m=0,E=0,v=0,T=0,p=0,g=new a,y=new a(0,-1,0),S=new a(0,f,0),R=new a,C=new a,I=new d,A=new a,x=0,D=0,L=0;L<=i;L++)m=L*h,v=Math.cos(m+Math.PI)*t,T=f,p=Math.sin(m+Math.PI)*t,u[x++]=0,u[x+8*(i+1)-1]=v,u[x++]=T,u[x+8*(i+1)-1]=-T,u[x++]=0,u[x+8*(i+1)-1]=p,g.x=v,g.y=0,g.z=p,R.x=v,R.y=-T,R.z=p,a.subtract(R,S,C),a.normalize(C,C),e=Math.acos(a.dot(y,C)),a.cross(y,C,A),a.normalize(A,A),d.createFromAxisAngle(A,e,I),a.normalize(g,g),a.transformQuat(g,I,g),a.normalize(g,g),u[x++]=g.x,u[x+8*(i+1)-1]=g.x,u[x++]=g.y,u[x+8*(i+1)-1]=g.y,u[x++]=g.z,u[x+8*(i+1)-1]=g.z,u[x++]=1-1*L/i,u[x+8*(i+1)-1]=1-1*L/i,u[x++]=0,u[x+8*(i+1)-1]=1;x+=8*(i+1);for(var M=0;M<i;M++)c[D++]=M+E+(i+1),c[D++]=M+E+1,c[D++]=M+E,c[D++]=M+E+(i+1),c[D++]=M+E+(i+1)+1,c[D++]=M+E+1;E+=2*(i+1);for(var O=0;O<=i;O++)0===O&&(u[x++]=0,u[x++]=-f,u[x++]=0,u[x++]=0,u[x++]=-1,u[x++]=0,u[x++]=.5,u[x++]=.5),m=O*h,v=Math.cos(m+Math.PI)*t,T=-f,p=Math.sin(m+Math.PI)*t,u[x++]=v,u[x++]=T,u[x++]=p,u[x++]=0,u[x++]=-1,u[x++]=0,u[x++]=.5+.5*Math.cos(m),u[x++]=.5+.5*Math.sin(m);for(var N=0;N<i;N++)c[D++]=0+E,c[D++]=N+2+E,c[D++]=N+1+E;return E+=i+1+1,n._createMesh(l,u,c)}},{key:"createCylinder",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,i=r+1+1+2*(r+1)+(r+1+1),a=3*r+6*r+3*r,o=Te.getVertexDeclaration("POSITION,NORMAL,UV"),s=o.vertexStride/4,l=new Float32Array(i*s),_=new Uint16Array(a),u=2*Math.PI/r,c=t/2,h=0,d=0,f=0,m=0,E=0,v=0,T=0,p=0;p<=r;p++)0===p&&(l[v++]=0,l[v++]=c,l[v++]=0,l[v++]=0,l[v++]=1,l[v++]=0,l[v++]=.5,l[v++]=.5),h=p*u,f=Math.cos(h)*e,m=c,E=Math.sin(h)*e,l[v++]=f,l[v++]=m,l[v++]=E,l[v++]=0,l[v++]=1,l[v++]=0,l[v++]=.5+.5*Math.cos(h),l[v++]=.5+.5*Math.sin(h);for(var g=0;g<r;g++)_[T++]=0,_[T++]=g+1,_[T++]=g+2;d+=r+1+1;for(var y=0;y<=r;y++)h=y*u,f=Math.cos(h+Math.PI)*e,m=c,E=Math.sin(h+Math.PI)*e,l[v++]=f,l[v+8*(r+1)-1]=f,l[v++]=m,l[v+8*(r+1)-1]=-m,l[v++]=E,l[v+8*(r+1)-1]=E,l[v++]=f,l[v+8*(r+1)-1]=f,l[v++]=0,l[v+8*(r+1)-1]=0,l[v++]=E,l[v+8*(r+1)-1]=E,l[v++]=1-1*y/r,l[v+8*(r+1)-1]=1-1*y/r,l[v++]=0,l[v+8*(r+1)-1]=1;v+=8*(r+1);for(var S=0;S<r;S++)_[T++]=S+d+(r+1),_[T++]=S+d+1,_[T++]=S+d,_[T++]=S+d+(r+1),_[T++]=S+d+(r+1)+1,_[T++]=S+d+1;d+=2*(r+1);for(var R=0;R<=r;R++)0===R&&(l[v++]=0,l[v++]=-c,l[v++]=0,l[v++]=0,l[v++]=-1,l[v++]=0,l[v++]=.5,l[v++]=.5),h=R*u,f=Math.cos(h+Math.PI)*e,m=-c,E=Math.sin(h+Math.PI)*e,l[v++]=f,l[v++]=m,l[v++]=E,l[v++]=0,l[v++]=-1,l[v++]=0,l[v++]=.5+.5*Math.cos(h),l[v++]=.5+.5*Math.sin(h);for(var C=0;C<r;C++)_[T++]=0+d,_[T++]=C+2+d,_[T++]=C+1+d;return d+=r+1+1,n._createMesh(o,l,_)}},{key:"createPlane",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,a=(r+1)*(i+1),o=new Uint16Array(r*i*2*3),s=Te.getVertexDeclaration("POSITION,NORMAL,UV"),l=s.vertexStride/4,_=new Float32Array(a*l),u=e/2,c=t/2,h=e/r,d=t/i,f=0,m=0;m<=i;m++)for(var E=0;E<=r;E++)_[f++]=E*h-u,_[f++]=0,_[f++]=m*d-c,_[f++]=0,_[f++]=1,_[f++]=0,_[f++]=1*E/r,_[f++]=1*m/i;var v=0;for(m=0;m<i;m++)for(E=0;E<r;E++)o[v++]=(m+1)*(r+1)+E,o[v++]=m*(r+1)+E,o[v++]=(m+1)*(r+1)+E+1,o[v++]=m*(r+1)+E,o[v++]=m*(r+1)+E+1,o[v++]=(m+1)*(r+1)+E+1;return n._createMesh(s,_,o)}},{key:"createQuad",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=Te.getVertexDeclaration("POSITION,NORMAL,UV"),i=e/2,a=t/2,o=new Float32Array([-i,a,0,0,0,1,0,0,i,a,0,0,0,1,1,0,-i,-a,0,0,0,1,0,1,i,-a,0,0,0,1,1,1]),s=new Uint16Array([0,1,2,3,2,1]);return n._createMesh(r,o,s)}},{key:"createSphere",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:32,i=(t+1)*(r+1),a=3*t*(r+1)*2,o=new Uint16Array(a),s=Te.getVertexDeclaration("POSITION,NORMAL,UV"),l=s.vertexStride/4,_=new Float32Array(i*l),u=Math.PI/t,c=2*Math.PI/r,h=0;i=0,a=0;for(var d=0;d<t+1;d++)for(var f=Math.sin(d*u),m=Math.cos(d*u),E=0;E<r+1;E++){var v=f*Math.sin(E*c+1*Math.PI/2),T=f*Math.cos(E*c+1*Math.PI/2);_[i+0]=v*e,_[i+1]=m*e,_[i+2]=T*e,_[i+3]=v,_[i+4]=m,_[i+5]=T,_[i+6]=E/r,_[i+7]=d/t,i+=l,d!=t-1&&(o[a++]=h+(r+1),o[a++]=h,o[a++]=h+1,o[a++]=h+r,o[a++]=h,o[a++]=h+(r+1),h++)}return n._createMesh(s,_,o)}}]),n}(),Zn=function(e){function n(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.TextureFormat.R8G8B8,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];_classCallCheck(this,n);var a=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,r,i));a._glTextureType=t.LayaGL.instance.TEXTURE_CUBE_MAP,a._width=e,a._height=e;var o=t.LayaGL.instance;if(a._setWarpMode(o.TEXTURE_WRAP_S,a._wrapModeU),a._setWarpMode(o.TEXTURE_WRAP_T,a._wrapModeV),a._setFilterMode(a._filterMode),a._setAnisotropy(a._anisoLevel),a._mipmap){a._mipmapCount=Math.ceil(Math.log2(e));for(var s=0;s<a._mipmapCount;s++)a._setPixels([],s,Math.max(e>>s,1),Math.max(e>>s,1));a._setGPUMemory(e*e*4*(1+1/3)*6)}else a._mipmapCount=1,a._setGPUMemory(e*e*4*6);return a}return _inherits(n,t.BaseTexture),_createClass(n,[{key:"_setPixels",value:function(e,n,r,i){var a=t.LayaGL.instance,o=this._getGLFormat();t.WebGLContext.bindTexture(a,this._glTextureType,this._glTexture),this.format===t.TextureFormat.R8G8B8?(a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[0]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[1]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[2]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[3]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[4]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[5]),a.pixelStorei(a.UNPACK_ALIGNMENT,4)):(a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[0]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[1]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[2]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[3]),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[4]),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,n,o,r,i,0,o,a.UNSIGNED_BYTE,e[5]))}},{key:"setSixSideImageSources",value:function(e){for(var n,r,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=0;a<6;a++){var o=e[a];if(!o)return void console.log("TextureCube: image Source can't be null.");var s=o.width,l=o.height;if(a>0&&n!==s)return void console.log("TextureCube: each side image's width and height must same.");if((n=s)!==(r=l))return void console.log("TextureCube: each side image's width and height must same.")}this._width=n,this._height=r;var _=t.LayaGL.instance;t.WebGLContext.bindTexture(_,this._glTextureType,this._glTexture);var u=this._getGLFormat();if(t.Render.isConchApp){if(1==i)for(var c=0;c<6;c++)e[c].setPremultiplyAlpha(i);_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_Z,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[0]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[1]),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[2]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_X,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[3]),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_Y,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[4]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,e[5])}else i&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_Z,0,u,u,_.UNSIGNED_BYTE,e[0]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,u,u,_.UNSIGNED_BYTE,e[1]),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X,0,u,u,_.UNSIGNED_BYTE,e[2]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_X,0,u,u,_.UNSIGNED_BYTE,e[3]),_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_Y,0,u,u,_.UNSIGNED_BYTE,e[4]),_.texImage2D(_.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,u,u,_.UNSIGNED_BYTE,e[5]),i&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);this._mipmap&&this._isPot(n)&&this._isPot(r)?(_.generateMipmap(this._glTextureType),this._setGPUMemory(n*r*4*(1+1/3)*6)):this._setGPUMemory(n*r*4*6),this._setWarpMode(_.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(_.TEXTURE_WRAP_T,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource()}},{key:"setSixSidePixels",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!e)throw new Error("TextureCube:pixels can't be null.");var r=Math.max(this._width>>n,1),i=Math.max(this._height>>n,1),a=r*i*this._getFormatByteCount();if(e[0].length<a)throw"TextureCube:pixels length should at least "+a+".";if(this._setPixels(e,n,r,i),0===n){var o=t.LayaGL.instance;this._setWarpMode(o.TEXTURE_WRAP_S,this._wrapModeU),this._setWarpMode(o.TEXTURE_WRAP_T,this._wrapModeV)}this._readyed=!0,this._activeResource()}},{key:"_recoverResource",value:function(){}},{key:"defaulteTexture",get:function(){return n.grayTexture}}],[{key:"__init__",value:function(){var e=new Uint8Array(3);e[0]=128,e[1]=128,e[2]=128,n.grayTexture=new n(1,t.TextureFormat.R8G8B8,!1),n.grayTexture.setSixSidePixels([e,e,e,e,e,e]),n.grayTexture.lock=!0}},{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1];var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=t?new n(0,t[0],t[1]):new n(0);return r.setSixSideImageSources(e),r}},{key:"load",value:function(e,r){t.ILaya.loader.create(e,r,null,n.TEXTURECUBE)}}]),n}();Zn.TEXTURECUBE="TEXTURECUBE";var qn='#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}',Qn=function e(){_classCallCheck(this,e),this.textureID=-1},Kn=function(e){function n(e,t,r,i,a){_classCallCheck(this,n);var o=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return o._stateParamsMap=[],o._uploadMark=-1,o._uploadRenderType=-1,o._vs=e,o._ps=t,o._attributeMap=r,o._uniformMap=i,o._shaderPass=a,o._create(),o.lock=!0,o}return _inherits(n,t.Resource),_createClass(n,[{key:"_create",value:function(){var e=t.LayaGL.instance;for(var n in this._program=e.createProgram(),this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.attachShader(this._program,this._vshader),e.attachShader(this._program,this._pshader),this._attributeMap)e.bindAttribLocation(this._program,this._attributeMap[n],n);if(e.linkProgram(this._program),!t.Render.isConchApp&&U.debugMode&&!e.getProgramParameter(this._program,e.LINK_STATUS))throw e.getProgramInfoLog(this._program);var r=[],i=[],a=[],o=[],s=[];this._customUniformParamsMap=[];var l,_,u,c=e.getProgramParameter(this._program,e.ACTIVE_UNIFORMS);for(t.WebGLContext.useProgram(e,this._program),this._curActTexIndex=0,_=0;_<c;_++){var h=e.getActiveUniform(this._program,_),d=h.name;(l=new Qn).location=e.getUniformLocation(this._program,d),d.indexOf("[0]")>0?(l.name=d=d.substr(0,d.length-3),l.isArray=!0):(l.name=d,l.isArray=!1),l.type=h.type,this._addShaderUnifiormFun(l);var f=this._uniformMap[d];if(null!=f)switch(l.dataOffset=U.propertyNameToID(d),f){case U.PERIOD_CUSTOM:s.push(l);break;case U.PERIOD_MATERIAL:o.push(l);break;case U.PERIOD_SPRITE:a.push(l);break;case U.PERIOD_CAMERA:i.push(l);break;case U.PERIOD_SCENE:r.push(l);break;default:throw new Error("Shader3D: period is unkonw.")}}for(this._sceneUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*r.length*5+4,64,!0),_=0,u=r.length;_<u;_++)this._sceneUniformParamsMap.addShaderUniform(r[_]);for(this._cameraUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*i.length*5+4,64,!0),_=0,u=i.length;_<u;_++)this._cameraUniformParamsMap.addShaderUniform(i[_]);for(this._spriteUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*a.length*5+4,64,!0),_=0,u=a.length;_<u;_++)this._spriteUniformParamsMap.addShaderUniform(a[_]);for(this._materialUniformParamsMap=t.LayaGL.instance.createCommandEncoder(4*o.length*5+4,64,!0),_=0,u=o.length;_<u;_++)this._materialUniformParamsMap.addShaderUniform(o[_]);for(this._customUniformParamsMap.length=s.length,_=0,u=s.length;_<u;_++){var m=s[_];this._customUniformParamsMap[m.dataOffset]=m}var E=this._shaderPass._stateMap;for(var v in E)this._stateParamsMap[E[v]]=U.propertyNameToID(v)}},{key:"_getRenderState",value:function(e,t){var n=this._stateParamsMap[t];return null==n?null:e[n]}},{key:"_disposeResource",value:function(){t.LayaGL.instance.deleteShader(this._vshader),t.LayaGL.instance.deleteShader(this._pshader),t.LayaGL.instance.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._setGPUMemory(0),this._curActTexIndex=0}},{key:"_addShaderUnifiormFun",value:function(e){var n=t.LayaGL.instance;e.caller=this;var r=e.isArray;switch(e.type){case n.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case n.INT:e.fun=r?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case n.FLOAT:e.fun=r?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case n.FLOAT_VEC2:e.fun=r?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case n.FLOAT_VEC3:e.fun=r?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case n.FLOAT_VEC4:e.fun=r?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case n.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case n.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case n.FLOAT_MAT4:e.fun=r?this._uniformMatrix4fv:this._uniformMatrix4f;break;case n.SAMPLER_2D:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case 35679:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case n.SAMPLER_CUBE:n.uniform1i(e.location,this._curActTexIndex),e.textureID=t.WebGLContext._glTextureIDs[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;default:throw new Error("compile shader err!")}}},{key:"_createShader",value:function(e,t,n){var r=e.createShader(n);if(e.shaderSource(r,t),e.compileShader(r),U.debugMode&&!e.getShaderParameter(r,e.COMPILE_STATUS))throw e.getShaderInfoLog(r);return r}},{key:"_uniform1f",value:function(e,n){var r=e.uploadedValue;return r[0]!==n?(t.LayaGL.instance.uniform1f(e.location,r[0]=n),1):0}},{key:"_uniform1fv",value:function(e,n){if(n.length<4){var r=e.uploadedValue;return r[0]!==n[0]||r[1]!==n[1]||r[2]!==n[2]||r[3]!==n[3]?(t.LayaGL.instance.uniform1fv(e.location,n),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],1):0}return t.LayaGL.instance.uniform1fv(e.location,n),1}},{key:"_uniform_vec2",value:function(e,n){var r=e.uploadedValue;return r[0]!==n.x||r[1]!==n.y?(t.LayaGL.instance.uniform2f(e.location,r[0]=n.x,r[1]=n.y),1):0}},{key:"_uniform_vec2v",value:function(e,n){if(n.length<2){var r=e.uploadedValue;return r[0]!==n[0]||r[1]!==n[1]||r[2]!==n[2]||r[3]!==n[3]?(t.LayaGL.instance.uniform2fv(e.location,n),r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],1):0}return t.LayaGL.instance.uniform2fv(e.location,n),1}},{key:"_uniform_vec3",value:function(e,n){var r=e.uploadedValue;return r[0]!==n.x||r[1]!==n.y||r[2]!==n.z?(t.LayaGL.instance.uniform3f(e.location,r[0]=n.x,r[1]=n.y,r[2]=n.z),1):0}},{key:"_uniform_vec3v",value:function(e,n){return t.LayaGL.instance.uniform3fv(e.location,n),1}},{key:"_uniform_vec4",value:function(e,n){var r=e.uploadedValue;return r[0]!==n.x||r[1]!==n.y||r[2]!==n.z||r[3]!==n.w?(t.LayaGL.instance.uniform4f(e.location,r[0]=n.x,r[1]=n.y,r[2]=n.z,r[3]=n.w),1):0}},{key:"_uniform_vec4v",value:function(e,n){return t.LayaGL.instance.uniform4fv(e.location,n),1}},{key:"_uniformMatrix2fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix2fv(e.location,!1,n),1}},{key:"_uniformMatrix3fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix3fv(e.location,!1,n),1}},{key:"_uniformMatrix4f",value:function(e,n){var r=n.elements;return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,r),1}},{key:"_uniformMatrix4fv",value:function(e,n){return t.LayaGL.instance.uniformMatrix4fv(e.location,!1,n),1}},{key:"_uniform1i",value:function(e,n){var r=e.uploadedValue;return r[0]!==n?(t.LayaGL.instance.uniform1i(e.location,r[0]=n),1):0}},{key:"_uniform1iv",value:function(e,n){return t.LayaGL.instance.uniform1iv(e.location,n),1}},{key:"_uniform_ivec2",value:function(e,n){var r=e.uploadedValue;return r[0]!==n[0]||r[1]!==n[1]?(t.LayaGL.instance.uniform2i(e.location,r[0]=n[0],r[1]=n[1]),1):0}},{key:"_uniform_ivec2v",value:function(e,n){return t.LayaGL.instance.uniform2iv(e.location,n),1}},{key:"_uniform_vec3i",value:function(e,n){var r=e.uploadedValue;return r[0]!==n[0]||r[1]!==n[1]||r[2]!==n[2]?(t.LayaGL.instance.uniform3i(e.location,r[0]=n[0],r[1]=n[1],r[2]=n[2]),1):0}},{key:"_uniform_vec3vi",value:function(e,n){return t.LayaGL.instance.uniform3iv(e.location,n),1}},{key:"_uniform_vec4i",value:function(e,n){var r=e.uploadedValue;return r[0]!==n[0]||r[1]!==n[1]||r[2]!==n[2]||r[3]!==n[3]?(t.LayaGL.instance.uniform4i(e.location,r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3]),1):0}},{key:"_uniform_vec4vi",value:function(e,n){return t.LayaGL.instance.uniform4iv(e.location,n),1}},{key:"_uniform_sampler2D",value:function(e,n){var r=n._getSource()||n.defaulteTexture._getSource(),i=t.LayaGL.instance;return t.WebGLContext.activeTexture(i,e.textureID),t.WebGLContext.bindTexture(i,i.TEXTURE_2D,r),0}},{key:"_uniform_sampler3D",value:function(e,n){var r=n._getSource()||n.defaulteTexture._getSource(),i=t.LayaGL.instance;return t.WebGLContext.activeTexture(i,e.textureID),t.WebGLContext.bindTexture(i,WebGL2RenderingContext.TEXTURE_3D,r),0}},{key:"_uniform_samplerCube",value:function(e,n){var r=n._getSource()||n.defaulteTexture._getSource(),i=t.LayaGL.instance;return t.WebGLContext.activeTexture(i,e.textureID),t.WebGLContext.bindTexture(i,i.TEXTURE_CUBE_MAP,r),0}},{key:"bind",value:function(){return t.WebGLContext.useProgram(t.LayaGL.instance,this._program)}},{key:"uploadUniforms",value:function(e,n,r){t.Stat.shaderCall+=t.LayaGLRunner.uploadShaderUniforms(t.LayaGL.instance,e,n,r)}},{key:"uploadRenderStateBlendDepth",value:function(e){var n=t.LayaGL.instance,r=this._shaderPass.renderState,i=e.getData(),a=this._getRenderState(i,U.RENDER_STATE_DEPTH_WRITE),o=this._getRenderState(i,U.RENDER_STATE_DEPTH_TEST),s=this._getRenderState(i,U.RENDER_STATE_BLEND);switch(null==a&&(a=r.depthWrite),null==o&&(o=r.depthTest),null==s&&(s=r.blend),t.WebGLContext.setDepthMask(n,a),o===q.DEPTHTEST_OFF?t.WebGLContext.setDepthTest(n,!1):(t.WebGLContext.setDepthTest(n,!0),t.WebGLContext.setDepthFunc(n,o)),s){case q.BLEND_DISABLE:t.WebGLContext.setBlend(n,!1);break;case q.BLEND_ENABLE_ALL:var l=this._getRenderState(i,U.RENDER_STATE_BLEND_EQUATION),_=this._getRenderState(i,U.RENDER_STATE_BLEND_SRC),u=this._getRenderState(i,U.RENDER_STATE_BLEND_DST);null==l&&(l=r.blendEquation),null==_&&(_=r.srcBlend),null==u&&(u=r.dstBlend),t.WebGLContext.setBlend(n,!0),t.WebGLContext.setBlendEquation(n,l),t.WebGLContext.setBlendFunc(n,_,u);break;case q.BLEND_ENABLE_SEPERATE:var c=this._getRenderState(i,U.RENDER_STATE_BLEND_EQUATION_RGB),h=this._getRenderState(i,U.RENDER_STATE_BLEND_EQUATION_ALPHA),d=this._getRenderState(i,U.RENDER_STATE_BLEND_SRC_RGB),f=this._getRenderState(i,U.RENDER_STATE_BLEND_DST_RGB),m=this._getRenderState(i,U.RENDER_STATE_BLEND_SRC_ALPHA),E=this._getRenderState(i,U.RENDER_STATE_BLEND_DST_ALPHA);null==c&&(c=r.blendEquationRGB),null==h&&(h=r.blendEquationAlpha),null==d&&(d=r.srcBlendRGB),null==f&&(f=r.dstBlendRGB),null==m&&(m=r.srcBlendAlpha),null==E&&(E=r.dstBlendAlpha),t.WebGLContext.setBlend(n,!0),t.WebGLContext.setBlendEquationSeparate(n,c,h),t.WebGLContext.setBlendFuncSeperate(n,d,f,m,E)}}},{key:"uploadRenderStateFrontFace",value:function(e,n,r){var i,a=t.LayaGL.instance,o=this._shaderPass.renderState,s=e.getData(),l=this._getRenderState(s,U.RENDER_STATE_CULL);switch(null==l&&(l=o.cull),l){case q.CULL_NONE:t.WebGLContext.setCullFace(a,!1);break;case q.CULL_FRONT:t.WebGLContext.setCullFace(a,!0),i=n?r?a.CCW:a.CW:r?a.CW:a.CCW,t.WebGLContext.setFrontFace(a,i);break;case q.CULL_BACK:t.WebGLContext.setCullFace(a,!0),i=n?r?a.CW:a.CCW:r?a.CCW:a.CW,t.WebGLContext.setFrontFace(a,i)}}},{key:"uploadCustomUniform",value:function(e,n){t.Stat.shaderCall+=t.LayaGLRunner.uploadCustomUniform(t.LayaGL.instance,this._customUniformParamsMap,e,n)}},{key:"_uniformMatrix2fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix2fvEx(e.location,!1,n),1}},{key:"_uniformMatrix3fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix3fvEx(e.location,!1,n),1}},{key:"_uniformMatrix4fvForNative",value:function(e,n){return t.LayaGL.instance.uniformMatrix4fvEx(e.location,!1,n),1}}]),n}(),Jn=function(e){function n(e,t,r,i){_classCallCheck(this,n);var a=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,r,null));for(var o in a._cacheSharders={},a._cacheShaderHierarchy=1,a._renderState=new q,a._validDefine=new k,a._owner=e,a._stateMap=i,a.defs)a._validDefine.add(U.getDefineByName(o));return a}return _inherits(n,t.ShaderCompile),_createClass(n,[{key:"_compileToTree",value:function(e,n,r,i,a){var o,s,l,_,u,c,h,d,f,m,E;for(f=r;f<n.length;f++)if(!((l=n[f]).length<1)&&0!==(c=l.indexOf("//"))){if(c>=0&&(l=l.substr(0,c)),o=d||new t.ShaderNode(i),d=null,o.text=l,(c=l.indexOf("#"))>=0){for(_="#",E=c+1,m=l.length;E<m;E++){var v=l.charAt(E);if(" "===v||"\t"===v||"?"===v)break;_+=v}switch(o.name=_,_){case"#ifdef":case"#ifndef":if(o.setParent(e),e=o,a)for(h=l.substr(E).split(t.ShaderCompile._splitToWordExps3),E=0;E<h.length;E++)(l=h[E]).length&&(a[l]=!0);continue;case"#if":case"#elif":if(o.setParent(e),e=o,a)for(h=l.substr(E).split(t.ShaderCompile._splitToWordExps3),E=0;E<h.length;E++)(l=h[E]).length&&"defined"!=l&&(a[l]=!0);continue;case"#else":s=(e=e.parent).childs[e.childs.length-1],o.setParent(e),e=o;continue;case"#endif":s=(e=e.parent).childs[e.childs.length-1],o.setParent(e);continue;case"#include":h=t.ShaderCompile.splitToWords(l,null);var T=t.ShaderCompile.includes[h[1]];if(!T)throw"ShaderCompile error no this include file:"+h[1];if((c=h[0].indexOf("?"))<0){o.setParent(e),l=T.getWith("with"==h[2]?h[3]:null),this._compileToTree(o,l.split("\n"),0,i,a),o.text="";continue}o.setCondition(h[0].substr(c+1),t.ShaderCompile.IFDEF_YES),o.text=T.getWith("with"==h[2]?h[3]:null);break;case"#import":u=(h=t.ShaderCompile.splitToWords(l,null))[1],i.push({node:o,file:t.ShaderCompile.includes[u],ofs:o.text.length});continue}}else{if((s=e.childs[e.childs.length-1])&&!s.name){i.length>0&&t.ShaderCompile.splitToWords(l,s),d=o,s.text+="\n"+l;continue}i.length>0&&t.ShaderCompile.splitToWords(l,o)}o.setParent(e)}}},{key:"_resizeCacheShaderMap",value:function(e,t,n){var r=this._cacheShaderHierarchy-1;if(t==r){for(var i in e)for(var a=e[i],o=0,s=n-r;o<s;o++)o==s-1?e[0]=a:e=e[0==o?i:0]={};this._cacheShaderHierarchy=n}else for(var i in e)this._resizeCacheShaderMap(e[i],++t,n)}},{key:"_addDebugShaderVariantCollection",value:function(e){var t=U._debugShaderVariantInfo,r=this._owner,i=r._owner,a=n._debugDefineString;if(U._getNamesByDefineData(e,a),!o._config._multiLighting){var s=a.indexOf("LEGACYSINGLELIGHTING");-1!==s&&a.splice(s,1)}t?t.setValue(i,i._subShaders.indexOf(r),r._passes.indexOf(this),a):U._debugShaderVariantInfo=t=new F(i,i._subShaders.indexOf(r),r._passes.indexOf(this),a),U.debugShaderVariantCollection.add(t)}},{key:"withCompile",value:function(e){e._intersectionDefineDatas(this._validDefine),U.debugMode&&this._addDebugShaderVariantCollection(e);var t=this._cacheSharders,r=e._length;r>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(t,0,r),this._cacheShaderHierarchy=r);for(var i=e._mask,a=e._length-1,s=this._cacheShaderHierarchy-1,l=0;l<s;l++){var _=a<l?0:i[l],u=t[_];u||(t[_]=u={}),t=u}var c=a<s?0:i[s],h=t[c];if(h)return h;var d=n._defineString;U._getNamesByDefineData(e,d);var f=o._config,m=f.lightClusterCount,E={},v="#define MAX_LIGHT_COUNT "+f.maxLightCount+"\n";v+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+f._maxAreaLightCountPerClusterAverage+"\n",v+="#define CLUSTER_X_COUNT "+m.x+"\n",v+="#define CLUSTER_Y_COUNT "+m.y+"\n",v+="#define CLUSTER_Z_COUNT "+m.z+"\n";l=0;for(var T=d.length;l<T;l++){var p=d[l];v+="#define "+p+"\n",E[p]=!0}var g=this._VS.toscript(E,[]),y="";0==g[0].indexOf("#version")&&(y=g[0]+"\n",g.shift());var S=this._PS.toscript(E,[]),R="";if(0==S[0].indexOf("#version")&&(R=S[0]+"\n",S.shift()),h=new Kn(y+v+g.join("\n"),R+v+S.join("\n"),this._owner._attributeMap||this._owner._owner._attributeMap,this._owner._uniformMap||this._owner._owner._uniformMap,this),t[c]=h,U.debugMode){var C="",I="";if(!f._multiLighting){e.remove(U.SHADERDEFINE_LEGACYSINGALLIGHTING);var A=d.indexOf("LEGACYSINGLELIGHTING");-1!==A&&d.splice(A,1)}for(l=0,T=e._length;l<T;l++)I+=l==T-1?i[l]:i[l]+",";for(l=0,T=d.length;l<T;l++)C+=l==T-1?d[l]:d[l]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+I+"] DefineNames:["+C+"]","color:green")}return h}},{key:"renderState",get:function(){return this._renderState}}]),n}();Jn._defineString=[],Jn._debugDefineString=[];var $n=function(){function e(t,n){_classCallCheck(this,e),this._flags={},this._passes=[],this._attributeMap=t,this._uniformMap=n}return _createClass(e,[{key:"setFlag",value:function(e,t){t?this._flags[e]=t:delete this._flags[e]}},{key:"getFlag",value:function(e){return this._flags[e]}},{key:"addShaderPass",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=new Jn(this,e,t,n);return this._passes.push(r),r}}]),e}(),er=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"__init__",value:function(){U.SHADERDEFINE_LEGACYSINGALLIGHTING=U.getDefineByName("LEGACYSINGLELIGHTING"),U.addInclude("Lighting.glsl","struct DirectionLight {\r\n\tvec3 color;\r\n\tvec3 direction;\r\n};\r\n\r\nstruct PointLight {\r\n\tvec3 color;\r\n\tvec3 position;\r\n\tfloat range;\r\n};\r\n\r\nstruct SpotLight {\r\n\tvec3 color;\r\n\tvec3 position;\r\n\tfloat range;\r\n\tvec3 direction;\r\n\tfloat spot;\r\n};\r\n\r\n\r\n\r\nconst int c_ClusterBufferWidth = CLUSTER_X_COUNT*CLUSTER_Y_COUNT;\r\nconst int c_ClusterBufferHeight = CLUSTER_Z_COUNT*(1+int(ceil(float(MAX_LIGHT_COUNT_PER_CLUSTER)/4.0)));\r\nconst int c_ClusterBufferFloatWidth = c_ClusterBufferWidth*4;\r\n\r\nivec4 getClusterInfo(sampler2D clusterBuffer,mat4 viewMatrix,vec4 viewport,vec3 position,vec4 fragCoord,vec4 projectParams)\r\n{\r\n\tvec3 viewPos = vec3(viewMatrix*vec4(position, 1.0)); //position in viewspace\r\n\r\n\tint clusterXIndex = int(floor(fragCoord.x/ (float(viewport.z)/float(CLUSTER_X_COUNT))));\r\n    int clusterYIndex = int(floor((viewport.w * (projectParams.z <0.0? 0.0 : 1.0) - fragCoord.y * projectParams.z)/ (float(viewport.w)/float(CLUSTER_Y_COUNT))));//Maybe Flipped ProjectMatrix\r\n\tfloat zSliceParam =float(CLUSTER_Z_COUNT)/log2(projectParams.y / projectParams.x);\r\n \tint clusterZIndex = int(floor(log2(-viewPos.z) * zSliceParam- log2(projectParams.x) * zSliceParam));//projectParams x:cameraNear y:cameraFar\r\n\r\n\tvec2 uv= vec2((float(clusterXIndex + clusterYIndex * CLUSTER_X_COUNT)+0.5)/float(c_ClusterBufferWidth),\r\n\t\t\t\t(float(clusterZIndex)+0.5)/float(c_ClusterBufferHeight));\r\n\tvec4 clusterPixel=texture2D(clusterBuffer, uv);\r\n\treturn ivec4(clusterPixel);//X:Point Count Y:Spot Count Z、W:Light Offset\r\n}\r\n\r\n\r\nint getLightIndex(sampler2D clusterBuffer,int offset,int index) \r\n{\r\n\tint totalOffset=offset+index;\r\n\tint row=totalOffset/c_ClusterBufferFloatWidth;\r\n\tint lastRowFloat=totalOffset-row*c_ClusterBufferFloatWidth;\r\n\tint col=lastRowFloat/4;\r\n\tvec2 uv=vec2((float(col)+0.5)/float(c_ClusterBufferWidth),\r\n\t\t\t\t(float(row)+0.5)/float(c_ClusterBufferHeight));\r\n\tvec4 texel = texture2D(clusterBuffer, uv);\r\n    int pixelComponent = lastRowFloat-col*4;\r\n    if (pixelComponent == 0) \r\n      return int(texel.x);\r\n    else if (pixelComponent == 1) \r\n      return int(texel.y);\r\n    else if (pixelComponent == 2) \r\n      return int(texel.z);\r\n    else if (pixelComponent == 3) \r\n      return int(texel.w);\r\n}\r\n\r\nDirectionLight getDirectionLight(sampler2D lightBuffer,int index) \r\n{\r\n    DirectionLight light;\r\n    float v = (float(index)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tlight.color=p1.rgb;\r\n    light.direction = p2.rgb;\r\n    return light;\r\n}\r\n\r\nPointLight getPointLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \r\n{\r\n    PointLight light;\r\n\tint pointIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,index);\r\n    float v = (float(pointIndex)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tlight.color=p1.rgb;\r\n\tlight.range = p1.a;\r\n    light.position = p2.rgb;\r\n    return light;\r\n}\r\n\r\nSpotLight getSpotLight(sampler2D lightBuffer,sampler2D clusterBuffer,ivec4 clusterInfo,int index) \r\n{\r\n    SpotLight light;\r\n\tint spoIndex=getLightIndex(clusterBuffer,clusterInfo.z*c_ClusterBufferFloatWidth+clusterInfo.w,clusterInfo.x+index);\r\n    float v = (float(spoIndex)+0.5)/ float(MAX_LIGHT_COUNT);\r\n    vec4 p1 = texture2D(lightBuffer, vec2(0.125,v));\r\n    vec4 p2 = texture2D(lightBuffer, vec2(0.375,v));\r\n\tvec4 p3 = texture2D(lightBuffer, vec2(0.625,v));\r\n    light.color = p1.rgb;\r\n\tlight.range=p1.a;\r\n    light.position = p2.rgb;\r\n\tlight.spot = p2.a;\r\n\tlight.direction = p3.rgb;\r\n    return light;\r\n}\r\n\r\n\r\n\r\n// Laya中使用衰减纹理\r\nfloat LayaAttenuation(in vec3 L,in float invLightRadius) {\r\n\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\r\n\tfRatio *= fRatio;\r\n\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\r\n}\r\n\r\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\r\nfloat BasicAttenuation(in vec3 L,in float invLightRadius) {\r\n\tvec3 distance = L * invLightRadius;\r\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius));\r\n\treturn attenuation * attenuation;\r\n}\r\n\r\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\r\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius) {\r\n\tfloat attenuationFactor = 30.0;\r\n\tvec3 distance = L * invLightRadius;\r\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\r\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\r\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\r\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\r\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\r\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\r\n\tattenuation /= 1.0 - attenuationFactor;\r\n\treturn attenuation;\r\n}\r\n\r\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tmediump vec3 h = normalize(viewDir-lightVec);\r\n\tlowp float ln = max (0.0, dot (-lightVec,normal));\r\n\tfloat nh = max (0.0, dot (h,normal));\r\n\tdiffuseColor=lightColor * ln;\r\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\r\n}\r\n\r\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec=normalize(light.direction);\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec,diffuseColor,specularColor);\r\n}\r\n\r\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec =  pos-light.position;\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,lightVec/length(lightVec),diffuseColor,specularColor);\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\r\n\tdiffuseColor *= attenuate;\r\n\tspecularColor*= attenuate;\r\n}\r\n\r\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor) {\r\n\tvec3 lightVec =  pos-light.position;\r\n\tvec3 normalLightVec=lightVec/length(lightVec);\r\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.color,normalLightVec,diffuseColor,specularColor);\r\n\tvec2 cosAngles=cos(vec2(light.spot,light.spot*0.5)*0.5);//ConeAttenuation\r\n\tfloat dl=dot(normalize(light.direction),normalLightVec);\r\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range)*dl;\r\n\tdiffuseColor *=attenuate;\r\n\tspecularColor *=attenuate;\r\n}\r\n\r\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal) {\r\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\r\n\r\n\t// Build orthonormal basis.\r\n\tvec3 N = normalize(unitNormal);\r\n\tvec3 T = normalize(tangent);\r\n\tvec3 B = normalize(binormal);\r\n\tmat3 TBN = mat3(T, B, N);\r\n\r\n\t// Transform from tangent space to world space.\r\n\tvec3 bumpedNormal = TBN*normalT;\r\n\r\n\treturn bumpedNormal;\r\n}\r\n\r\nvec3 NormalSampleToWorldSpace1(vec4 normalMapSample, vec3 tangent, vec3 binormal, vec3 unitNormal) {\r\n\tvec3 normalT;\r\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\r\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\r\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\r\n\r\n\tvec3 T = normalize(tangent);\r\n\tvec3 B = normalize(binormal);\r\n\tvec3 N = normalize(unitNormal);\r\n\tmat3 TBN = mat3(T, B, N);\r\n\r\n\t// Transform from tangent space to world space.\r\n\tvec3 bumpedNormal = TBN * normalize(normalT);\r\n\r\n\treturn bumpedNormal;\r\n}\r\n\r\nvec3 DecodeLightmap(vec4 color) {\r\n\treturn color.rgb*color.a*5.0;\r\n}\r\n\r\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\r\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\r\n\ttransTexcoord.y+=1.0;\r\n\treturn transTexcoord;\r\n}\r\n\r\nvec4 remapGLPositionZ(vec4 position) {\r\n\tposition.z=position.z * 2.0 - position.w;\r\n\treturn position;\r\n}\r\n\r\nmat3 inverse(mat3 m) {\r\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\r\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\r\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\r\n\r\n  float b01 = a22 * a11 - a12 * a21;\r\n  float b11 = -a22 * a10 + a12 * a20;\r\n  float b21 = a21 * a10 - a11 * a20;\r\n\r\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\r\n\r\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\r\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\r\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\r\n}\r\n\r\n"),U.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\r\nuniform sampler2D u_shadowMap2;\r\nuniform sampler2D u_shadowMap3;\r\nuniform vec2\t  u_shadowPCFoffset;\r\nuniform vec4     u_shadowPSSMDistance;\r\nvec4 packDepth(const in float depth)\r\n{\r\n\tconst vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\r\n\tconst vec4 bitMask\t= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\r\n\tvec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\r\n\tres -= res.xxyz * bitMask;\r\n\treturn res;\r\n}\r\nfloat unpackDepth(const in vec4 rgbaDepth)\r\n{\r\n\tconst vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\r\n\tfloat depth = dot(rgbaDepth, bitShift);\r\n\treturn depth;\r\n}\r\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\r\n{\r\n\tvec2 texelpos =texcoord / invsize;\r\n\tvec2 lerps = fract( texelpos );\r\n\tfloat sourcevals[4];\r\n\tsourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\r\n\tsourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\r\n\tsourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\r\n\tsourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\r\n\treturn mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\r\n}\r\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\r\n{\r\n\tfloat value = 1.0;\r\n\tint nPSNum = int(posViewZ>pssmDistance.x);\r\n\tnPSNum += int(posViewZ>pssmDistance.y);\r\n\tnPSNum += int(posViewZ>pssmDistance.z);\r\n\t//真SB,webgl不支持在PS中直接访问数组\r\n\tmat4 lightVP;\r\n\tif( nPSNum == 0 )\r\n\t{\r\n\t\tlightVP = lightShadowVP[1];\r\n\t}\r\n\telse if( nPSNum == 1 )\r\n\t{\r\n\t\tlightVP = lightShadowVP[2];\r\n\t}\r\n\telse if( nPSNum == 2 )\r\n\t{\r\n\t\tlightVP = lightShadowVP[3];\r\n\t}\r\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\r\n\t//为了效率，在CPU计算/2.0 + 0.5\r\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\r\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\r\n\tfloat fMyZ = vText.z - zBias;\r\n\t/*\r\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\r\n\tbool bInFrustum = all( bInFrustumVec );\r\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\r\n\tbool bFrustumTest = all( bFrustumTestVec );\r\n\tif ( bFrustumTest ) \r\n\t*/\r\n\tif( fMyZ <= 1.0 )\r\n\t{\r\n\t\tfloat zdepth=0.0;\r\n#ifdef SHADOWMAP_PCF3\r\n\t\tif ( nPSNum == 0 )\r\n\t\t{\r\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\r\n\t\t\tvalue = value/4.0;\r\n\t\t} \r\n\t\telse if( nPSNum == 1 )\r\n\t\t{\r\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\r\n\t\t}\r\n\t\telse if( nPSNum == 2 )\r\n\t\t{\r\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\r\n\t\t\tzdepth = unpackDepth(color);\r\n\t\t\tvalue = float(fMyZ < zdepth);\r\n\t\t}\r\n#endif\r\n#ifdef SHADOWMAP_PCF2\r\n\t\tif ( nPSNum == 0 )\r\n\t\t{\r\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\r\n\t\t}\r\n\t\telse if( nPSNum == 1 )\r\n\t\t{\r\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\r\n\t\t}\r\n\t\telse if( nPSNum == 2 )\r\n\t\t{\r\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\r\n\t\t\tzdepth = unpackDepth(color);\r\n\t\t\tvalue = float(fMyZ < zdepth);\r\n\t\t}\r\n\r\n#endif\r\n#ifdef SHADOWMAP_PCF1\r\n\t\tif ( nPSNum == 0 )\r\n\t\t{\r\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\r\n\t\t}\r\n\t\telse if( nPSNum == 1 )\r\n\t\t{\r\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\r\n\t\t\tzdepth = unpackDepth(color);\r\n\t\t\tvalue = float(fMyZ < zdepth);\r\n\t\t}\r\n\t\telse if( nPSNum == 2 )\r\n\t\t{\r\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\r\n\t\t\tzdepth = unpackDepth(color);\r\n\t\t\tvalue = float(fMyZ < zdepth);\r\n\t\t}\r\n#endif\r\n#ifdef SHADOWMAP_PCF_NO\r\n\t\tvec4 color;\r\n\t\tif ( nPSNum == 0 )\r\n\t\t{\r\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\r\n\t\t}\r\n\t\telse if( nPSNum == 1 )\r\n\t\t{\r\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\r\n\t\t}\r\n\t\telse if( nPSNum == 2 )\r\n\t\t{\r\n\t\t\tcolor = texture2D( shadowMap3,vText.xy );\r\n\t\t}\r\n\t\tzdepth = unpackDepth(color);\r\n\t\tvalue = float(fMyZ < zdepth);\r\n#endif\r\n\t}\r\n\treturn value;\r\n}\r\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\r\n{\r\n\tfloat value = 1.0;\r\n\tint nPSNum = int(posViewZ>pssmDistance.x);\r\n\tnPSNum += int(posViewZ>pssmDistance.y);\r\n\t//真SB,webgl不支持在PS中直接访问数组\r\n\tmat4 lightVP;\r\n\tif( nPSNum == 0 )\r\n\t{\r\n\t\tlightVP = lightShadowVP[1];\r\n\t}\r\n\telse if( nPSNum == 1 )\r\n\t{\r\n\t\tlightVP = lightShadowVP[2];\r\n\t}\r\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\r\n\t//为了效率，在CPU计算/2.0 + 0.5\r\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\r\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\r\n\tfloat fMyZ = vText.z - zBias;\r\n\t/*\r\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\r\n\tbool bInFrustum = all( bInFrustumVec );\r\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\r\n\tbool bFrustumTest = all( bFrustumTestVec );\r\n\tif ( bFrustumTest ) \r\n\t*/\r\n\tif( fMyZ <= 1.0 )\r\n\t{\r\n\t\tfloat zdepth=0.0;\r\n#ifdef SHADOWMAP_PCF3\r\n\t\tif ( nPSNum == 0 )\r\n\t\t{\r\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\r\n\t\t\tvalue = value/4.0;\r\n\t\t}\r\n\t\telse if( nPSNum == 1 )\r\n\t\t{\r\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\r\n\t\t}\r\n#endif\r\n#ifdef SHADOWMAP_PCF2\r\n\t\tif ( nPSNum == 0 )\r\n\t\t{\r\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\r\n\t\t}\r\n\t\telse if( nPSNum == 1 )\r\n\t\t{\r\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\r\n\t\t}\r\n#endif\r\n#ifdef SHADOWMAP_PCF1\r\n\t\tif ( nPSNum == 0 )\r\n\t\t{\r\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\r\n\t\t}\r\n\t\telse if( nPSNum == 1 )\r\n\t\t{\r\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\r\n\t\t\tzdepth = unpackDepth(color);\r\n\t\t\tvalue = float(fMyZ < zdepth);\r\n\t\t}\r\n#endif\r\n#ifdef SHADOWMAP_PCF_NO\r\n\t\tvec4 color;\r\n\t\tif ( nPSNum == 0 )\r\n\t\t{\r\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\r\n\t\t}\r\n\t\telse if( nPSNum == 1 )\r\n\t\t{\r\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\r\n\t\t}\r\n\t\tzdepth = unpackDepth(color);\r\n\t\tvalue = float(fMyZ < zdepth);\r\n#endif\r\n\t}\r\n\treturn value;\r\n}\r\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec4 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\r\n{\r\n\tfloat value = 1.0;\r\n\tif( posViewZ < pssmDistance.x )\r\n\t{\r\n\t\tvec3 vText = lightMVPPos.xyz / lightMVPPos.w;\r\n\t\tfloat fMyZ = vText.z - zBias;\r\n\t\t/*\r\n\t\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\r\n\t\tbool bInFrustum = all( bInFrustumVec );\r\n\t\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\r\n\t\tbool bFrustumTest = all( bFrustumTestVec );\r\n\t\t*/\r\n\t\tif ( fMyZ <= 1.0 ) \r\n\t\t{\r\n\t\t\tfloat zdepth=0.0;\r\n#ifdef SHADOWMAP_PCF3\r\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\r\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\r\n\t\t\tvalue = value/4.0;\r\n#endif\r\n#ifdef SHADOWMAP_PCF2\t\t\r\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\r\n#endif\r\n#ifdef SHADOWMAP_PCF1\r\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\r\n#endif\r\n#ifdef SHADOWMAP_PCF_NO\t\t\r\n\t\t\tvec4 color = texture2D( shadowMap1,vText.xy );\r\n\t\t\tzdepth = unpackDepth(color);\r\n\t\t\tvalue = float(fMyZ < zdepth);\r\n#endif\r\n\t\t}\r\n\t}\r\n\treturn value;\r\n}"),U.addInclude("BRDF.glsl","struct LayaGI\r\n{\r\n\tvec3 diffuse;\r\n\tvec3 specular;\r\n};\r\n\r\nvec4 LayaAirBRDF(in vec3 diffuseColor, in vec3 specularColor, in float oneMinusReflectivity, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\r\n{\r\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\r\n\tvec3 halfDir = SafeNormalize(viewDir - lightDir);\r\n\t\r\n\tfloat nv = abs(dot(normal, viewDir));\r\n\t\r\n\tfloat nl = clamp(dot(normal,   -lightDir),  0.0, 1.0);\r\n\tfloat nh = clamp(dot(normal,     halfDir),  0.0, 1.0);\r\n\tfloat lv = clamp(dot(lightDir,   viewDir),  0.0, 1.0);\r\n\tfloat lh = clamp(dot(lightDir,  -halfDir),  0.0, 1.0);\r\n\t\r\n\tfloat diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\r\n\t\r\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\r\n\t\r\n\t//#if UNITY_BRDF_GGX\r\n\t // GGX with roughtness to 0 would mean no specular at all, using max(roughness, 0.002) here to match HDrenderloop roughtness remapping.\r\n\troughness = max(roughness,0.014);\r\n\tfloat V = SmithJointGGXVisibilityTerm(nl, nv, roughness);\r\n\tfloat D = GGXTerm(nh, roughness);\r\n\t\r\n\tfloat specularTerm = V * D * PI;\r\n\t\r\n\tspecularTerm = sqrt(max(0.0001, specularTerm));\r\n\tspecularTerm = max(0.0, specularTerm * nl);\r\n\t\r\n\tfloat surfaceReduction = 1.0 - 0.28 * roughness * perceptualRoughness;\r\n\tfloat grazingTerm = clamp(smoothness + (1.0 - oneMinusReflectivity), 0.0, 1.0);\r\n\t\r\n\tvec4 color;\r\n\tcolor.rgb = diffuseColor * (gi.diffuse+lightColor * diffuseTerm) \r\n\t\t\t  + specularTerm * lightColor * FresnelTerm (specularColor, lh);\r\n\t\t\t  //+ surfaceReduction * gi.specular * FresnelLerp(specularColor, vec3(grazingTerm), nv);\r\n\t\r\n\treturn color;\r\n}\r\nvec4 LayaAirStandardReflect(in vec4 albedoColor,in float metallic,in float smoothness,in LayaGI gi)\r\n{\r\n\tvec3 diffuseColor;\r\n\tvec3 specularColor;\r\n\tfloat alpha;\r\n\tfloat oneMinusReflectivity;\r\n\tdiffuseColor = DiffuseAndSpecularFromMetallic (albedoColor.rgb, metallic, specularColor, oneMinusReflectivity);\r\n\tdiffuseColor = LayaPreMultiplyAlpha(diffuseColor, albedoColor.a, oneMinusReflectivity, alpha);\r\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\r\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\r\n\tfloat surfaceReduction = 1.0 - 0.28 * roughness * perceptualRoughness;\r\n\tvec4 color;\r\n\tcolor.rgb = surfaceReduction * gi.specular;\r\n\tcolor.a = alpha;\r\n\treturn color;\r\n\r\n}\r\n\r\nvec4 LayaAirSpecularReflect(in vec4 albedoColor,in vec3 specularColor,in float smoothness,in LayaGI gi)\r\n{\r\n\tfloat oneMinusReflectivity;\r\n\tvec3 diffuseColor;\r\n\tfloat alpha;\r\n\t\r\n\tdiffuseColor = EnergyConservationBetweenDiffuseAndSpecular (albedoColor.rgb, specularColor, oneMinusReflectivity);\r\n\t\r\n\tdiffuseColor = LayaPreMultiplyAlpha(diffuseColor, albedoColor.a, oneMinusReflectivity, alpha);\r\n\r\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\r\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\r\n\tfloat surfaceReduction = 1.0 - 0.28 * roughness * perceptualRoughness;\r\n\tvec4 color;\r\n\tcolor.rgb = surfaceReduction * gi.specular;\r\n\tcolor.a = alpha;\r\n\treturn color;\r\n}"),U.addInclude("PBRUtils.glsl","\r\nvec3 UnpackScaleNormal(in vec2 uv0)\r\n{\r\n\t#ifdef NORMALTEXTURE\r\n\t\tvec3 normalT;\r\n\t\tvec4 normalMapSample = texture2D(u_NormalTexture, uv0);\r\n\t\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\r\n\t\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\r\n\t\tnormalT.xy *= u_normalScale;\r\n\t\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\r\n\t\t\r\n\t\tvec3 T = normalize(v_Tangent);\r\n\t\tvec3 B = normalize(v_Binormal);\r\n\t\tvec3 N = normalize(v_Normal);\r\n\t\tmat3 TBN = mat3(T, B, N);\r\n\t\t\r\n\t\tvec3 bumpedNormal = TBN * normalize(normalT);\r\n\t\treturn bumpedNormal;\r\n\t#else\r\n\t\treturn normalize(v_Normal);\r\n\t#endif\r\n}\r\n\r\nvec4 DielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\r\n\r\nfloat PI = 3.14159265359;\r\n\r\nvec3 FresnelTerm (in vec3 F0, in float cosA)\r\n{\r\n\treturn F0 + (vec3(1.0) - F0) * pow(1.0 - cosA, 5.0);\r\n}\r\n\r\nvec3 FresnelLerp (in vec3 F0, in vec3 F90, float cosA)\r\n{\r\n    float t = pow(1.0 - cosA, 5.0);\r\n    return mix(F0, F90, t);\r\n}\r\n\r\nfloat PerceptualRoughnessToRoughness(in float perceptualRoughness)\r\n{\r\n\treturn perceptualRoughness * perceptualRoughness;\r\n}\r\n\r\nfloat PerceptualRoughnessToSpecularPower(in float perceptualRoughness)\r\n{\r\n\tfloat m = PerceptualRoughnessToRoughness(perceptualRoughness);\r\n\tfloat sq = max(0.0001, m * m);\r\n\tfloat n = (2.0 / sq) - 2.0;\r\n\tn = max(n, 0.0001);\r\n\treturn n;\r\n}\r\n\r\nfloat RoughnessToPerceptualRoughness(in float roughness)\r\n{\r\n\treturn sqrt(roughness);\r\n}\r\n\r\nfloat SmoothnessToRoughness(in float smoothness)\r\n{\r\n\treturn (1.0 - smoothness) * (1.0 - smoothness);\r\n}\r\n\r\nfloat SmoothnessToPerceptualRoughness(in float smoothness)\r\n{\r\n\treturn (1.0 - smoothness);\r\n}\r\n\r\nvec3 SafeNormalize(in vec3 inVec)\r\n{\r\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\r\n\treturn inVec * (1.0 / sqrt(dp3));\r\n}\r\n\r\nfloat DisneyDiffuse(in float NdotV, in float NdotL, in float LdotH, in float perceptualRoughness)\r\n{\r\n\tfloat fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\r\n\tfloat lightScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotL,5.0));\r\n\tfloat viewScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotV,5.0));\r\n\r\n\treturn lightScatter * viewScatter;\r\n}\r\n\r\nfloat SmithJointGGXVisibilityTerm (float NdotL, float NdotV, float roughness)\r\n{\r\n\tfloat a = roughness;\r\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\r\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\r\n\r\n\treturn 0.5 / (lambdaV + lambdaL + 0.00001);\r\n}\r\n\r\nfloat GGXTerm (float NdotH, float roughness)\r\n{\r\n\tfloat a2 = roughness * roughness;\r\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0;\r\n\treturn 0.31830988618 * a2 / (d * d + 0.0000001);\r\n}\r\n\r\nfloat OneMinusReflectivityFromMetallic(in float metallic)\r\n{\r\n\tfloat oneMinusDielectricSpec = DielectricSpecularColor.a;\r\n\treturn oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;\r\n}\r\n\r\nfloat SpecularStrength(vec3 specular)\r\n{\r\n    //(SHADER_TARGET < 30)return specular.r; \r\n    return max (max (specular.r, specular.g), specular.b);\r\n}\r\n\r\nvec3 DiffuseAndSpecularFromMetallic(in vec3 diffuseColor, in float metallic, out vec3 specularColor, out float oneMinusReflectivity)\r\n{\r\n\tspecularColor = mix(DielectricSpecularColor.rgb, diffuseColor, metallic);\r\n\toneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);\r\n\treturn diffuseColor * oneMinusReflectivity;\r\n}\r\n\r\nvec3 EnergyConservationBetweenDiffuseAndSpecular(in vec3 diffuseColor, in vec3 specularColor, out float oneMinusReflectivity)\r\n{\r\n\toneMinusReflectivity = 1.0 - SpecularStrength(specularColor);\r\n\treturn diffuseColor * oneMinusReflectivity;\r\n}\r\n\r\nvec4 Occlusion(in vec2 uv0){\r\n\t#ifdef OCCLUSIONTEXTURE\r\n\t\tvec4 occlusionTextureColor = texture2D(u_OcclusionTexture, uv0);\r\n\t\tfloat occ = occlusionTextureColor.g;\r\n\t\tfloat oneMinusT = 1.0 - u_occlusionStrength;\r\n\t\tfloat lerpOneTo = oneMinusT + occ * u_occlusionStrength;\r\n\t\treturn occlusionTextureColor * lerpOneTo;\r\n\t#else\r\n\t\treturn vec4(1.0);\r\n\t#endif\r\n}\r\n\r\nvec2 ParallaxOffset(in vec3 viewDir){\r\n\t#ifdef PARALLAXTEXTURE\r\n\t\tfloat h = texture2D(u_ParallaxTexture, v_Texcoord0).g;\r\n\t\th = h * u_parallaxScale - u_parallaxScale / 2.0;\r\n\t\tvec3 v = viewDir;\r\n\t\tv.z += 0.42;\r\n\t\tvec2 offset = h * (v.xy / v.z);\r\n\t\treturn v_Texcoord0 + offset;\r\n\t#else\r\n\t\treturn v_Texcoord0;\r\n\t#endif\r\n}\r\n\r\nvec3 ReflectCubeMap(in vec3 viewDir, in vec3 normal){\r\n\t#ifdef REFLECTMAP\r\n\t\tvec3 incident = -viewDir;\r\n\t\tvec3 reflectionVector = reflect(incident, normal);\r\n\t\tvec3 reflectionColor = textureCube(u_ReflectTexture, vec3(-reflectionVector.x, reflectionVector.yz)).rgb;\r\n\t\treturn reflectionColor * u_ReflectIntensity;\r\n\t#else\r\n\t\treturn vec3(0.0);\r\n\t#endif\r\n}\r\n\r\n\r\n\r\nvec3 LayaPreMultiplyAlpha(vec3 diffColor, float alpha, float oneMinusReflectivity, out float outModifiedAlpha)\r\n{\r\n\t#ifdef ALPHAPREMULTIPLY\r\n\t\tdiffColor *= alpha;\r\n\t\toutModifiedAlpha = 1.0 - oneMinusReflectivity + alpha * oneMinusReflectivity;\r\n\t#else\r\n\t\toutModifiedAlpha = alpha;\r\n\t#endif\r\n\treturn diffColor;\r\n}\r\n\r\n"),U.addInclude("PBRStandardLighting.glsl",'#include "PBRUtils.glsl"\r\n#include "BRDF.glsl"\r\n\r\nvec4 PBRStandardLight(in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\r\n{\r\n\tfloat oneMinusReflectivity;\r\n\tvec3 diffuseColor;\r\n\tvec3 specularColor;\r\n\tfloat alpha;\r\n\t\r\n\tdiffuseColor = DiffuseAndSpecularFromMetallic (albedoColor.rgb, metallic, specularColor, oneMinusReflectivity);\r\n\t\r\n\tdiffuseColor = LayaPreMultiplyAlpha(diffuseColor, albedoColor.a, oneMinusReflectivity, alpha);\r\n\t\r\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\r\n\tcolor.a = alpha;\r\n\treturn color;\r\n}\r\n\r\nvec4 PBRStandardDiectionLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in LayaGI gi,in float shadowValue)\r\n{\r\n\tvec3 lightVec = normalize(light.direction);\r\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.color*shadowValue, gi);\r\n}\r\n#ifdef POINTLIGHT\r\nvec4 PBRStandardPointLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in PointLight light, in vec3 pos, in LayaGI gi,in float shadowValue)\r\n{\r\n\tvec3 lightVec = pos-light.position;\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\r\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.color*shadowValue, gi) * attenuate;\r\n}\r\n#endif\r\nvec4 PBRStandardSpotLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi,in float shadowValue)\r\n{\r\n\tvec3 lightVec =  pos - light.position;\r\n\tvec3 normalLightVec = normalize(lightVec);\r\n\tvec2 cosAngles = cos(vec2(light.spot, light.spot*0.5) * 0.5);//ConeAttenuation\r\n\tfloat dl = dot(normalize(light.direction), normalLightVec);\r\n\tdl *= smoothstep(cosAngles[0], cosAngles[1], dl);\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range) * dl;\r\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.color*shadowValue, gi) * attenuate;\r\n\t\r\n}\r\n\r\n//vec4 PBRStandardSpotLight1 (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\r\n//{\r\n//\tvec4 lightCoord = u_SpotLightMatrix * vec4(pos, 1.0);\r\n//\t\r\n//\tfloat distance = dot(lightCoord, lightCoord);\r\n//\tfloat attenuate = (lightCoord.z < 0.0) ? texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\r\n//\t//float attenuate = (lightCoord.z < 0.0) ? texture2D(u_AngleTexture, vec2(lightCoord.x / lightCoord.w + 0.5, lightCoord.y / lightCoord.w + 0.5)).r * texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\r\n//\t//vec2 _uv = vec2(pos.x * 180.0/(2.0 * pos.z) + 0.5, pos.y * 180.0/(2.0 * pos.z) + 0.5);\r\n//\tvec3 lightVec = normalize(pos - light.position);\r\n//\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.color, gi) * attenuate;\r\n//}\r\n\r\nvec2 MetallicGloss(in float albedoTextureAlpha, in vec2 uv0)\r\n{\r\n\tvec2 mg;\r\n\t\r\n\t#ifdef METALLICGLOSSTEXTURE\r\n\t\tvec4 metallicGlossTextureColor = texture2D(u_MetallicGlossTexture, uv0);\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\tmg.r = metallicGlossTextureColor.r;\r\n\t\t\tmg.g = albedoTextureAlpha;\r\n\t\t#else\r\n\t\t    mg = metallicGlossTextureColor.ra;\r\n\t\t#endif\r\n\t\tmg.g *= u_smoothnessScale;\r\n\t#else\r\n\t\tmg.r = u_metallic;\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\tmg.g = albedoTextureAlpha * u_smoothnessScale;\r\n\t\t#else\r\n\t\t\tmg.g = u_smoothness;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\treturn mg;\r\n}\r\n\r\n'),U.addInclude("PBRSpecularLighting.glsl",'#include "PBRUtils.glsl"\r\n#include "BRDF.glsl"\r\n\r\nvec4 PBRSpecularLight(in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\r\n{\r\n\tfloat oneMinusReflectivity;\r\n\tvec3 diffuseColor;\r\n\tfloat alpha;\r\n\t\r\n\tdiffuseColor = EnergyConservationBetweenDiffuseAndSpecular (albedoColor.rgb, specularColor, oneMinusReflectivity);\r\n\t\r\n\tdiffuseColor = LayaPreMultiplyAlpha(diffuseColor, albedoColor.a, oneMinusReflectivity, alpha);\r\n\t\r\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\r\n\tcolor.a = alpha;\r\n\treturn color;\r\n}\r\n\r\nvec4 PBRSpecularDiectionLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in LayaGI gi,in float shadowValue)\r\n{\r\n\tvec3 lightVec = normalize(light.direction);\r\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.color*shadowValue, gi);\r\n}\r\n#ifdef POINTLIGHT\r\nvec4 PBRSpecularPointLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in PointLight light, in vec3 pos, in LayaGI gi,in float shadowValue)\r\n{\r\n\tvec3 lightVec = pos-light.position;\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range);\r\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.color*shadowValue, gi) * attenuate;\r\n}\r\n#endif\r\nvec4 PBRSpecularSpotLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi,in float shadowValue)\r\n{\r\n\tvec3 lightVec =  pos - light.position;\r\n\tvec3 normalLightVec = normalize(lightVec);\r\n\tvec2 cosAngles = cos(vec2(light.spot, light.spot*0.5) * 0.5);//ConeAttenuation\r\n\tfloat dl = dot(normalize(light.direction), normalLightVec);\r\n\tdl *= smoothstep(cosAngles[0], cosAngles[1], dl);\r\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.range) * dl;\r\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.color*shadowValue, gi) * attenuate;\r\n}\r\n\r\n//vec4 PBRStandardSpotLight1 (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\r\n//{\r\n//\tvec4 lightCoord = u_SpotLightMatrix * vec4(pos, 1.0);\r\n//\t\r\n//\tfloat distance = dot(lightCoord, lightCoord);\r\n//\tfloat attenuate = (lightCoord.z < 0.0) ? texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\r\n//\t//float attenuate = (lightCoord.z < 0.0) ? texture2D(u_AngleTexture, vec2(lightCoord.x / lightCoord.w + 0.5, lightCoord.y / lightCoord.w + 0.5)).r * texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\r\n//\t//vec2 _uv = vec2(pos.x * 180.0/(2.0 * pos.z) + 0.5, pos.y * 180.0/(2.0 * pos.z) + 0.5);\r\n//\tvec3 lightVec = normalize(pos - light.cosition);\r\n//\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.color, gi) * attenuate;\r\n//}\r\n\r\nvec4 SpecularGloss(float albedoTextureAlpha, in vec2 uv0)\r\n{\r\n    vec4 sg;\r\n\t\r\n\t#ifdef SPECULARTEXTURE\r\n\t\tvec4 specularTextureColor = texture2D(u_SpecularTexture, uv0);\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\tsg.rgb = specularTextureColor.rgb;\r\n\t\t\tsg.a = albedoTextureAlpha;\r\n\t\t#else\r\n\t\t\tsg = specularTextureColor;\r\n\t\t#endif\r\n\t\tsg.a *= u_smoothnessScale;\r\n\t#else\r\n\t\tsg.rgb = u_SpecularColor.rgb;\r\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\r\n\t\t\tsg.a = albedoTextureAlpha * u_smoothnessScale;\r\n\t\t#else\r\n\t\t\tsg.a = u_smoothness;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n    return sg;\r\n}\r\n\r\n'),U.addInclude("Colors.glsl",'#include "StdLib.glsl";\r\n\r\n#define EPSILON 1.0e-4\r\n\r\n// Quadratic color thresholding\r\n// curve = (threshold - knee, knee * 2, 0.25 / knee)\r\nmediump vec4 quadraticThreshold(mediump vec4 color, mediump float threshold, mediump vec3 curve) {\r\n\t// Pixel brightness\r\n\tmediump float br = max3(color.r, color.g, color.b);\r\n\r\n\t// Under-threshold part: quadratic curve\r\n\tmediump float rq = clamp(br - curve.x, 0.0, curve.y);\r\n\trq = curve.z * rq * rq;\r\n\r\n\t// Combine and apply the brightness response curve.\r\n\tcolor *= max(rq, br - threshold) / max(br, EPSILON);\r\n\r\n\treturn color;\r\n}\r\n\r\n\r\n\r\n//\r\n// sRGB transfer functions\r\n// Fast path ref: http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\r\n//\r\nmediump vec3 sRGBToLinear(mediump vec3 c) {\r\n\t#ifdef USE_VERY_FAST_SRGB\r\n\t\treturn c * c;\r\n\t#elif defined(USE_FAST_SRGB)\r\n\t\treturn c * (c * (c * 0.305306011 + 0.682171111) + 0.012522878);\r\n\t#else\r\n\t\tmediump vec3 linearRGBLo = c / 12.92;\r\n\t\tmediump vec3 power=vec3(2.4, 2.4, 2.4);\r\n\t\tmediump vec3 linearRGBHi = positivePow((c + 0.055) / 1.055, power);\r\n\t\tmediump vec3 linearRGB =vec3((c.r<=0.04045) ? linearRGBLo.r : linearRGBHi.r,(c.g<=0.04045) ? linearRGBLo.g : linearRGBHi.g,(c.b<=0.04045) ? linearRGBLo.b : linearRGBHi.b);\r\n\t\treturn linearRGB;\r\n\t#endif\r\n}\r\n\r\nmediump vec4 sRGBToLinear(mediump vec4 c){\r\n    return vec4(sRGBToLinear(c.rgb), c.a);\r\n}\r\n\r\n\r\n\r\nmediump vec3 linearToSRGB(mediump vec3 c) {\r\n\t#ifdef USE_VERY_FAST_SRGB\r\n\t\treturn sqrt(c);\r\n\t#elif defined(USE_FAST_SRGB)\r\n\t\treturn max(1.055 * PositivePow(c, 0.416666667) - 0.055, 0.0);\r\n\t#else\r\n\t\tmediump vec3 sRGBLo = c * 12.92;\r\n\t\tmediump vec3 power=vec3(1.0 / 2.4, 1.0 / 2.4, 1.0 / 2.4);\r\n\t\tmediump vec3 sRGBHi = (positivePow(c, power) * 1.055) - 0.055;\r\n\t\tmediump vec3 sRGB =vec3((c.r<=0.0031308) ? sRGBLo.r : sRGBHi.r,(c.g<=0.0031308) ? sRGBLo.g : sRGBHi.g,(c.b<=0.0031308) ? sRGBLo.b : sRGBHi.b);\r\n\t\treturn sRGB;\r\n\t#endif\r\n}\r\n\r\nmediump vec4 linearToSRGB(mediump vec4 c){\r\n    return vec4(linearToSRGB(c.rgb), c.a);\r\n}'),U.addInclude("Sampling.glsl","// Better, temporally stable box filtering\r\n// [Jimenez14] http://goo.gl/eomGso\r\n// . . . . . . .\r\n// . A . B . C .\r\n// . . D . E . .\r\n// . F . G . H .\r\n// . . I . J . .\r\n// . K . L . M .\r\n// . . . . . . .\r\nmediump vec4 downsampleBox13Tap(sampler2D tex, vec2 uv, vec2 texelSize)\r\n{\r\n    mediump vec4 A = texture2D(tex, uv + texelSize * vec2(-1.0, -1.0));\r\n    mediump vec4 B = texture2D(tex, uv + texelSize * vec2( 0.0, -1.0));\r\n    mediump vec4 C = texture2D(tex, uv + texelSize * vec2( 1.0, -1.0));\r\n    mediump vec4 D = texture2D(tex, uv + texelSize * vec2(-0.5, -0.5));\r\n    mediump vec4 E = texture2D(tex, uv + texelSize * vec2( 0.5, -0.5));\r\n    mediump vec4 F = texture2D(tex, uv + texelSize * vec2(-1.0,  0.0));\r\n    mediump vec4 G = texture2D(tex, uv);\r\n    mediump vec4 H = texture2D(tex, uv + texelSize * vec2( 1.0,  0.0));\r\n    mediump vec4 I = texture2D(tex, uv + texelSize * vec2(-0.5,  0.5));\r\n    mediump vec4 J = texture2D(tex, uv + texelSize * vec2( 0.5,  0.5));\r\n    mediump vec4 K = texture2D(tex, uv + texelSize * vec2(-1.0,  1.0));\r\n    mediump vec4 L = texture2D(tex, uv + texelSize * vec2( 0.0,  1.0));\r\n    mediump vec4 M = texture2D(tex, uv + texelSize * vec2( 1.0,  1.0));\r\n\r\n\tmediump vec2 scale= vec2(0.5, 0.125);\r\n    mediump vec2 div = (1.0 / 4.0) * scale;\r\n\r\n    mediump vec4 o = (D + E + I + J) * div.x;\r\n    o += (A + B + G + F) * div.y;\r\n    o += (B + C + H + G) * div.y;\r\n    o += (F + G + L + K) * div.y;\r\n    o += (G + H + M + L) * div.y;\r\n\r\n    return o;\r\n}\r\n\r\n// Standard box filtering\r\nmediump vec4 downsampleBox4Tap(sampler2D tex, vec2 uv, vec2 texelSize)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0);\r\n\r\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.xw);\r\n    s += texture2D(tex, uv + d.zw);\r\n\r\n    return s * (1.0 / 4.0);\r\n}\r\n\r\n// 9-tap bilinear upsampler (tent filter)\r\n// . . . . . . .\r\n// . 1 . 2 . 1 .\r\n// . . . . . . .\r\n// . 2 . 4 . 2 .\r\n// . . . . . . .\r\n// . 1 . 2 . 1 .\r\n// . . . . . . .\r\nmediump vec4 upsampleTent(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(1.0, 1.0, -1.0, 0.0) * sampleScale;\r\n\r\n    mediump vec4 s =  texture2D(tex, uv - d.xy);\r\n    s += texture2D(tex, uv - d.wy) * 2.0;\r\n    s += texture2D(tex, uv - d.zy);\r\n\r\n    s += texture2D(tex, uv + d.zw) * 2.0;\r\n    s += texture2D(tex, uv) * 4.0;\r\n    s += texture2D(tex,\tuv + d.xw) * 2.0;\r\n\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.wy) * 2.0;\r\n    s += texture2D(tex, uv + d.xy);\r\n\r\n    return s * (1.0 / 16.0);\r\n}\r\n\r\n// Standard box filtering\r\nmediump vec4 upsampleBox(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\r\n{\r\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0) * 0.5 * sampleScale;\r\n\r\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\r\n    s += texture2D(tex, uv + d.zy);\r\n    s += texture2D(tex, uv + d.xw);\r\n    s += texture2D(tex, uv + d.zw);\r\n\r\n    return s * (1.0 / 4.0);\r\n}"),U.addInclude("StdLib.glsl","#define HALF_MAX       65504.0 // (2 - 2^-10) * 2^15\r\n\r\n#define FLT_EPSILON    1.192092896e-07 // Smallest positive number, such that 1.0 + FLT_EPSILON != 1.0\r\n\r\nmediump vec4 safeHDR(mediump vec4 c)\r\n{\r\n    return min(c, HALF_MAX);\r\n}\r\n\r\nfloat max3(float a, float b, float c)\r\n{\r\n    return max(max(a, b), c);\r\n}\r\n\r\nvec3 positivePow(vec3 base, vec3 power)\r\n{\r\n    return pow(max(abs(base), vec3(FLT_EPSILON, FLT_EPSILON, FLT_EPSILON)), power);\r\n}");var e={a_Position:Te.MESH_POSITION0,a_Color:Te.MESH_COLOR0,a_Normal:Te.MESH_NORMAL0,a_Texcoord0:Te.MESH_TEXTURECOORDINATE0,a_Texcoord1:Te.MESH_TEXTURECOORDINATE1,a_BoneWeights:Te.MESH_BLENDWEIGHT0,a_BoneIndices:Te.MESH_BLENDINDICES0,a_Tangent0:Te.MESH_TANGENT0,a_MvpMatrix:Te.MESH_MVPMATRIX_ROW0,a_WorldMat:Te.MESH_WORLDMATRIX_ROW0},t={u_Bones:U.PERIOD_CUSTOM,u_DiffuseTexture:U.PERIOD_MATERIAL,u_SpecularTexture:U.PERIOD_MATERIAL,u_NormalTexture:U.PERIOD_MATERIAL,u_AlphaTestValue:U.PERIOD_MATERIAL,u_DiffuseColor:U.PERIOD_MATERIAL,u_MaterialSpecular:U.PERIOD_MATERIAL,u_Shininess:U.PERIOD_MATERIAL,u_TilingOffset:U.PERIOD_MATERIAL,u_WorldMat:U.PERIOD_SPRITE,u_MvpMatrix:U.PERIOD_SPRITE,u_LightmapScaleOffset:U.PERIOD_SPRITE,u_LightMap:U.PERIOD_SPRITE,u_CameraPos:U.PERIOD_CAMERA,u_Viewport:U.PERIOD_CAMERA,u_ProjectionParams:U.PERIOD_CAMERA,u_View:U.PERIOD_CAMERA,u_ReflectTexture:U.PERIOD_SCENE,u_ReflectIntensity:U.PERIOD_SCENE,u_FogStart:U.PERIOD_SCENE,u_FogRange:U.PERIOD_SCENE,u_FogColor:U.PERIOD_SCENE,u_DirationLightCount:U.PERIOD_SCENE,u_LightBuffer:U.PERIOD_SCENE,u_LightClusterBuffer:U.PERIOD_SCENE,u_AmbientColor:U.PERIOD_SCENE,u_shadowMap1:U.PERIOD_SCENE,u_shadowMap2:U.PERIOD_SCENE,u_shadowMap3:U.PERIOD_SCENE,u_shadowPSSMDistance:U.PERIOD_SCENE,u_lightShadowVP:U.PERIOD_SCENE,u_shadowPCFoffset:U.PERIOD_SCENE,"u_DirectionLight.color":U.PERIOD_SCENE,"u_DirectionLight.direction":U.PERIOD_SCENE,"u_PointLight.position":U.PERIOD_SCENE,"u_PointLight.range":U.PERIOD_SCENE,"u_PointLight.color":U.PERIOD_SCENE,"u_SpotLight.position":U.PERIOD_SCENE,"u_SpotLight.direction":U.PERIOD_SCENE,"u_SpotLight.range":U.PERIOD_SCENE,"u_SpotLight.spot":U.PERIOD_SCENE,"u_SpotLight.color":U.PERIOD_SCENE},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("BLINNPHONG",null,null,!0),i=new $n(e,t);r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\n\r\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\r\n\tattribute vec2 a_Texcoord0;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#if defined(LIGHTMAP)&&defined(UV1)\r\n\tattribute vec2 a_Texcoord1;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tuniform vec4 u_LightmapScaleOffset;\r\n\tvarying vec2 v_LightMapUV;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tattribute vec4 a_Color;\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\tattribute vec3 a_Normal;\r\n\tvarying vec3 v_Normal; \r\n\tuniform vec3 u_CameraPos;\r\n\tvarying vec3 v_ViewDir; \r\n#endif\r\n\r\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\r\n\tattribute vec4 a_Tangent0;\r\n\tvarying vec3 v_Tangent;\r\n\tvarying vec3 v_Binormal;\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\r\n\t#ifdef GPU_INSTANCE\r\n\t\tattribute mat4 a_WorldMat;\r\n\t#else\r\n\t\tuniform mat4 u_WorldMat;\r\n\t#endif\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\nvarying float v_posViewZ;\r\n#ifdef RECEIVESHADOW\r\n  #ifdef SHADOWMAP_PSSM1 \r\n  varying vec4 v_lightMVPPos;\r\n  uniform mat4 u_lightShadowVP[4];\r\n  #endif\r\n#endif\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\nvoid main_castShadow()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\t//TODO没考虑UV动画呢\r\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n\tv_posViewZ = gl_Position.z;\r\n}\r\n\r\nvoid main_normal()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\r\n\t\tmat4 worldMat;\r\n\t\t#ifdef GPU_INSTANCE\r\n\t\t\tworldMat = a_WorldMat;\r\n\t\t#else\r\n\t\t\tworldMat = u_WorldMat;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tmat3 worldInvMat;\r\n\t\t#ifdef BONE\r\n\t\t\tworldInvMat=inverse(mat3(worldMat*skinTransform));\r\n\t\t#else\r\n\t\t\tworldInvMat=inverse(mat3(worldMat));\r\n\t\t#endif  \r\n\t\tv_Normal=a_Normal*worldInvMat;\r\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\r\n\t\t\tv_Tangent=a_Tangent0.xyz*worldInvMat;\r\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\r\n\t\tv_PositionWorld=(worldMat*position).xyz;\r\n\t#endif\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\r\n\t#endif\r\n\r\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\r\n\t\t#ifdef TILINGOFFSET\r\n\t\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t\t#else\r\n\t\t\tv_Texcoord0=a_Texcoord0;\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#ifdef LIGHTMAP\r\n\t\t#ifdef SCALEOFFSETLIGHTINGMAPUV\r\n\t\t\t#ifdef UV1\r\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord1.x,1.0-a_Texcoord1.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\r\n\t\t\t#else\r\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,1.0-a_Texcoord0.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\r\n\t\t\t#endif \r\n\t\t\tv_LightMapUV.y=1.0-v_LightMapUV.y;\r\n\t\t#else\r\n\t\t\t#ifdef UV1\r\n\t\t\t\tv_LightMapUV=a_Texcoord1;\r\n\t\t\t#else\r\n\t\t\t\tv_LightMapUV=a_Texcoord0;\r\n\t\t\t#endif \r\n\t\t#endif \r\n\t#endif\r\n\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tv_Color=a_Color;\r\n\t#endif\r\n\r\n\t#ifdef RECEIVESHADOW\r\n\t\tv_posViewZ = gl_Position.w;\r\n\t\t#ifdef SHADOWMAP_PSSM1 \r\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\r\n\t\t#endif\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n\r\nvoid main()\r\n{\r\n\t#ifdef CASTSHADOW\r\n\t\tmain_castShadow();\r\n\t#else\r\n\t\tmain_normal();\r\n\t#endif\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n\tprecision highp int;\r\n#else\r\n\tprecision mediump float;\r\n\tprecision mediump int;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n\r\nuniform vec4 u_DiffuseColor;\r\n\r\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef ALPHATEST\r\n\tuniform float u_AlphaTestValue;\r\n#endif\r\n\r\n#ifdef DIFFUSEMAP\r\n\tuniform sampler2D u_DiffuseTexture;\r\n#endif\r\n\r\n\r\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tvarying vec2 v_LightMapUV;\r\n\tuniform sampler2D u_LightMap;\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\tvarying vec3 v_Normal;\r\n\tvarying vec3 v_ViewDir; \r\n\r\n\tuniform vec3 u_MaterialSpecular;\r\n\tuniform float u_Shininess;\r\n\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tuniform DirectionLight u_DirectionLight;\r\n\t\t#endif\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tuniform PointLight u_PointLight;\r\n\t\t#endif\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tuniform SpotLight u_SpotLight;\r\n\t\t#endif\r\n\t#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n\t#endif\r\n\r\n\t#ifdef SPECULARMAP \r\n\t\tuniform sampler2D u_SpecularTexture;\r\n\t#endif\r\n\t#ifdef NORMALMAP \r\n\t\tuniform sampler2D u_NormalTexture;\r\n\t\tvarying vec3 v_Tangent;\r\n\t\tvarying vec3 v_Binormal;\r\n\t#endif\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\n\r\nuniform vec3 u_AmbientColor;\r\n\r\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#include "ShadowHelper.glsl"\r\nvarying float v_posViewZ;\r\n#ifdef RECEIVESHADOW\r\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\r\n\t\tuniform mat4 u_lightShadowVP[4];\r\n\t#endif\r\n\t#ifdef SHADOWMAP_PSSM1 \r\n\t\tvarying vec4 v_lightMVPPos;\r\n\t#endif\r\n#endif\r\n\r\nvoid main_castShadow()\r\n{\r\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\r\n\tgl_FragColor=packDepth(v_posViewZ);\r\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\r\n\t\tif( alpha < u_AlphaTestValue )\r\n\t\t{\r\n\t\t\tdiscard;\r\n\t\t}\r\n\t#endif\r\n}\r\nvoid main_normal()\r\n{\r\n\tvec3 globalDiffuse=u_AmbientColor;\r\n\t#ifdef LIGHTMAP\t\r\n\t\tglobalDiffuse += DecodeLightmap(texture2D(u_LightMap, v_LightMapUV));\r\n\t#endif\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 normal;\r\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\r\n\t\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\r\n\t\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\r\n\t\t#else\r\n\t\t\tnormal = normalize(v_Normal);\r\n\t\t#endif\r\n\t\tvec3 viewDir= normalize(v_ViewDir);\r\n\t#endif\r\n\t\r\n\tvec4 mainColor=u_DiffuseColor;\r\n\t#ifdef DIFFUSEMAP\r\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\r\n\t\tmainColor=mainColor*difTexColor;\r\n\t#endif \r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tmainColor=mainColor*v_Color;\r\n\t#endif \r\n    \r\n\t#ifdef ALPHATEST\r\n\t\tif(mainColor.a<u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n  \r\n\t\r\n\tvec3 diffuse = vec3(0.0);\r\n\tvec3 specular= vec3(0.0);\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 dif,spe;\r\n\t\t#ifdef SPECULARMAP\r\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\r\n\t\t#else\r\n\t\t\t#ifdef DIFFUSEMAP\r\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\r\n\t\t\t#else\r\n\t\t\t\tvec3 gloss=vec3(1.0);\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,directionLight,dif,spe);\r\n\t\t\t\tdiffuse+=dif;\r\n\t\t\t\tspecular+=spe;\r\n\t\t\t}\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,pointLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,spotLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#ifdef RECEIVESHADOW\r\n\t\tfloat shadowValue = 1.0;\r\n\t\t#ifdef SHADOWMAP_PSSM3\r\n\t\t\tshadowValue = getShadowPSSM3(u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\r\n\t\t#endif\r\n\t\t#ifdef SHADOWMAP_PSSM2\r\n\t\t\tshadowValue = getShadowPSSM2(u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\r\n\t\t#endif \r\n\t\t#ifdef SHADOWMAP_PSSM1\r\n\t\t\tshadowValue = getShadowPSSM1(u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\r\n\t\t#endif\r\n\t\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse*shadowValue),mainColor.a);\r\n\t#else\r\n\t\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse),mainColor.a);\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t#ifdef RECEIVESHADOW\r\n\t\t\tgl_FragColor.rgb+=specular*shadowValue;\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb+=specular;\r\n\t\t#endif\r\n\t#endif\r\n\t  \r\n\t#ifdef FOG\r\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\r\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n\t#endif\r\n}\r\n\r\nvoid main()\r\n{\r\n\t#ifdef CASTSHADOW\t\t\r\n\t\tmain_castShadow();\r\n\t#else\r\n\t\tmain_normal();\r\n\t#endif  \r\n}\r\n\r\n',n),e={a_Position:Te.MESH_POSITION0,a_Color:Te.MESH_COLOR0},t={u_MvpMatrix:U.PERIOD_SPRITE,u_Color:U.PERIOD_MATERIAL},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("LineShader"),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nuniform mat4 u_MvpMatrix;\r\nuniform vec4 u_Color;\r\nattribute vec4 a_Color;\r\nvarying vec4 v_Color;\r\n\r\n\r\nvoid main()\r\n{\r\n\tgl_Position = u_MvpMatrix * a_Position;\r\n\tv_Color=a_Color*u_Color;\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nuniform vec4 u_Color;\r\n\r\nvoid main()\r\n{\r\n  gl_FragColor = v_Color * u_Color; \r\n}\r\n\r\n",n),e={a_Position:Te.MESH_POSITION0,a_Normal:Te.MESH_NORMAL0,a_Tangent0:Te.MESH_TANGENT0,a_Texcoord0:Te.MESH_TEXTURECOORDINATE0,a_BoneWeights:Te.MESH_BLENDWEIGHT0,a_BoneIndices:Te.MESH_BLENDINDICES0,a_MvpMatrix:Te.MESH_MVPMATRIX_ROW0,a_WorldMat:Te.MESH_WORLDMATRIX_ROW0},t={u_Bones:U.PERIOD_CUSTOM,u_MvpMatrix:U.PERIOD_SPRITE,u_WorldMat:U.PERIOD_SPRITE,u_CameraPos:U.PERIOD_CAMERA,u_View:U.PERIOD_CAMERA,u_ProjectionParams:U.PERIOD_CAMERA,u_Viewport:U.PERIOD_CAMERA,u_AlphaTestValue:U.PERIOD_MATERIAL,u_AlbedoColor:U.PERIOD_MATERIAL,u_EmissionColor:U.PERIOD_MATERIAL,u_AlbedoTexture:U.PERIOD_MATERIAL,u_NormalTexture:U.PERIOD_MATERIAL,u_ParallaxTexture:U.PERIOD_MATERIAL,u_MetallicGlossTexture:U.PERIOD_MATERIAL,u_OcclusionTexture:U.PERIOD_MATERIAL,u_EmissionTexture:U.PERIOD_MATERIAL,u_metallic:U.PERIOD_MATERIAL,u_smoothness:U.PERIOD_MATERIAL,u_smoothnessScale:U.PERIOD_MATERIAL,u_occlusionStrength:U.PERIOD_MATERIAL,u_normalScale:U.PERIOD_MATERIAL,u_parallaxScale:U.PERIOD_MATERIAL,u_TilingOffset:U.PERIOD_MATERIAL,u_ReflectTexture:U.PERIOD_SCENE,u_ReflectIntensity:U.PERIOD_SCENE,u_AmbientColor:U.PERIOD_SCENE,u_shadowMap1:U.PERIOD_SCENE,u_shadowMap2:U.PERIOD_SCENE,u_shadowMap3:U.PERIOD_SCENE,u_shadowPSSMDistance:U.PERIOD_SCENE,u_lightShadowVP:U.PERIOD_SCENE,u_shadowPCFoffset:U.PERIOD_SCENE,u_FogStart:U.PERIOD_SCENE,u_FogRange:U.PERIOD_SCENE,u_FogColor:U.PERIOD_SCENE,u_DirationLightCount:U.PERIOD_SCENE,u_LightBuffer:U.PERIOD_SCENE,u_LightClusterBuffer:U.PERIOD_SCENE,"u_DirectionLight.direction":U.PERIOD_SCENE,"u_DirectionLight.color":U.PERIOD_SCENE,"u_PointLight.position":U.PERIOD_SCENE,"u_PointLight.range":U.PERIOD_SCENE,"u_PointLight.color":U.PERIOD_SCENE,"u_SpotLight.position":U.PERIOD_SCENE,"u_SpotLight.direction":U.PERIOD_SCENE,"u_SpotLight.range":U.PERIOD_SCENE,"u_SpotLight.spot":U.PERIOD_SCENE,"u_SpotLight.color":U.PERIOD_SCENE},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("PBRStandard",null,null,!0),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec3 a_Normal;\r\nattribute vec4 a_Tangent0;\r\nattribute vec2 a_Texcoord0;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_WorldMat;\r\n#else\r\n\tuniform mat4 u_WorldMat;\r\n#endif\r\n\r\nuniform vec3 u_CameraPos;\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec3 v_PositionWorld;\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\nvarying float v_posViewZ;\r\n#ifdef RECEIVESHADOW\r\n  #ifdef SHADOWMAP_PSSM1 \r\n\t  varying vec4 v_lightMVPPos;\r\n\t  uniform mat4 u_lightShadowVP[4];\r\n  #endif\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nvoid main_castShadow()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t \r\n\t//TODO没考虑UV动画呢\r\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t\tv_Texcoord0 = a_Texcoord0;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n\tv_posViewZ = gl_Position.z;\r\n}\r\n\r\nvoid main_normal()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)||defined(REFLECTMAP)\r\n\t\tmat4 worldMat;\r\n\t\t#ifdef GPU_INSTANCE\r\n\t\t\tworldMat = a_WorldMat;\r\n\t\t#else\r\n\t\t\tworldMat = u_WorldMat;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\r\n\t\tmat3 worldInvMat;\r\n\t\t#ifdef BONE\r\n\t\t\tworldInvMat=inverse(mat3(worldMat*skinTransform));\r\n\t\t#else\r\n\t\t\tworldInvMat=inverse(mat3(worldMat));\r\n\t\t#endif  \r\n\t\tv_Normal=a_Normal*worldInvMat;\r\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))\r\n\t\t\tv_Tangent=a_Tangent0.xyz*worldInvMat;\r\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)||defined(REFLECTMAP)\r\n\t\tv_PositionWorld=(worldMat*position).xyz;\r\n\t#endif\r\n\t\r\n  \r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(REFLECTMAP)\r\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\r\n\t#endif\r\n\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t#else\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n  \r\n\t#ifdef RECEIVESHADOW\r\n\t\tv_posViewZ = gl_Position.w;\r\n\t\t#ifdef SHADOWMAP_PSSM1 \r\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\r\n\t\t#endif\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n\r\nvoid main()\r\n{\r\n\t#ifdef CASTSHADOW\r\n\t\tmain_castShadow();\r\n\t#else\r\n\t\tmain_normal();\r\n\t#endif\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec3 v_PositionWorld;\r\n\r\nuniform vec3 u_AmbientColor;\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef ALBEDOTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n#endif\r\n#ifdef METALLICGLOSSTEXTURE\r\n\tuniform sampler2D u_MetallicGlossTexture;\r\n#endif\r\n#ifdef NORMALTEXTURE\r\n\tuniform sampler2D u_NormalTexture;\r\n\tuniform float u_normalScale;\r\n#endif\r\n#ifdef PARALLAXTEXTURE\r\n\tuniform sampler2D u_ParallaxTexture;\r\n\tuniform float u_parallaxScale;\r\n#endif\r\n#ifdef OCCLUSIONTEXTURE\r\n\tuniform sampler2D u_OcclusionTexture;\r\n\tuniform float u_occlusionStrength;\r\n#endif\r\n#ifdef EMISSION\r\n\t#ifdef EMISSIONTEXTURE\r\n\t\tuniform sampler2D u_EmissionTexture;\r\n\t#endif\r\n\tuniform vec4 u_EmissionColor;\r\n#endif\r\n#ifdef REFLECTMAP\r\n\tuniform samplerCube u_ReflectTexture;\r\n\tuniform float u_ReflectIntensity;\r\n#endif\r\n\r\nuniform float u_AlphaTestValue;\r\nuniform float u_metallic;\r\nuniform float u_smoothness;\r\nuniform float u_smoothnessScale;\r\n\r\n\r\n\r\n\r\n#include "Lighting.glsl";\r\n#include "PBRStandardLighting.glsl"\r\n#include "ShadowHelper.glsl"\r\n\r\nvarying float v_posViewZ;\r\n#ifdef RECEIVESHADOW\r\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\r\n\t\tuniform mat4 u_lightShadowVP[4];\r\n\t#endif\r\n\t#ifdef SHADOWMAP_PSSM1 \r\n\t\tvarying vec4 v_lightMVPPos;\r\n\t#endif\r\n#endif\r\n\r\n#ifdef LEGACYSINGLELIGHTING\r\n\t#ifdef DIRECTIONLIGHT\r\n\t\tuniform DirectionLight u_DirectionLight;\r\n\t#endif\r\n\t#ifdef POINTLIGHT\r\n\t\tuniform PointLight u_PointLight;\r\n\t#endif\r\n\t#ifdef SPOTLIGHT\r\n\t\tuniform SpotLight u_SpotLight;\r\n\t#endif\r\n#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\nvoid main_castShadow()\r\n{\r\n\tgl_FragColor=packDepth(v_posViewZ);\r\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t\tfloat alpha = texture2D(u_AlbedoTexture,v_Texcoord0).w;\r\n\t\tif( alpha < u_AlphaTestValue )\r\n\t\t{\r\n\t\t\tdiscard;\r\n\t\t}\r\n\t#endif\r\n}\r\n\r\nvoid main_normal()\r\n{\t\r\n\tvec3 viewDir = normalize(v_ViewDir);\r\n\t\r\n\tvec2 uv0 = ParallaxOffset(viewDir);\r\n\t\r\n\tvec2 mg;\r\n\tvec4 albedoColor;\r\n\t#ifdef ALBEDOTEXTURE\r\n\t\tvec4 abledoTextureColor = texture2D(u_AlbedoTexture, uv0);\r\n\t\talbedoColor = abledoTextureColor * u_AlbedoColor;\r\n\t\tmg = MetallicGloss(abledoTextureColor.a, uv0);\r\n\t#else\r\n\t\talbedoColor = u_AlbedoColor;\r\n\t\tmg = MetallicGloss(1.0, uv0);\r\n\t#endif\r\n\t\r\n\t#ifdef ALPHATEST\r\n\t\tif(albedoColor.a < u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n\t\r\n\tvec3 normal = UnpackScaleNormal(uv0);\r\n  \r\n\tLayaGI gi;\r\n\tgi.diffuse = u_AmbientColor * Occlusion(uv0).rgb;\r\n\tgi.specular = ReflectCubeMap(viewDir, normal);\r\n  \r\n  \tfloat shadowValue = 1.0;\r\n\t#ifdef RECEIVESHADOW\r\n\t\r\n\t\t#ifdef SHADOWMAP_PSSM3\r\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\r\n\t\t#endif\r\n\t\t#ifdef SHADOWMAP_PSSM2\r\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\r\n\t\t#endif \r\n\t\t#ifdef SHADOWMAP_PSSM1\r\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\r\n\t\t#endif\r\n\t#endif\r\n\r\n\tvec4 color = vec4(0.0);\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tcolor += PBRStandardDiectionLight(albedoColor, mg.r, mg.g, normal, viewDir, u_DirectionLight, gi,shadowValue);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tcolor.a = 0.0;\r\n\t\t\tcolor += PBRStandardPointLight(albedoColor, mg.r, mg.g, normal, viewDir, u_PointLight, v_PositionWorld, gi,shadowValue);\r\n\t\t#endif\r\n\t\t\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tcolor.a = 0.0;\r\n\t\t\tcolor += PBRStandardSpotLight(albedoColor, mg.r, mg.g, normal, viewDir, u_SpotLight, v_PositionWorld, gi,shadowValue);\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\tcolor.a = 0.0;\r\n\t\t\t\tcolor += PBRStandardDiectionLight(albedoColor, mg.r, mg.g, normal, viewDir, directionLight, gi,shadowValue);\r\n\t\t\t}\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tcolor.a = 0.0;\r\n\t\t\t\t\tcolor += PBRStandardPointLight(albedoColor, mg.r, mg.g, normal, viewDir, pointLight, v_PositionWorld, gi,shadowValue);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tcolor.a = 0.0;\r\n\t\t\t\t\tcolor += PBRStandardSpotLight(albedoColor, mg.r, mg.g, normal, viewDir, spotLight, v_PositionWorld, gi,shadowValue);\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t\r\n\t#ifdef REFLECTMAP\r\n\t \tcolor += LayaAirStandardReflect(albedoColor,mg.r,mg.g,gi);\r\n\t#endif\r\n\r\n\t#ifdef EMISSION\r\n\t\tvec4 emissionColor = u_EmissionColor;\r\n\t\t#ifdef EMISSIONTEXTURE\r\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\r\n\t\t#endif\r\n\t\tcolor.rgb += emissionColor.rgb;\r\n\t#endif\r\n\t\r\n\t\tgl_FragColor = color;\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\r\n\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\r\n\t#endif\r\n}\r\n\r\nvoid main()\r\n{\r\n\t#ifdef CASTSHADOW\t\t\r\n\t\tmain_castShadow();\r\n\t#else\r\n\t\tmain_normal();\r\n\t#endif  \r\n}',n),e={a_Position:Te.MESH_POSITION0,a_Normal:Te.MESH_NORMAL0,a_Tangent0:Te.MESH_TANGENT0,a_Texcoord0:Te.MESH_TEXTURECOORDINATE0,a_BoneWeights:Te.MESH_BLENDWEIGHT0,a_BoneIndices:Te.MESH_BLENDINDICES0,a_MvpMatrix:Te.MESH_MVPMATRIX_ROW0,a_WorldMat:Te.MESH_WORLDMATRIX_ROW0},t={u_Bones:U.PERIOD_CUSTOM,u_MvpMatrix:U.PERIOD_SPRITE,u_WorldMat:U.PERIOD_SPRITE,u_CameraPos:U.PERIOD_CAMERA,u_View:U.PERIOD_CAMERA,u_ProjectionParams:U.PERIOD_CAMERA,u_Viewport:U.PERIOD_CAMERA,u_AlphaTestValue:U.PERIOD_MATERIAL,u_AlbedoColor:U.PERIOD_MATERIAL,u_SpecularColor:U.PERIOD_MATERIAL,u_EmissionColor:U.PERIOD_MATERIAL,u_AlbedoTexture:U.PERIOD_MATERIAL,u_NormalTexture:U.PERIOD_MATERIAL,u_ParallaxTexture:U.PERIOD_MATERIAL,u_SpecularTexture:U.PERIOD_MATERIAL,u_OcclusionTexture:U.PERIOD_MATERIAL,u_EmissionTexture:U.PERIOD_MATERIAL,u_smoothness:U.PERIOD_MATERIAL,u_smoothnessScale:U.PERIOD_MATERIAL,u_occlusionStrength:U.PERIOD_MATERIAL,u_normalScale:U.PERIOD_MATERIAL,u_parallaxScale:U.PERIOD_MATERIAL,u_TilingOffset:U.PERIOD_MATERIAL,u_ReflectTexture:U.PERIOD_SCENE,u_ReflectIntensity:U.PERIOD_SCENE,u_AmbientColor:U.PERIOD_SCENE,u_shadowMap1:U.PERIOD_SCENE,u_shadowMap2:U.PERIOD_SCENE,u_shadowMap3:U.PERIOD_SCENE,u_shadowPSSMDistance:U.PERIOD_SCENE,u_lightShadowVP:U.PERIOD_SCENE,u_shadowPCFoffset:U.PERIOD_SCENE,u_FogStart:U.PERIOD_SCENE,u_FogRange:U.PERIOD_SCENE,u_FogColor:U.PERIOD_SCENE,u_DirationLightCount:U.PERIOD_SCENE,u_LightBuffer:U.PERIOD_SCENE,u_LightClusterBuffer:U.PERIOD_SCENE,"u_DirectionLight.direction":U.PERIOD_SCENE,"u_DirectionLight.color":U.PERIOD_SCENE,"u_PointLight.position":U.PERIOD_SCENE,"u_PointLight.range":U.PERIOD_SCENE,"u_PointLight.color":U.PERIOD_SCENE,"u_SpotLight.position":U.PERIOD_SCENE,"u_SpotLight.direction":U.PERIOD_SCENE,"u_SpotLight.range":U.PERIOD_SCENE,"u_SpotLight.spot":U.PERIOD_SCENE,"u_SpotLight.color":U.PERIOD_SCENE},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("PBRSpecular",null,null,!0),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec3 a_Normal;\r\nattribute vec4 a_Tangent0;\r\nattribute vec2 a_Texcoord0;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_WorldMat;\r\n#else\r\n\tuniform mat4 u_WorldMat;\r\n#endif\r\nuniform vec3 u_CameraPos;\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec3 v_PositionWorld;\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\nvarying float v_posViewZ;\r\n#ifdef RECEIVESHADOW\r\n  #ifdef SHADOWMAP_PSSM1 \r\n\t  varying vec4 v_lightMVPPos;\r\n\t  uniform mat4 u_lightShadowVP[4];\r\n  #endif\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nvoid main_castShadow()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t \r\n\t//TODO没考虑UV动画呢\r\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t\tv_Texcoord0 = a_Texcoord0;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n\tv_posViewZ = gl_Position.z;\r\n}\r\n\r\nvoid main_normal()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)||defined(REFLECTMAP)\r\n\t\tmat4 worldMat;\r\n\t\t#ifdef GPU_INSTANCE\r\n\t\t\tworldMat = a_WorldMat;\r\n\t\t#else\r\n\t\t\tworldMat = u_WorldMat;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\r\n\t\tmat3 worldInvMat;\r\n\t\t#ifdef BONE\r\n\t\t\tworldInvMat=inverse(mat3(worldMat*skinTransform));\r\n\t\t#else\r\n\t\t\tworldInvMat=inverse(mat3(worldMat));\r\n\t\t#endif  \r\n\t\tv_Normal=a_Normal*worldInvMat;\r\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))\r\n\t\t\tv_Tangent=a_Tangent0.xyz*worldInvMat;\r\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)||defined(REFLECTMAP)\r\n\t\tv_PositionWorld=(worldMat*position).xyz;\r\n\t#endif\r\n\t\r\n  \r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\r\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\r\n\t#endif\r\n\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t#else\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n  \r\n\t#ifdef RECEIVESHADOW\r\n\t\tv_posViewZ = gl_Position.w;\r\n\t\t#ifdef SHADOWMAP_PSSM1 \r\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\r\n\t\t#endif\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n\r\nvoid main()\r\n{\r\n\t#ifdef CASTSHADOW\r\n\t\tmain_castShadow();\r\n\t#else\r\n\t\tmain_normal();\r\n\t#endif\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec3 v_PositionWorld;\r\n\r\nuniform vec3 u_AmbientColor;\r\nuniform vec4 u_AlbedoColor;\r\nuniform vec4 u_SpecularColor;\r\n\r\n#ifdef ALBEDOTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n#endif\r\n#ifdef SPECULARTEXTURE\r\n\tuniform sampler2D u_SpecularTexture;\r\n#endif\r\n#ifdef NORMALTEXTURE\r\n\tuniform sampler2D u_NormalTexture;\r\n\tuniform float u_normalScale;\r\n#endif\r\n#ifdef PARALLAXTEXTURE\r\n\tuniform sampler2D u_ParallaxTexture;\r\n\tuniform float u_parallaxScale;\r\n#endif\r\n#ifdef OCCLUSIONTEXTURE\r\n\tuniform sampler2D u_OcclusionTexture;\r\n\tuniform float u_occlusionStrength;\r\n#endif\r\n#ifdef EMISSION\r\n\t#ifdef EMISSIONTEXTURE\r\n\t\tuniform sampler2D u_EmissionTexture;\r\n\t#endif\r\n\tuniform vec4 u_EmissionColor;\r\n#endif\r\n#ifdef REFLECTMAP\r\n\tuniform samplerCube u_ReflectTexture;\r\n\tuniform float u_ReflectIntensity;\r\n#endif\r\n\r\nuniform float u_AlphaTestValue;\r\nuniform float u_metallic;\r\nuniform float u_smoothness;\r\nuniform float u_smoothnessScale;\r\n\r\n\r\n\r\n#include "Lighting.glsl";\r\n#include "PBRSpecularLighting.glsl"\r\n#include "ShadowHelper.glsl"\r\n\r\nvarying float v_posViewZ;\r\n#ifdef RECEIVESHADOW\r\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\r\n\t\tuniform mat4 u_lightShadowVP[4];\r\n\t#endif\r\n\t#ifdef SHADOWMAP_PSSM1 \r\n\t\tvarying vec4 v_lightMVPPos;\r\n\t#endif\r\n#endif\r\n\r\n#ifdef LEGACYSINGLELIGHTING\r\n\t#ifdef DIRECTIONLIGHT\r\n\t\tuniform DirectionLight u_DirectionLight;\r\n\t#endif\r\n\t#ifdef POINTLIGHT\r\n\t\tuniform PointLight u_PointLight;\r\n\t#endif\r\n\t#ifdef SPOTLIGHT\r\n\t\tuniform SpotLight u_SpotLight;\r\n\t#endif\r\n#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\nvoid main_castShadow()\r\n{\r\n\tgl_FragColor=packDepth(v_posViewZ);\r\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\r\n\t\tfloat alpha = texture2D(u_AlbedoTexture,v_Texcoord0).w;\r\n\t\tif( alpha < u_AlphaTestValue )\r\n\t\t{\r\n\t\t\tdiscard;\r\n\t\t}\r\n\t#endif\r\n}\r\n\r\nvoid main_normal()\r\n{\t\r\n\tvec3 viewDir = normalize(v_ViewDir);\r\n\t\r\n\tvec2 uv0 = ParallaxOffset(viewDir);\r\n\t\r\n\tvec4 sg;\r\n\tvec4 albedoColor;\r\n\t#ifdef ALBEDOTEXTURE\r\n\t\tvec4 albedoTextureColor = texture2D(u_AlbedoTexture, uv0);\r\n\t\talbedoColor = albedoTextureColor * u_AlbedoColor;\r\n\t\tsg = SpecularGloss(albedoTextureColor.a, uv0);\r\n\t#else\r\n\t\talbedoColor = u_AlbedoColor;\r\n\t\tsg = SpecularGloss(1.0, uv0);\r\n\t#endif\r\n\t\r\n\t#ifdef ALPHATEST\r\n\t\tif(albedoColor.a < u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n  \r\n\tvec3 normal = UnpackScaleNormal(uv0);\r\n\t\r\n\tLayaGI gi;\r\n\tgi.diffuse = u_AmbientColor * Occlusion(uv0).rgb;\r\n\tgi.specular = ReflectCubeMap(viewDir, normal);\r\n\t\r\n\t//float a = (sg.r+sg.g+sg.b) / 3.0;\r\n  \tfloat shadowValue = 1.0;\r\n\t#ifdef RECEIVESHADOW\r\n\t\t\r\n\t\t#ifdef SHADOWMAP_PSSM3\r\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\r\n\t\t#endif\r\n\t\t#ifdef SHADOWMAP_PSSM2\r\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\r\n\t\t#endif \r\n\t\t#ifdef SHADOWMAP_PSSM1\r\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\r\n\t\t#endif\r\n\t#endif\r\n\tvec4 color = vec4(0.0);\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tcolor += PBRSpecularDiectionLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_DirectionLight, gi,shadowValue);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tcolor.a = 0.0;\r\n\t\t\tcolor += PBRSpecularPointLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_PointLight, v_PositionWorld, gi,shadowValue);\r\n\t\t#endif\r\n\t\t\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tcolor.a = 0.0;\r\n\t\t\tcolor += PBRSpecularSpotLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_SpotLight, v_PositionWorld, gi,shadowValue);\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\tcolor.a = 0.0;\r\n\t\t\t\tcolor +=PBRSpecularDiectionLight(albedoColor, sg.rgb, sg.a, normal, viewDir, directionLight, gi,shadowValue);\r\n\t\t\t}\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tcolor.a = 0.0;\r\n\t\t\t\t\tcolor +=PBRSpecularPointLight(albedoColor, sg.rgb, sg.a, normal, viewDir, pointLight, v_PositionWorld, gi,shadowValue);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tcolor.a = 0.0;\r\n\t\t\t\t\tcolor += PBRSpecularSpotLight(albedoColor, sg.rgb, sg.a, normal, viewDir, spotLight, v_PositionWorld, gi,shadowValue);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\t#ifdef REFLECTMAP\r\n\t \tcolor += LayaAirSpecularReflect(albedoColor,sg.rgb,sg.a,gi);\r\n\t#endif\r\n\r\n\t#ifdef EMISSION\r\n\t\tvec4 emissionColor = u_EmissionColor;\r\n\t\t#ifdef EMISSIONTEXTURE\r\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\r\n\t\t#endif\r\n\t\tcolor.rgb += emissionColor.rgb;\r\n\t#endif\r\n\r\n\tgl_FragColor = color;\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\r\n\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\r\n\t#endif\r\n}\r\n\r\nvoid main()\r\n{\r\n\t#ifdef CASTSHADOW\t\t\r\n\t\tmain_castShadow();\r\n\t#else\r\n\t\tmain_normal();\r\n\t#endif  \r\n}\r\n\r\n',n),e={a_Position:Te.MESH_POSITION0,a_Color:Te.MESH_COLOR0,a_Texcoord0:Te.MESH_TEXTURECOORDINATE0,a_BoneWeights:Te.MESH_BLENDWEIGHT0,a_BoneIndices:Te.MESH_BLENDINDICES0,a_MvpMatrix:Te.MESH_MVPMATRIX_ROW0},t={u_Bones:U.PERIOD_CUSTOM,u_AlbedoTexture:U.PERIOD_MATERIAL,u_AlbedoColor:U.PERIOD_MATERIAL,u_TilingOffset:U.PERIOD_MATERIAL,u_AlphaTestValue:U.PERIOD_MATERIAL,u_MvpMatrix:U.PERIOD_SPRITE,u_FogStart:U.PERIOD_SCENE,u_FogRange:U.PERIOD_SCENE,u_FogColor:U.PERIOD_SCENE},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("Unlit",null,null,!0),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\n\r\nattribute vec2 a_Texcoord0;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\nattribute vec4 a_Color;\r\nvarying vec4 v_Color;\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nvoid main() {\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t#else\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tv_Color = a_Color;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\tvarying vec4 v_Color;\r\n#endif\r\n\r\n#ifdef ALBEDOTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n\tvarying vec2 v_Texcoord0;\r\n#endif\r\n\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef ALPHATEST\r\n\tuniform float u_AlphaTestValue;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 color =  u_AlbedoColor;\r\n\t#ifdef ALBEDOTEXTURE\r\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\r\n\t#endif\r\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\r\n\t\tcolor *= v_Color;\r\n\t#endif\r\n\t\r\n\t#ifdef ALPHATEST\r\n\t\tif(color.a < u_AlphaTestValue)\r\n\t\t\tdiscard;\r\n\t#endif\r\n\t\r\n\tgl_FragColor = color;\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n}\r\n\r\n",n),e={a_Position:Te.MESH_POSITION0,a_Texcoord0:Te.MESH_TEXTURECOORDINATE0,a_BoneWeights:Te.MESH_BLENDWEIGHT0,a_BoneIndices:Te.MESH_BLENDINDICES0,a_MvpMatrix:Te.MESH_MVPMATRIX_ROW0},t={u_Bones:U.PERIOD_CUSTOM,u_AlbedoTexture:U.PERIOD_MATERIAL,u_AlbedoColor:U.PERIOD_MATERIAL,u_TilingOffset:U.PERIOD_MATERIAL,u_AlphaTestValue:U.PERIOD_MATERIAL,u_MvpMatrix:U.PERIOD_SPRITE,u_FogStart:U.PERIOD_SCENE,u_FogRange:U.PERIOD_SCENE,u_FogColor:U.PERIOD_SCENE},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("Effect",null,null,!0),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec4 a_Color;\r\nattribute vec2 a_Texcoord0;\r\n\r\n#ifdef GPU_INSTANCE\r\n\tattribute mat4 a_MvpMatrix;\r\n#else\r\n\tuniform mat4 u_MvpMatrix;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tvarying vec4 v_Color;\r\n#endif\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\n#ifdef BONE\r\n\tconst int c_MaxBoneCount = 24;\r\n\tattribute vec4 a_BoneIndices;\r\n\tattribute vec4 a_BoneWeights;\r\n\tuniform mat4 u_Bones[c_MaxBoneCount];\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 position;\r\n\t#ifdef BONE\r\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\r\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\r\n\t\tposition=skinTransform*a_Position;\r\n\t#else\r\n\t\tposition=a_Position;\r\n\t#endif\r\n\t#ifdef GPU_INSTANCE\r\n\t\tgl_Position = a_MvpMatrix * position;\r\n\t#else\r\n\t\tgl_Position = u_MvpMatrix * position;\r\n\t#endif\r\n\t\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\r\n\t#else\r\n\t\tv_Texcoord0=a_Texcoord0;\r\n\t#endif\r\n\t\t\r\n\t#ifdef COLOR\r\n\t\tv_Color = a_Color;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#ifdef COLOR\r\n\tvarying vec4 v_Color;\r\n#endif\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef MAINTEXTURE\r\n\tuniform sampler2D u_AlbedoTexture;\r\n#endif\r\n\r\nuniform vec4 u_AlbedoColor;\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 color =  2.0 * u_AlbedoColor;\r\n\t#ifdef COLOR\r\n\t\tcolor *= v_Color;\r\n\t#endif\r\n\t#ifdef MAINTEXTURE\r\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\r\n\t#endif\r\n\t\r\n\tgl_FragColor = color;\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n}\r\n\r\n",n),e={a_CornerTextureCoordinate:Pt.PARTICLE_CORNERTEXTURECOORDINATE0,a_MeshPosition:Pt.PARTICLE_POSITION0,a_MeshColor:Pt.PARTICLE_COLOR0,a_MeshTextureCoordinate:Pt.PARTICLE_TEXTURECOORDINATE0,a_ShapePositionStartLifeTime:Pt.PARTICLE_SHAPEPOSITIONSTARTLIFETIME,a_DirectionTime:Pt.PARTICLE_DIRECTIONTIME,a_StartColor:Pt.PARTICLE_STARTCOLOR0,a_EndColor:Pt.PARTICLE_ENDCOLOR0,a_StartSize:Pt.PARTICLE_STARTSIZE,a_StartRotation0:Pt.PARTICLE_STARTROTATION,a_StartSpeed:Pt.PARTICLE_STARTSPEED,a_Random0:Pt.PARTICLE_RANDOM0,a_Random1:Pt.PARTICLE_RANDOM1,a_SimulationWorldPostion:Pt.PARTICLE_SIMULATIONWORLDPOSTION,a_SimulationWorldRotation:Pt.PARTICLE_SIMULATIONWORLDROTATION},t={u_Tintcolor:U.PERIOD_MATERIAL,u_TilingOffset:U.PERIOD_MATERIAL,u_texture:U.PERIOD_MATERIAL,u_WorldPosition:U.PERIOD_SPRITE,u_WorldRotation:U.PERIOD_SPRITE,u_PositionScale:U.PERIOD_SPRITE,u_SizeScale:U.PERIOD_SPRITE,u_ScalingMode:U.PERIOD_SPRITE,u_Gravity:U.PERIOD_SPRITE,u_ThreeDStartRotation:U.PERIOD_SPRITE,u_StretchedBillboardLengthScale:U.PERIOD_SPRITE,u_StretchedBillboardSpeedScale:U.PERIOD_SPRITE,u_SimulationSpace:U.PERIOD_SPRITE,u_CurrentTime:U.PERIOD_SPRITE,u_ColorOverLifeGradientAlphas:U.PERIOD_SPRITE,u_ColorOverLifeGradientColors:U.PERIOD_SPRITE,u_MaxColorOverLifeGradientAlphas:U.PERIOD_SPRITE,u_MaxColorOverLifeGradientColors:U.PERIOD_SPRITE,u_VOLVelocityConst:U.PERIOD_SPRITE,u_VOLVelocityGradientX:U.PERIOD_SPRITE,u_VOLVelocityGradientY:U.PERIOD_SPRITE,u_VOLVelocityGradientZ:U.PERIOD_SPRITE,u_VOLVelocityConstMax:U.PERIOD_SPRITE,u_VOLVelocityGradientMaxX:U.PERIOD_SPRITE,u_VOLVelocityGradientMaxY:U.PERIOD_SPRITE,u_VOLVelocityGradientMaxZ:U.PERIOD_SPRITE,u_VOLSpaceType:U.PERIOD_SPRITE,u_SOLSizeGradient:U.PERIOD_SPRITE,u_SOLSizeGradientX:U.PERIOD_SPRITE,u_SOLSizeGradientY:U.PERIOD_SPRITE,u_SOLSizeGradientZ:U.PERIOD_SPRITE,u_SOLSizeGradientMax:U.PERIOD_SPRITE,u_SOLSizeGradientMaxX:U.PERIOD_SPRITE,u_SOLSizeGradientMaxY:U.PERIOD_SPRITE,u_SOLSizeGradientMaxZ:U.PERIOD_SPRITE,u_ROLAngularVelocityConst:U.PERIOD_SPRITE,u_ROLAngularVelocityConstSeprarate:U.PERIOD_SPRITE,u_ROLAngularVelocityGradient:U.PERIOD_SPRITE,u_ROLAngularVelocityGradientX:U.PERIOD_SPRITE,u_ROLAngularVelocityGradientY:U.PERIOD_SPRITE,u_ROLAngularVelocityGradientZ:U.PERIOD_SPRITE,u_ROLAngularVelocityConstMax:U.PERIOD_SPRITE,u_ROLAngularVelocityConstMaxSeprarate:U.PERIOD_SPRITE,u_ROLAngularVelocityGradientMax:U.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxX:U.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxY:U.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxZ:U.PERIOD_SPRITE,u_ROLAngularVelocityGradientMaxW:U.PERIOD_SPRITE,u_TSACycles:U.PERIOD_SPRITE,u_TSASubUVLength:U.PERIOD_SPRITE,u_TSAGradientUVs:U.PERIOD_SPRITE,u_TSAMaxGradientUVs:U.PERIOD_SPRITE,u_CameraPos:U.PERIOD_CAMERA,u_CameraDirection:U.PERIOD_CAMERA,u_CameraUp:U.PERIOD_CAMERA,u_View:U.PERIOD_CAMERA,u_Projection:U.PERIOD_CAMERA,u_FogStart:U.PERIOD_SCENE,u_FogRange:U.PERIOD_SCENE,u_FogColor:U.PERIOD_SCENE},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("PARTICLESHURIKEN"),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\n#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n  precision highp float;\r\n#else\r\n  precision mediump float;\r\n#endif\r\n\r\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\r\n\tattribute vec4 a_CornerTextureCoordinate;\r\n#endif\r\n#ifdef RENDERMODE_MESH\r\n\tattribute vec3 a_MeshPosition;\r\n\tattribute vec4 a_MeshColor;\r\n\tattribute vec2 a_MeshTextureCoordinate;\r\n\tvarying vec4 v_MeshColor;\r\n#endif\r\n\r\nattribute vec4 a_ShapePositionStartLifeTime;\r\nattribute vec4 a_DirectionTime;\r\nattribute vec4 a_StartColor;\r\nattribute vec3 a_StartSize;\r\nattribute vec3 a_StartRotation0;\r\nattribute float a_StartSpeed;\r\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n  attribute vec4 a_Random0;\r\n#endif\r\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  attribute vec4 a_Random1;\r\n#endif\r\nattribute vec3 a_SimulationWorldPostion;\r\nattribute vec4 a_SimulationWorldRotation;\r\n\r\nvarying vec4 v_Color;\r\n#ifdef DIFFUSEMAP\r\n\tvarying vec2 v_TextureCoordinate;\r\n#endif\r\n\r\nuniform float u_CurrentTime;\r\nuniform vec3 u_Gravity;\r\n\r\nuniform vec3 u_WorldPosition;\r\nuniform vec4 u_WorldRotation;\r\nuniform bool u_ThreeDStartRotation;\r\nuniform int u_ScalingMode;\r\nuniform vec3 u_PositionScale;\r\nuniform vec3 u_SizeScale;\r\nuniform mat4 u_View;\r\nuniform mat4 u_Projection;\r\n\r\n#ifdef STRETCHEDBILLBOARD\r\n\tuniform vec3 u_CameraPos;\r\n#endif\r\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\r\nuniform vec3 u_CameraUp;\r\n\r\nuniform  float u_StretchedBillboardLengthScale;\r\nuniform  float u_StretchedBillboardSpeedScale;\r\nuniform int u_SimulationSpace;\r\n\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  uniform  int  u_VOLSpaceType;\r\n#endif\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\r\n  uniform  vec3 u_VOLVelocityConst;\r\n#endif\r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\r\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\r\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\r\n#endif\r\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n  uniform  vec3 u_VOLVelocityConstMax;\r\n#endif\r\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\r\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\r\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\r\n#endif\r\n\r\n#ifdef COLOROVERLIFETIME\r\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\r\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\r\n#endif\r\n#ifdef RANDOMCOLOROVERLIFETIME\r\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\r\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\r\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\r\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\r\n#endif\r\n\r\n\r\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\r\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\r\n#endif\r\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\r\n#endif\r\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\r\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\r\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\r\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\r\n#endif\r\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\r\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\r\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\r\n#endif\r\n\r\n\r\n#ifdef ROTATIONOVERLIFETIME\r\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\r\n    uniform  float u_ROLAngularVelocityConst;\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n    uniform  float u_ROLAngularVelocityConstMax;\r\n  #endif\r\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\r\n  #endif\r\n#endif\r\n#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\r\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\r\n  #endif\r\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\r\n  #endif\r\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\r\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\r\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\r\n  #endif\r\n#endif\r\n\r\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\r\n  uniform  float u_TSACycles;\r\n  uniform  vec2 u_TSASubUVLength;\r\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\r\n#endif\r\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\r\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\r\n#endif\r\n\r\n#ifdef TILINGOFFSET\r\n\tuniform vec4 u_TilingOffset;\r\n#endif\r\n\r\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\r\n{\r\n\tfloat halfRoll = rot.z * 0.5;\r\n    float halfPitch = rot.x * 0.5;\r\n\tfloat halfYaw = rot.y * 0.5;\r\n\r\n\tfloat sinRoll = sin(halfRoll);\r\n\tfloat cosRoll = cos(halfRoll);\r\n\tfloat sinPitch = sin(halfPitch);\r\n\tfloat cosPitch = cos(halfPitch);\r\n\tfloat sinYaw = sin(halfYaw);\r\n\tfloat cosYaw = cos(halfYaw);\r\n\r\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\r\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\r\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\r\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\r\n\t\r\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\r\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\r\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\r\n\t\r\n\tfloat x = quaX + quaX;\r\n    float y = quaY + quaY;\r\n    float z = quaZ + quaZ;\r\n    float wx = quaW * x;\r\n    float wy = quaW * y;\r\n    float wz = quaW * z;\r\n\tfloat xx = quaX * x;\r\n    float xy = quaX * y;\r\n\tfloat xz = quaX * z;\r\n    float yy = quaY * y;\r\n    float yz = quaY * z;\r\n    float zz = quaZ * z;\r\n\r\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\r\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\r\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\r\n\t\r\n}\r\n\r\n//假定axis已经归一化\r\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\r\n{\r\n\tfloat halfAngle = angle * 0.5;\r\n\tfloat sin = sin(halfAngle);\r\n\t\r\n\tfloat quaX = axis.x * sin;\r\n\tfloat quaY = axis.y * sin;\r\n\tfloat quaZ = axis.z * sin;\r\n\tfloat quaW = cos(halfAngle);\r\n\t\r\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\r\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\r\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\r\n\t\r\n\tfloat x = quaX + quaX;\r\n    float y = quaY + quaY;\r\n    float z = quaZ + quaZ;\r\n    float wx = quaW * x;\r\n    float wy = quaW * y;\r\n    float wz = quaW * z;\r\n\tfloat xx = quaX * x;\r\n    float xy = quaX * y;\r\n\tfloat xz = quaX * z;\r\n    float yy = quaY * y;\r\n    float yz = quaY * z;\r\n    float zz = quaZ * z;\r\n\r\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\r\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\r\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\r\n\t\r\n}\r\n\r\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \r\n{\r\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\r\n}\r\n\r\n \r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\r\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\r\n{\r\n\tfloat curValue;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientNumber=gradientNumbers[i];\r\n\t\tfloat key=gradientNumber.x;\r\n\t\tif(key>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\r\n\t\t\tfloat lastKey=lastGradientNumber.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn curValue;\r\n}\r\n#endif\r\n\r\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\r\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\r\n{\r\n\tfloat totalValue=0.0;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientNumber=gradientNumbers[i];\r\n\t\tfloat key=gradientNumber.x;\r\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\r\n\t\tfloat lastValue=lastGradientNumber.y;\r\n\t\t\r\n\t\tif(key>=normalizedAge){\r\n\t\t\tfloat lastKey=lastGradientNumber.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\telse{\r\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\r\n\t\t}\r\n\t}\r\n\treturn totalValue;\r\n}\r\n#endif\r\n\r\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\r\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\r\n{\r\n\tvec4 overTimeColor;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientAlpha=gradientAlphas[i];\r\n\t\tfloat alphaKey=gradientAlpha.x;\r\n\t\tif(alphaKey>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\r\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\r\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\r\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\t\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec4 gradientColor=gradientColors[i];\r\n\t\tfloat colorKey=gradientColor.x;\r\n\t\tif(colorKey>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\r\n\t\t\tfloat lastColorKey=lastGradientColor.x;\r\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\r\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn overTimeColor;\r\n}\r\n#endif\r\n\r\n\r\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\r\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\r\n{\r\n\tfloat overTimeFrame;\r\n\tfor(int i=1;i<4;i++)\r\n\t{\r\n\t\tvec2 gradientFrame=gradientFrames[i];\r\n\t\tfloat key=gradientFrame.x;\r\n\t\tif(key>=normalizedAge)\r\n\t\t{\r\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\r\n\t\t\tfloat lastKey=lastGradientFrame.x;\r\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\r\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\treturn floor(overTimeFrame);\r\n}\r\n#endif\r\n\r\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\nvec3 computeParticleLifeVelocity(in float normalizedAge)\r\n{\r\n  vec3 outLifeVelocity;\r\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\r\n\t outLifeVelocity=u_VOLVelocityConst; \r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMECURVE\r\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \r\n  #endif\r\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\r\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\r\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\r\n  #endif\r\n\t\t\t\t\t\r\n  return outLifeVelocity;\r\n} \r\n#endif\r\n\r\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\r\n{\r\n   vec3 startPosition;\r\n   vec3 lifePosition;\r\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=lifeVelocity*age;\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMECURVE\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=lifeVelocity*age;\r\n\t#endif\r\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\r\n\t\t  startPosition=startVelocity*age;\r\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\r\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\r\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\r\n\t#endif\r\n\t\r\n\tvec3 finalPosition;\r\n\tif(u_VOLSpaceType==0){\r\n\t  if(u_ScalingMode!=2)\r\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\r\n\t  else\r\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\r\n\t}\r\n\telse{\r\n\t  if(u_ScalingMode!=2)\r\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\r\n\t  else\r\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\r\n\t}\r\n  #else\r\n\t startPosition=startVelocity*age;\r\n\t vec3 finalPosition;\r\n\t if(u_ScalingMode!=2)\r\n\t\t\tfinalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\r\n\t else\r\n\t   \tfinalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\r\n  #endif\r\n  \r\n  if(u_SimulationSpace==0)\r\n    finalPosition=finalPosition+a_SimulationWorldPostion;\r\n  else if(u_SimulationSpace==1) \r\n    finalPosition=finalPosition+u_WorldPosition;\r\n  \r\n  finalPosition+=0.5*gravityVelocity*age;\r\n \r\n  return  finalPosition;\r\n}\r\n\r\n\r\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\r\n{\r\n\t#ifdef COLOROVERLIFETIME\r\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\r\n\t#endif\r\n\t\r\n\t#ifdef RANDOMCOLOROVERLIFETIME\r\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\r\n\t#endif\r\n\r\n    return color;\r\n}\r\n\r\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\r\n{\r\n\t#ifdef SIZEOVERLIFETIMECURVE\r\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\r\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\r\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\r\n\t#endif\r\n\treturn size;\r\n}\r\n\r\n#ifdef RENDERMODE_MESH\r\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\r\n{\r\n\t#ifdef SIZEOVERLIFETIMECURVE\r\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\r\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\r\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\r\n\t#endif\r\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\r\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\r\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\r\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\r\n\t#endif\r\n\treturn size;\r\n}\r\n#endif\r\n\r\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\r\n{ \r\n\t#ifdef ROTATIONOVERLIFETIME\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\r\n\t\t#endif\r\n\t#endif\r\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\r\n\t\t#endif\r\n\t#endif\r\n\treturn rotation;\r\n}\r\n\r\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\r\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\r\n{ \r\n\t#ifdef ROTATIONOVERLIFETIME\r\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\r\n\t\t#endif\r\n\t#endif\r\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\r\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\r\n\t        rotation+=ageRot;\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\r\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\r\n\t\t#endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\r\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\r\n\t        rotation+=ageRot;\r\n\t    #endif\r\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\r\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\r\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\r\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\r\n\t\t#endif\r\n\t#endif\r\n\treturn rotation;\r\n}\r\n#endif\r\n\r\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\r\n{ \r\n\t#ifdef TEXTURESHEETANIMATIONCURVE\r\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\r\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\r\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\r\n\t\tfloat floorTotalULength=floor(totalULength);\r\n\t    uv.x+=totalULength-floorTotalULength;\r\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\r\n    #endif\r\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\r\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\r\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\r\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\r\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\r\n\t\tfloat floorTotalULength=floor(totalULength);\r\n\t    uv.x+=totalULength-floorTotalULength;\r\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\r\n    #endif\r\n\treturn uv;\r\n}\r\n\r\nvoid main()\r\n{\r\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\r\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\r\n\tvec3 lifeVelocity;\r\n\tif(normalizedAge<1.0)\r\n\t{ \r\n\t\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\r\n\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\r\n\t\t#endif \r\n\t\tvec3 gravityVelocity=u_Gravity*age;\r\n\t\t\r\n\t\tvec4 worldRotation;\r\n\t\tif(u_SimulationSpace==0)\r\n\t\t\tworldRotation=a_SimulationWorldRotation;\r\n\t\telse\r\n\t\t\tworldRotation=u_WorldRotation;\r\n\t\t\r\n\t\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\r\n\t\r\n\t\r\n\t\t#ifdef SPHERHBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\r\n\t\t\tvec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\r\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\r\n\t\t\tvec3 upVector = normalize(cross(sideVector,u_CameraDirection));\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\t\t\tfloat c = cos(rot);\r\n\t\t\t\t\tfloat s = sin(rot);\r\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\t\t\tcorner=rotation*corner;\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\r\n\t\t\t\t}\r\n\t\t\t#else\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tfloat c = cos(a_StartRotation0.x);\r\n\t\t\t\t\tfloat s = sin(a_StartRotation0.x);\r\n\t\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\t\t\tcorner=rotation*corner;\r\n\t\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef STRETCHEDBILLBOARD\r\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\r\n\t\tvec3 velocity;\r\n\t\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\r\n\t\t\tif(u_VOLSpaceType==0)\r\n\t\t\tvelocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\r\n\t\t\telse\r\n\t\t\tvelocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\r\n\t\t#else\r\n\t\t\tvelocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\r\n\t\t#endif\t\r\n\t\t\tvec3 cameraUpVector = normalize(velocity);\r\n\t\t\tvec3 direction = normalize(center-u_CameraPos);\r\n\t\t\tvec3 sideVector = normalize(cross(direction,normalize(velocity)));\r\n\t\t\t\r\n\t\t\tsideVector=u_SizeScale.xzy*sideVector;\r\n\t\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\r\n\t\t\t\r\n\t\t\tvec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\t\r\n\t\t\tconst mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\r\n\t\t\tcorner=rotaionZHalfPI*corner;\r\n\t\t\tcorner.y=corner.y-abs(corner.y);\r\n\t\t\t\r\n\t\t\tfloat speed=length(velocity);//TODO:\r\n\t\t\tcenter +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef HORIZONTALBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\r\n\t\t\tconst vec3 cameraUpVector=vec3(0.0,0.0,1.0);\r\n\t\t\tconst vec3 sideVector = vec3(-1.0,0.0,0.0);\r\n\t\t\t\r\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\tfloat c = cos(rot);\r\n\t\t\tfloat s = sin(rot);\r\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef VERTICALBILLBOARD\r\n\t\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\r\n\t\t\tconst vec3 cameraUpVector =vec3(0.0,1.0,0.0);\r\n\t\t\tvec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\r\n\t\t\t\r\n\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\tfloat c = cos(rot);\r\n\t\t\tfloat s = sin(rot);\r\n\t\t\tmat2 rotation= mat2(c, -s, s, c);\r\n\t\t\tcorner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\r\n\t\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\r\n\t\t\tcenter +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef RENDERMODE_MESH\r\n\t\t\tvec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\r\n\t\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\r\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIME\r\n\t\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\r\n\t\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\r\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\t#ifdef SHAPE\r\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\r\n\t\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\r\n\t\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\r\n\t\t\t\t\t\t\t#endif\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t#endif\r\n\t\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\r\n\t\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\r\n\t\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x), age,normalizedAge);\r\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\r\n\t\t\t\t\t#endif\t\t\r\n\t\t\t\t}\r\n\t\t\t#else\r\n\t\t\t\tif(u_ThreeDStartRotation){\r\n\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\r\n\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\r\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\t#ifdef SHAPE\r\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\r\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\r\n\t\t\t\t\t\t#else\r\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\r\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\r\n\t\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\r\n\t\t\t\t\t\t#endif\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\tv_MeshColor=a_MeshColor;\r\n\t\t#endif\r\n\t\r\n\t\tgl_Position=u_Projection*u_View*vec4(center,1.0);\r\n\t\tv_Color = computeParticleColor(a_StartColor, normalizedAge);\r\n\t\t#ifdef DIFFUSEMAP\r\n\t\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\r\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\r\n\t\t\t#endif\r\n\t\t\t#ifdef RENDERMODE_MESH\r\n\t\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\r\n\t\t\t#endif\r\n\t\t\t\r\n\t\t\t#ifdef TILINGOFFSET\r\n\t\t\t\tv_TextureCoordinate=TransformUV(v_TextureCoordinate,u_TilingOffset);\r\n\t\t\t#endif\r\n\t\t#endif\r\n   \t}\r\n   \telse\r\n\t{\r\n\t\tgl_Position=vec4(2.0,2.0,2.0,1.0);//Discard use out of X(-1,1),Y(-1,1),Z(0,1)\r\n\t}\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n  precision highp float;\r\n#else\r\n  precision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nvarying vec2 v_TextureCoordinate;\r\nuniform sampler2D u_texture;\r\nuniform vec4 u_Tintcolor;\r\n\r\n#ifdef RENDERMODE_MESH\r\n\tvarying vec4 v_MeshColor;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\t#ifdef ADDTIVEFOG\r\n\t#else\r\n\t\tuniform vec3 u_FogColor;\r\n\t#endif\r\n#endif\r\n\r\n\r\nvoid main()\r\n{\t\r\n\t#ifdef RENDERMODE_MESH\r\n\t\tgl_FragColor=v_MeshColor;\r\n\t#else\r\n\t\tgl_FragColor=vec4(1.0);\t\r\n\t#endif\r\n\t\t\r\n\t#ifdef DIFFUSEMAP\r\n\t\t#ifdef TINTCOLOR\r\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\r\n\t\t#else\r\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef TINTCOLOR\r\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\r\n\t\t#else\r\n\t\t\tgl_FragColor*=v_Color;\r\n\t\t#endif\r\n\t#endif\r\n\t\r\n\t#ifdef FOG\r\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\r\n\t\t#ifdef ADDTIVEFOG\r\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\r\n\t\t#else\r\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n\t\t#endif\r\n\t#endif\r\n}",n),e={a_Position:Te.MESH_POSITION0},t={u_TintColor:U.PERIOD_MATERIAL,u_Exposure:U.PERIOD_MATERIAL,u_Rotation:U.PERIOD_MATERIAL,u_CubeTexture:U.PERIOD_MATERIAL,u_ViewProjection:U.PERIOD_CAMERA},r=U.add("SkyBox"),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nuniform mat4 u_ViewProjection;\r\nuniform float u_Rotation;\r\nvarying vec3 v_Texcoord;\r\n\r\n\r\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\r\n{\r\n\tfloat angle = degrees * 3.141593 / 180.0;\r\n\tfloat sina=sin(angle);\r\n\tfloat cosa=cos(angle);\r\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\r\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\r\n}\r\n\t\t\r\nvoid main()\r\n{\r\n\tvec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);\r\n\tgl_Position = u_ViewProjection*position;\r\n\tv_Texcoord=vec3(-a_Position.x,a_Position.yz);//转换坐标系\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec3 v_Texcoord;\r\n\r\nuniform samplerCube u_CubeTexture;\r\nuniform float u_Exposure;\r\nuniform vec4 u_TintColor;\r\n\r\n\r\nvoid main()\r\n{\t\r\n\tvec3 color=textureCube(u_CubeTexture, v_Texcoord).rgb*u_TintColor.rgb*u_Exposure*2.0;\r\n\tgl_FragColor=vec4(color,1.0);\r\n}\r\n\r\n"),e={a_Position:Te.MESH_POSITION0},t={u_SunSize:U.PERIOD_MATERIAL,u_SunSizeConvergence:U.PERIOD_MATERIAL,u_AtmosphereThickness:U.PERIOD_MATERIAL,u_SkyTint:U.PERIOD_MATERIAL,u_GroundTint:U.PERIOD_MATERIAL,u_Exposure:U.PERIOD_MATERIAL,u_ViewProjection:U.PERIOD_CAMERA,"u_SunLight.direction":U.PERIOD_SCENE,"u_SunLight.color":U.PERIOD_SCENE},r=U.add("SkyBoxProcedural"),i=new $n(e,t),r.addSubShader(i),i.addShaderPass("#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include \"Lighting.glsl\";\r\n\r\n#define OUTER_RADIUS 1.025\r\n#define RAYLEIGH (mix(0.0, 0.0025, pow(u_AtmosphereThickness,2.5)))// Rayleigh constant Rayleigh为夜空光和极光亮度单位\r\n#define MIE 0.0010             // Mie constant 米氏散射\r\n#define SUN_BRIGHTNESS 20.0    // Sun brightness\r\n#define MAX_SCATTER 50.0 // Maximum scattering value, to prevent math overflows on Adrenos\r\n\r\nconst float SKY_GROUND_THRESHOLD = 0.02;\r\nconst float outerRadius = OUTER_RADIUS;\r\nconst float outerRadius2 = OUTER_RADIUS*OUTER_RADIUS;\r\nconst float innerRadius = 1.0;\r\nconst float innerRadius2 = 1.0;\r\nconst float cameraHeight = 0.0001;\r\n\r\nconst float HDSundiskIntensityFactor = 15.0;\r\nconst float simpleSundiskIntensityFactor = 27.0;\r\n\r\nconst float sunScale = 400.0 * SUN_BRIGHTNESS;\r\nconst float kmESun = MIE * SUN_BRIGHTNESS;\r\nconst float km4PI = MIE * 4.0 * 3.14159265;\r\nconst float scale = 1.0 / (OUTER_RADIUS - 1.0);\r\nconst float scaleDepth = 0.25;\r\nconst float scaleOverScaleDepth = (1.0 / (OUTER_RADIUS - 1.0)) / 0.25;\r\nconst float samples = 2.0; // THIS IS UNROLLED MANUALLY, DON'T TOUCH\r\n\r\n// RGB wavelengths        .35 (.62=158), .43 (.68=174), .525 (.75=190)\r\nconst vec3 c_DefaultScatteringWavelength = vec3(0.65, 0.57, 0.475);//默认散射波长\r\nconst vec3 c_VariableRangeForScatteringWavelength = vec3(0.15, 0.15, 0.15);//散射播放的可变范围\r\n\r\nattribute vec4 a_Position;\r\n\r\nuniform mat4 u_ViewProjection;\r\nuniform vec3 u_SkyTint;\r\nuniform vec3 u_GroundTint;\r\nuniform float u_Exposure;\r\nuniform float u_AtmosphereThickness;\r\nuniform DirectionLight u_SunLight;\r\n\r\nvarying vec3 v_GroundColor;\r\nvarying vec3 v_SkyColor;\r\n\r\n#ifdef SUN_HIGH_QUALITY\r\n\tvarying vec3 v_Vertex;\r\n#elif defined(SUN_SIMPLE)\r\n\tvarying vec3 v_RayDir;\r\n#else\r\n\tvarying float v_SkyGroundFactor;\r\n#endif\r\n\r\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\tvarying vec3 v_SunColor;\r\n#endif\r\n\r\n// Calculates the Rayleigh phase function\r\nfloat getRayleighPhase(vec3 light, vec3 ray) \r\n{\r\n\tfloat eyeCos = dot(light, ray);\r\n\treturn 0.75 + 0.75*eyeCos*eyeCos;\r\n}\r\n\r\nfloat scaleAngle(float inCos)\r\n{\r\n\tfloat x = 1.0 - inCos;\r\n\treturn 0.25 * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\r\n}\r\n\r\n\r\nvoid main () {\r\n\tgl_Position = u_ViewProjection*a_Position;\r\n\r\n\tvec3 skyTintInGammaSpace = u_SkyTint;//支持非GAMMA空间后要调整\r\n\tvec3 scatteringWavelength = mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0) - skyTintInGammaSpace); // using Tint in sRGB+ gamma allows for more visually linear interpolation and to keep (0.5) at (128, gray in sRGB) point\r\n\tvec3 invWavelength = 1.0 / pow(scatteringWavelength, vec3(4.0));\r\n\r\n\tfloat krESun = RAYLEIGH * SUN_BRIGHTNESS;\r\n\tfloat kr4PI = RAYLEIGH * 4.0 * 3.14159265;\r\n\r\n\tvec3 cameraPos = vec3(0.0,innerRadius + cameraHeight,0.0); // The camera's current position\r\n\r\n\t// Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\r\n\tvec3 eyeRay = normalize(a_Position.xyz);\r\n\r\n\tfloat far = 0.0;\r\n\tvec3 cIn, cOut;\r\n\tif (eyeRay.y >= 0.0) {// Sky\r\n\t\t// Calculate the length of the \"atmosphere\"\r\n\t\tfar = sqrt(outerRadius2 + innerRadius2 * eyeRay.y * eyeRay.y - innerRadius2) - innerRadius * eyeRay.y;\r\n\r\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\r\n\t\tfloat height = innerRadius + cameraHeight;\r\n\t\tfloat depth = exp(scaleOverScaleDepth * -cameraHeight);\r\n\t\tfloat startAngle = dot(eyeRay, cameraPos) / height;\r\n\t\tfloat startOffset = depth*scaleAngle(startAngle);\r\n\r\n\t\t// Initialize the scattering loop variables\r\n\t\tfloat sampleLength = far / samples;\r\n\t\tfloat scaledLength = sampleLength * scale;\r\n\t\tvec3 sampleRay = eyeRay * sampleLength;\r\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\r\n\r\n\t\tvec3 frontColor = vec3(0.0);\r\n\t\t//unrolling this manually to avoid some platform for loop slow\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\r\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\r\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\r\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat lightAngle = dot(-u_SunLight.direction, samplePoint) / height;\r\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\r\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\r\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\r\n\t\t// Finally, scale the Mie and Rayleigh colors and set up the varying variables for the pixel shader\r\n\t\tcIn = frontColor * (invWavelength * krESun);\r\n\t\tcOut = frontColor * kmESun;\r\n\t} else {// Ground\r\n\t\tfar = (-cameraHeight) / (min(-0.001, eyeRay.y));\r\n\t\tvec3 pos = cameraPos + far * eyeRay;\r\n\r\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\r\n\t\tfloat depth = exp((-cameraHeight) * (1.0/scaleDepth));\r\n\t\tfloat cameraAngle = dot(-eyeRay, pos);\r\n\t\tfloat lightAngle = dot(-u_SunLight.direction, pos);\r\n\t\tfloat cameraScale = scaleAngle(cameraAngle);\r\n\t\tfloat lightScale = scaleAngle(lightAngle);\r\n\t\tfloat cameraOffset = depth*cameraScale;\r\n\t\tfloat temp = lightScale + cameraScale;\r\n\r\n\t\t// Initialize the scattering loop variables\r\n\t\tfloat sampleLength = far / samples;\r\n\t\tfloat scaledLength = sampleLength * scale;\r\n\t\tvec3 sampleRay = eyeRay * sampleLength;\r\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\r\n\r\n\t\t// Now loop through the sample rays\r\n\t\tvec3 frontColor = vec3(0.0, 0.0, 0.0);\r\n\t\tvec3 attenuate;\r\n\r\n\t\t// Loop removed because we kept hitting SM2.0 temp variable limits. Doesn't affect the image too much.\r\n\t\t{\r\n\t\t\tfloat height = length(samplePoint);\r\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\r\n\t\t\tfloat scatter = depth*temp - cameraOffset;\r\n\t\t\tattenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\r\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\r\n\t\t\tsamplePoint += sampleRay;\r\n\t\t}\r\n\r\n\t\tcIn = frontColor * (invWavelength * krESun + kmESun);\r\n\t\tcOut = clamp(attenuate, 0.0, 1.0);\r\n\t}\r\n\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tv_Vertex = -a_Position.xyz;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tv_RayDir = -eyeRay;\r\n\t#else\r\n\t\tv_SkyGroundFactor = -eyeRay.y / SKY_GROUND_THRESHOLD;\r\n\t#endif\r\n\r\n\t// if we want to calculate color in vprog:\r\n\t// in case of linear: multiply by _Exposure in here (even in case of lerp it will be common multiplier, so we can skip mul in fshader)\r\n\tv_GroundColor = u_Exposure * (cIn + u_GroundTint*u_GroundTint * cOut);//u_GroundColor*u_GroundColor is gamma space convert to linear space\r\n\tv_SkyColor    = u_Exposure * (cIn * getRayleighPhase(-u_SunLight.direction, -eyeRay));\r\n\r\n\t\r\n\t// The sun should have a stable intensity in its course in the sky. Moreover it should match the highlight of a purely specular material.\r\n\t// This matching was done using the Unity3D standard shader BRDF1 on the 5/31/2017\r\n\t// Finally we want the sun to be always bright even in LDR thus the normalization of the lightColor for low intensity.\r\n\tfloat lightColorIntensity = clamp(length(u_SunLight.color), 0.25, 1.0);\r\n\r\n\t#ifdef SUN_HIGH_QUALITY \r\n\t\tv_SunColor = HDSundiskIntensityFactor * clamp(cOut,0.0,1.0) * u_SunLight.color / lightColorIntensity;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tv_SunColor = simpleSundiskIntensityFactor * clamp(cOut * sunScale,0.0,1.0) * u_SunLight.color / lightColorIntensity;\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n",'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n\r\nconst float MIE_G = -0.990;\r\nconst float MIE_G2 = 0.9801;\r\nconst float SKY_GROUND_THRESHOLD = 0.02;\r\n\r\nuniform float u_SunSize;\r\nuniform float u_SunSizeConvergence;\r\nuniform DirectionLight u_SunLight;\r\n\r\n\r\nvarying vec3 v_GroundColor;\r\nvarying vec3 v_SkyColor;\r\n\r\n\r\n#ifdef SUN_HIGH_QUALITY\r\n\tvarying vec3 v_Vertex;\r\n#elif defined(SUN_SIMPLE)\r\n\tvarying vec3 v_RayDir;\r\n#else\r\n\tvarying float v_SkyGroundFactor;\r\n#endif\r\n\r\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\tvarying vec3 v_SunColor;\r\n#endif\r\n\r\n// Calculates the Mie phase function\r\nfloat getMiePhase(float eyeCos, float eyeCos2) {\r\n\tfloat temp = 1.0 + MIE_G2 - 2.0 * MIE_G * eyeCos;\r\n\ttemp = pow(temp, pow(u_SunSize,0.65) * 10.0);\r\n\ttemp = max(temp,1.0e-4); // prevent division by zero, esp. in half precision\r\n\ttemp = 1.5 * ((1.0 - MIE_G2) / (2.0 + MIE_G2)) * (1.0 + eyeCos2) / temp;\r\n\treturn temp;\r\n}\r\n\r\n// Calculates the sun shape\r\nfloat calcSunAttenuation(vec3 lightPos, vec3 ray) {\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tfloat focusedEyeCos = pow(clamp(dot(lightPos, ray),0.0,1.0), u_SunSizeConvergence);\r\n\t\treturn getMiePhase(-focusedEyeCos, focusedEyeCos * focusedEyeCos);\r\n\t#else //SUN_SIMPLE\r\n\t\tvec3 delta = lightPos - ray;\r\n\t\tfloat dist = length(delta);\r\n\t\tfloat spot = 1.0 - smoothstep(0.0, u_SunSize, dist);\r\n\t\treturn spot * spot;\r\n\t#endif\r\n}\r\n\r\nvoid main() {\r\n\t// if y > 1 [eyeRay.y < -SKY_GROUND_THRESHOLD] - ground\r\n\t// if y >= 0 and < 1 [eyeRay.y <= 0 and > -SKY_GROUND_THRESHOLD] - horizon\r\n\t// if y < 0 [eyeRay.y > 0] - sky\r\n\tvec3 col = vec3(0.0, 0.0, 0.0);\r\n\r\n\t#ifdef SUN_HIGH_QUALITY\r\n\t\tvec3 ray = normalize(v_Vertex);\r\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\r\n\t#elif defined(SUN_SIMPLE) \r\n\t\tvec3 ray = v_RayDir;\r\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\t\r\n\t#else\r\n\t\tfloat y = v_SkyGroundFactor;\r\n\t#endif\r\n\r\n\t// if we did precalculate color in vprog: just do lerp between them\r\n\tcol = mix(v_SkyColor, v_GroundColor, clamp(y,0.0,1.0));\r\n\r\n\t#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\r\n\t\tif (y < 0.0)\r\n\t\t\tcol += v_SunColor * calcSunAttenuation(-u_SunLight.direction, -ray);\r\n\t#endif\r\n\r\n\tcol = sqrt(col);//linear space convert to gamma space\r\n\tgl_FragColor=vec4(col,1.0);\r\n}\r\n\r\n'),e={a_Position:Te.MESH_POSITION0,a_Normal:Te.MESH_NORMAL0,a_Texcoord0:Te.MESH_TEXTURECOORDINATE0},t={u_MvpMatrix:U.PERIOD_SPRITE,u_WorldMat:U.PERIOD_SPRITE,u_CameraPos:U.PERIOD_CAMERA,u_Viewport:U.PERIOD_CAMERA,u_ProjectionParams:U.PERIOD_CAMERA,u_View:U.PERIOD_CAMERA,u_LightmapScaleOffset:U.PERIOD_SPRITE,u_LightMap:U.PERIOD_SPRITE,u_SplatAlphaTexture:U.PERIOD_MATERIAL,u_DiffuseTexture1:U.PERIOD_MATERIAL,u_DiffuseTexture2:U.PERIOD_MATERIAL,u_DiffuseTexture3:U.PERIOD_MATERIAL,u_DiffuseTexture4:U.PERIOD_MATERIAL,u_DiffuseTexture5:U.PERIOD_MATERIAL,u_DiffuseScaleOffset1:U.PERIOD_MATERIAL,u_DiffuseScaleOffset2:U.PERIOD_MATERIAL,u_DiffuseScaleOffset3:U.PERIOD_MATERIAL,u_DiffuseScaleOffset4:U.PERIOD_MATERIAL,u_DiffuseScaleOffset5:U.PERIOD_MATERIAL,u_FogStart:U.PERIOD_SCENE,u_FogRange:U.PERIOD_SCENE,u_FogColor:U.PERIOD_SCENE,u_DirationLightCount:U.PERIOD_SCENE,u_LightBuffer:U.PERIOD_SCENE,u_LightClusterBuffer:U.PERIOD_SCENE,u_AmbientColor:U.PERIOD_SCENE,u_shadowMap1:U.PERIOD_SCENE,u_shadowMap2:U.PERIOD_SCENE,u_shadowMap3:U.PERIOD_SCENE,u_shadowPSSMDistance:U.PERIOD_SCENE,u_lightShadowVP:U.PERIOD_SCENE,u_shadowPCFoffset:U.PERIOD_SCENE,"u_DirectionLight.color":U.PERIOD_SCENE,"u_DirectionLight.direction":U.PERIOD_SCENE,"u_PointLight.position":U.PERIOD_SCENE,"u_PointLight.range":U.PERIOD_SCENE,"u_PointLight.color":U.PERIOD_SCENE,"u_SpotLight.position":U.PERIOD_SCENE,"u_SpotLight.direction":U.PERIOD_SCENE,"u_SpotLight.range":U.PERIOD_SCENE,"u_SpotLight.spot":U.PERIOD_SCENE,"u_SpotLight.color":U.PERIOD_SCENE},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("ExtendTerrain"),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec2 a_Texcoord0;\r\n\r\nuniform mat4 u_MvpMatrix;\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\r\n\tattribute vec3 a_Normal;\r\n\tvarying vec3 v_Normal;\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\r\n\tuniform mat4 u_WorldMat;\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#ifdef LIGHTMAP\r\n\tvarying vec2 v_LightMapUV;\r\n\tuniform vec4 u_LightmapScaleOffset;\r\n#endif\r\n\r\n#ifdef RECEIVESHADOW\r\n\tvarying float v_posViewZ;\r\n\t#ifdef SHADOWMAP_PSSM1 \r\n\t\tvarying vec4 v_lightMVPPos;\r\n\t\tuniform mat4 u_lightShadowVP[4];\r\n\t#endif\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tgl_Position = u_MvpMatrix * a_Position;\r\n  \r\n\tv_Texcoord0 = a_Texcoord0;\r\n  \r\n\t#ifdef LIGHTMAP\r\n\t\tv_LightMapUV = vec2(a_Texcoord0.x, 1.0 - a_Texcoord0.y) * u_LightmapScaleOffset.xy + u_LightmapScaleOffset.zw;\r\n\t\tv_LightMapUV.y = 1.0 - v_LightMapUV.y;\r\n\t#endif\r\n  \r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tv_Normal = a_Normal;\r\n\t#endif\r\n\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\r\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\r\n\t#endif\r\n\r\n\t#ifdef RECEIVESHADOW\r\n\t\tv_posViewZ = gl_Position.w;\r\n\t\t#ifdef SHADOWMAP_PSSM1\r\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\r\n\t\t#endif\r\n\t#endif\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Lighting.glsl";\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\r\n\tuniform vec3 u_CameraPos;\r\n\tvarying vec3 v_Normal;\r\n\tvarying vec3 v_PositionWorld;\r\n#endif\r\n\r\n#ifdef FOG\r\n\tuniform float u_FogStart;\r\n\tuniform float u_FogRange;\r\n\tuniform vec3 u_FogColor;\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tuniform DirectionLight u_DirectionLight;\r\n\t\t#endif\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tuniform PointLight u_PointLight;\r\n\t\t#endif\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tuniform SpotLight u_SpotLight;\r\n\t\t#endif\r\n\t#else\r\n\t\tuniform mat4 u_View;\r\n\t\tuniform vec4 u_ProjectionParams;\r\n\t\tuniform vec4 u_Viewport;\r\n\t\tuniform int u_DirationLightCount;\r\n\t\tuniform sampler2D u_LightBuffer;\r\n\t\tuniform sampler2D u_LightClusterBuffer;\r\n\t#endif\r\n#endif\r\n\r\n#include "ShadowHelper.glsl"\r\n#ifdef RECEIVESHADOW\r\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\r\n\tuniform mat4 u_lightShadowVP[4];\r\n\t#endif\r\n\t#ifdef SHADOWMAP_PSSM1 \r\n\tvarying vec4 v_lightMVPPos;\r\n\t#endif\r\n#endif\r\nvarying float v_posViewZ;\r\n\r\nuniform vec3 u_AmbientColor;\r\n\r\nuniform sampler2D u_SplatAlphaTexture;\r\n\r\nuniform sampler2D u_DiffuseTexture1;\r\nuniform sampler2D u_DiffuseTexture2;\r\nuniform sampler2D u_DiffuseTexture3;\r\nuniform sampler2D u_DiffuseTexture4;\r\nuniform sampler2D u_DiffuseTexture5;\r\n\r\nuniform vec4 u_DiffuseScaleOffset1;\r\nuniform vec4 u_DiffuseScaleOffset2;\r\nuniform vec4 u_DiffuseScaleOffset3;\r\nuniform vec4 u_DiffuseScaleOffset4;\r\nuniform vec4 u_DiffuseScaleOffset5;\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\n#ifdef LIGHTMAP\r\n\tuniform sampler2D u_LightMap;\r\n\tvarying vec2 v_LightMapUV;\r\n#endif\r\n\r\nvoid main()\r\n{\r\n\tvec4 splatAlpha = vec4(1.0);\r\n\t#ifdef ExtendTerrain_DETAIL_NUM1\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM2\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM3\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM4\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\r\n\t#endif\r\n\t#ifdef ExtendTerrain_DETAIL_NUM5\r\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\r\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\r\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\r\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\r\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\r\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\r\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\r\n\t#endif\r\n\t\tgl_FragColor.w = splatAlpha.a;\r\n\t\t\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\tvec3 normal = v_Normal;\r\n\t\tvec3 dif, spe;\r\n\t#endif\r\n\r\n\tvec3 diffuse = vec3(0.0);\r\n\tvec3 specular= vec3(0.0);\r\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\r\n\t\tvec3 toEye;\r\n\t\t#ifdef FOG\r\n\t\t\ttoEye=u_CameraPos-v_PositionWorld;\r\n\t\t\tfloat toEyeLength=length(toEye);\r\n\t\t\ttoEye/=toEyeLength;\r\n\t\t#else\r\n\t\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\r\n\t\t#endif\r\n\t#endif\r\n\r\n\t#ifdef LEGACYSINGLELIGHTING\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,u_DirectionLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t\r\n\t\t#ifdef POINTLIGHT\r\n\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_PointLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\r\n\t\t#ifdef SPOTLIGHT\r\n\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,u_SpotLight,dif,spe);\r\n\t\t\tdiffuse+=dif;\r\n\t\t\tspecular+=spe;\r\n\t\t#endif\r\n\t#else\r\n\t\t#ifdef DIRECTIONLIGHT\r\n\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t{\r\n\t\t\t\tif(i >= u_DirationLightCount)\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tDirectionLight directionLight = getDirectionLight(u_LightBuffer,i);\r\n\t\t\t\tLayaAirBlinnPhongDiectionLight(vec3(0.0),1.0,normal,vec3(1.0),toEye,directionLight,dif,spe);\r\n\t\t\t\tdiffuse+=dif;\r\n\t\t\t\tspecular+=spe;\r\n\t\t\t}\r\n\t\t#endif\r\n\t\t#if defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t\t\tivec4 clusterInfo =getClusterInfo(u_LightClusterBuffer,u_View,u_Viewport, v_PositionWorld,gl_FragCoord,u_ProjectionParams);\r\n\t\t\t#ifdef POINTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.x)//PointLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tPointLight pointLight = getPointLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye,pointLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t\t#ifdef SPOTLIGHT\r\n\t\t\t\tfor (int i = 0; i < MAX_LIGHT_COUNT; i++) \r\n\t\t\t\t{\r\n\t\t\t\t\tif(i >= clusterInfo.y)//SpotLightCount\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tSpotLight spotLight = getSpotLight(u_LightBuffer,u_LightClusterBuffer,clusterInfo,i);\r\n\t\t\t\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,vec3(0.0),1.0,normal,vec3(1.0),toEye\t,spotLight,dif,spe);\r\n\t\t\t\t\tdiffuse+=dif;\r\n\t\t\t\t\tspecular+=spe;\r\n\t\t\t\t}\r\n\t\t\t#endif\r\n\t\t#endif\r\n\t#endif\r\n\r\nvec3 globalDiffuse = u_AmbientColor;\r\n#ifdef LIGHTMAP\r\n\tglobalDiffuse += DecodeLightmap(texture2D(u_LightMap, v_LightMapUV));\r\n#endif\r\n\r\n#ifdef RECEIVESHADOW\r\n\tfloat shadowValue = 1.0;\r\n\t#ifdef SHADOWMAP_PSSM3\r\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\r\n\t#endif\r\n\t#ifdef SHADOWMAP_PSSM2\r\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\r\n\t#endif \r\n\t#ifdef SHADOWMAP_PSSM1\r\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\r\n\t#endif\r\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse) * shadowValue, gl_FragColor.a);\r\n#else\r\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse), gl_FragColor.a);\r\n#endif\r\n\r\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\r\n\t#ifdef RECEIVESHADOW\r\n\t\tgl_FragColor.rgb += specular * shadowValue;\r\n\t#else\r\n\t\tgl_FragColor.rgb += specular;\r\n\t#endif\r\n#endif\r\n\r\n#ifdef FOG\r\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\r\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\r\n#endif\r\n}\r\n\r\n\r\n\r\n\r\n\r\n',n),e={a_Position:Mn.TRAIL_POSITION0,a_OffsetVector:Mn.TRAIL_OFFSETVECTOR,a_Texcoord0X:Mn.TRAIL_TEXTURECOORDINATE0X,a_Texcoord0Y:Mn.TRAIL_TEXTURECOORDINATE0Y,a_BirthTime:Mn.TRAIL_TIME0,a_Color:Mn.TRAIL_COLOR},t={u_MvpMatrix:U.PERIOD_SPRITE,u_View:U.PERIOD_CAMERA,u_Projection:U.PERIOD_CAMERA,u_TilingOffset:U.PERIOD_MATERIAL,u_MainTexture:U.PERIOD_MATERIAL,u_MainColor:U.PERIOD_MATERIAL,u_CurTime:U.PERIOD_SPRITE,u_LifeTime:U.PERIOD_SPRITE,u_WidthCurve:U.PERIOD_SPRITE,u_WidthCurveKeyLength:U.PERIOD_SPRITE,u_GradientColorkey:U.PERIOD_SPRITE,u_GradientAlphakey:U.PERIOD_SPRITE},n={s_Cull:U.RENDER_STATE_CULL,s_Blend:U.RENDER_STATE_BLEND,s_BlendSrc:U.RENDER_STATE_BLEND_SRC,s_BlendDst:U.RENDER_STATE_BLEND_DST,s_DepthTest:U.RENDER_STATE_DEPTH_TEST,s_DepthWrite:U.RENDER_STATE_DEPTH_WRITE},r=U.add("Trail"),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec3 a_Position;\r\nattribute vec3 a_OffsetVector;\r\nattribute vec4 a_Color;\r\nattribute float a_Texcoord0X;\r\nattribute float a_Texcoord0Y;\r\nattribute float a_BirthTime;\r\n\r\nuniform mat4 u_View;\r\nuniform mat4 u_Projection;\r\n\r\nuniform vec4 u_TilingOffset;\r\n\r\nuniform float u_CurTime;\r\nuniform float u_LifeTime;\r\nuniform vec4 u_WidthCurve[10];\r\nuniform int u_WidthCurveKeyLength;\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec4 v_Color;\r\n\r\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\r\n{\r\n\tfloat t2 = t * t;\r\n\tfloat t3 = t2 * t;\r\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\r\n\tfloat b = t3 - 2.0 * t2 + t;\r\n\tfloat c = t3 - t2;\r\n\tfloat d = -2.0 * t3 + 3.0 * t2;\r\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\r\n}\r\n\r\nfloat getCurWidth(in float normalizeTime)\r\n{\r\n\tfloat width;\r\n\tif(normalizeTime == 0.0){\r\n\t\twidth=u_WidthCurve[0].w;\r\n\t}\r\n\telse if(normalizeTime >= 1.0){\r\n\t\twidth=u_WidthCurve[u_WidthCurveKeyLength - 1].w;\r\n\t}\r\n\telse{\r\n\t\tfor(int i = 0; i < 10; i ++ )\r\n\t\t{\r\n\t\t\tif(normalizeTime == u_WidthCurve[i].x){\r\n\t\t\t\twidth=u_WidthCurve[i].w;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\r\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\r\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\r\n\t\t\t{\r\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\r\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\r\n\t\t\t\tfloat outTangent = lastFrame.z;\r\n\t\t\t\tfloat inTangent = nextFrame.y;\r\n\t\t\t\tfloat value1 = lastFrame.w;\r\n\t\t\t\tfloat value2 = nextFrame.w;\r\n\t\t\t\twidth=hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn width;\r\n}\t\r\n\r\nvoid main()\r\n{\r\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\r\n\t\r\n\t#ifdef TILINGOFFSET\r\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, 1.0 - a_Texcoord0Y) * u_TilingOffset.xy + u_TilingOffset.zw;\r\n\t#else\r\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\r\n\t#endif\r\n\t\r\n\tv_Color = a_Color;\r\n\t\r\n\tgl_Position = u_Projection * u_View * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}\r\n',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\nuniform sampler2D u_MainTexture;\r\nuniform vec4 u_MainColor;\r\n\r\nvarying vec2 v_Texcoord0;\r\nvarying vec4 v_Color;\r\n\r\nvoid main()\r\n{\r\n\tvec4 color = 2.0 * u_MainColor * v_Color;\r\n\t#ifdef MAINTEXTURE\r\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\r\n\t\tcolor *= mainTextureColor;\r\n\t#endif\r\n\tgl_FragColor = color;\r\n}\r\n\r\n     ",n),e={a_Position:Te.MESH_POSITION0,a_Normal:Te.MESH_NORMAL0,a_Tangent0:Te.MESH_TANGENT0},t={u_MvpMatrix:U.PERIOD_SPRITE,u_WorldMat:U.PERIOD_SPRITE,u_CameraPos:U.PERIOD_CAMERA,u_Time:U.PERIOD_SCENE,u_MainTexture:U.PERIOD_MATERIAL,u_NormalTexture:U.PERIOD_MATERIAL,u_HorizonColor:U.PERIOD_MATERIAL,u_WaveScale:U.PERIOD_MATERIAL,u_WaveSpeed:U.PERIOD_MATERIAL},r=U.add("WaterPrimary"),i=new $n(e,t),r.addSubShader(i),i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_Position;\r\nattribute vec3 a_Normal;\r\nattribute vec4 a_Tangent0;\r\n\r\nuniform mat4 u_MvpMatrix;\r\nuniform mat4 u_WorldMat;\r\nuniform vec3 u_CameraPos;\r\nuniform float u_WaveScale;\r\nuniform vec4 u_WaveSpeed;\r\nuniform float u_Time;\r\n\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec2 v_Texcoord0;\r\nvarying vec2 v_Texcoord1;\r\n\r\nvoid main()\r\n{\r\n\tvec4 positionWorld = u_WorldMat * a_Position;\r\n\tvec4 position = u_MvpMatrix * a_Position;\r\n\t\r\n\tvec4 temp = vec4(positionWorld.x, positionWorld.z, positionWorld.x, positionWorld.z) * u_WaveScale + u_WaveSpeed * u_WaveScale * u_Time;\r\n\t\r\n\tv_Texcoord0 = temp.xy * vec2(0.4, 0.45);\r\n\tv_Texcoord1 = temp.wz;\r\n\t\r\n\tmat3 worldMat = mat3(u_WorldMat);\r\n\tv_Normal = worldMat * a_Normal;\r\n\tv_Tangent = worldMat * a_Tangent0.xyz;\r\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\r\n\t\r\n\tv_ViewDir = u_CameraPos - positionWorld.xyz;\r\n\tgl_Position = position;\r\n\tgl_Position=remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#ifdef MAINTEXTURE\r\n\tuniform sampler2D u_MainTexture;\r\n#endif\r\n\r\n#ifdef NORMALTEXTURE\r\n\tuniform sampler2D u_NormalTexture;\r\n#endif\r\n\r\nuniform vec4 u_HorizonColor;\r\n\r\nvarying vec3 v_Normal;\r\nvarying vec3 v_Tangent;\r\nvarying vec3 v_Binormal;\r\nvarying vec3 v_ViewDir;\r\nvarying vec2 v_Texcoord0;\r\nvarying vec2 v_Texcoord1;\r\n\r\n#include "Lighting.glsl"\r\n\r\nvoid main()\r\n{\r\n\tvec4 bumpColor1 = texture2D(u_NormalTexture, v_Texcoord0);\r\n\tvec4 bumpColor2 = texture2D(u_NormalTexture, v_Texcoord1);\r\n\t\r\n\tvec3 normal1 = NormalSampleToWorldSpace1(bumpColor1, v_Tangent, v_Binormal, v_Normal);\r\n\tvec3 normal2 = NormalSampleToWorldSpace1(bumpColor2, v_Tangent, v_Binormal, v_Normal);\r\n\t\r\n\tvec3 normal = normalize((normal1 + normal2) * 0.5);\r\n\tvec3 viewDir = normalize(v_ViewDir);\r\n\tfloat fresnel = dot(viewDir, normal);\r\n\t\r\n\tvec4 waterColor = texture2D(u_MainTexture, vec2(fresnel, fresnel));\r\n\t\r\n\tvec4 color;\r\n\tcolor.rgb = mix(waterColor.rgb, u_HorizonColor.rgb, vec3(waterColor.a));\r\n\tcolor.a = u_HorizonColor.a;\r\n\t\r\n\tgl_FragColor = color;\r\n}\r\n\r\n'),e={a_PositionTexcoord:Te.MESH_POSITION0},t={u_MainTex:U.PERIOD_MATERIAL,u_OffsetScale:U.PERIOD_MATERIAL},r=U.add("BlitScreen"),i=new $n(e,t),r.addSubShader(i);var a=i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nuniform vec4 u_OffsetScale;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\t\r\n\tgl_Position = vec4(u_OffsetScale.x*2.0-1.0+(a_PositionTexcoord.x+1.0)*u_OffsetScale.z,(1.0-((u_OffsetScale.y*2.0-1.0+(-a_PositionTexcoord.y+1.0)*u_OffsetScale.w)+1.0)/2.0)*2.0-1.0, 0.0, 1.0);\t\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}',"#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\nuniform sampler2D u_MainTex;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_FragColor = texture2D(u_MainTex, v_Texcoord0);\r\n}\r\n\r\n"),o=a.renderState;o.depthTest=q.DEPTHTEST_ALWAYS,o.depthWrite=!1,o.cull=q.CULL_NONE,o.blend=q.BLEND_DISABLE,e={a_PositionTexcoord:Te.MESH_POSITION0},t={u_MainTex:U.PERIOD_MATERIAL,u_BloomTex:U.PERIOD_MATERIAL,u_AutoExposureTex:U.PERIOD_MATERIAL,u_MainTex_TexelSize:U.PERIOD_MATERIAL,u_SampleScale:U.PERIOD_MATERIAL,u_Threshold:U.PERIOD_MATERIAL,u_Params:U.PERIOD_MATERIAL},r=U.add("PostProcessBloom"),i=new $n(e,t),r.addSubShader(i),(o=(a=i.addShaderPass(qn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\r\nuniform vec4 u_Params; // x: clamp, yzw: unused\r\n\r\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\r\n\tcolor *= autoExposure;\r\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\r\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\r\n\treturn color;\r\n}\r\n\r\nvoid fragPrefilter13() {\r\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragPrefilter13();\r\n}')).renderState).depthTest=q.DEPTHTEST_ALWAYS,o.depthWrite=!1,o.cull=q.CULL_NONE,o.blend=q.BLEND_DISABLE,i=new $n(e,t),r.addSubShader(i),(o=(a=i.addShaderPass(qn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\r\nuniform vec4 u_Params; // x: clamp, yzw: unused\r\n\r\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\r\n\tcolor *= autoExposure;\r\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\r\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\r\n\treturn color;\r\n}\r\n\r\nvoid fragPrefilter4() {\r\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragPrefilter4();\r\n}')).renderState).depthTest=q.DEPTHTEST_ALWAYS,o.depthWrite=!1,o.cull=q.CULL_NONE,o.blend=q.BLEND_DISABLE,i=new $n(e,t),r.addSubShader(i),(o=(a=i.addShaderPass(qn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\n\r\nvoid fragDownsample13() {\r\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = color;\r\n}\r\n\r\nvoid main() {\r\n\tfragDownsample13();\r\n}')).renderState).depthTest=q.DEPTHTEST_ALWAYS,o.depthWrite=!1,o.cull=q.CULL_NONE,o.blend=q.BLEND_DISABLE,i=new $n(e,t),r.addSubShader(i),(o=(a=i.addShaderPass(qn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform vec4 u_MainTex_TexelSize;\r\n\r\nvoid fragDownsample4() {\r\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\r\n\tgl_FragColor = color;\r\n}\r\n\r\nvoid main() {\r\n\tfragDownsample4();\r\n}')).renderState).depthTest=q.DEPTHTEST_ALWAYS,o.depthWrite=!1,o.cull=q.CULL_NONE,o.blend=q.BLEND_DISABLE,i=new $n(e,t),r.addSubShader(i),(o=(a=i.addShaderPass(qn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform float u_SampleScale;\r\n\r\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\r\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\r\n\treturn bloom + color;\r\n}\r\n\r\nvoid fragUpsampleTent() {\r\n\tmediump vec4 bloom = upsampleTent(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\r\n\tgl_FragColor = combine(bloom, v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragUpsampleTent();\r\n}')).renderState).depthTest=q.DEPTHTEST_ALWAYS,o.depthWrite=!1,o.cull=q.CULL_NONE,o.blend=q.BLEND_DISABLE,i=new $n(e,t),r.addSubShader(i),(o=(a=i.addShaderPass(qn,'#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform vec4 u_MainTex_TexelSize;\r\nuniform float u_SampleScale;\r\n\r\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\r\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\r\n\treturn bloom + color;\r\n}\r\n\r\nvoid fragUpsampleBox() {\r\n\tmediump vec4 bloom = upsampleBox(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\r\n\tgl_FragColor = combine(bloom, v_Texcoord0);\r\n}\r\n\r\nvoid main() {\r\n\tfragUpsampleBox();\r\n}')).renderState).depthTest=q.DEPTHTEST_ALWAYS,o.depthWrite=!1,o.cull=q.CULL_NONE,o.blend=q.BLEND_DISABLE,e={a_PositionTexcoord:Te.MESH_POSITION0},t={u_MainTex:U.PERIOD_MATERIAL,u_BloomTex:U.PERIOD_MATERIAL,u_AutoExposureTex:U.PERIOD_MATERIAL,u_Bloom_DirtTileOffset:U.PERIOD_MATERIAL,u_Bloom_DirtTex:U.PERIOD_MATERIAL,u_BloomTex_TexelSize:U.PERIOD_MATERIAL,u_Bloom_Settings:U.PERIOD_MATERIAL,u_Bloom_Color:U.PERIOD_MATERIAL},r=U.add("PostProcessComposite"),i=new $n(e,t),r.addSubShader(i),(o=(a=i.addShaderPass('#include "Lighting.glsl";\r\n\r\nattribute vec4 a_PositionTexcoord;\r\nvarying vec2 v_Texcoord0;\r\n\r\nvoid main() {\r\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\r\n\tv_Texcoord0 = a_PositionTexcoord.zw;\r\n\tgl_Position = remapGLPositionZ(gl_Position);\r\n}','#ifdef GL_FRAGMENT_PRECISION_HIGH\r\n\tprecision highp float;\r\n#else\r\n\tprecision mediump float;\r\n#endif\r\n\r\n#include "Colors.glsl";\r\n#include "Sampling.glsl";\r\n\r\nvarying vec2 v_Texcoord0;\r\n\r\nuniform sampler2D u_MainTex;\r\nuniform sampler2D u_BloomTex;\r\n\r\nuniform sampler2D u_AutoExposureTex;\r\nuniform sampler2D u_Bloom_DirtTex;\r\nuniform vec4 u_BloomTex_TexelSize;\r\nuniform vec4 u_Bloom_DirtTileOffset; // xy: tiling, zw: offset\r\nuniform mediump vec3 u_Bloom_Settings;// x: sampleScale, y: intensity, z: dirt intensity\r\nuniform mediump vec3 u_Bloom_Color;\r\n\r\nvoid main() {\r\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, v_Texcoord0).r;\r\n\tmediump vec4 color=vec4(0.0);\r\n\tcolor = texture2D(u_MainTex, v_Texcoord0);\r\n\t\r\n\tcolor = sRGBToLinear(color);\r\n\tcolor.rgb *= autoExposure;\r\n\t\r\n\t#if defined(BLOOM)||defined(BLOOM_LOW)\r\n\t\t#ifdef BLOOM\r\n\t\t\tmediump vec4 bloom = upsampleTent(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\r\n\t\t#else\r\n\t\t\tmediump vec4 bloom = upsampleBox(u_BloomTex, v_Texcoord0, u_BloomTex_TexelSize.xy, vec4(u_Bloom_Settings.x));\r\n\t\t#endif\r\n\r\n\t\t// UVs should be Distort(uv * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw)\r\n\t\t// but considering we use a cover-style scale on the dirt texture the difference\r\n\t\t// isn\'t massive so we chose to save a few ALUs here instead in case lens distortion\r\n\t\t// is active\r\n\t\tmediump vec4 dirt =vec4(texture2D(u_Bloom_DirtTex, v_Texcoord0 * u_Bloom_DirtTileOffset.xy + u_Bloom_DirtTileOffset.zw).rgb, 0.0);\r\n\r\n\t\t// Additive bloom (artist friendly)\r\n\t\tbloom *= u_Bloom_Settings.y;\r\n\t\tdirt *= u_Bloom_Settings.z;\r\n\t\tmediump vec4 bloomColor=vec4(u_Bloom_Color, 1.0);\r\n\t\tcolor += bloom * bloomColor;\r\n\t\tcolor += dirt * bloom;\r\n\t#endif\r\n\t\r\n\tmediump vec4 finalColor = color;\r\n\tfinalColor = linearToSRGB(finalColor);\r\n\t//finalColor.rgb = Dither(finalColor.rgb, v_Texcoord0);//TODO:抖动\r\n\tgl_FragColor = finalColor;\r\n}')).renderState).depthTest=q.DEPTHTEST_ALWAYS,o.depthWrite=!1,o.cull=q.CULL_NONE,o.blend=q.BLEND_DISABLE}}]),e}(),tr=function(){function e(){var t;for(_classCallCheck(this,e),this._spiltDistance=[],this._currentPSSM=-1,this._shadowMapCount=3,this._maxDistance=200,this._ratioOfDistance=1/this._shadowMapCount,this._globalParallelLightDir=new a(0,-1,0),this._statesDirty=!0,this._shadowMapTextureSize=1024,this._scene=null,this._boundingSphere=new Array(e.MAX_PSSM_COUNT+1),this._boundingBox=new Array(e.MAX_PSSM_COUNT+1),this._frustumPos=new Array(4*(e.MAX_PSSM_COUNT+1)),this._uniformDistance=new Array(e.MAX_PSSM_COUNT+1),this._logDistance=new Array(e.MAX_PSSM_COUNT+1),this._dimension=new Array(e.MAX_PSSM_COUNT+1),this._PCFType=0,this._tempLookAt3=new a,this._tempLookAt4=new i,this._tempValue=new i,this._tempPos=new a,this._tempLightUp=new a,this._tempMin=new i,this._tempMax=new i,this._tempMatrix44=new T,this._splitFrustumCulling=new Ae(T.DEFAULT),this._tempScaleMatrix44=new T,this._shadowPCFOffset=new r(1/1024,1/1024),this._shaderValueDistance=new i,this._shaderValueLightVP=null,this.cameras=[],this._shaderValueVPs=[],t=0;t<this._spiltDistance.length;t++)this._spiltDistance[t]=0;for(t=0;t<this._dimension.length;t++)this._dimension[t]=new r;for(t=0;t<this._frustumPos.length;t++)this._frustumPos[t]=new a;for(t=0;t<this._boundingBox.length;t++)this._boundingBox[t]=new Je(new a,new a);for(t=0;t<this._boundingSphere.length;t++)this._boundingSphere[t]=new kt(new a,0);T.createScaling(new a(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}return _createClass(e,[{key:"setInfo",value:function(t,n,r,i,a,o){a>e.MAX_PSSM_COUNT&&(this._shadowMapCount=e.MAX_PSSM_COUNT),this._scene=t,this._maxDistance=n,this.shadowMapCount=a,this._globalParallelLightDir=r,this._ratioOfDistance=1/this._shadowMapCount;for(var s=0;s<this._spiltDistance.length;s++)this._spiltDistance[s]=0;this._shadowMapTextureSize=i,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(o),this._statesDirty=!0}},{key:"setPCFType",value:function(e){this._PCFType=e;var t=this._scene._shaderValues;switch(this._PCFType){case 0:t.addDefine(Z.SHADERDEFINE_SHADOW_PCF_NO),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF1),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF2),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF3);break;case 1:t.addDefine(Z.SHADERDEFINE_SHADOW_PCF1),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF_NO),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF2),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF3);break;case 2:t.addDefine(Z.SHADERDEFINE_SHADOW_PCF2),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF_NO),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF1),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF3);break;case 3:t.addDefine(Z.SHADERDEFINE_SHADOW_PCF3),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF_NO),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF1),t.removeDefine(Z.SHADERDEFINE_SHADOW_PCF2)}}},{key:"getPCFType",value:function(){return this._PCFType}},{key:"setFarDistance",value:function(e){this._maxDistance!=e&&(this._maxDistance=e,this._statesDirty=!0)}},{key:"getFarDistance",value:function(){return this._maxDistance}},{key:"_beginSampler",value:function(e,t){if(e<0||e>this._shadowMapCount)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=e,this._update(t)}},{key:"endSampler",value:function(e){this._currentPSSM=-1}},{key:"_calcAllLightCameraInfo",value:function(e){if(1===this._shadowMapCount)this._beginSampler(0,e),this.endSampler(e);else for(var t=0,n=this._shadowMapCount+1;t<n;t++)this._beginSampler(t,e),this.endSampler(e)}},{key:"_recalculate",value:function(e,t,n){this._calcSplitDistance(e),this._calcBoundingBox(t,n),this._rebuildRenderInfo()}},{key:"_update",value:function(e){var t=e.nearPlane,n=e.fieldOfView,r=e.aspectRatio;(this._statesDirty||this.lastNearPlane!==t||this.lastFieldOfView!==n||this.lastAspectRatio!==r)&&(this._recalculate(t,n,r),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=t,this.lastFieldOfView=n,this.lastAspectRatio=r),this._calcLightViewProject(e)}},{key:"_uploadShaderValue",value:function(){var e=this._scene._shaderValues;switch(this._shadowMapCount){case 1:e.addDefine(Z.SHADERDEFINE_SHADOW_PSSM1),e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM2),e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM3);break;case 2:e.addDefine(Z.SHADERDEFINE_SHADOW_PSSM2),e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM1),e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM3);break;case 3:e.addDefine(Z.SHADERDEFINE_SHADOW_PSSM3),e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM1),e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM2)}switch(e.setVector(s.Scene3D.SHADOWDISTANCE,this._shaderValueDistance),e.setBuffer(s.Scene3D.SHADOWLIGHTVIEWPROJECT,this._shaderValueLightVP),e.setVector2(s.Scene3D.SHADOWMAPPCFOFFSET,this._shadowPCFOffset),this._shadowMapCount){case 3:e.setTexture(s.Scene3D.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget),e.setTexture(s.Scene3D.SHADOWMAPTEXTURE2,this.cameras[2].renderTarget),e.setTexture(s.Scene3D.SHADOWMAPTEXTURE3,this.cameras[3].renderTarget);break;case 2:e.setTexture(s.Scene3D.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget),e.setTexture(s.Scene3D.SHADOWMAPTEXTURE2,this.cameras[2].renderTarget);break;case 1:e.setTexture(s.Scene3D.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget)}}},{key:"_calcSplitDistance",value:function(e){var t,n=this._maxDistance,r=1/this._shadowMapCount;for(t=0;t<=this._shadowMapCount;t++)this._uniformDistance[t]=e+(n-e)*t*r;var i=n/e;for(t=0;t<=this._shadowMapCount;t++){var a=Math.pow(i,t*r);this._logDistance[t]=e*a}for(t=0;t<=this._shadowMapCount;t++)this._spiltDistance[t]=this._uniformDistance[t]*this._ratioOfDistance+this._logDistance[t]*(1-this._ratioOfDistance);this._shaderValueDistance.x=void 0!=this._spiltDistance[1]&&this._spiltDistance[1],this._shaderValueDistance.y=void 0!=this._spiltDistance[2]&&this._spiltDistance[2],this._shaderValueDistance.z=void 0!=this._spiltDistance[3]&&this._spiltDistance[3],this._shaderValueDistance.w=void 0!=this._spiltDistance[4]&&this._spiltDistance[4]}},{key:"_calcBoundingBox",value:function(e,t){var n,r,i,a,o,s,l,_,u=3.1415926*e/180,c=Math.tan(u/2);for(a=0;a<=this._shadowMapCount;a++){r=(n=(i=this._spiltDistance[a])*c)*t;var h=this._frustumPos[4*a+0];h.x=-r,h.y=-n,h.z=-i,(h=this._frustumPos[4*a+1]).x=r,h.y=-n,h.z=-i,(h=this._frustumPos[4*a+2]).x=-r,h.y=n,h.z=-i,(h=this._frustumPos[4*a+3]).x=r,h.y=n,h.z=-i,(h=this._dimension[a]).x=r,h.y=n}for(a=1;a<=this._shadowMapCount;a++)o=this._dimension[a],(s=this._boundingBox[a].min).x=-o.x,s.y=-o.y,s.z=-this._spiltDistance[a],(l=this._boundingBox[a].max).x=o.x,l.y=o.y,l.z=-this._spiltDistance[a-1],(_=this._boundingSphere[a].center).x=.5*(s.x+l.x),_.y=.5*(s.y+l.y),_.z=.5*(s.z+l.z),this._boundingSphere[a].radius=.5*Math.sqrt(Math.pow(l.x-s.x,2)+Math.pow(l.y-s.y,2)+Math.pow(l.z-s.z,2));s=this._boundingBox[0].min,o=this._dimension[this._shadowMapCount],s.x=-o.x,s.y=-o.y,s.z=-this._spiltDistance[this._shadowMapCount],(l=this._boundingBox[0].max).x=o.x,l.y=o.y,l.z=-this._spiltDistance[0],(_=this._boundingSphere[0].center).x=.5*(s.x+l.x),_.y=.5*(s.y+l.y),_.z=.5*(s.z+l.z),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(l.x-s.x,2)+Math.pow(l.y-s.y,2)+Math.pow(l.z-s.z,2))}},{key:"calcSplitFrustum",value:function(e){this._currentPSSM>0?T.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):T.createPerspective(3.1416*e.fieldOfView/180,e.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._shadowMapCount],this._tempMatrix44),T.multiply(this._tempMatrix44,e.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44}},{key:"_rebuildRenderInfo",value:function(){var e,n=this._shadowMapCount+1;for(this.cameras.length=n,e=0;e<n;e++){if(!this.cameras[e]){var r=new Xe;r.name="lightCamera"+e,r.clearColor=new i(1,1,1,1),this.cameras[e]=r}var a=this.cameras[e].renderTarget;null!=a&&a.width==this._shadowMapTextureSize&&a.height==this._shadowMapTextureSize||(a&&a.destroy(),(a=new V(this._shadowMapTextureSize,this._shadowMapTextureSize,t.RenderTextureFormat.R8G8B8A8,t.RenderTextureDepthFormat.DEPTH_16)).filterMode=t.BaseTexture.FILTERMODE_POINT,this.cameras[e].renderTarget=a)}}},{key:"_calcLightViewProject",value:function(t){var n=this._boundingSphere[this._currentPSSM],r=t.transform.worldMatrix;n.radius;n.center.cloneTo(this._tempLookAt3),a.transformV3ToV4(this._tempLookAt3,r,this._tempLookAt4);var o=this._tempLookAt3,l=this._tempLookAt4;o.x=l.x,o.y=l.y,o.z=l.z;var _=this._tempLightUp;t.transform.worldMatrix.getForward(e._tempVector30);var u=e._tempVector30;_.x=u.x,_.y=1,_.z=u.z,a.normalize(this._tempLightUp,this._tempLightUp),a.scale(this._globalParallelLightDir,4*n.radius,this._tempPos),a.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var c=this.cameras[this._currentPSSM];c.transform.position=this._tempPos,c.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var h=this._tempMax,d=this._tempMin;h.x=h.y=h.z=-1e5,h.w=1,d.x=d.y=d.z=1e5,d.w=1,T.multiply(c.viewMatrix,r,this._tempMatrix44);var f=this._tempValue,m=[];m.length=8,this._boundingBox[this._currentPSSM].getCorners(m);for(var E=0;E<8;E++){var v=m[E];f.x=v.x,f.y=v.y,f.z=v.z,f.w=1,i.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),d.x=f.x<d.x?f.x:d.x,d.y=f.y<d.y?f.y:d.y,d.z=f.z<d.z?f.z:d.z,h.x=f.x>h.x?f.x:h.x,h.y=f.y>h.y?f.y:h.y,h.z=f.z>h.z?f.z:h.z}i.add(this._tempMax,this._tempMin,this._tempValue),f.x*=.5,f.y*=.5,f.z*=.5,f.w=1,i.transformByM4x4(this._tempValue,c.transform.worldMatrix,this._tempValue);var p=Math.abs(-this._tempMax.z),g=p>this._maxDistance?p:this._maxDistance;a.scale(this._globalParallelLightDir,g,this._tempPos);var y=this._tempPos;y.x=f.x-y.x,y.y=f.y-y.y,y.z=f.z-y.z,c.transform.position=this._tempPos,c.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),T.createOrthoOffCenter(d.x,h.x,d.y,h.y,1,g+.5*(h.z-d.z),c.projectionMatrix);var S=c.projectionViewMatrix;e.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,S,this._shaderValueVPs[this._currentPSSM]),this._scene._shaderValues.setBuffer(s.Scene3D.SHADOWLIGHTVIEWPROJECT,this._shaderValueLightVP)}},{key:"setShadowMapTextureSize",value:function(e){e!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=e,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)}},{key:"disposeAllRenderTarget",value:function(){for(var e=0,t=this._shadowMapCount+1;e<t;e++)this.cameras[e].renderTarget&&(this.cameras[e].renderTarget.destroy(),this.cameras[e].renderTarget=null)}},{key:"shadowMapCount",set:function(t){if(t=(t=t>0?t:1)<=e.MAX_PSSM_COUNT?t:e.MAX_PSSM_COUNT,this._shadowMapCount!=t){this._shadowMapCount=t,this._ratioOfDistance=1/this._shadowMapCount,this._statesDirty=!0,this._shaderValueLightVP=new Float32Array(16*t),this._shaderValueVPs.length=t;for(var n=0;n<t;n++)this._shaderValueVPs[n]=new Float32Array(this._shaderValueLightVP.buffer,64*n)}},get:function(){return this._shadowMapCount}}],[{key:"multiplyMatrixOutFloat32Array",value:function(e,t,n){var r,i,a,o,s,l,_;for(i=e.elements,a=t.elements,r=0;r<4;r++)o=i[r],s=i[r+4],l=i[r+8],_=i[r+12],n[r]=o*a[0]+s*a[1]+l*a[2]+_*a[3],n[r+4]=o*a[4]+s*a[5]+l*a[6]+_*a[7],n[r+8]=o*a[8]+s*a[9]+l*a[10]+_*a[11],n[r+12]=o*a[12]+s*a[13]+l*a[14]+_*a[15]}}]),e}();tr.MAX_PSSM_COUNT=3,tr._tempVector30=new a;var nr=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._isAlternate=!1,e._intensity=1,e._intensityColor=new a,e.color=new a(1,1,1),e._shadow=!1,e._shadowFarPlane=8,e._shadowMapSize=512,e._shadowMapCount=1,e._shadowMapPCFType=0,e._lightmapBakedType=t.LIGHTMAPBAKEDTYPE_REALTIME,e}return _inherits(t,le),_createClass(t,[{key:"_parse",value:function(e,n){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_parse",this).call(this,e,n);var r=e.color;this.color.fromArray(r),this.intensity=e.intensity,this.lightmapBakedType=e.lightmapBakedType}},{key:"_addToScene",value:function(){var e=this._scene,t=o._config.maxLightCount;e._lightCount<t?(e._lightCount++,this._addToLightQueue(),this._isAlternate=!1):(e._alternateLights.add(this),this._isAlternate=!0,console.warn("LightSprite:light count has large than maxLightCount,the latest added light will be ignore."))}},{key:"_removeFromScene",value:function(){var e=this._scene;if(this._isAlternate)e._alternateLights.remove(this);else if(e._lightCount--,this._removeFromLightQueue(),e._alternateLights._length>0){var t=e._alternateLights.shift();t._addToLightQueue(),t._isAlternate=!1,e._lightCount++}}},{key:"_addToLightQueue",value:function(){}},{key:"_removeFromLightQueue",value:function(){}},{key:"_onActive",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onActive",this).call(this),this.lightmapBakedType!==t.LIGHTMAPBAKEDTYPE_BAKED&&this._addToScene()}},{key:"_onInActive",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_onInActive",this).call(this),this.lightmapBakedType!==t.LIGHTMAPBAKEDTYPE_BAKED&&this._removeFromScene()}},{key:"_create",value:function(){return new t}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=e}},{key:"shadow",get:function(){return this._shadow},set:function(e){throw new Error("LightSprite: must override it.")}},{key:"shadowDistance",get:function(){return this._shadowFarPlane},set:function(e){this._shadowFarPlane=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(e)}},{key:"shadowResolution",get:function(){return this._shadowMapSize},set:function(e){this._shadowMapSize=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(e)}},{key:"shadowPSSMCount",get:function(){return this._shadowMapCount},set:function(e){this._shadowMapCount=e,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.shadowMapCount=e)}},{key:"shadowPCFType",get:function(){return this._shadowMapPCFType},set:function(e){this._shadowMapPCFType=e,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(e)}},{key:"lightmapBakedType",get:function(){return this._lightmapBakedType},set:function(e){this._lightmapBakedType!==e&&(this._lightmapBakedType=e,this.activeInHierarchy&&(e!==t.LIGHTMAPBAKEDTYPE_BAKED?this._addToScene():this._removeFromScene()))}},{key:"diffuseColor",get:function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},set:function(e){console.log("LightSprite: discard property,please use color property instead."),this.color=e}}]),t}();nr.LIGHTMAPBAKEDTYPE_REALTIME=0,nr.LIGHTMAPBAKEDTYPE_MIXED=1,nr.LIGHTMAPBAKEDTYPE_BAKED=2;var rr=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._direction=new a,e}return _inherits(t,nr),_createClass(t,[{key:"shadow",set:function(e){this._shadow!==e&&(this._shadow=e,this.scene&&this._initShadow())}}]),_createClass(t,[{key:"_initShadow",value:function(){if(this._shadow)this._parallelSplitShadowMap=new tr,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this.transform.worldMatrix.getForward(this._direction),a.normalize(this._direction,this._direction),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this._direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var e=this._scene._shaderValues,t=this.scene.parallelSplitShadowMaps;t.splice(t.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM1),e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM2),e.removeDefine(Z.SHADERDEFINE_SHADOW_PSSM3)}}},{key:"_addToLightQueue",value:function(){this._scene._directionLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._directionLights.remove(this)}}]),t}(),ir=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._range=6,e}return _inherits(t,nr),_createClass(t,[{key:"range",get:function(){return this._range},set:function(e){this._range=e}}]),_createClass(t,[{key:"_addToLightQueue",value:function(){this._scene._pointLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._pointLights.remove(this)}},{key:"_parse",value:function(e,n){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_parse",this).call(this,e,n),this.range=e.range}}]),t}(),ar=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._spotAngle=30,e._range=10,e._direction=new a,e}return _inherits(t,nr),_createClass(t,[{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=Math.max(Math.min(e,179),0)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e}}]),_createClass(t,[{key:"_addToLightQueue",value:function(){this._scene._spotLights.add(this)}},{key:"_removeFromLightQueue",value:function(){this._scene._spotLights.remove(this)}},{key:"_parse",value:function(e,n){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_parse",this).call(this,e,n),this.range=e.range,this.spotAngle=e.spotAngle}}]),t}(),or=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"_createSprite3DInstance",value:function(t,n,r){var i;switch(t.type){case"Scene3D":i=new Rn;break;case"Sprite3D":i=new le;break;case"MeshSprite3D":i=new at,r&&t.props.isStatic&&r.push(i);break;case"SkinnedMeshSprite3D":i=new An;break;case"ShuriKenParticle3D":i=new Gt;break;case"Camera":i=new Xe;break;case"DirectionLight":i=new rr;break;case"PointLight":i=new ir;break;case"SpotLight":i=new ar;break;case"TrailSprite3D":i=new bn;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var a=t.child;if(a)for(var o=0,s=a.length;o<s;o++){var l=e._createSprite3DInstance(a[o],n,r);i.addChild(l)}return n[t.instanceID]=i,i}},{key:"_createComponentInstance",value:function(n,r){var i=r[n.instanceID];i._parse(n.props,r);var a=n.child;if(a)for(var o=0,s=a.length;o<s;o++)e._createComponentInstance(a[o],r);var l=n.components;if(l)for(var _=0,u=l.length;_<u;_++){var c=l[_],h=t.ClassUtils.getRegClass(c.type);if(h)i.addComponent(h)._parse(c);else console.warn("Unkown component type.")}}},{key:"_createNodeByJson02",value:function(t,n){var r={},i=e._createSprite3DInstance(t,r,n);return e._createComponentInstance(t,r),i}},{key:"_parse",value:function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n,r=t.data,i=[];switch(t.version){case"LAYAHIERARCHY:02":n=e._createNodeByJson02(r,i);break;default:n=e._createNodeByJson(r,i)}return ue.combine(n,i),n}},{key:"_parseScene",value:function(t){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var n,r=t.data,i=[];switch(t.version){case"LAYASCENE3D:02":n=e._createNodeByJson02(r,i);break;default:n=e._createNodeByJson(r,i)}return ue.combine(null,i),n}},{key:"_createNodeByJson",value:function(n,r){var i;switch(n.type){case"Scene3D":i=new Rn;break;case"Sprite3D":i=new le;break;case"MeshSprite3D":i=new at,r&&n.props.isStatic&&r.push(i);break;case"SkinnedMeshSprite3D":i=new An;break;case"ShuriKenParticle3D":i=new Gt;break;case"Camera":i=new Xe;break;case"DirectionLight":i=new rr;break;case"PointLight":i=new ir;break;case"SpotLight":i=new ar;break;case"TrailSprite3D":i=new bn;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var a=n.child;if(a)for(var o=0,s=a.length;o<s;o++){var l=e._createNodeByJson(a[o],r);i.addChild(l)}var _=n.components;if(_)for(var u=0,c=_.length;u<c;u++){var h=_[u],d=t.ClassUtils.getRegClass(h.type);if(d)i.addComponent(d)._parse(h);else console.warn("Unkown component type.")}return i._parse(n.props,null),i}}]),e}(),sr=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"_cancelLoadByUrl",value:function(n){t.Laya.loader.cancelLoadByUrl(n),e._innerFirstLevelLoaderManager.cancelLoadByUrl(n),e._innerSecondLevelLoaderManager.cancelLoadByUrl(n),e._innerThirdLevelLoaderManager.cancelLoadByUrl(n),e._innerFourthLevelLoaderManager.cancelLoadByUrl(n)}},{key:"_changeWebGLSize",value:function(e,n){t.WebGL.onStageResize(e,n),b.clientWidth=e,b.clientHeight=n}},{key:"__init__",value:function(n,r,i){if(t.Config.isAntialias=i.isAntialias,t.Config.isAlpha=i.isAlpha,t.Config.premultipliedAlpha=i.premultipliedAlpha,t.Config.isStencil=i.isStencil,t.WebGL.enable()){t.RunDriver.changeWebGLSize=e._changeWebGLSize,t.Render.is3DMode=!0,t.Laya.init(n,r),t.Render.supportWebGLPlusRendering||(t.LayaGL.instance=t.WebGLContext.mainContext,t.LayaGL.instance.createCommandEncoder=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:128,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new t.CommandEncoder(this,e,n,r)}),i._multiLighting=i.enableMultiLight&&Me.supportTextureFormat(t.TextureFormat.R32G32B32A32),s.Shader3D=U,s.Scene3D=Rn,s.MeshRenderStaticBatchManager=Qe,s.MeshRenderDynamicBatchManager=it,s.SubMeshDynamicBatch=rt,s.Laya3D=e,s.Matrix4x4=T,e.enableNative3D(),me.__init__(),Te.__init__(),bt.__init__(),Vt.__init__(),cn.__init__(),Mn.__init__(),Vn.__init__(),Ht.__init__(),pe.__init__(),rt.__init__(),I._bullet=window.Physics3D,I._bullet&&(Gn.__init__(),Jt.__init__(),tn.__init__(),sn.__init__(),ln.__init__(),$t.__init__(),rn.__init__(),wn.__init__(),Un.__init__()),er.__init__(),Yn.__init__(),jn.__init__(),le.__init__(),_e.__init__(),at.__init__(),An.__init__(),Gt.__init__(),bn.__init__(),z.__init__(),Rn.__init__(),Qe.__init__(),Y.__initDefine__(),j.__initDefine__(),Q.__initDefine__(),ee.__initDefine__(),$.__initDefine__(),ne.__initDefine__(),re.__initDefine__(),xn.__initDefine__(),K.__initDefine__(),ie.__initDefine__(),Mt.__initDefine__(),J.__initDefine__(),zt.__initDefine__(),te.__initDefine__(),Be.__init__(),t.ClassUtils.regClass("Laya.EffectMaterial",K),t.ClassUtils.regClass("Laya.UnlitMaterial",re),t.ClassUtils.regClass("Laya.BlinnPhongMaterial",Q),t.ClassUtils.regClass("Laya.SkyProceduralMaterial",ne),t.ClassUtils.regClass("Laya.PBRStandardMaterial",ee),t.ClassUtils.regClass("Laya.PBRSpecularMaterial",$),t.ClassUtils.regClass("Laya.SkyBoxMaterial",te),t.ClassUtils.regClass("Laya.WaterPrimaryMaterial",ie),t.ClassUtils.regClass("Laya.ExtendTerrainMaterial",J),t.ClassUtils.regClass("Laya.ShurikenParticleMaterial",Mt),t.ClassUtils.regClass("Laya.TrailMaterial",xn),t.ClassUtils.regClass("Laya.PhysicsCollider",Bn),t.ClassUtils.regClass("Laya.Rigidbody3D",Un),t.ClassUtils.regClass("Laya.CharacterController",wn),t.ClassUtils.regClass("Laya.Animator",N),t.ClassUtils.regClass("PhysicsCollider",Bn),t.ClassUtils.regClass("CharacterController",wn),t.ClassUtils.regClass("Animator",N),t.ClassUtils.regClass("Rigidbody3D",Un),zt.defaultMaterial=new zt,Q.defaultMaterial=new Q,K.defaultMaterial=new K,ee.defaultMaterial=new ee,$.defaultMaterial=new $,re.defaultMaterial=new re,Mt.defaultMaterial=new Mt,xn.defaultMaterial=new xn,ne.defaultMaterial=new ne,te.defaultMaterial=new te,ie.defaultMaterial=new ie,zt.defaultMaterial.lock=!0,Q.defaultMaterial.lock=!0,K.defaultMaterial.lock=!0,ee.defaultMaterial.lock=!0,$.defaultMaterial.lock=!0,re.defaultMaterial.lock=!0,Mt.defaultMaterial.lock=!0,xn.defaultMaterial.lock=!0,ne.defaultMaterial.lock=!0,te.defaultMaterial.lock=!0,ie.defaultMaterial.lock=!0,t.Texture2D.__init__(),Zn.__init__(),be.__init__(),hn.__init__(),we.__init__(),Fe.__init__(),ce.__init__(),y.__init__();var a=t.LoaderManager.createMap;a.lh=[e.HIERARCHY,or._parse],a.ls=[e.HIERARCHY,or._parseScene],a.lm=[e.MESH,Yn._parse],a.lmat=[e.MATERIAL,Y._parse],a.ltc=[e.TEXTURECUBE,Zn._parse],a.jpg=[e.TEXTURE2D,t.Texture2D._parse],a.jpeg=[e.TEXTURE2D,t.Texture2D._parse],a.bmp=[e.TEXTURE2D,t.Texture2D._parse],a.gif=[e.TEXTURE2D,t.Texture2D._parse],a.png=[e.TEXTURE2D,t.Texture2D._parse],a.dds=[e.TEXTURE2D,t.Texture2D._parse],a.ktx=[e.TEXTURE2D,t.Texture2D._parse],a.pvr=[e.TEXTURE2D,t.Texture2D._parse],a.lani=[e.ANIMATIONCLIP,x._parse],a.lav=[e.AVATAR,X._parse];var o=t.Loader.parserMap;o[e.HIERARCHY]=e._loadHierarchy,o[e.MESH]=e._loadMesh,o[e.MATERIAL]=e._loadMaterial,o[e.TEXTURECUBE]=e._loadTextureCube,o[e.TEXTURE2D]=e._loadTexture2D,o[e.ANIMATIONCLIP]=e._loadAnimationClip,o[e.AVATAR]=e._loadAvatar,e._innerFirstLevelLoaderManager.on(t.Event.ERROR,null,e._eventLoadManagerError),e._innerSecondLevelLoaderManager.on(t.Event.ERROR,null,e._eventLoadManagerError),e._innerThirdLevelLoaderManager.on(t.Event.ERROR,null,e._eventLoadManagerError),e._innerFourthLevelLoaderManager.on(t.Event.ERROR,null,e._eventLoadManagerError)}else alert("Laya3D init error,must support webGL!")}},{key:"enableNative3D",value:function(){var e=G,n=Kn,r=In,i=X,a=ce;if(t.Render.supportWebGLPlusRendering&&(e.prototype._initData=e.prototype._initDataForNative,e.prototype.setBool=e.prototype.setBoolForNative,e.prototype.getBool=e.prototype.getBoolForNative,e.prototype.setInt=e.prototype.setIntForNative,e.prototype.getInt=e.prototype.getIntForNative,e.prototype.setNumber=e.prototype.setNumberForNative,e.prototype.getNumber=e.prototype.getNumberForNative,e.prototype.setVector=e.prototype.setVectorForNative,e.prototype.getVector=e.prototype.getVectorForNative,e.prototype.setVector2=e.prototype.setVector2ForNative,e.prototype.getVector2=e.prototype.getVector2ForNative,e.prototype.setVector3=e.prototype.setVector3ForNative,e.prototype.getVector3=e.prototype.getVector3ForNative,e.prototype.setQuaternion=e.prototype.setQuaternionForNative,e.prototype.getQuaternion=e.prototype.getQuaternionForNative,e.prototype.setMatrix4x4=e.prototype.setMatrix4x4ForNative,e.prototype.getMatrix4x4=e.prototype.getMatrix4x4ForNative,e.prototype.setBuffer=e.prototype.setBufferForNative,e.prototype.getBuffer=e.prototype.getBufferForNative,e.prototype.setTexture=e.prototype.setTextureForNative,e.prototype.getTexture=e.prototype.getTextureForNative,e.prototype.setAttribute=e.prototype.setAttributeForNative,e.prototype.getAttribute=e.prototype.getAttributeForNative,e.prototype.cloneTo=e.prototype.cloneToForNative,e.prototype.getData=e.prototype.getDataForNative,n.prototype._uniformMatrix2fv=n.prototype._uniformMatrix2fvForNative,n.prototype._uniformMatrix3fv=n.prototype._uniformMatrix3fvForNative,n.prototype._uniformMatrix4fv=n.prototype._uniformMatrix4fvForNative,t.LayaGLRunner.uploadShaderUniforms=t.LayaGLRunner.uploadShaderUniformsForNative),t.Render.supportWebGLPlusCulling&&(a.renderObjectCulling=ce.renderObjectCullingNative),t.Render.supportWebGLPlusAnimation){i.prototype._cloneDatasToAnimator=i.prototype._cloneDatasToAnimatorNative;var o=x;o.prototype._evaluateClipDatasRealTime=o.prototype._evaluateClipDatasRealTimeForNative,r.prototype._computeSkinnedData=r.prototype._computeSkinnedDataForNative}}},{key:"formatRelativePath",value:function(e,t){var n;if(n=e+t,"."===t.charAt(0)){for(var r=n.split("/"),i=0,a=r.length;i<a;i++)if(".."==r[i]){var o=i-1;o>0&&".."!==r[o]&&(r.splice(o,2),i-=2)}n=r.join("/")}return n}},{key:"_endLoad",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(r)for(var i=0,a=r.length;i<a;i++){var o=t.Loader.getRes(r[i]);o&&o._removeReference()}e.endLoad(n)}},{key:"_eventLoadManagerError",value:function(e){t.Laya.loader.event(t.Event.ERROR,e)}},{key:"_addHierarchyInnerUrls",value:function(t,n,r,i,a,o){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,_=e.formatRelativePath(i,a);return r&&(_+=r),t.push({url:_,type:o,constructParams:s,propertyParams:l}),n.push(_),_}},{key:"_getSprite3DHierarchyInnerUrls",value:function(t,n,r,i,a,o,s,l){var _,u,c=t.props;switch(t.type){case"Scene3D":var h=c.lightmaps;for(_=0,u=h.length;_<u;_++){var d=h[_];d.path=e._addHierarchyInnerUrls(a,o,s,l,d.path,e.TEXTURE2D,d.constructParams,d.propertyParams)}var f=c.reflectionTexture;if(f&&(c.reflectionTexture=e._addHierarchyInnerUrls(i,o,s,l,f,e.TEXTURECUBE)),c.sky){var m=c.sky.material;m&&(m.path=e._addHierarchyInnerUrls(r,o,s,l,m.path,e.MATERIAL))}break;case"Camera":var E=c.skyboxMaterial;E&&(E.path=e._addHierarchyInnerUrls(r,o,s,l,E.path,e.MATERIAL));break;case"TrailSprite3D":case"MeshSprite3D":case"SkinnedMeshSprite3D":var v=c.meshPath;v&&(c.meshPath=e._addHierarchyInnerUrls(n,o,s,l,v,e.MESH));var T=c.materials;if(T)for(_=0,u=T.length;_<u;_++)T[_].path=e._addHierarchyInnerUrls(r,o,s,l,T[_].path,e.MATERIAL);break;case"ShuriKenParticle3D":if(c.main){var p=c.renderer.resources,g=p.mesh,y=p.material;g&&(p.mesh=e._addHierarchyInnerUrls(n,o,s,l,g,e.MESH)),y&&(p.material=e._addHierarchyInnerUrls(r,o,s,l,y,e.MATERIAL))}else{var S=c.meshPath;S&&(c.meshPath=e._addHierarchyInnerUrls(n,o,s,l,S,e.MESH)),c.material.path=e._addHierarchyInnerUrls(r,o,s,l,c.material.path,e.MATERIAL)}break;case"Terrain":e._addHierarchyInnerUrls(a,o,s,l,c.dataPath,e.TERRAINRES)}var R=t.components;if(R)for(var C=0,I=R.length;C<I;C++){var A=R[C];switch(A.type){case"Animator":A.avatarPath;var x=A.avatar;x&&(x.path=e._addHierarchyInnerUrls(a,o,s,l,x.path,e.AVATAR));var D=A.clipPaths;if(D)for(_=0,u=D.length;_<u;_++)D[_]=e._addHierarchyInnerUrls(a,o,s,l,D[_],e.ANIMATIONCLIP);else{var L=A.layers;for(_=0;_<L.length;_++)for(var M=L[_].states,O=0,N=M.length;O<N;O++){var P=M[O].clipPath;P&&(M[O].clipPath=e._addHierarchyInnerUrls(a,o,s,l,P,e.ANIMATIONCLIP))}}break;case"PhysicsCollider":case"Rigidbody3D":case"CharacterController":var b=A.shapes;for(_=0;_<b.length;_++){var V=b[_];if("MeshColliderShape"===V.type)(g=V.mesh)&&(V.mesh=e._addHierarchyInnerUrls(n,o,s,l,g,e.MESH))}}}var k=t.child;for(_=0,u=k.length;_<u;_++)e._getSprite3DHierarchyInnerUrls(k[_],n,r,i,a,o,s,l)}},{key:"_loadHierarchy",value:function(n){n.on(t.Event.LOADED,null,e._onHierarchylhLoaded,[n]),n.load(n.url,t.Loader.JSON,!1,null,!0)}},{key:"_onHierarchylhLoaded",value:function(n,r){var i=n.url,a=A.getURLVerion(i),o=t.URL.getPath(i),s=[],l=[],_=[],u=[],c=[];e._getSprite3DHierarchyInnerUrls(r.data,s,l,_,u,c,a,o);var h=s.length+l.length+u.length,d=h+1,f=1/d;if(e._onProcessChange(n,0,f,1),u.length>0){var m=h/d,E=t.Handler.create(null,e._onProcessChange,[n,f,m],!1);e._innerFourthLevelLoaderManager._create(u,!1,t.Handler.create(null,e._onHierarchyInnerForthLevResouLoaded,[n,E,r,c,s,l,_,f+m*u.length,m]),E,null,null,null,1,!0)}else e._onHierarchyInnerForthLevResouLoaded(n,null,r,c,s,l,_,f,m)}},{key:"_onHierarchyInnerForthLevResouLoaded",value:function(n,r,i,a,o,s,l,_,u){if(r&&r.recover(),l.length>0){var c=t.Handler.create(null,e._onProcessChange,[n,_,u],!1);e._innerThirdLevelLoaderManager._create(l,!1,t.Handler.create(null,e._onHierarchyInnerThirdLevResouLoaded,[n,c,i,a,o,s,_+u*s.length,u]),r,null,null,null,1,!0)}else e._onHierarchyInnerThirdLevResouLoaded(n,null,i,a,o,s,_,u)}},{key:"_onHierarchyInnerThirdLevResouLoaded",value:function(n,r,i,a,o,s,l,_){if(r&&r.recover(),s.length>0){var u=t.Handler.create(null,e._onProcessChange,[n,l,_],!1);e._innerSecondLevelLoaderManager._create(s,!1,t.Handler.create(null,e._onHierarchyInnerSecondLevResouLoaded,[n,u,i,a,o,l+_*s.length,_]),r,null,null,null,1,!0)}else e._onHierarchyInnerSecondLevResouLoaded(n,null,i,a,o,l,_)}},{key:"_onHierarchyInnerSecondLevResouLoaded",value:function(n,r,i,a,o,s,l){if(r&&r.recover(),o.length>0){var _=t.Handler.create(null,e._onProcessChange,[n,s,l],!1);e._innerFirstLevelLoaderManager._create(o,!1,t.Handler.create(null,e._onHierarchyInnerFirstLevResouLoaded,[n,_,i,a]),r,null,null,null,1,!0)}else e._onHierarchyInnerFirstLevResouLoaded(n,null,i,a)}},{key:"_onHierarchyInnerFirstLevResouLoaded",value:function(t,n,r,i){n&&n.recover(),t._cache=t._createCache;var a="Scene3D"===r.data.type?or._parseScene(r,t._propertyParams,t._constructParams):or._parse(r,t._propertyParams,t._constructParams);e._endLoad(t,a,i)}},{key:"_loadMesh",value:function(n){n.on(t.Event.LOADED,null,e._onMeshLmLoaded,[n]),n.load(n.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_onMeshLmLoaded",value:function(t,n){t._cache=t._createCache;var r=Yn._parse(n,t._propertyParams,t._constructParams);e._endLoad(t,r)}},{key:"_loadMaterial",value:function(n){n.on(t.Event.LOADED,null,e._onMaterilLmatLoaded,[n]),n.load(n.url,t.Loader.JSON,!1,null,!0)}},{key:"_onMaterilLmatLoaded",value:function(n,r){var i,a=n.url,o=A.getURLVerion(a),s=t.URL.getPath(a),l=[],_=[];r.customProps;switch(r.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var u,c,h=r.props.textures;if(h)for(u=0,c=h.length;u<c;u++){var d=h[u],f=d.path;f&&(i=e.formatRelativePath(s,f),o&&(i+=o),l.push({url:i,constructParams:d.constructParams,propertyParams:d.propertyParams}),_.push(i),d.path=i)}break;default:throw new Error("Laya3D:unkonwn version.")}var m=l.length,E=m+1,v=1/E;if(e._onProcessChange(n,0,v,1),m>0){var T=t.Handler.create(null,e._onProcessChange,[n,v,m/E],!1);e._innerFourthLevelLoaderManager._create(l,!1,t.Handler.create(null,e._onMateialTexturesLoaded,[n,T,r,_]),T,null,null,null,1,!0)}else e._onMateialTexturesLoaded(n,null,r,null)}},{key:"_onMateialTexturesLoaded",value:function(t,n,r,i){t._cache=t._createCache;var a=Y._parse(r,t._propertyParams,t._constructParams);e._endLoad(t,a,i),n&&n.recover()}},{key:"_loadAvatar",value:function(n){n.on(t.Event.LOADED,null,function(t){n._cache=n._createCache;var r=X._parse(t,n._propertyParams,n._constructParams);e._endLoad(n,r)}),n.load(n.url,t.Loader.JSON,!1,null,!0)}},{key:"_loadAnimationClip",value:function(n){n.on(t.Event.LOADED,null,function(t){n._cache=n._createCache;var r=x._parse(t,n._propertyParams,n._constructParams);e._endLoad(n,r)}),n.load(n.url,t.Loader.BUFFER,!1,null,!0)}},{key:"_loadTexture2D",value:function(n){var r,i=n.url,a=i.lastIndexOf(".")+1,o=i.indexOf("?"),s=-1==o?i.length:o;switch(i.substr(a,s-a)){case"jpg":case"jpeg":case"bmp":case"gif":case"png":r="nativeimage";break;case"dds":case"ktx":case"pvr":r=t.Loader.BUFFER}n.on(t.Event.LOADED,null,function(r){n._cache=n._createCache;var i=t.Texture2D._parse(r,n._propertyParams,n._constructParams);e._endLoad(n,i)}),n.load(n.url,r,!1,null,!0)}},{key:"_loadTextureCube",value:function(n){n.on(t.Event.LOADED,null,e._onTextureCubeLtcLoaded,[n]),n.load(n.url,t.Loader.JSON,!1,null,!0)}},{key:"_onTextureCubeLtcLoaded",value:function(n,r){var i=t.URL.getPath(n.url),a=[e.formatRelativePath(i,r.front),e.formatRelativePath(i,r.back),e.formatRelativePath(i,r.left),e.formatRelativePath(i,r.right),e.formatRelativePath(i,r.up),e.formatRelativePath(i,r.down)];e._onProcessChange(n,0,1/7,1);var o=t.Handler.create(null,e._onProcessChange,[n,1/7,6/7],!1);e._innerFourthLevelLoaderManager.load(a,t.Handler.create(null,e._onTextureCubeImagesLoaded,[n,a,o]),o,"nativeimage")}},{key:"_onTextureCubeImagesLoaded",value:function(n,r,i){for(var a=new Array(6),o=0;o<6;o++)a[o]=t.Loader.getRes(r[o]);n._cache=n._createCache;var s=Zn._parse(a,n._propertyParams,n._constructParams);for(i.recover(),o=0;o<6;o++)t.Loader.clearRes(r[o]);e._endLoad(n,s)}},{key:"_onProcessChange",value:function(e,n,r,i){(i=n+i*r)<1&&e.event(t.Event.PROGRESS,i)}},{key:"init",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(e._isInit)i&&i.run();else{e._isInit=!0,r&&r.cloneTo(o._config),r=o._config,ce.debugFrustumCulling=r.debugFrustumCulling,e._editerEnvironment=r._editerEnvironment,Rn.octreeCulling=r.octreeCulling,Rn.octreeInitialSize=r.octreeInitialSize,Rn.octreeInitialCenter=r.octreeInitialCenter,Rn.octreeMinNodeSize=r.octreeMinNodeSize,Rn.octreeLooseness=r.octreeLooseness;var a=window.Physics3D;null==a?(I._enablePhysics=!1,e.__init__(t,n,r),i&&i.run()):(I._enablePhysics=!0,a(16*r.defaultPhysicsMemory,kn._interactive).then(function(){e.__init__(t,n,r),i&&i.run()}))}}},{key:"enablePhysics",get:function(){return I._enablePhysics}}]),e}();sr.HIERARCHY="HIERARCHY",sr.MESH="MESH",sr.MATERIAL="MATERIAL",sr.TEXTURE2D="TEXTURE2D",sr.TEXTURECUBE="TEXTURECUBE",sr.ANIMATIONCLIP="ANIMATIONCLIP",sr.AVATAR="AVATAR",sr.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",sr.TERRAINRES="TERRAIN",sr._innerFirstLevelLoaderManager=new t.LoaderManager,sr._innerSecondLevelLoaderManager=new t.LoaderManager,sr._innerThirdLevelLoaderManager=new t.LoaderManager,sr._innerFourthLevelLoaderManager=new t.LoaderManager,sr._isInit=!1,sr._editerEnvironment=!1,sr.physicsSettings=new un,window.Laya3D=sr;var lr=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,qe),_createClass(t,[{key:"add",value:function(e){if(-1!==e._indexInCastShadowList)throw"CastShadowList:element has  in  CastShadowList.";this._add(e),e._indexInCastShadowList=this.length++}},{key:"remove",value:function(e){var t=e._indexInCastShadowList;if(this.length--,t!==this.length){var n=this.elements[this.length];this.elements[t]=n,n._indexInCastShadowList=t}e._indexInCastShadowList=-1}}]),t}(),_r=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"onStateEnter",value:function(){}},{key:"onStateUpdate",value:function(){}},{key:"onStateExit",value:function(){}}]),e}(),ur=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments));return e._indexInPool=-1,e}return _inherits(n,t.Component),_createClass(n,[{key:"_checkProcessTriggers",value:function(){var e=n.prototype;return this.onTriggerEnter!==e.onTriggerEnter||(this.onTriggerStay!==e.onTriggerStay||this.onTriggerExit!==e.onTriggerExit)}},{key:"_checkProcessCollisions",value:function(){var e=n.prototype;return this.onCollisionEnter!==e.onCollisionEnter||(this.onCollisionStay!==e.onCollisionStay||this.onCollisionExit!==e.onCollisionExit)}},{key:"_onAwake",value:function(){this.onAwake(),this.onStart!==n.prototype.onStart&&t.Laya.startTimer.callLater(this,this.onStart)}},{key:"_onEnable",value:function(){this.owner._scene._addScript(this);var e=n.prototype;this.onKeyDown!==e.onKeyDown&&t.Laya.stage.on(t.Event.KEY_DOWN,this,this.onKeyDown),this.onKeyPress!==e.onKeyPress&&t.Laya.stage.on(t.Event.KEY_PRESS,this,this.onKeyUp),this.onKeyUp!==e.onKeyUp&&t.Laya.stage.on(t.Event.KEY_UP,this,this.onKeyUp),this.onEnable()}},{key:"_onDisable",value:function(){this.owner._scene._removeScript(this),this.owner.offAllCaller(this),t.Laya.stage.offAllCaller(this),this.onDisable()}},{key:"_isScript",value:function(){return!0}},{key:"_onAdded",value:function(){var e=this.owner,t=e._scripts;t||(e._scripts=t=[]),t.push(this),e._needProcessCollisions||(e._needProcessCollisions=this._checkProcessCollisions()),e._needProcessTriggers||(e._needProcessTriggers=this._checkProcessTriggers())}},{key:"_onDestroy",value:function(){var e=this.owner._scripts;e.splice(e.indexOf(this),1);var t=this.owner;t._needProcessTriggers=!1;for(var n=0,r=e.length;n<r;n++)if(e[n]._checkProcessTriggers()){t._needProcessTriggers=!0;break}for(t._needProcessCollisions=!1,n=0,r=e.length;n<r;n++)if(e[n]._checkProcessCollisions()){t._needProcessCollisions=!0;break}this.onDestroy()}},{key:"onAwake",value:function(){}},{key:"onEnable",value:function(){}},{key:"onStart",value:function(){}},{key:"onTriggerEnter",value:function(e){}},{key:"onTriggerStay",value:function(e){}},{key:"onTriggerExit",value:function(e){}},{key:"onCollisionEnter",value:function(e){}},{key:"onCollisionStay",value:function(e){}},{key:"onCollisionExit",value:function(e){}},{key:"onMouseDown",value:function(){}},{key:"onMouseDrag",value:function(){}},{key:"onMouseClick",value:function(){}},{key:"onMouseUp",value:function(){}},{key:"onMouseEnter",value:function(){}},{key:"onMouseOver",value:function(){}},{key:"onMouseOut",value:function(){}},{key:"onKeyDown",value:function(e){}},{key:"onKeyPress",value:function(e){}},{key:"onKeyUp",value:function(e){}},{key:"onUpdate",value:function(){}},{key:"onLateUpdate",value:function(){}},{key:"onPreRender",value:function(){}},{key:"onPostRender",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){}},{key:"isSingleton",get:function(){return!1}}]),n}(),cr=function(){function e(t,n,r,i){_classCallCheck(this,e),this._datas=[],this._w=t,this._h=n,this._minHeight=r,this._maxHeight=i}return _createClass(e,[{key:"_inBounds",value:function(e,t){return e>=0&&e<this._h&&t>=0&&t<this._w}},{key:"getHeight",value:function(e,t){return this._inBounds(e,t)?this._datas[e][t]:NaN}},{key:"width",get:function(){return this._w}},{key:"height",get:function(){return this._h}},{key:"maxHeight",get:function(){return this._maxHeight}},{key:"minHeight",get:function(){return this._minHeight}}],[{key:"creatFromMesh",value:function(t,n,r,i){for(var o=[],s=[],l=t.subMeshCount,_=0;_<l;_++){for(var u=t.getSubMesh(_),c=u._vertexBuffer,h=c.getFloat32Data(),d=[],f=0;f<h.length;f+=c.vertexDeclaration.vertexStride/4){var m=new a(h[f+0],h[f+1],h[f+2]);d.push(m)}o.push(d);var E=u._indexBuffer;s.push(E.getData())}var v=t.bounds,T=v.getMin().x,p=v.getMin().z,g=v.getMax().x,y=v.getMax().z,S=v.getMin().y,R=v.getMax().y,C=g-T,I=y-p,A=i.x=C/(n-1),x=i.y=I/(r-1),D=new e(n,r,S,R),L=e._tempRay,M=L.direction;M.x=0,M.y=-1,M.z=0;var O=R+.1;L.origin.y=O;for(var N=0;N<r;N++){var P=p+N*x;D._datas[N]=[];for(var b=0;b<n;b++){var V=T+b*A,k=L.origin;k.x=V,k.z=P;var w=e._getPosition(L,o,s);D._datas[N][b]=w===Number.MAX_VALUE?NaN:O-w}}return D}},{key:"createFromImage",value:function(t,n,r){for(var i=t.width,a=t.height,o=new e(i,a,n,r),s=(r-n)/254,l=t.getPixels(),_=0,u=0;u<a;u++)for(var c=o._datas[u]=[],h=0;h<i;h++){var d=l[_++],f=l[_++],m=l[_++],E=l[_++];c[h]=255==d&&255==f&&255==m&&255==E?NaN:(d+f+m)/3*s+n}return o}},{key:"_getPosition",value:function(e,t,n){for(var r=Number.MAX_VALUE,i=0;i<t.length;i++)for(var a=t[i],o=n[i],s=0;s<o.length;s+=3){var l=a[o[s+0]],_=a[o[s+1]],u=a[o[s+2]],c=De.rayIntersectsTriangle(e,l,_,u);!isNaN(c)&&c<r&&(r=c)}return r}}]),e}();cr._tempRay=new Re(new a,new a);var hr=function(e){function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return a._heightMap=n,a._cellSize=new r,a}return _inherits(t,at),_createClass(t,[{key:"_disableRotation",value:function(){var e=this.transform.rotation;e.x=0,e.y=0,e.z=0,e.w=1,this.transform.rotation=e}},{key:"_getScaleX",value:function(){var e=this.transform.worldMatrix.elements,t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)}},{key:"_getScaleZ",value:function(){var e=this.transform.worldMatrix.elements,t=e[8],n=e[9],r=e[10];return Math.sqrt(t*t+n*n+r*r)}},{key:"_initCreateFromMesh",value:function(e,t){this._heightMap=cr.creatFromMesh(this.meshFilter.sharedMesh,e,t,this._cellSize);var n=this.meshFilter.sharedMesh.bounds,r=n.getMin();n.getMax();this._minX=r.x,this._minZ=r.z}},{key:"_initCreateFromMeshHeightMap",value:function(e,t,n){var r=this.meshFilter.sharedMesh.bounds;this._heightMap=cr.createFromImage(e,t,n),this._computeCellSize(r);var i=r.getMin();r.getMax();this._minX=i.x,this._minZ=i.z}},{key:"_computeCellSize",value:function(e){var t=e.getMin(),n=e.getMax(),r=t.x,i=t.z,a=n.x-r,o=n.z-i;this._cellSize.x=a/(this._heightMap.width-1),this._cellSize.y=o/(this._heightMap.height-1)}},{key:"_update",value:function(e){this._disableRotation()}},{key:"getHeight",value:function(e,n){t._tempVector3.x=e,t._tempVector3.y=0,t._tempVector3.z=n,this._disableRotation();var r=this.transform.worldMatrix;r.invert(t._tempMatrix4x4),a.transformCoordinate(t._tempVector3,t._tempMatrix4x4,t._tempVector3),e=t._tempVector3.x,n=t._tempVector3.z;var i=(e-this._minX)/this._cellSize.x,o=(n-this._minZ)/this._cellSize.y,s=Math.floor(o),l=Math.floor(i),_=i-l,u=o-s,c=r.elements,h=c[4],d=c[5],f=c[6],m=Math.sqrt(h*h+d*d+f*f),E=c[13],v=this._heightMap.getHeight(s,l+1),T=this._heightMap.getHeight(s+1,l);if(isNaN(v)||isNaN(T))return NaN;if(_+u<=1){var p=this._heightMap.getHeight(s,l);return isNaN(p)?NaN:(p+_*(v-p)+u*(T-p))*m+E}var g=this._heightMap.getHeight(s+1,l+1);return isNaN(g)?NaN:(g+(1-_)*(T-g)+(1-u)*(v-g))*m+E}},{key:"minX",get:function(){var e=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+e[12]}},{key:"minZ",get:function(){var e=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+e[14]}},{key:"width",get:function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}},{key:"depth",get:function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}}],[{key:"createFromMesh",value:function(e,n,r){var i=new t(e,null,arguments.length>3&&void 0!==arguments[3]?arguments[3]:null);return i._initCreateFromMesh(n,r),i}},{key:"createFromMeshAndHeightMap",value:function(e,n,r,i){var a=new t(e,null,arguments.length>4&&void 0!==arguments[4]?arguments[4]:null);return a._initCreateFromMeshHeightMap(n,r,i),a}}]),t}();hr._tempVector3=new a,hr._tempMatrix4x4=new T;var dr=function(){function e(){_classCallCheck(this,e),this._currentLength=0,this._elements=new Float32Array(12)}return _createClass(e,[{key:"add",value:function(e,t){this._currentLength<8?(6===this._currentLength&&1!==e&&(e=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=e,this._elements[this._currentLength++]=t.x,this._elements[this._currentLength++]=t.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")}},{key:"cloneTo",value:function(e){var t=e;t._currentLength=this._currentLength;for(var n=t._elements,r=0,i=this._elements.length;r<i;r++)n[r]=this._elements[r]}},{key:"clone",value:function(){var t=new e;return this.cloneTo(t),t}},{key:"gradientCount",get:function(){return this._currentLength/3}}]),e}(),fr=function(){function e(){_classCallCheck(this,e),this.startPosition=new a,this.endPosition=new a,this.startColor=new ae,this.endColor=new ae}return _createClass(e,[{key:"cloneTo",value:function(e){this.startPosition.cloneTo(e.startPosition),this.endPosition.cloneTo(e.endPosition),this.startColor.cloneTo(e.startColor),this.endColor.cloneTo(e.endColor)}}]),e}(),mr=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"render",value:function(e){}}]),e}(),Er=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._shader=null,e._shaderData=new G,e._linearColor=new ae,e._bloomTextureTexelSize=new i,e._shaderThreshold=new i,e._shaderParams=new i,e._pyramid=null,e._intensity=0,e._threshold=1,e._softKnee=.5,e._diffusion=7,e._anamorphicRatio=0,e._dirtIntensity=0,e._shaderSetting=new i,e._dirtTileOffset=new i,e.clamp=65472,e.color=new ae(1,1,1,1),e.fastMode=!1,e.dirtTexture=null,e._shader=U.find("PostProcessBloom"),e._pyramid=new Array(2*n.MAXPYRAMIDSIZE),e}return _inherits(n,mr),_createClass(n,[{key:"render",value:function(e){var r=e.command,a=e.camera.viewport;this._shaderData.setTexture(n.SHADERVALUE_AUTOEXPOSURETEX,t.Texture2D.whiteTexture);var o,s=this._anamorphicRatio,l=s<0?-s:0,_=s>0?s:0,u=Math.floor(a.width/(2-l)),c=Math.floor(a.height/(2-_)),h=Math.max(u,c);o=Math.log2(h)+this._diffusion-10;var d=Math.floor(o),f=Math.min(Math.max(d,1),n.MAXPYRAMIDSIZE),m=.5+o-d;this._shaderData.setNumber(n.SHADERVALUE_SAMPLESCALE,m);var E=ae.gammaToLinearSpace(this.threshold),v=E*this._softKnee+1e-5;this._shaderThreshold.setValue(E,E-v,2*v,.25/v),this._shaderData.setVector(n.SHADERVALUE_THRESHOLD,this._shaderThreshold);var T=ae.gammaToLinearSpace(this.clamp);this._shaderParams.setValue(T,0,0,0),this._shaderData.setVector(n.SHADERVALUE_PARAMS,this._shaderParams);for(var p=this.fastMode?1:0,g=e.source,y=0;y<f;y++){var S=2*y,R=S+1,C=0==y?n.SUBSHADER_PREFILTER13+p:n.SUBSHADER_DOWNSAMPLE13+p,I=V.createFromPool(u,c,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE,t.BaseTexture.FILTERMODE_BILINEAR);if(this._pyramid[S]=I,y!==f-1){var A=V.createFromPool(u,c,t.RenderTextureFormat.R8G8B8,t.RenderTextureDepthFormat.DEPTHSTENCIL_NONE,t.BaseTexture.FILTERMODE_BILINEAR);this._pyramid[R]=A}r.blitScreenTriangle(g,I,null,this._shader,this._shaderData,C),g=I,u=Math.max(Math.floor(u/2),1),c=Math.max(Math.floor(c/2),1)}var x=this._pyramid[2*(f-1)];for(y=f-2;y>=0;y--)R=(S=2*y)+1,I=this._pyramid[S],A=this._pyramid[R],r.setShaderDataTexture(this._shaderData,n.SHADERVALUE_BLOOMTEX,I),r.blitScreenTriangle(x,A,null,this._shader,this._shaderData,n.SUBSHADER_UPSAMPLETENT+p),x=A;var D=this._linearColor;this.color.toLinear(D);var L=Math.pow(2,this._intensity/10)-1,M=this._shaderSetting;this._shaderSetting.setValue(m,L,this._dirtIntensity,f);var O=this.dirtTexture?this.dirtTexture:t.Texture2D.blackTexture,N=O.width/O.height,P=a.width/a.height,b=this._dirtTileOffset;N>P?b.setValue(P/N,1,.5*(1-b.x),0):N<P&&b.setValue(1,N/P,0,.5*(1-b.y));var k=e.compositeShaderData;for(this.fastMode?k.addDefine(z.SHADERDEFINE_BLOOM_LOW):k.addDefine(z.SHADERDEFINE_BLOOM),this._bloomTextureTexelSize.setValue(1/x.width,1/x.height,x.width,x.height),k.setVector(z.SHADERVALUE_BLOOM_DIRTTILEOFFSET,b),k.setVector(z.SHADERVALUE_BLOOM_SETTINGS,M),k.setVector(z.SHADERVALUE_BLOOM_COLOR,new i(D.r,D.g,D.b,D.a)),k.setTexture(z.SHADERVALUE_BLOOM_DIRTTEX,O),k.setTexture(z.SHADERVALUE_BLOOMTEX,x),k.setVector(z.SHADERVALUE_BLOOMTEX_TEXELSIZE,this._bloomTextureTexelSize),y=0;y<f;y++)R=(S=2*y)+1,V.recoverToPool(this._pyramid[S]),0!==y&&y!==f-1&&V.recoverToPool(this._pyramid[R]);e.deferredReleaseTextures.push(x)}},{key:"intensity",get:function(){return this._intensity},set:function(e){this._intensity=Math.max(e,0)}},{key:"threshold",get:function(){return this._threshold},set:function(e){this._threshold=Math.max(e,0)}},{key:"softKnee",get:function(){return this._softKnee},set:function(e){this._softKnee=Math.min(Math.max(e,0),1)}},{key:"diffusion",get:function(){return this._diffusion},set:function(e){this._diffusion=Math.min(Math.max(e,1),10)}},{key:"anamorphicRatio",get:function(){return this._anamorphicRatio},set:function(e){this._anamorphicRatio=Math.min(Math.max(e,-1),1)}},{key:"dirtIntensity",get:function(){return this._dirtIntensity},set:function(e){this._dirtIntensity=Math.max(e,0)}}]),n}();Er.SHADERVALUE_MAINTEX=U.propertyNameToID("u_MainTex"),Er.SHADERVALUE_AUTOEXPOSURETEX=U.propertyNameToID("u_AutoExposureTex"),Er.SHADERVALUE_SAMPLESCALE=U.propertyNameToID("u_SampleScale"),Er.SHADERVALUE_THRESHOLD=U.propertyNameToID("u_Threshold"),Er.SHADERVALUE_PARAMS=U.propertyNameToID("u_Params"),Er.SHADERVALUE_BLOOMTEX=U.propertyNameToID("u_BloomTex"),Er.SUBSHADER_PREFILTER13=0,Er.SUBSHADER_PREFILTER4=1,Er.SUBSHADER_DOWNSAMPLE13=2,Er.SUBSHADER_DOWNSAMPLE4=3,Er.SUBSHADER_UPSAMPLETENT=4,Er.SUBSHADER_UPSAMPLEBOX=5,Er.MAXPYRAMIDSIZE=16;var vr=function(){function e(t){if(_classCallCheck(this,e),!(t instanceof Array)||4!==t.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|t[0],this._state0L=0|t[1],this._state1U=0|t[2],this._state1L=0|t[3]}return _createClass(e,[{key:"randomint",value:function(){var e=this._state0U,t=this._state0L,n=this._state1U,r=this._state1L,i=(r>>>0)+(t>>>0),a=n+e+(i/2>>>31)>>>0,o=i>>>0;this._state0U=n,this._state0L=r;var s=0,l=0;s=(e^=s=e<<23|(-512&t)>>>9)^n,l=(t^=l=t<<23)^r;s^=e>>>18,l^=t>>>18|(262143&e)<<14;return s^=n>>>5,l^=r>>>5|(31&n)<<27,this._state1U=s,this._state1L=l,[a,o]}},{key:"random",value:function(){var t=this.randomint(),n=t[0],r=1023<<20|n>>>12,i=0|(t[1]>>>12|(4095&n)<<20);return e._CONVERTION_BUFFER.setUint32(0,r,!1),e._CONVERTION_BUFFER.setUint32(4,i,!1),e._CONVERTION_BUFFER.getFloat64(0,!1)-1}}]),e}();vr._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8)),vr.defaultRand=new vr([0,Date.now()/65536,0,Date.now()%65536]);var Tr=function(e){function n(){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._feedbackEnabled=!1,e}return _inherits(n,t.Component),_createClass(n,[{key:"_onDestroy",value:function(){I._bullet.destroy(this._btConstraint),this._btConstraint=null}},{key:"enabled",get:function(){return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"enabled",this)},set:function(e){this._btConstraint.IsEnabled=e,_set(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"enabled",e,this)}},{key:"breakingImpulseThreshold",get:function(){return this._breakingImpulseThreshold},set:function(e){this._btConstraint.BreakingImpulseThreshold=e,this._breakingImpulseThreshold=e}},{key:"appliedImpulse",get:function(){return this._feedbackEnabled||(this._btConstraint.EnableFeedback(!0),this._feedbackEnabled=!0),this._btConstraint.AppliedImpulse}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(e){this._connectedBody=e}}]),n}(),pr=function(){function e(){_classCallCheck(this,e),this._pivotInA=new a,this._pivotInB=new a}return _createClass(e,[{key:"pivotInA",get:function(){return this._pivotInA},set:function(e){this._pivotInA=e}},{key:"pivotInB",get:function(){return this._pivotInB},set:function(e){this._pivotInB=e}},{key:"damping",get:function(){return this._damping},set:function(e){this._damping=e}},{key:"impulseClamp",get:function(){return this._impulseClamp},set:function(e){this._impulseClamp=e}},{key:"tau",get:function(){return this._tau},set:function(e){this._tau=e}}]),e}(),gr=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize=e}},{key:"color",get:function(){return this._color},set:function(e){this._color=e}}]),_createClass(e,[{key:"_createVertexBuffer",value:function(e){}},{key:"_resizeVertexBuffer",value:function(e){}},{key:"_addChar",value:function(){}}]),e}(),yr=function(){function e(t,n){_classCallCheck(this,e),this._width=0,this._height=0,this._width=t,this._height=n}return _createClass(e,[{key:"width",get:function(){return-1===this._width?b.clientWidth:this._width}},{key:"height",get:function(){return-1===this._height?b.clientHeight:this._height}}],[{key:"fullScreen",get:function(){return new e(-1,-1)}}]),e}();e.AlternateLightQueue=mn,e.AnimationClip=x,e.AnimationClipParser03=g,e.AnimationClipParser04=S,e.AnimationEvent=_,e.AnimationNode=W,e.AnimationTransform3D=H,e.Animator=N,e.AnimatorControllerLayer=L,e.AnimatorPlayState=D,e.AnimatorState=M,e.AnimatorStateScript=_r,e.Avatar=X,e.BaseCamera=ke,e.BaseMaterial=j,e.BaseRender=et,e.BaseShape=Tt,e.BatchMark=he,e.BlinnPhongMaterial=Q,e.BlitScreenQuadCMD=Ue,e.BloomEffect=Er,e.BoundBox=Je,e.BoundFrustum=Ae,e.BoundSphere=kt,e.Bounds=$e,e.BoundsOctree=Sn,e.BoundsOctreeNode=gn,e.BoxColliderShape=$t,e.BoxShape=gt,e.BufferState=Oe,e.BulletInteractive=kn,e.Burst=lt,e.Camera=Xe,e.CapsuleColliderShape=en,e.CastShadowList=lr,e.CharacterController=wn,e.CircleShape=yt,e.Cluster=ye,e.ColliderShape=Jt,e.Collision=Qt,e.CollisionTool=Kt,e.CollisionUtils=Ie,e.Color=ae,e.ColorOverLifetime=ut,e.Command=Be,e.CommandBuffer=We,e.CompoundColliderShape=tn,e.ConchQuaternion=p,e.ConchVector3=v,e.ConchVector4=E,e.ConeColliderShape=nn,e.ConeShape=St,e.Config3D=o,e.Constraint3D=function e(){_classCallCheck(this,e)},e.ConstraintComponent=Tr,e.ContactPoint=qt,e.ContainmentType=Ce,e.CylinderColliderShape=rn,e.DefineDatas=k,e.DirectionLight=rr,e.DirectionLightQueue=fn,e.DynamicBatchManager=oe,e.EffectMaterial=K,e.Emission=Ft,e.ExtendTerrainMaterial=J,e.FloatKeyframe=c,e.FrameOverTime=ct,e.FrustumCulling=ce,e.GeometryElement=de,e.Gradient=st,e.GradientAngularVelocity=ht,e.GradientColor=_t,e.GradientDataInt=dt,e.GradientDataNumber=ft,e.GradientDataVector2=dr,e.GradientMode=ot,e.GradientSize=mt,e.GradientVelocity=Et,e.HalfFloatUtils=y,e.HeightMap=cr,e.HeightfieldColliderShape=function e(){_classCallCheck(this,e)},e.HemisphereShape=Rt,e.HitResult=jt,e.ILaya3D=s,e.IndexBuffer3D=Ne,e.Input3D=_n,e.Keyframe=u,e.KeyframeNode=l,e.KeyframeNodeList=R,e.KeyframeNodeOwner=O,e.Laya3D=sr,e.LightQueue=dn,e.LightSprite=nr,e.LoadModelV04=Hn,e.LoadModelV05=Wn,e.Material=Y,e.MathUtils3D=n,e.Matrix3x3=h,e.Matrix4x4=T,e.Mesh=Yn,e.MeshColliderShape=an,e.MeshFilter=nt,e.MeshReader=Xn,e.MeshRenderDynamicBatchManager=it,e.MeshRenderStaticBatchManager=Qe,e.MeshRenderer=tt,e.MeshSprite3D=at,e.MeshSprite3DShaderDeclaration=Ke,e.MeshTerrainSprite3D=hr,e.MouseTouch=Xt,e.OctreeMotionList=yn,e.PBRSpecularMaterial=$,e.PBRStandardMaterial=ee,e.ParallelSplitShadowMap=tr,e.Physics3D=I,e.Physics3DUtils=Ot,e.PhysicsCollider=Bn,e.PhysicsComponent=sn,e.PhysicsSettings=un,e.PhysicsSimulation=ln,e.PhysicsTriggerComponent=Fn,e.PhysicsUpdateList=Zt,e.Picker=De,e.PixelLineData=fr,e.PixelLineFilter=En,e.PixelLineMaterial=zt,e.PixelLineRenderer=vn,e.PixelLineSprite3D=Tn,e.PixelLineVertex=Ht,e.Plane=Se,e.Point2PointConstraint=pr,e.PointLight=ir,e.PostProcess=z,e.PostProcessEffect=mr,e.PostProcessRenderContext=P,e.PrimitiveMesh=jn,e.Quaternion=d,e.QuaternionKeyframe=f,e.Rand=wt,e.RandX=vr,e.Ray=Re,e.RenderContext3D=b,e.RenderElement=Ye,e.RenderQueue=pn,e.RenderState=q,e.RenderTexture=V,e.RenderableSprite3D=_e,e.Rigidbody3D=Un,e.RotationOverLifetime=vt,e.Scene3D=Rn,e.Scene3DShaderDeclaration=Z,e.Scene3DUtils=or,e.SceneManager=function e(){_classCallCheck(this,e)},e.ScreenQuad=we,e.ScreenTriangle=Fe,e.Script3D=ur,e.SetRenderTargetCMD=Ge,e.SetShaderDataTextureCMD=ze,e.Shader3D=U,e.ShaderData=G,e.ShaderDefine=w,e.ShaderInit3D=er,e.ShaderInstance=Kn,e.ShaderPass=Jn,e.ShaderVariable=Qn,e.ShaderVariant=F,e.ShaderVariantCollection=B,e.ShapeUtils=pt,e.ShuriKenParticle3D=Gt,e.ShuriKenParticle3DShaderDeclaration=Lt,e.ShurikenParticleData=Bt,e.ShurikenParticleMaterial=Mt,e.ShurikenParticleRenderer=Nt,e.ShurikenParticleSystem=Ut,e.SimpleSingletonList=Wt,e.SingletonList=qe,e.Size=yr,e.SizeOverLifetime=It,e.SkinnedMeshRenderer=In,e.SkinnedMeshSprite3D=An,e.SkinnedMeshSprite3DShaderDeclaration=Cn,e.SkyBox=be,e.SkyBoxMaterial=te,e.SkyDome=hn,e.SkyMesh=Pe,e.SkyProceduralMaterial=ne,e.SkyRenderer=Ve,e.SphereColliderShape=on,e.SphereShape=Ct,e.SpotLight=ar,e.Sprite3D=le,e.StartFrame=At,e.StaticBatchManager=ue,e.StaticPlaneColliderShape=Gn,e.SubMesh=zn,e.SubMeshDynamicBatch=rt,e.SubMeshInstanceBatch=pe,e.SubMeshRenderElement=je,e.SubMeshStaticBatch=Ze,e.SubShader=$n,e.SystemUtils=Me,e.TextMesh=gr,e.TextureCube=Zn,e.TextureGenerator=C,e.TextureMode=Ln,e.TextureSheetAnimation=xt,e.Touch=Yt,e.TrailFilter=Nn,e.TrailGeometry=On,e.TrailMaterial=xn,e.TrailRenderer=Pn,e.TrailSprite3D=bn,e.Transform3D=se,e.UnlitMaterial=re,e.Utils3D=A,e.Vector2=r,e.Vector3=a,e.Vector3Keyframe=m,e.Vector4=i,e.VelocityOverLifetime=Dt,e.VertexBuffer3D=fe,e.VertexDeclaration=Ee,e.VertexElement=ve,e.VertexElementFormat=me,e.VertexMesh=Te,e.VertexPositionTerrain=Vn,e.VertexPositionTexture0=cn,e.VertexShuriKenParticle=Pt,e.VertexShurikenParticleBillboard=bt,e.VertexShurikenParticleMesh=Vt,e.VertexTrail=Mn,e.Viewport=xe,e.WaterPrimaryMaterial=ie}(window.Laya=window.Laya||{},Laya);